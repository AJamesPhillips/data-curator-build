var dn=Object.defineProperty;var ln=(t,ee,te)=>ee in t?dn(t,ee,{enumerable:!0,configurable:!0,writable:!0,value:te}):t[ee]=te;var Ne=(t,ee,te)=>(ln(t,typeof ee!="symbol"?ee+"":ee,te),te);import{r as requireCreateSvgIcon,g as get_supabase,s as set_window_title,A as APP_DETAILS,a as get_persisted_state_object,p as persist_state_object,t as time_scale_days_to_ms_pixels_fudge_factor,W as WarningTheme,D as DefaultTheme}from"./set_window_title-8097ac69.js";import{h as h$1,F as F$1,p as p$1,d as k$1,m as connect,s as sn,c as y$1,b as _$d,n as createStore,o as b$1,r as FlexSearch,t as fuzzysort,M as Model,u as commonjsGlobal,v as commonjsRequire,w as getDefaultExportFromCjs,P as Provider,D as D$1}from"./common_libraries-9ca671ee.js";import{o as o$1,i as interopRequireDefaultExports,r as requireJsxRuntime,c as Card,d as CardMedia,e as CardContent,b as Button$2,B as Box,f as Tooltip,I as IconButton,H as Hidden,g as TextField,h as ButtonGroup,j as Slider,m as makeStyles,k as Collapse,l as Toolbar,y as yellow,A as Accordion,n as AccordionSummary,a as Typography,p as AccordionDetails,F as FormControl,q as FormLabel,R as RadioGroup,s as FormControlLabel,t as Radio,M as MenuItem,u as Menu$1,S as StyledEngineProvider,T as ThemeProvider,D as Dialog,v as DialogTitle,w as DialogContent,x as DialogActions,z as ArrowUpward$1,E as ArrowDownward$1,G as DeleteIcon,J as SettingsIcon,K as Select,L as Breadcrumbs,N as FormGroup,O as withStyles,P as Badge,Q as CssBaseline,U as AppBar,V as clsx,W as Drawer,C as Container}from"./common_style_libraries-d8efd735.js";function _mergeNamespaces(t,ee){for(var te=0;te<ee.length;te++){const ne=ee[te];if(typeof ne!="string"&&!Array.isArray(ne)){for(const oe in ne)if(oe!=="default"&&!(oe in t)){const ie=Object.getOwnPropertyDescriptor(ne,oe);ie&&Object.defineProperty(t,oe,ie.get?ie:{enumerable:!0,get:()=>ne[oe]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}const App$2="",WComponentCanvasConnection$1="",CanvasConnection$1="";function bounded(t,ee,te){return Math.max(Math.min(t,te),ee)}function rescale(t,ee,te,ne=0,oe=1){const _e=(bounded(t,ne,oe)-ne)/(oe-ne);return ee+_e*(te-ee)}const connection_terminal_attributes=["meta","validity","state"],connection_terminal_sides=["right","left"];var ConnectionLineBehaviour=(t=>(t.curve="curve",t.straight="straight",t.angular="angular",t))(ConnectionLineBehaviour||{});const connection_line_behaviours=["curve","straight","angular"];function is_a_wcomponent(t){return!!t}function wcomponent_is_event(t){return wcomponent_is_a("event",t)}function wcomponent_is_statev2(t){return wcomponent_is_a("statev2",t)}function wcomponent_is_state_value(t,ee=""){return wcomponent_is_a("state_value",t,ee)}function wcomponent_is_process(t){return wcomponent_is_a("process",t)}function wcomponent_is_a(t,ee,te=""){let ne=!1;return te=typeof te=="string"?te:"",ee?ee.type!==t?te&&console.error(`wcomponent with id "${te}" is not a ${t}`):ne=!0:te&&console.error(`wcomponent with id "${te}" does not exist`),ne}function wcomponent_is_action(t,ee=""){return wcomponent_is_a("action",t,ee)}function wcomponent_is_goal(t,ee=""){return wcomponent_is_a("goal",t,ee)}function wcomponent_has_objectives(t,ee=""){return wcomponent_is_action(t,void 0)||wcomponent_is_goal(t,ee)}function wcomponent_is_prioritisation(t,ee=""){return wcomponent_is_a("prioritisation",t,ee)}function wcomponent_is_causal_link(t){return wcomponent_is_a("causal_link",t)}function wcomponent_is_relation_link(t){return wcomponent_is_a("relation_link",t)}function wcomponent_is_plain_connection(t){return wcomponent_is_causal_link(t)||wcomponent_is_relation_link(t)}function wcomponent_type_is_plain_connection(t){return t==="causal_link"||t==="relation_link"}function wcomponent_is_node(t){return wcomponent_is_event(t)||wcomponent_is_statev2(t)||wcomponent_is_process(t)||wcomponent_is_action(t)||wcomponent_is_goal(t)||wcomponent_is_sub_state(t)||wcomponent_is_state_value(t)||wcomponent_is_counterfactual_v2(t)||wcomponent_is_prioritisation(t)}function wcomponent_is_judgement_or_objective(t,ee=""){return wcomponent_is_a("judgement",t,void 0)||wcomponent_is_a("objective",t,ee)}function wcomponent_is_sub_state(t,ee=""){return wcomponent_is_a("sub_state",t,ee)}function wcomponent_is_counterfactual_v2(t,ee=""){return wcomponent_is_a("counterfactualv2",t,ee)}function wcomponent_can_render_connection(t){return wcomponent_is_plain_connection(t)}function wcomponent_has_event_at(t){return t.event_at!==void 0}function wcomponent_is_deleted(t){return t?t.deleted_at!==void 0:void 0}function wcomponent_is_not_deleted(t){return t?t.deleted_at===void 0:void 0}function wcomponent_has_validity_predictions(t){const{validity:ee}=t;return ee!==void 0&&ee.length>0}const types_without_validity=new Set(["prioritisation","counterfactualv2","sub_state"]);function wcomponent_can_have_validity_predictions(t){return!types_without_validity.has(t.type)}function wcomponent_has_VAP_sets(t){return t.values_and_prediction_sets!==void 0}function wcomponent_has_value_possibilities(t){return(t==null?void 0:t.value_possibilities)!==void 0}function wcomponent_is_allowed_to_have_state_VAP_sets(t){return wcomponent_is_statev2(t)||wcomponent_is_state_value(t)||wcomponent_is_action(t)}function wcomponent_has_legitimate_non_empty_state_VAP_sets(t){return wcomponent_has_VAP_sets(t)&&t.values_and_prediction_sets.length>0&&wcomponent_is_allowed_to_have_state_VAP_sets(t)}function wcomponent_has_calculations(t){return t.calculations!==void 0}function wcomponent_allowed_calculations(t){return wcomponent_is_statev2(t)||wcomponent_is_action(t)}const rads={_0:0,_5:.08726646259971647,_10:.17453292519943295,_15:.2617993877991494,_20:.3490658503988659,_25:.4363323129985824,_30:.5235987755982988,_35:.6108652381980153,_40:.6981317007977318,_45:.7853981633974483,_50:.8726646259971648,_55:.9599310885968813,_60:1.0471975511965976,_65:1.1344640137963142,_70:1.2217304763960306,_75:1.3089969389957472,_80:1.3962634015954636,_85:1.48352986419518,_90:1.5707963267948966,_95:1.6580627893946132,_100:1.7453292519943295,_105:1.8325957145940461,_110:1.9198621771937625,_115:2.007128639793479,_120:2.0943951023931953,_125:2.1816615649929116,_130:2.2689280275926285,_135:2.356194490192345,_140:2.443460952792061,_145:2.530727415391778,_150:2.6179938779914944,_155:2.705260340591211,_160:2.792526803190927,_165:2.8797932657906435,_170:2.96705972839036,_175:3.0543261909900767,_180:3.141592653589793,_185:3.2288591161895095,_190:3.3161255787892263,_195:3.4033920413889422,_200:3.490658503988659,_205:3.5779249665883754,_210:3.6651914291880923,_215:3.752457891787808,_220:3.839724354387525,_225:3.9269908169872414,_230:4.014257279586958,_235:4.101523742186674,_240:4.1887902047863905,_245:4.276056667386108,_250:4.363323129985823,_255:4.4505895925855405,_260:4.537856055185257,_265:4.625122517784973,_270:4.71238898038469,_275:4.799655442984406,_280:4.886921905584122,_285:4.974188368183839,_290:5.061454830783556,_295:5.148721293383272,_300:5.235987755982989,_305:5.323254218582705,_310:5.410520681182422,_315:5.497787143782138,_320:5.585053606381854,_325:5.672320068981571,_330:5.759586531581287,_335:5.846852994181004,_340:5.93411945678072,_345:6.021385919380437,_350:6.1086523819801535,_355:6.19591884457987};function get_angle(t,ee,te,ne){const oe=ne-ee,ie=te-t;return Math.atan2(oe,ie)}const TWO_PI=Math.PI*2;function normalise_angle_between_neg_Pi_and_Pi(t){return t+TWO_PI*Math.floor((Math.PI-t)/TWO_PI)}function to_vec(t,ee){const te=ee*Math.cos(t),ne=ee*Math.sin(t);return{x:te,y:ne}}function add_vec(t,ee){return{x:t.x+ee.x,y:t.y+ee.y}}var ConnectionEndType=(t=>(t[t.positive=0]="positive",t[t.negative=1]="negative",t[t.noop=2]="noop",t))(ConnectionEndType||{});function ConnectionEnd(t){const{type:ee,x:te,y:ne,end_angle:oe,opacity:ie,blur:_e,size:se,is_hovered:re,is_highlighted:ae}=t;let ce=`${ae?"highlighted":""} ${re?"hovered":""}`;const de=ie*(1-_e/100),ue={fillOpacity:de};let le;ee===0?le=get_connection_arrow_end(oe,se):ee===1?le=get_connection_bar_end(oe,se):(ue.fillOpacity=0,ue.strokeOpacity=de,le=get_connection_noop_end(oe),ce+=" noop_end ");const pe=points_to_path({x:te,y:ne},le);return o$1("polygon",{className:"connection_end "+ce,points:pe,style:ue})}function points_to_path(t,ee){const{x:te,y:ne}=t;let oe=`${te}, ${-ne} `;return ee.forEach(ie=>oe+=`${te+ie.x}, ${-ne-ie.y} `),oe}function get_connection_arrow_end(t,ee){const te=get_arrow_end_points(t,1,ee),ne=get_arrow_end_points(t,-1,ee);return[te,ne]}const arrow_angle=rads._25;function get_arrow_end_points(t,ee,te){return to_vec(t+ee*arrow_angle,te)}const BAR_WIDTH=12,BAR_HALF_WIDTH=BAR_WIDTH/2,BAR_THICKNESS=4;function get_connection_bar_end(t,ee){ee=ee/10;const te=to_vec(t+rads._90,BAR_HALF_WIDTH*ee),ne=add_vec(to_vec(t,BAR_THICKNESS*ee),te),oe=add_vec(to_vec(t-rads._90,BAR_WIDTH*ee),ne),ie=add_vec(to_vec(t-rads._180,BAR_THICKNESS*ee),oe);return[te,ne,oe,ie]}const NOOP_SIZE=9,NOOP_THICKNESS=Math.sin(rads._45)*NOOP_SIZE*2;function get_connection_noop_end(t){const ee=to_vec(t+rads._315,NOOP_SIZE),te=add_vec(to_vec(t+rads._45,NOOP_SIZE),ee),ne=add_vec(to_vec(t+rads._135,NOOP_SIZE),te),oe=add_vec(to_vec(t+rads._225,NOOP_SIZE),ne);return[ee,te,ne,oe]}const grid_small_step=20,h_step=grid_small_step*18,v_step=grid_small_step*8;function round_number(t,ee){return Math.round(t/ee)*ee}function round_coordinate_small_step(t){return round_number(t,grid_small_step)}function position_to_point(t){return{left:t.x,top:-t.y}}function round_canvas_point(t,ee="small"){return ee==="small"?{left:round_coordinate_small_step(t.left),top:round_coordinate_small_step(t.top)}:{left:round_number(t.left,h_step),top:round_number(t.top,v_step)}}const NODE_WIDTH=250,node_height_approx=(t=!1)=>t?120:59,HALF_NODE_WIDTH=NODE_WIDTH/2,half_node_height=t=>node_height_approx(t)/2;function offset_input_by_half_node(t){return{left:t.left-HALF_NODE_WIDTH,top:t.top-half_node_height(!1)}}function offset_entry_by_half_node(t,ee){const te=t.s??1,ne=t.left+te*HALF_NODE_WIDTH,oe=t.top+te*half_node_height(ee);return{left:ne,top:oe}}function square_distance_between_kv_entries(t,ee){return!t||!ee?Number.POSITIVE_INFINITY:(t.left-ee.left)**2+(t.top-ee.top)**2}const connection_diameter$1=12,connection_radius=connection_diameter$1/2,connection_left=-6,connection_top=27;let connection_top_increment=22;try{navigator.platform.indexOf("Win")>-1&&(connection_top_increment=17)}catch{}const attribute_type_to_ordinal={meta:0,validity:1,state:2};function get_top_left_for_terminal_type(t,ee=1){const te=attribute_type_to_ordinal[t.attribute],ne=ee**1.14,oe=(connection_top+te*connection_top_increment)*ne;return{left:connection_left+(t.side==="right"?NODE_WIDTH:0)*ee,top:oe}}function get_connection_point(t){const{kv_wc_entry:ee,wcomponent_type:te,connection_terminal_type:ne}=t;if(wcomponent_type_is_plain_connection(te))return ee;const ie=ee.s||1;let{left:_e,top:se}=get_top_left_for_terminal_type(ne,ie);return _e+=ee.left+connection_radius,se+=ee.top+connection_radius,{left:_e,top:se}}const MIN_NODE_HORIZONTAL_GAP=45,NODE_WIDTH_plus_min_gap=t=>{let ee=0;if(wcomponent_type_is_plain_connection(t.wcomponent_type))ee=0;else{const{s:te=1}=t.kv_wc_entry;ee=NODE_WIDTH*te}return ee+MIN_NODE_HORIZONTAL_GAP},OFFSET_Y_CONNECTION=30,MINIMUM_LINE_BOW=30,CONNECTION_LENGTH_WHEN_MISSING_ONE_NODE=150;function derive_connection_coords(t){t.end_size===0&&((t.console_warn||console.warn)(`Invalid connection end_size "${t.end_size}", defaulting to 1`),t.end_size=1);const{connection_from_component:ee,connection_to_component:te,line_behaviour:ne,circular_links:oe,end_size:ie,connection_end_type:_e}=t;if(!ee||!te)return derive_connection_coords_when_missing_one_node(t);if(ne==="angular")return derive_connection_coords_for_angular_line({connection_from_component:ee,connection_to_component:te,end_size:ie,connection_end_type:_e});const{offset_line_start_y:se,offset_connection_start_y:re,invert_end_angle:ae,circular_link_from_below_to:ce}=relative_connection_positions({circular_links:oe,connection_from_component:ee,connection_to_component:te}),de=get_connection_point(ee),ue=de.left,le=-de.top+se,pe=get_connection_point(te),me=pe.left,fe=-pe.top+re;let ge=1,he=1;ce!==void 0&&(ue<me?ce?ge=-1:he=-1:ce?he=-1:ge=-1);let be={x:0,y:0},ve=be,ye=get_angle(ue,le,me,fe)+rads._180;if(ne===void 0||ne==="curve"){const $e=(me-ue)/2,Se=Math.max(Math.abs($e),MINIMUM_LINE_BOW)*(Math.sign($e)||-1);let Te=Se*ge,xe=-Se*he,Ie=0,Pe=0;const je=me<=ue;if(!oe&&je){const De=fe-le;Te=Math.min(-Te,300),xe=Math.max(-xe,-300),Ie=De||-MINIMUM_LINE_BOW,Pe=-De||-MINIMUM_LINE_BOW}ye=ae?0:rads._180,be={x:Te,y:Ie},ve={x:xe,y:Pe}}const{line_end_x:ke,line_end_y:Ae}=calculate_line_end_coords({connection_end_type:_e,end_size:ie,end_angle:ye,connection_end_x:me,connection_end_y:fe});return{line_start_x:ue,line_start_y:le,relative_control_point1:be,relative_control_point2:ve,line_end_x:ke,line_end_y:Ae,connection_end_x:me,connection_end_y:fe,end_angle:ye}}function relative_connection_positions(t){const ee={offset_line_start_y:0,offset_connection_start_y:0,invert_end_angle:!1,circular_link_from_below_to:void 0};if(!t.circular_links)return ee;const{connection_from_component:te,connection_to_component:ne}=t,oe=wcomponent_type_is_plain_connection(te.wcomponent_type),ie=wcomponent_type_is_plain_connection(ne.wcomponent_type);let _e=oe||ie?0:OFFSET_Y_CONNECTION;return te.kv_wc_entry.left<ne.kv_wc_entry.left-NODE_WIDTH_plus_min_gap(te)||(ne.kv_wc_entry.left<te.kv_wc_entry.left-NODE_WIDTH_plus_min_gap(ne)?(ee.offset_line_start_y=_e,ee.offset_connection_start_y=_e,ne.connection_terminal_type={...ne.connection_terminal_type,side:"right"},te.connection_terminal_type={...te.connection_terminal_type,side:"left"},ee.invert_end_angle=!0):(ee.circular_link_from_below_to=ne.kv_wc_entry.top<te.kv_wc_entry.top,ee.circular_link_from_below_to?(te.connection_terminal_type={...te.connection_terminal_type,side:"left"},ee.offset_line_start_y=_e):(ne.connection_terminal_type={...ne.connection_terminal_type,side:"right"},ee.offset_connection_start_y=_e,ee.invert_end_angle=!0))),ee}function derive_connection_coords_when_missing_one_node(t){const{connection_from_component:ee,connection_to_component:te,line_behaviour:ne,circular_links:oe,end_size:ie,connection_end_type:_e}=t;let se=0;const re={x:0,y:0},ae=re;let ce;if(ee)se=ee.kv_wc_entry.left+NODE_WIDTH,ce=get_connection_point(ee);else{if(!te)return null;se=te.kv_wc_entry.left-CONNECTION_LENGTH_WHEN_MISSING_ONE_NODE,ce=get_connection_point(te)}const de=-ce.top,ue=se+CONNECTION_LENGTH_WHEN_MISSING_ONE_NODE,le=de,pe=rads._180,{line_end_x:me,line_end_y:fe}=calculate_line_end_coords({connection_end_type:_e,end_size:ie,end_angle:pe,connection_end_x:ue,connection_end_y:le});return{line_start_x:se,line_start_y:de,relative_control_point1:re,relative_control_point2:ae,line_end_x:me,line_end_y:fe,connection_end_x:ue,connection_end_y:le,end_angle:pe}}function calculate_line_end_coords(t){const{connection_end_type:ee,end_angle:te,connection_end_x:ne,connection_end_y:oe}=t,ie=t.end_size/10,_e=ee===ConnectionEndType.negative?BAR_THICKNESS*ie:ee===ConnectionEndType.noop?NOOP_THICKNESS:9*ie,se=ne+Math.cos(te)*_e,re=oe+Math.sin(te)*_e;return{line_end_x:se,line_end_y:re}}function derive_connection_coords_for_angular_line(t){const{connection_from_component:ee,connection_to_component:te,end_size:ne,connection_end_type:oe}=t,ie=80,_e=0,se=ee.kv_wc_entry,re=te.kv_wc_entry;let ae=se.left,ce=-se.top,de=re.left,ue=-re.top;wcomponent_type_is_plain_connection(ee.wcomponent_type)||(ae+=HALF_NODE_WIDTH*(se.s||1),ce-=ie*(se.s||1)),wcomponent_type_is_plain_connection(te.wcomponent_type)||(de+=HALF_NODE_WIDTH*(re.s||1),ue+=_e);const le=3.142/2;return{line_start_x:ae,line_start_y:ce,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:de,line_end_y:ue,connection_end_x:de,connection_end_y:ue,end_angle:le}}function bezier_middle(t){const ee=add_point(t.point1,t.relative_control_point1),te=add_point(t.point2,t.relative_control_point2),ne=average_point(t.point1,ee),oe=average_point(ee,te),ie=average_point(te,t.point2),_e=average_point(ne,oe),se=average_point(oe,ie);return average_point(_e,se)}function add_point(t,ee){return{x:t.x+ee.x,y:t.y+ee.y}}function average_point(t,ee){return{x:(t.x+ee.x)/2,y:(t.y+ee.y)/2}}function CanvasConnection(t){const[ee,te]=h$1(!1),{connection_from_component:ne,connection_to_component:oe,line_behaviour:ie,circular_links:_e,on_pointer_over_out:se=()=>{},connection_end_type:re=ConnectionEndType.positive,is_highlighted:ae=!1}=t,ce=ee?2:t.thickness??2,de=bounded(ce*2.5,10,35),ue=F$1(()=>derive_connection_coords({connection_from_component:ne,connection_to_component:oe,line_behaviour:ie,circular_links:_e,end_size:de,connection_end_type:re}),[ne,oe,ie,_e,de,re]);if(!ue)return null;const le=t.intensity??1,pe=t.blur??0,me={strokeWidth:ce+10},fe={strokeOpacity:le,strokeWidth:ce,filter:pe?`url(#blur_filter_${Math.round(pe)})`:""},ge=ee?" hovered ":t.focused_mode?"":ae?" highlighted ":"",he=(t.on_click?" mouseable ":"")+ge,be=()=>{te(!0),se(!0)},ve=()=>{te(!1),se(!1)};return o$1("g",{className:"connection_container "+(t.extra_css_classes||""),onPointerDown:t.on_click,style:{display:t.hidden?"none":""},children:o$1(CanvasConnectionVisual,{target_connection_coords:ue,extra_background_classes:he,on_pointer_over:be,on_pointer_out:ve,style_line_background:me,extra_line_classes:ge,style_line:fe,connection_end_type:re,opacity:le,blur:pe,end_size:de,hovered:ee,is_highlighted:ae,line_behaviour:ie})})}function CanvasConnectionVisual(t){const[ee,te]=h$1(t.target_connection_coords);p$1(()=>animate_to_target(ee,t.target_connection_coords,te),[t.target_connection_coords]);const ne=calc_d(ee,t.line_behaviour);return o$1(k$1,{children:[o$1("path",{className:"connection_line_background "+t.extra_background_classes,d:ne,onPointerOver:t.on_pointer_over,onPointerOut:t.on_pointer_out,style:t.style_line_background}),o$1("path",{className:"connection_line "+t.extra_line_classes,d:ne,style:t.style_line}),o$1(ConnectionEnd,{type:t.connection_end_type,x:ee.connection_end_x,y:ee.connection_end_y,end_angle:ee.end_angle,opacity:t.opacity,blur:t.blur,size:t.end_size,is_hovered:t.hovered,is_highlighted:t.is_highlighted})]})}function calc_d({line_start_x:t,line_start_y:ee,relative_control_point1:te,relative_control_point2:ne,line_end_x:oe,line_end_y:ie},_e){if(_e===ConnectionLineBehaviour.angular){const de=(ie-ee)/2;return`
            M ${t} ${-ee}
            L ${t} ${-ee-de}
            L ${oe} ${-ee-de}
            L ${oe} ${-ie}
        `}const se=t+te.x,re=-ee-te.y,ae=oe+ne.x,ce=-ie-ne.y;return`
        M ${t} ${-ee}
        C ${se},${re}, ${ae},${ce}, ${oe},${-ie}
    `}const ANIMATION_TOTAL_MS=1*1e3;function animate_to_target(t,ee,te){if(t===ee)return;let ne=performance.now();function oe(ie){if(ne<0)return;let _e=(ie-ne)/ANIMATION_TOTAL_MS;_e=Math.min(_e,1);const se={line_start_x:tween(t.line_start_x,ee.line_start_x,_e),line_start_y:tween(t.line_start_y,ee.line_start_y,_e),relative_control_point1:tween_vector(t.relative_control_point1,ee.relative_control_point1,_e),relative_control_point2:tween_vector(t.relative_control_point2,ee.relative_control_point2,_e),line_end_x:tween(t.line_end_x,ee.line_end_x,_e),line_end_y:tween(t.line_end_y,ee.line_end_y,_e),connection_end_x:tween(t.connection_end_x,ee.connection_end_x,_e),connection_end_y:tween(t.connection_end_y,ee.connection_end_y,_e),end_angle:tween(t.end_angle,ee.end_angle,_e)};_e>=1?(ne=-1,te(ee)):(te(se),requestAnimationFrame(oe))}return requestAnimationFrame(oe),()=>ne=-1}function tween(t,ee,te){return t+(ee-t)*te}function tween_vector(t,ee,te){return{x:tween(t.x,ee.x,te),y:tween(t.y,ee.y,te)}}var SortDirection=(t=>(t[t.ascending=0]="ascending",t[t.descending=1]="descending",t))(SortDirection||{});function sort_list(t,ee,te){const ne=get_sort_function(te);return t.map((oe,ie)=>({item:oe,key_value:ee(oe,ie)})).sort(ne).map(({item:oe})=>oe)}function get_sort_function(t){const ee=t===0,te=ee?-1:1,ne=ee?1:-1;return(oe,ie)=>oe.key_value<ie.key_value?te:oe.key_value>ie.key_value?ne:0}var VAPsType=(t=>(t[t.boolean=0]="boolean",t[t.number=1]="number",t[t.other=2]="other",t[t.action=3]="action",t[t.undefined=4]="undefined",t))(VAPsType||{}),ACTION_VALUE_POSSIBILITY_ID=(t=>(t.action_potential="action__value_possibility__potential_id",t.action_in_progress="action__value_possibility__in_progress_id",t.action_paused="action__value_possibility__paused_id",t.action_completed="action__value_possibility__completed_id",t.action_failed="action__value_possibility__failed_id",t.action_rejected="action__value_possibility__rejected_id",t))(ACTION_VALUE_POSSIBILITY_ID||{});const VALUE_POSSIBILITY_IDS={uncertainty:"value_possibility_uncertainty_id__undefined__",boolean_true:"value_possibility_true_id",boolean_false:"value_possibility_false_id",...ACTION_VALUE_POSSIBILITY_ID},ORDERED_ACTION_VALUE_POSSIBILITY_ID=["action__value_possibility__potential_id","action__value_possibility__in_progress_id","action__value_possibility__paused_id","action__value_possibility__completed_id","action__value_possibility__failed_id","action__value_possibility__rejected_id"],VALUE_POSSIBILITY_IDS_to_text={[VALUE_POSSIBILITY_IDS.uncertainty]:"Uncertainty",[VALUE_POSSIBILITY_IDS.boolean_true]:"True",[VALUE_POSSIBILITY_IDS.boolean_false]:"False",[VALUE_POSSIBILITY_IDS.action_potential]:"Potential",[VALUE_POSSIBILITY_IDS.action_in_progress]:"In Progress",[VALUE_POSSIBILITY_IDS.action_paused]:"Paused",[VALUE_POSSIBILITY_IDS.action_completed]:"Completed",[VALUE_POSSIBILITY_IDS.action_failed]:"Failed",[VALUE_POSSIBILITY_IDS.action_rejected]:"Rejected"};function parse_VAP_value(t,ee){return ee===VAPsType.boolean?t.probability>.5:ee===VAPsType.number?parse_string_as_number(t.value):t.value}function is_string_valid_number(t){return!Number.isNaN(parse_string_as_number(t))}function parse_string_as_number(t){if(t=t.trim(),t==="")return null;const ee=t.match(/^(-?[0-9]*\.?[0-9]*)\s*(?:(e)\s*(-?[0-9]+))?\s*(\%)?$/);let te=NaN;do{if(!ee)break;const[,ne,oe,ie,_e]=ee;if(!ne||(te=parseFloat(ne),Number.isNaN(te)))break;oe&&ie&&(te=te*10**parseInt(ie)),_e&&(te=te/100)}while(!1);return te}function get_parsed_value_represented_by_a_VAP(t,ee){let te=parse_VAP_value(t,ee);return ee===VAPsType.boolean&&(te=t.value_id===VALUE_POSSIBILITY_IDS.boolean_true),te}function get_boolean_representation(t,ee){let te="",ne="";if(wcomponent_is_statev2(t)){const{value_possibilities:oe={}}=t,ie=oe[VALUE_POSSIBILITY_IDS.boolean_true],_e=oe[VALUE_POSSIBILITY_IDS.boolean_false];te=(ie==null?void 0:ie.value)||te,ne=(_e==null?void 0:_e.value)||ne}return te=te?ee?te+" (True)":te:"True",ne=ne?ee?ne+" (False)":ne:"False",{true:te,false:ne}}function parsed_value_to_string(t,ee){let te;return typeof t=="boolean"?te=t?ee.true:ee.false:te=`${t}`,te}const VAP_visual_uncertainty_id="VAP_uncertainty_id__undefined__",VAP_visual_false_id="VAP_false_id__undefined__";function ensure_VAP_set_entries_consistent_with_representing_type(t,ee){let te=ee===VAPsType.boolean?t.entries.slice(0,1):t.entries;return te=expand_booleans(te,ee),{...t,entries:te}}function expand_booleans(t,ee){if(ee===VAPsType.boolean){const te=t[0];if(!te)return t;const ne={...te,probability:1-te.probability,id:VAP_visual_false_id,value_id:VALUE_POSSIBILITY_IDS.boolean_false,description:""};t=[{...te,value_id:VALUE_POSSIBILITY_IDS.boolean_true},ne]}return t}function add_uncertain_VAP_visual(t,ee){const te=1-t,ne={VAP_id:VAP_visual_uncertainty_id,value_id:VALUE_POSSIBILITY_IDS.uncertainty,value_text:"?",certainty:te,parsed_value:null};return[...ee,ne]}function convert_VAP_set_to_VAP_visuals(t){var se;const ee=ensure_VAP_set_entries_consistent_with_representing_type(t.VAP_set,t.VAPs_represent),te=(se=ee.shared_entry_values)==null?void 0:se.conviction;let ne=0;const oe=get_boolean_representation(t.wcomponent),ie=ee.entries.map(re=>{const ae=get_parsed_value_represented_by_a_VAP(re,t.VAPs_represent),ce=parsed_value_to_string(ae,oe),de=te??re.conviction,ue=re.probability*de;return ne+=ue,{VAP_id:re.id,value_id:re.value_id,parsed_value:ae,value_text:ce,certainty:ue}}),_e=sort_list(ie,re=>re.certainty,SortDirection.descending);return add_uncertain_VAP_visual(ne,_e)}function apply_counterfactuals_v2_to_VAP_set(t){const{VAP_set_id_to_counterfactual_v2_map:ee}=t;let{VAP_set:te}=t;const ne=(ee==null?void 0:ee[te.id])||[];let oe=!1,ie;return ne.forEach(_e=>{const{target_VAP_id:se}=_e;se&&(te=distort_VAP_set_for_counterfactual(te,se),oe=!0,ie=_e.id)}),{...te,has_any_counterfactual_applied:oe,active_counterfactual_v2_id:ie}}function distort_VAP_set_for_counterfactual(t,ee){const te=ee===VAP_visual_uncertainty_id?0:1,ne={...t.shared_entry_values,conviction:te},oe=t.entries.map(ie=>{const _e=ie.id===ee?1:0;return{...ie,probability:_e,relative_probability:0,conviction:te}});return{...t,shared_entry_values:ne,entries:oe,target_VAP_id:ee}}function stable_stringify(t,ee={}){const te=ee.sort_items??!1,ne=ee.render_undefined??!1,oe=typeof ee.space=="number"?Array(ee.space+1).join(" "):ee.space||"",ie=typeof ee.cycles=="boolean"?ee.cycles:!1,_e=ee.replacer||((ae,ce)=>is_date(ce)?ce.toISOString():ce instanceof Set?Array.from(ce).sort():ce),se=ee.comparison_function&&function(ae){return function(ce,de){return ee.comparison_function({key:ce,value:ae[ce]},{key:de,value:ae[de]})}},re=[];return function ae(ce,de,ue,le){const pe=oe?`
`+new Array(le+1).join(oe):"",me=oe?": ":":";if(ue=_e.call(ce,de,ue),ue===void 0)return ne?"undefined":void 0;if(typeof ue!="object"||ue===null)return JSON.stringify(ue);if(Array.isArray(ue)){const he=[];for(let be=0;be<ue.length;be++){const ve=ae(ue,be,ue[be],le+1)||JSON.stringify(null);he.push(pe+oe+ve)}return"["+he.join(",")+pe+"]"}if(re.indexOf(ue)!==-1){if(ie)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else re.push(ue);let fe=Object.keys(ue);te&&(fe=fe.sort(se&&se(ue)));const ge=[];return fe.forEach(he=>{const be=ae(ue,he,ue[he],le+1);if(!be)return;const ve=JSON.stringify(he)+me+be;ge.push(pe+oe+ve)}),re.splice(re.indexOf(ue),1),"{"+ge.join(",")+pe+"}"}({"":t},"",t,0)}function is_date(t){return Object.prototype.toString.call(t)==="[object Date]"}let _tests_stats={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0};const tests_stats={get:()=>_tests_stats,reset:()=>{_tests_stats={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0}},print:()=>{const t=_tests_stats;console.log(`
describe: ${t.describe_run+t.describe_skipped}
tests: ${t.test_run+t.test_skipped}`);const ee=t.describe_skipped+t.test_skipped;console.log(`%cskipped: ${ee}`,`color:${ee?"tan":"LightGrey"};font-weight:bold;`),t.test_failed.length&&console.error("failed: "+t.test_failed.join(`
failed: `)),console.log(`%cpassed: ${t.test_passed}${t.test_failed.length?`
failed: ${t.test_failed.length}`:""}
    `,`color:${t.test_failed.length?"red":"green"};font-weight:bold;`)}},test_fn=(t,ee,te="",ne=!0)=>{_tests_stats.test_run+=1;const oe={render_undefined:!0,sort_items:ne},ie=stable_stringify(t,oe),_e=stable_stringify(ee,oe);if(ie===_e){_tests_stats.test_passed+=1;const re=te.split(`
`).filter(ae=>ae.trim())[0];console.log(`pass:  ${re}`)}else{_tests_stats.test_failed.push(`${te} "${ie}" !== "${_e}"`),console.error(`fail:  ${te} "${ie}" !== "${_e}"`);try{if((t==null?void 0:t.constructor)===Object){const re=[...new Set([...Object.keys(t),...Object.keys(ee)])];re.sort(),re.forEach(ae=>{const ce=t[ae],de=ee[ae],ue=stable_stringify(ce,oe),le=stable_stringify(de,oe);if(!(ue===le))console.debug(`Test failure: different values for key "${ae}", got: '${ue}', but expected: '${le}'`);else if(ue==="undefined"){const me=ae in t,fe=ae in ee;me!==fe&&console.debug(`Test failure: key "${ae}", got: ${me?"present":"not present"}, but expected: ${fe?"present":"not present"}`)}})}}catch(re){console.debug("error in providing debugging for test failure",re)}}},test=test_fn;test.skip=(t,ee,te="",ne=!0)=>{_tests_stats.test_skipped+=1,console.warn("skipping  "+te)};const describe_fn=(t,ee)=>{function te(){_tests_stats.describe_run+=1,console.group(t),ee(),console.groupEnd()}return te(),te},describe=describe_fn;describe.skip=(t,ee)=>{function te(){_tests_stats.describe_skipped+=1,console.warn("skipping  "+t)}return te};describe.delay=(t,ee)=>{function te(){_tests_stats.describe_run+=1,console.group(t),ee(),console.groupEnd()}return te};function get_uncertain_datetime(t){return t&&(t.min||t.value||t.max)}function uncertain_datetime_is_eternal(t){return get_uncertain_datetime(t)===void 0}function get_created_at_datetime(t){return t.custom_created_at||t.created_at}function get_created_at_ms(t){return get_created_at_datetime(t).getTime()}function get_sim_datetime(t){return get_uncertain_datetime(t.datetime)}function get_sim_datetime_ms(t){const ee=get_sim_datetime(t);return ee===void 0?void 0:ee.getTime()}function partition_items_by_created_at_datetime(t){const{items:ee,created_at_ms:te}=t,ne=[],oe=[];return ee.forEach(ie=>{get_created_at_ms(ie)>te?ne.push(ie):oe.push(ie)}),{invalid_future_items:ne,current_items:oe}}const test_partition_items_by_created_at_datetime=describe.delay("partition_items_by_created_at_datetime",()=>{function t(le){const pe=partition_items_by_created_at_datetime(le);return{invalid_future_items:pe.invalid_future_items.map(({id:me})=>me),current_items:pe.current_items.map(({id:me})=>me)}}let ee,te;const oe=new Date("2021-04-01 00:00").getTime(),ie=new Date("2021-04-01 00:01"),_e=ie.getTime(),se=new Date("2021-04-01 00:02"),re=se.getTime(),ce=new Date("2021-04-01 00:03").getTime(),de={base_id:-1,id:"1",created_at:ie},ue={base_id:-1,id:"2",created_at:se};ee=[],te=t({items:ee,created_at_ms:ce}),test(te,{invalid_future_items:[],current_items:[]}),ee=[de,ue],te=t({items:ee,created_at_ms:ce}),test(te,{invalid_future_items:[],current_items:[de.id,ue.id]}),te=t({items:ee,created_at_ms:re}),test(te,{invalid_future_items:[],current_items:[de.id,ue.id]}),te=t({items:ee,created_at_ms:_e}),test(te,{invalid_future_items:[ue.id],current_items:[de.id]}),te=t({items:ee,created_at_ms:oe}),test(te,{invalid_future_items:[de.id,ue.id],current_items:[]})});var Tense=(t=>(t[t.past=0]="past",t[t.present=1]="present",t[t.future=2]="future",t[t.eternal=3]="eternal",t))(Tense||{});function get_tense_of_uncertain_datetime(t,ee){const{min:te,value:ne,max:oe}=t.datetime||{},[ie,_e]=te===void 0?[!1,0]:[!0,te.getTime()],[se,re]=ne===void 0?[!1,0]:[!0,ne.getTime()],[ae,ce]=oe===void 0?[!1,0]:[!0,oe.getTime()];if(ie){if(_e>ee)return Tense.future;if(_e===ee||!ae&&_e<ee)return Tense.present}if(ae)return ce<=ee?Tense.past:Tense.present;if(se){if(re<ee)return Tense.past;if(re===ee)return Tense.present;if(re>ee)return Tense.future}return Tense.eternal}const test_get_tense_of_uncertain_datetime=describe.delay("get_tense_of_uncertain_datetime",()=>{let t;const te=new Date("2021-04-01 00:01").getTime(),ne=new Date("2021-04-01 00:02"),oe=ne.getTime(),ie=new Date("2021-04-01 00:03"),_e=ie.getTime(),se=new Date("2021-04-01 00:04"),re=se.getTime(),ce=new Date("2021-04-01 00:05").getTime();t=get_tense_of_uncertain_datetime({datetime:{}},te),test(t,Tense.eternal),t=get_tense_of_uncertain_datetime({datetime:{min:ne}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{min:ne}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne}},_e),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{value:ne}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{value:ne}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{value:ne}},_e),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{max:ne}},te),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{max:ne}},oe),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{max:ne}},_e),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},_e),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},re),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:se}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:se}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:se}},_e),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:se}},re),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:se}},ce),test(t,Tense.past)});function partition_and_sort_by_uncertain_event_datetimes(t){const{items:ee,sim_ms:te}=t,ne=sort_by_uncertain_event_datetimes(ee);return partition_sorted_items_by_datetimes({sorted_items:ne,sim_ms:te})}function sort_by_uncertain_event_datetimes(t,ee=SortDirection.descending){return sort_list(t,({datetime:ne})=>{if(uncertain_datetime_is_eternal(ne))return Number.NEGATIVE_INFINITY;const{max:oe,value:ie,min:_e}=ne;return _e?_e.getTime()*10+2:ie?ie.getTime()*10+1:oe?oe.getTime()*10:1},ee)}function partition_sorted_items_by_datetimes(t){const{sorted_items:ee,sim_ms:te}=t;let ne=[],oe=[],ie=[];const _e=[];ee.forEach(re=>{const ae=get_tense_of_uncertain_datetime(re,te);ae===Tense.past?ne.push(re):ae===Tense.future?_e.push(re):ae===Tense.present?oe.push(re):ie.push(re)}),oe.length!==1&&(oe.length>1?(ne=oe.slice(1).concat(ne),oe=oe.slice(0,1)):ne.length&&(oe=ne.slice(0,1),ne=ne.slice(1))),ie.length&&(oe.length!==1&&(oe=ie.slice(0,1),ie=ie.slice(1)),ne=ne.concat(ie));const se=oe[0];return{past_items:ne,present_item:se,future_items:_e}}const test_partition_sorted_items_by_datetimes=describe.delay("partition_sorted_items_by_datetimes",()=>{function t(de){var le;const ue=partition_sorted_items_by_datetimes(de);return{past_items:ue.past_items.map(({id:pe})=>pe),present_item:(le=ue.present_item)==null?void 0:le.id,future_items:ue.future_items.map(({id:pe})=>pe)}}let ee,te;const oe=new Date("2021-04-01 00:00").getTime(),ie=new Date("2021-04-01 00:01"),_e=ie.getTime(),se=new Date("2021-04-01 00:02"),re=se.getTime(),ce=new Date("2021-04-01 00:03").getTime();ee=[],te=t({sorted_items:ee,sim_ms:ce}),test(te,{past_items:[],present_item:void 0,future_items:[]}),ee=[{id:"10",datetime:{}},{id:"11",datetime:{}}],te=t({sorted_items:ee,sim_ms:oe}),test(te,{past_items:["11"],present_item:"10",future_items:[]},"Can handle multiple eternal elements"),ee=[{id:"30",datetime:{value:se}},{id:"20",datetime:{value:ie}},{id:"10",datetime:{}}],te=t({sorted_items:ee,sim_ms:oe}),test(te,{past_items:[],present_item:"10",future_items:["30","20"]},"Should partition eternal item as present if other items are in the future"),te=t({sorted_items:ee,sim_ms:_e}),test(te,{past_items:["10"],present_item:"20",future_items:["30"]},"Should partition eternal item as past if other items are in the present"),te=t({sorted_items:ee,sim_ms:re}),test(te,{past_items:["20","10"],present_item:"30",future_items:[]},"Should partition eternal item and other past items as past if other items are in the present"),te=t({sorted_items:ee,sim_ms:ce}),test(te,{past_items:["20","10"],present_item:"30",future_items:[]}),ee=[{id:"40",datetime:{min:ie}}],te=t({sorted_items:ee,sim_ms:_e}),test(te,{past_items:[],present_item:"40",future_items:[]},"Should find min datetime as present when sim_ms is equal to min datetime"),te=t({sorted_items:ee,sim_ms:oe}),test(te,{past_items:[],present_item:void 0,future_items:["40"]},"Should find min datetime as future when sim_ms is before min datetime"),ee=[{id:"50",datetime:{max:ie}}],te=t({sorted_items:ee,sim_ms:_e}),test(te,{past_items:[],present_item:"50",future_items:[]},"Should find max datetime as present when sim_ms is equal to max datetime"),ee=[{id:"50",datetime:{max:ie}},{id:"60",datetime:{max:ie}}],te=t({sorted_items:ee,sim_ms:re}),test(te,{past_items:["60"],present_item:"50",future_items:[]},"Should find max datetime as past when sim_ms is later than max datetime but when no other item is present, will use one as present item")}),test_sort_by_uncertain_event_datetimes=describe.delay("sort_by_uncertain_event_datetimes",()=>{function t(ke){return sort_by_uncertain_event_datetimes(ke).map(({id:$e})=>$e)}function ee(ke,Ae){const $e=[...ke].reverse(),Se=Ae.map(({id:xe})=>xe);ne=t(ke);const Te=t($e);test(ne,Te,"",!1),test(ne,Se,"",!1)}let te=[],ne,oe;const ie=new Date("2021-04-01 00:00"),_e=new Date("2021-04-01 00:01"),se=new Date("2021-04-01 00:02"),re=new Date("2021-04-01 00:03");let ae=0;const ce=()=>`${ae++}`,de={id:ce(),datetime:{}},ue={id:ce(),datetime:{}},le={id:ce(),datetime:{value:_e}},pe={id:ce(),datetime:{value:se}},me={id:ce(),datetime:{max:_e}},fe={id:ce(),datetime:{max:se}},ge={id:ce(),datetime:{min:_e}},he={id:ce(),datetime:{min:se}},be={id:ce(),datetime:{min:ie,max:re}},ve={id:ce(),datetime:{min:_e,max:se}};te=[],ne=t(te),test(ne,[],"",!1),te=[de,ue];const we=[...te].reverse();ne=t(te);const ye=t(we);test(JSON.stringify(ne)!==JSON.stringify(ye),!0,"Should be different (indeterminant sort)"),te=[de,le,pe],oe=[pe,le,de],ee(te,oe),te=[de,ge,he],oe=[he,ge,de],ee(te,oe),te=[de,me,fe],oe=[fe,me,de],ee(te,oe),te=[de,le,pe,ge,he,me,fe],oe=[he,pe,fe,ge,le,me,de],ee(te,oe),te=[de,be,ve],oe=[ve,be,de],ee(te,oe)});function group_versions_by_id(t){const ee={};t.forEach(oe=>{const ie=ee[oe.id]||[];ie.push(oe),ee[oe.id]=ie});const te={};return{latest:Object.values(ee).map(oe=>{const ie=sort_list(oe,get_created_at_ms,SortDirection.descending),_e=ie[0];return te[_e.id]=ie.slice(1),_e}),previous_versions_by_id:te}}function partition_and_prune_items_by_datetimes_and_versions(t){const{invalid_future_items:ee,current_items:te}=partition_items_by_created_at_datetime(t),{latest:ne,previous_versions_by_id:oe}=group_versions_by_id(te),ie=partition_and_sort_by_uncertain_event_datetimes({items:ne,sim_ms:t.sim_ms});return{invalid_future_items:ee,...ie,previous_versions_by_id:oe}}function prune_items_by_created_at_and_versions_and_sort_by_datetimes(t,ee){const te=prune_items_by_created_at_and_versions(t,ee);return sort_by_uncertain_event_datetimes(te)}function prune_items_by_created_at_and_versions(t,ee){const{current_items:te}=partition_items_by_created_at_datetime({items:t,created_at_ms:ee}),{latest:ne}=group_versions_by_id(te);return ne}const test_partition_and_prune_items_by_datetimes_and_versions=describe.delay("partition_and_prune_items_by_datetimes_and_versions",()=>{const t=new Date("2021-04-01 00:00"),ee=new Date("2021-04-01 00:01"),te=new Date("2021-04-01 00:02");function ne(ie){return ie.map((_e,se)=>({base_id:-1,id:`vps${se}`,created_at:ee,version:1,datetime:{},entries:[],..._e}))}let oe=ne([{datetime:{value:t},id:"vap_set_0"},{datetime:{value:ee},id:"vap_set_1"},{datetime:{value:te},id:"vap_set_2"}]);describe("all items created in future",()=>{const ie=partition_and_prune_items_by_datetimes_and_versions({items:oe,created_at_ms:t.getTime(),sim_ms:ee.getTime()});test(ie.invalid_future_items,oe,"should have all invalid future items"),test(ie.past_items,[],"should have no past items"),test(ie.present_item,void 0,"should have no present item"),test(ie.future_items,[],"should have no future items"),test(ie.previous_versions_by_id,{},"should have empty map of previous versions")}),describe("all items created in past, sim_ms in middle",()=>{const ie=partition_and_prune_items_by_datetimes_and_versions({items:oe,created_at_ms:ee.getTime(),sim_ms:ee.getTime()});test(ie.invalid_future_items,[],"should have no invalid future items"),test(ie.past_items,[oe[0]],"vap_set_0 should be the one past item"),test(ie.present_item,oe[1],"vap_set_1 should be the one present item"),test(ie.future_items,[oe[2]],"vap_set_2 should be the one future item"),test(ie.previous_versions_by_id,{vap_set_0:[],vap_set_1:[],vap_set_2:[]},"vap sets should have no previous versions")})});function get_current_VAP_set(t){const{values_and_prediction_sets:ee=[],created_at_ms:te,sim_ms:ne}=t,{present_item:oe}=partition_and_prune_items_by_datetimes_and_versions({items:ee,created_at_ms:te,sim_ms:ne});return oe}function get_wcomponent_VAPs_represent(t,ee,te=new Set){let ne=VAPsType.undefined;do{if(te.has((t==null?void 0:t.id)||"")){console.log(`Recursion prevented in "get_wcomponent_VAPs_represent" for wcomponent id: "${t==null?void 0:t.id}" type: "${t==null?void 0:t.type}"`);break}if(t&&te.add(t.id),!wcomponent_is_allowed_to_have_state_VAP_sets(t))break;if(wcomponent_is_statev2(t))ne=subtype_to_VAPsType(t.subtype);else if(wcomponent_is_action(t))ne=VAPsType.action;else if(wcomponent_is_state_value(t)){const oe=ee[t.attribute_wcomponent_id||""];oe&&(ne=get_wcomponent_VAPs_represent(oe,ee,te))}else console.error(`Unimplemented "get_wcomponent_VAPs_represent" for wcomponent id: "${t.id}" type: "${t.type}"`)}while(!1);return ne}function subtype_to_VAPsType(t){return t==="boolean"?VAPsType.boolean:t==="number"?VAPsType.number:t==="other"?VAPsType.other:VAPsType.undefined}const toggle_linked_datetime_sliders_type="toggle_linked_datetime_sliders",toggle_linked_datetime_sliders=()=>({type:toggle_linked_datetime_sliders_type}),is_toggle_linked_datetime_sliders=t=>t.type===toggle_linked_datetime_sliders_type,set_display_time_sliders_type="set_display_time_sliders",set_display_time_sliders=t=>({type:set_display_time_sliders_type,display_time_sliders:t}),is_set_display_time_sliders=t=>t.type===set_display_time_sliders_type,toggle_display_time_sliders_type="toggle_display_time_sliders",toggle_display_time_sliders=()=>({type:toggle_display_time_sliders_type}),is_toggle_display_time_sliders=t=>t.type===toggle_display_time_sliders_type,set_or_toggle_display_side_panel_type="set_or_toggle_display_side_panel",set_or_toggle_display_side_panel=t=>(typeof t!="boolean"&&(t=void 0),{type:set_or_toggle_display_side_panel_type,display_side_panel:t}),is_set_or_toggle_display_side_panel=t=>t.type===set_or_toggle_display_side_panel_type,set_or_toggle_display_select_storage_type="set_or_toggle_display_select_storage",set_or_toggle_display_select_storage=t=>(typeof t!="boolean"&&(t=void 0),{type:set_or_toggle_display_select_storage_type,display_select_storage:t}),is_set_or_toggle_display_select_storage=t=>t.type===set_or_toggle_display_select_storage_type,controls_actions={toggle_linked_datetime_sliders,set_display_time_sliders,toggle_display_time_sliders,set_or_toggle_display_side_panel,set_or_toggle_display_select_storage},toggle_use_creation_context_type="toggle_use_creation_context",toggle_use_creation_context=()=>({type:toggle_use_creation_context_type}),is_toggle_use_creation_context=t=>t.type===toggle_use_creation_context_type,set_custom_created_at_type="set_custom_created_at",set_custom_created_at=t=>({type:set_custom_created_at_type,...t}),is_set_custom_created_at=t=>t.type===set_custom_created_at_type,set_label_ids_type="set_label_ids",set_label_ids=t=>({type:set_label_ids_type,...t}),is_set_label_ids=t=>t.type===set_label_ids_type,set_replace_text_type="set_replace_text",set_replace_text=t=>({type:set_replace_text_type,...t}),is_set_replace_text=t=>t.type===set_replace_text_type,creation_context_actions={toggle_use_creation_context,set_custom_created_at,set_label_ids,set_replace_text},toggle_consumption_formatting_type="toggle_consumption_formatting",toggle_consumption_formatting=t=>({type:toggle_consumption_formatting_type,...t}),is_toggle_consumption_formatting=t=>t.type===toggle_consumption_formatting_type,set_or_toggle_focused_mode_type="set_or_toggle_focused_mode",set_or_toggle_focused_mode=t=>({type:set_or_toggle_focused_mode_type,focused_mode:t}),is_set_or_toggle_focused_mode=t=>t.type===set_or_toggle_focused_mode_type,set_time_resolution_type="set_time_resolution",set_time_resolution=t=>({type:set_time_resolution_type,...t}),is_set_time_resolution=t=>t.type===set_time_resolution_type,set_validity_filter_type="set_validity_filter",set_validity_filter=t=>({type:set_validity_filter_type,...t}),is_set_validity_filter=t=>t.type===set_validity_filter_type,set_certainty_formatting_type="set_certainty_formatting",set_certainty_formatting=t=>({type:set_certainty_formatting_type,...t}),is_set_certainty_formatting=t=>t.type===set_certainty_formatting_type,set_display_by_simulated_time_type="set_display_by_simulated_time",set_display_by_simulated_time=t=>({type:set_display_by_simulated_time_type,display_by_simulated_time:t}),is_set_display_by_simulated_time=t=>t.type===set_display_by_simulated_time_type,set_display_time_marks_type="set_display_time_marks",set_display_time_marks=t=>({type:set_display_time_marks_type,display_time_marks:t}),is_set_display_time_marks=t=>t.type===set_display_time_marks_type,set_or_toggle_animate_connections_type="set_or_toggle_animate_connections",set_or_toggle_animate_connections=t=>({type:set_or_toggle_animate_connections_type,animate_connections:t}),is_set_or_toggle_animate_connections=t=>t.type===set_or_toggle_animate_connections_type,set_or_toggle_circular_links_type="set_or_toggle_circular_links",set_or_toggle_circular_links=t=>({type:set_or_toggle_circular_links_type,circular_links:t}),is_set_or_toggle_circular_links=t=>t.type===set_or_toggle_circular_links_type,set_show_help_menu_type="set_show_help_menu",set_show_help_menu=t=>({type:set_show_help_menu_type,...t}),is_set_show_help_menu=t=>t.type===set_show_help_menu_type,set_or_toggle_show_large_grid_type="set_or_toggle_show_large_grid",set_or_toggle_show_large_grid=t=>({type:set_or_toggle_show_large_grid_type,show_large_grid:t}),is_set_or_toggle_show_large_grid=t=>t.type===set_or_toggle_show_large_grid_type,set_or_toggle_enable_angular_connections_type="set_or_toggle_enable_angular_connections",set_or_toggle_enable_angular_connections=t=>({type:set_or_toggle_enable_angular_connections_type,enable_angular_connections:t}),is_set_or_toggle_enable_angular_connections=t=>t.type===set_or_toggle_enable_angular_connections_type,display_actions={toggle_consumption_formatting,set_or_toggle_focused_mode,set_time_resolution,set_validity_filter,set_certainty_formatting,set_display_by_simulated_time,set_display_time_marks,set_or_toggle_animate_connections,set_or_toggle_circular_links,set_show_help_menu,set_or_toggle_show_large_grid,set_or_toggle_enable_angular_connections},set_apply_filter_type="set_apply_filter",set_apply_filter=t=>({type:set_apply_filter_type,apply_filter:t}),is_set_apply_filter=t=>t.type===set_apply_filter_type,set_filters_type="set_filters",set_filters=t=>({type:set_filters_type,...t}),is_set_filters=t=>t.type===set_filters_type,filter_context_actions={set_apply_filter,set_filters},key_down_type="key_down",key_down=t=>({type:key_down_type,...t}),is_key_down=t=>t.type===key_down_type,key_up_type="key_up",key_up=t=>({type:key_up_type,...t}),is_key_up=t=>t.type===key_up_type,clear_all_keys_type="clear_all_keys",clear_all_keys=()=>({type:clear_all_keys_type}),is_clear_all_keys=t=>t.type===clear_all_keys_type,global_keys_actions={key_down,key_up,clear_all_keys},change_route_type="change_route",change_route=t=>{const ee=t.args;return ee&&(ee.x=round_position(ee.x),ee.y=round_position(ee.y),ee.zoom=round_position(ee.zoom)),{type:change_route_type,...t}};function round_position(t){return t===void 0?t:Math.round(t)}const is_change_route=t=>t.type===change_route_type,routing_actions={change_route};function update_state(t,ee,te){return t[ee]===te?t:{...t,[ee]:te}}function update_substate(t,ee,te,ne){const oe=update_state(t[ee],te,ne);return update_state(t,ee,oe)}function update_subsubstate(t,ee,te,ne,oe){const ie=update_state(t[ee][te],ne,oe),_e=update_state(t[ee],te,ie);return update_state(t,ee,_e)}function update_subsubsubstate(t,ee,te,ne,oe,ie){const _e=update_state(t[ee][te][ne],oe,ie),se=update_state(t[ee][te],ne,_e),re=update_state(t[ee],te,se);return update_state(t,ee,re)}function routing_arg_datetime_strings_to_datetime(t,ee){return t?date_and_time_strings_to_datetime(t,ee||""):new Date}function date_and_time_strings_to_datetime(t,ee){const te=new Date(t+" "+ee);return Number.isNaN(te.getTime())?new Date:te}function get_datetime_and_ms(t){return t.ms===void 0?{ms:t.datetime.getTime(),datetime:t.datetime}:{ms:t.ms,datetime:new Date(t.ms)}}function get_datetime_or_ms(t,ee,te=console.warn){return ee===void 0?t?t.getTime():void 0:(t!==void 0&&te("do not set both new_ms and new_datetime"),ee)}const display_at_created_datetime_reducer=(t,ee)=>{if(is_change_display_at_created_datetime(ee)){const{ms:te,datetime:ne}=get_datetime_and_ms(ee),oe={...t.routing.args,created_at_datetime:ne,created_at_ms:te};t.controls.linked_datetime_sliders&&(oe.sim_datetime=ne,oe.sim_ms=te),t=update_substate(t,"routing","args",oe)}return t},change_display_at_created_datetime_type="change_display_at_created_datetime",change_display_at_created_datetime=t=>({type:change_display_at_created_datetime_type,...t}),is_change_display_at_created_datetime=t=>t.type===change_display_at_created_datetime_type,display_at_created_datetime_actions={change_display_at_created_datetime},one_hour=3600*1e3;function periodically_change_display_at_created_datetime(t){setTimeout(()=>{t.dispatch(change_display_at_created_datetime({datetime:new Date}))},one_hour)}const display_at_sim_datetime_reducer=(t,ee)=>{if(is_change_display_at_sim_datetime(ee)){const{ms:te,datetime:ne}=get_datetime_and_ms(ee),oe={...t.routing.args,sim_datetime:ne,sim_ms:te};t.controls.linked_datetime_sliders&&(oe.created_at_datetime=ne,oe.created_at_ms=te),t=update_substate(t,"routing","args",oe)}return t},change_display_at_sim_datetime_type="change_display_at_sim_datetime",change_display_at_sim_datetime=t=>({type:change_display_at_sim_datetime_type,...t}),is_change_display_at_sim_datetime=t=>t.type===change_display_at_sim_datetime_type,display_at_sim_datetime_actions={change_display_at_sim_datetime},search_reducer=(t,ee)=>(is_update_search_fields(ee)&&(t=update_substate(t,"search","search_fields",ee.search_fields)),is_update_search_type(ee)&&(t=update_substate(t,"search","search_type",ee.search_type)),t),update_search_fields_type="update_search_fields",update_search_type_type="update_search_type",update_search_fields=t=>({type:update_search_fields_type,...t}),is_update_search_fields=t=>t.type===update_search_fields_type,update_search_type=t=>({type:update_search_fields_type,...t}),is_update_search_type=t=>t.type===update_search_type_type,search_actions={update_search_fields,update_search_type};function safe_merge(t,ee={},te={},ne={},oe={},ie={},_e={},se={},re={}){return{...t,...ee,...te,...ne,...oe,...ie,..._e,...se,...re}}function get_wcomponent_from_state(t,ee){return ee?t.specialised_objects.wcomponents_by_id[ee]:void 0}function get_wcomponents_from_ids(t,ee){return ee=ee||[],ee=ee instanceof Set?Array.from(ee):ee,ee.map(te=>t[te])}function get_wcomponents_from_state(t,ee){return ee=ee||[],ee=ee instanceof Set?Array.from(ee):ee,ee.map(te=>get_wcomponent_from_state(t,te))}function get_current_composed_knowledge_view_from_state(t){return t.derived.current_composed_knowledge_view}function get_current_knowledge_view_from_state(t){return t.specialised_objects.knowledge_views_by_id[t.routing.args.subview_id]}function is_on_current_knowledge_view(t,ee){const te=get_current_knowledge_view_from_state(t);if(!te)return!1;const ne=te.wc_id_map[ee];return!!ne&&!ne.passthrough}function get_knowledge_view_from_state(t,ee){return t.specialised_objects.knowledge_views_by_id[ee]}function get_nested_knowledge_view_ids(t,ee){const te=new Set(t.map(_e=>_e.id));t=t.filter(_e=>_e.base_id===ee);const ne=new Set(t.map(_e=>_e.id)),oe={top_ids:[],map:{}},ie=[];return t.forEach(_e=>{const{parent_knowledge_view_id:se,title:re,sort_type:ae="normal"}=_e;se?ie.push({..._e,parent_knowledge_view_id:se}):(oe.top_ids.push(_e.id),oe.map[_e.id]={id:_e.id,title:re,sort_type:ae,parent_id:void 0,child_ids:[]})}),add_child_views(te,ne,ie,oe,ee),oe}function add_child_views(t,ee,te,ne,oe){if(te.length===0)return;const ie=[];if(te.forEach(_e=>{const se=ne.map[_e.parent_knowledge_view_id];if(se){const{id:re,title:ae,sort_type:ce="normal"}=_e;se.child_ids.push(re),ne.map[re]={id:re,title:ae,sort_type:ce,parent_id:se.id,child_ids:[]}}else ie.push(_e)}),te.length===ie.length){const _e=ie.filter(se=>se.base_id===oe);_e.length&&console.warn(`Maybe broken knowledge view tree.  Look in "Views" for:
 * ${_e.map(se=>`${se.title} ${se.id}`).join(`
 * `)}`),ie.forEach(({id:se,title:re,parent_knowledge_view_id:ae})=>{ne.top_ids.push(se);const ce=ee.has(ae),de=!t.has(ae),ue=!ce&&!de;ne.map[se]={id:se,title:re,sort_type:"errored",parent_id:void 0,child_ids:[],ERROR_is_circular:ce,ERROR_parent_kv_missing:de,ERROR_parent_from_diff_base:ue}})}else add_child_views(t,ee,ie,ne,oe)}function sort_nested_knowledge_map_ids_by_priority_then_title(t){t.top_ids=sort_knowledge_map_ids_by_priority_then_title(t.top_ids,t.map),Object.values(t.map).forEach(ee=>{ee.child_ids=sort_knowledge_map_ids_by_priority_then_title(ee.child_ids,t.map)})}const sort_type_to_prefix={priority:"0",normal:"1",hidden:"2",archived:"3",errored:"4"};function sort_knowledge_map_ids_by_priority_then_title(t,ee){return sort_list(t,te=>{const ne=ee[te];return sort_type_to_prefix[ne.sort_type]+ne.title.toLowerCase()},SortDirection.ascending)}function wcomponent_has_knowledge_view(t,ee){return!!ee[t]}function get_current_datetime_from_wcomponent(t,ee,te){const ne=get_current_temporal_value_certainty_from_wcomponent(t,ee,te);return get_uncertain_datetime(ne==null?void 0:ne.temporal_uncertainty)}function get_current_temporal_value_certainty_from_wcomponent(t,ee,te){const ne=ee[t];if(wcomponent_is_event(ne)){let{event_at:oe=[]}=ne;const ie=oe[0];if(!ie)return;const _e=ie.datetime,se=ie.probability*ie.conviction;return{temporal_uncertainty:_e,certainty:se}}else if(wcomponent_is_sub_state(ne)){const{target_wcomponent_id:oe,selector:ie}=ne,_e=ee[oe||""],se=wcomponent_is_allowed_to_have_state_VAP_sets(_e)&&_e;if(!se||!ie)return;const{target_VAP_set_id:re}=ie;if(!re)return;let{values_and_prediction_sets:ae}=se;ae=ae.filter(({id:de})=>de===re),ae=partition_items_by_created_at_datetime({items:ae,created_at_ms:te}).current_items,ae=sort_list(ae,get_created_at_ms,SortDirection.descending);const ce=ae[0];return convert_VAP_set_to_temporal_certainty(ce)}else if(ne&&wcomponent_has_legitimate_non_empty_state_VAP_sets(ne)){const oe=wcomponent_has_single_statev2_datetime(ne);if(oe)return convert_VAP_set_to_temporal_certainty(oe)}}function wcomponent_has_single_statev2_datetime(t){let ee=t.values_and_prediction_sets||[];ee=group_versions_by_id(ee).latest;const te=ee[0];if(te&&ee.length===1)return te;const ne=ee.filter(ie=>!uncertain_datetime_is_eternal(ie.datetime)),oe=ne[0];return oe&&ne.length===1?oe:!1}function convert_VAP_set_to_temporal_certainty(t){var ne;if(!t)return;let ee;const te=(ne=t.shared_entry_values)==null?void 0:ne.conviction;return t.entries.forEach(oe=>{const ie=oe.probability*(te!==void 0?te:oe.conviction);ee=Math.max(ee||0,ie)}),{temporal_uncertainty:t.datetime,certainty:ee}}const highlighting_reducer=(t,ee)=>{if(is_set_highlighted_wcomponent(ee)){const{id:te,highlighted:ne}=ee;let oe=new Set(t.meta_wcomponents.highlighted_wcomponent_ids);te===void 0?oe=new Set:ne?oe.add(te):oe.delete(te),t=update_substate(t,"meta_wcomponents","highlighted_wcomponent_ids",oe);let{neighbour_ids_of_highlighted_wcomponent:ie}=t.meta_wcomponents;if(t.display_options.focused_mode){const se=get_current_composed_knowledge_view_from_state(t);if(se&&(ie=new Set,te!==void 0&&ee.highlighted)){const re=se.wc_id_connections_map[te];re&&(ie=new Set(re),t.derived.wcomponent_ids_by_type.any_node.has(te)&&re.forEach(ae=>{const ce=se.wc_id_connections_map[ae];ce&&ce.forEach(de=>ie.add(de))}))}}else ie.size&&(ie=new Set);t=update_substate(t,"meta_wcomponents","neighbour_ids_of_highlighted_wcomponent",ie)}return t},set_highlighted_wcomponent_type="set_highlighted_wcomponent",set_highlighted_wcomponent=t=>({type:set_highlighted_wcomponent_type,id:t.id,highlighted:t.highlighted}),is_set_highlighted_wcomponent=t=>t.type===set_highlighted_wcomponent_type,highlighting_actions={set_highlighted_wcomponent},replace_all_specialised_objects_type="replace_all_specialised_objects",replace_all_specialised_objects=t=>({type:replace_all_specialised_objects_type,...t}),is_replace_all_specialised_objects=t=>t.type===replace_all_specialised_objects_type,clear_from_mem_all_specialised_objects_type="clear_from_mem_all_specialised_objects",clear_from_mem_all_specialised_objects=()=>({type:clear_from_mem_all_specialised_objects_type}),is_clear_from_mem_all_specialised_objects=t=>t.type===clear_from_mem_all_specialised_objects_type,syncing_actions={replace_all_specialised_objects,clear_from_mem_all_specialised_objects},bulk_edit_wcomponents_type="bulk_edit_wcomponents",bulk_edit_wcomponents=t=>({type:bulk_edit_wcomponents_type,...t}),is_bulk_edit_wcomponents=t=>t.type===bulk_edit_wcomponents_type,bulk_editing_wcomponents_actions={bulk_edit_wcomponents},upsert_wcomponent_type="upsert_wcomponent",upsert_wcomponent=t=>({type:upsert_wcomponent_type,...t}),is_upsert_wcomponent=t=>t.type===upsert_wcomponent_type,delete_wcomponent_type="delete_wcomponent",delete_wcomponent=t=>({type:delete_wcomponent_type,...t}),is_delete_wcomponent=t=>t.type===delete_wcomponent_type,add_wcomponents_to_store_type="add_wcomponents_to_store",add_wcomponents_to_store=t=>({type:add_wcomponents_to_store_type,...t}),is_add_wcomponents_to_store=t=>t.type===add_wcomponents_to_store_type,wcomponent_actions={upsert_wcomponent,delete_wcomponent,add_wcomponents_to_store,...bulk_editing_wcomponents_actions},bulk_edit_knowledge_view_entries_type="bulk_edit_knowledge_view_entries",bulk_edit_knowledge_view_entries=t=>({type:bulk_edit_knowledge_view_entries_type,...t}),is_bulk_edit_knowledge_view_entries=t=>t.type===bulk_edit_knowledge_view_entries_type,bulk_update_knowledge_view_entries_type="bulk_update_knowledge_view_entries",bulk_update_knowledge_view_entries=t=>({type:bulk_update_knowledge_view_entries_type,...t}),is_bulk_update_knowledge_view_entries=t=>t.type===bulk_update_knowledge_view_entries_type,snap_to_grid_knowledge_view_entries_type="snap_to_grid_knowledge_view_entries",snap_to_grid_knowledge_view_entries=t=>({type:snap_to_grid_knowledge_view_entries_type,...t}),is_snap_to_grid_knowledge_view_entries=t=>t.type===snap_to_grid_knowledge_view_entries_type,change_current_knowledge_view_entries_order_type="change_current_knowledge_view_entries_order",change_current_knowledge_view_entries_order=t=>({type:change_current_knowledge_view_entries_order_type,...t}),is_change_current_knowledge_view_entries_order=t=>t.type===change_current_knowledge_view_entries_order_type,bulk_add_to_knowledge_view_type="bulk_add_to_knowledge_view",bulk_add_to_knowledge_view=t=>({type:bulk_add_to_knowledge_view_type,...t}),is_bulk_add_to_knowledge_view=t=>t.type===bulk_add_to_knowledge_view_type,bulk_remove_from_knowledge_view_type="bulk_remove_from_knowledge_view",bulk_remove_from_knowledge_view=t=>({type:bulk_remove_from_knowledge_view_type,...t}),is_bulk_remove_from_knowledge_view=t=>t.type===bulk_remove_from_knowledge_view_type,bulk_editing_knowledge_view_entries_actions={bulk_edit_knowledge_view_entries,bulk_update_knowledge_view_entries,bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries,change_current_knowledge_view_entries_order},upsert_knowledge_view_entry_type="upsert_knowledge_view_entry",upsert_knowledge_view_entry=t=>({type:upsert_knowledge_view_entry_type,...t}),is_upsert_knowledge_view_entry=t=>t.type===upsert_knowledge_view_entry_type,upsert_knowledge_view_type="upsert_knowledge_view",upsert_knowledge_view=t=>({type:upsert_knowledge_view_type,...t}),is_upsert_knowledge_view=t=>t.type===upsert_knowledge_view_type,knowledge_view_actions={upsert_knowledge_view_entry,upsert_knowledge_view,...bulk_editing_knowledge_view_entries_actions},specialised_object_actions=safe_merge(highlighting_actions,syncing_actions,wcomponent_actions,knowledge_view_actions),update_sync_status_type="update_sync_status",update_sync_status=t=>({type:update_sync_status_type,...t}),is_update_sync_status=t=>t.type===update_sync_status_type,debug_refresh_all_specialised_object_ids_pending_save_type="debug_refresh_all_specialised_object_ids_pending_save",debug_refresh_all_specialised_object_ids_pending_save=()=>({type:debug_refresh_all_specialised_object_ids_pending_save_type}),is_debug_refresh_all_specialised_object_ids_pending_save=t=>t.type===debug_refresh_all_specialised_object_ids_pending_save_type,update_specialised_object_sync_info_type="update_specialised_object_sync_info",update_specialised_object_sync_info=t=>({type:update_specialised_object_sync_info_type,...t}),is_update_specialised_object_sync_info=t=>t.type===update_specialised_object_sync_info_type,update_network_status_type="update_network_status",update_network_status=t=>({type:update_network_status_type,...t}),is_update_network_status=t=>t.type===update_network_status_type,request_searching_for_wcomponents_by_id_in_any_base_type="request_searching_for_wcomponents_by_id_in_any_base",request_searching_for_wcomponents_by_id_in_any_base=t=>({type:request_searching_for_wcomponents_by_id_in_any_base_type,...t}),is_request_searching_for_wcomponents_by_id_in_any_base=t=>t.type===request_searching_for_wcomponents_by_id_in_any_base_type,searching_for_wcomponents_by_id_in_any_base_type="searching_for_wcomponents_by_id_in_any_base",searching_for_wcomponents_by_id_in_any_base=()=>({type:searching_for_wcomponents_by_id_in_any_base_type}),is_searching_for_wcomponents_by_id_in_any_base=t=>t.type===searching_for_wcomponents_by_id_in_any_base_type,searched_for_wcomponents_by_id_in_any_base_type="searched_for_wcomponents_by_id_in_any_base",searched_for_wcomponents_by_id_in_any_base=t=>({type:searched_for_wcomponents_by_id_in_any_base_type,...t}),is_searched_for_wcomponents_by_id_in_any_base=t=>t.type===searched_for_wcomponents_by_id_in_any_base_type,sync_actions={update_sync_status,debug_refresh_all_specialised_object_ids_pending_save,update_specialised_object_sync_info,update_network_status,request_searching_for_wcomponents_by_id_in_any_base,searching_for_wcomponents_by_id_in_any_base,searched_for_wcomponents_by_id_in_any_base},set_user_type="set_user",set_user=t=>({type:set_user_type,...t}),is_set_user=t=>t.type===set_user_type,set_need_to_handle_password_recovery_type="set_need_to_handle_password_recovery",set_need_to_handle_password_recovery=t=>({type:set_need_to_handle_password_recovery_type,need_to_handle_password_recovery:t}),is_set_need_to_handle_password_recovery=t=>t.type===set_need_to_handle_password_recovery_type,set_users_type="set_users",set_users=t=>({type:set_users_type,...t}),is_set_users=t=>t.type===set_users_type,update_chosen_base_id_type="update_chosen_base_id",update_chosen_base_id=t=>({type:update_chosen_base_id_type,...t}),is_update_chosen_base_id=t=>t.type===update_chosen_base_id_type,update_bases_type="update_bases",update_bases=t=>({type:update_bases_type,...t}),is_update_bases=t=>t.type===update_bases_type,user_info_actions={set_user,set_need_to_handle_password_recovery,set_users,update_chosen_base_id,update_bases},set_action_ids_to_show_type="set_action_ids_to_show",set_action_ids_to_show=t=>({type:set_action_ids_to_show_type,...t}),is_set_action_ids_to_show=t=>t.type===set_action_ids_to_show_type,view_priorities_actions={set_action_ids_to_show},set_find_all_causal_paths_wcomponent_ids_type="set_find_all_causal_paths_wcomponent_ids",set_find_all_causal_paths_wcomponent_ids=t=>({type:set_find_all_causal_paths_wcomponent_ids_type,...t}),is_set_find_all_causal_paths_wcomponent_ids=t=>t.type===set_find_all_causal_paths_wcomponent_ids_type,find_all_causal_paths_actions={set_find_all_causal_paths_wcomponent_ids},clicked_wcomponent_type="clicked_wcomponent",clicked_wcomponent=t=>({type:clicked_wcomponent_type,...t}),is_clicked_wcomponent=t=>t.type===clicked_wcomponent_type,clear_selected_wcomponents_type="clear_selected_wcomponents",clear_selected_wcomponents=t=>({type:clear_selected_wcomponents_type,...t}),is_clear_selected_wcomponents=t=>t.type===clear_selected_wcomponents_type,set_selected_wcomponents_type="set_selected_wcomponents",set_selected_wcomponents=t=>({type:set_selected_wcomponents_type,...t}),is_set_selected_wcomponents=t=>t.type===set_selected_wcomponents_type,pointerupdown_on_connection_terminal_type="pointerupdown_on_connection_terminal",pointerupdown_on_connection_terminal=t=>({type:pointerupdown_on_connection_terminal_type,...t}),is_pointerupdown_on_connection_terminal=t=>t.type===pointerupdown_on_connection_terminal_type,is_pointerup_on_connection_terminal=t=>is_pointerupdown_on_connection_terminal(t)&&t.up_down==="up",is_pointerdown_on_connection_terminal=t=>is_pointerupdown_on_connection_terminal(t)&&t.up_down==="down",pointerupdown_on_component_type="pointerupdown_on_component",pointerupdown_on_component=t=>({type:pointerupdown_on_component_type,...t}),is_pointerupdown_on_component=t=>t.type===pointerupdown_on_component_type,is_pointerup_on_component=t=>is_pointerupdown_on_component(t)&&t.up_down==="up",is_pointerdown_on_component=t=>is_pointerupdown_on_component(t)&&t.up_down==="down",clear_pointerupdown_on_connection_terminal_type="clear_pointerupdown_on_connection_terminal",clear_pointerupdown_on_connection_terminal=t=>({type:clear_pointerupdown_on_connection_terminal_type,...t}),is_clear_pointerupdown_on_connection_terminal=t=>t.type===clear_pointerupdown_on_connection_terminal_type,set_wcomponent_ids_to_move_type="set_wcomponent_ids_to_move",set_wcomponent_ids_to_move=t=>({type:set_wcomponent_ids_to_move_type,...t}),is_set_wcomponent_ids_to_move=t=>t.type===set_wcomponent_ids_to_move_type,selecting_actions={clicked_wcomponent,clear_selected_wcomponents,set_selected_wcomponents,pointerupdown_on_connection_terminal,pointerupdown_on_component,clear_pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move},set_frame_is_resizing_type="set_frame_is_resizing",set_frame_is_resizing=t=>({type:set_frame_is_resizing_type,...t}),is_set_frame_is_resizing=t=>t.type===set_frame_is_resizing_type,meta_wcomponents_actions=safe_merge({set_frame_is_resizing},selecting_actions,find_all_causal_paths_actions),ACTIONS={controls:controls_actions,creation_context:creation_context_actions,filter_context:filter_context_actions,display:display_actions,sync:sync_actions,routing:routing_actions,global_keys:global_keys_actions,display_at_created_datetime:display_at_created_datetime_actions,display_at_sim_datetime:display_at_sim_datetime_actions,search:search_actions,specialised_object:specialised_object_actions,meta_wcomponents:meta_wcomponents_actions,user_info:user_info_actions,view_priorities:view_priorities_actions};function calc_prediction_is_uncertain({probability:t,conviction:ee}){return t>0&&t<1||ee!==1}function calc_prediction_certainty({probability:t,conviction:ee}){return Math.min(t,ee)}const default_wcomponent_validity_value=()=>({is_valid:!0,certainty:1});function get_wcomponent_validity_value(t){const{wcomponent:ee,created_at_ms:te,sim_ms:ne}=t;if(!wcomponent_has_validity_predictions(ee))return;const oe=partition_and_prune_items_by_datetimes_and_versions({items:ee.validity,created_at_ms:te,sim_ms:ne}).present_item;if(!oe)return;const ie=oe.probability>.5,_e=calc_prediction_certainty(oe);return{is_valid:ie,certainty:_e}}function calc_wcomponent_should_display(t){const{wcomponent:ee,kv_entry:te,sim_ms:ne,selected_wcomponent_ids_set:oe,wc_ids_excluded_by_filters:ie}=t;if(!te||te.blocked)return!1;if(oe.has(ee.id))return{display_certainty:1};if(ie.has(ee.id)||wcomponent_is_not_yet_created(ee,t.created_at_ms))return!1;const{certainty:se}=get_wcomponent_validity_value(t)||default_wcomponent_validity_value();if(get_wcomponent_is_invalid_for_display({validity_certain:se,validity_filter:t.validity_filter}))return!1;let ae=se;if(wcomponent_has_event_at(ee)){const ce=get_certainty_for_wcomponent_event_at({event_at:ee.event_at,sim_ms:ne});ce!==void 0&&(ae=Math.min(ae,ce))}return{display_certainty:ae}}function wcomponent_is_not_yet_created(t,ee){return get_created_at_ms(t)>ee}function get_wcomponent_is_invalid_for_display(t){let ee=!1;const{validity_certain:te,validity_filter:ne}=t;return ne.show_invalid?ee=!0:ne.maybe_invalid?ee=te>0:ne.only_maybe_valid?ee=te>.5:ne.only_certain_valid?ee=te===1:console.error("Unsupported validity_filter: "+JSON.stringify(ne)),!ee}function get_certainty_for_wcomponent_event_at(t){const{event_at:ee,sim_ms:te}=t,ne=ee[0];if(ne)return ne.probability*ne.conviction}function calc_connection_wcomponent_should_display(t){const{from_wc:ee,from_wc__kv_entry:te,to_wc:ne,to_wc__kv_entry:oe}=t,ie=calc_wcomponent_should_display(t);if(!ie)return!1;if(!ee||!ne)return{display_certainty:1};if(!te||!oe)return!1;const _e=calc_wcomponent_should_display({...t,wcomponent:ee,kv_entry:te});return!_e||!calc_wcomponent_should_display({...t,wcomponent:ne,kv_entry:oe})?!1:{display_certainty:Math.min(ie.display_certainty,_e.display_certainty)}}function calc_judgement_connection_wcomponent_should_display(t){const{target_wc:ee,target_wc__kv_entry:te}=t;if(!ee||!te)return!1;const ne=calc_wcomponent_should_display(t);if(!ne)return!1;const oe=calc_wcomponent_should_display({...t,wcomponent:ee,kv_entry:te});return oe?{display_certainty:Math.min(ne.display_certainty,oe.display_certainty)}:!1}function calc_display_opacity(t){if(t.is_highlighted||t.is_selected||t.is_current_item||t.certainty_formatting.render_100_opacity&&!t.focused_mode||t.connected_neighbour_is_highlighted)return 1;if(t.focused_mode)return .1;if(t.is_editing)return 1;const ee=t.certainty_formatting.render_certainty_as_easier_opacity;return t.certainty===1?1:ee?rescale(t.certainty,.4,.7):rescale(t.certainty,.1,.5)}function factory_on_click(t){const{wcomponent_id:ee,shift_or_control_keys_are_down:te,change_route:ne,clicked_wcomponent:oe,clear_selected_wcomponents:ie,is_current_item:_e}=t;return se=>{se.stopImmediatePropagation(),se.preventDefault(),oe({id:ee}),te?ne({route:"wcomponents",sub_route:"wcomponents_edit_multiple",item_id:null}):_e?(ne({route:"wcomponents",sub_route:null,item_id:null}),ie({})):ne({route:"wcomponents",sub_route:null,item_id:ee})}}function get_wc_id_to_counterfactuals_v2_map(t){var ee;return(ee=t.derived.current_composed_knowledge_view)==null?void 0:ee.wc_id_to_active_counterfactuals_v2_map}function get_VAP_set_id_to_counterfactual_v2_map(t,ee){var ne;if(!ee)return;const te=get_wc_id_to_counterfactuals_v2_map(t);return te&&((ne=te[ee])==null?void 0:ne.VAP_sets)}function get_overlapping_wcomponent_ids(t,ee){const{overlapping_wc_ids:te={}}=t.derived.current_composed_knowledge_view||{};return te[ee]}function get_connection_termini(t){const{wcomponent:ee,current_composed_knowledge_view:te,from_wc:ne,to_wc:oe}=t,{kv_entry_from_wc:ie,kv_entry_to_wc:_e,from_attribute:se,to_attribute:re}=get_connection_terminal_node_positions({wcomponent:ee,wc_id_map:te.composed_wc_id_map}),ae={side:"right",attribute:se},ce={side:"left",attribute:re},de=ne==null?void 0:ne.type,ue=oe==null?void 0:oe.type;return{connection_from_component:ie&&de&&{kv_wc_entry:ie,wcomponent_type:de,connection_terminal_type:ae},connection_to_component:_e&&ue&&{kv_wc_entry:_e,wcomponent_type:ue,connection_terminal_type:ce}}}function get_connection_terminal_node_positions({wcomponent:t,wc_id_map:ee}){let te,ne,oe,ie;return wcomponent_is_plain_connection(t)?(te=ee[t.from_id],ne=ee[t.to_id],oe=t.from_type,ie=t.to_type):(te=ee[t.id],ne=ee[t.judgement_target_wcomponent_id],oe="meta",ie="meta"),{kv_entry_from_wc:te,kv_entry_to_wc:ne,from_attribute:oe,to_attribute:ie}}const map_state$1Y=(t,ee)=>{const{id:te}=ee,ne=get_wcomponent_from_state(t,te),{selected_wcomponent_ids_set:oe}=t.meta_wcomponents,{current_composed_knowledge_view:ie}=t.derived,{created_at_ms:_e,sim_ms:se}=t.routing.args,{derived_validity_filter:re}=t.display_options,ae=!t.display_options.consumption_formatting;let ce=!1,de,ue,le;if(!(!ne||!ie)){const{wc_ids_excluded_by_filters:fe}=ie.filters,ge=ie.composed_wc_id_map[ne.id];if(wcomponent_is_plain_connection(ne)){de=get_wcomponent_from_state(t,ne.from_id),ue=get_wcomponent_from_state(t,ne.to_id);const he=ie.composed_wc_id_map[ne.from_id],be=ie.composed_wc_id_map[ne.to_id];ce=calc_connection_wcomponent_should_display({wcomponent:ne,kv_entry:ge,validity_filter:re,from_wc:de,to_wc:ue,from_wc__kv_entry:he,to_wc__kv_entry:be,created_at_ms:_e,sim_ms:se,selected_wcomponent_ids_set:oe,wc_ids_excluded_by_filters:fe}),le=calculate_effect(ne,de,t)}else if(wcomponent_is_judgement_or_objective(ne)){const he=ne.judgement_target_wcomponent_id,be=get_wcomponent_from_state(t,he),ve=ie.composed_wc_id_map[he];ce=calc_judgement_connection_wcomponent_should_display({wcomponent:ne,kv_entry:ge,validity_filter:re,target_wc:be,target_wc__kv_entry:ve,created_at_ms:_e,sim_ms:se,selected_wcomponent_ids_set:oe,wc_ids_excluded_by_filters:fe})}}const pe=ce===!1?!1:ce.display_certainty,me=t.global_keys.derived.shift_or_control_down;return{current_composed_knowledge_view:ie,wcomponent:ne,from_wc:de,to_wc:ue,connection_effect:le,validity_value:pe,is_current_item:t.routing.item_id===te,is_selected:t.meta_wcomponents.selected_wcomponent_ids_set.has(te),is_highlighted:t.meta_wcomponents.highlighted_wcomponent_ids.has(te),is_editing:ae,certainty_formatting:t.display_options.derived_certainty_formatting,shift_or_control_keys_are_down:me,focused_mode:t.display_options.focused_mode,connected_neighbour_is_highlighted:t.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(te),circular_links:t.display_options.circular_links}},map_dispatch$17={clicked_wcomponent:ACTIONS.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:ACTIONS.meta_wcomponents.clear_selected_wcomponents,set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,change_route:ACTIONS.routing.change_route},connector$1_=connect(map_state$1Y,map_dispatch$17);function _WComponentCanvasConnection(t){const{id:ee,current_composed_knowledge_view:te,wcomponent:ne,from_wc:oe,to_wc:ie,is_current_item:_e,is_highlighted:se,is_selected:re,validity_value:ae,connection_effect:ce,shift_or_control_keys_are_down:de,change_route:ue,clicked_wcomponent:le,clear_selected_wcomponents:pe}=t;if(!ne)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${ee}" but could not find it`),null;if(!wcomponent_can_render_connection(ne))return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${ee}" but was not a causal link`),null;if(ae===!1)return null;if(!te)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${ee}" but no current_composed_knowledge_view`),null;const me=factory_on_click({wcomponent_id:ee,clicked_wcomponent:le,clear_selected_wcomponents:pe,shift_or_control_keys_are_down:de,change_route:ue,is_current_item:_e}),fe=get_connection_termini({wcomponent:ne,from_wc:oe,to_wc:ie,current_composed_knowledge_view:te}),{connection_from_component:ge,connection_to_component:he}=F$1(()=>fe,[JSON.stringify(fe)]),be=calc_display_opacity({is_editing:t.is_editing,certainty:ae,is_current_item:_e,is_selected:re,connected_neighbour_is_highlighted:t.connected_neighbour_is_highlighted,certainty_formatting:t.certainty_formatting,focused_mode:t.focused_mode});let ve=2,we=ConnectionEndType.positive,ye="";ce!==void 0&&(ve=bounded(Math.abs(ce),2,15),ce<0?(we=ConnectionEndType.negative,ye="negative_connection_effect"):ce===0&&(we=ConnectionEndType.noop,ye="no_connection_effect"));let ke;return wcomponent_is_plain_connection(ne)&&(ke=ne.line_behaviour),o$1(CanvasConnection,{connection_from_component:ge,connection_to_component:he,on_click:me,on_pointer_over_out:Ae=>t.set_highlighted_wcomponent({id:ee,highlighted:Ae}),line_behaviour:ke,circular_links:t.circular_links,thickness:ve,connection_end_type:we,intensity:be,is_highlighted:_e||se||re,focused_mode:t.focused_mode,extra_css_classes:"connection_type_"+ne.type+" "+ye})}const WComponentCanvasConnection=connector$1_(_WComponentCanvasConnection);function calculate_effect(t,ee,te){var oe;let ne;if(wcomponent_is_causal_link(t)&&(ne=t.effect_when_true,wcomponent_is_statev2(ee))){const ie=get_current_VAP_set({values_and_prediction_sets:ee.values_and_prediction_sets,created_at_ms:te.routing.args.created_at_ms,sim_ms:te.routing.args.sim_ms});if(ie){const _e=get_VAP_set_id_to_counterfactual_v2_map(te,ee.id),se=apply_counterfactuals_v2_to_VAP_set({VAP_set:ie,VAP_set_id_to_counterfactual_v2_map:_e}),ae=get_wcomponent_VAPs_represent(ee,{}),de=(oe=convert_VAP_set_to_VAP_visuals({wcomponent:ee,VAP_set:se,VAPs_represent:ae})[0])==null?void 0:oe.parsed_value;de!=null&&(ae===VAPsType.boolean?ne=de===!0?t.effect_when_true:t.effect_when_false??t.effect_when_true:ne=typeof de=="number"?t.effect_when_true!==void 0?de*t.effect_when_true:void 0:t.effect_when_true)}}return ne!==void 0?bounded(ne,-100,100):void 0}function n(){return n=Object.assign||function(t){for(var ee=1;ee<arguments.length;ee++){var te=arguments[ee];for(var ne in te)Object.prototype.hasOwnProperty.call(te,ne)&&(t[ne]=te[ne])}return t},n.apply(this,arguments)}const e=["children","options"],r=["allowFullScreen","allowTransparency","autoComplete","autoFocus","autoPlay","cellPadding","cellSpacing","charSet","className","classId","colSpan","contentEditable","contextMenu","crossOrigin","encType","formAction","formEncType","formMethod","formNoValidate","formTarget","frameBorder","hrefLang","inputMode","keyParams","keyType","marginHeight","marginWidth","maxLength","mediaGroup","minLength","noValidate","radioGroup","readOnly","rowSpan","spellCheck","srcDoc","srcLang","srcSet","tabIndex","useMap"].reduce((t,ee)=>(t[ee.toLowerCase()]=ee,t),{for:"htmlFor"}),o={amp:"&",apos:"'",gt:">",lt:"<",nbsp:" ",quot:"“"},c=["style","script"],a=/([-A-Z0-9_:]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|(?:\{((?:\\.|{[^}]*?}|[^}])*)\})))?/gi,_$c=/mailto:/i,u=/\n{2,}$/,i$1=/^( *>[^\n]+(\n[^\n]+)*\n*)+\n{2,}/,l=/^ *> ?/gm,s=/^ {2,}\n/,f=/^(?:( *[-*_])){3,} *(?:\n *)+\n/,d$a=/^\s*(`{3,}|~{3,}) *(\S+)?([^\n]*?)?\n([\s\S]+?)\s*\1 *(?:\n *)*\n?/,p=/^(?: {4}[^\n]+\n*)+(?:\n *)+\n?/,m=/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,g=/^(?:\n *)*\n/,y=/\r\n?/g,h=/^\[\^([^\]]+)](:.*)\n/,k=/^\[\^([^\]]+)]/,x=/\f/g,b=/^\s*?\[(x|\s)\]/,v=/^ *(#{1,6}) *([^\n]+?)(?: +#*)?(?:\n *)*(?:\n|$)/,$=/^([^\n]+)\n *(=|-){3,} *(?:\n *)+\n/,S=/^ *(?!<[a-z][^ >/]* ?\/>)<([a-z][^ >/]*) ?([^>]*)\/{0}>\n?(\s*(?:<\1[^>]*?>[\s\S]*?<\/\1>|(?!<\1)[\s\S])*?)<\/\1>\n*/i,z=/&([a-zA-Z]+);/g,w=/^<!--[\s\S]*?(?:-->)/,A=/^(data|aria|x)-[a-z_][a-z\d_.-]*$/,E=/^ *<([a-z][a-z0-9:]*)(?:\s+((?:<.*?>|[^>])*))?\/?>(?!<\/\1>)(\s*\n)?/i,L=/^\{.*\}$/,M=/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,I=/^<([^ >]+@[^ >]+)>/,O=/^<([^ >]+:\/[^ >]+)>/,B=/-([a-z])?/gi,R=/^(.*\|?.*)\n *(\|? *[-:]+ *\|[-| :]*)\n((?:.*\|.*\n)*)\n?/,T=/^\[([^\]]*)\]:\s+<?([^\s>]+)>?\s*("([^"]*)")?/,j=/^!\[([^\]]*)\] ?\[([^\]]*)\]/,C=/^\[([^\]]*)\] ?\[([^\]]*)\]/,D=/(\[|\])/g,N=/(\n|^[-*]\s|^#|^ {2,}|^-{2,}|^>\s)/,Z=/\t/g,F=/^ *\| */,P=/(^ *\||\| *$)/g,G=/ *$/,H=/^ *:-+: *$/,q=/^ *:-+ *$/,U=/^ *-+: *$/,V=/^([*_])\1((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1\1(?!\1)/,W=/^([*_])((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1(?!\1|\w)/,Q=/^==((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)==/,X=/^~~((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)~~/,J=/^\\([^0-9A-Za-z\s])/,K=/^[\s\S]+?(?=[^0-9A-Z\s\u00c0-\uffff&;.()'"]|\d+\.|\n\n| {2,}\n|\w+:\S|$)/i,Y=/^\n+/,tt=/^([ \t]*)/,nt=/\\([^\\])/g,et=/ *\n+$/,rt=/(?:^|\n)( *)$/,ot="(?:\\d+\\.)",ct="(?:[*+-])";function at(t){return"( *)("+(t===1?ot:ct)+") +"}const _t=at(1),ut=at(2);function it(t){return new RegExp("^"+(t===1?_t:ut))}const lt=it(1),st=it(2);function ft(t){return new RegExp("^"+(t===1?_t:ut)+"[^\\n]*(?:\\n(?!\\1"+(t===1?ot:ct)+" )[^\\n]*)*(\\n|$)","gm")}const dt=ft(1),pt=ft(2);function mt(t){const ee=t===1?ot:ct;return new RegExp("^( *)("+ee+") [\\s\\S]+?(?:\\n{2,}(?! )(?!\\1"+ee+" (?!"+ee+" ))\\n*|\\s*\\n*$)")}const gt=mt(1),yt=mt(2);function ht(t,ee){const te=ee===1,ne=te?gt:yt,oe=te?dt:pt,ie=te?lt:st;return{t(_e,se,re){const ae=rt.exec(re);return ae&&(se.o||!se._&&!se.u)?ne.exec(_e=ae[1]+_e):null},i:Gt.HIGH,l(_e,se,re){const ae=te?+_e[2]:void 0,ce=_e[0].replace(u,`
`).match(oe);let de=!1;return{p:ce.map(function(ue,le){const pe=ie.exec(ue)[0].length,me=new RegExp("^ {1,"+pe+"}","gm"),fe=ue.replace(me,"").replace(ie,""),ge=le===ce.length-1,he=fe.indexOf(`

`)!==-1||ge&&de;de=he;const be=re._,ve=re.o;let we;re.o=!0,he?(re._=!1,we=fe.replace(et,`

`)):(re._=!0,we=fe.replace(et,""));const ye=se(we,re);return re._=be,re.o=ve,ye}),m:te,g:ae}},h:(_e,se,re)=>t(_e.m?"ol":"ul",{key:re.k,start:_e.g},_e.p.map(function(ae,ce){return t("li",{key:ce},se(ae,re))}))}}const kt=/^\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,xt=/^!\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,bt=[i$1,d$a,p,v,$,w,R,dt,gt,pt,yt],vt=[...bt,/^[^\n]+(?:  \n|\n{2,})/,S,E];function $t(t){return t.replace(/[ÀÁÂÃÄÅàáâãäåæÆ]/g,"a").replace(/[çÇ]/g,"c").replace(/[ðÐ]/g,"d").replace(/[ÈÉÊËéèêë]/g,"e").replace(/[ÏïÎîÍíÌì]/g,"i").replace(/[Ññ]/g,"n").replace(/[øØœŒÕõÔôÓóÒò]/g,"o").replace(/[ÜüÛûÚúÙù]/g,"u").replace(/[ŸÿÝý]/g,"y").replace(/[^a-z0-9- ]/gi,"").replace(/ /gi,"-").toLowerCase()}function St(t){return U.test(t)?"right":H.test(t)?"center":q.test(t)?"left":null}function zt(t,ee,te){const ne=te.v;te.v=!0;const oe=ee(t.trim(),te);te.v=ne;let ie=[[]];return oe.forEach(function(_e,se){_e.type==="tableSeparator"?se!==0&&se!==oe.length-1&&ie.push([]):(_e.type!=="text"||oe[se+1]!=null&&oe[se+1].type!=="tableSeparator"||(_e.$=_e.$.replace(G,"")),ie[ie.length-1].push(_e))}),ie}function wt(t,ee,te){te._=!0;const ne=zt(t[1],ee,te),oe=t[2].replace(P,"").split("|").map(St),ie=function(_e,se,re){return _e.trim().split(`
`).map(function(ae){return zt(ae,se,re)})}(t[3],ee,te);return te._=!1,{S:oe,A:ie,L:ne,type:"table"}}function At(t,ee){return t.S[ee]==null?{}:{textAlign:t.S[ee]}}function Et(t){return function(ee,te){return te._?t.exec(ee):null}}function Lt(t){return function(ee,te){return te._||te.u?t.exec(ee):null}}function Mt(t){return function(ee,te){return te._||te.u?null:t.exec(ee)}}function It(t){return function(ee){return t.exec(ee)}}function Ot(t,ee,te){if(ee._||ee.u||te&&!te.endsWith(`
`))return null;let ne="";t.split(`
`).every(ie=>!bt.some(_e=>_e.test(ie))&&(ne+=ie+`
`,ie.trim()));const oe=ne.trimEnd();return oe==""?null:[ne,oe]}function Bt(t){try{if(decodeURIComponent(t).replace(/[^A-Za-z0-9/:]/g,"").match(/^\s*(javascript|vbscript|data(?!:image)):/i))return null}catch{return null}return t}function Rt(t){return t.replace(nt,"$1")}function Tt(t,ee,te){const ne=te._||!1,oe=te.u||!1;te._=!0,te.u=!0;const ie=t(ee,te);return te._=ne,te.u=oe,ie}function jt(t,ee,te){const ne=te._||!1,oe=te.u||!1;te._=!1,te.u=!0;const ie=t(ee,te);return te._=ne,te.u=oe,ie}function Ct(t,ee,te){return te._=!1,t(ee+`

`,te)}const Dt=(t,ee,te)=>({$:Tt(ee,t[1],te)});function Nt(){return{}}function Zt(){return null}function Ft(...t){return t.filter(Boolean).join(" ")}function Pt(t,ee,te){let ne=t;const oe=ee.split(".");for(;oe.length&&(ne=ne[oe[0]],ne!==void 0);)oe.shift();return ne||te}var Gt;function Ht(t,ee={}){ee.overrides=ee.overrides||{},ee.slugify=ee.slugify||$t,ee.namedCodesToUnicode=ee.namedCodesToUnicode?n({},o,ee.namedCodesToUnicode):o;const te=ee.createElement||y$1;function ne(le,pe,...me){const fe=Pt(ee.overrides,`${le}.props`,{});return te(function(ge,he){const be=Pt(he,ge);return be?typeof be=="function"||typeof be=="object"&&"render"in be?be:Pt(he,`${ge}.component`,ge):ge}(le,ee.overrides),n({},pe,fe,{className:Ft(pe==null?void 0:pe.className,fe.className)||void 0}),...me)}function oe(le){let pe=!1;ee.forceInline?pe=!0:ee.forceBlock||(pe=N.test(le)===!1);const me=ce(ae(pe?le:`${le.trimEnd().replace(Y,"")}

`,{_:pe}));for(;typeof me[me.length-1]=="string"&&!me[me.length-1].trim();)me.pop();if(ee.wrapper===null)return me;const fe=ee.wrapper||(pe?"span":"div");let ge;if(me.length>1||ee.forceWrapper)ge=me;else{if(me.length===1)return ge=me[0],typeof ge=="string"?ne("span",{key:"outer"},ge):ge;ge=null}return y$1(fe,{key:"outer"},ge)}function ie(le){const pe=le.match(a);return pe?pe.reduce(function(me,fe,ge){const he=fe.indexOf("=");if(he!==-1){const be=function(ke){return ke.indexOf("-")!==-1&&ke.match(A)===null&&(ke=ke.replace(B,function(Ae,$e){return $e.toUpperCase()})),ke}(fe.slice(0,he)).trim(),ve=function(ke){const Ae=ke[0];return(Ae==='"'||Ae==="'")&&ke.length>=2&&ke[ke.length-1]===Ae?ke.slice(1,-1):ke}(fe.slice(he+1).trim()),we=r[be]||be,ye=me[we]=function(ke,Ae){return ke==="style"?Ae.split(/;\s?/).reduce(function($e,Se){const Te=Se.slice(0,Se.indexOf(":"));return $e[Te.replace(/(-[a-z])/g,xe=>xe[1].toUpperCase())]=Se.slice(Te.length+1).trim(),$e},{}):ke==="href"?Bt(Ae):(Ae.match(L)&&(Ae=Ae.slice(1,Ae.length-1)),Ae==="true"||Ae!=="false"&&Ae)}(be,ve);typeof ye=="string"&&(S.test(ye)||E.test(ye))&&(me[we]=sn(oe(ye.trim()),{key:ge}))}else fe!=="style"&&(me[r[fe]||fe]=!0);return me},{}):null}const _e=[],se={},re={blockQuote:{t:Mt(i$1),i:Gt.HIGH,l:(le,pe,me)=>({$:pe(le[0].replace(l,""),me)}),h:(le,pe,me)=>ne("blockquote",{key:me.k},pe(le.$,me))},breakLine:{t:It(s),i:Gt.HIGH,l:Nt,h:(le,pe,me)=>ne("br",{key:me.k})},breakThematic:{t:Mt(f),i:Gt.HIGH,l:Nt,h:(le,pe,me)=>ne("hr",{key:me.k})},codeBlock:{t:Mt(p),i:Gt.MAX,l:le=>({$:le[0].replace(/^ {4}/gm,"").replace(/\n+$/,""),M:void 0}),h:(le,pe,me)=>ne("pre",{key:me.k},ne("code",n({},le.I,{className:le.M?`lang-${le.M}`:""}),le.$))},codeFenced:{t:Mt(d$a),i:Gt.MAX,l:le=>({I:ie(le[3]||""),$:le[4],M:le[2]||void 0,type:"codeBlock"})},codeInline:{t:Lt(m),i:Gt.LOW,l:le=>({$:le[2]}),h:(le,pe,me)=>ne("code",{key:me.k},le.$)},footnote:{t:Mt(h),i:Gt.MAX,l:le=>(_e.push({O:le[2],B:le[1]}),{}),h:Zt},footnoteReference:{t:Et(k),i:Gt.HIGH,l:le=>({$:le[1],R:`#${ee.slugify(le[1])}`}),h:(le,pe,me)=>ne("a",{key:me.k,href:Bt(le.R)},ne("sup",{key:me.k},le.$))},gfmTask:{t:Et(b),i:Gt.HIGH,l:le=>({T:le[1].toLowerCase()==="x"}),h:(le,pe,me)=>ne("input",{checked:le.T,key:me.k,readOnly:!0,type:"checkbox"})},heading:{t:Mt(v),i:Gt.HIGH,l:(le,pe,me)=>({$:Tt(pe,le[2],me),j:ee.slugify(le[2]),C:le[1].length}),h:(le,pe,me)=>ne(`h${le.C}`,{id:le.j,key:me.k},pe(le.$,me))},headingSetext:{t:Mt($),i:Gt.MAX,l:(le,pe,me)=>({$:Tt(pe,le[1],me),C:le[2]==="="?1:2,type:"heading"})},htmlComment:{t:It(w),i:Gt.HIGH,l:()=>({}),h:Zt},image:{t:Lt(xt),i:Gt.HIGH,l:le=>({D:le[1],R:Rt(le[2]),N:le[3]}),h:(le,pe,me)=>ne("img",{key:me.k,alt:le.D||void 0,title:le.N||void 0,src:Bt(le.R)})},link:{t:Et(kt),i:Gt.LOW,l:(le,pe,me)=>({$:jt(pe,le[1],me),R:Rt(le[2]),N:le[3]}),h:(le,pe,me)=>ne("a",{key:me.k,href:Bt(le.R),title:le.N},pe(le.$,me))},linkAngleBraceStyleDetector:{t:Et(O),i:Gt.MAX,l:le=>({$:[{$:le[1],type:"text"}],R:le[1],type:"link"})},linkBareUrlDetector:{t:(le,pe)=>pe.Z?null:Et(M)(le,pe),i:Gt.MAX,l:le=>({$:[{$:le[1],type:"text"}],R:le[1],N:void 0,type:"link"})},linkMailtoDetector:{t:Et(I),i:Gt.MAX,l(le){let pe=le[1],me=le[1];return _$c.test(me)||(me="mailto:"+me),{$:[{$:pe.replace("mailto:",""),type:"text"}],R:me,type:"link"}}},orderedList:ht(ne,1),unorderedList:ht(ne,2),newlineCoalescer:{t:Mt(g),i:Gt.LOW,l:Nt,h:()=>`
`},paragraph:{t:Ot,i:Gt.LOW,l:Dt,h:(le,pe,me)=>ne("p",{key:me.k},pe(le.$,me))},ref:{t:Et(T),i:Gt.MAX,l:le=>(se[le[1]]={R:le[2],N:le[4]},{}),h:Zt},refImage:{t:Lt(j),i:Gt.MAX,l:le=>({D:le[1]||void 0,F:le[2]}),h:(le,pe,me)=>ne("img",{key:me.k,alt:le.D,src:Bt(se[le.F].R),title:se[le.F].N})},refLink:{t:Et(C),i:Gt.MAX,l:(le,pe,me)=>({$:pe(le[1],me),P:pe(le[0].replace(D,"\\$1"),me),F:le[2]}),h:(le,pe,me)=>se[le.F]?ne("a",{key:me.k,href:Bt(se[le.F].R),title:se[le.F].N},pe(le.$,me)):ne("span",{key:me.k},pe(le.P,me))},table:{t:Mt(R),i:Gt.HIGH,l:wt,h:(le,pe,me)=>ne("table",{key:me.k},ne("thead",null,ne("tr",null,le.L.map(function(fe,ge){return ne("th",{key:ge,style:At(le,ge)},pe(fe,me))}))),ne("tbody",null,le.A.map(function(fe,ge){return ne("tr",{key:ge},fe.map(function(he,be){return ne("td",{key:be,style:At(le,be)},pe(he,me))}))})))},tableSeparator:{t:function(le,pe){return pe.v?F.exec(le):null},i:Gt.HIGH,l:function(){return{type:"tableSeparator"}},h:()=>" | "},text:{t:It(K),i:Gt.MIN,l:le=>({$:le[0].replace(z,(pe,me)=>ee.namedCodesToUnicode[me]?ee.namedCodesToUnicode[me]:pe)}),h:le=>le.$},textBolded:{t:Lt(V),i:Gt.MED,l:(le,pe,me)=>({$:pe(le[2],me)}),h:(le,pe,me)=>ne("strong",{key:me.k},pe(le.$,me))},textEmphasized:{t:Lt(W),i:Gt.LOW,l:(le,pe,me)=>({$:pe(le[2],me)}),h:(le,pe,me)=>ne("em",{key:me.k},pe(le.$,me))},textEscaped:{t:Lt(J),i:Gt.HIGH,l:le=>({$:le[1],type:"text"})},textMarked:{t:Lt(Q),i:Gt.LOW,l:Dt,h:(le,pe,me)=>ne("mark",{key:me.k},pe(le.$,me))},textStrikethroughed:{t:Lt(X),i:Gt.LOW,l:Dt,h:(le,pe,me)=>ne("del",{key:me.k},pe(le.$,me))}};ee.disableParsingRawHTML!==!0&&(re.htmlBlock={t:It(S),i:Gt.HIGH,l(le,pe,me){const[,fe]=le[3].match(tt),ge=new RegExp(`^${fe}`,"gm"),he=le[3].replace(ge,""),be=(ve=he,vt.some(Ae=>Ae.test(ve))?Ct:Tt);var ve;const we=le[1].toLowerCase(),ye=c.indexOf(we)!==-1;me.Z=me.Z||we==="a";const ke=ye?le[3]:be(pe,he,me);return me.Z=!1,{I:ie(le[2]),$:ke,G:ye,H:ye?we:le[1]}},h:(le,pe,me)=>ne(le.H,n({key:me.k},le.I),le.G?le.$:pe(le.$,me))},re.htmlSelfClosing={t:It(E),i:Gt.HIGH,l:le=>({I:ie(le[2]||""),H:le[1]}),h:(le,pe,me)=>ne(le.H,n({},le.I,{key:me.k}))});const ae=function(le){let pe=Object.keys(le);function me(fe,ge){let he=[],be="";for(;fe;){let ve=0;for(;ve<pe.length;){const we=pe[ve],ye=le[we],ke=ye.t(fe,ge,be);if(ke){const Ae=ke[0];fe=fe.substring(Ae.length);const $e=ye.l(ke,me,ge);$e.type==null&&($e.type=we),he.push($e),be=Ae;break}ve++}}return he}return pe.sort(function(fe,ge){let he=le[fe].i,be=le[ge].i;return he!==be?he-be:fe<ge?-1:1}),function(fe,ge){return me(function(he){return he.replace(y,`
`).replace(x,"").replace(Z,"    ")}(fe),ge)}}(re),ce=(de=function(le){return function(pe,me,fe){return le[pe.type].h(pe,me,fe)}}(re),function le(pe,me={}){if(Array.isArray(pe)){const fe=me.k,ge=[];let he=!1;for(let be=0;be<pe.length;be++){me.k=be;const ve=le(pe[be],me),we=typeof ve=="string";we&&he?ge[ge.length-1]+=ve:ve!==null&&ge.push(ve),he=we}return me.k=fe,ge}return de(pe,le,me)});var de;const ue=oe(t);return _e.length?ne("div",null,ue,ne("footer",{key:"footer"},_e.map(function(le){return ne("div",{id:ee.slugify(le.B),key:le.B},le.B,ce(ae(le.O,{_:!0})))}))):ue}(function(t){t[t.MAX=0]="MAX",t[t.HIGH=1]="HIGH",t[t.MED=2]="MED",t[t.LOW=3]="LOW",t[t.MIN=4]="MIN"})(Gt||(Gt={}));const Markdown=t=>{let{children:ee,options:te}=t,ne=function(oe,ie){if(oe==null)return{};var _e,se,re={},ae=Object.keys(oe);for(se=0;se<ae.length;se++)ie.indexOf(_e=ae[se])>=0||(re[_e]=oe[_e]);return re}(t,e);return sn(Ht(ee,te),ne)};var Description={},_interopRequireDefault$y=interopRequireDefaultExports;Object.defineProperty(Description,"__esModule",{value:!0});var default_1$y=Description.default=void 0,_createSvgIcon$y=_interopRequireDefault$y(requireCreateSvgIcon()),_jsxRuntime$y=requireJsxRuntime(),_default$y=(0,_createSvgIcon$y.default)((0,_jsxRuntime$y.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"}),"Description");default_1$y=Description.default=_default$y;const WComponentCanvasNode$1="",ConnectableCanvasNode$1="";function CanvasNode(t){const{position:ee,extra_styles:te,display:ne,extra_css_class:oe,title:ie,children:_e}=t,{on_pointer_enter:se,on_pointer_leave:re,on_pointer_down:ae,on_pointer_up:ce,on_click:de}=t,ue={...ee,position:ee?"absolute":"relative",display:ne===void 0||ne?"":"none",...te},pe=`node ${ae||ce||de||se||re?"mouseable":""} ${oe||""}`;return o$1("div",{...t.extra_args,className:pe,style:ue,title:ie,onPointerDown:ae||(me=>{me.stopImmediatePropagation(),me.preventDefault()}),onPointerUp:ce,onClick:de,onPointerEnter:se,onPointerLeave:re,onContextMenu:me=>{me.preventDefault()},children:_e})}const display_colors="";function ConnectableCanvasNode(t){let{opacity:ee}=t;const te={display:t.hidden?"none":"",opacity:ee};t.unlimited_width&&(te.maxWidth="initial");const ne={boxShadow:t.glow?`${t.glow} 0px 0px 10px`:"",backgroundColor:t.color,...t.extra_styles_for_node_main_content},{pointerupdown_on_connection_terminal:oe=()=>{}}=t,ie=" connectable_canvas_node "+(t.extra_css_class||"");return o$1(CanvasNode,{position:t.position,on_pointer_down:t.on_pointer_down,on_pointer_up:t.on_pointer_up,on_click:t.on_click,on_pointer_enter:t.on_pointer_enter,on_pointer_leave:t.on_pointer_leave,extra_css_class:ie,extra_styles:te,extra_args:t.extra_args,children:[o$1(Card,{className:"node_main_content",variant:"outlined",style:ne,children:[t.cover_image&&o$1(CardMedia,{component:"img",image:t.cover_image,className:"node_image_content",onContextMenu:_e=>{_e.stopImmediatePropagation()}}),o$1(CardContent,{style:{padding:16},children:t.node_main_content}),t.terminals.map(({type:_e,style:se,label:re})=>o$1("div",{className:"connection_terminal",style:{...connection_style_common,...se},onPointerDown:ae=>{ae.stopPropagation(),oe(_e,"down")},onPointerUp:ae=>{ae.stopPropagation(),oe(_e,"up")},children:re}))]}),t.other_children]})}const connection_diameter=connection_radius*2,connection_style_common={width:connection_diameter,height:connection_diameter,borderRadius:connection_radius+1},LabelV2$1="";function get_VAPs_ordered_by_prob(t,ee){const te=t[0];return ee===VAPsType.boolean&&te?[te]:t.sort((ne,oe)=>ne.probability>oe.probability?-1:ne.probability<oe.probability?1:0)}function get_most_probable_VAPs(t,ee){const te=get_VAPs_ordered_by_prob(t,ee),ne=te[0];if(!ne)return[];const{probability:oe}=ne;return te.filter(ie=>ie.probability===oe)}const is_defined=t=>t!==void 0;function get_wcomponent_state_value_and_probabilities(t){const{wcomponent:ee,VAP_set_id_to_counterfactual_v2_map:te,created_at_ms:ne,sim_ms:oe}=t;if(!wcomponent_is_allowed_to_have_state_VAP_sets(ee))return{most_probable_VAP_set_values:[],not_allowed_VAP_set_values:!0};const _e=get_wcomponent_VAPs_represent(ee,{}),{values_and_prediction_sets:se=[]}=ee,{present_item:re}=partition_and_prune_items_by_datetimes_and_versions({items:se,created_at_ms:ne,sim_ms:oe}),ae=re===void 0?void 0:apply_counterfactuals_v2_to_VAP_set({VAP_set:re,VAP_set_id_to_counterfactual_v2_map:te}),{most_probable_VAP_set_values:ce,any_uncertainty:de}=get_most_probable_VAP_set_values(ae,_e);let ue=[ae==null?void 0:ae.active_counterfactual_v2_id,ee._derived__using_value_from_wcomponent_id].filter(is_defined);return ue=ue.length?ue:void 0,{most_probable_VAP_set_values:ce,any_uncertainty:de,counterfactual_applied:ae==null?void 0:ae.has_any_counterfactual_applied,derived__using_value_from_wcomponent_ids:ue}}function get_most_probable_VAP_set_values(t,ee){if(!t||t.entries.length===0)return{most_probable_VAP_set_values:[],any_uncertainty:!1};const te=get_VAPs_ordered_by_prob(t.entries,ee);let ne=!1,oe=[];for(const ie of te){const _e=parse_VAP_value(ie,ee),se=calc_prediction_certainty(ie),re=calc_prediction_is_uncertain(ie);if(ne=ne||re,ee===VAPsType.boolean||re||ie.probability!==0){const ce={probability:ie.probability,conviction:ie.conviction,certainty:se,original_value:ie.value,parsed_value:_e,value_id:ie.value_id};if(ie.probability===1&&ie.conviction===1){ne=!1,oe=[ce];break}oe.push(ce)}}return{most_probable_VAP_set_values:oe,any_uncertainty:ne}}function get_wcomponent_state_UI_value(t){const{most_probable_VAP_set_values:ee,any_uncertainty:te,counterfactual_applied:ne,derived__using_value_from_wcomponent_ids:oe}=get_wcomponent_state_value_and_probabilities(t),ie=get_boolean_representation(t.wcomponent),_e=[];ee.forEach(ae=>{const ce=parsed_value_to_string(ae.parsed_value,ie);_e.push(ce)});const se=ee.length>0,re=reduce_display_string_values(_e);return se?{values_string:re,counterfactual_applied:ne,uncertain:te,derived__using_values_from_wcomponent_ids:oe}:void 0}const max_items=3;function reduce_display_string_values(t){let ee=t.slice(0,max_items).join(", ").trim()||"not defined";return t.length>max_items&&(ee+=`, (${t.length-max_items} more)`),ee}function get_default_wcomponent_title(t){let ee="";if(wcomponent_is_plain_connection(t.wcomponent)){const te=t.wcomponents_by_id[t.wcomponent.from_id],ne=t.wcomponents_by_id[t.wcomponent.to_id];(te||ne)&&(ee=`${te?"@@"+te.id:"_"} -> ${ne?"@@"+ne.id:"_"} <auto generated>`)}else if(wcomponent_is_counterfactual_v2(t.wcomponent)){ee="Counterfactual (no target set) <auto generated>";const te=t.wcomponent.target_wcomponent_id;te&&(ee=`Counterfactual of: @@${te} <auto generated>`)}else if(wcomponent_is_sub_state(t.wcomponent)){ee="Sub state (no target set) <auto generated>";const{target_wcomponent_id:te,selector:ne}=t.wcomponent;if(te){if(ee=`Sub state of @@${te}`,ne!=null&&ne.target_value&&(ne!=null&&ne.target_value_id_type)){const{target_value:oe,target_value_id_type:ie}=ne;let _e="";if(ie==="id"){const se=t.wcomponents_by_id[te];if(wcomponent_has_value_possibilities(se)){const re=((se==null?void 0:se.value_possibilities)||{})[oe];re&&(_e=re.value)}}else _e=oe;ee+=": "+_e}ee+=" <auto generated>"}}else if(wcomponent_is_state_value(t.wcomponent)){ee="State value (no target attribute set) <auto generated>";const{attribute_wcomponent_id:te}=t.wcomponent;te&&(ee=te?`Alternative state value for @@${te} `:"No target attribute ",ee+="<auto generated>")}return ee}const uuids_regex=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})$/gi,double_at_mentioned_uuids_regex=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,double_at_mentioned_uuids_regex_capture_surrounding=/(.*)(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})(.*)/gi,only_double_at_mentioned_uuids_regex=/^\s*(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\s*$/gi;function is_valid_uuid(t){return!!t.match(uuids_regex)}const old_ids_and_functions_regex=/.*?(@@\w*\d+)\.([\w]+)/g,uuids_and_functions_regex=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\.([\w]+)/gi,format_wcomponent_id_error=(t,ee)=>`✗${t} (${ee})`,format_wcomponent_url=(t,ee,te="")=>`${t}#wcomponents/${ee}`+(te?`&subview_id=${te}`:""),format_wcomponent_link=(t,ee,te="□",ne="")=>`[${te}](${format_wcomponent_url(t,ee,ne)})`;function replace_function_ids_in_text(t,ee,te){const{get_title:ne,root_url:oe,render_links:ie,depth_limit:_e}=te;if(ee>=_e)return t;const se=get_functional_ids_from_text(t);return se.length===0||(se.forEach(({id:re,funktion:ae})=>{const ce=te.wcomponents_by_id[re];if(!is_supported_funktion(ae))return;let de="";if(ae==="map"){const le=te.knowledge_views_by_id[re],pe=(le==null?void 0:le.title)||re;de=format_wcomponent_link(oe,ce?re:"",pe,re)}else if(ce)if(ae==="url")de=format_wcomponent_url(oe,re);else if(ae==="value"){const le=new Date().getTime(),pe=get_wcomponent_state_UI_value({wcomponent:ce,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:le,sim_ms:le});de=(pe==null?void 0:pe.values_string)||""}else de=ie?format_wcomponent_link(oe,re):"",ae==="title"?de=ne(ce):ae==="description"&&(de+=ce.description);else return;const ue=new RegExp(`@@${re}.${ae}`,"g");t=t.replace(ue,de)}),ee<_e&&(t=replace_function_ids_in_text(t,ee+1,te))),t}function get_functional_ids_from_text(t){return[...t.matchAll(uuids_and_functions_regex),...t.matchAll(old_ids_and_functions_regex)].map(te=>({id:te[1].slice(2),funktion:te[2]}))}const _supported_functions={url:!0,title:!0,description:!0,map:!0,value:!0},supported_funktions=new Set(Object.keys(_supported_functions));function is_supported_funktion(t){return supported_funktions.has(t)}function replace_normal_ids(t,ee,te){const{root_url:ne,depth_limit:oe,get_title:ie,render_links:_e}=te;return get_double_at_mentioned_uuids_from_text(t).forEach(re=>{const ae=new RegExp(`@@${re}`,"g"),ce=te.wcomponents_by_id[re];if(!ce){const le=_e?format_wcomponent_link(ne,re,`@@${re}`):`@@${re}`;t=t.replace(ae,format_wcomponent_id_error(le,"not found"));return}const de=ee<oe?ie(ce):`@@${re}`,ue=_e?format_wcomponent_link(ne,re,de):de;t=t.replace(ae,ue)}),t}function get_double_at_mentioned_uuids_from_text(t){return[...t.matchAll(double_at_mentioned_uuids_regex)].map(te=>te[1].slice(2))}const DEFAULT_MAX_DEPTH_LIMIT=3;var RichTextType=(t=>(t[t.raw=0]="raw",t[t.plain=1]="plain",t[t.rich=2]="rich",t))(RichTextType||{});function get_title$1(t){const{wcomponent:ee,wc_id_to_counterfactuals_map:te,created_at_ms:ne,sim_ms:oe}=t,ie=t.text_type??2;let _e=ee.title;if(_e||(_e=get_default_wcomponent_title(t)),ie===0)return _e;const se=replace_value_in_text({text:_e,wcomponent:ee,wc_id_to_counterfactuals_map:te,created_at_ms:ne,sim_ms:oe});return replace_ids_in_text({...t,text:se,text_type:ie})}function replace_value_in_text(t){var _e;let{text:ee,wcomponent:te,wc_id_to_counterfactuals_map:ne={}}=t;if(!ee.includes("${value}"))return ee;const oe=(_e=ne[te.id])==null?void 0:_e.VAP_sets,ie=get_wcomponent_state_UI_value({wcomponent:te,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return ie&&(ee=ee.replace(/\$\{value\}/g,`${ie.values_string}`)),ee}function replace_ids_in_text(t){const{text:ee,text_type:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,depth_limit:ie=DEFAULT_MAX_DEPTH_LIMIT,current_depth:_e=0,root_url:se="",wc_id_to_counterfactuals_map:re,created_at_ms:ae,sim_ms:ce}=t;return te===0?ee:_replace_ids_in_text(ee,te,ne,oe,ie,_e,se,re,ae,ce)}function _replace_ids_in_text(t,ee,te,ne,oe,ie,_e,se,re,ae){ee=ee===2?ie===0?2:1:ee;function ce(ue){return get_title$1({text_type:ee,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:se,created_at_ms:re,sim_ms:ae,depth_limit:oe,current_depth:ie+1,root_url:_e,wcomponent:ue})}const de={wcomponents_by_id:te,knowledge_views_by_id:ne,depth_limit:oe,render_links:ee===2,root_url:_e,get_title:ce};return t=replace_function_ids_in_text(t,ie,de),t=replace_normal_ids(t,ie,de),t}function color_to_string(t){return t?`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`:""}function color_to_opposite(t){if(!t)return{r:0,g:0,b:0,a:1};const te=t.r+t.g+t.b<383?255:0;return{r:te,g:te,b:te,a:1}}function darker_color(t){if(t)return{r:t.r/2,g:t.g/2,b:t.b/2,a:t.a}}const regexp_code_block=/^(([ ]{0,3}```)|([ ]{4,})).*/gm,regexp_list_line=/^[ \t]*(\*|\d+\.)/gm,regexp_text_line=/^[ \t]*[^\s]+/gm;function add_newlines_to_markdown(t){const ee=[];let te=!1;const ne=t.split(`
`);return ne.forEach((ie,_e)=>{if(_e>0){const se=ne[_e-1];se.match(regexp_code_block)&&(te=!te),te||se.match(regexp_text_line)&&!se.match(regexp_list_line)&&(ie.match(regexp_list_line)?ee[_e-1]=se+`
`:ie.match(regexp_text_line)&&(ee[_e-1]=se+"<br>"))}ee.push(ie)}),ee.join(`
`)}const test_add_newlines_to_markdown=describe.delay("add_newlines_to_markdown",()=>{test(add_newlines_to_markdown(`
test 1
test2
`),`
test 1<br>
test2
`);const t=`* Test bullet 1
* Test bullet 2`;test(add_newlines_to_markdown(t),t);let te=add_newlines_to_markdown(`Test 1
Test
  Test 3  
	Test 4
* Test bullet 1
* Test bullet 2

Test 5
1. Test number 1
2. Test number 2

`),ne=`Test 1<br>
Test<br>
  Test 3  <br>
	Test 4

* Test bullet 1
* Test bullet 2

Test 5

1. Test number 1
2. Test number 2

`;test(te,ne),describe("Code blocks should not contain <br>",()=>{te=add_newlines_to_markdown("\n```\nsome text\n```\n"),ne="\n```\nsome text\n```\n",test(te,ne,"Three ``` should stop <br> insertion"),te=add_newlines_to_markdown("\n   ```\nsome text\n```\n"),ne="\n   ```\nsome text\n```\n",test(te,ne,"Three ``` with three prepended spaces should stop <br> insertion"),te=add_newlines_to_markdown(`
   more text
   some more text
`),ne=`
   more text<br>
   some more text
`,test(te,ne,"Three prepended spaces for normal text should allow <br> insertion"),te=add_newlines_to_markdown("\n    ```some text\n    some more text\n"),ne="\n    ```some text\n    some more text\n",test(te,ne,"Four prepended spaces for ``` and normal text should stop <br> insertion")})});function AnchorTag(t){return o$1("a",{href:t.href,onClick:ee=>ee.stopImmediatePropagation(),onPointerDown:ee=>ee.stopImmediatePropagation(),children:t.children})}const map_state$1X=t=>({rich_text:t.display_options.consumption_formatting,composed_wcomponents_by_id:t.derived.composed_wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}),connector$1Z=connect(map_state$1X);function _RichMarkDown(t){const{text:ee,rich_text:te,composed_wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,placeholder:_e="...",created_at_ms:se,sim_ms:re}=t,ae=te?RichTextType.rich:RichTextType.raw,ce=replace_ids_in_text({text:ee,text_type:ae,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,created_at_ms:se,sim_ms:re});return o$1(Markdown,{options:MARKDOWN_OPTIONS,children:ce&&add_newlines_to_markdown(ce)||_e})}const RichMarkDown=connector$1Z(_RichMarkDown),MARKDOWN_OPTIONS={overrides:{a:AnchorTag,script:t=>t.children,auto:t=>"",iframe:t=>{const{src:ee}=t;return new URL(ee).hostname==="www.youtube.com"?o$1("iframe",{...t}):null},tweet:t=>{const ee=`https://platform.twitter.com/embed/Tweet.html?dnt=false&frame=false&hideCard=false&hideThread=false&id=${t.id}&lang=en-gb&theme=light&widgetsVersion=0a8eea3%3A1643743420422&width=400px"`;return o$1("iframe",{src:ee,scrolling:"no",frameBorder:0,allowTransparency:!0,allowFullScreen:!0,style:{width:401,height:624}})},img:t=>{var ee;return(ee=t.style)==null||delete ee.position,o$1("img",{src:t.src,style:t.style,alt:t.alt})}}},COLOURS={white:{r:255,g:255,b:255,a:1},white_a75:{r:255,g:255,b:255,a:.75}};function map_state$1W(t,{wcomponent_id:ee}){const{wcomponents_by_id:te,knowledge_views_by_id:ne}=t.specialised_objects;return{wcomponent:te[ee],wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}}const connector$1Y=connect(map_state$1W);function _LabelV2(t){const{wcomponent:ee}=t,te=ee?get_title$1({wcomponent:ee,wcomponents_by_id:t.wcomponents_by_id,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:t.wc_id_to_counterfactuals_map,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}):"&lt;Label not found&gt;";return o$1("div",{className:"label_v2",style:{backgroundColor:color_to_string((ee==null?void 0:ee.label_color)||COLOURS.white_a75),color:color_to_string(color_to_opposite(ee==null?void 0:ee.label_color))},children:o$1(Markdown,{options:MARKDOWN_OPTIONS,children:te})})}const LabelV2=connector$1Y(_LabelV2);function LabelsListV2(t){return o$1("div",{style:{display:"flex",flexWrap:"wrap"},children:(t.label_ids||[]).map(ee=>o$1(LabelV2,{wcomponent_id:ee}))})}function wcomponent_type_to_text(t){return t==="counterfactualv2"?"counterfactual":t==="statev2"?"state":t.replaceAll("_"," ")}function WarningTriangle(t){const ee="⚠";return o$1("span",{style:{backgroundColor:t.backgroundColor||"yellow",color:"black"},title:t.message,children:ee})}const WComponentJudgements$1="";function calculate_judgement_value(t){const{judgement_wcomponent:ee,target_wcomponent:te,VAP_set_id_to_counterfactual_v2_map:ne,created_at_ms:oe,sim_ms:ie}=t;if(ee.judgement_manual!==void 0)return ee.judgement_manual;if(!te)return;const{most_probable_VAP_set_values:_e}=get_wcomponent_state_value_and_probabilities({wcomponent:te,VAP_set_id_to_counterfactual_v2_map:ne,created_at_ms:oe,sim_ms:ie});if(_e.length!==1)return;const re=_e[0].parsed_value,ce=get_wcomponent_VAPs_represent(te,{});return core_calculate_judgement_value({judgement_wcomponent:ee,target_VAPs_represent:ce,value:re})}function core_calculate_judgement_value(t){const{judgement_wcomponent:ee,target_VAPs_represent:te,value:ne}=t,{judgement_operator:oe,judgement_comparator_value:ie,judgement_manual:_e}=ee;if(_e!==void 0)return _e;const se=te===VAPsType.number?parseFloat(ie||""):te===VAPsType.boolean?ie==="True"||(ie==="False"?!1:void 0):ie;let re;return ne===null||se===void 0?re=void 0:oe==="=="?re=ne===se:oe==="!="?re=ne!==se:oe==="<"?re=ne<se:oe==="<="?re=ne<=se:oe===">"?re=ne>se:oe===">="&&(re=ne>=se),re}var TrendingUp={},_interopRequireDefault$x=interopRequireDefaultExports;Object.defineProperty(TrendingUp,"__esModule",{value:!0});var default_1$x=TrendingUp.default=void 0,_createSvgIcon$x=_interopRequireDefault$x(requireCreateSvgIcon()),_jsxRuntime$x=requireJsxRuntime(),_default$x=(0,_createSvgIcon$x.default)((0,_jsxRuntime$x.jsx)("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"}),"TrendingUp");default_1$x=TrendingUp.default=_default$x;var TrendingFlat={},_interopRequireDefault$w=interopRequireDefaultExports;Object.defineProperty(TrendingFlat,"__esModule",{value:!0});var default_1$w=TrendingFlat.default=void 0,_createSvgIcon$w=_interopRequireDefault$w(requireCreateSvgIcon()),_jsxRuntime$w=requireJsxRuntime(),_default$w=(0,_createSvgIcon$w.default)((0,_jsxRuntime$w.jsx)("path",{d:"m22 12-4-4v3H3v2h15v3z"}),"TrendingFlat");default_1$w=TrendingFlat.default=_default$w;var TrendingDown={},_interopRequireDefault$v=interopRequireDefaultExports;Object.defineProperty(TrendingDown,"__esModule",{value:!0});var default_1$v=TrendingDown.default=void 0,_createSvgIcon$v=_interopRequireDefault$v(requireCreateSvgIcon()),_jsxRuntime$v=requireJsxRuntime(),_default$v=(0,_createSvgIcon$v.default)((0,_jsxRuntime$v.jsx)("path",{d:"m16 18 2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"}),"TrendingDown");default_1$v=TrendingDown.default=_default$v;function CommonIcon(t){var te,ne;let{className:ee=""}=t;return ee="MuiSvgIcon-root "+ee,t.fontSize==="small"&&(ee+=" MuiSvgIcon-fontSizeSmall "),o$1("span",{title:t.title,style:{width:(te=t.style)==null?void 0:te.width,height:(ne=t.style)==null?void 0:ne.height},children:o$1("svg",{className:ee,viewBox:"0 0 24 24",style:t.style,children:[o$1("path",{d:t.d}),t.svg_elements]})})}const d$9="M11.07 12.85c.77-1.39 2.25-2.21 3.11-3.44.91-1.29.4-3.7-2.18-3.7-1.69 0-2.52 1.28-2.87 2.34L6.54 6.96C7.25 4.83 9.18 3 11.99 3c2.35 0 3.96 1.07 4.78 2.41.7 1.15 1.11 3.3.03 4.9-1.2 1.77-2.35 2.31-2.97 3.45-.25.46-.35.76-.35 2.24h-2.89c-.01-.78-.13-2.05.48-3.15zM14 20c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z";function QuestionMarkIcon(t){return o$1(CommonIcon,{...t,d:d$9})}const JudgementBadge$1="",Link$1="",month_to_3text={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function date2str(t,ee){const te={M:t.getMonth()+1,d:t.getDate(),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()};return ee=ee.replace(/MMM/g,function(ne){return month_to_3text[t.getMonth()]||""}),ee=ee.replace(/(M+|d+|h+|m+|s+)/g,function(ne){return((ne.length>1?"0":"")+te[ne.slice(-1)]).slice(-2)}),ee.replace(/(y+)/g,function(ne){return t.getFullYear().toString().slice(-ne.length)})}function date2str_auto(t){const{date:ee,time_resolution:te="minute",trim_midnight:ne=!0}=t,ie=date2str(ee,te==="day"?"yyyy-MM-dd":te==="hour"?"yyyy-MM-dd hh:00":te==="minute"?"yyyy-MM-dd hh:mm":"yyyy-MM-dd hh:mm:ss");return ne?ie.replace(" 00:00",""):ie}function get_today_str(t=!0){return date2str(new Date,"yyyy-MM-dd")+(t?" 00:00":"")}function get_today_date(){return new Date(get_today_str())}const MSECONDS_IN_DAY=24*3600*1e3,TIME_ZONE_IN_MS=new Date().getTimezoneOffset()*6e4;function*get_inclusive_dates(t,ee){const te=Math.floor((t.getTime()-TIME_ZONE_IN_MS)/MSECONDS_IN_DAY),ne=Math.ceil((ee.getTime()-TIME_ZONE_IN_MS)/MSECONDS_IN_DAY);let oe=te;for(;oe<ne;)yield new Date(oe*MSECONDS_IN_DAY),++oe}function get_inclusive_date_strs(t,ee){const te="yyyy-MM-dd";return[...get_inclusive_dates(t,ee)].map(ne=>date2str(ne,te))}const ALLOWED_SUB_ROUTES={views:[],wcomponents:["wcomponents_edit_multiple"],search:[],filter:[],select:[],display:[],statements:[],objects:["objects_bulk_import","objects_bulk_import/setup"],patterns:[],creation_context:[],about:[]},ALLOWED_ROUTES=Object.keys(ALLOWED_SUB_ROUTES),_view_types={priorities:!0,priorities_list:!0,actions_list:!0,knowledge:!0,objectives:!0},routing_view_types=Object.keys(_view_types),is_routing_view_types=t=>routing_view_types.includes(t),ALLOWED_ROUTE_ARGS={view:!0,subview_id:!0,zoom:!0,x:!0,y:!0,storage_location:!0,cdate:!0,ctime:!0,sdate:!0,stime:!0},ALLOWED_ROUTE_ARGS_COUNT=Object.keys(ALLOWED_ROUTE_ARGS).length;function routing_state_to_string(t){const ee=t.sub_route?`${t.sub_route}/`:"",te=t.item_id?`${t.item_id}/`:"",ne=t.args,oe=routing_args_to_string(ne);return"#"+t.route+"/"+ee+te+oe}const exclude_routing_keys=new Set(["order","rotation","created_at_datetime","created_at_ms","sim_datetime","sim_ms"]);function routing_args_to_string(t){const ee={...t,cdate:date2str(t.created_at_datetime,"yyyy-MM-dd"),ctime:date2str(t.created_at_datetime,"hh:mm:ss"),sdate:date2str(t.sim_datetime,"yyyy-MM-dd"),stime:date2str(t.sim_datetime,"hh:mm:ss")};return Object.keys(t).filter(ne=>!exclude_routing_keys.has(ne)).sort().concat(["sdate","stime","cdate","ctime"]).map(ne=>`&${ne}=${ee[ne]??""}`).join("")}function url_is_incomplete(t){const ee=parse_url(t);return!ee.route||ee.args_from_url.length!==ALLOWED_ROUTE_ARGS_COUNT}function parse_url(t){const te=(t.split("#")[1]||"").split("&"),oe=te[0].split("/").filter(ae=>!!ae),{route:ie,sub_route:_e,item_id:se}=get_route_subroute_and_item_id(oe),re=te.slice(1).map(ae=>ae.split("=")).filter(ae=>ALLOWED_ROUTE_ARGS[ae[0]]);return{route:ie,sub_route:_e,item_id:se,args_from_url:re}}function merge_route_params_prioritising_url_over_state(t,ee){const{route:te,sub_route:ne,item_id:oe,args_from_url:ie}=parse_url(t),_e=update_args_from_url(ee.args,ie);return{route:te,sub_route:ne,item_id:oe,args:_e}}function get_route_subroute_and_item_id(t){let ee=t[0],te=null,ne=null;if(!ALLOWED_ROUTES.includes(ee))ee="wcomponents";else{const oe=t.slice(1).join("/")||null;ALLOWED_SUB_ROUTES[ee].includes(oe)?te=oe:ne=oe}return{route:ee,sub_route:te,item_id:ne}}function update_args_from_url(t,ee){t={...t};let te=null,ne=null,oe=null,ie=null;return ee.forEach(_e=>{const[se,re]=_e;se==="cdate"?te=re:se==="ctime"?ne=re:se==="sdate"?oe=re:se==="stime"?ie=re:update_args_with_value(t,se,re)}),t.created_at_datetime=routing_arg_datetime_strings_to_datetime(te,ne),t.sim_datetime=oe?routing_arg_datetime_strings_to_datetime(oe,ie):t.created_at_datetime,t.created_at_ms=t.created_at_datetime.getTime(),t.sim_ms=t.sim_datetime.getTime(),t}function update_args_with_value(t,ee,te){ee==="view"?is_routing_view_types(te)&&(t.view=te):routing_arg_is_a_number(ee)?t[ee]=parse_int_or_0(te):ee==="subview_id"?t.subview_id=te:ee==="storage_location"&&(t.storage_location=parse_int_or_undefined(te))}const ROUTING_ARGS_WHICH_ARE_NUMBERS=new Set(["x","y","zoom"]);function routing_arg_is_a_number(t){return ROUTING_ARGS_WHICH_ARE_NUMBERS.has(t)}function parse_int_or_0(t){const ee=parseInt(t);return Number.isNaN(ee)?0:ee}function parse_int_or_undefined(t){const ee=parseInt(t);return Number.isNaN(ee)?void 0:ee}const test_routing_state_to_string=describe.delay("routing_state_to_string",()=>{let t,ee;t={route:"wcomponents",sub_route:null,item_id:"wc88",args:{view:"knowledge",subview_id:"kv77",zoom:100,x:101,y:158,storage_location:void 0,created_at_datetime:new Date("2020-10-21T17:04:24.000Z"),created_at_ms:1603299864e3,sim_datetime:new Date("2021-04-26T09:23:13.000Z"),sim_ms:1619428993e3}},ee=routing_state_to_string(t),test(ee,"#wcomponents/wc88/&storage_location=&subview_id=kv77&view=knowledge&x=101&y=158&zoom=100&sdate=2021-04-26&stime=10:23:13&cdate=2020-10-21&ctime=18:04:24")});function merge_routing_state(t,ee,te){const{route:ne,sub_route:oe,item_id:ie,args:_e}=t,se=ee.args||{};se.created_at_ms=get_datetime_or_ms(se.created_at_datetime,se.created_at_ms,te),se.created_at_datetime=se.created_at_ms?new Date(se.created_at_ms):void 0,se.sim_ms=get_datetime_or_ms(se.sim_datetime,se.sim_ms,te),se.sim_datetime=se.sim_ms?new Date(se.sim_ms):void 0,Object.keys(se).forEach(ae=>{if(ae==="storage_location")return;const ce=se[ae];(ce===void 0||ce==="")&&delete se[ae]});const re={..._e,...se};return{route:ee.route||ne,sub_route:ee.sub_route===null?null:ee.sub_route||oe,item_id:ee.item_id===null?null:ee.item_id||ie,args:re}}const test_merge_routing_state=describe.delay("merge_routing_state",()=>{const t=new Date("2021-04-09 23:25:26"),ee=new Date("2022-01-01 01:01:01"),te=new Date("2023-01-01 01:01:01"),ne={route:"wcomponents",sub_route:null,item_id:"wc53611570523449304",args:{created_at_datetime:t,created_at_ms:t.getTime(),sim_datetime:t,sim_ms:t.getTime(),view:"knowledge",subview_id:"kv7207606403961189",zoom:100,x:0,y:0,storage_location:1}};let oe,ie,_e;const se=re=>_e=re;oe={args:{x:0}},ie=merge_routing_state(ne,oe),test(ie,ne),oe={args:{zoom:void 0}},ie=merge_routing_state(ne,oe),test(ie,ne),oe={args:{created_at_datetime:ee,created_at_ms:te.getTime()}},_e="",ie=merge_routing_state(ne,oe,se),test(ie.args.created_at_datetime,te),test(ie.args.created_at_ms,te.getTime()),test(_e,"do not set both new_ms and new_datetime"),oe={args:{sim_datetime:ee,sim_ms:te.getTime()}},_e="",ie=merge_routing_state(ne,oe,se),test(ie.args.sim_datetime,te),test(ie.args.sim_ms,te.getTime()),test(_e,"do not set both new_ms and new_datetime"),oe={args:{sim_ms:void 0,created_at_ms:void 0}},ie=merge_routing_state(ne,oe),test(ie.args.sim_ms,t.getTime(),"should leave sim_ms unchanged when called with `{ args: { sim_ms: undefined }}`"),test(ie.args.created_at_ms,t.getTime(),"should leave created_at_ms unchanged when called with `{ args: { created_at_ms: undefined }}`"),oe={args:{storage_location:void 0}},ie=merge_routing_state(ne,oe),test(ie.args.storage_location,void 0)}),map_state$1V=(t,ee)=>{const te=t.routing,{selected_on:ne=new Set}=ee;let oe=ne.size>0;return ne.size&&(ne.has("route")&&ee.route!==void 0&&(oe=oe&&ee.route===te.route),ee.args&&(ne.has("args.view")&&ee.args.view!==void 0&&(oe=oe&&ee.args.view===te.args.view),ne.has("args.subview_id")&&ee.args.subview_id!==void 0&&(oe=oe&&ee.args.subview_id===te.args.subview_id))),{current_routing_state:te,selected:oe}},map_dispatch$16=(t,ee)=>({change_route:te=>t(ACTIONS.routing.change_route({route:ee.route,sub_route:ee.sub_route,item_id:ee.item_id,args:te}))}),connector$1X=connect(map_state$1V,map_dispatch$16);function _Link(t){const[ee,te]=h$1(!1),ne=_$d(void 0);ee&&!ne.current&&(ne.current=setTimeout(()=>{te(!1),ne.current=void 0},300));const oe=t.args||{},ie=ae=>{ae.stopImmediatePropagation(),ae.preventDefault(),!t.selected&&(te(!0),!(t.on_pointer_down&&t.on_pointer_down())&&t.change_route(oe))},_e=merge_routing_state(t.current_routing_state,t),se={...t.current_routing_state.args,...oe};_e.args=se;const re="link "+(ee?" clicked_animate ":"")+(t.selected?" selected ":"")+(t.extra_class_name||"");return o$1("a",{onPointerDown:ie,onClick:ae=>{ae.stopImmediatePropagation(),ae.preventDefault()},href:routing_state_to_string({..._e}),className:re,style:t.extra_css_style,children:t.children||"Link"})}const Link=connector$1X(_Link);function _LinkButton(t){const ee=t.args||{},te=ie=>{ie.stopImmediatePropagation(),ie.preventDefault(),!(t.on_pointer_down&&t.on_pointer_down())&&t.change_route(ee)},ne=merge_routing_state(t.current_routing_state,t),oe={...t.current_routing_state.args,...ee};return ne.args=oe,o$1(Button$2,{size:"small",color:"primary",variant:"contained",onClick:te,href:routing_state_to_string({...ne}),children:t.name||"Link"})}const LinkButton=connector$1X(_LinkButton),bound_zoom=t=>bounded(t,10,400),SCALE_BY=100,zoom_sensitivity=.01;function calculate_new_zoom(t){const{zoom:ee,wheel_change:te}=t,ne=ee-te*zoom_sensitivity*ee;return bound_zoom(Math.round(ne))}function calculate_new_zoom_xy(t){const{old:ee,new_zoom:te,pointer_x:ne,pointer_y:oe,client_width:ie,client_height:_e}=t,se=ne/ie,re=oe/_e,ae=SCALE_BY/te-SCALE_BY/ee.zoom,ce=se*ie*ae,de=re*_e*ae,ue=ee.x-ce,le=ee.y+de;return{x:ue,y:le}}const test_calculate_new_zoom_xy=describe.skip("calculate_new_zoom_xy (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{let t,ie,_e,se;const re={pointer_x:5,pointer_y:15},ae={pointer_x:5+900,pointer_y:15+600};function ce(de){const ue=de.pointer==="top_left"?re:ae;return calculate_new_zoom_xy({old:{x:de.x,y:de.y,zoom:de.zoom},new_zoom:de.new_zoom,...ue,client_width:900,client_height:600})}se="top_left",t=ce({x:0,y:0,zoom:10,new_zoom:200,pointer:se}),test(t,{x:0,y:0}),t=ce({x:100,y:100,zoom:200,new_zoom:200,pointer:se}),test(t,{x:100,y:100}),t=ce({x:100,y:100,zoom:200,new_zoom:10,pointer:se}),test(t,{x:100,y:100}),se="bottom_right",ie=100,_e=50,t=ce({x:0,y:0,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:-900,y:600}),t=ce({x:100,y:100,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:-900+100,y:600+100}),ie=200,_e=100,t=ce({x:0,y:0,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:-900/2,y:600/2}),t=ce({x:100,y:100,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:-900/2+100,y:600/2+100}),ie=100,_e=200,t=ce({x:0,y:0,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:900/2,y:-600/2}),t=ce({x:100,y:100,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:900/2+100,y:-600/2+100}),ie=50,_e=100,t=ce({x:0,y:0,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:900,y:-600}),t=ce({x:100,y:100,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:900+100,y:-600+100}),ie=50,_e=50,t=ce({x:0,y:0,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:0,y:0}),t=ce({x:100,y:100,zoom:ie,new_zoom:_e,pointer:se}),test(t,{x:100,y:100})}),SIDE_PANEL_WIDTH=440,STARTING_ZOOM=100;function get_routing_starting_state(){const t=new Date,ee=t.getTime(),ne={route:"wcomponents",sub_route:null,item_id:null,args:{view:"knowledge",subview_id:"",zoom:100,x:0,y:0,storage_location:void 0,created_at_datetime:t,created_at_ms:ee,sim_datetime:t,sim_ms:ee}};return merge_route_params_prioritising_url_over_state(window.location.toString(),ne)}const TOP_HEADER_FUDGE=48,bottom_controls_fudge=t=>t?300:120,side_panel_fudge=t=>t?SIDE_PANEL_WIDTH:0,get_screen_width=t=>document.body.clientWidth-side_panel_fudge(t),get_visible_screen_height=t=>document.body.clientHeight-TOP_HEADER_FUDGE-bottom_controls_fudge(t),half_screen_width=t=>get_screen_width(t)/2,half_screen_height=t=>get_visible_screen_height(t)/2;function calculate_xy_for_middle(t,ee,te){const ne=round_number(t.x+half_screen_width(ee)*(SCALE_BY/t.zoom),h_step),oe=round_number(t.y-half_screen_height(te)*(SCALE_BY/t.zoom)+TOP_HEADER_FUDGE,v_step);return{x:ne,y:oe}}function calculate_xy_for_put_middle(t,ee){const te=t.x-half_screen_width(ee.display_side_panel)*(SCALE_BY/t.zoom),ne=t.y+(half_screen_height(ee.display_time_sliders)+TOP_HEADER_FUDGE)*(SCALE_BY/t.zoom);return{x:te,y:ne}}function get_middle_of_screen(t){const ee=calculate_xy_for_middle(t.routing.args,t.controls.display_side_panel,t.controls.display_time_sliders);return position_to_point(ee)}const DEFAULT_DISPLAY_ARGS={display_side_panel:!1,display_time_sliders:!1};function lefttop_to_xy(t,ee,te){if(!t)return;const{left:ne,top:oe,zoom:ie=STARTING_ZOOM}=t,_e=oe!==void 0?-1*oe:void 0;return ee&&ne!==void 0&&_e!==void 0?{...calculate_xy_for_put_middle({x:ne,y:_e,zoom:ie},te||DEFAULT_DISPLAY_ARGS),zoom:ie}:{x:ne,y:_e,zoom:ie}}function needs_save(t){const{wcomponent_ids:ee,knowledge_view_ids:te}=t.sync.specialised_object_ids_pending_save;return ee.size+te.size>0}function get_next_specialised_state_id_to_save(t){const{wcomponent_ids:ee,knowledge_view_ids:te}=t.sync.specialised_object_ids_pending_save,oe=ee.values().next();if(!oe.done)return{id:oe.value,object_type:"wcomponent"};const _e=te.values().next();if(!_e.done)return{id:_e.value,object_type:"knowledge_view"}}function merge_base_object(t){const{last_source_of_truth_value:ee,current_value:te,source_of_truth_value:ne,get_custom_field_merger:oe}=t;let ie={...ne},_e=!1,se=[];return get_fields(te,ee,ne).forEach(ae=>{const de=(oe(ae)||get_default_base_object_field_merger(ae))(t);_e=_e||de.needs_save,de.unresolvable_conflict&&se.push(ae),ie[ae]=de.value}),{value:ie,needs_save:_e,unresolvable_conflicted_fields:se}}function get_fields(...t){const ee=new Set;return t.forEach(te=>{Object.keys(te).forEach(ne=>{ee.add(ne)})}),Array.from(ee)}function get_default_base_object_field_merger(t){const ee=new Set(["needs_save","saving"]),te=new Set(["id","created_at","modified_at"]);function ne(oe){const ie=oe.source_of_truth_value[t],_e=oe.current_value[t];let se=!1,re=!1;return ee.has(t)?{needs_save:se,unresolvable_conflict:re,value:_e}:te.has(t)?{needs_save:se,unresolvable_conflict:re,value:ie}:get_default_field_merger(t)(oe)}return ne}function get_default_field_merger(t){function ee(ne,oe){return JSON.stringify(ne)===JSON.stringify(oe)}function te(ne){const oe=ne.source_of_truth_value[t],ie=ne.current_value[t],_e=ne.last_source_of_truth_value[t];let se=!1,re=!1,ae;return ne.update_successful||ee(oe,_e)?(ae=ie,se=!ee(ie,oe)):(ae=oe,ee(ie,_e)||(re=!ee(ie,oe),re&&console.debug("unresolvable_conflict with field: ",t,"last_source_of_truth_field_value",_e,"source_of_truth_field_value",oe,"current_field_value",ie))),{needs_save:se,unresolvable_conflict:re,value:ae}}return te}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const REGEX=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(t){return typeof t=="string"&&REGEX.test(t)}var byteToHex=[];for(var i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify(t){var ee=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,te=(byteToHex[t[ee+0]]+byteToHex[t[ee+1]]+byteToHex[t[ee+2]]+byteToHex[t[ee+3]]+"-"+byteToHex[t[ee+4]]+byteToHex[t[ee+5]]+"-"+byteToHex[t[ee+6]]+byteToHex[t[ee+7]]+"-"+byteToHex[t[ee+8]]+byteToHex[t[ee+9]]+"-"+byteToHex[t[ee+10]]+byteToHex[t[ee+11]]+byteToHex[t[ee+12]]+byteToHex[t[ee+13]]+byteToHex[t[ee+14]]+byteToHex[t[ee+15]]).toLowerCase();if(!validate(te))throw TypeError("Stringified UUID is invalid");return te}function v4(t,ee,te){t=t||{};var ne=t.random||(t.rng||rng)();if(ne[6]=ne[6]&15|64,ne[8]=ne[8]&63|128,ee){te=te||0;for(var oe=0;oe<16;++oe)ee[te+oe]=ne[oe];return ee}return stringify(ne)}function get_new_id(){return v4()}const get_new_wcomponent_id=()=>get_new_id(),get_new_prediction_id=()=>"pr"+get_new_id(),get_new_value_and_prediction_set_id=()=>"vps"+get_new_id(),get_new_VAP_id=()=>"VAP"+get_new_id(),get_new_knowledge_view_id=()=>get_new_id(),uuidv4_regex=new RegExp(/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i),is_uuid_v4=t=>!!t&&uuidv4_regex.test(t);function floor_mseconds_to_resolution(t,ee){return floor_datetime_to_resolution(new Date(t),ee).getTime()}function floor_datetime_to_resolution(t,ee){const te=date2str_auto({date:t,time_resolution:ee});return new Date(te)}function get_new_created_ats(t){const ee=new Date;let te;if(t){const{use_creation_context:ne,creation_context:oe}=t;te=ne?oe&&oe.custom_created_at:void 0}return{created_at:ee,custom_created_at:te}}function selector_current_user(t){const{user:ee,users_by_id:te}=t.user_info;return ee&&te?te[ee.id]:void 0}function selector_user_name(t){const ee=selector_current_user(t);return ee==null?void 0:ee.name}function selector_need_to_set_user_name(t){const{user:ee,users_by_id:te}=t.user_info;return ee&&te&&!selector_user_name(t)}function selector_chosen_base(t,ee=""){const{bases_by_id:te,chosen_base_id:ne}=t.user_info,oe=te&&te[ne||""];function ie(_e){ee&&console.error(_e+ee)}return te||ie("No state.user_info.bases_by_id present"),ne===void 0&&ie("No state.user_info.chosen_base_id present"),oe===void 0&&ie("No chosen_base present"),oe}function selector_chosen_base_name(t){const ee=selector_chosen_base(t),te=selector_chosen_base_id(t);return ee?ee.title:te===void 0?"Not set":`Store: ${te}`}function selector_editable_bases(t){const{user:ee,bases_by_id:te}=t.user_info;if(ee&&te)return Object.values(te).filter(ne=>ne.can_edit)}function selector_have_an_editable_base(t){const ee=selector_editable_bases(t);return ee===void 0?void 0:ee.length>0}function selector_chosen_base_id(t){return t.user_info.chosen_base_id}function selector_needs_to_create_a_base(t){const{bases_by_id:ee}=t.user_info;return ee===void 0?!1:selector_have_an_editable_base(t)===!1&&selector_chosen_base(t)===void 0}function selector_current_user_access_level(t){const ee=selector_chosen_base(t);return ee==null?void 0:ee.access_level}function get_new_knowledge_view_object(t,ee){return{id:get_new_knowledge_view_id(),...get_new_created_ats(ee),title:"",description:"",wc_id_map:{},goal_ids:[],sort_type:"normal",...t}}function create_new_knowledge_view(t){const ee=t.store||get_store(),te=selector_chosen_base_id(ee.getState()),ne={...t.knowledge_view,base_id:te},oe=get_new_knowledge_view_object(ne,t.creation_context);ee.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:oe}))}function navigate_to_knowledge_view_or_kvwcomponent(t,ee){ee.dispatch(ACTIONS.routing.change_route({route:"wcomponents",args:{subview_id:t}}))}function merge_knowledge_view(t){return merge_base_object({...t,get_custom_field_merger:get_custom_field_merger$1})}function get_custom_field_merger$1(t){if(t!=="wc_id_map")return;function ee(te,ne){return JSON.stringify(te)===JSON.stringify(ne)}return te=>{const ne=te.source_of_truth_value.wc_id_map,oe=te.current_value.wc_id_map,ie=te.last_source_of_truth_value.wc_id_map;let _e=!1,se=!1,re;return te.update_successful||ee(ne,ie)?(re=oe,_e=!ee(oe,ne)):(re=ne,ee(oe,ie)||Array.from(new Set(Object.keys(oe).concat(Object.keys(ne)))).forEach(ce=>{const de=get_default_field_merger(ce)({source_of_truth_value:ne,current_value:oe,last_source_of_truth_value:ie,update_successful:te.update_successful});re[ce]=de.value,de.unresolvable_conflict&&console.debug("unresolvable_conflict in wc_id_map with wc_id: ",ce,"last_source_of_truth_value",ie[ce],"source_of_truth_value",ne[ce],"current_value",oe[ce]),_e=_e||de.needs_save,se=se||de.unresolvable_conflict})),{needs_save:_e,unresolvable_conflict:se,value:re}}}const test_merge_knowledge_views=describe.delay("merge knowledge view functions",()=>{const t=new Date("2021-01-01"),ee=new Date("2021-02-02");function te(oe,ie=!0){if(!oe&&ie)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return oe?oe.getTime():void 0}const ne=oe=>({left:oe,top:oe});describe("should handle adding entry on client",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(1)},needs_save:!0,saving:!0},_e={...oe,wc_id_map:{0:ne(1)},modified_at:ee},se=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:_e,update_successful:!0});test(te(se.value.modified_at),te(ee)),test(se.value.wc_id_map,{0:ne(1)}),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,[])}),describe("should handle adding entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(1)},needs_save:!0,saving:!0},_e={...oe,wc_id_map:{2:ne(3)},modified_at:ee},se=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:_e,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.wc_id_map,{0:ne(1),2:ne(3)}),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,[])}),describe("should handle nonconflicting changing different entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1),2:ne(3)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(4),2:ne(3)},needs_save:!0,saving:!0},_e={...oe,wc_id_map:{0:ne(1),2:ne(5)},modified_at:ee},se=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:_e,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.wc_id_map,{0:ne(4),2:ne(5)}),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,[])}),describe("should handle conflict changing same entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(3)},needs_save:!0,saving:!0},_e={...oe,wc_id_map:{0:ne(2)},modified_at:ee},se=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:_e,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.wc_id_map,{0:ne(2)}),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,["wc_id_map"])}),describe("should handle resolveable conflict changing same entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(2)},needs_save:!0,saving:!0},_e={...oe,wc_id_map:{0:ne(2)},modified_at:ee},se=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:_e,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.wc_id_map,{0:ne(2)}),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,[])}),describe("should handle non and conflict changes and second client change",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(4),1:ne(10)},needs_save:!0,saving:!0},_e={...oe,wc_id_map:{0:ne(2)},modified_at:ee},se=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:_e,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.wc_id_map,{0:ne(2),1:ne(10)}),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,["wc_id_map"])})});function prepare_new_contextless_wcomponent_object(t){const ee={id:get_new_wcomponent_id(),created_at:new Date,base_id:t.base_id,title:"",description:"",type:"process"},te=t.custom_created_at||t.created_at||ee.custom_created_at||ee.created_at;let ne;if(t.type==="causal_link"||t.type==="relation_link"){let oe={...ee,from_id:"",to_id:"",from_type:"state",to_type:"state",...t,type:t.type};wcomponent_is_causal_link(oe)&&(oe={effect_string:"1",effect_when_true:1,effect_when_false:void 0,values_and_prediction_sets:[],...oe}),ne=oe}else t.type==="judgement"||t.type==="objective"?ne={...ee,judgement_target_wcomponent_id:"",judgement_operator:"==",judgement_comparator_value:"True",judgement_manual:void 0,...t,type:t.type}:t.type==="statev2"?ne={...ee,subtype:void 0,values_and_prediction_sets:[],...t,type:t.type}:t.type==="prioritisation"?ne={...ee,title:date2str_auto({date:te,time_resolution:"day"}),goals:{},datetime:{value:te},...t,type:t.type}:t.type==="goal"?ne={...ee,objective_ids:[],...t,type:t.type}:t.type==="action"?ne={...ee,values_and_prediction_sets:[],reason_for_status:"",depends_on_action_ids:[],...t,type:t.type}:ne={...ee,...t,type:t.type||"process"};return ne}function prepare_new_wcomponent_object(t,ee){let te={...prepare_new_contextless_wcomponent_object(t),...get_new_created_ats(ee)};return te=set_creation_context_label_ids(te,ee),te}function set_creation_context_label_ids(t,ee){const te=ee.creation_context,ne=ee.use_creation_context&&te&&te.label_ids||[],oe=t.label_ids||[],ie=new Set(oe);return ne.forEach(_e=>ie.has(_e)?"":oe.push(_e)),{...t,label_ids:oe}}function merge_wcomponent(t){return merge_base_object({...t,get_custom_field_merger})}function get_custom_field_merger(t){}const test_merge_wcomponent=describe.delay("merge_wcomponent",()=>{const t=new Date("2021-01-01"),ee=new Date("2021-02-02");function te(ne,oe=!0){if(!ne&&oe)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return ne?ne.getTime():void 0}describe("should handle update on client",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TB",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!0});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TB"),test(_e.needs_save,!1),test(_e.unresolvable_conflicted_fields,[])}),describe("should handle nonconflicting updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TB"),test(_e.value.description,"DX"),test(_e.needs_save,!0),test(_e.unresolvable_conflicted_fields,[])}),describe("should handle conflicting updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TX",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TX"),test(_e.needs_save,!1),test(_e.unresolvable_conflicted_fields,["title"])}),describe("should handle multiple updates on client",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TB",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!0});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TC"),test(_e.needs_save,!0),test(_e.unresolvable_conflicted_fields,[])}),describe("should handle nonconflicting updates with multiple client updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TC"),test(_e.value.description,"DX"),test(_e.needs_save,!0),test(_e.unresolvable_conflicted_fields,[])}),describe("should handle conflicting updates with multiple client updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TX",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TX"),test(_e.needs_save,!1),test(_e.unresolvable_conflicted_fields,["title"])}),describe("should handle non and conflicting updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TB",description:"DB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TB"),test(_e.value.description,"DX"),test(_e.needs_save,!0),test(_e.unresolvable_conflicted_fields,["description"])}),describe("should handle non and conflicting updates with multiple client updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TC",description:"DC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(_e.value.modified_at),te(ee)),test(_e.value.title,"TC"),test(_e.value.description,"DX"),test(_e.needs_save,!0),test(_e.unresolvable_conflicted_fields,["description"])}),describe("should handle different custom created at",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,custom_created_at:new Date("2021"),modified_at:t}),oe={...ne,custom_created_at:new Date("2015"),needs_save:!0,saving:!0};({...ne});const ie={...ne,custom_created_at:new Date("2015"),modified_at:ee},_e=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!0});test(te(_e.value.modified_at),te(ee)),test(new Date("2021"),new Date("2021")),test(_e.value.custom_created_at,new Date("2015")),test(_e.needs_save,!1),test(_e.unresolvable_conflicted_fields,[])})});function get_last_source_of_truth_wcomponent_from_state(t,ee){return t.sync.last_source_of_truth_specialised_objects_by_id.wcomponents[ee||""]}function get_last_source_of_truth_knowledge_view_from_state(t,ee){return t.sync.last_source_of_truth_specialised_objects_by_id.knowledge_views[ee||""]}function clean_base_object_of_sync_meta_fields(t){return t={...t},delete t.needs_save,delete t.saving,t}function parse_base_dates(t){return{...t,created_at:new Date(t.created_at),custom_created_at:optional_date(t.custom_created_at),modified_at:optional_date(t.modified_at),datetime:optional_datetime_temporal_uncertainty(t.datetime)}}const optional_date=t=>t===void 0?void 0:new Date(t);function optional_datetime_temporal_uncertainty(t){if(t)return{...t,value:optional_date(t.value),min:optional_date(t.min),max:optional_date(t.max)}}function parse_knowledge_view(t,ee,te=!1){t=clean_base_object_of_sync_meta_fields(t);let ne=t.wc_id_map;return te&&(ne=remove_wc_id_map_passthrough_entries(ne)),t={...t,...parse_base_dates(t),wc_id_map:ne,sort_type:t.sort_type||"normal"},t=upgrade_2021_05_24_knowledge_view(t),t=upgrade_2021_11_19_knowledge_view(t),t}function remove_wc_id_map_passthrough_entries(t){const ee={...t};return Object.entries(ee).forEach(([te,ne])=>{ne.passthrough&&delete ee[te]}),ee}function upgrade_2021_05_24_knowledge_view(t){const ee=t.goal_ids||[];return{...t,goal_ids:ee}}function upgrade_2021_11_19_knowledge_view(t){const{wc_id_map:ee}=t,te={...ee};return Object.values(te).forEach(ne=>{ne.deleted&&(delete ne.deleted,ne.blocked=!0)}),{...t,wc_id_map:te}}async function supabase_create_item(t){const ee=t.converter_app_to_supabase(t.item),te=await t.supabase.from(t.table).insert(ee).eq("id",ee.id),oe=(te.data||[]).map(t.converter_supabase_to_app)[0];return{status:te.status,item:oe,error:te.error||void 0}}const SUPABASE_MAX_ROWS=1e3;async function supabase_get_items(t){const ee=t.offset||0,te=t.specific_ids?100:SUPABASE_MAX_ROWS,ne=ee+te-1;let oe=t.supabase.from(t.table).select("*").order("id",{ascending:!0});if(t.base_id!==void 0&&(oe=oe.eq("base_id",t.base_id)),t.specific_ids===void 0)oe=oe.range(ee,ne);else{const ae=t.specific_ids.slice(ee,ne+1);oe=oe.in("id",ae)}const ie=await oe;let _e=ie.error||void 0,se=(ie.data||[]).map(t.converter);const re=t.specific_ids&&ee+te<t.specific_ids.length;if(!_e&&(se.length===te||re)){const ae=await supabase_get_items({...t,offset:ee+te});ae.error?_e=ae.error:se=se.concat(ae.value)}return{error:_e,value:se}}function app_item_to_supabase(t,ee){if(ee=t.base_id??ee,ee===void 0)throw new Error("Must provide base_id for app_item_to_supabase");const te=clean_base_object_of_sync_meta_fields(t);return delete te.base_id,{id:t.id,modified_at:t.modified_at?t.modified_at.toISOString():void 0,base_id:ee,json:te,title:t.title}}function supabase_item_to_app(t){let{json:ee,id:te,base_id:ne,modified_at:oe}=t;const ie=oe?new Date(oe+"Z"):void 0;return delete ee.base_id,ee={...ee,id:te,base_id:ne,modified_at:ie},ee}const TABLE_NAME$1="knowledge_views";function supabase_get_knowledge_views(t){return supabase_get_items({...t,table:TABLE_NAME$1,converter:knowledge_view_supabase_to_app,specific_ids:t.ids})}async function supabase_get_knowledge_views_from_other_bases(t){const ee=t.wcomponents_from_other_bases.filter(_e=>wcomponent_is_not_deleted(_e)),te=Array.from(new Set(ee.map(_e=>_e.id))),ne=new Set(t.knowledge_views.map(_e=>_e.id)),oe=t.knowledge_views.map(_e=>_e.parent_knowledge_view_id).filter(is_defined).filter(_e=>!ne.has(_e));let ie=te.concat(oe);return t.knowledge_views.map(_e=>_e.foundation_knowledge_view_ids).forEach(_e=>{_e==null||_e.filter(se=>!ne.has(se)).forEach(se=>ie.push(se))}),ie=Array.from(new Set(ie)),await supabase_get_knowledge_views({supabase:t.supabase,ids:ie,all_bases:!0})}async function supabase_upsert_knowledge_view(t){return t.knowledge_view.modified_at?supabase_update_knowledge_view(t):supabase_create_knowledge_view(t)}async function supabase_create_knowledge_view(t){return supabase_create_item({supabase:t.supabase,table:TABLE_NAME$1,item:t.knowledge_view,converter_app_to_supabase:knowledge_view_app_to_supabase,converter_supabase_to_app:knowledge_view_supabase_to_app})}async function supabase_update_knowledge_view(t){const ee=knowledge_view_app_to_supabase(t.knowledge_view),te=await t.supabase.rpc("update_knowledge_view",{item:ee});if(te.status===401)return{status:te.status,error:{message:"JWT expired"},item:void 0};let ne,oe=te.error||void 0;try{let ie=te.data;te.status===409&&(ie=JSON.parse(te.error.details)),ne=knowledge_view_supabase_to_app(ie)}catch(ie){console.error("Exception whilst handling rpc update_knowledge_view response",ie),oe=ie}return{status:te.status,error:oe,item:ne}}function knowledge_view_app_to_supabase(t,ee){return app_item_to_supabase(t,ee)}function knowledge_view_supabase_to_app(t){let ee=supabase_item_to_app(t);return ee=parse_knowledge_view(ee),ee}function parse_wcomponent(t){if(t=clean_base_object_of_sync_meta_fields(t),t=upgrade_2021_05_19_process_actions(t),t=upgrade_2021_05_24_action(t),t=upgrade_2021_06_12_goal(t),t={...parse_base_dates(t)},wcomponent_has_validity_predictions(t)&&(t.validity=t.validity.map(parse_prediction)),wcomponent_has_VAP_sets(t)){const ee=t.values_and_prediction_sets;t.values_and_prediction_sets=ee&&ee.map(parse_values_and_predictions_set)}return wcomponent_has_event_at(t)&&(t.event_at=t.event_at.map(parse_base_dates)),wcomponent_is_plain_connection(t)&&(t.from_type=upgrade_2021_05_19_connection_fromto_types(t.from_type),t.to_type=upgrade_2021_05_19_connection_fromto_types(t.to_type),t.from_type=upgrade_2021_05_31_connection_fromto_types(t.from_type),t.to_type=upgrade_2021_05_31_connection_fromto_types(t.to_type)),t}function upgrade_2021_05_19_connection_fromto_types(t){return t==="meta-effector"||t==="meta-effected"?"meta":t==="effector"||t==="effected"?"state":t||"state"}function upgrade_2021_05_31_connection_fromto_types(t){return t==="value"?"state":t||"state"}function upgrade_2021_05_19_process_actions(t){return!wcomponent_is_process(t)||!t.is_action?t:{...t,is_action:void 0,type:"action"}}function upgrade_2021_05_24_action(t){if(wcomponent_is_action(t)){const ee=t.depends_on_action_ids||[];t={...t,depends_on_action_ids:ee}}return t}function upgrade_2021_06_12_goal(t){if(wcomponent_is_goal(t)){const ee=t.objective_ids||[];t={...t,objective_ids:ee}}return t}const parse_prediction=t=>parse_base_dates(t),parse_values_and_predictions_set=t=>parse_base_dates(t),TABLE_NAME="wcomponents";function supabase_get_wcomponents(t){return supabase_get_items({...t,table:TABLE_NAME,converter:wcomponent_supabase_to_app,specific_ids:t.ids})}async function supabase_get_wcomponents_from_any_base(t){const ee=await supabase_get_items({supabase:t.supabase,all_bases:!0,base_id:void 0,specific_ids:t.ids,table:TABLE_NAME,converter:wcomponent_supabase_to_app});return{error:ee.error,wcomponents:ee.value}}async function supabase_get_wcomponents_from_other_bases(t){const ee=new Set(t.wcomponents.map(ie=>ie.id)),te=new Set;function ne(ie,_e){ie.forEach(se=>{if(!is_valid_uuid(se)){console.trace(`Found invalid UUID "${se}".  Source of ids: "${_e}"`);return}ee.has(se)||te.add(se)})}t.knowledge_views.forEach(ie=>{ne(Object.keys(ie.wc_id_map),`wc_id_map of knowledge view "${ie.id}"`)}),t.wcomponents.forEach(ie=>{const _e=`wcomponent "${ie.id}"`;ne(ie.label_ids||[],_e);let se=get_double_at_mentioned_uuids_from_text(ie.title);ne(se,_e),se=get_double_at_mentioned_uuids_from_text(ie.description),ne(se,_e),wcomponent_is_action(ie)&&ne(ie.parent_goal_or_action_ids||[],_e)});const oe=Array.from(te);return await supabase_get_wcomponents_from_any_base({supabase:t.supabase,ids:oe})}async function supabase_upsert_wcomponent(t){return t.wcomponent.modified_at?supabase_update_wcomponent(t):supabase_create_wcomponent(t)}async function supabase_create_wcomponent(t){return supabase_create_item({supabase:t.supabase,table:TABLE_NAME,item:t.wcomponent,converter_app_to_supabase:wcomponent_app_to_supabase,converter_supabase_to_app:wcomponent_supabase_to_app})}async function supabase_update_wcomponent(t){const ee=wcomponent_app_to_supabase(t.wcomponent),te=await t.supabase.rpc("update_wcomponent",{item:ee});if(te.status===401)return{status:te.status,error:{message:"JWT expired"},item:void 0};let ne,oe=te.error||void 0;try{let ie=te.data;te.status===409&&(ie=JSON.parse(te.error.details)),ne=wcomponent_supabase_to_app(ie)}catch(ie){console.error("Exception whilst handling rpc update_wcomponent response",ie),oe=ie}return{status:te.status,error:oe,item:ne}}function wcomponent_app_to_supabase(t,ee){return{...app_item_to_supabase(t,ee),type:t.type,attribute_id:wcomponent_is_state_value(t)?t.attribute_wcomponent_id:void 0}}function wcomponent_supabase_to_app(t){let ee=supabase_item_to_app(t);return ee=parse_wcomponent(ee),ee}function error_to_string(t){if(t){if("type"in t&&typeof t.type=="string")return t.type+": "+(t.message||"<no message>");if(`${t}`.includes("[object"))return JSON.stringify(t)}return`${t}`}let global_attempts=0;async function save_state(t,ee=!1){const te=t.getState();if(!te.sync.ready_for_writing)return console.error(`Inconsistent state violation.  Save state called whilst state.sync.status: "${te.sync.specialised_objects.status}", ready_for_writing: ${te.sync.ready_for_writing}`),Promise.reject();const ne=get_next_specialised_state_id_to_save(te);if(!ne){const{wcomponent_ids:ie,knowledge_view_ids:_e}=te.sync.specialised_object_ids_pending_save,se=JSON.stringify(Array.from(ie)),re=JSON.stringify(Array.from(_e));return t.dispatch(ACTIONS.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})),ee?(console.log(`No ids need to be saved: "${se}", "${re}"`),Promise.resolve()):(console.error(`Inconsistent state violation.  No ids need to be saved: "${se}", "${re}"`),Promise.reject())}t.dispatch(ACTIONS.sync.update_sync_status({status:"SAVING",data_type:"specialised_objects"}));let oe;ne.object_type==="knowledge_view"?oe=save_knowledge_view(ne.id,t):oe=save_wcomponent(ne.id,t);try{global_attempts+=1,await oe&&(global_attempts=0),global_attempts<10?t.dispatch(ACTIONS.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})):t.dispatch(ACTIONS.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:"Try manually saving or refresh the page.  Failing that contact the team.",attempt:global_attempts}))}catch(ie){console.error(`Got error saving ${ne.object_type} ${ne.id}.  Error: ${ie}`),t.dispatch(ACTIONS.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:`${ie}`,attempt:global_attempts}))}return Promise.resolve()}async function save_knowledge_view(t,ee){const te="knowledge_view",ne=get_knowledge_view_from_state(ee.getState(),t),oe=pre_upsert_check(t,ee,te,ne);if(oe.error)return oe.error;const ie=oe.initial_item,_e=get_supabase(),se=await supabase_upsert_knowledge_view({supabase:_e,knowledge_view:ie}),re=post_upsert_check(t,ee,te,se);if(re.error)return re.error;const{create_successful:ae,update_successful:ce,latest_source_of_truth_value:de}=re,ue=get_last_source_of_truth_knowledge_view_from_state(ee.getState(),t),le=get_knowledge_view_from_state(ee.getState(),t);ee.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:de,is_source_of_truth:!0}));const pe=check_merge_args({object_type:te,initial_item:ie,last_source_of_truth_value:ue,current_value:le});if(pe.error)return pe.error;if(pe.merge_args){const me=merge_knowledge_view({...pe.merge_args,source_of_truth_value:de,update_successful:ce});me.needs_save&&ee.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:{...me.value},is_source_of_truth:!1})),me.unresolvable_conflicted_fields.length}return Promise.resolve(ae||ce)}async function save_wcomponent(t,ee){const te="wcomponent",ne=get_wcomponent_from_state(ee.getState(),t),oe=pre_upsert_check(t,ee,te,ne);if(oe.error)return oe.error;const ie=oe.initial_item,_e=get_supabase(),se=await supabase_upsert_wcomponent({supabase:_e,wcomponent:ie}),re=post_upsert_check(t,ee,te,se);if(re.error)return re.error;const{create_successful:ae,update_successful:ce,latest_source_of_truth_value:de}=re,ue=get_last_source_of_truth_wcomponent_from_state(ee.getState(),t),le=get_wcomponent_from_state(ee.getState(),t);ee.dispatch(ACTIONS.specialised_object.upsert_wcomponent({wcomponent:de,is_source_of_truth:!0}));const pe=check_merge_args({object_type:te,initial_item:ie,last_source_of_truth_value:ue,current_value:le});if(pe.error)return pe.error;if(pe.merge_args){const me=merge_wcomponent({...pe.merge_args,source_of_truth_value:de,update_successful:ce});me.needs_save&&ee.dispatch(ACTIONS.specialised_object.upsert_wcomponent({wcomponent:{...me.value},is_source_of_truth:!1})),me.unresolvable_conflicted_fields.length}return Promise.resolve(ae||ce)}function pre_upsert_check(t,ee,te,ne){return ne?(ee.dispatch(ACTIONS.sync.update_specialised_object_sync_info({id:ne.id,object_type:te,saving:!0})),{error:void 0,initial_item:ne}):(ee.dispatch(ACTIONS.sync.debug_refresh_all_specialised_object_ids_pending_save()),{error:Promise.reject(`Inconsistent state violation.  save_"${te}" but no item for id: "${t}".  Updating all specialised_object_ids_pending_save.`),initial_item:void 0})}function post_upsert_check(t,ee,te,ne){const oe=ne.status===201,ie=ne.status===200;if(!oe&&!ie&&ne.status!==409){const se=error_to_string(ne.error);return{error:Promise.reject(`save_"${te}" got "${ne.status}" error: "${se}"`),create_successful:oe,update_successful:ie,latest_source_of_truth_value:void 0}}const _e=ne.item;return _e?{error:void 0,create_successful:oe,update_successful:ie,latest_source_of_truth_value:_e}:{error:Promise.reject(`Inconsistent state violation.  save_"${te}" got "${ne.status}" but no latest_source_of_truth_value item.  Error: "${JSON.stringify(ne.error)}".`),create_successful:oe,update_successful:ie,latest_source_of_truth_value:_e}}function check_merge_args(t){const{object_type:ee,initial_item:te,last_source_of_truth_value:ne,current_value:oe}=t;return ne?oe?{error:void 0,merge_args:{last_source_of_truth_value:ne,current_value:oe}}:{error:Promise.reject(`Inconsistent state violation.  save_"${ee}" found "${ee}" last_source_of_truth_value but no current_value for id "${te.id}".`),merge_args:void 0}:te.modified_at?{error:Promise.reject(`Inconsistent state violation.  save_"${ee}" found no last_source_of_truth_value "${ee}" for id: "${te.id}" but "${ee}" had a modified_at already set`),merge_args:void 0}:{error:void 0,merge_args:void 0}}async function conditionally_save_state(t){if(!calc_should_save(t,!0))return Promise.resolve();await save_state(t)}function calc_should_save(t,ee){if(!t.load_state_from_storage)return!1;const te=t.getState(),{ready_for_writing:ne,specialised_objects:oe}=te.sync;return!(!ne||ee&&oe.status==="FAILED"||ee&&!needs_save(te))}async function save_and_optionally_signout(t){const ee=get_store(),te=get_supabase();try{await conditionally_save_state(ee)}catch{}try{if(t){const{error:ne}=await te.auth.signOut();localStorage.clear()}}catch{}window.location.reload()}const window_on_focus_listeners=[];function setup_window_on_focus_listener(){window.addEventListener("focus",function(){window_on_focus_listeners.forEach(t=>t())},!1)}function register_window_on_focus_listener(t){window_on_focus_listeners.push(t)}let registered=!1;function register_window_focus_session_check(t){if(registered){console.error("Already run register_window_focus_session_check");return}registered=!0,register_window_on_focus_listener(()=>check_and_handle_connection_and_session(t))}async function check_and_handle_connection_and_session(t){if(!t.load_state_from_storage)return;const ee=get_supabase(),te=await check_connection_and_session(t,ee);handle_connection_and_session_check_result(te,t)}async function check_connection_and_session(t,ee){var te,ne,oe;if(!t.getState().user_info.user)return console.log("User not signed in once yet."),0;try{const ie=await ee.auth.update({});if(((te=ie.error)==null?void 0:te.message)==="Not logged in."||((ne=ie.error)==null?void 0:ne.status)===401)return 1;if(((oe=ie.error)==null?void 0:oe.message)==="Network request failed")return console.log("Network error"),2;if(ie.error){debugger;return console.log("Unexpected error whilst check_connection_and_session",ie.error),3}else return 4}catch(ie){return console.error("Unexpected exception whilst check_connection_and_session",ie),3}}function handle_connection_and_session_check_result(t,ee){if(t===0)return;if(t===1){console.log("User not logged in.  Reloading page."),window.location.reload();return}else if(t===3){save_and_optionally_signout(!1);return}let te=!0;t===2&&(te=!1),ee.dispatch(ACTIONS.sync.update_network_status({network_functional:te,last_checked:new Date}))}function register_window_title_updater_subscriber(t){let ee="";t.subscribe(()=>{const te=t.getState(),ne=get_current_knowledge_view_from_state(te);if(ne&&ne.title!==ee){ee=ne.title;const oe=(ee?ee+" | ":"")+APP_DETAILS.NAME;set_window_title(oe)}})}function controls_subscribers(t){show_side_panel_on_change_route(t)}function show_side_panel_on_change_route(t){t.subscribe(()=>{const ee=t.getState();ee.routing.route,should_display_side_panel(ee)&&t.dispatch(ACTIONS.controls.set_or_toggle_display_side_panel(!0))})}function should_display_side_panel(t){return t.last_action?!t.controls.display_side_panel&&is_change_route(t.last_action)&&t.last_action.route!==void 0&&(t.last_action.route==="search"||t.last_action.route==="filter"):!1}function throttle(t,ee){let te;const ne=()=>{te&&(clearTimeout(te),te=void 0)};let oe;return{throttled:(...se)=>{ne(),oe=se,te=setTimeout(()=>{t(...se),oe=void 0},ee)},cancel:ne,flush:()=>{ne(),oe&&(t(...oe),oe=void 0)}}}function min_throttle(t,ee){let te;const ne=()=>{te&&(clearTimeout(te),te=void 0)};let oe={args:void 0},ie;const _e=(...ae)=>(oe.args=ae,te||(te=setTimeout(()=>{t(...oe.args),oe.args=void 0,te=void 0},ee),ie=performance.now()+ee),ie);let se;return{throttled:_e,cancel:ne,flush:()=>(se||(se=new Promise(ae=>{setTimeout(()=>{if(ne(),se=void 0,oe.args){const ce=oe.args;oe.args=void 0,ae(t(...ce))}ae(void 0)},0)})),se)}}function pub_sub_factory(t={}){const ee={};function te(ie,_e){const se=t[ie];if(se){const ce=se(_e);if(!ce.continue)return;_e=ce.message}const re=ee[ie];(re===void 0?[]:re).forEach(ce=>{setTimeout(()=>ce(_e),0)})}function ne(ie,_e){const se=ee[ie],re=se===void 0?[]:se;return re.push(_e),ee[ie]=re,oe(ie,_e)}function oe(ie,_e){return()=>{const se=ee[ie],ae=(se===void 0?[]:se).filter(ce=>ce!==_e);ee[ie]=ae}}return{pub:te,sub:ne}}const canvas_pub_sub=pub_sub_factory({canvas_node_drag_relative_position:canvas_node_drag_relative_position_middleware});let last_node_drag_position;function canvas_node_drag_relative_position_middleware(t){const ee=(last_node_drag_position==null?void 0:last_node_drag_position.left)!==t.left||(last_node_drag_position==null?void 0:last_node_drag_position.top)!==t.top;return last_node_drag_position=t,{continue:ee,message:t}}function handle_canvas_node_drag_relative_position(t){canvas_pub_sub.pub("throttled_canvas_node_drag_relative_position",t)}const throttled_handle_canvas_node_drag_relative_position=min_throttle(handle_canvas_node_drag_relative_position,30);canvas_pub_sub.sub("canvas_node_drag_relative_position",throttled_handle_canvas_node_drag_relative_position.throttled);const global_keys_pub_sub=pub_sub_factory(),user_pub_sub=pub_sub_factory(),pub_sub={canvas:canvas_pub_sub,global_keys:global_keys_pub_sub,user:user_pub_sub};function conditional_ctrl_f_search(t,ee){ee.ctrl_key&&ee.key==="f"&&(ee.event.preventDefault(),t.dispatch(ACTIONS.routing.change_route({route:"search"})))}const conditionally_select_all_components=factory_conditionally_select_components(t=>Object.keys(t.composed_visible_wc_id_map)),conditionally_expand_selected_components=factory_conditionally_select_components((t,ee)=>{const te=[...ee],ne=new Set(te),{wc_id_connections_map:oe,composed_visible_wc_id_map:ie}=t;return ee.forEach(_e=>{const se=oe[_e];se&&se.forEach(re=>{ne.has(re)||ie[_e]&&(te.push(re),ne.add(re))})}),te}),conditionally_decrease_selected_components=factory_conditionally_select_components((t,ee,te)=>{const ne=new Set(ee),oe=new Set,{wc_id_connections_map:ie,composed_visible_wc_id_map:_e,wc_ids_by_type:se}=t;return ee.forEach(re=>{const ae=ie[re];if(!ae)oe.add(re);else{const ce=Array.from(ae).filter(de=>_e[de]).filter(de=>ne.has(de));if(ce.length<=1)oe.add(re);else if(se.any_node.has(re)){let de;Array.from(ce).map(le=>te[le]).filter(wcomponent_is_plain_connection).find(le=>{const pe=le.from_id===re;if(de===void 0)de=pe;else if(de!==pe)return!0;return!1})||oe.add(re)}}}),ee.filter(re=>!oe.has(re))}),conditionally_select_forward_causal_components=factory_conditionally_select_causal_components("forward"),conditionally_select_source_causal_components=factory_conditionally_select_causal_components("source");function factory_conditionally_select_causal_components(t){const ee=t==="forward";return factory_conditionally_select_components((te,ne,oe)=>{const ie=[...ne],_e=new Set(ie);function se(ce){_e.has(ce)||(_e.add(ce),ie.push(ce))}const{wc_id_connections_map:re,composed_visible_wc_id_map:ae}=te;return ne.forEach(ce=>{const de=re[ce];if(!de)return;Array.from(de).concat([ce]).filter(le=>ae[le]).map(le=>oe[le]).filter(wcomponent_is_causal_link).filter(le=>(ee?le.from_id:le.to_id)===ce||le.id===ce).forEach(({id:le,from_id:pe,to_id:me})=>{se(le),se(ee?me:pe)})}),ie})}const conditionally_select_interconnections=factory_conditionally_select_components((t,ee)=>{const te=new Set(ee),ne=[...ee],oe=new Set(ne),{wc_id_connections_map:ie,composed_visible_wc_id_map:_e}=t;function se(re){return!_e[re]}return ee.forEach(re=>{if(se(re))return;const ae=ie[re];ae&&ae.forEach(ce=>{if(se(ce))return;const de=ie[ce];de&&de.forEach(ue=>{ue!==re&&te.has(ue)&&(se(ue)||oe.has(ce)||(ne.push(ce),oe.add(ce)))})})}),ne});function factory_conditionally_select_components(t){return ee=>{const te=ee.getState(),ne=get_current_composed_knowledge_view_from_state(te);if(!ne||!(te.routing.args.view==="knowledge"))return;const ie=te.meta_wcomponents.selected_wcomponent_ids_list,{wcomponents_by_id:_e}=te.specialised_objects,se=t(ne,ie,_e);ee.dispatch(ACTIONS.meta_wcomponents.set_selected_wcomponents({ids:se})),ee.dispatch(ACTIONS.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))}}function meta_wcomponents_selecting_subscribers(t){handle_canvas_area_select(t)}function handle_ctrl_a(t,ee){ee.key==="a"&&ee.ctrl_key&&(ee.event.preventDefault(),conditionally_select_all_components(t))}function handle_canvas_area_select(t){pub_sub.canvas.sub("canvas_area_select",ee=>{const te=t.getState(),ne=get_current_composed_knowledge_view_from_state(te);if(!ne||!(te.routing.args.view==="knowledge"))return;const{start_x:ie,start_y:_e,end_x:se,end_y:re}=ee,ae=-_e,ce=-re,de=Object.entries(ne.composed_visible_wc_id_map).filter(([pe,me])=>me.left>=ie&&me.left<=se&&me.top<=ae&&me.top>=ce).map(([pe])=>pe).filter(pe=>!ne.wc_ids_by_type.any_link.has(pe)),ue=te.global_keys.keys_down.has("Control"),le=calculate_new_selected_ids(ue,te,de);t.dispatch(ACTIONS.meta_wcomponents.set_selected_wcomponents({ids:le})),t.dispatch(ACTIONS.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))})}function calculate_new_selected_ids(t,ee,te){let ne=[];if(t){const oe=new Set(ee.meta_wcomponents.selected_wcomponent_ids_set);te.forEach(ie=>oe.delete(ie)),ne=Array.from(oe)}else{const oe=ee.meta_wcomponents.selected_wcomponent_ids_list,ie=new Set(oe),_e=te.filter(se=>!ie.has(se));ne=oe.concat(_e)}return ne}function display_options_subscribers(t){toggle_consumption_formatting_on_key_press(t)}function toggle_consumption_formatting_on_key_press(t){let ee="";pub_sub.global_keys.sub("key_down",te=>{if(ee){handle_key_combo(ee,te,t);return}const ne=te.ctrl_key&&root_key_combo.has(te.key);if(ee=ne?ee=te.key:"",ne){te.event.preventDefault();return}te.ctrl_key&&te.key==="e"?(te.event.preventDefault(),t.dispatch(ACTIONS.display.toggle_consumption_formatting({}))):te.shift_key&&te.key==="?"?(te.event.preventDefault(),t.getState().display_options.show_help_menu||t.dispatch(ACTIONS.display.set_show_help_menu({show:!0}))):(handle_ctrl_a(t,te),conditional_ctrl_f_search(t,te))}),pub_sub.global_keys.sub("key_up",te=>{te.key==="Control"&&(ee="")})}function handle_key_combo(t,ee,te){let ne=!1;t==="d"?ne=handle_display_key_combo(ee.key,te):t==="s"&&(ne=handle_selection_key_combo(ee.key,te)),ne&&ee.event.preventDefault()}const root_key_combo=new Set(["d","s"]);function handle_display_key_combo(t,ee){let te=!0;return t==="f"?ee.dispatch(ACTIONS.display.set_or_toggle_focused_mode()):t==="t"?ee.dispatch(ACTIONS.controls.toggle_display_time_sliders()):t==="s"?ee.dispatch(ACTIONS.controls.set_or_toggle_display_side_panel()):t==="a"?ee.dispatch(ACTIONS.display.set_or_toggle_animate_connections()):t==="c"?ee.dispatch(ACTIONS.display.set_or_toggle_circular_links()):te=!1,te}function handle_selection_key_combo(t,ee){let te=!0;return t==="a"?conditionally_select_all_components(ee):t==="e"?conditionally_expand_selected_components(ee):t==="d"?conditionally_decrease_selected_components(ee):t==="f"?conditionally_select_forward_causal_components(ee):t==="c"?conditionally_select_source_causal_components(ee):t==="i"?conditionally_select_interconnections(ee):te=!1,te}function record_keyupdown_activity(t){document.onkeydown=ee=>{const te={event:ee,time_stamp:ee.timeStamp,alt_key:ee.altKey,code:ee.code,ctrl_key:ee.ctrlKey,key:ee.key,meta_key:ee.metaKey,shift_key:ee.shiftKey};t.dispatch(ACTIONS.global_keys.key_down(te)),pub_sub.global_keys.pub("key_down",te)},document.onkeyup=ee=>{const te={event:ee,time_stamp:ee.timeStamp,alt_key:ee.altKey,code:ee.code,ctrl_key:ee.ctrlKey,key:ee.key,meta_key:ee.metaKey,shift_key:ee.shiftKey};t.dispatch(ACTIONS.global_keys.key_up(te)),pub_sub.global_keys.pub("key_up",te)},window.onfocus=()=>{t.getState().global_keys.keys_down.size!==0&&t.dispatch(ACTIONS.global_keys.clear_all_keys())}}function pick(t,ee){const te={};return t.forEach(ne=>{te[ne]=ee[ne]}),te}function controls_persist(t){const ee=pick(["display_time_sliders","display_side_panel"],t.controls);persist_state_object("controls",ee)}function controls_starting_state(t){const ee=get_persisted_state_object("controls");return{linked_datetime_sliders:!1,display_time_sliders:!1,display_side_panel:!0,display_select_storage:t.storage_location===void 0,...ee}}function creation_context_persist(t){const ee=pick(["use_creation_context","creation_context"],t.creation_context);persist_state_object("creation_context",ee)}function creation_context_starting_state(){const t=get_persisted_state_object("creation_context"),{use_creation_context:ee=!1,creation_context:te={custom_created_at:void 0,label_ids:[]}}=t;let{custom_created_at:ne}=te;return ne=ne&&new Date(ne),te.custom_created_at=ne,{use_creation_context:ee,creation_context:te}}function derive_validity_filter(t){return{only_certain_valid:t==="only_certain_valid",only_maybe_valid:t==="only_maybe_valid",maybe_invalid:t==="maybe_invalid",show_invalid:t==="show_invalid"}}function derive_certainty_formatting(t){return{render_certainty_as_opacity:t==="render_certainty_as_opacity",render_certainty_as_easier_opacity:t==="render_certainty_as_easier_opacity",render_100_opacity:t==="render_100_opacity"}}function display_options_persist(t){const ee=pick(["consumption_formatting","time_resolution","display_by_simulated_time","display_time_marks","animate_connections","circular_links","show_large_grid","validity_filter","certainty_formatting","enable_angular_connections"],t.display_options);persist_state_object("display_options",ee)}function display_options_starting_state(){const t=get_persisted_state_object("display_options"),ee=t.validity_filter||"show_invalid",te=t.certainty_formatting||"render_certainty_as_opacity",ne=derive_validity_filter(ee),oe=derive_certainty_formatting(te);return{consumption_formatting:!0,focused_mode:!1,time_resolution:"minute",display_by_simulated_time:!1,display_time_marks:!1,animate_connections:!1,circular_links:!0,show_help_menu:!1,show_large_grid:!1,validity_filter:ee,certainty_formatting:te,derived_validity_filter:ne,derived_certainty_formatting:oe,enable_angular_connections:!1,...t}}function filter_context_persist(t){const ee=pick(["apply_filter","filters"],t.filter_context);persist_state_object("filter_context",ee)}function filter_context_starting_state(){const t=get_persisted_state_object("filter_context");t.filters instanceof Array&&delete t.filters;const{apply_filter:ee=!1,filters:te={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""}}=t;return{apply_filter:ee,filters:te}}function search_persist(t){const ee=pick(["search_fields","search_type"],t.search);persist_state_object("search",ee)}function search_starting_state(){return{search_fields:"all",search_type:"best",...get_persisted_state_object("search")}}function sync_persist(t){const ee=pick([],t.sync);persist_state_object("sync",ee)}function sync_starting_state(){const t=get_persisted_state_object("sync"),ee={status:void 0,error_message:"",retry_attempt:void 0,loading_base_id:void 0};return{last_source_of_truth_specialised_objects_by_id:{wcomponents:{},knowledge_views:{}},specialised_object_ids_pending_save:{wcomponent_ids:new Set,knowledge_view_ids:new Set},specialised_objects_save_conflicts:{wcomponent_conflicts_by_id:{},knowledge_view_conflicts_by_id:{}},ready_for_reading:!1,ready_for_writing:!1,network_functional:!0,network_function_last_checked:void 0,wcomponent_ids_to_search_for_in_any_base:new Set,wcomponent_ids_searching_for_in_any_base:new Set,wcomponent_ids_searched_for_in_any_base:new Set,bases:{...ee},specialised_objects:{...ee},...t}}const local_raw_data={wcomponents_by_id:{},knowledge_views_by_id:{}},local_user={},{wcomponents_by_id,knowledge_views_by_id}=local_raw_data,wcomponents=Object.values(wcomponents_by_id).map(t=>parse_wcomponent(t)),knowledge_views=Object.values(knowledge_views_by_id).map(t=>parse_knowledge_view(t)),local_data={wcomponents,knowledge_views};function user_info_persist(t){const ee=pick(["has_signed_in_at_least_once","chosen_base_id"],t.user_info);persist_state_object("user_info",ee)}function user_info_starting_state(t){const ee=get_persisted_state_object("user_info"),ne=(se=>document.location.hash.includes(se))("type=recovery"),oe=t.storage_location!==void 0?t.storage_location:ee.chosen_base_id;return{has_signed_in_at_least_once:!1,user:t.load_state_from_storage?get_supabase().auth.user()||void 0:local_user,need_to_handle_password_recovery:ne,users_by_id:void 0,bases_by_id:void 0,...ee,chosen_base_id:oe}}function persist_relevant_state(t){creation_context_persist(t),controls_persist(t),display_options_persist(t),filter_context_persist(t),search_persist(t),sync_persist(t),user_info_persist(t)}const controls_reducer=(t,ee)=>{if(is_toggle_linked_datetime_sliders(ee)){const te=!t.controls.linked_datetime_sliders;t=update_substate(t,"controls","linked_datetime_sliders",te)}if(is_set_display_time_sliders(ee)){const{display_time_sliders:te}=ee;t=update_substate(t,"controls","display_time_sliders",te)}if(is_toggle_display_time_sliders(ee)){const{display_time_sliders:te}=t.controls;t=update_substate(t,"controls","display_time_sliders",!te)}if(is_set_or_toggle_display_side_panel(ee)){const{display_side_panel:te}=t.controls,ne=ee.display_side_panel??!te;t=update_substate(t,"controls","display_side_panel",ne)}if(is_set_or_toggle_display_select_storage(ee)){const{display_select_storage:te}=t.controls,ne=ee.display_select_storage??!te;t=update_substate(t,"controls","display_select_storage",ne)}return t},creation_context_reducer=(t,ee)=>{if(is_toggle_use_creation_context(ee)){const ne=!t.creation_context.use_creation_context;t=update_substate(t,"creation_context","use_creation_context",ne)}let te=!1;if(is_set_custom_created_at(ee)){const ne={label_ids:[],...t.creation_context.creation_context,custom_created_at:ee.custom_created_at};t=update_substate(t,"creation_context","creation_context",ne),te=te||!!ee.custom_created_at}if(is_set_label_ids(ee)){const ne={...t.creation_context.creation_context,label_ids:ee.label_ids};t=update_substate(t,"creation_context","creation_context",ne),te=te||ee.label_ids.length>0}if(is_set_replace_text(ee)){const ne={label_ids:[],...t.creation_context.creation_context};ee.value_type==="target"?ne.replace_text_target=ee.value:ne.replace_text_replacement=ee.value,t=update_substate(t,"creation_context","creation_context",ne)}return te&&(t=update_substate(t,"creation_context","use_creation_context",!0)),t},DEFAULT_DATETIME_LINE_CONFIG={time_origin_x:0,time_scale:1,time_line_number:4,time_line_spacing_days:30};function default_time_origin_parameters(t){const ee=t.time_origin_ms??new Date().getTime(),te=t.time_origin_x??0,ne=t.time_scale??1;return{time_origin_ms:ee,time_origin_x:te,time_scale:ne}}function calculate_canvas_x_for_wcomponent_temporal_uncertainty(t){const ee=get_current_datetime_from_wcomponent(t.wcomponent_id,t.wcomponents_by_id,t.created_at_ms);if(!ee)return;const te=calculate_canvas_x_for_datetime({datetime:ee,...t});return round_coordinate_small_step(te)}function calculate_canvas_x_for_datetime(t){const ee=t.datetime.getTime()-t.time_origin_ms,te=t.time_scale/time_scale_days_to_ms_pixels_fudge_factor;return ee*te+t.time_origin_x}function wc_map_entry_to_coord_key(t){return`${t.left},${t.top}`}function get_wc_position_to_id_map(t,ee){const te={};return Object.entries(t).forEach(([ne,oe])=>{if(wcomponent_is_plain_connection(ee[ne]))return;const ie=round_canvas_point(oe,"large"),_e=wc_map_entry_to_coord_key(ie),se=te[_e]||[];se.push(ne),te[_e]=se}),te}function ensure_item_in_set(t,ee){return t.has(ee)||(t=new Set(t),t.add(ee)),t}function ensure_item_not_in_set(t,ee){return t.has(ee)&&(t=new Set(t),t.delete(ee)),t}function set_union(...t){let ee=[];return t.forEach(te=>ee=ee.concat(Array.from(te))),new Set(ee)}function set_difference(t,ee){const te=new Set(t);return ee.forEach(ne=>te.delete(ne)),te.size===t.size?t:te}function get_empty_wcomponent_ids_by_type(){return{event:new Set,statev2:new Set,state_value:new Set,sub_state:new Set,multidimensional_state:new Set,process:new Set,action:new Set,actor:new Set,causal_link:new Set,relation_link:new Set,judgement:new Set,objective:new Set,counterfactualv2:new Set,goal:new Set,prioritisation:new Set,judgement_or_objective:new Set,goal_or_action:new Set,has_objectives:new Set,any_link:new Set,any_node:new Set,any_state_VAPs:new Set,has_single_datetime:new Set}}function get_wcomponent_ids_by_type(t,ee){const te=get_empty_wcomponent_ids_by_type(),ne=new Set;return ee.forEach(oe=>{const ie=t[oe];if(!ie){console.warn(`Could not find wcomponent by id: ${oe}.  Wrong ID or in another base?`);return}wcomponent_is_deleted(ie)||(te[ie.type].add(oe),wcomponent_has_legitimate_non_empty_state_VAP_sets(ie)&&wcomponent_has_single_statev2_datetime(ie)&&ne.add(ie.id))}),te.judgement_or_objective=set_union(te.judgement,te.objective),te.goal_or_action=set_union(te.goal,te.action),te.has_objectives=set_union(te.action,te.goal),te.any_link=set_union(te.causal_link,te.relation_link),te.any_node=set_difference(new Set(ee),te.any_link),te.any_state_VAPs=set_union(te.statev2,te.causal_link,te.action),te.has_single_datetime=set_union(te.event,te.sub_state,ne),te}function calc_if_wcomponent_should_exclude_because_label_or_type(t,ee){const{id:te,label_ids:ne=[],type:oe}=t,{exclude_by_label_ids:ie,include_by_label_ids:_e,exclude_by_component_types:se,include_by_component_types:re}=ee,ae=ie.has(te)||!!ne.find(me=>ie.has(me)),ce=_e.size>0&&!_e.has(te)&&!ne.find(me=>_e.has(me)),de=se.has(oe),ue=re.size>0&&!re.has(oe);return{should_exclude:ae||de,lacks_include:ce||ue}}function get_knowledge_view_given_routing(t){let ee=t.routing.args.subview_id;return ee=is_uuid_v4(ee)?ee:"",get_knowledge_view_from_state(t,ee)}function get_composed_wc_id_maps_object(t,ee){let te={};t.forEach(ie=>{Object.entries(ie.wc_id_map).forEach(([_e,se])=>{se.passthrough||(delete te[_e],te[_e]=se)})}),remove_deleted_wcomponents(te,ee);const ne=partition_wc_id_map_on_blocked(te);te=ne.composed_wc_id_map;const oe=ne.composed_blocked_wc_id_map;return{composed_wc_id_map:te,composed_blocked_wc_id_map:oe}}function remove_deleted_wcomponents(t,ee){Object.keys(t).forEach(te=>{const ne=ee[te];wcomponent_is_deleted(ne)&&delete t[te]})}function partition_wc_id_map_on_blocked(t){const ee={};return Object.entries(t).forEach(([te,ne])=>{ne.blocked&&(ee[te]=ne,delete t[te])}),{composed_wc_id_map:t,composed_blocked_wc_id_map:ee}}function get_available_filter_options(t){const ee=new Set,te=new Set;t.forEach(oe=>{oe.label_ids&&oe.label_ids.forEach(ie=>ee.add(ie)),te.add(oe.type)});const ne=Array.from(te).sort();return{wc_label_ids:ee,wc_types:ne}}const links_regex=/(.*?)(?:\[([^\]]*)\]\([^\)]*\))/g,tags_regex=/(.*?)(\<[^\>]*\>)/g;function remove_rich_text(t){return t=t.replaceAll(" <auto generated>",""),t=t.replaceAll(links_regex,"$1$2"),t=t.replaceAll(tags_regex,"$1"),t}const knowledge_views_derived_reducer=(t,ee)=>{t.specialised_objects.knowledge_views_by_id!==ee.specialised_objects.knowledge_views_by_id&&(ee=update_derived_knowledge_view_state(ee));const ne=get_knowledge_view_given_routing(t),oe=get_knowledge_view_given_routing(ee);(ne==null?void 0:ne.id)!==(oe==null?void 0:oe.id)&&(ee=update_substate(ee,"derived","current_composed_knowledge_view",void 0));const _e=ne!==oe,se=t.specialised_objects.wcomponents_by_id!==ee.specialised_objects.wcomponents_by_id,re=t.meta_wcomponents.selected_wcomponent_ids_set!==ee.meta_wcomponents.selected_wcomponent_ids_set,ae=_e||se||re,ce=t.routing.args.created_at_ms!==ee.routing.args.created_at_ms,de=ce||t.filter_context!==ee.filter_context||se,ue=t.display_options.display_time_marks!==ee.display_options.display_time_marks,le=ce||ue;if(oe){if(ae){let pe=update_current_composed_knowledge_view_state(ee,oe);pe=update_composed_knowledge_view_filters(ee,pe),pe=add_ephemeral_overrides_to_wc_id_map(ee,pe),ee=update_substate(ee,"derived","current_composed_knowledge_view",pe)}else if(de){const pe=update_composed_knowledge_view_filters(ee,ee.derived.current_composed_knowledge_view);ee=update_substate(ee,"derived","current_composed_knowledge_view",pe)}else if(le){let{current_composed_knowledge_view:pe}=ee.derived;pe=update_ephemeral_overrides_of_current_composed_kv(pe,ue,ee,oe),ee=update_substate(ee,"derived","current_composed_knowledge_view",pe)}}return ee};function update_derived_knowledge_view_state(t){const{knowledge_views_by_id:ee}=t.specialised_objects,te=selector_chosen_base_id(t),oe=Object.values(ee).map(se=>({...se,title:remove_rich_text(se.title)})),ie=sort_list(oe,({title:se})=>se,SortDirection.ascending),_e=get_nested_knowledge_view_ids(ie,te);return sort_nested_knowledge_map_ids_by_priority_then_title(_e),t={...t,derived:{...t.derived,knowledge_views:ie,nested_knowledge_view_ids:_e}},t}function update_current_composed_knowledge_view_state(t,ee){const{knowledge_views_by_id:te,wcomponents_by_id:ne}=t.specialised_objects,{current_composed_knowledge_view:oe}=t.derived;return calculate_composed_knowledge_view({knowledge_view:ee,current_composed_knowledge_view:oe,knowledge_views_by_id:te,wcomponents_by_id:ne})}function calculate_composed_knowledge_view(t){const{knowledge_view:ee,knowledge_views_by_id:te,wcomponents_by_id:ne}=t,oe=t.current_composed_knowledge_view||{composed_visible_wc_id_map:{},active_judgement_or_objective_ids_by_target_id:{},active_judgement_or_objective_ids_by_goal_or_action_id:{},filters:{wc_ids_excluded_by_any_filter:new Set,wc_ids_excluded_by_filters:new Set,wc_ids_excluded_by_created_at_datetime_filter:new Set,vap_set_number_excluded_by_created_at_datetime_filter:0}},ie=get_foundational_knowledge_views(ee,te,!0),{composed_wc_id_map:_e,composed_blocked_wc_id_map:se}=get_composed_wc_id_maps_object(ie,ne),re=get_overlapping_wc_ids(_e,ne),ae=Object.keys(_e),ce=get_wcomponent_ids_by_type(ne,ae),de=[],ue=[];ae.forEach(we=>{const ye=ne[we];ye?de.push(ye):ue.push(we)});const le=de.filter(is_wcomponent_node),pe=de.filter(wcomponent_can_render_connection),me=calculate_wc_id_to_counterfactuals_v2_map({wc_ids_by_type:ce,wcomponents_by_id:ne,active_counterfactual_ids:ee.active_counterfactual_v2_ids||[]}),fe=get_prioritisations(ce.prioritisation,ne),ge=get_wc_id_connections_map(ce.any_link,ne),he=get_available_filter_options(de),be=get_composed_datetime_lines_config(ie,!0),ve={...ee,...oe,composed_wc_id_map:_e,composed_blocked_wc_id_map:se,overlapping_wc_ids:re,wcomponent_nodes:le,wcomponent_connections:pe,wcomponent_unfound_ids:ue,wc_id_to_active_counterfactuals_v2_map:me,wc_ids_by_type:ce,prioritisations:fe,wc_id_connections_map:ge,available_filter_options:he,composed_datetime_line_config:be};return delete ve.wc_id_map,delete ve.datetime_line_config,ve}function get_foundational_knowledge_views(t,ee,te){const{foundation_knowledge_view_ids:ne=[]}=t,oe=ne.map(ie=>ee[ie]).filter(is_defined);return te&&oe.push(t),oe}const invalid_node_types=new Set(["causal_link","relation_link"]),is_wcomponent_node=t=>!invalid_node_types.has(t.type);function calculate_wc_id_to_counterfactuals_v2_map(t){const ee={},te=new Set(t.active_counterfactual_ids);return t.wc_ids_by_type.counterfactualv2.forEach(ne=>{if(!te.has(ne))return;const oe=t.wcomponents_by_id[ne];if(!wcomponent_is_counterfactual_v2(oe))return;const{target_wcomponent_id:ie,target_VAP_set_id:_e}=oe;if(!ie||!_e)return;const se=ee[ie]||{VAP_sets:{}};ee[ie]=se;const re=se.VAP_sets[_e]||[];re.push(oe),se.VAP_sets[_e]=re}),ee}function get_prioritisations(t,ee){const te=Array.from(t).map(ne=>ee[ne]).filter(wcomponent_is_prioritisation);return sort_list(te,ne=>get_sim_datetime_ms(ne)||get_created_at_ms(ne),SortDirection.descending)}function get_wc_id_connections_map(t,ee){const te={};function ne(ie,_e){const se=te[ie]||new Set;se.add(_e),te[ie]=se}function oe(ie,_e){ne(ie,_e),ne(_e,ie)}return t.forEach(ie=>{const _e=ee[ie];wcomponent_is_plain_connection(_e)&&(_e.from_id&&oe(_e.from_id,_e.id),_e.to_id&&oe(_e.to_id,_e.id))}),te}function get_composed_datetime_lines_config(t,ee){let te={};return ee&&(te={...DEFAULT_DATETIME_LINE_CONFIG}),t.forEach(ne=>{const{datetime_line_config:oe}=ne;oe&&(te.time_origin_ms=oe.time_origin_ms??te.time_origin_ms,te.time_origin_x=oe.time_origin_x??te.time_origin_x,te.time_scale=oe.time_scale??te.time_scale,te.time_line_number=oe.time_line_number??te.time_line_number,te.time_line_spacing_days=oe.time_line_spacing_days??te.time_line_spacing_days)}),te}function update_composed_knowledge_view_filters(t,ee){if(!ee)return;const{wc_ids_by_type:te,composed_wc_id_map:ne}=ee,oe=get_wcomponents_from_state(t,te.any_node).filter(wcomponent_is_node),ie=get_wcomponents_from_state(t,te.any_link).filter(wcomponent_is_plain_connection),_e=oe.concat(ie);let se=new Set;t.filter_context.apply_filter&&(se=calculate_wc_ids_to_exclude_based_on_filters(t.filter_context.filters,t.meta_wcomponents.selected_wcomponent_ids_set,oe,ie));const{created_at_ms:re}=t.routing.args;let ae=0;const ce=_e.filter(pe=>(wcomponent_has_legitimate_non_empty_state_VAP_sets(pe)&&pe.values_and_prediction_sets.forEach(me=>{get_created_at_ms(me)>re&&++ae}),get_created_at_ms(pe)>re)).map(({id:pe})=>pe),de=new Set(ce),ue=set_union(se,de),le={...ne};return ue.forEach(pe=>{delete le[pe]}),{...ee,composed_visible_wc_id_map:le,filters:{wc_ids_excluded_by_any_filter:ue,wc_ids_excluded_by_filters:se,wc_ids_excluded_by_created_at_datetime_filter:de,vap_set_number_excluded_by_created_at_datetime_filter:ae}}}function calculate_wc_ids_to_exclude_based_on_filters(t,ee,te,ne){const oe=new Set,{exclude_by_label_ids:ie,include_by_label_ids:_e,exclude_by_component_types:se,include_by_component_types:re}=t,ae=new Set(ie),ce=new Set(_e),de=new Set(se),ue=new Set(re),le={exclude_by_label_ids:ae,include_by_label_ids:ce,include_by_label_ids_list:_e,exclude_by_component_types:de,include_by_component_types:ue};return te.forEach(pe=>{const{should_exclude:me,lacks_include:fe}=calc_if_wcomponent_should_exclude_because_label_or_type(pe,le);(me||fe)&&oe.add(pe.id)}),ne.forEach(pe=>{const{from_id:me,to_id:fe}=pe;let ge=!1;//!from_id || !to_id
ge=ge||!!me&&!ee.has(me)&&oe.has(me)||!!fe&&!ee.has(fe)&&oe.has(fe);const he=calc_if_wcomponent_should_exclude_because_label_or_type(pe,le);ge=ge||he.should_exclude,ge&&oe.add(pe.id)}),oe}function get_overlapping_wc_ids(t,ee){const te=get_wc_position_to_id_map(t,ee),ne={};return Object.values(te).forEach(oe=>{oe.length<=1||oe.forEach((ie,_e)=>{const se=_e+1;ne[ie]=[...oe.slice(se),...oe.slice(0,se)]})}),ne}function update_ephemeral_overrides_of_current_composed_kv(t,ee,te,ne){if(t){if(ee&&!te.display_options.display_time_marks){const{knowledge_views_by_id:oe,wcomponents_by_id:ie}=te.specialised_objects,_e=get_foundational_knowledge_views(ne,oe,!0),se=get_composed_wc_id_maps_object(_e,ie);t={...t,...se}}else t=add_ephemeral_overrides_to_wc_id_map(te,t);return t}}function add_ephemeral_overrides_to_wc_id_map(t,ee){if(!ee)return;const{display_time_marks:te}=t.display_options,{wc_ids_by_type:ne,composed_wc_id_map:oe,composed_datetime_line_config:ie}=ee,{time_origin_ms:_e,time_origin_x:se,time_scale:re}=ie,{wcomponents_by_id:ae}=t.specialised_objects,{created_at_ms:ce}=t.routing.args;if(!te||_e===void 0)return ee;const de={...oe};let ue=!1;return Array.from(ne.has_single_datetime).forEach(le=>{const pe=oe[le];if(!pe)return;const me=calculate_canvas_x_for_wcomponent_temporal_uncertainty({wcomponent_id:le,wcomponents_by_id:ae,created_at_ms:ce,time_origin_ms:_e,time_origin_x:se,time_scale:re});me===void 0||pe.left===me||(ue=!0,de[le]={...pe,left:me})}),ue?{...ee,composed_wc_id_map:de}:ee}function get_composed_wcomponents_by_id(t){const{wcomponents_by_id:ee,created_at_ms:te}=t,ne={...ee};return Object.keys(t.composed_visible_wc_id_map||{}).forEach(oe=>{const ie=ee[oe];if(ie&&wcomponent_is_state_value(ie)){const _e=ee[ie.attribute_wcomponent_id||""];if(!wcomponent_is_statev2(_e))return;let se;ie.values_and_prediction_sets&&(se=partition_items_by_created_at_datetime({items:ie.values_and_prediction_sets,created_at_ms:te}).current_items,se=sort_list(se,get_created_at_ms,SortDirection.descending));const re={..._e,values_and_prediction_sets:se,value_possibilities:ie.value_possibilities,_derived__using_value_from_wcomponent_id:ie.id};ne[re.id]=re}}),ne}function derived_composed_wcomponents_by_id_reducer(t,ee){var re,ae;const te=t.specialised_objects.wcomponents_by_id!==ee.specialised_objects.wcomponents_by_id,ne=(re=t.derived.current_composed_knowledge_view)==null?void 0:re.composed_visible_wc_id_map,oe=(ae=ee.derived.current_composed_knowledge_view)==null?void 0:ae.composed_visible_wc_id_map;if(!(te||ne!==oe))return ee;const se=get_composed_wcomponents_by_id_from_state(ee);return ee=update_substate(ee,"derived","composed_wcomponents_by_id",se),ee}function get_composed_wcomponents_by_id_from_state(t){const{wcomponents_by_id:ee}=t.specialised_objects,{composed_visible_wc_id_map:te}=t.derived.current_composed_knowledge_view||{},{created_at_ms:ne}=t.routing.args;return get_composed_wcomponents_by_id({composed_visible_wc_id_map:te,wcomponents_by_id:ee,created_at_ms:ne})}function derived_state_reducer(t,ee){if(t.specialised_objects.wcomponents_by_id!==ee.specialised_objects.wcomponents_by_id){const te=Object.keys(ee.specialised_objects.wcomponents_by_id),ne=get_wcomponent_ids_by_type(ee.specialised_objects.wcomponents_by_id,te);ee=update_substate(ee,"derived","wcomponent_ids_by_type",ne);const oe=get_judgement_or_objectives(ee,ee.derived.wcomponent_ids_by_type.judgement_or_objective),ie=update_judgement_or_objective_ids_by_target_id(oe);ee=update_substate(ee,"derived","judgement_or_objective_ids_by_target_id",ie);const _e=get_wcomponents_from_state(ee,ee.derived.wcomponent_ids_by_type.goal).filter(is_defined).filter(wcomponent_is_goal),se=update_judgement_or_objective_ids_by_goal_or_action_id(_e);ee=update_substate(ee,"derived","judgement_or_objective_ids_by_goal_or_action_id",se)}return ee=knowledge_views_derived_reducer(t,ee),ee=derived_composed_wcomponents_by_id_reducer(t,ee),ee=conditionally_update_active_judgement_or_objective_ids(t,ee),ee}function get_judgement_or_objectives(t,ee){return get_wcomponents_from_state(t,ee).filter(is_defined).filter(wcomponent_is_judgement_or_objective)}function update_judgement_or_objective_ids_by_target_id(t){const ee={};return t.forEach(te=>{const ne=te.judgement_target_wcomponent_id;if(!ne)return;const oe=ee[ne]||[];oe.push(te.id),ee[ne]=oe}),ee}function update_judgement_or_objective_ids_by_goal_or_action_id(t){const ee={};return t.forEach(({id:te,objective_ids:ne})=>{ee[te]=ne||[]}),ee}function conditionally_update_active_judgement_or_objective_ids(t,ee){var ae;let{current_composed_knowledge_view:te}=ee.derived;const ne=((ae=t.derived.current_composed_knowledge_view)==null?void 0:ae.id)!==(te==null?void 0:te.id),oe=t.derived.judgement_or_objective_ids_by_target_id!==ee.derived.judgement_or_objective_ids_by_target_id,{created_at_ms:ie,sim_ms:_e}=ee.routing.args,se=t.routing.args.created_at_ms!==ie,re=t.routing.args.sim_ms!==_e;if(te&&(ne||oe||se||re)){let ce=function(we){return fe[we]};const de={},ue={},{wc_ids_by_type:le,composed_visible_wc_id_map:pe}=te,me=get_judgement_or_objectives(ee,le.judgement_or_objective),fe={};me.forEach(we=>{if(!pe[we.id])return;const{is_valid:ye}=get_wcomponent_validity_value({wcomponent:we,created_at_ms:ie,sim_ms:_e})||default_wcomponent_validity_value();ye&&(fe[we.id]=!0)});const ge={};Object.keys(pe).forEach((we,ye)=>{ge[we]=ye});const he=we=>ge[we]||-1,{judgement_or_objective_ids_by_target_id:be,judgement_or_objective_ids_by_goal_or_action_id:ve}=ee.derived;Object.keys(pe).forEach(we=>{const ye=be[we],ke=ve[we];if(ye){const Ae=ye.filter(ce);if(Ae.length){const $e=sort_list(Ae,he,SortDirection.descending);de[we]=$e}}if(ke){const Ae=ke.filter(ce);if(Ae.length){const $e=sort_list(Ae,he,SortDirection.descending);ue[we]=$e}}}),te={...te,active_judgement_or_objective_ids_by_target_id:de,active_judgement_or_objective_ids_by_goal_or_action_id:ue},ee=update_substate(ee,"derived","current_composed_knowledge_view",te)}return ee}const display_reducer=(t,ee)=>{if(is_toggle_consumption_formatting(ee)&&(t=update_substate(t,"display_options","consumption_formatting",!t.display_options.consumption_formatting)),is_set_or_toggle_focused_mode(ee)){const te=boolean_or_toggle(ee.focused_mode,t.display_options.focused_mode);t=update_substate(t,"display_options","focused_mode",te)}if(is_set_time_resolution(ee)&&(t=update_substate(t,"display_options","time_resolution",ee.time_resolution)),is_set_validity_filter(ee)){t=update_substate(t,"display_options","validity_filter",ee.validity_filter);const te=derive_validity_filter(ee.validity_filter);t=update_substate(t,"display_options","derived_validity_filter",te)}if(is_set_certainty_formatting(ee)){t=update_substate(t,"display_options","certainty_formatting",ee.certainty_formatting);const te=derive_certainty_formatting(ee.certainty_formatting);t=update_substate(t,"display_options","derived_certainty_formatting",te)}if(is_set_display_by_simulated_time(ee)&&(t=update_substate(t,"display_options","display_by_simulated_time",ee.display_by_simulated_time)),is_set_display_time_marks(ee)&&(t=update_substate(t,"display_options","display_time_marks",ee.display_time_marks)),is_set_or_toggle_animate_connections(ee)){const te=boolean_or_toggle(ee.animate_connections,t.display_options.animate_connections);t=update_substate(t,"display_options","animate_connections",te)}if(is_set_or_toggle_circular_links(ee)){const te=boolean_or_toggle(ee.circular_links,t.display_options.circular_links);t=update_substate(t,"display_options","circular_links",te)}if(is_set_show_help_menu(ee)&&(t=update_substate(t,"display_options","show_help_menu",ee.show)),is_set_or_toggle_show_large_grid(ee)){const te=boolean_or_toggle(ee.show_large_grid,t.display_options.show_large_grid);t=update_substate(t,"display_options","show_large_grid",te)}if(is_set_or_toggle_enable_angular_connections(ee)){const te=boolean_or_toggle(ee.enable_angular_connections,t.display_options.enable_angular_connections);t=update_substate(t,"display_options","enable_angular_connections",te)}return t};function boolean_or_toggle(t,ee){return t===void 0&&(t=!ee),t}function get_is_on_actions_list_view(t){return t.routing.args.view==="actions_list"}function get_action_ids_for_actions_list_view(t){let ee=t.derived.wcomponent_ids_by_type.action;const{apply_filter:te,filters:ne}=t.filter_context;if(!te)return ee;const{filter_by_current_knowledge_view:oe,filter_by_text:ie}=ne;if(oe){const _e=get_current_composed_knowledge_view_from_state(t);_e&&(ee=_e.wc_ids_by_type.action)}if(ie){const _e=Array.from(ee).map(se=>t.specialised_objects.wcomponents_by_id[se]).filter(is_a_wcomponent).filter(se=>se.title.includes(ie)||se.description.includes(ie)).map(se=>se.id);ee=new Set(_e)}return ee}const filter_context_reducer=(t,ee)=>{if(is_set_apply_filter(ee)&&(t=update_substate(t,"filter_context","apply_filter",ee.apply_filter)),is_set_filters(ee)){t=update_substate(t,"filter_context","filters",ee.filters);const te=get_is_on_actions_list_view(t),{exclude_by_label_ids:ne,include_by_label_ids:oe,exclude_by_component_types:ie,include_by_component_types:_e,filter_by_current_knowledge_view:se,filter_by_text:re}=ee.filters,ae=ne.length+oe.length+ie.length+_e.length>0||te&&(se||re.length>0);t=update_substate(t,"filter_context","apply_filter",ae)}return t},global_keys_reducer=(t,ee)=>{let te=!1;if(is_key_down(ee)){te=!0;const ne=new Set([...t.global_keys.keys_down]);ne.add(ee.key),t={...t,global_keys:{...t.global_keys,last_key:ee.key,last_key_time_stamp:ee.time_stamp,keys_down:ne}}}if(is_key_up(ee)){te=!0;let ne=new Set([...t.global_keys.keys_down]);ne.delete(ee.key),t={...t,global_keys:{...t.global_keys,last_key:ee.key,last_key_time_stamp:ee.time_stamp,keys_down:ne}}}return is_clear_all_keys(ee)&&(te=!0,t=update_substate(t,"global_keys","keys_down",new Set)),te&&(t=set_derived_state(t)),t};function set_derived_state(t){const{keys_down:ee}=t.global_keys,te=ee.has("Control"),ne=ee.has("Shift"),oe={...t.global_keys,derived:{shift_down:ne,control_down:te,shift_or_control_down:te||ne}};return{...t,global_keys:oe}}const view_priorities_reducer=(t,ee)=>(is_set_action_ids_to_show(ee)&&(t=update_substate(t,"view_priorities","action_ids_to_show",ee.action_ids),t=update_substate(t,"view_priorities","date_shown",ee.date_shown)),t),ONE_MINUTE$1=60*1e3;function get_latest_sim_ms_for_routing(t,ee){let te=Number.NEGATIVE_INFINITY;return wcomponent_has_legitimate_non_empty_state_VAP_sets(t)&&t.type==="action"&&t.values_and_prediction_sets.forEach(ne=>{var ie;const oe=((ie=get_uncertain_datetime(ne.datetime))==null?void 0:ie.getTime())||Number.NEGATIVE_INFINITY;te=Math.max(te,oe)}),te=Math.max(te+ONE_MINUTE$1,ee.routing.args.sim_ms),te}const routing_reducer=(t,ee)=>{if(is_change_route(ee)){const{route:te,sub_route:ne,item_id:oe,args:ie}=t.routing,_e=merge_routing_state(t.routing,ee);(te!==_e.route||ne!==_e.sub_route||oe!==_e.item_id||routing_args_to_string(ie)!==routing_args_to_string(_e.args))&&(t={...t,routing:_e})}if(is_upsert_wcomponent(ee)){const te=get_latest_sim_ms_for_routing(ee.wcomponent,t);te!==t.routing.args.sim_ms&&(t=update_subsubstate(t,"routing","args","sim_ms",te))}return t},find_all_causal_paths_reducer=(t,ee)=>{if(is_set_find_all_causal_paths_wcomponent_ids(ee)){const te=ee.side==="right"?"find_all_causal_paths_from_wcomponent_ids":"find_all_causal_paths_to_wcomponent_ids";t=update_substate(t,"meta_wcomponents",te,ee.ids)}return t};function replace_element(t,ee,te){const ne=t.findIndex(te);return ne<0?(console.error(`Can not find element by predicate: ${te.toString()}`),t):[...t.slice(0,ne),ee,...t.slice(ne+1)]}function upsert_entry(t,ee,te,ne=""){let oe=-1;const ie=t.filter((se,re)=>{const ae=te(se);return ae&&(oe=re),ae});if(ie.length>1)throw new Error(`During upsert_entry multiple (${ie.length}) "${ne}" items matching predicate: "${te.toString()}"`);let _e=t;return ie.length===1?ie[0]!==ee&&(_e=[...t.slice(0,oe),ee,...t.slice(oe+1)]):_e=[...t,ee],_e}function remove_element(t,ee){const te=t.filter(ne=>!ee(ne));return te.length===t.length?t:te}function toggle_item_in_list(t,ee,te){const ne=te||(ie=>ie===ee),oe=t.filter(ie=>!ne(ie));return oe.length===t.length&&oe.push(ee),oe}function index_is_in_bounds(t,ee){return t.length>0&&ee>=0&&ee<t.length}function swap_elements(t,ee,te){if(!index_is_in_bounds(t,ee)||!index_is_in_bounds(t,te))return t;const ne=Math.min(ee,te),oe=Math.max(ee,te),ie=[...t],_e=ie[ne];return ie[ne]=ie[oe],ie[oe]=_e,ie}function insert_element_at_index(t,ee,te){return te<=0?t=[ee,...t]:te>=t.length?t=[...t,ee]:t=[...t.slice(0,te),ee,...t.slice(te)],t}const selecting_reducer=(t,ee)=>{const te=t.meta_wcomponents.selected_wcomponent_ids_list;if(is_clicked_wcomponent(ee)){const{id:ne}=ee;let oe=[...t.meta_wcomponents.selected_wcomponent_ids_list];const{shift_or_control_down:ie}=t.global_keys.derived;ie?oe=toggle_item_in_list(oe,ne):oe=[ne];const _e={...t.meta_wcomponents,selected_wcomponent_ids_list:oe,last_clicked_wcomponent_id:ne};t={...t,meta_wcomponents:_e}}if(is_clear_selected_wcomponents(ee)&&(t=handle_clear_selected_wcomponents(t)),is_set_selected_wcomponents(ee)&&(t=handle_set_selected_wcomponents(t,ee)),is_pointerdown_on_component(ee)){const ne={wcomponent_id:ee.wcomponent_id,terminal_type:void 0};t=update_substate(t,"meta_wcomponents","last_pointer_down_connection_terminal",ne)}if(is_pointerdown_on_connection_terminal(ee)){const{wcomponent_id:ne,terminal_type:oe}=ee;t=update_substate(t,"meta_wcomponents","last_pointer_down_connection_terminal",{wcomponent_id:ne,terminal_type:oe})}return is_clear_pointerupdown_on_connection_terminal(ee)&&(t=update_substate(t,"meta_wcomponents","last_pointer_down_connection_terminal",void 0)),is_set_wcomponent_ids_to_move(ee)&&(t=update_substate(t,"meta_wcomponents","wcomponent_ids_to_move_set",ee.wcomponent_ids_to_move)),te!==t.meta_wcomponents.selected_wcomponent_ids_list&&(t=update_derived_selected_wcomponent_ids(t)),t};function handle_clear_selected_wcomponents(t){return t=update_substate(t,"meta_wcomponents","selected_wcomponent_ids_list",[]),t}function handle_set_selected_wcomponents(t,ee){return t=update_substate(t,"meta_wcomponents","selected_wcomponent_ids_list",[...ee.ids]),t}function update_derived_selected_wcomponent_ids(t){const ee=new Set(t.meta_wcomponents.selected_wcomponent_ids_list),te={};t.meta_wcomponents.selected_wcomponent_ids_list.forEach((oe,ie)=>te[oe]=ie);const ne={...t.meta_wcomponents,selected_wcomponent_ids_set:ee,selected_wcomponent_ids_to_ordinal_position_map:te};return{...t,meta_wcomponents:ne}}const meta_wcomponents_reducer=(t,ee)=>(t=find_all_causal_paths_reducer(t,ee),t=selecting_reducer(t,ee),is_set_frame_is_resizing(ee)&&(t=update_substate(t,"meta_wcomponents","frame_is_resizing",ee.frame_is_resizing)),t);function derived_meta_wcomponents_state_reducer(t,ee){return ee=handle_route_changed(t,ee),ee}function handle_route_changed(t,ee){const te=t.sync.ready_for_reading!==ee.sync.ready_for_reading;if((t.routing.item_id!==ee.routing.item_id||te)&&ee.routing.item_id&&is_uuid_v4(ee.routing.item_id)){const ne=[ee.routing.item_id];ee=update_substate(ee,"meta_wcomponents","selected_wcomponent_ids_list",ne),ee=update_derived_selected_wcomponent_ids(ee)}return ee}function prepare_new_VAP(){return{id:get_new_VAP_id(),explanation:"",probability:0,conviction:1,value:"",description:""}}function set_VAP_probabilities(t,ee){const te=t.length>1;let ne=0;return t=t.map(oe=>{const ie=te?oe.relative_probability===void 0?oe.probability:oe.relative_probability:void 0;return ie!==void 0&&(ne+=ie),{...oe,relative_probability:ie}}),ee!==VAPsType.boolean&&(ne=ne||1,t=t.map(oe=>{const _e=(oe.relative_probability===void 0?1:oe.relative_probability)/ne;return{...oe,probability:_e}})),t}function tidy_wcomponent(t,ee){if(wcomponent_has_validity_predictions(t)){const te=sort_list(t.validity,get_created_at_ms,SortDirection.ascending);t.validity=te}if(wcomponent_has_VAP_sets(t)){const te=sort_list(t.values_and_prediction_sets||[],get_created_at_ms,SortDirection.ascending),ne=get_wcomponent_VAPs_represent(t,ee),oe=te.map(ie=>({...ie,entries:set_VAP_probabilities(ie.entries,ne)}));t.values_and_prediction_sets=oe}return wcomponent_is_allowed_to_have_state_VAP_sets(t)&&(t._derived__using_value_from_wcomponent_id&&console.error(`WComponent "${t.id}" had _derived__using_value_from_wcomponent_id set ("${t._derived__using_value_from_wcomponent_id}") but this should never happen and only be used on wcomponents from state.derived.composed_wcomponents_by_id`),delete t._derived__using_value_from_wcomponent_id),t}function update_specialised_object_ids_pending_save$1(t,ee,te,ne){let{wcomponent_ids:oe,knowledge_view_ids:ie}=t.sync.specialised_object_ids_pending_save;const _e=ee==="wcomponent";let se=_e?oe:ie;return se=ne?ensure_item_in_set(se,te):ensure_item_not_in_set(se,te),t=update_subsubstate(t,"sync","specialised_object_ids_pending_save",_e?"wcomponent_ids":"knowledge_view_ids",se),t}function update_wcomponent_last_source_of_truth(t,ee){return ee=tidy_wcomponent(ee,t.specialised_objects.wcomponents_by_id),ee=clean_base_object_of_sync_meta_fields(ee),t=update_subsubsubstate(t,"sync","last_source_of_truth_specialised_objects_by_id","wcomponents",ee.id,ee),t}function update_knowledge_view_last_source_of_truth(t,ee){return ee=clean_base_object_of_sync_meta_fields(ee),t=update_subsubsubstate(t,"sync","last_source_of_truth_specialised_objects_by_id","knowledge_views",ee.id,ee),t}function update_modified_by(t,ee){return update_modified_or_deleted_by(t,ee,!1)}function update_modified_or_deleted_by(t,ee,te){return t={...t,needs_save:!0,modified_by_username:selector_user_name(ee)},te&&(t.deleted_at=new Date),t}function handle_upsert_knowledge_view(t,ee,te){const ne={...t.specialised_objects.knowledge_views_by_id};return ee=te?ee:update_modified_by(ee,t),ne[ee.id]=ee,t=update_substate(t,"specialised_objects","knowledge_views_by_id",ne),t=update_specialised_object_ids_pending_save$1(t,"knowledge_view",ee.id,!!ee.needs_save),t}const bulk_editing_knowledge_view_entries_reducer=(t,ee)=>(is_bulk_edit_knowledge_view_entries(ee)&&(t=handle_bulk_edit_knowledge_view_entries(t,ee)),is_bulk_update_knowledge_view_entries(ee)&&(t=handle_bulk_update_knowledge_view_entries(t,ee)),is_snap_to_grid_knowledge_view_entries(ee)&&(t=handle_snap_to_grid_knowledge_view_entries(t,ee)),is_change_current_knowledge_view_entries_order(ee)&&(t=handle_change_current_knowledge_view_entries_order(t,ee)),is_bulk_add_to_knowledge_view(ee)&&(t=handle_bulk_add_to_knowledge_view(t,ee)),is_bulk_remove_from_knowledge_view(ee)&&(t=handle_bulk_remove_from_knowledge_view(t,ee)),t);function handle_bulk_add_to_knowledge_view(t,ee){const{knowledge_view_id:te,wcomponent_ids:ne,override_entry:oe,default_entry:ie}=ee,_e=t.specialised_objects.knowledge_views_by_id[te],se=get_current_composed_knowledge_view_from_state(t);if(!_e)console.error(`Could not find knowledge view for bulk_add_to_knowledge_view by id: "${te}"`);else if(!se)console.error("There should always be a current knowledge view if bulk editing position of world components");else{let re={};ne.forEach(ce=>{let de={...ie,...se.composed_wc_id_map[ce],...oe,blocked:void 0,passthrough:void 0};if(de.left===void 0||de.top===void 0){console.error(`we should always have an entry but no bulk_entry provided and wcomponent "${ce}" lacking entry in composed_kv composed_wc_id_map for "${te}"`);return}re[ce]=de}),re={..._e.wc_id_map,...re};const ae={..._e,wc_id_map:re};t=handle_upsert_knowledge_view(t,ae)}return t}function handle_bulk_remove_from_knowledge_view(t,ee){const{wcomponent_ids:te,remove_type:ne}=ee,oe=ne==="block",ie=get_current_knowledge_view_from_state(t),_e=get_current_composed_knowledge_view_from_state(t);if(!ie||!_e)console.error("There should always be a current and current composed knowledge view if bulk editing (removing) positions of world components");else{const se={...ie.wc_id_map};te.forEach(ae=>{const ce=oe?_e.composed_wc_id_map[ae]:ie.wc_id_map[ae];if(!ce)return;const de=oe?{...ce,blocked:!0,passthrough:void 0}:{...ce,blocked:void 0,passthrough:!0};se[ae]=de});const re={...ie,wc_id_map:se};t=handle_upsert_knowledge_view(t,re)}return t}function handle_snap_to_grid_knowledge_view_entries(t,ee){const{wcomponent_ids:te,knowledge_view_id:ne}=ee,oe=t.specialised_objects.knowledge_views_by_id[ne];if(oe){const ie={...oe.wc_id_map};te.forEach(se=>{const re=oe.wc_id_map[se];if(!re)return;const ae=round_canvas_point(re,"large");ie[se]=ae});const _e={...oe,wc_id_map:ie};t=handle_upsert_knowledge_view(t,_e)}return t}function handle_change_current_knowledge_view_entries_order(t,ee){const{wcomponent_ids:te,order:ne}=ee,oe=get_current_knowledge_view_from_state(t),ie=get_current_composed_knowledge_view_from_state(t);if(!oe||!ie)return console.error("There should always be a current knowledge view and current composed knowledge view if bulk editing (moving to top) world components"),t;let _e={};ne==="front"?(_e={...oe.wc_id_map},te.forEach(re=>{const ae=ie.composed_wc_id_map[re];ae&&(delete _e[re],_e[re]=ae)})):ne==="back"&&(te.forEach(re=>{const ae=ie.composed_wc_id_map[re];ae&&(_e[re]=ae)}),_e={..._e,...oe.wc_id_map});const se={...oe,wc_id_map:_e};return t=handle_upsert_knowledge_view(t,se),t}function handle_bulk_edit_knowledge_view_entries(t,ee){const{wcomponent_ids:te,change_left:ne,change_top:oe}=ee,ie=get_current_knowledge_view_from_state(t),_e=get_current_composed_knowledge_view_from_state(t);if(ie&&_e){const se={...ie.wc_id_map};te.forEach(ae=>{const ce=_e.composed_wc_id_map[ae];if(!ce||ce.blocked||ce.passthrough)return;const de={...ce};de.left+=ne,de.top+=oe,se[ae]=de});const re={...ie,wc_id_map:se};t=handle_upsert_knowledge_view(t,re)}else console.error("There should always be a current knowledge view if bulk editing position of world components");return t}function handle_bulk_update_knowledge_view_entries(t,ee){const{knowledge_view_id:te,changes:ne}=ee,oe=t.specialised_objects.knowledge_views_by_id[te];if(oe){const ie={...oe.wc_id_map};ne.forEach(se=>{const re=oe.wc_id_map[se.wcomponent_id];if(!re)return;const ae={...re,left:se.left,top:se.top};ie[se.wcomponent_id]=ae});const _e={...oe,wc_id_map:ie};t=handle_upsert_knowledge_view(t,_e)}return t}const knowledge_views_reducer=(t,ee)=>{if(is_upsert_knowledge_view(ee)&&(t=handle_upsert_knowledge_view(t,ee.knowledge_view,ee.is_source_of_truth)),is_upsert_wcomponent(ee)){const{wcomponent:te,add_to_knowledge_view:ne,add_to_top:oe}=ee;if(ne){const _e={...ne.position};t=handle_upsert_knowledge_view_entry(t,ne.id,te.id,_e,oe)}const ie=t.specialised_objects.knowledge_views_by_id[te.id];if(ie&&ie.title!==te.title){const _e={...ie,title:te.title};t=handle_upsert_knowledge_view(t,_e,ee.is_source_of_truth)}}if(is_upsert_knowledge_view_entry(ee)&&(t=handle_upsert_knowledge_view_entry(t,ee.knowledge_view_id,ee.wcomponent_id,ee.entry)),is_update_specialised_object_sync_info(ee)&&ee.object_type==="knowledge_view"){let te=get_knowledge_view_from_state(t,ee.id);te?(te={...te,saving:ee.saving},t=update_subsubstate(t,"specialised_objects","knowledge_views_by_id",ee.id,te)):console.error(`Could not find knowledge_view by id: "${ee.id}" whilst handling is_update_specialised_object_sync_info`)}return t=bulk_editing_knowledge_view_entries_reducer(t,ee),t};function handle_upsert_knowledge_view_entry(t,ee,te,ne,oe){const ie=get_knowledge_view_from_state(t,ee);return ie?add_wcomponent_entry_to_knowledge_view(t,ie,te,ne,oe):(console.error(`Could not find knowledge_view for id: "${ee}"`),t)}function add_wcomponent_entry_to_knowledge_view(t,ee,te,ne,oe=!0){let ie={...ee.wc_id_map};const _e=ie[te];_e&&(_e.blocked&&!ne.blocked||_e.passthrough&&!ne.passthrough)&&delete ie[te],oe?ie[te]=ne:ie={[te]:ne,...ie};const se={...ee,wc_id_map:ie};return handle_upsert_knowledge_view(t,se)}const _wcomponent_types={event:!0,statev2:!0,state_value:!0,sub_state:!0,multidimensional_state:!0,process:!0,action:!0,actor:!0,causal_link:!0,relation_link:!0,judgement:!0,objective:!0,counterfactualv2:!0,goal:!0,prioritisation:!0},wcomponent_types=Object.keys(_wcomponent_types).sort().filter(t=>t!=="multidimensional_state");function get_items_by_id(t,ee){const te={};return t.forEach(ne=>{if(te[ne.id])throw new Error(`Duplicate "${ee}".id: "${te[ne.id]}".  "${te[ne.id].title}" and "${ne.title}"`);te[ne.id]=ne}),te}const syncing_reducer=(t,ee)=>{if(is_replace_all_specialised_objects(ee)){const{wcomponents:te,knowledge_views:ne}=ee.specialised_objects,oe=get_items_by_id(te,"wcomponents"),ie=get_items_by_id(ne,"knowledge_views");t={...t,specialised_objects:{wcomponents_by_id:oe,knowledge_views_by_id:ie}}}return is_clear_from_mem_all_specialised_objects(ee)&&(t={...t,specialised_objects:{wcomponents_by_id:{},knowledge_views_by_id:{}}}),t};function handle_upsert_wcomponent(t,ee,te,ne=!1){const oe={...t.specialised_objects.wcomponents_by_id};return ee=te?ee:update_modified_or_deleted_by(ee,t,ne),oe[ee.id]=ee,t=update_substate(t,"specialised_objects","wcomponents_by_id",oe),t=update_specialised_object_ids_pending_save$1(t,"wcomponent",ee.id,!!ee.needs_save),t}function handle_add_wcomponents_to_store(t,ee){const te={...t.specialised_objects.wcomponents_by_id};return ee.forEach(ne=>te[ne.id]=ne),t=update_substate(t,"specialised_objects","wcomponents_by_id",te),t}const bulk_editing_wcomponents_reducer=(t,ee)=>(is_bulk_edit_wcomponents(ee)&&(t=handle_bulk_edit_wcomponents(t,ee)),t);function handle_bulk_edit_wcomponents(t,ee){const{wcomponent_ids:te,change:ne,remove_label_ids:oe,add_label_ids:ie}=ee,_e=get_wcomponents_from_state(t,te).filter(is_defined);return _e.length&&_e.forEach(se=>{const re={...se,...ne},ae=modify_label_ids(re,oe,ie),ce=tidy_wcomponent(ae,t.specialised_objects.wcomponents_by_id);t=handle_upsert_wcomponent(t,ce,!1)}),t}function modify_label_ids(t,ee,te){let{label_ids:ne}=t;if(ne&&ee&&(ne=ne.filter(oe=>!ee.has(oe))),te){const oe=ne||[],ie=new Set(oe);Array.from(te).forEach(_e=>{ie.has(_e)||oe.push(_e)}),ne=oe}return{...t,label_ids:ne}}const wcomponents_reducer=(t,ee)=>{if(is_upsert_wcomponent(ee)){const te=tidy_wcomponent(ee.wcomponent,t.specialised_objects.wcomponents_by_id);t=handle_upsert_wcomponent(t,te,ee.is_source_of_truth)}if(is_delete_wcomponent(ee)){const{wcomponent_id:te}=ee;let{wcomponents_by_id:ne}=t.specialised_objects;const oe=ne[te];oe&&(t=handle_upsert_wcomponent(t,oe,!1,!0))}if(is_add_wcomponents_to_store(ee)){const te=ee.wcomponents.map(ne=>tidy_wcomponent(ne,t.specialised_objects.wcomponents_by_id));t=handle_add_wcomponents_to_store(t,te)}if(is_update_specialised_object_sync_info(ee)&&ee.object_type==="wcomponent"){let te=get_wcomponent_from_state(t,ee.id);te?(te={...te,saving:ee.saving},t=update_subsubstate(t,"specialised_objects","wcomponents_by_id",ee.id,te)):console.error(`Could not find wcomponent by id: "${ee.id}" whilst handling is_update_specialised_object_sync_info`)}return t=bulk_editing_wcomponents_reducer(t,ee),t},specialised_objects_reducer=(t,ee)=>(t=highlighting_reducer(t,ee),t=syncing_reducer(t,ee),t=wcomponents_reducer(t,ee),t=knowledge_views_reducer(t,ee),t),sync_reducer=(t,ee)=>{if(is_update_sync_status(ee)){const{status:te,loading_base_id:ne,error_message:oe="",attempt:ie}=ee,_e={...t.sync[ee.data_type],status:te,error_message:oe,retry_attempt:ie};ne!==void 0&&(_e.loading_base_id=ne),t=update_substate(t,"sync",ee.data_type,_e),t=update_ready_for_fields(t)}if(is_debug_refresh_all_specialised_object_ids_pending_save(ee)){const te=Object.values(t.specialised_objects.wcomponents_by_id),ne=Object.values(t.specialised_objects.knowledge_views_by_id),oe=prepare_specialised_object_ids_pending_save({wcomponents:te,knowledge_views:ne});t=update_specialised_object_ids_pending_save(t,oe)}if(is_clear_from_mem_all_specialised_objects(ee)&&(t=update_specialised_object_ids_pending_save(t,{knowledge_view_ids:new Set,wcomponent_ids:new Set}),t=update_substate(t,"sync","last_source_of_truth_specialised_objects_by_id",{wcomponents:{},knowledge_views:{}}),t=update_substate(t,"sync","specialised_objects",{status:void 0,loading_base_id:void 0,error_message:"",retry_attempt:0}),t=update_ready_for_fields(t)),is_replace_all_specialised_objects(ee)){const{wcomponents:te,knowledge_views:ne}=ee.specialised_objects,oe=prepare_specialised_object_ids_pending_save({wcomponents:te,knowledge_views:ne});t=update_specialised_object_ids_pending_save(t,oe);const ie={wcomponents:get_items_by_id(te,"wcomponents"),knowledge_views:get_items_by_id(ne,"knowledge_views")};t=update_substate(t,"sync","last_source_of_truth_specialised_objects_by_id",ie)}if(is_upsert_wcomponent(ee)&&ee.is_source_of_truth&&(t=update_wcomponent_last_source_of_truth(t,ee.wcomponent)),is_upsert_knowledge_view(ee)&&ee.is_source_of_truth&&(t=update_knowledge_view_last_source_of_truth(t,ee.knowledge_view)),is_update_network_status(ee)&&(t=update_substate(t,"sync","network_functional",ee.network_functional),t=update_substate(t,"sync","network_function_last_checked",ee.last_checked)),is_request_searching_for_wcomponents_by_id_in_any_base(ee)){const te=new Set(t.sync.wcomponent_ids_to_search_for_in_any_base),{wcomponent_ids_searching_for_in_any_base:ne,wcomponent_ids_searched_for_in_any_base:oe}=t.sync;ee.ids.filter(ie=>!te.has(ie)&&!ne.has(ie)&&!oe.has(ie)&&!t.specialised_objects.wcomponents_by_id[ie]).forEach(ie=>te.add(ie)),t=update_substate(t,"sync","wcomponent_ids_to_search_for_in_any_base",te)}if(is_searching_for_wcomponents_by_id_in_any_base(ee)){const te=set_union(t.sync.wcomponent_ids_to_search_for_in_any_base,t.sync.wcomponent_ids_searching_for_in_any_base);t=update_substate(t,"sync","wcomponent_ids_to_search_for_in_any_base",new Set),t=update_substate(t,"sync","wcomponent_ids_searching_for_in_any_base",te)}if(is_searched_for_wcomponents_by_id_in_any_base(ee)){const te=new Set(t.sync.wcomponent_ids_searching_for_in_any_base),ne=new Set(t.sync.wcomponent_ids_searched_for_in_any_base);ee.ids.forEach(oe=>{te.delete(oe),ne.add(oe)}),t=update_substate(t,"sync","wcomponent_ids_searching_for_in_any_base",te),t=update_substate(t,"sync","wcomponent_ids_searched_for_in_any_base",ne)}return t};function update_ready_for_fields(t){const{bases:ee,specialised_objects:te}=t.sync,ne=get_ready_for_fields_for_data_type(te);return t=update_substate(t,"sync","ready_for_reading",ne.ready_for_reading),t=update_substate(t,"sync","ready_for_writing",ne.ready_for_writing),t}function get_ready_for_fields_for_data_type(t){const{status:ee}=t;return{ready_for_reading:ee!==void 0&&ee!=="LOADING",ready_for_writing:ee==="SAVED"||ee==="LOADED"||ee==="FAILED"}}function prepare_specialised_object_ids_pending_save(t){const ee=new Set(t.wcomponents.filter(ne=>ne.needs_save).map(({id:ne})=>ne)),te=new Set(t.knowledge_views.filter(ne=>ne.needs_save).map(({id:ne})=>ne));return{wcomponent_ids:ee,knowledge_view_ids:te}}function update_specialised_object_ids_pending_save(t,ee){return update_substate(t,"sync","specialised_object_ids_pending_save",ee)}const user_info_reducer=(t,ee)=>{var te,ne;if(is_set_user(ee)){const oe=((te=t.user_info.user)==null?void 0:te.id)!==((ne=ee.user)==null?void 0:ne.id);t=update_substate(t,"user_info","user",ee.user);const ie=t.user_info.has_signed_in_at_least_once||!!ee.user;t=update_substate(t,"user_info","has_signed_in_at_least_once",ie),oe&&pub_sub.user.pub("changed_user",!0)}if(is_set_users(ee)){let oe;ee.users&&(oe={},ee.users.forEach(ie=>oe[ie.id]=ie)),t=update_substate(t,"user_info","users_by_id",oe)}if(is_set_need_to_handle_password_recovery(ee)&&(t=update_substate(t,"user_info","need_to_handle_password_recovery",ee.need_to_handle_password_recovery)),is_update_bases(ee)){const{bases:oe}=ee,ie=build_bases_by_id_map(oe);t=update_substate(t,"user_info","bases_by_id",ie);let _e=!1;if(t.user_info.user){const se=t.user_info.chosen_base_id;t=ensure_valid_chosen_base_id(t),_e=se!==t.user_info.chosen_base_id}pub_sub.user.pub("changed_bases",!0),_e&&pub_sub.user.pub("changed_chosen_base_id",!0)}if(is_update_chosen_base_id(ee)){const oe=t.user_info.chosen_base_id;t=update_substate(t,"user_info","chosen_base_id",ee.base_id),oe!==t.user_info.chosen_base_id&&pub_sub.user.pub("changed_chosen_base_id",!0)}return t};function build_bases_by_id_map(t){let ee;return t&&(ee={},t.forEach(te=>ee[te.id]=te)),ee}function ensure_valid_chosen_base_id(t){var ne;const{bases_by_id:ee,chosen_base_id:te}=t.user_info;if(ee&&(te===void 0||!ee[te])){const oe=selector_editable_bases(t),ie=oe&&((ne=oe[0])==null?void 0:ne.id);t=update_substate(t,"user_info","chosen_base_id",ie)}return t}const root_reducer$1=(t,ee)=>{const te=t;return t=display_reducer(t,ee),t=sync_reducer(t,ee),t=routing_reducer(t,ee),t=global_keys_reducer(t,ee),t=display_at_created_datetime_reducer(t,ee),t=display_at_sim_datetime_reducer(t,ee),t=specialised_objects_reducer(t,ee),t=meta_wcomponents_reducer(t,ee),t=controls_reducer(t,ee),t=creation_context_reducer(t,ee),t=filter_context_reducer(t,ee),t=user_info_reducer(t,ee),t=view_priorities_reducer(t,ee),t=search_reducer(t,ee),t={...t,last_action:ee},t=derived_state_reducer(te,t),t=derived_meta_wcomponents_state_reducer(te,t),window.debug_state=t,t},factory_location_hash=t=>{let ee;const te=factory_throttled_update_location_hash();record_location_hash_change(t);function ne(){const oe=t.getState();if(oe.routing===ee)return;const ie=calc_changed_only_xy(ee,oe.routing);ee=oe.routing,te(ie,oe.routing)}return ne(),ne};let hash_pending_update=!1;function factory_throttled_update_location_hash(){const t=throttle(te=>{const ne=routing_state_to_string(te);window.DEBUG_ROUTING&&console.log("DELAYED changing route from ",window.location.hash.toString(),"   to:   ",ne),window.location.hash=ne,hash_pending_update=!1},1e3),ee=throttle(te=>{const ne=routing_state_to_string(te),oe=url_is_incomplete(window.location.toString());window.DEBUG_ROUTING&&console.log(`Debounced changing route from "${oe?"incomplete":"complete"}"`,window.location.hash.toString(),"   to:   ",ne),oe?history.replaceState(null,"",ne):window.location.hash=ne,hash_pending_update=!1},0);return(te,ne)=>{hash_pending_update=!0,te?t.throttled(ne):(t.cancel(),ee.cancel(),ee.throttled(ne))}}function calc_changed_only_xy(t,ee){return!t||!t.args?!1:t.args.x!==ee.args.x||t.args.y!==ee.args.y}function record_location_hash_change(t){window.onhashchange=ee=>{var oe,ie,_e,se;if(hash_pending_update)return;const te=ee,ne=t.getState();if(ne.sync.ready_for_reading){const re="#"+(te.newURL.split("#")[1]||""),ae=routing_state_to_string(ne.routing);if(ae===re){window.DEBUG_ROUTING&&console.log("on hash change but no difference to current hash route_from_state",ae);return}window.DEBUG_ROUTING&&console.log("on hash change difference.  new url is: ",re,"   state is:   ",ae),t.dispatch(ACTIONS.meta_wcomponents.clear_selected_wcomponents({}));const de=merge_route_params_prioritising_url_over_state(te.newURL,ne.routing);((oe=de==null?void 0:de.args)==null?void 0:oe.created_at_ms)!==void 0&&((ie=de==null?void 0:de.args)==null||delete ie.created_at_datetime),((_e=de==null?void 0:de.args)==null?void 0:_e.sim_ms)!==void 0&&((se=de==null?void 0:de.args)==null||delete se.sim_datetime),t.dispatch(ACTIONS.routing.change_route(de))}}}function sync_storage_location_subscriber(t){const ee=t.getState();let{chosen_base_id:te}=ee.user_info;t.subscribe(()=>{const ne=t.getState(),{chosen_base_id:oe}=ne.user_info,{storage_location:ie}=ne.routing.args;ie===void 0?ie!==oe&&(console.log(`Change storage_location in route to "${oe}" as nothing was set`),t.dispatch(ACTIONS.routing.change_route({args:{storage_location:oe}}))):ie!==oe&&(te!==oe?t.dispatch(ACTIONS.routing.change_route({args:{storage_location:oe}})):t.dispatch(ACTIONS.user_info.update_chosen_base_id({base_id:ie}))),te=oe})}const routing_subscribers={sync_storage_location_subscriber};function get_default_parent_goal_or_action_ids(t,ee,te){let ne=t?ee[t]:void 0;for(;ne;){const oe=te[ne.id];if(wcomponent_is_action(oe)||wcomponent_is_goal(oe))return[oe.id];ne=ne.parent_knowledge_view_id?ee[ne.parent_knowledge_view_id]:void 0}return[]}function get_max_value_possibilities_order(t){let ee=-1;if(t){let te;Array.isArray(t)?te=t:te=Object.values(t),te.forEach(({order:ne=-1})=>ee=Math.max(ee,ne))}return ee}function ensure_possible_values_have_ids(t){let ee=get_max_value_possibilities_order(t);return t.map(ne=>{const oe=ne.id||v4(),ie=ne.order??++ee;return{description:"",...ne,id:oe,order:ie}})}const action_statuses=["potential","in progress","paused","completed","failed","rejected"];new Set(action_statuses);function default_possible_values(t,ee){return t===VAPsType.boolean?ee=[{value:"True",id:VALUE_POSSIBILITY_IDS.boolean_true,order:0},{value:"False",id:VALUE_POSSIBILITY_IDS.boolean_false,order:1}]:t===VAPsType.action?ee=ORDERED_ACTION_VALUE_POSSIBILITY_ID.map((te,ne)=>({id:te,value:VALUE_POSSIBILITY_IDS_to_text[te]||"?",order:ne})):ee.length===0&&(t===VAPsType.number?["1"]:[""]).forEach((te,ne)=>{ee.push({value:te,order:ne})}),ee}const test_default_possible_values=describe.delay("default_possible_values",()=>{const t=[{id:"730a7cb4-7523-45f7-bfde-a00d0acb9f65",value:"",description:"",order:0},{id:"724c4da6-f4ee-4680-a493-556ee241f29d",value:"",description:"",order:1}];let ee=default_possible_values(VAPsType.boolean,t);test.skip(ee.length,1,"If boolean and given more than one value possibility, it should be reduced back to 1"),ee=default_possible_values(VAPsType.boolean,[]),test(ee.length,2,"If boolean and no value possibilities, it should create 2"),ee=default_possible_values(VAPsType.action,[]),test(ee.length,action_statuses.length,"If action and no value possibilities, it should create the set"),ee=default_possible_values(VAPsType.other,[]),test(ee.length,1,"If other and no value possibilities, it should create an empty value"),ee=default_possible_values(VAPsType.number,[]),test(ee.length,1,"If other and no value possibilities, it should create an empty value")});function get_possibilities_from_VAP_sets(t,ee,te){const ne=get_simple_possibilities_from_VAP_sets(t,ee,te);return ensure_possible_values_have_ids(ne)}function get_simple_possibilities_from_VAP_sets(t,ee,te){const ne=Object.values(ee||{}).map(ie=>({...ie,id:void 0,value_id:ie.id}));te.forEach(ie=>{ie.entries.forEach(({value_id:_e,value:se})=>{ne.push({value_id:_e,value:se})})});const oe=get_simple_possibilities_from_values(ne,ee);return default_possible_values(t,oe)}function get_simple_possibilities_from_values(t,ee={}){let te=[];const ne=new Set;let oe=0;return t.forEach(({value_id:ie})=>{const _e=ee[ie||""];!_e||ne.has(_e.value)||(te.push(_e),oe=Math.max(oe,_e.order),ne.add(_e.value))}),t.forEach(({value:ie,value_id:_e})=>{ne.has(ie)||(te.push({value:ie,id:_e,order:++oe}),ne.add(ie))}),t.length===0&&(te=Object.values(ee)),te.sort((ie,_e)=>(ie.order??0)<(_e.order??0)?-1:1)}const test_get_possibilities_from_VAP_sets=describe.delay("get_possibilities_from_VAP_sets",()=>{var ie,_e,se,re,ae,ce,de;const t=VAPsType.number,ee="val_prob_id_123",te=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...prepare_new_VAP(),value_id:ee,value:"abc",description:""},{...prepare_new_VAP(),value_id:void 0,value:"duplicated",description:""},{...prepare_new_VAP(),value_id:void 0,value:"duplicated",description:""}]}];let ne=get_possibilities_from_VAP_sets(t,void 0,te);test(ne.length,2,"Should get possibilities for all unique values and remove duplicates"),test((ie=ne[0])==null?void 0:ie.value,"abc"),test.skip(((_e=ne[0])==null?void 0:_e.id)!==ee,!0,"Should set a new ID"),test((se=ne[1])==null?void 0:se.value,"duplicated"),test(((re=ne[1])==null?void 0:re.id)!==void 0,!0,"Should set a new ID if original is undefined");let oe={[ee]:{id:ee,value:"new abc",description:"",order:1}};ne=get_possibilities_from_VAP_sets(t,oe,te),test((ae=ne[0])==null?void 0:ae.value,"new abc"),test((ce=ne[0])==null?void 0:ce.id,ee,"Should reuse existing ID"),test((de=ne[1])==null?void 0:de.order,2,"Should increment off maximum order")}),ONE_MINUTE=60*1e3;function create_wcomponent(t){const ee=t.store||get_store(),te=ee.getState(),ne=te.creation_context;let oe=prepare_new_wcomponent_object(t.wcomponent,ne);oe=set_judgement_or_objective_target(oe,te),oe=set_parent_goal_or_action_ids(oe,te),oe=set_state_value_fields(oe,te);const ie=get_knowledge_view_entry(t.add_to_knowledge_view,oe,te),_e=!wcomponent_is_judgement_or_objective(oe);let se=get_created_at_ms(oe);se=Math.max(se+ONE_MINUTE,te.routing.args.created_at_ms);const re=get_latest_sim_ms_for_routing(oe,te);return ee.dispatch(ACTIONS.specialised_object.upsert_wcomponent({wcomponent:oe,add_to_knowledge_view:ie,add_to_top:_e})),ee.dispatch(ACTIONS.meta_wcomponents.clear_selected_wcomponents({})),ee.dispatch(ACTIONS.routing.change_route({route:"wcomponents",item_id:oe.id,args:{created_at_ms:se,sim_ms:re}})),!0}function set_judgement_or_objective_target(t,ee){if(wcomponent_is_judgement_or_objective(t)){const te=ee.meta_wcomponents.selected_wcomponent_ids_list,ne=te[0];if(te.length===1&&ne){const oe=get_wcomponent_from_state(ee,ne);oe&&(t={...t,judgement_target_wcomponent_id:oe.id})}}return t}function set_parent_goal_or_action_ids(t,ee){if(!wcomponent_is_action(t)||t.parent_goal_or_action_ids)return t;const te=get_current_composed_knowledge_view_from_state(ee),{wcomponents_by_id:ne,knowledge_views_by_id:oe}=ee.specialised_objects,ie=te==null?void 0:te.id,_e=get_default_parent_goal_or_action_ids(ie,oe,ne);return{...t,parent_goal_or_action_ids:_e}}function get_knowledge_view_entry(t,ee,te){const ne=get_current_composed_knowledge_view_from_state(te);if(!t&&ne){let oe;wcomponent_is_judgement_or_objective(ee)?oe=ee.judgement_target_wcomponent_id:wcomponent_is_state_value(ee)&&(oe=ee.attribute_wcomponent_id);let ie=ne.composed_wc_id_map[oe||""];ie||(ie=get_middle_of_screen(te)),t={id:ne.id,position:ie}}return t}function set_state_value_fields(t,ee){if(wcomponent_is_state_value(t)){const{wcomponents_by_id:te}=ee.specialised_objects;let{attribute_wcomponent_id:ne,value_possibilities:oe}=t;const ie=ee.meta_wcomponents.selected_wcomponent_ids_list,_e=ie[0];if(ie.length===1&&_e){const se=get_wcomponent_from_state(ee,_e);if(se&&wcomponent_is_statev2(se)){const re=se;if(ne=se.id,!oe||!Object.keys(oe)){const ae=get_wcomponent_VAPs_represent(re,te),ce=get_possibilities_from_VAP_sets(ae,re.value_possibilities,re.values_and_prediction_sets||[]);oe=get_items_by_id(ce,"attribute's possible_values")}}}t={...t,attribute_wcomponent_id:ne,value_possibilities:oe}}return t}function create_links_on_connection_terminal_mouse_events__subscriber(t){return()=>{const ee=t.getState(),{last_pointer_down_connection_terminal:te}=ee.meta_wcomponents;if(!te)return;const ne=selector_chosen_base_id(ee);if(ne===void 0)return;if(ee.global_keys.last_key==="Escape"||ee.display_options.consumption_formatting){t.dispatch(ACTIONS.meta_wcomponents.clear_pointerupdown_on_connection_terminal({}));return}if(!ee.last_action)return;let oe=!1;const{terminal_type:ie,wcomponent_id:_e}=te,se=(ie==null?void 0:ie.attribute)||"state";let re=ie==null?void 0:ie.side,ae,ce="state",de=((ie==null?void 0:ie.side)||"right")==="right"?"left":"right";if(is_pointerup_on_component(ee.last_action))ae=ee.last_action.wcomponent_id,oe=_e===ae&&(ie==null?void 0:ie.side)===void 0;else if(is_pointerup_on_connection_terminal(ee.last_action))ae=ee.last_action.wcomponent_id,ce=ee.last_action.terminal_type.attribute,de=ee.last_action.terminal_type.side;else return;if(oe=oe||_e===ae&&re===de,t.dispatch(ACTIONS.meta_wcomponents.clear_pointerupdown_on_connection_terminal({})),oe)return;re=de==="right"?"left":"right";const ue=re==="right";create_wcomponent({wcomponent:{base_id:ne,type:se==="meta"||ce==="meta"?"relation_link":"causal_link",from_id:ue?_e:ae,to_id:ue?ae:_e,from_type:ue?se:ce,to_type:ue?ce:se}})}}function clear_last_pointer_down_connection_terminal(t){function ee(){const te=t.getState(),{last_pointer_down_connection_terminal:ne}=te.meta_wcomponents;ne&&t.dispatch(ACTIONS.meta_wcomponents.clear_pointerupdown_on_connection_terminal({}))}pub_sub.canvas.sub("canvas_right_click",()=>{ee()}),pub_sub.canvas.sub("canvas_pointer_down",()=>{ee()}),pub_sub.canvas.sub("canvas_pointer_up",()=>{ee()})}function create_wcomponent_on_double_tap(t){pub_sub.canvas.sub("canvas_double_tap",ee=>{const te=t.getState(),ne=get_current_knowledge_view_from_state(te);if(!ne){console.error("No current_knowledge_view despite canvas double_tap");return}const oe=selector_chosen_base_id(te);if(oe===void 0){console.error("No base_id despite canvas double_tap");return}if(te.display_options.consumption_formatting||te.routing.args.view!=="knowledge")return;const ie=position_from_canvas_pointer_event(ee),_e={id:ne.id,position:ie};create_wcomponent({wcomponent:{base_id:oe,type:"statev2"},add_to_knowledge_view:_e,store:t})})}function position_from_canvas_pointer_event(t){const ee=offset_input_by_half_node(position_to_point(t));return round_canvas_point(ee,"large")}function cancel_selected_wcomponents_on_right_click(t){pub_sub.canvas.sub("canvas_right_click",ee=>{t.dispatch(ACTIONS.meta_wcomponents.clear_selected_wcomponents({}));const{route:te,item_id:ne,sub_route:oe}=t.getState().routing;(te==="wcomponents"&&ne||oe==="wcomponents_edit_multiple")&&t.dispatch(ACTIONS.routing.change_route({route:"wcomponents",sub_route:null,item_id:null}))})}function specialised_objects_subscribers(t){pub_sub_subscribers(t);const ee=create_links_on_connection_terminal_mouse_events__subscriber(t);return()=>{ee()}}function pub_sub_subscribers(t){cancel_selected_wcomponents_on_right_click(t),create_wcomponent_on_double_tap(t),clear_last_pointer_down_connection_terminal(t)}function get_derived_starting_state(){return{composed_wcomponents_by_id:{},wcomponent_ids_by_type:get_empty_wcomponent_ids_by_type(),knowledge_views:[],nested_knowledge_view_ids:{top_ids:[],map:{}},judgement_or_objective_ids_by_target_id:{},judgement_or_objective_ids_by_goal_or_action_id:{},current_composed_knowledge_view:void 0}}function get_global_keys_starting_state(){return{last_key:void 0,last_key_time_stamp:void 0,keys_down:new Set,derived:{shift_down:!1,control_down:!1,shift_or_control_down:!1}}}function view_priorities_starting_state(){return{action_ids_to_show:[],date_shown:void 0}}function get_meta_wcomponents_starting_state(){return{selected_wcomponent_ids_list:[],selected_wcomponent_ids_set:new Set,selected_wcomponent_ids_to_ordinal_position_map:{},highlighted_wcomponent_ids:new Set,neighbour_ids_of_highlighted_wcomponent:new Set,last_clicked_wcomponent_id:void 0,last_pointer_down_connection_terminal:void 0,wcomponent_ids_to_move_set:new Set,frame_is_resizing:!1,find_all_causal_paths_from_wcomponent_ids:[],find_all_causal_paths_to_wcomponent_ids:[]}}function get_specialised_objects_starting_state(){return{wcomponents_by_id:{},knowledge_views_by_id:{}}}function get_starting_state$1(t){const ee=get_routing_starting_state(),{storage_location:te}=ee.args,ne=user_info_starting_state({load_state_from_storage:t,storage_location:te});return{controls:controls_starting_state({storage_location:te}),creation_context:creation_context_starting_state(),filter_context:filter_context_starting_state(),specialised_objects:get_specialised_objects_starting_state(),last_action:void 0,display_options:display_options_starting_state(),sync:sync_starting_state(),routing:ee,global_keys:get_global_keys_starting_state(),meta_wcomponents:get_meta_wcomponents_starting_state(),search:search_starting_state(),user_info:ne,view_priorities:view_priorities_starting_state(),derived:get_derived_starting_state()}}function parse_specialised_objects_fromto_server(t){const ee=new Set(["wcomponents","knowledge_views"]);let te=[],ne=[];if(t){delete t.wcomponent_ids_to_delete;const _e=Object.keys(t).filter(ae=>!ee.has(ae));if(_e.length)throw new Error(`Unexpected keys "${_e.join(", ")}" in specialised objects state`);const se=Array.from(ee).filter(ae=>!t.hasOwnProperty(ae));if(se.length)throw new Error(`Expected keys "${se.join(", ")}" missing in specialised objects state`);te=t.wcomponents.map(parse_wcomponent);const re=new Set(te.map(({id:ae})=>ae));ne=t.knowledge_views.map(ae=>parse_knowledge_view(ae,re,!0))}return{wcomponents:te,knowledge_views:ne}}function parse_specialised_objects_from_server_data(t){try{return parse_specialised_objects_fromto_server(t)}catch(ee){throw console.error("Error parsing specialised objects state from server"),ee}}async function supabase_load_data(t,ee){if(!t)return Promise.resolve(local_data);const te=get_supabase(),ne=await supabase_get_knowledge_views({supabase:te,base_id:ee});if(ne.error)return Promise.reject(ne.error);const oe=await supabase_get_wcomponents({supabase:te,base_id:ee});if(oe.error)return Promise.reject(oe.error);const ie=await supabase_get_wcomponents_from_other_bases({supabase:te,base_id:ee,knowledge_views:ne.value,wcomponents:oe.value});if(ie.error)return Promise.reject(ie.error);const _e=await supabase_get_knowledge_views_from_other_bases({supabase:te,knowledge_views:ne.value,wcomponents_from_other_bases:ie.wcomponents});if(_e.error)return Promise.reject(_e.error);const se=[...oe.value,...ie.wcomponents],re=[...ne.value,..._e.value];return Promise.resolve({knowledge_views:re,wcomponents:se})}function calculate_spatial_temporal_position_to_move_to(t){const{current_composed_knowledge_view:ee,wcomponents_by_id:te,initial_wcomponent_id:ne,disable_if_not_present:oe,display_side_panel:ie,display_time_sliders:_e}=t;let{created_at_ms:se,selected_wcomponent_ids_set:re}=t,ae,ce=[];if(ee){const{composed_wc_id_map:de,composed_visible_wc_id_map:ue,wc_ids_by_type:le}=ee,pe=te[ne];ae=pe&&get_created_at_ms(pe);const{any_node:me}=le;re=new Set(re),re.delete(ne);const fe=get_wcomponent_group_positions_and_last_created_at({initial_wcomponent:pe,disable_if_not_present:oe,composed_visible_wc_id_map:ue,selected_wcomponent_ids_set:re,wcomponents_by_id:te,composed_wc_id_map:de,display_side_panel:ie,display_time_sliders:_e,any_node:me});ce=fe.positions,fe.wcomponent_created_at_ms&&(ae=Math.max(fe.wcomponent_created_at_ms,ae||0)),ae&&(se=Math.max(se,ae))}return{positions:ce,go_to_datetime_ms:se}}function calculate_all_display_combinations_of_spatial_temporal_position_to_move_to(t){const{current_composed_knowledge_view:ee,wcomponents_by_id:te,initial_wcomponent_id:ne,selected_wcomponent_ids_set:oe,created_at_ms:ie,disable_if_not_present:_e}=t,se={current_composed_knowledge_view:ee,wcomponents_by_id:te,initial_wcomponent_id:ne,selected_wcomponent_ids_set:oe,created_at_ms:ie,disable_if_not_present:_e},{positions:re,go_to_datetime_ms:ae}=calculate_spatial_temporal_position_to_move_to({...se,display_side_panel:!1,display_time_sliders:!1}),ce=calculate_spatial_temporal_position_to_move_to({...se,display_side_panel:!0,display_time_sliders:!1}).positions,de=calculate_spatial_temporal_position_to_move_to({...se,display_side_panel:!1,display_time_sliders:!0}).positions,ue=calculate_spatial_temporal_position_to_move_to({...se,display_side_panel:!0,display_time_sliders:!0}).positions;return{positions_no_sidepanel_or_timesliders:re,positions_sidepanel_no_timesliders:ce,positions_timesliders_no_sidepanel:de,positions_with_sidepanel_or_timesliders:ue,go_to_datetime_ms:ae}}function get_wcomponent_group_positions_and_last_created_at(t){const{initial_wcomponent:ee,disable_if_not_present:te,composed_visible_wc_id_map:ne,selected_wcomponent_ids_set:oe,wcomponents_by_id:ie,composed_wc_id_map:_e,display_side_panel:se,display_time_sliders:re,any_node:ae}=t;let ce=[],de;const ue={display_side_panel:se,display_time_sliders:re},le=_e[(ee==null?void 0:ee.id)||""];if(ee&&le){const{left:pe,top:me}=offset_entry_by_half_node(le,!!ee.summary_image),fe=lefttop_to_xy({left:pe,top:me,zoom:SCALE_BY},!0,ue);ce.push(fe)}else if(!te&&ne){let pe=ids_on_map(oe,ne),me=calculate_position_groups_with_zoom(pe,ie,_e,ue);me.position_groups.length===0&&(pe=ids_on_map(ae,ne),me=calculate_position_groups_with_zoom(pe,ie,_e,ue)),de=me.wcomponent_created_at_ms,ce=me.position_groups.map(fe=>lefttop_to_xy({left:(fe.min_left+fe.max_left)/2,top:(fe.min_top+fe.max_top)/2,zoom:fe.zoom},!0,ue))}return{positions:ce,wcomponent_created_at_ms:de}}function calculate_position_groups_with_zoom(t,ee,te,ne){const oe=[];let ie;const _e=Array.from(t);for(let se=0;se<_e.length;++se){const re=_e[se];if(!re)continue;const ae=ee[re],ce=te[re];if(!ae||!ce)continue;const de=ce.s??1,ue=node_height_approx(!!ae.summary_image),le=ce.left-NODE_WIDTH,pe=ce.left+NODE_WIDTH*de+NODE_WIDTH,me=ce.top-ue,fe=ce.top+ue*de;if(!oe.find(he=>{const be={min_left:Math.min(he.min_left,le),max_left:Math.max(he.max_left,pe),min_top:Math.min(he.min_top,me),max_top:Math.max(he.max_top,fe)},{zoom:ve,fits:we}=calculate_zoom_to_contain_group(be,ne);return we?(he.min_left=be.min_left,he.max_left=be.max_left,he.min_top=be.min_top,he.max_top=be.max_top,he.zoom=ve,!0):!1})){if(oe.length>10)break;const he={min_left:le,max_left:pe,min_top:me,max_top:fe,zoom:SCALE_BY};oe.push(he)}ie=get_created_at_ms(ae)}return{position_groups:oe,wcomponent_created_at_ms:ie}}function calculate_zoom_to_contain_group(t,ee){const te=t.max_left-t.min_left,ne=t.max_top-t.min_top,oe=get_screen_width(ee.display_side_panel)/te*SCALE_BY,ie=get_visible_screen_height(ee.display_time_sliders)/ne*SCALE_BY,_e=Math.min(oe,ie),se=bound_zoom(Math.min(SCALE_BY,_e));return{zoom:se,fits:_e>=se}}function ids_on_map(t,ee){const te=new Set(t);return t.forEach(ne=>{ee[ne]||te.delete(ne)}),te}function get_actually_display_time_sliders(t){return t.controls.display_time_sliders}function ensure_any_knowledge_view_displayed(t){const ee=t.getState();if(!current_knowledge_view_is_valid(ee)){const te=selector_chosen_base(ee),ne=ee.specialised_objects.knowledge_views_by_id[(te==null?void 0:te.default_knowledge_view_id)||""],oe=ee.derived.knowledge_views[0],ie=ne||oe,_e=ee.controls.display_side_panel,se=get_actually_display_time_sliders(ee);if(!ie)return;const re=optionally_calculate_spatial_temporal_position_to_move_to(ee,ie,_e,se),ae={subview_id:ie.id,...re};t.dispatch(ACTIONS.routing.change_route({args:ae}))}}function current_knowledge_view_is_valid(t){const{subview_id:ee}=t.routing.args;return!!t.specialised_objects.knowledge_views_by_id[ee]}function optionally_calculate_spatial_temporal_position_to_move_to(t,ee,te,ne){let oe=update_current_composed_knowledge_view_state(t,ee);oe=update_composed_knowledge_view_filters(t,oe);const{wcomponents_by_id:ie}=t.specialised_objects,_e=t.routing.item_id||"",{created_at_ms:se}=t.routing.args,{selected_wcomponent_ids_set:re}=t.meta_wcomponents,ae=calculate_spatial_temporal_position_to_move_to({current_composed_knowledge_view:oe,wcomponents_by_id:ie,initial_wcomponent_id:_e,selected_wcomponent_ids_set:re,created_at_ms:se,disable_if_not_present:!1,display_side_panel:te,display_time_sliders:ne});return{x:0,y:0,z:0,...ae.positions[0],created_at_ms:ae.go_to_datetime_ms}}function ensure_a_knowledge_view_is_in_existence(t){const ee=t.getState();if(!ee.sync.ready_for_reading||ee.derived.knowledge_views.length)return;const te=selector_chosen_base_id(ee);if(te===void 0){console.error("Can not create knowledge view without chosen_base_id");return}const ne=get_new_knowledge_view_object({title:"All",base_id:te},ee.creation_context);t.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:ne}))}function load_state(t){let ee=t.getState();const{dispatch:te}=t,{chosen_base_id:ne}=ee.user_info;ne!==ee.sync.specialised_objects.loading_base_id&&(t.dispatch(ACTIONS.specialised_object.clear_from_mem_all_specialised_objects()),ne!==void 0&&(te(ACTIONS.sync.update_sync_status({status:"LOADING",data_type:"specialised_objects",loading_base_id:ne})),supabase_load_data(t.load_state_from_storage,ne).then(oe=>parse_specialised_objects_from_server_data(oe)).then(oe=>{te(ACTIONS.specialised_object.replace_all_specialised_objects({specialised_objects:oe})),te(ACTIONS.sync.update_sync_status({status:"LOADED",data_type:"specialised_objects"})),ensure_a_knowledge_view_is_in_existence(t),ensure_any_knowledge_view_displayed(t)}).catch(oe=>{const ie=error_to_string(oe);console.error(oe),te(ACTIONS.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:ie}))})))}function sync_subscribers(t){pub_sub.user.sub("changed_bases",()=>{const{ready_for_reading:oe}=t.getState().sync;oe||load_state(t)}),pub_sub.user.sub("changed_chosen_base_id",()=>load_state(t));const ee=t.getState(),{user:te,chosen_base_id:ne}=ee.user_info;te&&ne!==void 0&&load_state(t),subscribe_search_for_requested_wcomponents_in_any_base(t)}function subscribe_search_for_requested_wcomponents_in_any_base(t){const ee=get_supabase(),te=min_throttle(async()=>{const ne=t.getState();if(!ne.sync.wcomponent_ids_to_search_for_in_any_base.size)return;const oe=Array.from(ne.sync.wcomponent_ids_to_search_for_in_any_base);t.dispatch(ACTIONS.sync.searching_for_wcomponents_by_id_in_any_base());const ie=await supabase_get_wcomponents_from_any_base({supabase:ee,ids:oe});t.dispatch(ACTIONS.sync.searched_for_wcomponents_by_id_in_any_base({ids:oe})),t.dispatch(ACTIONS.specialised_object.add_wcomponents_to_store({wcomponents:ie.wcomponents}))},50);t.subscribe(async()=>{const ne=t.getState();ne.sync.ready_for_reading&&ne.sync.wcomponent_ids_to_search_for_in_any_base.size&&te.throttled()}),pub_sub.user.sub("changed_chosen_base_id",()=>{te.cancel()})}function conditionally_warn_unsaved_exit(t,ee){if(t&&needs_save(ee))return!0}function setup_warning_of_unsaved_data_beforeunload(t,ee){let te=performance.now();const ne=30*1e3;window.onbeforeunload=()=>{const oe=ee.getState();let ie=conditionally_warn_unsaved_exit(t,oe);return ie&&(ie=performance.now()-te>ne),ie&&(te=performance.now()),ie}}async function get_all_bases(t){const te=await get_supabase().from("bases").select("*, access_controls(access_level,user_id)").order("inserted_at",{ascending:!0}),ne=te.data?te.data.map(oe=>base_supabase_to_app(oe,oe.access_controls,t)):void 0;return{error:te.error,data:ne}}async function create_a_base(t){const{owner_user_id:ee,title:te="Primary"}=t,oe=await get_supabase().from("bases").insert({owner_user_id:ee,title:te});return{base:oe.data&&oe.data[0]||void 0,error:oe.error}}function santise_base(t){return{id:t.id,inserted_at:t.inserted_at,updated_at:t.updated_at,owner_user_id:t.owner_user_id,public_read:t.public_read,title:t.title,default_knowledge_view_id:t.default_knowledge_view_id}}function base_supabase_to_app(t,ee,te){let{inserted_at:ne,updated_at:oe,owner_user_id:ie,public_read:_e}=t;ne=new Date(ne),oe=new Date(oe);const se=ee==null?void 0:ee.find(ce=>ce.user_id===te),re=(se==null?void 0:se.access_level)||(te===ie?"owner":_e?"viewer":"none"),ae=re==="owner"||re==="editor";return{...santise_base(t),inserted_at:ne,updated_at:oe,access_level:re,can_edit:ae}}async function modify_base(t){const ee=santise_base(t);return await get_supabase().from("bases").update(ee).eq("id",ee.id)}async function refresh_bases_for_current_user(t,ee=!1){t||(t=get_store()),ee&&t.dispatch(ACTIONS.user_info.update_bases({bases:void 0}));const{user:te}=t.getState().user_info;t.dispatch(ACTIONS.sync.update_sync_status({status:"LOADING",data_type:"bases"}));const{data:ne,error:oe}=await get_all_bases(te==null?void 0:te.id);t.dispatch(ACTIONS.user_info.update_bases({bases:ne}));const ie=oe?"FAILED":"LOADED";return t.dispatch(ACTIONS.sync.update_sync_status({status:ie,data_type:"bases"})),{error:oe||void 0}}function user_info_subscribers(t){if(!t.load_state_from_storage)return;const ee=t.getState(),{users_by_id:te,bases_by_id:ne}=ee.user_info;te||get_users(t),ne||refresh_bases_for_current_user(t),pub_sub.user.sub("changed_user",()=>{var ie;(ie=selector_chosen_base(t.getState()))!=null&&ie.public_read||t.dispatch(ACTIONS.specialised_object.clear_from_mem_all_specialised_objects()),pub_sub.user.pub("stale_users_by_id",!0),pub_sub.user.pub("stale_bases",!0)}),pub_sub.user.sub("stale_users_by_id",ie=>{ie&&t.dispatch(ACTIONS.user_info.set_users({users:void 0})),get_users(t)}),pub_sub.user.sub("stale_bases",ie=>{refresh_bases_for_current_user(t,ie)});const oe=get_supabase();oe.auth.onAuthStateChange(()=>{const ie=t.getState().user_info.user,_e=oe.auth.user()||void 0;(ie==null?void 0:ie.id)!==(_e==null?void 0:_e.id)&&t.dispatch(ACTIONS.user_info.set_user({user:_e}))})}async function get_users(t){const ee=get_supabase(),{data:te,error:ne}=await ee.from("users").select("*");te&&t.dispatch(ACTIONS.user_info.set_users({users:te}))}let cached_store$1;function get_store(t={}){const{use_cache:ee=!0,override_preloaded_state:te={},load_state_from_storage:ne=!1}=t;if(cached_store$1&&ee)return cached_store$1;const oe={...get_starting_state$1(ne),...te},ie=createStore(root_reducer$1,oe);ie.load_state_from_storage=ne,cached_store$1=ie;const _e=()=>{const se=ie.getState();persist_relevant_state(se),conditionally_save_state(ie)};return ie.subscribe(_e),setup_warning_of_unsaved_data_beforeunload(ne,ie),ie.subscribe(factory_location_hash(ie)),ie.subscribe(specialised_objects_subscribers(ie)),controls_subscribers(ie),display_options_subscribers(ie),meta_wcomponents_selecting_subscribers(ie),periodically_change_display_at_created_datetime(ie),record_keyupdown_activity(ie),routing_subscribers.sync_storage_location_subscriber(ie),user_info_subscribers(ie),sync_subscribers(ie),register_window_focus_session_check(ie),register_window_title_updater_subscriber(ie),ie}function JudgementBadge(t){const{judgement:ee,judgement_trend_manual:te,size:ne}=t,ie=`judgement_badge ${ne} ${ee?"positive":ee===void 0?"inactive":"negative"} ${te??""}`,_e=te==="improving"?o$1(default_1$x,{}):te==="stable"?o$1(default_1$w,{}):te==="worsening"?o$1(default_1$v,{}):te==="unknown"?o$1(QuestionMarkIcon,{}):o$1("span",{});if(!t.judgement_or_objective_id)return o$1("div",{className:ie,children:_e});let se;return t.position&&(se=lefttop_to_xy({...t.position,zoom:100},!0)),o$1(Link,{route:void 0,sub_route:void 0,item_id:t.judgement_or_objective_id,args:se,extra_class_name:ie,on_pointer_down:()=>{const re=get_store(),ae=re.getState(),{display_side_panel:ce,display_time_sliders:de}=ae.controls;return t.position&&(se=lefttop_to_xy({...t.position,zoom:100},!0,{display_side_panel:ce,display_time_sliders:de})),re.dispatch(ACTIONS.routing.change_route({item_id:t.judgement_or_objective_id,args:se})),!0},children:_e})}const map_state$1U=(t,ee)=>{let te=get_wcomponent_from_state(t,ee.judgement_or_objective_id);wcomponent_is_judgement_or_objective(te)||(te=void 0);let ne,oe;if(te){const se=te.judgement_target_wcomponent_id;ne=get_wcomponent_from_state(t,se),oe=get_VAP_set_id_to_counterfactual_v2_map(t,se)}const ie=get_current_composed_knowledge_view_from_state(t),_e=ie==null?void 0:ie.composed_wc_id_map[ee.judgement_or_objective_id];return{judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,position:_e}},connector$1W=connect(map_state$1U);function _JudgementBadgeConnected(t){const{judgement_or_objective_id:ee,judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:_e,position:se}=t;if(!te||!ne)return null;const re=calculate_judgement_value({judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:_e});return o$1(JudgementBadge,{judgement:re,judgement_trend_manual:t.hide_judgement_trend?void 0:te.judgement_trend_manual,judgement_or_objective_id:ee,position:se,size:t.hide_judgement_trend?"small":"medium"})}const JudgementBadgeConnected=connector$1W(_JudgementBadgeConnected),map_state$1T=(t,ee)=>{let te=get_wcomponent_from_state(t,ee.judgement_or_objective_id);wcomponent_is_judgement_or_objective(te)||(te=void 0);const ne=get_current_composed_knowledge_view_from_state(t),oe=ne?ne.composed_wc_id_map[ee.judgement_or_objective_id]:void 0;return{judgement_wcomponent:te,position:oe}},connector$1V=connect(map_state$1T);function _JudgementBadgeSimple(t){const{judgement_or_objective_id:ee,judgement_wcomponent:te,position:ne,target_VAPs_represent:oe,value:ie}=t;if(!te)return null;const _e=core_calculate_judgement_value({judgement_wcomponent:te,target_VAPs_represent:oe,value:ie});return o$1(JudgementBadge,{judgement:_e,judgement_trend_manual:t.hide_judgement_trend?void 0:te.judgement_trend_manual,judgement_or_objective_id:ee,position:ne,size:t.hide_judgement_trend?"small":"medium"})}const JudgementBadgeSimple=connector$1V(_JudgementBadgeSimple),map_state$1S=t=>{const ee=get_current_composed_knowledge_view_from_state(t);return{active_judgement_or_objective_ids_by_target_id:ee==null?void 0:ee.active_judgement_or_objective_ids_by_target_id,active_judgement_or_objective_ids_by_goal_or_action_id:ee==null?void 0:ee.active_judgement_or_objective_ids_by_goal_or_action_id}},connector$1U=connect(map_state$1S);function _WComponentJudgements(t){const{active_judgement_or_objective_ids_by_target_id:ee,active_judgement_or_objective_ids_by_goal_or_action_id:te,target_VAPs_represent:ne,value:oe}=t,ie=F$1(()=>[...(ee||{})[t.wcomponent.id]||[],...(te||{})[t.wcomponent.id]||[]],[ee,te]),_e="node_judgements_container ";return oe===void 0||ne===void 0?o$1("div",{className:_e,children:ie.map(se=>o$1(JudgementBadgeConnected,{judgement_or_objective_id:se,hide_judgement_trend:t.hide_judgement_trend}))}):o$1("div",{className:_e,children:ie.map(se=>o$1(JudgementBadgeSimple,{judgement_or_objective_id:se,hide_judgement_trend:t.hide_judgement_trend,target_VAPs_represent:ne,value:oe}))})}const WComponentJudgements=connector$1U(_WComponentJudgements);function get_VAP_id_to_counterfactuals_info_map(t){const{VAP_set:ee,VAP_set_id_to_counterfactual_v2_map:te,knowledge_views_by_id:ne}=t,oe=(te==null?void 0:te[ee.id])||[],ie={};return oe.forEach(_e=>{const{target_VAP_id:se}=_e;if(!se)return;const re=wcomponent_has_knowledge_view(_e.id,ne),ae={counterfactual_v2_id:_e.id,counterfactual_has_knowledge_view:re},ce=ie[se]||[];ce.push(ae),ie[se]=ce}),ie}const ValueAndPredictionSetSummary$1="";var ArrowUpward={},_interopRequireDefault$u=interopRequireDefaultExports;Object.defineProperty(ArrowUpward,"__esModule",{value:!0});var default_1$u=ArrowUpward.default=void 0,_createSvgIcon$u=_interopRequireDefault$u(requireCreateSvgIcon()),_jsxRuntime$u=requireJsxRuntime(),_default$u=(0,_createSvgIcon$u.default)((0,_jsxRuntime$u.jsx)("path",{d:"m4 12 1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"}),"ArrowUpward");default_1$u=ArrowUpward.default=_default$u;var Search={},_interopRequireDefault$t=interopRequireDefaultExports;Object.defineProperty(Search,"__esModule",{value:!0});var default_1$t=Search.default=void 0,_createSvgIcon$t=_interopRequireDefault$t(requireCreateSvgIcon()),_jsxRuntime$t=requireJsxRuntime(),_default$t=(0,_createSvgIcon$t.default)((0,_jsxRuntime$t.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"}),"Search");default_1$t=Search.default=_default$t;const Handles$1="",d$8="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z";function AddSearchIcon(t){return o$1(CommonIcon,{...t,d:d$8,svg_elements:[o$1("line",{x1:"0",x2:"13",y1:"18",y2:"18",stroke:"white","stroke-width":"6"}),o$1("line",{x1:"6.5",x2:"6.5",y1:"11.5",y2:"24",stroke:"white","stroke-width":"6"}),o$1("line",{x1:"1.5",x2:"11.5",y1:"18",y2:"18","stroke-width":"3"}),o$1("line",{x1:"6.5",x2:"6.5",y1:"13",y2:"23","stroke-width":"3"})]})}const map_state$1R=(t,ee)=>{const te=get_wcomponent_from_state(t,ee.wcomponent_id),oe=(get_overlapping_wcomponent_ids(t,ee.wcomponent_id)||[]).find(ie=>t.specialised_objects.knowledge_views_by_id[ie]);return{wcomponent:te,kvwc:t.specialised_objects.knowledge_views_by_id[ee.wcomponent_id],subview_id:t.routing.args.subview_id,nested_knowledge_view_ids_entry:t.derived.nested_knowledge_view_ids.map[ee.wcomponent_id],presenting:t.display_options.consumption_formatting,any_overlapping_wcomponents_have_kvs:oe}},connector$1T=connect(map_state$1R);function _ExploreButtonHandle(t){let{kvwc:ee}=t;const{is_highlighted:te,nested_knowledge_view_ids_entry:ne,any_overlapping_wcomponents_have_kvs:oe}=t,ie=!t.presenting,_e=!ee&&(t.presenting||ie&&!te&&!oe),se=t.subview_id===t.wcomponent_id,re=ne&&ne.parent_id,ae=ie&&!!t.wcomponent,ce=se?re?2:-1:ee?1:ae?3:-2,de=se&&!re,ue="node_handle explore "+(_e?" hidden ":"")+(ee?" has_knowledge_view ":"")+(de?" current_but_no_parent ":"")+(ce===3?" will_create_on_click ":"")+(ce===-2?" error_disabled ":"");return o$1("div",{className:ue,title:ce===2?"Navigate up to parent":ce===-1?"No parent to navigate up to":ce===1?"Navigate to knowledge view":ce===3?"Create then navigate to knowledge view":ce===-2?"Error: could not find the component to create a new knowledge view for":"Unknown error",onClick:pe=>{pe.preventDefault(),pe.stopImmediatePropagation();const me=get_store();if(se)re&&navigate_to_knowledge_view_or_kvwcomponent(re,me);else{if(!ee){const fe=prepare_wcomponent_knowledge_view(t,me);if(!fe)return;ee=fe,me.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:ee}))}navigate_to_knowledge_view_or_kvwcomponent(ee.id,me)}},children:se?o$1(default_1$u,{}):ce===3?o$1(AddSearchIcon,{}):o$1(default_1$t,{})})}const ExploreButtonHandle=connector$1T(_ExploreButtonHandle);function prepare_wcomponent_knowledge_view(t,ee){if(!t.wcomponent)return!1;const te=ee.getState(),ne=get_middle_of_screen(te),oe={[t.wcomponent.id]:t.wcomponent_current_kv_entry||ne},ie=get_title$1({wcomponent:t.wcomponent,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(te),text_type:RichTextType.plain,wcomponents_by_id:te.specialised_objects.wcomponents_by_id,knowledge_views_by_id:te.specialised_objects.knowledge_views_by_id,created_at_ms:te.routing.args.created_at_ms,sim_ms:te.routing.args.sim_ms}),se=remove_rich_text(ie)||`Knowledge view for ${t.wcomponent.id} created: ${get_today_str()}`,re=get_current_composed_knowledge_view_from_state(te),ae=re&&re.id,ce={id:t.wcomponent.id,base_id:t.wcomponent.base_id,wc_id_map:oe,title:se,sort_type:ae?"normal":"hidden",parent_knowledge_view_id:ae},{creation_context:de}=te;return get_new_knowledge_view_object(ce,de)}const d$7="m9.78 11.16-1.42 1.42c-.68-.69-1.34-1.58-1.79-2.94l1.94-.49c.32.89.77 1.5 1.27 2.01zM11 6 7 2 3 6h3.02c.02.81.08 1.54.19 2.17l1.94-.49C8.08 7.2 8.03 6.63 8.02 6H11zm10 0-4-4-4 4h2.99c-.1 3.68-1.28 4.75-2.54 5.88-.5.44-1.01.92-1.45 1.55-.34-.49-.73-.88-1.13-1.24L9.46 13.6c.93.85 1.54 1.54 1.54 3.4v5h2v-5c0-2.02.71-2.66 1.79-3.63 1.38-1.24 3.08-2.78 3.2-7.37H21z";function AltRouteIcon(t){return o$1(CommonIcon,{...t,d:d$7})}const ALTERNATIVE_VALUE_COLOR="darkorange";function ValueAndPredictionEntryRow(t){const{VAP_visual:ee,show_judgements:te,counterfactual_VAP_set:ne,VAP_id_to_counterfactuals_info_map:oe}=t,ie={},_e=get_wcomponent_VAPs_represent(t.wcomponent,ie),se=ee.certainty*100,re=`${se}%`,ae=Math.round(se);let ce=100;ae<100&&(ce=ae*1.25);const de=oe[ee.VAP_id]||[],ue=ne.has_any_counterfactual_applied?"warning_color":"";return o$1("div",{className:`value_and_prediction prob-${ae} ${ue}`,style:{fontSize:`${ce}%`,maxHeight:re,minHeight:re},children:[ee.value_text,te&&o$1(WComponentJudgements,{wcomponent:t.wcomponent,target_VAPs_represent:_e,value:ee.parsed_value,hide_judgement_trend:!0}),de.map(le=>o$1(CounterfactualLink,{any_active:ne.has_any_counterfactual_applied,counterfactual:le,active_counterfactual_v2_id:ne.active_counterfactual_v2_id}))]})}function CounterfactualLink(t){const ne={fontSize:"25px",color:t.counterfactual.counterfactual_v2_id===t.active_counterfactual_v2_id?ALTERNATIVE_VALUE_COLOR:t.any_active?"white":"#ffc965",verticalAlign:"middle",fontWeight:"bold",width:"20px"};return o$1("span",{onPointerDown:oe=>oe.stopImmediatePropagation(),onClick:oe=>oe.stopImmediatePropagation(),style:{display:"inline-flex"},children:[" ",o$1(Link,{route:void 0,sub_route:void 0,item_id:t.counterfactual.counterfactual_v2_id,args:void 0,extra_css_style:ne,children:o$1(AltRouteIcon,{fontSize:"small"})}),t.counterfactual.counterfactual_has_knowledge_view&&o$1("span",{style:{fontSize:14},children:o$1(ExploreButtonHandle,{wcomponent_id:t.counterfactual.counterfactual_v2_id||"",is_highlighted:!0})})," "]})}function ValueAndPredictionSetSummary(t){const[ee,te]=h$1(!1),{counterfactual_VAP_set:ne,VAP_id_to_counterfactuals_info_map:oe}=t,ie={},_e=get_wcomponent_VAPs_represent(t.wcomponent,ie),se=convert_VAP_set_to_VAP_visuals({...t,VAP_set:ne,VAPs_represent:_e}),re=se.filter(ae=>ae.certainty>0);return o$1(Box,{height:"100%",maxWidth:"100%",minWidth:100,overflow:"hidden",position:"relative",flexDirection:"column",justifyContent:"flex-end",alignItems:"stretch",alignContent:"stretch",className:`value_and_prediction_set_summary items-${se.length} visible-${re.length}`,onPointerOver:()=>te(!0),onPointerLeave:()=>te(!1),children:se.map((ae,ce)=>{const de=ee||ce===0;return o$1(ValueAndPredictionEntryRow,{wcomponent:t.wcomponent,VAP_visual:ae,show_judgements:de,counterfactual_VAP_set:ne,VAP_id_to_counterfactuals_info_map:oe})})})}const map_state$1Q=(t,ee)=>({VAP_set_id_to_counterfactual_v2_map:get_VAP_set_id_to_counterfactual_v2_map(t,ee.wcomponent.id),knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),connector$1S=connect(map_state$1Q);function _ConnectedValueAndPredictionSetSummary(t){const{wcomponent:ee,VAP_set:te,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe}=t,ie=apply_counterfactuals_v2_to_VAP_set({VAP_set:te,VAP_set_id_to_counterfactual_v2_map:ne}),_e=get_VAP_id_to_counterfactuals_info_map({VAP_set:te,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe});return o$1(ValueAndPredictionSetSummary,{wcomponent:ee,counterfactual_VAP_set:ie,VAP_id_to_counterfactuals_info_map:_e})}const ConnectedValueAndPredictionSetSummary=connector$1S(_ConnectedValueAndPredictionSetSummary);function NodeValueAndPredictionSetSummary(t){if(!wcomponent_has_VAP_sets(t.wcomponent))return null;const ee=get_current_VAP_set({...t,values_and_prediction_sets:t.wcomponent.values_and_prediction_sets});return ee?o$1(ConnectedValueAndPredictionSetSummary,{wcomponent:t.wcomponent,VAP_set:ee}):null}const DisplayValue$1="";function DisplayValue(t){const{UI_value:ee}=t,{values_string:te,counterfactual_applied:ne,uncertain:oe,derived__using_values_from_wcomponent_ids:ie}=ee,_e=ne||!!(ie!=null&&ie.length),se=`value ${_e?"assumption":""} ${oe?"uncertain":""}`;let re="Current value";return _e&&(re+=" is an assumption"),_e&&oe&&(re+=" and"),oe&&(re+=" has uncertainty"),o$1(k$1,{children:[o$1(Tooltip,{className:se,title:re,"aria-label":re,children:o$1("span",{children:te})}),(ie||[]).map(ae=>o$1(LinkToComponent,{uuid:ae}))]})}const map_state$1P=(t,ee)=>{const{composed_wcomponents_by_id:te}=t.derived,ne=te[ee.uuid],oe=get_wc_id_to_counterfactuals_v2_map(t),ie=t.specialised_objects.knowledge_views_by_id;return{title:ne&&get_title$1({wcomponent:ne,text_type:RichTextType.plain,wcomponents_by_id:te,knowledge_views_by_id:ie,wc_id_to_counterfactuals_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms})}},connector$1R=connect(map_state$1P);function _LinkToComponent(t){const{uuid:ee,title:te}=t;let ne="a different component";te!=null&&te.trim()&&(ne=`'${remove_rich_text(te.trim())}'`);const oe="Value derived from "+ne;return o$1(Link,{route:void 0,sub_route:void 0,item_id:ee,args:void 0,children:o$1(AltRouteIcon,{className:"material-icons",title:oe,style:{fill:ALTERNATIVE_VALUE_COLOR,height:"16px"}})},ee)}const LinkToComponent=connector$1R(_LinkToComponent);function get_wcomponent_validity_UI_value(t){const{wcomponent:ee,created_at_ms:te,sim_ms:ne}=t,{is_valid:oe}=get_wcomponent_validity_value({wcomponent:ee,created_at_ms:te,sim_ms:ne})||default_wcomponent_validity_value();return{values_string:oe?"Valid":"Invalid",counterfactual_applied:void 0,uncertain:void 0,derived__using_values_from_wcomponent_ids:void 0}}const map_state$1O=t=>{const{created_at_ms:ee,sim_ms:te}=t.routing.args;return{created_at_ms:ee,sim_ms:te}},connector$1Q=connect(map_state$1O);function _WComponentValidityValue(t){const ee=get_wcomponent_validity_UI_value(t);return o$1("div",{className:"node_validity_value_container",children:o$1(DisplayValue,{UI_value:ee})})}const WComponentValidityValue=connector$1Q(_WComponentValidityValue),d$6="M14 2H4c-1.11 0-2 .9-2 2v10h2V4h10V2zm4 4H8c-1.11 0-2 .9-2 2v10h2V8h10V6zm2 4h-8c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z";function AutoAwesomeMotionIcon(t){return o$1(CommonIcon,{...t,d:d$6})}const map_state$1N=(t,ee)=>({overlapping_wcomponent_ids:get_overlapping_wcomponent_ids(t,ee.wcomponent_id)}),map_dispatch$15={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,change_route:ACTIONS.routing.change_route},connector$1P=connect(map_state$1N,map_dispatch$15);function _OverlappingNodesHandle(t){const{overlapping_wcomponent_ids:ee,set_highlighted_wcomponent:te,change_route:ne}=t,oe=(ee==null?void 0:ee.length)||0,_e="node_handle overlapping_nodes"+(oe===0?" hidden ":""),se=oe?`${oe-1} other nodes at this location`:"",re=F$1(()=>{if(ee)return ae=>{ae.stopImmediatePropagation(),te({id:t.wcomponent_id,highlighted:!1}),ne({item_id:ee[0]})}},[ne,ee]);return o$1("div",{className:_e,title:se,onClick:re,children:o$1(AutoAwesomeMotionIcon,{fontSize:"small"})})}const OverlappingNodesHandle=connector$1P(_OverlappingNodesHandle);function client_to_canvas(t,ee){return ee*(SCALE_BY/t)}function client_to_canvas_x(t,ee,te){return t+client_to_canvas(ee,te)}function client_to_canvas_y(t,ee,te){return t-client_to_canvas(ee,te)}function Handles(t){return o$1("div",{className:"handles",children:[o$1(HandleForMoving,{show_move_handle:t.show_move_handle,user_requested_node_move:t.user_requested_node_move}),o$1(ExploreButtonHandle,{wcomponent_id:t.wcomponent_id,wcomponent_current_kv_entry:t.wcomponent_current_kv_entry,is_highlighted:t.is_highlighted}),o$1(OverlappingNodesHandle,{wcomponent_id:t.wcomponent_id})]})}function HandleForMoving(t){const{show_move_handle:ee,user_requested_node_move:te}=t,ne="node_handle movement highlight_on_hover";return ee?o$1("div",{className:ne,onPointerDown:ie=>{ie.stopPropagation();const _e=canvas_pointer_event_to_position(ie);te(_e)},children:"✥"}):o$1("div",{className:ne,children:" "})}function canvas_pointer_event_to_position(t){const ee=get_store().getState(),{x:te,y:ne,zoom:oe}=ee.routing.args;return{x:client_to_canvas_x(te,oe,t.clientX),y:client_to_canvas_y(ne,oe,t.clientY)}}function convert_VAP_sets_to_visual_sub_state_value_possibilities(t){const{selector:ee,target_wcomponent:te}=t,{target_VAP_set_id:ne,target_value_id_type:oe,target_value:ie}=ee||{},_e=get_substate_target_VAP_sets(te,ne),re=get_wcomponent_VAPs_represent(te,{}),ae=[];return _e.forEach(de=>{convert_VAP_set_to_VAP_visuals({VAP_set:de,VAPs_represent:re,wcomponent:te}).forEach(({value_id:ue,value_text:le})=>ae.push({value_id:ue,value:le}))}),get_simple_possibilities_from_values(ae,te.value_possibilities).map(de=>{const ue=predicate_target_value_possibility({target_value_id_type:oe,target_value:ie,value_text:de.value,value_id:de.id});return{...de,selected:ue}})}function get_substate_target_VAP_sets(t,ee){let te=t.values_and_prediction_sets||[];return ee&&(te=te.filter(({id:ne})=>ne===ee)),te}function predicate_target_value_possibility(t){const{target_value_id_type:ee,target_value:te,value_text:ne,value_id:oe}=t;let ie;return ee==="value_string"?ie=te===ne:ee==="id"&&(ie=te===oe),ie}function ratio_to_percentage_string(t){if(t===void 0)return"";const ee=bounded(t,0,1)*100;return ee.toPrecision(ee<98?2:3).replace(/\.0$/,"")}const map_state$1M=(t,ee)=>{const{target_wcomponent_id:te}=ee.wcomponent,{wcomponents_by_id:ne}=t.specialised_objects,oe=ne[te||""],ie=wcomponent_is_allowed_to_have_state_VAP_sets(oe)&&oe,_e=get_VAP_set_id_to_counterfactual_v2_map(t,te);return{target_wcomponent:ie,wcomponents_by_id:ne,VAP_set_id_to_counterfactual_v2_map:_e,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}},connector$1O=connect(map_state$1M);function _NodeSubStateSummary(t){const{target_wcomponent:ee,wcomponents_by_id:te,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe}=t;if(!ee)return null;const{selector:ie}=t.wcomponent,{target_VAP_set_id:_e,target_value_id_type:se,target_value:re}=ie||{},ae=se!==void 0&&re!==void 0;let ce=ee.values_and_prediction_sets||[];const de=get_wcomponent_VAPs_represent(ee,te);if(_e===void 0)return ae?null:o$1(NodeValueAndPredictionSetSummary,{wcomponent:ee,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});ce=ce.filter(({id:he})=>he===_e),ce=prune_items_by_created_at_and_versions(ce,t.created_at_ms);const ue=ce[0];if(!ue)return o$1("div",{children:"Invalid configuration"});if(!ae)return o$1(ConnectedValueAndPredictionSetSummary,{wcomponent:ee,VAP_set:ue});const le=apply_counterfactuals_v2_to_VAP_set({VAP_set:ue,VAP_set_id_to_counterfactual_v2_map:ne}),pe=get_VAP_id_to_counterfactuals_info_map({VAP_set:ue,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe});let fe=convert_VAP_set_to_VAP_visuals({...t,VAP_set:le,VAPs_represent:de}).find(({value_id:he,value_text:be})=>predicate_target_value_possibility({target_value_id_type:se,target_value:re,value_id:he,value_text:be}));if(!fe)return o$1("div",{children:"Invalid configuration"});let{value_text:ge}=fe;return ge=` ${ratio_to_percentage_string(fe.certainty)}%`,fe={...fe,value_text:ge,certainty:1},o$1(ValueAndPredictionEntryRow,{wcomponent:ee,VAP_visual:fe,show_judgements:!0,counterfactual_VAP_set:le,VAP_id_to_counterfactuals_info_map:pe})}const NodeSubStateSummary=connector$1O(_NodeSubStateSummary),d$5="m14.5 14.2 2.9 1.7-.8 1.3L13 15v-5h1.5v4.2zM22 14c0 4.41-3.59 8-8 8-2.02 0-3.86-.76-5.27-2H4c-1.15 0-2-.85-2-2V9c0-1.12.89-1.96 2-2v-.5C4 4.01 6.01 2 8.5 2c2.34 0 4.24 1.79 4.46 4.08.34-.05.69-.08 1.04-.08 4.41 0 8 3.59 8 8zM6 7h5v-.74C10.88 4.99 9.8 4 8.5 4 7.12 4 6 5.12 6 6.5V7zm14 7c0-3.31-2.69-6-6-6s-6 2.69-6 6 2.69 6 6 6 6-2.69 6-6z";function LockClockIcon(t){return o$1(CommonIcon,{...t,d:d$5})}const d$4="M8 18h3v3h2v-3h3l-4-4-4 4zm8-12h-3v-3h-2v3h-3l4 4 4-4zm-12 5v2h16v-2z";function ReducedPossibilitiesIcon(t){return o$1(CommonIcon,{...t,d:d$4})}const map_state$1L=(t,ee)=>{const{target_wcomponent_id:te}=ee.wcomponent,ne=t.specialised_objects.wcomponents_by_id[te||""];return{target_wcomponent:wcomponent_is_allowed_to_have_state_VAP_sets(ne)&&ne,presenting:t.display_options.consumption_formatting}},connector$1N=connect(map_state$1L);function _NodeSubStateTypeIndicators(t){const{target_wcomponent:ee,presenting:te}=t;if(!ee||te)return null;const{selector:ne}=t.wcomponent,{target_VAP_set_id:oe,target_value_id_type:ie,target_value:_e}=ne||{},se=ee.values_and_prediction_sets||[],re=oe===void 0?0:se.find(({id:le})=>le===oe)?1:2,ae=convert_VAP_sets_to_visual_sub_state_value_possibilities({selector:ne,target_wcomponent:ee}),ce=ie===void 0||_e===void 0?0:ae.find(({selected:le})=>le)?1:2,de=sub_state_type_status_to_color(re),ue=sub_state_type_status_to_color(ce);return o$1("div",{className:"sub_state_type_indicators",children:[o$1(LockClockIcon,{className:de,title:"Specific Time "+sub_state_type_status_to_title(re),style:{height:"30px"}}),o$1(ReducedPossibilitiesIcon,{className:ue,title:"Specific Possibility "+sub_state_type_status_to_title(ce),style:{height:"30px"}})]})}const NodeSubStateTypeIndicators=connector$1N(_NodeSubStateTypeIndicators);function sub_state_type_status_to_color(t){return t===1?" sub_state_type_status__set ":t===0?" sub_state_type_status__not_set ":" sub_state_type_status__invalid "}function sub_state_type_status_to_title(t){return t===1?"Set":t===0?"Not set":"Invalid"}function start_moving_wcomponents(t,ee){const te=get_store(),ne=ACTIONS.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:t});te.dispatch(ne);let oe;const ie=pub_sub.canvas.sub("canvas_move",se=>{oe=round_canvas_point({left:se.x-ee.x,top:ee.y-se.y}),pub_sub.canvas.pub("canvas_node_drag_relative_position",oe)}),_e=pub_sub.canvas.sub("canvas_pointer_up",()=>{if(oe){const re=ACTIONS.specialised_object.bulk_edit_knowledge_view_entries({wcomponent_ids:Array.from(t),change_left:oe.left,change_top:oe.top});te.dispatch(re)}const se=ACTIONS.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:new Set});te.dispatch(se),ie(),_e()})}const WComponentCanvasNodeBackgroundFrame$1="",default_frame_color={r:175,g:175,b:175,a:.11},OFFSET_TOP=grid_small_step,OFFSET_RIGHT=grid_small_step,map_state$1K=t=>{var ee;return{is_editing:!t.display_options.consumption_formatting,frame_is_resizing:t.meta_wcomponents.frame_is_resizing,knowledge_view_id:(ee=get_current_knowledge_view_from_state(t))==null?void 0:ee.id}},map_dispatch$14={set_frame_is_resizing:ACTIONS.meta_wcomponents.set_frame_is_resizing,upsert_knowledge_view_entry:ACTIONS.specialised_object.upsert_knowledge_view_entry},connector$1M=connect(map_state$1K,map_dispatch$14);function _WComponentCanvasNodeBackgroundFrame(t){const{wcomponent_id:ee,kv_entry:te,is_editing:ne,frame_is_resizing:oe,knowledge_view_id:ie,set_frame_is_resizing:_e}=t;if((te==null?void 0:te.frame_width)===void 0||(te==null?void 0:te.frame_height)===void 0)return null;const[se,re]=h$1(void 0),[ae,ce]=h$1(void 0),de=me=>fe=>{fe.stopImmediatePropagation(),fe.preventDefault(),_e({frame_is_resizing:!0}),re(me)},ue=F$1(()=>de(!0),[]),le=F$1(()=>de(!1),[]);p$1(()=>pub_sub.canvas.sub("canvas_move",me=>{if(se===void 0)return;const fe=se?te.frame_width:round_coordinate_small_step(me.x-te.left+OFFSET_RIGHT),ge=se?round_coordinate_small_step(-me.y-te.top+OFFSET_TOP):te.frame_height;ce({...te,frame_width:fe,frame_height:ge})})),p$1(()=>pub_sub.canvas.sub("canvas_pointer_up",()=>{!oe||!ie||ae&&(t.upsert_knowledge_view_entry({wcomponent_id:ee,knowledge_view_id:ie,entry:ae}),ce(void 0),_e({frame_is_resizing:!1}),re(void 0))}));const pe=ae||te;return o$1("div",{className:"wcomponent_background_frame",style:{top:pe.top-OFFSET_TOP,left:pe.left-OFFSET_RIGHT,width:pe.frame_width,height:pe.frame_height,backgroundColor:color_to_string(pe.frame_color||default_frame_color),borderColor:color_to_string(darker_color(pe.frame_color||default_frame_color))},children:[ne&&o$1("div",{className:"editable_edge editable_edge_bottom",onPointerDown:ue}),ne&&o$1("div",{className:"editable_edge editable_edge_right",onPointerDown:le})]})}const WComponentCanvasNodeBackgroundFrame=connector$1M(_WComponentCanvasNodeBackgroundFrame),map_state$1J=(t,ee)=>{const{id:te}=ee,ne=t.global_keys.derived.shift_or_control_down,oe=is_on_current_knowledge_view(t,te),{current_composed_knowledge_view:ie}=t.derived,_e=t.derived.composed_wcomponents_by_id[te],se=_e&&ie&&_e.base_id!==ie.base_id;let re=!1;return ie&&(re=!!(ie.active_judgement_or_objective_ids_by_target_id[te]||ie.active_judgement_or_objective_ids_by_goal_or_action_id[te])),{on_current_knowledge_view:oe,current_composed_knowledge_view:ie,derived_composed_wcomponent:_e,kv_from_different_base:se,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t),composed_wcomponents_by_id:t.derived.composed_wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,is_current_item:t.routing.item_id===te,selected_wcomponent_ids_set:t.meta_wcomponents.selected_wcomponent_ids_set,is_highlighted:t.meta_wcomponents.highlighted_wcomponent_ids.has(te),shift_or_control_keys_are_down:ne,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,is_editing:!t.display_options.consumption_formatting,validity_filter:t.display_options.derived_validity_filter,certainty_formatting:t.display_options.derived_certainty_formatting,focused_mode:t.display_options.focused_mode,have_judgements:re,node_is_moving:t.meta_wcomponents.wcomponent_ids_to_move_set.has(te),display_time_marks:t.display_options.display_time_marks,connected_neighbour_is_highlighted:t.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(te)}},map_dispatch$13={clicked_wcomponent:ACTIONS.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:ACTIONS.meta_wcomponents.clear_selected_wcomponents,change_route:ACTIONS.routing.change_route,set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,pointerupdown_on_component:ACTIONS.meta_wcomponents.pointerupdown_on_component,pointerupdown_on_connection_terminal:ACTIONS.meta_wcomponents.pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move:ACTIONS.meta_wcomponents.set_wcomponent_ids_to_move,request_searching_for_wcomponents_by_id_in_any_base:ACTIONS.sync.request_searching_for_wcomponents_by_id_in_any_base},connector$1L=connect(map_state$1J,map_dispatch$13);function _WComponentCanvasNode(t){const{id:ee,is_on_canvas:te=!0,always_show:ne=!1,is_editing:oe,derived_composed_wcomponent:ie,current_composed_knowledge_view:_e,kv_from_different_base:se,wc_id_to_counterfactuals_map:re,composed_wcomponents_by_id:ae,knowledge_views_by_id:ce,is_current_item:de,selected_wcomponent_ids_set:ue,is_highlighted:le,shift_or_control_keys_are_down:pe,created_at_ms:me,sim_ms:fe,validity_filter:ge,certainty_formatting:he,clicked_wcomponent:be,clear_selected_wcomponents:ve}=t,{change_route:we,set_highlighted_wcomponent:ye}=t;if(!_e)return o$1("div",{children:"No current knowledge view"});p$1(()=>{ie||t.request_searching_for_wcomponents_by_id_in_any_base({ids:[ee]})},[!!ie]);const ke=_e.composed_wc_id_map[ee];if(!ke&&!ne)return o$1("div",{children:["Could not find knowledge view entry for id ",ee]});const Ae=ke||{left:0,top:0},[$e,Se]=h$1(void 0);p$1(()=>{if(!t.node_is_moving)return;const Me=pub_sub.canvas.sub("throttled_canvas_node_drag_relative_position",Ue=>{const qe={...Ae};qe.left+=Ue.left,qe.top+=Ue.top,Se(qe)});return()=>{Se(void 0),Me()}},[t.node_is_moving]);const{wc_ids_excluded_by_filters:Te}=_e.filters,xe=ne||!ie?{display_certainty:1}:calc_wcomponent_should_display({wcomponent:ie,kv_entry:Ae,created_at_ms:me,sim_ms:fe,validity_filter:ge,selected_wcomponent_ids_set:ue,wc_ids_excluded_by_filters:Te});if(!xe)return null;const Ie=ue.has(ee),Pe=calc_display_opacity({is_editing:oe,certainty:xe.display_certainty,is_highlighted:le,connected_neighbour_is_highlighted:t.connected_neighbour_is_highlighted,is_selected:Ie,is_current_item:de,certainty_formatting:he,focused_mode:t.focused_mode}),je=t.node_is_moving?.3:Pe,De=factory_on_click({wcomponent_id:ee,clicked_wcomponent:be,clear_selected_wcomponents:ve,shift_or_control_keys_are_down:pe,change_route:we,is_current_item:de}),We=t.node_is_moving?[]:[o$1(Handles,{show_move_handle:te&&oe&&le,user_requested_node_move:Me=>{let Ue=new Set(ue);Ue.has(ee)||(Ue=new Set([ee]),t.clicked_wcomponent({id:ee})),start_moving_wcomponents(Ue,Me)},wcomponent_id:ee,wcomponent_current_kv_entry:Ae,is_highlighted:le})],ze=ie?get_title$1({wcomponent:ie,wcomponents_by_id:ae,knowledge_views_by_id:ce,wc_id_to_counterfactuals_map:re,created_at_ms:me,sim_ms:fe}):"&lt;Not found&gt;",Le=oe,qt={transform:`scale(${Ae.s&&te?Ae.s:1})`},Vt=le?"orange":(Ie||de)&&"blue",Be=get_wcomponent_color({wcomponent:ie,wcomponents_by_id:ae,sim_ms:fe,created_at_ms:me,display_time_marks:t.display_time_marks}),Ce=` wcomponent_canvas_node  wcomponent_${ee} `+(oe?t.on_current_knowledge_view?" node_on_kv ":" node_on_foundational_kv ":"")+(t.node_is_moving?" node_is_moving ":"")+(le?" node_is_highlighted ":"")+(de?" node_is_current_item ":"")+(Ie?" node_is_selected ":"")+(ie?` node_is_type_${ie.type} `:"")+(Le?" compact_title ":"")+Be.font+Be.background;let Ee=!1,Ve=!1;ie&&(Ee=wcomponent_can_have_validity_predictions(ie)&&oe||wcomponent_has_validity_predictions(ie)&&de,Ve=oe&&wcomponent_is_allowed_to_have_state_VAP_sets(ie)||!ie.hide_state&&(wcomponent_has_legitimate_non_empty_state_VAP_sets(ie)||wcomponent_is_judgement_or_objective(ie)||wcomponent_has_objectives(ie)&&(ie.objective_ids||[]).length>0||t.have_judgements));const Fe=ie?(oe||!ie.hide_state)&&wcomponent_is_sub_state(ie)&&ie:!1,Ut=get_terminals({is_on_canvas:te,is_editing:oe,is_highlighted:le}),Ye=Me=>{Me.stopImmediatePropagation(),Me.preventDefault(),t.pointerupdown_on_component({up_down:"down",wcomponent_id:ee})},Je=Me=>{Me.stopImmediatePropagation(),Me.preventDefault(),t.pointerupdown_on_component({up_down:"up",wcomponent_id:ee})},Qt=(Me,Ue)=>t.pointerupdown_on_connection_terminal({terminal_type:Me,up_down:Ue,wcomponent_id:ee}),Wt=te?$e||Ae:void 0,en=F$1(()=>calculate_label_ids(ie),[ie]);return o$1("div",{children:[o$1(WComponentCanvasNodeBackgroundFrame,{wcomponent_id:ee,kv_entry:Wt}),o$1(ConnectableCanvasNode,{position:Wt,cover_image:ie==null?void 0:ie.summary_image,node_main_content:o$1("div",{children:[!(ie!=null&&ie.summary_image)&&o$1("div",{className:"background_image"}),o$1("div",{className:"node_title",children:[ke===void 0&&oe&&o$1("span",{children:[o$1(WarningTriangle,{message:"Missing from this knowledge view"})," "]}),se&&oe&&o$1("span",{children:[o$1(WarningTriangle,{message:"Is from a different base to this knowledge view"})," "]}),(oe||!(ie!=null&&ie.hide_title))&&o$1(Markdown,{options:{...MARKDOWN_OPTIONS,forceInline:!0},children:ze})]}),ie&&Ee&&o$1("div",{className:"node_validity_container",children:[oe&&o$1("div",{className:"description_label",children:"validity"}),o$1(WComponentValidityValue,{wcomponent:ie})]}),ie&&Ve&&o$1("div",{className:"node_state_container",children:[oe&&o$1("div",{className:"description_label",children:"state  "}),o$1(WComponentJudgements,{wcomponent:ie,hide_judgement_trend:!1}),o$1("div",{className:"value_and_prediction_summary",children:o$1(NodeValueAndPredictionSetSummary,{wcomponent:ie,created_at_ms:me,sim_ms:fe})})]}),Fe&&o$1("div",{className:"node_sub_state_container",children:o$1("div",{className:"value_and_prediction_summary",children:o$1(NodeSubStateSummary,{wcomponent:Fe,created_at_ms:me,sim_ms:fe})})}),Fe&&o$1(NodeSubStateTypeIndicators,{wcomponent:Fe}),ie&&oe&&o$1("div",{className:"description_label",children:wcomponent_type_to_text(ie.type)}),o$1("div",{style:{display:"flex"},title:ie!=null&&ie.description.trim()?"Further details are included":void 0,children:[(ie==null?void 0:ie.description.trim())&&o$1(default_1$y,{className:"description_icon",fontSize:"small",color:"disabled"}),ie&&o$1(LabelsListV2,{label_ids:en})]})]}),extra_css_class:Ce,extra_styles_for_node_main_content:qt,opacity:je,unlimited_width:!1,glow:Vt,on_click:De,on_pointer_enter:()=>ye({id:ee,highlighted:!0}),on_pointer_leave:()=>ye({id:ee,highlighted:!1}),terminals:Ut,on_pointer_down:Ye,on_pointer_up:Je,pointerupdown_on_connection_terminal:Qt,other_children:We})]})}const WComponentCanvasNode=connector$1L(_WComponentCanvasNode),no_terminals=[],terminals_with_label=[];connection_terminal_attributes.forEach(t=>{connection_terminal_sides.forEach(ee=>{const te={attribute:t,side:ee},ne=get_top_left_for_terminal_type(te),oe=te.attribute.slice(0,1).toUpperCase();terminals_with_label.push({type:te,style:ne,label:oe})})});function get_terminals(t){return!t.is_on_canvas||!t.is_editing||!t.is_highlighted?no_terminals:terminals_with_label}function get_wcomponent_color(t){let ee="",te="";const{wcomponent:ne,created_at_ms:oe,sim_ms:ie}=t;if(!ne)return{background:" node_missing ",font:te};if(wcomponent_is_action(ne)){const _e=get_wcomponent_state_value_and_probabilities({wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:oe,sim_ms:ie}),se=_e.most_probable_VAP_set_values[0];_e.any_uncertainty?ee=" past_uncertain ":se&&(se.value_id===ACTION_VALUE_POSSIBILITY_ID.action_completed||se.value_id===ACTION_VALUE_POSSIBILITY_ID.action_failed||se.value_id===ACTION_VALUE_POSSIBILITY_ID.action_rejected)&&(ee=" past_certain ",te=" color_light ")}else{const _e=get_current_temporal_value_certainty_from_wcomponent(ne.id,t.wcomponents_by_id,oe);if(_e){const{temporal_uncertainty:se,certainty:re}=_e,ae=get_uncertain_datetime(se);ae&&ae.getTime()<ie?re===1||re===void 0?(ee=" past_certain ",te=" color_light "):ee=" past_uncertain ":ae||(re===1||re===void 0)&&(ee=" past_certain ",te=" color_light ")}}return{background:ee,font:te}}function calculate_label_ids(t){if(!t)return[];const ee=[...t.label_ids||[]],te=new Set(ee);return wcomponent_is_action(t)&&t.parent_goal_or_action_ids&&t.parent_goal_or_action_ids.forEach(ne=>{te.has(ne)||(ee.push(ne),te.add(ne))}),ee}const Canvas$1="",SelectionBox$1="";function SelectionBox(t){const{canvas_start_x:ee,canvas_start_y:te,canvas_end_x:ne,canvas_end_y:oe}=t,ie={left:ee,top:-oe,width:ne-ee,height:oe-te};return o$1("div",{className:`selection_box color_${t.color}`,style:ie})}const GRAPH_CONTAINER_ID="graph_container",GRAPH_VISUALS_CONTAINER_ID="graph_visuals_container",MAX_DOUBLE_TAP_DELAY_MS=900,MAX_DOUBLE_TAP_XY_PIXEL_MOVEMENT=10,map_state$1I=t=>{const{x:ee,y:te,zoom:ne}=t.routing.args,oe=t.global_keys.keys_down.has("Shift"),ie=t.global_keys.keys_down.has("Control");return{zoom:ne,x:ee,y:te,shift_key_down:oe,control_key_down:ie}},map_dispatch$12=t=>({change_routing_args:ee=>{let te={};ee.zoom!==void 0&&(te.zoom=Math.round(bound_zoom(ee.zoom))),ee.x!==void 0&&(te.x=Math.round(ee.x)),ee.y!==void 0&&(te.y=Math.round(ee.y)),t(ACTIONS.routing.change_route({args:te}))}}),connector$1K=connect(map_state$1I,map_dispatch$12);class _Canvas extends b$1{constructor(te){super(te);Ne(this,"manual_zoom_target");Ne(this,"client_to_canvas",te=>client_to_canvas(this.props.zoom,te));Ne(this,"client_to_canvas_x",te=>client_to_canvas_x(this.props.x,this.props.zoom,te));Ne(this,"client_to_canvas_y",te=>client_to_canvas_y(this.props.y,this.props.zoom,te));Ne(this,"on_pointer_down",te=>{if(pub_sub.canvas.pub("canvas_pointer_down",!0),te.button===2)return;const oe=te.offsetX,ie=te.offsetY,_e={down:!0,area_select:this.props.shift_key_down,last_pointer_down_ms:new Date().getTime(),canvas_start_x:this.client_to_canvas_x(oe),canvas_start_y:this.client_to_canvas_y(ie),x_when_pointer_down:this.props.x,y_when_pointer_down:this.props.y,client_start_x:oe,client_start_y:ie};handle_if_double_tap({zoom:this.props.zoom,current_pointer_state:this.state.pointer_state,new_pointer_state:_e}),this.setState({pointer_state:_e,canvas_current_x:_e.canvas_start_x,canvas_current_y:_e.canvas_start_y})});Ne(this,"on_pointer_up",te=>{if(te==null||te.preventDefault(),pub_sub.canvas.pub("canvas_pointer_up",!0),this.state.pointer_state.area_select){const oe=area_selection_args(this.state),ie={start_x:oe.canvas_start_x,start_y:oe.canvas_start_y,end_x:oe.canvas_end_x,end_y:oe.canvas_end_y};pub_sub.canvas.pub("canvas_area_select",ie)}const ne={...this.state.pointer_state,down:!1,area_select:!1};this.setState({pointer_state:ne,canvas_current_x:void 0,canvas_current_y:void 0})});Ne(this,"on_pointer_leave",()=>{this.state.pointer_state.area_select||this.on_pointer_up()});Ne(this,"on_pointer_move",te=>{if(pub_sub.canvas.pub("canvas_move",{x:this.client_to_canvas_x(te.offsetX),y:this.client_to_canvas_y(te.offsetY)}),!this.state.pointer_state.down)return;const ne=te.offsetX,oe=te.offsetY;if(this.state.pointer_state.area_select){const ie=this.client_to_canvas_x(ne),_e=this.client_to_canvas_y(oe);this.setState({canvas_current_x:ie,canvas_current_y:_e})}else{const ie=this.state.pointer_state.client_start_x-ne,_e=this.state.pointer_state.client_start_y-oe,se=this.state.pointer_state.x_when_pointer_down+this.client_to_canvas(ie),re=this.state.pointer_state.y_when_pointer_down-this.client_to_canvas(_e);this.props.change_routing_args({x:se,y:re})}});Ne(this,"on_wheel",te=>{te.stopPropagation(),te.preventDefault();const ne=te.deltaY,oe=calculate_new_zoom({zoom:this.props.zoom,wheel_change:ne});if(oe===this.props.zoom)return;const ie=this.props.zoom/SCALE_BY,{pointer_x:_e,pointer_y:se}=get_pointer_position(te,this.props,ie),{offsetHeight:re,offsetWidth:ae}=te.currentTarget,ce=calculate_new_zoom_xy({old:this.props,new_zoom:oe,pointer_x:_e,pointer_y:se,client_height:re,client_width:ae});this.props.change_routing_args({zoom:oe,x:ce.x,y:ce.y}),this.manual_zoom_target=oe});Ne(this,"on_context_menu",te=>{te.stopPropagation(),te.preventDefault();const ne=this.client_to_canvas_x(te.offsetX),oe=this.client_to_canvas_y(te.offsetY);te.button===2&&pub_sub.canvas.pub("canvas_right_click",{x:ne,y:oe})});this.state={pointer_state:{down:!1,area_select:!1,last_pointer_down_ms:void 0,canvas_start_x:void 0,canvas_start_y:void 0,x_when_pointer_down:void 0,y_when_pointer_down:void 0,client_start_x:void 0,client_start_y:void 0},canvas_current_x:void 0,canvas_current_y:void 0}}render(){const{zoom:te}=this.props,ne=te/SCALE_BY,oe=-1*this.props.x*ne,ie=this.props.y*ne,_e=grid_small_step*ne,se=this.state.pointer_state.down,re=this.manual_zoom_target===te;this.manual_zoom_target=void 0;const ae=se?0:re?.1:1,ce={transition:`background-position ${ae}s, background-size ${ae}s`,backgroundPosition:`${oe}px ${ie}px`,backgroundSize:`${_e}px ${_e}px`},de={transition:`background-position ${ae}s, background-size ${ae}s`,backgroundPosition:`${oe}px ${ie}px`,backgroundSize:`${h_step*ne}px ${v_step*ne}px`},ue={transition:`transform ${ae}s`,transform:`translate(${oe}px,${ie}px)`},le={transition:`transform ${ae}s`,transformOrigin:"left top",transform:`scale(${ne})`},pe=(this.props.plain_background?"":"squared_background ")+(this.state.pointer_state.down?"graph_background_pointer_down ":"");return o$1("div",{style:{flexGrow:1},className:this.props.extra_class_names,children:o$1("div",{id:GRAPH_CONTAINER_ID,className:pe,style:ce,onPointerDown:this.on_pointer_down,onPointerMove:this.on_pointer_move,onPointerUp:this.on_pointer_up,onPointerLeave:this.on_pointer_leave,onWheel:this.on_wheel,onDragOver:me=>{me.preventDefault(),me.dataTransfer.dropEffect="move"},onContextMenu:this.on_context_menu,children:[!this.props.plain_background&&this.props.show_large_grid&&o$1("div",{className:"big_squared_background",style:de}),o$1("div",{id:GRAPH_VISUALS_CONTAINER_ID,style:ue,children:o$1("div",{style:le,children:[o$1("div",{id:"graph_lowest_elements_container",children:[o$1("svg",{style:{zIndex:0,position:"absolute",top:0,left:0},children:[blur_filter_defs,this.props.svg_children]}),this.props.children,o$1("svg",{style:{zIndex:2,position:"absolute",top:0,left:0},children:[blur_filter_defs,this.props.svg_upper_children]})]}),this.state.pointer_state.area_select&&o$1(SelectionBox,{...area_selection_args(this.state),color:this.props.control_key_down?"red":"blue"})]})}),o$1("div",{children:this.props.overlay})]})})}}const Canvas=connector$1K(_Canvas),blur_filter_defs=o$1("defs",{children:Array.from(Array(101)).map((t,ee)=>o$1("filter",{id:"blur_filter_"+ee,x:"0",y:"0",children:o$1("feGaussianBlur",{in:"SourceGraphic",stdDeviation:ee/20})}))});function handle_if_double_tap(t){const{zoom:ee,current_pointer_state:te,new_pointer_state:ne}=t;if(!te.last_pointer_down_ms||!ne.last_pointer_down_ms||ne.last_pointer_down_ms-te.last_pointer_down_ms>MAX_DOUBLE_TAP_DELAY_MS)return;const{canvas_start_x:ie,canvas_start_y:_e}=te,{canvas_start_x:se,canvas_start_y:re}=ne;if(ie===void 0||_e===void 0||se===void 0||re===void 0)return;const ae=Math.abs(ie-se),ce=Math.abs(_e-re),de=MAX_DOUBLE_TAP_XY_PIXEL_MOVEMENT/ee;ae>de||ce>de||pub_sub.canvas.pub("canvas_double_tap",{x:ie,y:_e})}function area_selection_args(t){const ee=t.pointer_state.canvas_start_x||0,te=t.pointer_state.canvas_start_y||0,ne=t.canvas_current_x||0,oe=t.canvas_current_y||0;return{canvas_start_x:Math.min(ee,ne),canvas_start_y:Math.min(te,oe),canvas_end_x:Math.max(ee,ne),canvas_end_y:Math.max(te,oe)}}function get_pointer_position(t,ee,te){let ne=t.offsetX,oe=t.offsetY,ie=t.target;if((ie==null?void 0:ie.id)!==GRAPH_CONTAINER_ID){for(;ie&&ie.id!==GRAPH_VISUALS_CONTAINER_ID;)ne+=ie.offsetLeft||0,oe+=ie.offsetTop||0,ie=ie.parentElement;ne-=ee.x,oe+=ee.y,ne*=te,oe*=te,ne=Math.round(ne),oe=Math.round(oe)}return{pointer_x:ne,pointer_y:oe}}const MainArea$1="";function get_wcomponent_time_slider_data(t){const ee=[],te=new Set,ne=[],oe=new Set;let ie=Number.POSITIVE_INFINITY,_e=Number.NEGATIVE_INFINITY;function se(ue,le){if(!ue)return;const pe=ue.getTime();le!=="sim"&&!te.has(pe)&&ee.push({datetime:ue,type:le}),le!=="created"&&!oe.has(pe)&&ne.push({datetime:ue,type:le}),ie=Math.min(ie,ue.getTime()),_e=Math.max(_e,ue.getTime())}function re(ue){se(ue.min,"sim"),se(ue.value,"sim"),se(ue.max,"sim")}t.forEach(ue=>{se(ue.custom_created_at||ue.created_at,"created"),wcomponent_has_validity_predictions(ue)&&ue.validity.forEach(({created_at:le,custom_created_at:pe,datetime:me})=>{se(pe||le,"created"),re(me)}),wcomponent_has_VAP_sets(ue)&&ue.values_and_prediction_sets.forEach(({created_at:le,custom_created_at:pe,datetime:me})=>{se(pe||le,"created"),re(me)}),wcomponent_has_event_at(ue)&&ue.event_at.forEach(({datetime:le})=>{re(le)})});const ae=new Date;ee.length===0&&se(ae,"created");const ce=ie,de=_e;return["created","sim"].forEach(ue=>{se(new Date(ce),ue),se(new Date(de),ue),se(new Date(ce-864e5),ue),se(new Date(de+864e5),ue)}),ee.sort(sort_by_datetime),ne.sort(sort_by_datetime),{created_events:ee,sim_events:ne}}function sort_by_datetime({datetime:t},{datetime:ee}){return t.getTime()<ee.getTime()?-1:1}var Tune={},_interopRequireDefault$s=interopRequireDefaultExports;Object.defineProperty(Tune,"__esModule",{value:!0});var default_1$s=Tune.default=void 0,_createSvgIcon$s=_interopRequireDefault$s(requireCreateSvgIcon()),_jsxRuntime$s=requireJsxRuntime(),_default$s=(0,_createSvgIcon$s.default)((0,_jsxRuntime$s.jsx)("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"}),"Tune");default_1$s=Tune.default=_default$s;var DoubleArrow={},_interopRequireDefault$r=interopRequireDefaultExports;Object.defineProperty(DoubleArrow,"__esModule",{value:!0});var default_1$r=DoubleArrow.default=void 0,_createSvgIcon$r=_interopRequireDefault$r(requireCreateSvgIcon()),_jsxRuntime$r=requireJsxRuntime(),_default$r=(0,_createSvgIcon$r.default)([(0,_jsxRuntime$r.jsx)("path",{d:"M15.5 5H11l5 7-5 7h4.5l5-7z"},"0"),(0,_jsxRuntime$r.jsx)("path",{d:"M8.5 5H4l5 7-5 7h4.5l5-7z"},"1")],"DoubleArrow");default_1$r=DoubleArrow.default=_default$r;const ContentControls$1="";function calculate_if_components_on_screen(t){let ee;const te=get_current_composed_knowledge_view_from_state(t);if(te){const{composed_visible_wc_id_map:ne,wc_ids_by_type:oe}=te,{x:ie,y:_e,zoom:se}=t.routing.args,re=SCALE_BY/se,ae=ie+get_screen_width(t.controls.display_side_panel)*re,ce=_e-TOP_HEADER_FUDGE*re,de=get_actually_display_time_sliders(t),ue=ce-get_visible_screen_height(de)*re;ee=!!Array.from(oe.any_node).find(le=>{const pe=ne[le];if(!pe)return!1;const{left:me,top:fe}=pe;return me>=ie&&me<=ae&&-fe<=ce&&-fe>=ue})}return ee}var FilterCenterFocus={},_interopRequireDefault$q=interopRequireDefaultExports;Object.defineProperty(FilterCenterFocus,"__esModule",{value:!0});var default_1$q=FilterCenterFocus.default=void 0,_createSvgIcon$q=_interopRequireDefault$q(requireCreateSvgIcon()),_jsxRuntime$q=requireJsxRuntime(),_default$q=(0,_createSvgIcon$q.default)((0,_jsxRuntime$q.jsx)("path",{d:"M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"}),"FilterCenterFocus");default_1$q=FilterCenterFocus.default=_default$q;function MoveToItemButton(t){const{move:ee,draw_attention:te,have_finished_drawing_attention:ne=()=>{}}=t;return p$1(()=>{if(t.enable_spacebar_move_to_shortcut)return pub_sub.global_keys.sub("key_down",oe=>{ee&&oe.key===" "&&ee()})},[t.enable_spacebar_move_to_shortcut,ee]),o$1(Box,{children:[o$1(Tooltip,{placement:"top",title:ee?"Move to component(s)":"No component(s) present",children:o$1("span",{children:o$1(IconButton,{size:"medium",onClick:ee,disabled:!ee,children:o$1(default_1$q,{})})})}),o$1("div",{className:ee&&te?"pulsating_circle":"",ref:oe=>setTimeout(()=>{oe==null||oe.classList.remove("pulsating_circle"),ne()},1e4)})]})}const map_state$1H=(t,ee)=>{const te=ee.wcomponent_id||t.routing.item_id||"";let ne;return ee.allow_drawing_attention&&(ne=calculate_if_components_on_screen(t)),{initial_wcomponent_id:te,created_at_ms:t.routing.args.created_at_ms,components_on_screen:ne,current_composed_knowledge_view:get_current_composed_knowledge_view_from_state(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,selected_wcomponent_ids_set:t.meta_wcomponents.selected_wcomponent_ids_set,display_side_panel:t.controls.display_side_panel,display_time_sliders:get_actually_display_time_sliders(t)}},map_dispatch$11={move:(t,ee)=>ACTIONS.routing.change_route({args:{created_at_ms:t,...ee}})},connector$1J=connect(map_state$1H,map_dispatch$11);function _MoveToWComponentButton(t){const{components_on_screen:ee,have_finished_drawing_attention:te,current_composed_knowledge_view:ne,wcomponents_by_id:oe,initial_wcomponent_id:ie,selected_wcomponent_ids_set:_e,created_at_ms:se,disable_if_not_present:re,display_side_panel:ae,display_time_sliders:ce}=t,{positions_no_sidepanel_or_timesliders:de,positions_sidepanel_no_timesliders:ue,positions_timesliders_no_sidepanel:le,positions_with_sidepanel_or_timesliders:pe,go_to_datetime_ms:me}=F$1(()=>calculate_all_display_combinations_of_spatial_temporal_position_to_move_to({current_composed_knowledge_view:ne,wcomponents_by_id:oe,initial_wcomponent_id:ie,selected_wcomponent_ids_set:_e,created_at_ms:se,disable_if_not_present:re}),[ne,oe,ie,_e,se,re]),fe=ae||ce?ae&&ce?pe:ae?ue:le:de;let ge=0;const he=fe.length===0?void 0:()=>{let ve=fe[ge++];ve||(ge=0,ve=fe[ge++]),t.move(me,ve)},be=t.allow_drawing_attention&&fe.length>0&&!ee;return o$1(MoveToItemButton,{move:he,draw_attention:be,have_finished_drawing_attention:te,enable_spacebar_move_to_shortcut:!t.wcomponent_id})}const MoveToWComponentButton=connector$1J(_MoveToWComponentButton);var NavigateBefore={},_interopRequireDefault$p=interopRequireDefaultExports;Object.defineProperty(NavigateBefore,"__esModule",{value:!0});var default_1$p=NavigateBefore.default=void 0,_createSvgIcon$p=_interopRequireDefault$p(requireCreateSvgIcon()),_jsxRuntime$p=requireJsxRuntime(),_default$p=(0,_createSvgIcon$p.default)((0,_jsxRuntime$p.jsx)("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore");default_1$p=NavigateBefore.default=_default$p;var NavigateNext={},_interopRequireDefault$o=interopRequireDefaultExports;Object.defineProperty(NavigateNext,"__esModule",{value:!0});var default_1$o=NavigateNext.default=void 0,_createSvgIcon$o=_interopRequireDefault$o(requireCreateSvgIcon()),_jsxRuntime$o=requireJsxRuntime(),_default$o=(0,_createSvgIcon$o.default)((0,_jsxRuntime$o.jsx)("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext");default_1$o=NavigateNext.default=_default$o;const time_slider="",Editable="";function date_to_string(t){const{date:ee,time_resolution:te,trim_midnight:ne}=t;return ee&&valid_date(ee)?date2str_auto({date:ee,time_resolution:te,trim_midnight:ne}):""}function uncertain_date_to_string(t,ee){let te="Eternal";if(!uncertain_datetime_is_eternal(t)){const ne=date_to_string({date:t.min,time_resolution:ee}),oe=date_to_string({date:t.value,time_resolution:ee}),ie=date_to_string({date:t.max,time_resolution:ee});if(oe&&!ne&&!ie)return oe;te=[ne,ne?" ":"","<",oe?" ":"",oe,oe?" ":"","<",ie?" ":"",ie].filter(se=>se).join("")}return te}function valid_date(t){return!Number.isNaN(t.getTime())}function correct_datetime_for_local_time_zone(t){const ee=new Date(t);return valid_date(ee)?ee:void 0}const Button$1="";function Button(t){return o$1(Hidden,{xsUp:t.is_hidden,children:o$1(Button$2,{className:t.className,title:t.title,color:t.color||"primary",style:{...t.style,pointerEvents:"initial"},component:t.component,disabled:t.disabled||!1,disableElevation:t.disableElevation||!0,disableFocusRipple:t.disableFocusRipple||!1,endIcon:t.endIcon,fullWidth:t.fullWidth||!1,href:t.href,size:t.size||"small",startIcon:t.startIcon,variant:t.variant||"contained",onPointerDown:ee=>{ee.currentTarget.focus(),ee.stopImmediatePropagation(),ee.preventDefault(),t.onPointerDown&&t.onPointerDown(ee)},onClick:ee=>{ee.currentTarget.focus(),ee.stopImmediatePropagation(),ee.preventDefault(),t.onClick&&t.onClick(ee)},children:t.children||t.value})})}function find_parent_element_by_class(t,ee){for(;t;){const{classList:te}=t;if(te&&te.contains(ee))break;t=t.parentElement}return t}function find_parent_element_by_classes(t,ee){for(;t;){const{classList:te}=t;if(te&&ee.find(ne=>te.contains(ne)))break;t=t.parentElement}return t}const map_state$1G=t=>({time_resolution:t.display_options.time_resolution,presenting:t.display_options.consumption_formatting}),connector$1I=connect(map_state$1G);function _EditableCustomDateTime(t){const ee=props_to_str_value(t),[te,ne]=h$1(!1),oe=ee?"":"no_entry",{on_change:ie}=t;if(!ie)return o$1("div",{className:oe,children:ee});const{invariant_value:_e,show_now_shortcut_button:se=!1,show_today_shortcut_button:re=!0}=t,ae=is_value_valid(ee),ce=t.editing_allowed!==void 0?!t.editing_allowed:t.presenting,de=`editable_field ${ae?"":"invalid"} ${oe} ${ce?"not_editable":""}`,ue=(t.title||"DateTime")+(t.invariant_value&&t.value?" (custom)":"");function le(fe){ie&&diff_value(t.value,fe)&&ie(fe)}const pe=_$d(void 0),me=_$d(le);return me.current=le,p$1(()=>()=>{if(!pe.current||!(document.activeElement===pe.current))return;const ge=handle_on_blur({working_value:pe.current.value,invariant_value:_e});me.current(ge)},[]),o$1("div",{className:de,title:ue,children:[o$1(TextField,{disabled:ce,type:"text",label:ue,value:ee,onFocus:()=>ne(!0),inputRef:fe=>{if(!fe||(pe.current=fe,!te))return;const ge=props_value(t),he=date_to_string({date:ge,time_resolution:"minute",trim_midnight:!1});fe.value=he,fe.setSelectionRange(0,fe.value.length)},onKeyDown:fe=>{var be;const ge=fe.key==="Enter",he=fe.key==="Escape";(ge||he)&&((be=fe.target)==null||be.blur())},onChange:fe=>{const ge=is_value_valid(fe.currentTarget.value),he=find_parent_element_by_class(fe.currentTarget,"editable_field");he&&(ge?he.classList.remove("invalid"):he.classList.add("invalid"))},onBlur:fe=>{const ge=fe.currentTarget.value,he=handle_on_blur({working_value:ge,invariant_value:_e});le(he),ne(!1)},size:"small",variant:"outlined",fullWidth:!0}),te&&se&&o$1(NowButton$1,{on_change:le}),te&&re&&o$1(Button,{value:"Today",onPointerDown:()=>{const fe=get_today_str();le(new Date(fe))}})]})}const EditableCustomDateTime=connector$1I(_EditableCustomDateTime);function is_value_valid(t){if(!t.trim())return!0;const ee=correct_datetime_for_local_time_zone(t);return!!ee&&valid_date(ee)}function NowButton$1(t){return o$1(Button,{value:"Now",onClick:()=>{const ee=new Date(new Date().getTime()+3e4),te=date2str(ee,"yyyy-MM-dd hh:mm");t.on_change(new Date(te))}})}function props_value(t){return t.value||t.invariant_value}function diff_value(t,ee){const te=t==null?void 0:t.getTime(),ne=ee==null?void 0:ee.getTime();return te!==ne}function props_to_str_value(t){const ee=props_value(t);return date_to_string({date:ee,time_resolution:t.time_resolution})}function handle_on_blur(t){const{working_value:ee,invariant_value:te}=t;let ne=correct_datetime_for_local_time_zone(ee);return ne&&ne.getTime()===(te&&te.getTime())&&(ne=void 0),ne}const test_handle_on_blur=describe.delay("handle_on_blur",()=>{let t,ee,te;t=void 0,ee="2020-01-01",te=handle_on_blur({invariant_value:t,working_value:ee}),test(te==null?void 0:te.getTime(),new Date("2020-01-01T00:00:00.000Z").getTime()),t=void 0,ee="2021-04-25 08:37",te=handle_on_blur({invariant_value:t,working_value:ee}),test(te==null?void 0:te.getTime(),new Date("2021-04-25T07:37:00.000Z").getTime())});function find_index_in_sorted_list(t,ee,te){let ne=0,oe=t.length-1;for(;ne<=oe;){let ie=Math.floor((ne+oe)/2);const _e=ee(t[ie]);if(_e===te)return ie;_e<te?ne=ie+1:oe=ie-1}return-1}function find_nearest_index_in_sorted_list(t,ee,te){let ne=0,oe=t.length-1;for(;ne<=oe;){let ie=Math.floor((ne+oe)/2);const _e=ee(t[ie]);if(_e===te)return{index:ie,exact:!0,bounds:"in"};if(_e<te?ne=ie+1:oe=ie-1,ne>oe){const se=oe===-1?"lower":ne===t.length?"higher":"in";return{index:se==="lower"?-.5:se==="higher"?t.length-.5:_e<te?ie+.5:ie-.5,exact:!1,bounds:se}}}return{index:-1,exact:!1,bounds:"n/a"}}const test_binary_search_functions=describe.delay("binary search functions",()=>{let t=find_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3);test(t,2),t=find_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3.5),test(t,-1);let ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3);test(ee,{index:2,exact:!0,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,0),test(ee,{index:-.5,exact:!1,bounds:"lower"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,1.5),test(ee,{index:.5,exact:!1,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,2.5),test(ee,{index:1.5,exact:!1,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3.5),test(ee,{index:2.5,exact:!1,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,9.5),test(ee,{index:8.5,exact:!1,bounds:"higher"})});function NowButton(t){return o$1(Button,{title:t.title,value:"Now",onClick:()=>{const ee=new Date().getTime()+6e4;t.change_datetime_ms(ee)},is_left:!0})}const map_state$1F=(t,{get_handle_ms:ee})=>({handle_datetime_ms:ee(t),time_resolution:t.display_options.time_resolution}),connector$1H=connect(map_state$1F);function _TimeSlider(t){const ee=t.events.map(se=>{let re=se.datetime.getTime();return re=floor_mseconds_to_resolution(re,t.time_resolution),re}),te=ee[0],ne=ee[ee.length-1],oe=find_nearest_index_in_sorted_list(ee,se=>se,t.handle_datetime_ms);function ie(se){typeof se=="number"&&t.change_handle_ms(se)}function _e(se){return()=>{let re=oe.index+se;oe.exact||(se===1?re=Math.ceil(oe.index):re=Math.floor(oe.index));let ae=ee[re];for(;ae===t.handle_datetime_ms;)re+=se,ae=ee[re];ae&&t.change_handle_ms(ae)}}return o$1(Box,{className:"time_slider",my:2,px:5,children:[o$1(Box,{className:"slider_container",display:"flex",children:[o$1(ButtonGroup,{size:"small",children:[o$1(IconButton,{onClick:_e(-1),disabled:oe.bounds==="n/a"||oe.index<=0,title:"Previous "+t.title+" datetime",size:"large",children:o$1(default_1$p,{})}),o$1(IconButton,{onClick:_e(1),disabled:oe.bounds==="n/a"||oe.index>=ee.length-1,title:"Next "+t.title+" datetime",size:"large",children:o$1(default_1$o,{})})]}),o$1(Box,{flexGrow:1,title:t.title+" datetimes",children:o$1(Slider,{onChange:(se,re)=>ie(re),color:"secondary",value:t.handle_datetime_ms,getAriaValueText:value_text,valueLabelFormat:get_value_label_format,step:1,min:te,max:ne,valueLabelDisplay:"auto",marks:ee.map(se=>({value:se,label:""}))})})]}),o$1(Box,{display:"flex",justifyContent:"flex-end",alignItems:"center",children:[o$1(EditableCustomDateTime,{title:t.title,value:new Date(t.handle_datetime_ms),on_change:se=>se&&t.change_handle_ms(se.getTime()),show_now_shortcut_button:!1,show_today_shortcut_button:!1,editing_allowed:!0}),o$1(NowButton,{title:"Set "+t.title+" to now",change_datetime_ms:se=>t.change_handle_ms(se)})]})]})}const TimeSlider=connector$1H(_TimeSlider),value_text=t=>`${t}`,get_value_label_format=t=>{const ee=date2str_auto({date:new Date(t),time_resolution:"minute"});return o$1("span",{style:{whiteSpace:"nowrap"},children:ee})},invert_disabled_appearance=makeStyles(t=>({inverse_disabled:{color:t.palette.text.disabled,"&.Mui-disabled":{color:t.palette.text.primary,pointerEvents:"auto"}}}));var Filter={},_interopRequireDefault$n=interopRequireDefaultExports;Object.defineProperty(Filter,"__esModule",{value:!0});var default_1$n=Filter.default=void 0,_createSvgIcon$n=_interopRequireDefault$n(requireCreateSvgIcon()),_jsxRuntime$n=requireJsxRuntime(),_default$n=(0,_createSvgIcon$n.default)((0,_jsxRuntime$n.jsx)("path",{d:"m15.96 10.29-2.75 3.54-1.96-2.36L8.5 15h11l-3.54-4.71zM3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"Filter");default_1$n=Filter.default=_default$n;const active_warning_styles=makeStyles(t=>({warning_button:{cursor:"help"},warning_icon:{color:t.palette.warning.main}})),map_state$1E=t=>{var ne;const{wc_ids_excluded_by_created_at_datetime_filter:ee,vap_set_number_excluded_by_created_at_datetime_filter:te=0}=((ne=get_current_composed_knowledge_view_from_state(t))==null?void 0:ne.filters)||{};return{components:(ee==null?void 0:ee.size)||0,vap_sets:te}},map_dispatch$10={set_display_time_sliders:ACTIONS.controls.set_display_time_sliders},connector$1G=connect(map_state$1E,map_dispatch$10);function _ActiveCreatedAtFilterWarning(t){const{components:ee,vap_sets:te}=t;if(ee+te===0)return null;const ne=active_warning_styles();let oe=ee?`${ee} components are invisible `:"";return ee&&te&&(oe+="and "),oe+=te?`${te} predictions are invisible `:"",oe+="due to created at datetime filter",o$1(Tooltip,{placement:"top",title:oe,children:o$1(IconButton,{className:ne.warning_button,component:"span",onClick:()=>t.set_display_time_sliders(!0),size:"small",children:o$1(default_1$n,{className:ne.warning_icon})})})}const ActiveCreatedAtFilterWarning=connector$1G(_ActiveCreatedAtFilterWarning),map_state$1D=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=(ee&&ee.composed_datetime_line_config.time_origin_ms)!==void 0,ne=get_current_knowledge_view_from_state(t);return{display_time_marks:t.display_options.display_time_marks,sim_ms:t.routing.args.sim_ms,time_origin_ms_present:te,current_kv:ne,presenting:t.display_options.consumption_formatting}},map_dispatch$$={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view,set_display_time_marks:ACTIONS.display.set_display_time_marks},connector$1F=connect(map_state$1D,map_dispatch$$);function _ToggleDatetimeMarkers(t){const{display_time_marks:ee,time_origin_ms_present:te,current_kv:ne,presenting:oe}=t;return oe&&!te?null:o$1(Box,{component:"label",children:o$1(ButtonGroup,{disableElevation:!0,variant:"contained",value:ee,children:o$1(Button$2,{onClick:()=>{const ie=!ee;if(ie&&!te&&ne){const _e=get_store(),se=get_middle_of_screen(_e.getState()).left,re={...ne,datetime_line_config:{...ne.datetime_line_config,time_origin_ms:t.sim_ms,time_origin_x:se}};t.upsert_knowledge_view({knowledge_view:re})}t.set_display_time_marks(ie)},"aria-label":"Toggle displaying time markers",children:[ee?"Hide":"Show"+(te?"":" (Set)")," time"]})})})}const ToggleDatetimeMarkers=connector$1F(_ToggleDatetimeMarkers);var FilterNone={},_interopRequireDefault$m=interopRequireDefaultExports;Object.defineProperty(FilterNone,"__esModule",{value:!0});var default_1$m=FilterNone.default=void 0,_createSvgIcon$m=_interopRequireDefault$m(requireCreateSvgIcon()),_jsxRuntime$m=requireJsxRuntime(),_default$m=(0,_createSvgIcon$m.default)((0,_jsxRuntime$m.jsx)("path",{d:"M3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"FilterNone");default_1$m=FilterNone.default=_default$m;const map_state$1C=t=>({apply_filter:t.filter_context.apply_filter}),map_dispatch$_={change_route:ACTIONS.routing.change_route},connector$1E=connect(map_state$1C,map_dispatch$_);function _ActiveFilterWarning(t){const{apply_filter:ee}=t,te=active_warning_styles();return ee?o$1(Tooltip,{placement:"top",title:"A filter is in place which could result in components being hidden",children:o$1(IconButton,{className:te.warning_button,component:"span",size:"small",onClick:()=>t.change_route({route:"filter"}),children:o$1(default_1$m,{className:te.warning_icon})})}):null}const ActiveFilterWarning=connector$1E(_ActiveFilterWarning);var PhotoFilter={},_interopRequireDefault$l=interopRequireDefaultExports;Object.defineProperty(PhotoFilter,"__esModule",{value:!0});var default_1$l=PhotoFilter.default=void 0,_createSvgIcon$l=_interopRequireDefault$l(requireCreateSvgIcon()),_jsxRuntime$l=requireJsxRuntime(),_default$l=(0,_createSvgIcon$l.default)((0,_jsxRuntime$l.jsx)("path",{d:"M19.02 10v9H5V5h9V3H5.02c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-9h-2zM17 10l.94-2.06L20 7l-2.06-.94L17 4l-.94 2.06L14 7l2.06.94zm-3.75.75L12 8l-1.25 2.75L8 12l2.75 1.25L12 16l1.25-2.75L16 12z"}),"PhotoFilter");default_1$l=PhotoFilter.default=_default$l;const map_state$1B=t=>({creation_context:t.creation_context,editing:!t.display_options.consumption_formatting}),map_dispatch$Z={change_route:ACTIONS.routing.change_route,set_or_toggle_display_side_panel:ACTIONS.controls.set_or_toggle_display_side_panel},connector$1D=connect(map_state$1B,map_dispatch$Z);function _ActiveCreationContextWarning(t){const{creation_context:ee,editing:te}=t,ne=active_warning_styles();return ee.use_creation_context&&te&&o$1(Tooltip,{placement:"top",title:"WARNING: Creation Context is active, which can result in components being created with incorrect information!",children:o$1(IconButton,{className:ne.warning_button,component:"span",size:"small",onClick:()=>{t.set_or_toggle_display_side_panel(!0),t.change_route({route:"creation_context"})},children:o$1(default_1$l,{className:ne.warning_icon})})})}const ActiveCreationContextWarning=connector$1D(_ActiveCreationContextWarning);var FilterTiltShift={},_interopRequireDefault$k=interopRequireDefaultExports;Object.defineProperty(FilterTiltShift,"__esModule",{value:!0});var default_1$k=FilterTiltShift.default=void 0,_createSvgIcon$k=_interopRequireDefault$k(requireCreateSvgIcon()),_jsxRuntime$k=requireJsxRuntime(),_default$k=(0,_createSvgIcon$k.default)((0,_jsxRuntime$k.jsx)("path",{d:"M11 4.07V2.05c-2.01.2-3.84 1-5.32 2.21L7.1 5.69c1.11-.86 2.44-1.44 3.9-1.62zm7.32.19C16.84 3.05 15.01 2.25 13 2.05v2.02c1.46.18 2.79.76 3.9 1.62l1.42-1.43zM19.93 11h2.02c-.2-2.01-1-3.84-2.21-5.32L18.31 7.1c.86 1.11 1.44 2.44 1.62 3.9zM5.69 7.1 4.26 5.68C3.05 7.16 2.25 8.99 2.05 11h2.02c.18-1.46.76-2.79 1.62-3.9zM4.07 13H2.05c.2 2.01 1 3.84 2.21 5.32l1.43-1.43c-.86-1.1-1.44-2.43-1.62-3.89zM15 12c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3zm3.31 4.9 1.43 1.43c1.21-1.48 2.01-3.32 2.21-5.32h-2.02c-.18 1.45-.76 2.78-1.62 3.89zM13 19.93v2.02c2.01-.2 3.84-1 5.32-2.21l-1.43-1.43c-1.1.86-2.43 1.44-3.89 1.62zm-7.32-.19C7.16 20.95 9 21.75 11 21.95v-2.02c-1.46-.18-2.79-.76-3.9-1.62l-1.42 1.43z"}),"FilterTiltShift");default_1$k=FilterTiltShift.default=_default$k;const map_state$1A=t=>({focused_mode:t.display_options.focused_mode}),map_dispatch$Y={set_or_toggle_focused_mode:ACTIONS.display.set_or_toggle_focused_mode},connector$1C=connect(map_state$1A,map_dispatch$Y);function _ActiveFocusedMode(t){const{focused_mode:ee}=t,te=ee?"WARNING: Focused Mode is active, unselected components will be almost invisible":"Activate focused mode",ne=ee?active_warning_styles():inactive_warning_styles();return o$1(Tooltip,{placement:"top",title:te,children:o$1("span",{children:o$1(IconButton,{component:"span",size:"medium",onClick:()=>t.set_or_toggle_focused_mode(),children:o$1(default_1$k,{className:ne.warning_icon})})})})}const ActiveFocusedMode=connector$1C(_ActiveFocusedMode),inactive_warning_styles=makeStyles(t=>({warning_icon:{color:t.palette.primary.main}})),map_state$1z=t=>({linked_datetime_sliders:t.controls.linked_datetime_sliders,display_by_simulated_time:t.display_options.display_by_simulated_time,display_time_sliders:t.controls.display_time_sliders,actually_display_time_sliders:get_actually_display_time_sliders(t),editing:!t.display_options.consumption_formatting,animate_connections:t.display_options.animate_connections,created_at_ms:t.routing.args.created_at_ms}),map_dispatch$X={change_display_at_created_datetime:ACTIONS.display_at_created_datetime.change_display_at_created_datetime,change_display_at_sim_datetime:ACTIONS.display_at_sim_datetime.change_display_at_sim_datetime,toggle_linked_datetime_sliders:ACTIONS.controls.toggle_linked_datetime_sliders,set_display_time_sliders:ACTIONS.controls.set_display_time_sliders,set_display_by_simulated_time:ACTIONS.display.set_display_by_simulated_time,set_or_toggle_animate_connections:ACTIONS.display.set_or_toggle_animate_connections},connector$1B=connect(map_state$1z,map_dispatch$X);function _ContentControls(t){const[ee,te]=h$1(!0);invert_disabled_appearance();const{created_events:ne,sim_events:oe}=t,ie=use_styles$6();return o$1(Box,{p:2,mb:2,borderTop:1,borderColor:"primary.main",position:"relative",children:[o$1(Collapse,{in:t.actually_display_time_sliders,children:o$1(Box,{className:ie.drawer_content,children:o$1(Box,{flexGrow:1,children:[o$1(TimeSlider,{events:ne,get_handle_ms:_e=>_e.routing.args.created_at_ms,change_handle_ms:_e=>t.change_display_at_created_datetime({ms:_e}),data_set_name:"content_controls_created_at_datetimes",title:"Created at"}),o$1(TimeSlider,{events:oe,get_handle_ms:_e=>_e.routing.args.sim_ms,change_handle_ms:_e=>t.change_display_at_sim_datetime({ms:_e}),data_set_name:"content_controls_sim_datetimes",title:"Simulation"})]})})}),o$1(Toolbar,{className:ie.toolbar,variant:"dense",children:[o$1(Box,{className:ie.move_to_button_and_warnings,children:[o$1(MoveToWComponentButton,{allow_drawing_attention:ee,have_finished_drawing_attention:()=>te(!1),disable_if_not_present:!1}),o$1(ActiveFocusedMode,{}),o$1(ActiveCreatedAtFilterWarning,{}),o$1(ActiveFilterWarning,{}),o$1(ActiveCreationContextWarning,{})]}),o$1(ToggleDatetimeMarkers,{}),o$1("div",{children:[o$1(Tooltip,{placement:"top",title:t.animate_connections?"Stop animating connections":"Animate connections",children:o$1(IconButton,{component:"span",size:"medium",onClick:()=>t.set_or_toggle_animate_connections(),children:o$1(default_1$r,{style:{color:t.animate_connections?"rgb(25, 118, 210)":""}})})}),o$1(Tooltip,{placement:"top",title:t.display_time_sliders?"Hide time sliders":"Show time sliders",children:o$1(IconButton,{component:"span",size:"medium",onClick:()=>t.set_display_time_sliders(!t.display_time_sliders),children:o$1(default_1$s,{})})})]})]})]})}const ContentControls=connector$1B(_ContentControls),use_styles$6=makeStyles(t=>({toolbar:{justifyContent:"space-between"},move_to_button_and_warnings:{display:"flex",flexDirection:"row"},drawer_content:{display:"flex",flexDirection:"row",alignItems:"center",alignContent:"center"},warning_icon:{color:t.palette.warning.main}})),map_state$1y=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,current_composed_knowledge_view:get_current_composed_knowledge_view_from_state(t)}),connector$1A=connect(map_state$1y);function _KnowledgeContentControls(t){const{wcomponents_by_id:ee,current_composed_knowledge_view:te}=t;if(!te)return o$1("div",{});const{composed_wc_id_map:ne}=te,{created_events:oe,sim_events:ie}=F$1(()=>{const _e=Object.keys(ne).map(se=>ee[se]).filter(is_defined);return get_wcomponent_time_slider_data(_e)},[ne,ee]);return o$1(ContentControls,{created_events:oe,sim_events:ie})}const KnowledgeContentControls=connector$1A(_KnowledgeContentControls),map_state$1x=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=ee==null?void 0:ee.prioritisations,ne=ee==null?void 0:ee.composed_datetime_line_config;return{prioritisations:te,time_origin_ms:ne==null?void 0:ne.time_origin_ms,time_origin_x:ne==null?void 0:ne.time_origin_x,time_scale:ne==null?void 0:ne.time_scale}},map_dispatch$W={change_display_at_created_datetime:ACTIONS.display_at_created_datetime.change_display_at_created_datetime,change_route:ACTIONS.routing.change_route},connector$1z=connect(map_state$1x,map_dispatch$W);function _PrioritiesContentControls(t){const[ee,te]=h$1(!0),{prioritisations:ne=[]}=t,{time_origin_ms:oe,time_origin_x:ie,time_scale:_e}=default_time_origin_parameters(t);let se=calculate_canvas_x_for_datetime({datetime:new Date,time_origin_ms:oe,time_origin_x:ie,time_scale:_e}),re=se;const ae=140;ne.forEach(pe=>{const me=get_uncertain_datetime(pe.datetime);if(!me)return;const fe=calculate_canvas_x_for_datetime({datetime:me,time_origin_ms:oe,time_origin_x:ie,time_scale:_e});se=Math.min(se,fe),re=Math.max(re,fe)}),se-=100,re+=200;const ce=calculate_zoom_to_contain_group({min_left:se,max_left:re,min_top:ae,max_top:ae},{display_side_panel:!1,display_time_sliders:!1}).zoom,de={x:se,y:ae,zoom:ce};return o$1("div",{style:{borderTop:"thin solid rgb(206, 206, 206)"},children:o$1(MoveToItemButton,{move:()=>t.change_route({args:de}),draw_attention:ee&&de&&!!0,have_finished_drawing_attention:()=>te(!1),enable_spacebar_move_to_shortcut:!0})})}const PrioritiesContentControls=connector$1z(_PrioritiesContentControls),map_state$1w=t=>({view:t.routing.args.view}),connector$1y=connect(map_state$1w);function _MainContentControls(t){const{view:ee}=t;return o$1("div",{className:"main_content_controls",children:[ee==="knowledge"&&o$1(KnowledgeContentControls,{}),ee==="priorities"&&o$1(PrioritiesContentControls,{})]})}const MainContentControls=connector$1y(_MainContentControls);function MainArea(t){return o$1(Box,{id:"main_area",display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,zIndex:1,children:[o$1(Box,{id:"main_content",flexGrow:1,flexShrink:1,display:"flex",flexDirection:"column",position:"relative",zIndex:1,children:t.main_content}),o$1(Box,{id:"main_content_controls",bgcolor:"#fafafa",flexGrow:0,flexShrink:1,position:"relative",zIndex:10,children:o$1(MainContentControls,{})}),t.extra_content]})}var ArrowDownward={},_interopRequireDefault$j=interopRequireDefaultExports;Object.defineProperty(ArrowDownward,"__esModule",{value:!0});var default_1$j=ArrowDownward.default=void 0,_createSvgIcon$j=_interopRequireDefault$j(requireCreateSvgIcon()),_jsxRuntime$j=requireJsxRuntime(),_default$j=(0,_createSvgIcon$j.default)((0,_jsxRuntime$j.jsx)("path",{d:"m20 12-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"}),"ArrowDownward");default_1$j=ArrowDownward.default=_default$j;const KnowledgeGraphTimeMarkers$1="",map_state$1v=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=ee==null?void 0:ee.composed_datetime_line_config;return{display_time_marks:t.display_options.display_time_marks,time_origin_ms:te==null?void 0:te.time_origin_ms,time_origin_x:te==null?void 0:te.time_origin_x,time_scale:te==null?void 0:te.time_scale,time_line_number:te==null?void 0:te.time_line_number,time_line_spacing_days:te==null?void 0:te.time_line_spacing_days,x:t.routing.args.x,zoom:t.routing.args.zoom,sim_ms:t.routing.args.sim_ms}},connector$1x=connect(map_state$1v);function _KnowledgeGraphTimeMarkers(t){if(!(t.force_display??t.display_time_marks))return null;let{time_origin_ms:ee,time_origin_x:te,time_scale:ne}=t;if(t.force_display&&({time_origin_ms:ee,time_origin_x:te,time_scale:ne}=default_time_origin_parameters({time_origin_ms:ee,time_origin_x:te,time_scale:ne})),ee===void 0||te===void 0||ne===void 0)return null;const{sim_ms:oe,time_line_number:ie,time_line_spacing_days:_e}=t,se=F$1(()=>get_other_datetime_lines({time_line_number:ie&&ie-1,time_line_spacing_days:_e}),[ie,_e]),{x:re,zoom:ae}=t,ce=ae/SCALE_BY,de=(re-te)*ce,ue=ne/time_scale_days_to_ms_pixels_fudge_factor*ce,le=new Date().getTime();return o$1("div",{className:"datetime_lines_container",children:[se.map(pe=>o$1(DatetimeLine,{date_ms:(t.show_by_now?le:oe)+pe.offset,time_origin_ms:ee,time_scale_ms_to_pixels_fudge:ue,xm:de,xd:ce,color:"black",opacity:pe.opacity},pe.key)),!!ie&&o$1(DatetimeLine,{date_ms:le,time_origin_ms:ee,time_scale_ms_to_pixels_fudge:ue,xm:de,xd:ce,color:"red",left_label_when_off_screen:!0}),!!ie&&!t.show_by_now&&o$1(DatetimeLine,{date_ms:oe,time_origin_ms:ee,time_scale_ms_to_pixels_fudge:ue,xm:de,xd:ce,color:"blue",left_label_when_off_screen:!0})]})}const KnowledgeGraphTimeMarkers=connector$1x(_KnowledgeGraphTimeMarkers),date_format="yyyy-MM-dd";function DatetimeLine(t){const{color:ee,opacity:te}=t;let ne=(t.date_ms-t.time_origin_ms)*t.time_scale_ms_to_pixels_fudge-t.xm;const oe=document.body.clientWidth-20,ie=ne<0,_e=ne>oe,se=!ie&&!_e;return!se&&!t.left_label_when_off_screen?null:(ne=bounded(ne,0,oe),o$1("div",{className:"datetime_container",style:{color:ee,borderColor:ee,left:ne,opacity:te},children:[o$1("div",{className:"rotater",children:[ie&&o$1(default_1$u,{fontSize:"small"}),_e&&o$1(default_1$j,{fontSize:"small"}),o$1("div",{className:"date_label",children:date2str(new Date(t.date_ms),date_format)})]}),se&&o$1("div",{className:"datetime_line"})]}))}const milliseconds_in_day=1e3*3600*24;function get_other_datetime_lines(t){const ee=[],{time_line_number:te,time_line_spacing_days:ne}=t;if(te===void 0||ne===void 0)return[];const oe=ne*milliseconds_in_day;for(let ie=te;ie>0;--ie){const _e=ie/te,se=te-ie+1;ee.push({offset:oe*se,opacity:_e,key:`plus${ie}`}),ee.push({offset:-oe*se,opacity:_e,key:`minus${ie}`})}return ee}const map_state$1u=t=>{const{ready_for_reading:ee}=t.sync,{current_composed_knowledge_view:te}=t.derived;ee&&!te&&console.log("No current_composed_knowledge_view");const{wcomponent_nodes:ne,wcomponent_connections:oe,wcomponent_unfound_ids:ie}=te||{},_e=t.meta_wcomponents.wcomponent_ids_to_move_set.size>0,se=t.meta_wcomponents.frame_is_resizing,re=_e||se;return{ready:ee,wcomponent_nodes:ne,wcomponent_connections:oe,wcomponent_unfound_ids:ie,presenting:t.display_options.consumption_formatting,show_large_grid:t.display_options.show_large_grid,canvas_drag_event:re}},connector$1w=connect(map_state$1u);function _KnowledgeGraphView(t){const ee=get_children$1(t),[te,ne]=h$1(!1);p$1(()=>pub_sub.canvas.sub("canvas_pointer_down",()=>{ne(!0)})),p$1(()=>pub_sub.canvas.sub("canvas_pointer_up",()=>{ne(!1)}));const oe=t.canvas_drag_event||te?" canvas_drag_event ":"";return o$1(MainArea,{main_content:o$1(Canvas,{svg_children:[],svg_upper_children:get_svg_upper_children(t),overlay:get_overlay_children$1(),plain_background:t.presenting,show_large_grid:t.show_large_grid,extra_class_names:oe,children:ee})})}const KnowledgeGraphView=connector$1w(_KnowledgeGraphView),no_children=[],get_children$1=t=>{const{ready:ee,wcomponent_nodes:te=[],wcomponent_unfound_ids:ne=[]}=t;return!ee||te.length===0&&ne.length===0?no_children:[...te.map(({id:ie})=>o$1(WComponentCanvasNode,{id:ie},ie)),...ne.map(ie=>o$1(WComponentCanvasNode,{id:ie},ie))]},get_svg_upper_children=({wcomponent_connections:t=[]})=>t.map(({id:ee})=>o$1(WComponentCanvasConnection,{id:ee},ee)),get_overlay_children$1=()=>o$1(KnowledgeGraphTimeMarkers,{}),PrioritiesListView$1="";function Prioritisation({prioritisation:t}){return o$1(WComponentCanvasNode,{id:t.id,is_on_canvas:!1,always_show:!0})}const EditableNumber$1="";function get_wcomponent_search_options(t){const{wcomponents:ee,allowed_wcomponent_ids:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,created_at_ms:_e,sim_ms:se}=t;let re=ee||Object.values(ne);return te&&(re=re.filter(({id:ce})=>te.has(ce))),re.filter(wcomponent_is_not_deleted).filter(ce=>!t.exclude_ids||!t.exclude_ids.has(ce.id)).map(ce=>{const de=get_title$1({wcomponent:ce,text_type:RichTextType.plain,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,created_at_ms:_e,sim_ms:se});let ue=`@@${ce.id} -- ${ce.title} -- ${ce.description}`;wcomponent_is_plain_connection(ce)&&(ue+=` -- @@${ce.from_id} -> @@${ce.to_id}`);let le;return wcomponent_is_judgement_or_objective(ce)&&(le=o$1("div",{children:[o$1(JudgementBadgeConnected,{judgement_or_objective_id:ce.id,hide_judgement_trend:!1}),de]})),{id:ce.id,title:de,jsx:le,raw_title:ce.title,subtitle:ue,color:ce.label_color}})}var ExpandMore={},_interopRequireDefault$i=interopRequireDefaultExports;Object.defineProperty(ExpandMore,"__esModule",{value:!0});var default_1$i=ExpandMore.default=void 0,_createSvgIcon$i=_interopRequireDefault$i(requireCreateSvgIcon()),_jsxRuntime$i=requireJsxRuntime(),_default$i=(0,_createSvgIcon$i.default)((0,_jsxRuntime$i.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");default_1$i=ExpandMore.default=_default$i;var Refresh={},_interopRequireDefault$h=interopRequireDefaultExports;Object.defineProperty(Refresh,"__esModule",{value:!0});var default_1$h=Refresh.default=void 0,_createSvgIcon$h=_interopRequireDefault$h(requireCreateSvgIcon()),_jsxRuntime$h=requireJsxRuntime(),_default$h=(0,_createSvgIcon$h.default)((0,_jsxRuntime$h.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"}),"Refresh");default_1$h=Refresh.default=_default$h;var Warning={},_interopRequireDefault$g=interopRequireDefaultExports;Object.defineProperty(Warning,"__esModule",{value:!0});var default_1$g=Warning.default=void 0,_createSvgIcon$g=_interopRequireDefault$g(requireCreateSvgIcon()),_jsxRuntime$g=requireJsxRuntime(),_default$g=(0,_createSvgIcon$g.default)((0,_jsxRuntime$g.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");default_1$g=Warning.default=_default$g;const AutocompleteText$1="";function Options(t){const{editing_options:ee,internal_options_to_display:te,is_option_wrapper_highlighted:ne,conditional_on_change:oe,set_highlighted_option_index:ie,on_mouse_over_option:_e,on_mouse_leave_option:se}=t;if(te.length===0||!ee)return null;const re=45;return o$1("div",{className:"options_outer",style:{marginTop:15},children:o$1("div",{className:"options_inner",ref:ae=>{if(!ae)return;const ce=`${document.body.clientHeight-ae.clientTop-re}px`;ae.style.setProperty("max-height",ce)},children:te.map((ae,ce)=>o$1("div",{className:"option_wrapper "+(ne(ae,ce)?" highlighted ":""),onMouseDown:()=>oe(ae.id),onMouseOver:()=>{ie(ce),_e(ae.id)},onMouseLeave:()=>se(ae.id),children:o$1("div",{className:"option",children:[ae.jsx||ae.title||ae.id||"none",o$1("div",{className:"option_subtitle",children:ae.subtitle})]})}))})})}const map_state$1t=t=>{var ee;return{presenting:(ee=t.display_options)==null?void 0:ee.consumption_formatting}},connector$1v=connect(map_state$1t);function _AutocompleteText(t){const ee=_$d([]),te=_$d(FlexSearch.Index()),ne=_$d([]);p$1(()=>{const xe=prepare_options(t.options,200,t.search_fields),Ie=prepare_targets(xe);ee.current=Ie,xe.forEach(Pe=>{te.current=te.current.add(Pe.id_num,Pe.unlimited_total_text)}),ne.current=xe},[t.options,t.search_fields]);const oe=_$d({actively_chosen:!1,id:void 0}),ie=we(),[_e,se]=h$1("");p$1(()=>{se(t.initial_search_term||ie)},[t.initial_search_term,ie]);const{throttled:re,flush:ae}=throttle(se,300),[ce,de]=h$1(!1);function ue(xe){xe!==ce&&de(xe)}p$1(()=>{ue(!!t.start_expanded)},[t.start_expanded]);const{threshold_minimum_score:le=!1}=t,[pe,me]=h$1([]);p$1(()=>{const xe=get_options_to_display({temp_value_str:_e,selected_any_option:t.selected_option_id!==OPTION_NONE_ID,allow_none:!!t.allow_none,internal_options:ne.current,prepared_targets:ee.current,flexsearch_index:te.current,search_type:t.search_type||"best",threshold_minimum_score:le,retain_options_order:t.retain_options_order||!1});me(xe.internal_options),t.set_search_type_used&&t.set_search_type_used(xe.search_type_used),ae()},[_e,t.selected_option_id,t.allow_none,ne.current,ee.current,te.current,t.search_type,le]);const[fe,ge]=h$1(0),he=_$d(new Set),be=F$1(()=>xe=>{xe&&he.current.add(xe),t.on_mouse_over_option&&t.on_mouse_over_option(xe)},[t.on_mouse_over_option]),ve=F$1(()=>xe=>{xe&&he.current.delete(xe),t.on_mouse_leave_option&&t.on_mouse_leave_option(xe)},[t.on_mouse_leave_option]);function we(){const xe=get_selected_option(t);return(xe==null?void 0:xe.title)||""}const ye=async(xe,Ie)=>{xe.stopImmediatePropagation();const Pe=xe.key,je=Pe==="ArrowDown",De=Pe==="ArrowUp",We=Pe==="Enter",ze=Pe==="Escape";if(We||ze)if(We&&fe!==void 0){const Le=Ie[fe];Le&&Ae(Le.id)}else ze&&Ae(t.selected_option_id);else if(je||De){let Le=fe+(je?1:-1);Le=Le%Ie.length,ge(Le)}},ke=()=>{ue(!1),!t.retain_invalid_search_term_on_blur&&se(we()),ge(0)},Ae=xe=>{ke(),oe.current={actively_chosen:!0,id:xe}},$e=()=>{ke();const{on_mouse_leave_option:xe}=t;xe&&(he.current.forEach(De=>xe(De)),he.current=new Set);const{actively_chosen:Ie,id:Pe}=oe.current;if(!Ie)return;oe.current={actively_chosen:!1,id:void 0},t.selected_option_id===Pe?t.on_choose_same&&t.on_choose_same(Pe):t.on_change(Pe)},Se=get_selected_internal_option(pe,_e),Te=(Se==null?void 0:Se.id)===OPTION_NONE.id&&t.allow_none||_e.toLowerCase()===(Se==null?void 0:Se.title.toLowerCase());return o$1("div",{class:"editable_field autocomplete "+(Te?"":"invalid "),style:t.extra_styles,children:[o$1(TextField,{variant:"standard",disabled:t.editing_allowed!==void 0?!t.editing_allowed:t.presenting,ref:xe=>{if(!xe)return;const Ie=xe.getElementsByTagName("input")[0];Ie&&setTimeout(ce?()=>Ie.focus():()=>Ie.blur(),0)},placeholder:t.placeholder,value:_e||(ce?"":"-"),onFocus:xe=>{setTimeout(()=>ue(!0),0),xe.currentTarget.setSelectionRange(0,xe.currentTarget.value.length)},onChange:xe=>re(xe.currentTarget.value),onKeyDown:xe=>ye(xe,pe),onBlur:()=>$e()}),o$1(Options,{editing_options:ce,internal_options_to_display:pe,is_option_wrapper_highlighted:(xe,Ie)=>Ie===fe,conditional_on_change:Ae,set_highlighted_option_index:ge,on_mouse_over_option:be,on_mouse_leave_option:ve})]})}const ConnectedAutocompleteText=connector$1v(_AutocompleteText);function AutocompleteText(t){return o$1(ConnectedAutocompleteText,{...t})}function get_selected_option(t){return t.selected_option_id===void 0?t.allow_none?void 0:t.options[0]:t.options.find(({id:ee})=>ee===t.selected_option_id)}function get_selected_internal_option(t,ee){const te=ee.toLowerCase();return t.find(ne=>ne.title.toLowerCase()===te)}const OPTION_ID_NUM_START=1;function prepare_options(t,ee,te="all"){let ne=OPTION_ID_NUM_START;const oe=te==="all";return t.filter(({is_hidden:_e})=>!_e).map(_e=>{const se=get_total_text(_e,ee,oe),re=get_total_text(_e,0,oe);return{..._e,limited_total_text:se,unlimited_total_text:re,id_num:ne++}})}function get_total_text(t,ee,te){let ne=limit_string_length(t.title,ee);return te?ne+=t.subtitle?" "+limit_string_length(t.subtitle,ee):"":ne+=t.raw_title?" "+limit_string_length(t.raw_title,ee):"",ne}function limit_string_length(t,ee){return ee?t.slice(0,ee)+(t.length>ee?"...":""):t}function prepare_targets(t){return t.map(({limited_total_text:ee})=>fuzzysort.prepare(ee))}const OPTION_NONE_ID=void 0,OPTION_NONE={id:OPTION_NONE_ID,id_num:OPTION_ID_NUM_START-1,title:"(clear)",limited_total_text:"clear",unlimited_total_text:""};function get_options_to_display(t){const{temp_value_str:ee,selected_any_option:te,allow_none:ne,prepared_targets:oe,flexsearch_index:ie,search_type:_e,threshold_minimum_score:se,retain_options_order:re}=t;let{internal_options:ae}=t,ce;if(!ee)return ae=ne&&te?[OPTION_NONE,...ae]:ae,{internal_options:ae,search_type_used:ce};let de=fe=>0,ue=fe=>0,le=0;if(_e==="best"||_e==="exact"){ce="exact";const fe=ie.search(ee);le=fe.length;const ge={};fe.forEach((he,be)=>ge[he]=1e4-be),de=he=>ge[he.id_num]||-1e4}if(le<10&&(_e==="best"||_e==="fuzzy")){ce="fuzzy";const fe={limit:100,allowTypo:!0,threshold:-1e4},ge=fuzzysort.go(ee,oe,fe),he={};ge.forEach(({target:be,score:ve})=>he[be]=ve),ue=be=>{const ve=he[be.limited_total_text];return ve===void 0?de(be):ve}}else ue=de;const pe=se===!1?ae:ae.filter(fe=>ue(fe)>se);let me=pe;return re||(me=sort_list(pe,ue,SortDirection.descending)),ne&&te&&(me=[OPTION_NONE,...me]),{internal_options:me,search_type_used:ce}}const Modal$1="";function map_state$1s(t,ee){const te=t.global_keys.last_key==="Escape",{last_key_time_stamp:ne=0}=t.global_keys;return{should_close:te&&ne>ee.time_stamp_first_rendered}}const connector$1u=connect(map_state$1s);function _ModalCore(t){const{on_close:ee}=t;return ee&&t.should_close&&setTimeout(()=>ee(),0),o$1("div",{id:"modal_background",className:(t.size||"medium")+"_modal",onClick:te=>{te.stopImmediatePropagation(),ee&&ee(te)},children:o$1("div",{id:"modal_container",style:t.scrollable===!1?{overflowY:"hidden"}:void 0,onClick:te=>te.stopPropagation(),children:[o$1("div",{id:"modal_title",children:t.title}),ee&&o$1("div",{id:"modal_close",onClick:te=>ee(te),children:o$1("span",{children:"X"})}),t.child]})})}const ModalCore=connector$1u(_ModalCore);function Modal(t){const ee=performance.now();return o$1(ModalCore,{...t,time_stamp_first_rendered:ee})}function SearchWindow(t){const[ee,te]=h$1("all"),[ne,oe]=h$1("best"),[ie,_e]=h$1(void 0),[se,re]=h$1(!1),ae=o$1(default_1$g,{titleAccess:"You might be getting sub optimal search results!",style:{color:yellow[600]}}),ce=()=>ne=="best"&&ee=="all";return o$1(Modal,{on_close:()=>t.on_blur&&t.on_blur(),title:t.search_window_title,child:o$1(Box,{p:5,children:[o$1(Accordion,{onChange:(de,ue)=>{re(ue)},children:[o$1(AccordionSummary,{expandIcon:!ce()&&!se?ae:o$1(default_1$i,{}),children:o$1(Typography,{component:"h2",children:[se?"Hide ":"Show ","Advanced Search Options"]})}),o$1(AccordionDetails,{children:o$1(Box,{width:1,children:[o$1(Box,{display:"flex",justifyContent:"flex-start",alignItems:"stretch",children:[o$1(Box,{mr:10,flexGrow:1,flexShrink:0,children:o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,children:[o$1(FormLabel,{component:"legend",children:"Search Type: "}),o$1(RadioGroup,{name:"search_type",value:ne,onChange:de=>oe(de.target.value),children:[o$1(FormControlLabel,{value:"exact",control:o$1(Radio,{}),label:"Exact"}),o$1(FormControlLabel,{value:"fuzzy",control:o$1(Radio,{}),label:"Fuzzy"}),o$1(FormControlLabel,{value:"best",control:o$1(Radio,{}),label:"Best"})]})]})}),o$1(Box,{mr:10,flexGrow:1,flexShrink:0,children:o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,children:[o$1(FormLabel,{component:"legend",children:"Search Over: "}),o$1(RadioGroup,{name:"search_fields",value:ee,onChange:de=>te(de.target.value),children:[o$1(FormControlLabel,{value:"all",control:o$1(Radio,{}),label:"All"}),o$1(FormControlLabel,{value:"title",control:o$1(Radio,{}),label:"Title Only"})]})]})}),o$1(Box,{flexGrow:1,flexShrink:0,alignSelf:"flex-end",textAlign:"right",children:!ce()&&o$1(Button$2,{variant:"contained",color:"primary",onClick:()=>{oe("best"),te("all")},endIcon:o$1(default_1$h,{}),children:"Reset Search Options"})})]}),o$1(Box,{style:{opacity:ie?.7:0},children:["Used: ",ie]})]})})]}),o$1(AutocompleteText,{placeholder:t.placeholder,selected_option_id:t.selected_option_id,initial_search_term:t.initial_search_term,options:t.options,allow_none:t.allow_none,on_change:de=>{t.on_change(de),t.on_blur&&t.on_blur()},on_mouse_over_option:t.on_mouse_over_option,on_mouse_leave_option:t.on_mouse_leave_option,extra_styles:t.extra_styles,start_expanded:!0,retain_invalid_search_term_on_blur:!0,search_fields:ee,search_type:ne,set_search_type_used:_e,editing_allowed:!0,threshold_minimum_score:-1e3})]})})}const map_state$1r=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}),connector$1t=connect(map_state$1r);function _WComponentSearchWindow(t){const ee=get_wcomponent_search_options(t);return o$1(SearchWindow,{search_window_title:"Search for a Component",placeholder:"Search for a Component...",selected_option_id:"",initial_search_term:t.initial_search_term,allow_none:!0,options:ee,on_change:t.on_change,on_blur:t.on_blur})}const WComponentSearchWindow=connector$1t(_WComponentSearchWindow);function ConditionalWComponentSearchWindow(t){const{value:ee,id_insertion_point:te,conditional_on_change:ne,on_close:oe}=t,ie=get_initial_search_term({value:ee,id_insertion_point:te}),_e=_$d(!1);return o$1(WComponentSearchWindow,{initial_search_term:ie,on_change:se=>{const re=insert_id_into_text({value:ee,id_to_insert:se,id_insertion_point:te}),ae=te+((se==null?void 0:se.length)||0),ce=ae+((ie==null?void 0:ie.length)||0),de={start:ae,end:ce};_e.current=!0,ne({new_value:re,on_focus_set_selection:de})},on_blur:()=>{if(_e.current)return;const se=te+((ie==null?void 0:ie.length)||0);oe({start:te,end:se})}})}function get_initial_search_term(t){const te=t.value.slice(t.id_insertion_point).match(/^(\w+)/);return te&&te[1]||""}function insert_id_into_text(t){const{value:ee,id_to_insert:te,id_insertion_point:ne}=t;return te===void 0?ee:ee.slice(0,ne)+te+ee.slice(ne)}var EditableTextOnBlurType=(t=>(t[t.conditional=0]="conditional",t[t.always=1]="always",t))(EditableTextOnBlurType||{});const map_state$1q=t=>({presenting:t.display_options.consumption_formatting,use_creation_context:t.creation_context.use_creation_context,creation_context:t.creation_context.creation_context}),connector$1s=connect(map_state$1q);function _EditableTextCommon(t){const{placeholder:ee,disabled:te,presenting:ne,editing_allowed:oe,select_all_on_focus:ie,force_focus_on_first_render:_e,on_blur_type:se=0}=t,[re,ae]=h$1(t.value);p$1(()=>ae(t.value),[t.value]);const ce=_$d(void 0),de=_$d(void 0);if(oe===!1||!t.conditional_on_change&&!t.on_blur||te||ne&&oe===void 0){const $e=te?"disabled":"",Se=t.value!==void 0;return o$1("div",{className:$e,children:[Se&&!t.hide_label&&o$1("span",{className:"description_label",children:[t.placeholder," "]}),o$1(RichMarkDown,{text:re||ee})]})}const ue=`editable_field ${re?"":"placeholder"}`,le=F$1(()=>$e=>{if(!$e)return;const Se=!ce.current;ce.current=$e,Se&&handle_text_field_render({el:$e,force_focus_on_first_render:_e})},[]),pe=F$1(()=>$e=>{handle_text_field_focus({e:$e,select_all_on_focus:ie})},[ie]),me=F$1(()=>$e=>{t.use_creation_context&&($e=custom_creation_context_replace_text(t.creation_context,$e)),$e!==t.value&&t.conditional_on_change&&t.conditional_on_change($e),ae($e)},[t.value,t.creation_context,t.conditional_on_change]),fe=F$1(()=>$e=>{t.use_creation_context&&($e=custom_creation_context_replace_text(t.creation_context,$e)),t.modify_value_pre_on_blur&&($e=t.modify_value_pre_on_blur($e));const Se=$e!==t.value;(se===1||Se)&&t.on_blur&&t.on_blur($e),ae($e)},[t.value,t.creation_context,se,t.on_blur]),ge=F$1(()=>$e=>{if(de.current!==void 0)return;const Se=get_id_insertion_point($e.currentTarget);Se!==void 0&&(de.current=Se),me($e.currentTarget.value)},[me]),he=F$1(()=>$e=>{de.current===void 0&&fe($e.currentTarget.value)},[t.value,fe]),be=F$1(()=>$e=>{handle_general_key_down($e,ce.current,me,fe)},[me,fe]),ve=_$d(fe);ve.current=fe,p$1(()=>()=>{!ce.current||!(document.activeElement===ce.current)||ve.current(ce.current.value)},[]);const[we,ye]=h$1({}),ke=F$1(()=>$e=>{var Se,Te;(Se=ce.current)==null||Se.focus(),de.current=void 0,ye({}),(Te=ce.current)==null||Te.setSelectionRange($e.start,$e.end)},[]),Ae=F$1(()=>t.component({value:re,on_render:le,on_focus:pe,on_change:ge,on_blur:he,on_key_down:be}),[re,le,pe,ge,he]);return o$1("div",{className:ue,style:t.style,children:[Ae,de.current!==void 0&&o$1("div",{style:{fontSize:"initial",fontWeight:"initial"},children:o$1(ConditionalWComponentSearchWindow,{value:re,id_insertion_point:de.current,conditional_on_change:({new_value:$e,on_focus_set_selection:Se})=>{me($e),setTimeout(()=>ke(Se),0)},on_close:$e=>{ke($e)}})})]})}const EditableTextCommon=connector$1s(_EditableTextCommon);function handle_text_field_render(t){t.force_focus_on_first_render&&setTimeout(()=>t.el.focus(),0)}function handle_text_field_focus(t){if(t.select_all_on_focus){const ee=t.e.currentTarget;ee.setSelectionRange(0,ee.value.length)}}function handle_general_key_down(t,ee,te,ne){document.activeElement===ee&&ee&&(handle_ctrl_k_link_insert(t,ee,te),handle_stop_propagation(t,ee,ne))}function handle_ctrl_k_link_insert(t,ee,te){if(!t.ctrlKey||t.key!=="k")return;t.preventDefault();const{value:ne,selectionStart:oe}=ee;let{selectionEnd:ie}=ee;if(typeof oe!="number")return;typeof ie!="number"&&(ie=oe);const _e=ne.slice(oe,ie),se=_e?_e.startsWith("http")?0:1:2,re=se===1?_e:"title",ae=se===0?_e:"url",ce=ne.slice(0,oe)+"["+re+"]("+ae+")"+ne.slice(ie);te(ce);let de=oe+1,ue=de+re.length;se===1&&(de=ie+3,ue=de+ae.length),setTimeout(()=>ee.setSelectionRange(de,ue),0)}function handle_stop_propagation(t,ee,te){if(t.ctrlKey&&t.key==="e"){te(ee.value);return}t.key!=="Shift"&&t.key!=="Control"&&t.stopImmediatePropagation()}function get_id_insertion_point({selectionStart:t,value:ee}){if(typeof t=="number"){const te=ee[t-2],ne=ee[t-1];if(te==="@"&&ne==="@"&&get_store().getState().global_keys.last_key==="@")return t}}function custom_creation_context_replace_text(t,ee){return t!=null&&t.replace_text_target&&(t!=null&&t.replace_text_replacement)&&(ee=ee.replaceAll(t.replace_text_target,t.replace_text_replacement)),ee}function EditableTextSingleLine(t){const ee=F$1(()=>({value:te,on_render:ne,on_focus:oe,on_change:ie,on_blur:_e,on_key_down:se})=>o$1(TextField,{fullWidth:!0,label:t.placeholder,variant:"outlined",value:te,onFocus:oe,onChange:ie,onBlur:_e,onKeyDown:se,size:t.size,inputRef:ne,spellcheck:t.spellcheck,disabled:t.disabled_input,title:t.title}),[t.placeholder,t.size,t.spellcheck,t.disabled_input,t.title]);return o$1(EditableTextCommon,{...t,component:ee})}const map_state$1p=t=>({editing:!t.display_options.consumption_formatting}),connector$1r=connect(map_state$1p);function _EditableNumber(t){const ee=t.value!==void 0?t.value.toString():"",{allow_undefined:te,conditional_on_change:ne,on_blur:oe,on_blur_type:ie,disabled:_e,editing:se,default_value_when_invalid:re=0,editing_allowed:ae}=t;let ce="editable_number";if(!se||!ne&&!oe||_e){ce=ce+(se?"":" not_editable ")+(_e?" disabled ":"");const de=t.value!==void 0;return o$1("div",{className:ce,style:t.style,children:[de&&o$1("span",{className:"description_label",children:t.placeholder})," ",de?t.value:t.placeholder]})}return o$1("div",{className:ce,style:t.style,children:o$1(EditableTextSingleLine,{placeholder:t.placeholder,size:t.size||"small",style:t.style,value:ee,editing_allowed:ae,select_all_on_focus:!0,conditional_on_change:de=>{if(!ne)return;const ue=string_to_number(de,re);(on_event_handler_accepts_undefined(ne,te)||ue!==void 0)&&ne(ue)},on_blur:de=>{oe&&handle_blur({value:de,default_value_when_invalid:re,on_blur:oe,allow_undefined:te})},on_blur_type:ie||EditableTextOnBlurType.conditional})})}const EditableNumber=connector$1r(_EditableNumber);function string_to_number(t,ee){if(!t)return;const te=parseFloat(t);return Number.isNaN(te)?ee:te}function on_event_handler_accepts_undefined(t,ee){return!!ee}function handle_blur({value:t,default_value_when_invalid:ee,on_blur:te,allow_undefined:ne}){let oe=string_to_number(t,ee);on_event_handler_accepts_undefined(te,ne)||oe===void 0&&(oe=ee),te(oe)}const map_state$1o=t=>({editing:!t.display_options.consumption_formatting}),map_dispatch$V={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1q=connect(map_state$1o,map_dispatch$V);function _PrioritisableGoal(t){var _e;const{goal:ee,selected_prioritisation:te,editing:ne}=t,oe=te&&te.goals||{},ie=(_e=oe[ee.id])==null?void 0:_e.effort;return o$1("div",{style:{display:"flex"},children:[o$1(WComponentCanvasNode,{id:ee.id,is_on_canvas:!1,always_show:!0}),te&&(ne||!!ie)&&o$1("div",{children:[o$1("br",{}),o$1(EditableNumber,{placeholder:"Effort",allow_undefined:!0,value:ie,on_blur:se=>{const re={...oe};se===void 0?delete re[ee.id]:re[ee.id]={effort:se};const ae={...te,goals:re};t.upsert_wcomponent({wcomponent:ae})},on_blur_type:EditableTextOnBlurType.conditional})]})]})}const PrioritisableGoal=connector$1q(_PrioritisableGoal);function get_next_available_wc_map_position(t,ee,te,ne=v_step){const oe={left:0,top:0};if(!t||!ee)return oe;const ie=t[ee];if(!ie)return oe;const _e=get_wc_position_to_id_map(t,te);let se=ie;const re={left:ie.left,top:ie.top};for(;se;){re.top+=ne;const ae=wc_map_entry_to_coord_key(re),de=(_e[ae]||[])[0];se=de?t[de]:void 0}return re}function PrioritiesListView(t){return o$1(MainArea,{main_content:o$1(PrioritiesListViewContent,{})})}const map_state$1n=t=>{const ee=t.specialised_objects.wcomponents_by_id,te=get_current_composed_knowledge_view_from_state(t),ne=[];let oe,ie;if(te){te.wc_ids_by_type.has_objectives.forEach(se=>{const re=ee[se];wcomponent_has_objectives(re,se)&&ne.push(re)}),oe=te.prioritisations;const{item_id:_e}=t.routing;ie=oe.find(({id:se})=>se===_e),Object.keys((ie==null?void 0:ie.goals)||{}).forEach(se=>{if(te.wc_ids_by_type.has_objectives.has(se))return;const re=ee[se];wcomponent_has_objectives(re,se)&&ne.push(re)})}return{composed_knowledge_view:te,goals_and_actions:ne,prioritisations:oe,selected_prioritisation:ie,base_id:selector_chosen_base_id(t),wcomponents_by_id:ee,display_side_panel:t.controls.display_side_panel}},map_dispatch$U={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1p=connect(map_state$1n,map_dispatch$U);function _PrioritiesListViewContent(t){const{goals_and_actions:ee,prioritisations:te,composed_knowledge_view:ne,selected_prioritisation:oe,base_id:ie,wcomponents_by_id:_e}=t,se=ne==null?void 0:ne.id,re=(ne==null?void 0:ne.composed_wc_id_map)||{},ae=oe==null?void 0:oe.goals,{potential_goals:ce,prioritised_goals:de,deprioritised_goals:ue}=partition_and_sort_goals(ee,ae);return ie===void 0?o$1("div",{children:"No base id chosen"}):o$1("div",{className:"priorities_list_view_content",children:[o$1("div",{className:"priorities_list goals",children:[o$1("h1",{children:"Potential"}),ce.map(le=>o$1(PrioritisableGoal,{goal:le,selected_prioritisation:oe},le.id)),o$1("h1",{children:"Deprioritised"}),ue.map(le=>o$1(PrioritisableGoal,{goal:le,selected_prioritisation:oe},le.id))]}),o$1("div",{className:"priorities_list goals",children:[o$1("h1",{children:"Prioritised"}),de.map(le=>o$1(PrioritisableGoal,{goal:le,selected_prioritisation:oe},le.id))]}),o$1("div",{className:"priorities_list prioritisations",children:[o$1("h1",{children:["Prioritisations",se&&o$1("span",{className:"button_add_new",children:[" ",o$1(Button,{fullWidth:!1,onClick:le=>{var fe;const pe=((fe=(te||[])[0])==null?void 0:fe.id)||"",me=get_next_available_wc_map_position(re,pe,_e);create_wcomponent({wcomponent:{base_id:ie,type:"prioritisation",goals:ae||{},description:(oe==null?void 0:oe.description)||""},add_to_knowledge_view:{id:se,position:me}})},children:ae?"Copy":"Add"})]})]}),o$1("div",{className:"prioritisations_list",children:(te||[]).map(le=>o$1(Prioritisation,{prioritisation:le}))})]}),o$1("div",{className:"side_panel_padding",style:{minWidth:t.display_side_panel?SIDE_PANEL_WIDTH:0}})]})}const PrioritiesListViewContent=connector$1p(_PrioritiesListViewContent);function partition_and_sort_goals(t,ee){let te=[],ne=[],oe=[];return ee?t.forEach(ie=>{const _e=ee[ie.id];_e?_e.effort>0?ne.push(ie):oe.push(ie):te.push(ie)}):te=t,te=sort_list(te,get_created_at_ms,SortDirection.descending),ne=sort_list(ne,factory_get_effort(ee),SortDirection.descending),oe=sort_list(oe,get_created_at_ms,SortDirection.descending),{potential_goals:te,prioritised_goals:ne,deprioritised_goals:oe}}function factory_get_effort(t){return ee=>{var te;return((te=(t||{})[ee.id])==null?void 0:te.effort)||0}}const map_state$1m=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),map_dispatch$T={change_route:ACTIONS.routing.change_route},connector$1o=connect(map_state$1m,map_dispatch$T);function _WComponentsList(t){const{wcomponent_ids:ee=[],wcomponents_by_id:te,knowledge_views_by_id:ne}=t,oe=ee.map(re=>te[re]).filter(is_defined),ie={},_e=new Date().getTime(),se=_e;return o$1("table",{class:"list",children:o$1("tbody",{children:oe.map(re=>o$1("tr",{style:{cursor:"pointer"},onClick:()=>t.change_route({item_id:re.id}),children:get_title$1({wcomponent:re,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:ie,created_at_ms:_e,sim_ms:se})}))})})}const WComponentsList=connector$1o(_WComponentsList),map_state$1l=t=>({action_ids_to_show:t.view_priorities.action_ids_to_show,date_shown:t.view_priorities.date_shown}),map_dispatch$S={set_action_ids_to_show:ACTIONS.view_priorities.set_action_ids_to_show},connector$1n=connect(map_state$1l,map_dispatch$S);function _WComponentActionsListModal(t){if(t.action_ids_to_show.length===0)return null;let ee="Actions";return t.date_shown&&(ee+=` (${date2str(t.date_shown,"yyyy-MMM-dd")})`),o$1(Modal,{on_close:()=>t.set_action_ids_to_show({action_ids:[]}),title:ee,child:o$1(WComponentsList,{wcomponent_ids:t.action_ids_to_show})})}const WComponentActionsListModal=connector$1n(_WComponentActionsListModal),map_dispatch$R={set_action_ids_to_show:ACTIONS.view_priorities.set_action_ids_to_show},connector$1m=connect(null,map_dispatch$R);function _DailyActionNode(t){const{x:ee,y:te,width:ne,height:oe,display:ie,action_ids:_e,date_shown:se}=t;return o$1(CanvasNode,{position:{width:ne,height:oe,left:ee,top:te},display:ie,extra_styles:{backgroundColor:"orange",borderRadius:"2px",border:"thin solid #777",overflow:"hidden",fontSize:"7px",textAlign:"center"},on_click:()=>t.set_action_ids_to_show({action_ids:_e,date_shown:se}),children:_e.length})}const DailyActionNode=connector$1m(_DailyActionNode),PrioritisationEntryNode$1="",map_state$1k=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,created_at_ms:t.routing.args.created_at_ms}),map_dispatch$Q={change_route:ACTIONS.routing.change_route},connector$1l=connect(map_state$1k,map_dispatch$Q);function _PrioritisationEntryNode(t){const{wcomponents_by_id:ee,knowledge_views_by_id:te,created_at_ms:ne,x:oe,y:ie,width:_e,effort:se,display:re}=t,ae=ee[t.wcomponent_id];if(!ae)return null;const ce=get_title$1({wcomponent:ae,wcomponents_by_id:ee,knowledge_views_by_id:te,wc_id_to_counterfactuals_map:void 0,created_at_ms:ne,sim_ms:new Date().getTime()}),de=Math.max(_e,60),ue=Math.max(_e,250),[le,pe]=h$1(de),me=`${Math.round(se*100)}%`,ge={backgroundImage:`linear-gradient(to top, #a6eaff ${me}, rgba(0,0,0,0) ${me})`,backgroundColor:"white"};return o$1(CanvasNode,{position:{left:oe,top:ie,width:le},display:re,on_pointer_down:he=>{he.stopImmediatePropagation(),he.preventDefault(),t.change_route({item_id:t.wcomponent_id})},on_pointer_enter:()=>pe(ue),on_pointer_leave:()=>pe(de),extra_css_class:" prioritisation_entry ",children:o$1("div",{className:"node_main_content",style:ge,children:[" ",o$1("span",{title:ce,children:o$1(Markdown,{options:MARKDOWN_OPTIONS,children:ce})}),o$1("div",{children:[o$1("br",{}),o$1("span",{style:{color:"grey",fontSize:10},children:["  ",se>0&&`Effort ${me}`]})]})]})})}const PrioritisationEntryNode=connector$1l(_PrioritisationEntryNode);function cloneable_generator_factory(t,ee,te=[]){let ne=ee(t);const oe={next:(...ie)=>(te.push(ie),ne.next(...ie)),throw:ie=>ne.throw(ie),return:ie=>ne.return(ie),[Symbol.iterator]:()=>oe,clone:()=>{const ie=[...te].map(_e=>[..._e]);return cloneable_generator_factory(t,ee,ie)}};return te.forEach(ie=>ne.next(...ie)),oe}const test_cloneable_generator_factory=describe.delay("cloneable_generator_factory",()=>{function*t(ne){let oe=ne.start;for(;;){let ie=yield++oe;ie!==void 0&&(oe+=ie)}}let ee=cloneable_generator_factory({start:10},t);test(ee.next().value,11,"should increment"),test(ee.next(3).value,11+1+3,"should use jump");let te=ee.clone();test(ee.next().value,16,"should increment again"),test(ee.next(10).value,16+1+10,"should jump again"),test(te.next().value,16,"should have been reset"),test(te.next().value,17,"should not use previous jump"),test(te.next(-10).value,17+1-10,"should jump on second branch"),test(ee.next().value,28,"should jump a third time on first branch")});function random_int(t){return parseInt(`${Math.random()}`.slice(2,2+t),10)}function prepare_args_for_actions_parent_ids(t){const{all_action_ids:ee,all_goal_ids:te,wcomponents_by_id:ne}=t,oe=Array.from(ee).map(re=>ne[re]).filter(wcomponent_is_action),ie={};oe.forEach(re=>ie[re.id]=re);const _e=Array.from(te).map(re=>ne[re]).filter(wcomponent_is_goal),se={};return _e.forEach(re=>se[re.id]=re),{actions_by_id:ie,goals_by_id:se}}function*get_actions_parent_ids(t){const{action:ee,actions_by_id:te,goals_by_id:ne}=t;let oe=ee,ie=[],_e=new Set([oe.id]);for(;;){(oe.parent_goal_or_action_ids||[]).forEach(de=>{if(_e.has(de)){console.warn(`Parent action/goal id already seen: "${de}".  May be circular, may just be a common ancestor.`);return}if(_e.add(de),!(te[de]||ne[de])){console.log(`Parent goal or action for id "${de}" not found.  Might be from another base?`);return}ie.push(de)});const se=ie.length>0;if((yield oe.id)||!se)return;const ae=ie.shift();if(!ae)return;const ce=te[ae]||ne[ae];if(!ce)return;oe=ce}}const test_get_actions_parent_ids=describe.delay("get_actions_parent_ids",()=>{function t(oe,ie=[]){return prepare_new_contextless_wcomponent_object({type:"goal",base_id:-1,title:oe,id:oe+` ${random_int(4)}`,parent_goal_or_action_ids:ie})}function ee(oe,ie=[]){return prepare_new_contextless_wcomponent_object({type:"action",base_id:-1,title:oe,id:oe+` ${random_int(4)}`,parent_goal_or_action_ids:ie})}function te(oe){const ie={},_e=new Set,se=new Set;return oe.forEach(re=>{ie[re.id]=re,re.type==="action"?_e.add(re.id):se.add(re.id)}),prepare_args_for_actions_parent_ids({all_action_ids:_e,all_goal_ids:se,wcomponents_by_id:ie})}function ne(oe,ie){const _e={action:oe,...te(ie)};return cloneable_generator_factory(_e,get_actions_parent_ids)}describe("No parents only self",()=>{const oe=ee("action0",[]),_e=ne(oe,[oe]).next();test(_e.value,oe.id,"Should return own id"),test(_e.done,!1,"Should have no more ids")}),describe("Branching parents grandparents",()=>{const oe=t("goal1"),ie=t("goal2"),_e=t("goal3"),se=t("subgoal2&3",[ie.id,_e.id]),re=ee("action1",[oe.id,se.id]);let ae=ne(re,[re,oe,ie,_e,se]),ce=ae.next();test(ce.value,re.id,"Should return own id"),test(ce.done,!1,"Should have more ids ready");let de=ae.clone();ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was own id and was also consumed"),test(ce.done,!0,"Should have no more ids ready when last id was own id and was also consumed"),ae=de,ce=ae.next(!1),test(ce.value,oe.id,"Should return next parent id, when last was own id and was not consumed"),de=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=de,ce=ae.next(!1),test(ce.value,se.id,"Should return next parent id, when last was not consumed but there is a sibling id"),de=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=de,ce=ae.next(!1),test(ce.value,ie.id,"Should return next parent id, when last was not consumed but there is a grandparent"),de=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=de,ce=ae.next(!1),test(ce.value,_e.id,"Should return next parent id, when last was not consumed and there is a grandparent sibling"),de=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=de,ce=ae.next(!1),test(ce.value,void 0,"Should return undefined when exhausted parent and grandparent ids"),test(ce.done,!0,"Should have no more ids")}),describe("get_actions_parent_ids should work if parents are also actions, and not just for parents that are goals",()=>{const oe=ee("action1"),ie=ee("action2"),_e=ee("action3"),se=ee("subaction2&3",[ie.id,_e.id]),re=ee("action1",[oe.id,se.id]);let ae=ne(re,[oe,ie,_e,se,re]),ce=ae.next();test(ce.value,re.id,"Should return own id"),ce=ae.next(),test(ce.value,oe.id,"Should return next id"),ce=ae.next(),test(ce.value,se.id,"Should return next id"),ce=ae.next(),test(ce.value,ie.id,"Should return next id"),ce=ae.next(),test(ce.value,_e.id,"Should return next id"),ce=ae.next(),test(ce.value,void 0,"Should return no more ids"),test(ce.done,!0,"Should be done")}),describe("Circular parents",()=>{const oe=t("goal1"),ie=ee("action1",[oe.id]);oe.parent_goal_or_action_ids=[ie.id];const _e=ee("action2",[oe.id]);let se=ne(_e,[ie,_e,oe]),re=se.next();test(re.value,_e.id,"Should return own id"),test(re.done,!1,"Should have more ids ready"),re=se.next(),test(re.value,oe.id,"Should return next id"),test(re.done,!1,"Should have more ids ready"),re=se.next(),test(re.value,ie.id,"Should return next id"),test(re.done,!1,"Should have not finished"),re=se.next(),test(re.done,!0,"Should have finished")}),describe("Spread iterator containing one parent",()=>{const oe=t("goal1"),ie=ee("action1",[oe.id]),se=[...ne(ie,[ie,oe])];test(se,[ie.id,oe.id],"Should return both ids")})}),VALID_ACTION_VALUE_POSSIBILITY_ID=new Set(Object.values(ACTION_VALUE_POSSIBILITY_ID));function get_action_active_date_ranges(t){let ee=t.values_and_prediction_sets||[];ee=group_versions_by_id(ee).latest,ee=sort_by_uncertain_event_datetimes(ee,SortDirection.ascending);let te,ne;const oe=[];if(ee.forEach(ie=>{const{entries:_e,datetime:se}=ie,ae=get_most_probable_VAPs(_e,VAPsType.action).filter(ue=>ue.probability>0&&ue.value_id&&VALID_ACTION_VALUE_POSSIBILITY_ID.has(ue.value_id)),ce=ae[0];if(ae.length!==1||!ce){console.log(`Skipping calculating action_active_date_ranges for VAP_set "${ie.id}" of action "${t.id}"`);return}ce.value_id===ACTION_VALUE_POSSIBILITY_ID.action_in_progress?te||(te=get_uncertain_datetime(se)):te&&(ne=get_uncertain_datetime(se)),te&&ne&&(oe.push({start:te,stop:ne}),te=void 0,ne=void 0)}),te){let ie=new Date;ie.getTime()<te.getTime()&&(ie=te),oe.push({start:te,stop:ie})}return oe}function get_action_active_date_strs(t){const ee=get_action_active_date_ranges(t);let te=[],ne=new Set;return ee.forEach(oe=>{const _e=get_inclusive_date_strs(oe.start,oe.stop).filter(se=>!ne.has(se));te=te.concat(_e),ne=new Set(te)}),te}const map_state$1j=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=ee==null?void 0:ee.prioritisations,{action:ne,goal:oe}=t.derived.wcomponent_ids_by_type,ie=ee==null?void 0:ee.composed_datetime_line_config;return{prioritisations:te,time_origin_ms:ie==null?void 0:ie.time_origin_ms,time_origin_x:ie==null?void 0:ie.time_origin_x,time_scale:ie==null?void 0:ie.time_scale,presenting:t.display_options.consumption_formatting,all_action_ids:ne,all_goal_ids:oe,wcomponents_by_id:t.specialised_objects.wcomponents_by_id}},connector$1k=connect(map_state$1j),get_svg_children=t=>[];function has_start_date(t){return!!t.start_date}const get_children=t=>{const{prioritisations:ee=[],all_action_ids:te,all_goal_ids:ne,wcomponents_by_id:oe}=t,ie=F$1(()=>process_prioritisations(ee),[ee]),{denormalised_prioritisation_by_id:_e,prioritised_goals_and_actions:se}=ie,re=F$1(()=>process_actions({all_action_ids:te,all_goal_ids:ne,wcomponents_by_id:oe,prioritised_goals_and_actions:se}),[te,ne,oe,se]),{time_origin_ms:ae,time_origin_x:ce,time_scale:de}=default_time_origin_parameters(t),ue=F$1(()=>convert_prioritised_goals_and_actions_to_nodes({denormalised_prioritisation_by_id:_e,prioritised_goals_and_actions:se,time_origin_ms:ae,time_origin_x:ce,time_scale:de}),[_e,se,ae,ce,de]),le=F$1(()=>convert_daily_actions_to_nodes({date_str_to_daily_actions_map:re,time_origin_ms:ae,time_origin_x:ce,time_scale:de,prioritised_goals_and_actions:se}),[re,ae,ce,de,se]);return[...ue,...le]},get_overlay_children=()=>o$1(KnowledgeGraphTimeMarkers,{force_display:!0,show_by_now:!0});function _PrioritiesView(t){const ee=get_children(t);return o$1(MainArea,{main_content:o$1(Canvas,{svg_children:get_svg_children(),svg_upper_children:[],overlay:get_overlay_children(),plain_background:t.presenting,children:ee}),extra_content:o$1(WComponentActionsListModal,{})})}const PrioritiesView=connector$1k(_PrioritiesView),UNCATEGORISED_PRIORITY_ID="UNCATEGORISED_PRIORITY_ID";function process_prioritisations(t){const ee=new Date;let te=t.map(se=>({...se,total_effort:0,start_date:get_uncertain_datetime(se.datetime),end_date:ee})).filter(has_start_date);te=sort_list(te,se=>se.start_date.getTime(),SortDirection.ascending),te.forEach((se,re)=>{const ae=te[re+1];se.end_date=get_uncertain_datetime(ae==null?void 0:ae.datetime)||ee});let ne=0;const oe={},ie=[];te.forEach(se=>{Object.entries(se.goals).forEach(([re,ae])=>{se.total_effort+=ae.effort;let ce=oe[re];ce===void 0&&(ce=ne++,oe[re]=ce),ie.push({prioritisation_id:se.id,goal_or_action_id:re,effort:ae.effort,offset_index:ce})})});const _e={};return te.forEach(se=>_e[se.id]=se),{denormalised_prioritisation_by_id:_e,prioritised_goals_and_actions:ie}}function process_actions(t){const{prioritised_goals_and_actions:ee}=t,te=new Set(ee.map(_e=>_e.goal_or_action_id)),ne={},oe=prepare_args_for_actions_parent_ids(t);return Object.values(oe.actions_by_id).forEach(_e=>{const se=[...get_actions_parent_ids({action:_e,...oe})];get_action_active_date_strs(_e).forEach(ae=>{const ce=ne[ae]||{prioritised_goal_or_action_ids_to_action_ids_map:{}};let de=!1;for(let ue=0;ue<se.length;++ue){const le=se[ue];if(te.has(le)){de=!0;const pe=ce.prioritised_goal_or_action_ids_to_action_ids_map[le]||[];pe.push(_e.id),ce.prioritised_goal_or_action_ids_to_action_ids_map[le]=pe}}if(!de){const ue=ce.prioritised_goal_or_action_ids_to_action_ids_map[UNCATEGORISED_PRIORITY_ID]||[];ue.push(_e.id),ce.prioritised_goal_or_action_ids_to_action_ids_map[UNCATEGORISED_PRIORITY_ID]=ue}ne[ae]=ce})}),ne}function convert_prioritised_goals_and_actions_to_nodes(t){const{denormalised_prioritisation_by_id:ee,prioritised_goals_and_actions:te,time_origin_ms:ne,time_origin_x:oe,time_scale:ie}=t;return te.map(({prioritisation_id:_e,goal_or_action_id:se,effort:re,offset_index:ae})=>{const{total_effort:ce,start_date:de,end_date:ue}=ee[_e],le=calculate_canvas_x_for_datetime({datetime:de,time_origin_ms:ne,time_origin_x:oe,time_scale:ie}),pe=calculate_canvas_x_for_datetime({datetime:ue,time_origin_ms:ne,time_origin_x:oe,time_scale:ie});return o$1(PrioritisationEntryNode,{effort:re/ce,wcomponent_id:se,x:le,y:100*ae,width:pe-le,display:!0})})}function convert_daily_actions_to_nodes(t){const{time_origin_ms:ee,time_origin_x:te,time_scale:ne,prioritised_goals_and_actions:oe}=t,ie={};oe.forEach(se=>{ie[se.goal_or_action_id]=se});const _e=[];return Object.entries(t.date_str_to_daily_actions_map).forEach(([se,re])=>{const ae=new Date(se),ce=calculate_canvas_x_for_datetime({datetime:ae,time_origin_ms:ee,time_origin_x:te,time_scale:ne});Object.entries(re.prioritised_goal_or_action_ids_to_action_ids_map).forEach(([de,ue])=>{const le=ie[de];let pe=-40;if(le)pe=100*le.offset_index+70;else if(de!==UNCATEGORISED_PRIORITY_ID)return;_e.push(o$1(DailyActionNode,{width:10,height:10,display:!0,x:ce,y:pe,action_ids:ue,date_shown:ae}))})}),_e}const KnowledgeTimeView$1="",map_state$1i=t=>{const{ready_for_reading:ee}=t.sync,{current_composed_knowledge_view:te}=t.derived;ee&&!te&&console.log("No current_composed_knowledge_view");const{selected_wcomponent_ids_to_ordinal_position_map:ne}=t.meta_wcomponents,{created_at_ms:oe,sim_ms:ie}=t.routing.args;let _e=[];return te&&(_e=te.wcomponent_nodes),{ready:ee,wcomponent_nodes:_e,wcomponent_connections:te&&te.wcomponent_connections,presenting:t.display_options.consumption_formatting,selected_wcomponent_ids_to_ordinal_position_map:ne,created_at_ms:oe,sim_ms:ie}},connector$1j=connect(map_state$1i);class DateRange{constructor(t,ee){Ne(this,"scale","months");Ne(this,"single_time_units",this._ms(1,!1));Ne(this,"scales",Object.keys(this.single_time_units));Ne(this,"dates",[]);Ne(this,"cdate",new Date);Ne(this,"sdate",new Date);Ne(this,"time_resolution","hour");Ne(this,"timeline_spacing",!0);t.length!==0&&(this.time_resolution="day",this.scale=this.time_resolution+"s",this.cdate=new Date(ee.created_at_ms),this.sdate=new Date(ee.sim_ms),this.dates=t.sort((te,ne)=>te.getTime()-ne.getTime()))}_ms(ms,convert=!0){const operator=convert?"/":"*";return{milliseconds:ms,get seconds(){return eval(`${ms} ${operator} 1000`)},get minutes(){return eval(`${this.seconds} ${operator} 60`)},get hours(){return eval(`${this.minutes} ${operator} 60`)},get days(){return eval(`${this.hours} ${operator} 24`)},get months(){return eval(`${this.days} ${operator} 365 / 12`)},get years(){return eval(`${this.days} ${operator} 365`)}}}get scale_index(){return this.scales.indexOf(this.scale)}increment(t,ee=1,te=this.scale){const ne=new Date(t.getTime()),oe=this.get_date_prop_func_names(te);return Object(ne)[oe.set](Object(ne)[oe.get]()+ee),ne}get range_dates(){const t=[],ee=this.round_date(this.increment(this.end_date,1),!0,this.scale),te=this.round_date(this.increment(this.start_date,-1),!1,this.scale);return t.push(te),t.push(ee),t}get start_date(){const t=this.dates.first();return ensure_date(t)}get end_date(){const t=this.dates.last();return ensure_date(t)}get range_start_date(){const t=this.range_dates.first();return ensure_date(t)}get range_end_date(){const t=this.range_dates.last();return ensure_date(t)}get_date_offset_percent(t){let ee=0;const te=t.getTime(),ne=this.range_start_date.getTime(),oe=this.range_end_date.getTime();return ee=(te-ne)/(oe-ne)*100,ee}get_date_prop_func_names(t){let ee,te=null;const ne=t.charAt(0).toUpperCase()+t.slice(1),oe=new Date,ie=`get${ne}`;switch(t){case"days":ee="getDate";break;default:Object(oe)[ie]?ee=ie:Object(oe)[ie.replace(/s$/,"")]&&(ee=ie.replace(/s$/,""))}return ee&&(te=ee.replace(/^get/,"set")),{get:ee,set:te}}round_date(t,ee=!1,te=this.scale){const ne=new Date(t.getTime());return this.scales.forEach((oe,ie)=>{const _e=this.get_date_prop_func_names(oe),se=oe==="days"?1:0;ee?ie===this.scale_index?Object(ne)[_e.set](Object(ne)[_e.get]()+1):ie<this.scale_index&&Object(ne)[_e.set](se):ie<this.scale_index&&_e.set&&Object(ne)[_e.set]&&Object(ne)[_e.set](se)}),ee&&ne.setTime(ne.getTime()-1),ne}render(t){if(t.length===0)return null;const ee=new Date(this.range_start_date.getTime()),te=[];for(te.push(new Date(ee.getTime()));ee.getTime()<=this.range_end_date.getTime();){let oe=this.get_date_prop_func_names(this.scale),ie=Object(ee)[oe.get]();Object(ee)[oe.set](ie+1),te.push(new Date(ee.getTime()))}const ne=this.timeline_spacing?`${100+te.length*1.42}%`:"100%";return o$1(Box,{id:"knowledge_time_view",className:`time_view scroll_area_x ${this.scale} ${this.timeline_spacing?"timeline_spacing":"event_spacing"}`,flexGrow:1,flexShrink:1,position:"relative",onScroll:oe=>{let _e=oe.target.scrollLeft,se=document.getElementsByClassName("wc");for(let re=0;re<se.length;re++){const ae=se[re];ae&&(ae.style.marginLeft=`${_e}px`)}},children:[o$1(Box,{className:"timeline",display:this.timeline_spacing?"block":"none",height:1,maxHeight:1,position:"absolute",minWidth:ne,width:ne,maxWidth:ne,top:0,right:"auto",bottom:0,left:0,zIndex:1,children:o$1(Box,{width:1,maxWidth:1,height:1,maxHeight:1,display:"flex",flexDirection:"row",flexWrap:"wrap",children:te.map((oe,ie)=>o$1(Box,{className:"unit",flexGrow:1,flexShrink:1,flexBasis:"auto",position:"relative",overflow:"visible",children:o$1(Box,{position:"absolute",className:"tick",width:0,height:1,top:0,right:0,bottom:0,left:0,children:o$1(Box,{className:"rotater",whiteSpace:"nowrap",children:[o$1(Box,{component:"small",className:"days weeks months years",children:oe.toLocaleDateString()}),o$1(Box,{component:"small",className:"hours",children:oe.toLocaleTimeString()})]})})}))})}),o$1(Box,{minWidth:ne,width:ne,maxWidth:ne,minHeight:1,height:1,maxHeight:1,overflow:"hidden",children:o$1(Box,{className:"scroll_area_y",minWidth:"100%",maxWidth:"100%",position:"relative",zIndex:10,height:1,maxHeight:1,children:o$1(Box,{className:"contents",mt:this.timeline_spacing?50:0,children:t.map(oe=>{const ie=wcomponent_has_VAP_sets(oe)?oe.values_and_prediction_sets:[];return o$1(Box,{width:1,maxWidth:1,overflow:"hidden",position:"relative",children:[o$1(Box,{id:`WC-${oe.id}`,className:"wc",display:"inline-block",position:"relative",top:0,children:o$1(WComponentCanvasNode,{id:oe.id,is_on_canvas:!1})}),o$1(Box,{className:"vaps",width:1,maxWidth:1,overflow:"hidden",minHeight:"7em",height:"7em",maxHeight:"7em",p:this.timeline_spacing?0:3,position:"relative",display:`${this.timeline_spacing?"block":"flex"}`,flexDirection:"row",justifyContent:"start",children:ie.map(_e=>{const se=get_sim_datetime(_e);if(!se)return null;const re=this.get_date_offset_percent(se);return o$1(Box,{className:"vap",flexGrow:0,flexShrink:1,flexBasis:"auto",display:"inline-block",border:1,minHeight:"100%",height:"100%",maxHeight:"100%",position:`${this.timeline_spacing?"absolute":"static"}`,zIndex:1,left:`${re}%`,children:o$1(ConnectedValueAndPredictionSetSummary,{wcomponent:oe,VAP_set:_e})})})})]})})})})})]})}}function _KnowledgeTimeView(t){let{wcomponent_nodes:ee}=t;const{selected_wcomponent_ids_to_ordinal_position_map:te}=t,ne=[];ee=sort_list(ee,se=>{const re=te[se.id];return re!==void 0?re:get_created_at_ms(se)},SortDirection.ascending),ee.forEach(se=>{(wcomponent_has_VAP_sets(se)?se.values_and_prediction_sets:[]).forEach(ae=>{const ce=get_sim_datetime(ae);ce&&ne.push(ce)})});const _e=new DateRange(ne,t).render(ee);return o$1(MainArea,{main_content:_e||o$1(Box,{})})}const KnowledgeTimeView=connector$1j(_KnowledgeTimeView);function ensure_date(t){return t instanceof Date?t:new Date}const ActionsListView$1="";var Add={},_interopRequireDefault$f=interopRequireDefaultExports;Object.defineProperty(Add,"__esModule",{value:!0});var default_1$f=Add.default=void 0,_createSvgIcon$f=_interopRequireDefault$f(requireCreateSvgIcon()),_jsxRuntime$f=requireJsxRuntime(),_default$f=(0,_createSvgIcon$f.default)((0,_jsxRuntime$f.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),"Add");default_1$f=Add.default=_default$f;const AddNewActionButton$1="";function prepare_new_VAP_set(t,ee,te,ne,oe){const ie=get_new_created_ats(oe),_e=prepare_new_VAP_set_entries(t,ee,te),se=t===VAPsType.action?{value:new Date}:te.length>0?{value:new Date}:{};return{id:get_new_value_and_prediction_set_id(),...ie,base_id:ne,datetime:se,entries:_e}}function prepare_new_VAP_set_entries(t,ee,te){const oe=get_possibilities_from_VAP_sets(t,ee,te).map(_e=>({...prepare_new_VAP(),value:_e.value,value_id:_e.id,description:_e.description||""}));return set_VAP_probabilities(oe,t)}function create_new_VAP_set_version(t,ee){return{...t,...get_new_created_ats(ee),entries:t.entries.map(ne=>({...ne,explanation:""})),shared_entry_values:{...t.shared_entry_values,explanation:void 0}}}const test_prepare_new_VAP_set=describe.delay("prepare_new_VAP_set",()=>{const t=[{...prepare_new_VAP_set(VAPsType.other,void 0,[],1,{}),entries:[{...prepare_new_VAP(),value_id:"1",value:"a"},{...prepare_new_VAP(),value_id:"2",value:"b"}]},{...prepare_new_VAP_set(VAPsType.other,void 0,[],1,{}),entries:[{...prepare_new_VAP(),value_id:"1",value:"a"},{...prepare_new_VAP(),value_id:"2",value:"b"}]}],ee={1:{id:"1",value:"a",description:"",order:0},2:{id:"2",value:"b",description:"",order:1}};let te=prepare_new_VAP_set(VAPsType.other,ee,t,1,{});test(te.entries.length,2,"If there are only two unique possibilities, only return 2 VAPs")});function update_value_possibilities_with_VAPSets(t,ee){let te=get_max_value_possibilities_order(t);return t&&(t={...t}),ee.forEach(ne=>{ne.entries.forEach(oe=>{var _e;if(!oe.value_id)return;t=t||{};const ie=((_e=t[oe.value_id])==null?void 0:_e.order)??++te;t[oe.value_id]={id:oe.value_id,value:oe.value,description:oe.description,order:ie}})}),t}function update_VAP_set_VAP_probabilities(t,ee){return t.entries.map(te=>{const ne=te.value_id===ee?1:0;return{...te,relative_probability:ne,probability:ne,conviction:1}})}function set_action_VAP_set_state(t){const{existing_value_possibilities:ee,orig_values_and_prediction_sets:te,base_id:ne,creation_context:oe,action_value_possibility_id:ie}=t,_e=prepare_new_VAP_set(VAPsType.action,ee,te,ne,oe),se=update_VAP_set_VAP_probabilities(_e,ie);return _e.entries=se,[...te,_e]}function handle_update_VAP_sets(t){const ee=update_value_possibilities_with_VAPSets(t.existing_value_possibilities,t.new_values_and_prediction_sets);t.update_VAPSets_and_value_possibilities({value_possibilities:ee,values_and_prediction_sets:t.new_values_and_prediction_sets});const te=get_latest_VAP_set_datetimes_ms(t.orig_values_and_prediction_sets,t.current_created_at_ms),ne=get_latest_VAP_set_datetimes_ms(t.new_values_and_prediction_sets,t.current_created_at_ms),oe=1*60*1e3,ie=10*oe;let _e;ne.latest_created_at_ms>te.latest_created_at_ms&&(_e=ne.latest_created_at_ms+oe);const se=new Date().getTime(),re=ne.latest_sim_ms<se+oe&&ne.latest_sim_ms>se-ie;let ae;t.sim_ms<ne.latest_sim_ms&&re&&(ae=ne.latest_sim_ms),(_e!==void 0||ae!==void 0)&&t.change_route({args:{sim_ms:ae,created_at_ms:_e}})}function get_latest_VAP_set_datetimes_ms(t,ee=0){let te=Number.NEGATIVE_INFINITY;return t.forEach(ne=>{ee=Math.max(get_created_at_ms(ne),ee);const oe=get_uncertain_datetime(ne.datetime);oe&&(te=Math.max(oe.getTime(),te))}),{latest_created_at_ms:ee,latest_sim_ms:te}}const map_state$1h=t=>({creation_context:t.creation_context,composed_knowledge_view:get_current_composed_knowledge_view_from_state(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,base_id:selector_chosen_base_id(t)}),connector$1i=connect(map_state$1h);function _AddNewActionButton(t){const{most_recent_action_id:ee,composed_knowledge_view:te,wcomponents_by_id:ne,base_id:oe,list_type:ie,creation_context:_e}=t;if(!te)return null;const{id:se,composed_wc_id_map:re}=te,ae=F$1(()=>make_handle_click({base_id:oe,composed_wc_id_map:re,most_recent_action_id:ee,wcomponents_by_id:ne,list_type:ie,creation_context:_e,knowledge_view_id:se}),[oe,re,ee,ne,ie,_e,se]);return o$1(Button,{className:"add_new_action_button",fullWidth:!1,onClick:ae,disabled:oe===void 0,title:oe===void 0?"No knowledge base selected":"",children:o$1(default_1$f,{})})}const AddNewActionButton=connector$1i(_AddNewActionButton);function make_handle_click(t){const{base_id:ee,composed_wc_id_map:te,most_recent_action_id:ne,wcomponents_by_id:oe,list_type:ie,creation_context:_e,knowledge_view_id:se}=t;return function(){if(ee===void 0)throw new Error("No base_id defined in click for AddNewActionButton");const ae=get_next_available_wc_map_position(te,ne,oe);let ce=[];const de=ie==="todo",ue=ie==="in_progress",le=ie==="done";if((ue||le)&&(ce=set_action_VAP_set_state({existing_value_possibilities:void 0,orig_values_and_prediction_sets:[],base_id:ee,creation_context:_e,action_value_possibility_id:ACTION_VALUE_POSSIBILITY_ID.action_in_progress}),le)){let me=new Date;const fe=3600*1e3;me=new Date(me.getTime()-fe),ce[0].datetime.value=me}le&&(ce=set_action_VAP_set_state({existing_value_possibilities:void 0,orig_values_and_prediction_sets:ce,base_id:ee,creation_context:_e,action_value_possibility_id:ACTION_VALUE_POSSIBILITY_ID.action_completed}));const pe=update_value_possibilities_with_VAPSets(void 0,ce);create_wcomponent({wcomponent:{base_id:ee,type:"action",values_and_prediction_sets:ce,value_possibilities:pe,todo_index:de?new Date().getTime():void 0},add_to_knowledge_view:{id:se,position:ae}})}}var ArrowForward={},_interopRequireDefault$e=interopRequireDefaultExports;Object.defineProperty(ArrowForward,"__esModule",{value:!0});var default_1$e=ArrowForward.default=void 0,_createSvgIcon$e=_interopRequireDefault$e(requireCreateSvgIcon()),_jsxRuntime$e=requireJsxRuntime(),_default$e=(0,_createSvgIcon$e.default)((0,_jsxRuntime$e.jsx)("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward");default_1$e=ArrowForward.default=_default$e;var ArrowBack={},_interopRequireDefault$d=interopRequireDefaultExports;Object.defineProperty(ArrowBack,"__esModule",{value:!0});var default_1$d=ArrowBack.default=void 0,_createSvgIcon$d=_interopRequireDefault$d(requireCreateSvgIcon()),_jsxRuntime$d=requireJsxRuntime(),_default$d=(0,_createSvgIcon$d.default)((0,_jsxRuntime$d.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack");default_1$d=ArrowBack.default=_default$d;const PrioritisableAction$1="",map_state$1g=t=>({editing:!t.display_options.consumption_formatting}),map_dispatch$P={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1h=connect(map_state$1g,map_dispatch$P);function _PrioritisableAction(t){const{action:ee,upsert_wcomponent:te}=t;return o$1("div",{className:"prioritisable_action",children:[o$1(WComponentCanvasNode,{id:ee.id,is_on_canvas:!1,always_show:!0}),t.show_icebox_actions&&o$1("div",{className:"controls",children:o$1(IconButton,{size:"medium",onClick:()=>te({wcomponent:{...ee,todo_index:new Date().getTime()}}),children:o$1(default_1$e,{})})}),t.show_todo_actions&&o$1("div",{className:"controls",children:[o$1(IconButton,{size:"medium",onClick:()=>te({wcomponent:{...ee,todo_index:new Date().getTime()}}),children:o$1(default_1$u,{})}),o$1(IconButton,{size:"medium",onClick:()=>te({wcomponent:{...ee,todo_index:void 0}}),children:o$1(default_1$d,{})})]})]})}const PrioritisableAction=connector$1h(_PrioritisableAction);function ActionsListView(t){return o$1(MainArea,{main_content:o$1(ActionsListViewContent,{})})}const map_state$1f=t=>{const{wcomponents_by_id:ee}=t.specialised_objects;return{action_ids:get_action_ids_for_actions_list_view(t),wcomponents_by_id:ee,display_side_panel:t.controls.display_side_panel}},map_dispatch$O={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1g=connect(map_state$1f,map_dispatch$O);function _ActionsListViewContent(t){const{action_ids:ee,wcomponents_by_id:te}=t,[ne,oe]=h$1(5),[ie,_e]=h$1(void 0),se=_$d(void 0),re=_$d(void 0),ae=F$1(()=>{const he=get_wcomponents_from_ids(te,ee).filter(wcomponent_is_action);return sort_list(he,get_modified_or_created_at,SortDirection.descending)},[ee,te]),ce=[],de=[],ue=[],le=[],pe=new Date().getTime();ae.forEach(he=>{const ve=get_wcomponent_state_value_and_probabilities({wcomponent:he,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:pe,sim_ms:pe}).most_probable_VAP_set_values[0];(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_in_progress?ue.push(he):(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_completed||(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_rejected||(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_failed?le.push(he):he.todo_index?de.push(he):ce.push(he)});const me=le.length-ne,fe=sort_list(de,he=>he.todo_index||0,SortDirection.descending),ge=F$1(()=>{var ve;return((ve=(sort_list(ae,get_created_at_ms,SortDirection.descending)||[])[0])==null?void 0:ve.id)||""},[ae]);return o$1("div",{className:`action_list_view_content ${ie===void 0?"":"moving"}`,ref:he=>re.current=he||void 0,onPointerDown:he=>{const be=re.current;be&&(_e({x:he.clientX,y:he.clientY}),se.current={left:be.scrollLeft,top:be.scrollTop})},onPointerMove:he=>{if(ie===void 0||se.current===void 0||!re.current)return;const be=se.current.left-(he.clientX-ie.x),ve=se.current.top-(he.clientY-ie.y);re.current.scroll(be,ve)},onPointerUp:he=>_e(void 0),onPointerLeave:he=>_e(void 0),onPointerOut:he=>{let be=he.relatedTarget;be=find_parent_element_by_classes(be,["action_list","action_list_view_content"]),!be&&_e(void 0)},children:[o$1("div",{className:"action_list icebox",children:[o$1("h1",{children:["Icebox",o$1(AddNewActionButton,{list_type:"icebox",most_recent_action_id:ge})]}),ce.map(he=>o$1(PrioritisableAction,{action:he,show_icebox_actions:!0},he.id))]}),o$1("div",{className:"action_list todo",children:[o$1("h1",{children:["Todo",o$1(AddNewActionButton,{list_type:"todo",most_recent_action_id:ge})]}),fe.map(he=>o$1(PrioritisableAction,{action:he,show_todo_actions:!0},he.id))]}),o$1("div",{className:"action_list in_progress",children:[o$1("h1",{children:["In progress",o$1(AddNewActionButton,{list_type:"in_progress",most_recent_action_id:ge})]}),ue.map(he=>o$1(PrioritisableAction,{action:he},he.id))]}),o$1("div",{className:"action_list done_or_rejected",children:[o$1("h1",{children:["Done",o$1(AddNewActionButton,{list_type:"done",most_recent_action_id:ge})]}),le.slice(0,ne).map(he=>o$1(PrioritisableAction,{action:he},he.id)),me>0&&o$1("div",{style:{textAlign:"center",margin:40,cursor:"pointer"},onClick:()=>oe(ne+50),children:["... ",me," hidden ..."]})]}),o$1("div",{className:"side_panel_padding",style:{minWidth:t.display_side_panel?SIDE_PANEL_WIDTH:0}})]})}const ActionsListViewContent=connector$1g(_ActionsListViewContent);function get_modified_or_created_at(t){return t.modified_at?t.modified_at.getTime():get_created_at_ms(t)}const map_state$1e=t=>{const{view:ee}=t.routing.args,{display_by_simulated_time:te}=t.display_options;return{view:ee,display_by_simulated_time:te}},connector$1f=connect(map_state$1e);function _MainAreaRouter(t){let ee=o$1("div",{children:["Unsupported view: ",t.view]});return t.view==="knowledge"?t.display_by_simulated_time?ee=o$1(KnowledgeTimeView,{}):ee=o$1(KnowledgeGraphView,{}):t.view==="priorities"?ee=o$1(PrioritiesView,{}):t.view==="priorities_list"?ee=o$1(PrioritiesListView,{}):t.view==="actions_list"&&(ee=o$1(ActionsListView,{})),ee}const MainAreaRouter=connector$1f(_MainAreaRouter);var Menu={},_interopRequireDefault$c=interopRequireDefaultExports;Object.defineProperty(Menu,"__esModule",{value:!0});var default_1$c=Menu.default=void 0,_createSvgIcon$c=_interopRequireDefault$c(requireCreateSvgIcon()),_jsxRuntime$c=requireJsxRuntime(),_default$c=(0,_createSvgIcon$c.default)((0,_jsxRuntime$c.jsx)("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"}),"Menu");default_1$c=Menu.default=_default$c;const map_state$1d=t=>({use_creation_context:t.creation_context.use_creation_context}),map_dispatch$N={toggle_use_creation_context:ACTIONS.creation_context.toggle_use_creation_context},connector$1e=connect(map_state$1d,map_dispatch$N);function _CreationContextTabTitle(t){return o$1("div",{children:["Creation Context",o$1("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:t.use_creation_context,onClick:ee=>{ee.stopPropagation(),ee.preventDefault()},onPointerDown:ee=>{ee.stopPropagation(),ee.preventDefault(),t.toggle_use_creation_context()}})]})}const CreationContextTabTitle=connector$1e(_CreationContextTabTitle),map_state$1c=t=>({apply_filter:t.filter_context.apply_filter}),map_dispatch$M={set_apply_filter:ACTIONS.filter_context.set_apply_filter},connector$1d=connect(map_state$1c,map_dispatch$M);function _FilterContextTabTitle(t){return o$1("div",{children:["Filter",o$1("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:t.apply_filter,onClick:ee=>{ee.stopPropagation(),ee.preventDefault()},onPointerDown:ee=>{ee.stopPropagation(),ee.preventDefault(),t.set_apply_filter(!t.apply_filter)}})]})}const FilterContextTabTitle=connector$1d(_FilterContextTabTitle);function sentence_case(t){return t.slice(0,1).toUpperCase()+t.slice(1).toLowerCase()}function route_to_text(t){return t==="wcomponents"?"Components":t==="display"?"Display Options":t==="select"?"Selection":sentence_case(t.replaceAll("_"," "))}function get_title(t){return t==="filter"?o$1(FilterContextTabTitle,{}):t==="creation_context"?o$1(CreationContextTabTitle,{}):route_to_text(t)}const map_state$1b=t=>({current_route:t.routing.route}),map_dispatch$L={change_route:ACTIONS.routing.change_route},connector$1c=connect(map_state$1b,map_dispatch$L);function _AppMenuItem(t){const ee=()=>{t.on_pointer_down(),t.change_route({route:t.id,sub_route:null,item_id:null})},te=()=>(t.on_pointer_down(),!1),ne=get_title(t.id);return o$1(CustomisableAppMenuItem,{on_pointer_down:ee,children:o$1(Link,{route:t.id,sub_route:null,item_id:null,args:void 0,on_pointer_down:te,children:ne})})}const AppMenuItem=connector$1c(_AppMenuItem);function CustomisableAppMenuItem(t){return o$1(MenuItem,{style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},onPointerDown:ee=>{ee.stopImmediatePropagation(),t.on_pointer_down()},children:t.children})}const map_state$1a=t=>({route:t.routing.route,editing:!t.display_options.consumption_formatting}),map_dispatch$K={set_show_help_menu:ACTIONS.display.set_show_help_menu,change_route:ACTIONS.routing.change_route},connector$1b=connect(map_state$1a,map_dispatch$K),hide_routes=new Set(["objects","patterns","statements"]),base_allowed_routes=ALLOWED_ROUTES.filter(t=>!hide_routes.has(t));function _AppMenuItemsContainer(t){const[ee,te]=h$1(null),ne=re=>{te(re.currentTarget)},oe=()=>{te(null)},[ie,_e]=h$1(!1);let se=base_allowed_routes;if(!ie){const re=new Set(["about","creation_context"]);se=se.filter(ae=>!re.has(ae)||t.editing&&ae==="creation_context")}return o$1("div",{children:[o$1("div",{style:{display:"flex",flexDirection:"row"},children:[o$1(Button$2,{style:{display:"flex",flex:1},children:o$1("b",{style:{width:"100%",display:"flex"},onClick:()=>{t.change_route({route:t.route,item_id:null,sub_route:null})},children:route_to_text(t.route)})}),o$1(Button$2,{"aria-controls":"select_tab","aria-haspopup":"true",style:{display:"flex",flex:1,justifyContent:"end"},onClick:ne,children:o$1(default_1$c,{})})]}),o$1(Menu$1,{anchorEl:ee,id:"select_tab",onClose:oe,open:!!ee,keepMounted:!0,children:[se.map(re=>o$1(AppMenuItem,{id:re,on_pointer_down:oe})),o$1(CustomisableAppMenuItem,{on_pointer_down:()=>{oe(),t.set_show_help_menu({show:!0})},children:"Help"}),o$1(MenuItem,{onClick:()=>_e(!ie),style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},children:[ie?"Hide extra":"Show all"," options"]})]})]})}const AppMenuItemsContainer=connector$1b(_AppMenuItemsContainer),map_state$19=t=>({}),connector$1a=connect(map_state$19);function _AboutSidePanel(t){return o$1("div",{children:[o$1("span",{className:"description_label",children:"Version"})," ",o$1("b",{children:"2025-01-21"})]})}const AboutSidePanel=connector$1a(_AboutSidePanel);function EditableCheckbox(t){t.value;const{on_change:ee}=t,te=t.disabled||!ee;return o$1("input",{type:"checkbox",checked:t.value,disabled:te,style:{cursor:te?"not-allowed":""},onChange:ne=>{if(!ee)return;const oe=ne.currentTarget.checked;ee(oe)}})}function EditableText(t){return o$1(EditableTextCommon,{...t,component:({value:ee,on_render:te,on_focus:ne,on_change:oe,on_blur:ie,on_key_down:_e})=>o$1(TextField,{fullWidth:!0,size:"small",variant:"standard",label:t.placeholder,multiline:!0,value:ee,onFocus:ne,onChange:oe,onBlur:ie,onKeyDown:_e,inputRef:te,spellcheck:t.spellcheck})})}var Clear={},_interopRequireDefault$b=interopRequireDefaultExports;Object.defineProperty(Clear,"__esModule",{value:!0});var default_1$b=Clear.default=void 0,_createSvgIcon$b=_interopRequireDefault$b(requireCreateSvgIcon()),_jsxRuntime$b=requireJsxRuntime(),_default$b=(0,_createSvgIcon$b.default)((0,_jsxRuntime$b.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear");default_1$b=Clear.default=_default$b;function SelectedOption(t){const{editing:ee,option:te,on_remove_option:ne,on_pointer_down_selected_option:oe,on_mouse_over_option:ie,on_mouse_leave_option:_e}=t;return te?o$1(ButtonGroup,{size:"small",color:"primary",variant:"contained",fullWidth:!0,disableElevation:!0,style:{margin:5},children:[o$1(Button,{onClick:se=>oe&&oe(se,te.id),disabled:!oe,style:{cursor:oe?"":"not-allowed",backgroundColor:te.color&&color_to_string(te.color),color:te.color&&color_to_string(color_to_opposite(te.color))},children:o$1(Tooltip,{title:te.jsx||te.title,children:o$1(Typography,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:te.jsx||te.title})})}),ee&&o$1(IconButton,{onClick:()=>ne(te.id),size:"small",children:o$1(default_1$b,{})})]}):null}const map_state$18=(t,ee)=>({editable:ee.editing_allowed!==void 0?ee.editing_allowed:!t.display_options.consumption_formatting}),map_dispatch$J={change_route:ACTIONS.routing.change_route},connector$19=connect(map_state$18,map_dispatch$J);function _MultiAutocompleteText(t){const{editable:ee,options:te,selected_option_ids:ne}=t,{filtered_options:oe,missing_options_by_id:ie}=F$1(()=>{const se=te.filter(({id:ae})=>!ne.includes(ae)),re={};if(se.length!==ne.length){const ae=new Set(se.map(({id:de})=>de));ne.filter(de=>!ae.has(de)).forEach(de=>{const ue={id:de,title:"<Label Not found>"};re[de]=ue,se.push(ue)})}return{filtered_options:se,missing_options_by_id:re}},[te,ne]),_e=F$1(()=>{const se={...ie};return te.forEach(re=>se[re.id]=re),se},[te,ie]);return o$1(Box,{width:"100%",overflowX:"hidden",children:[ee&&o$1(AutocompleteText,{...t,selected_option_id:void 0,options:oe,on_change:se=>{se!==void 0&&t.on_change([...ne,se])},editing_allowed:ee}),o$1("div",{style:{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden"},children:ne.map(se=>o$1("div",{style:{flexGrow:1,flexShrink:1,flexBasis:"30%",maxWidth:"100%"},children:o$1(SelectedOption,{editing:ee,option:_e[se],on_remove_option:re=>{t.on_change(ne.filter(ae=>ae!==re))},on_mouse_over_option:t.on_mouse_over_option,on_mouse_leave_option:t.on_mouse_leave_option,on_pointer_down_selected_option:(re,ae)=>{t.change_route({item_id:ae})}})}))})]})}const ConnectedMultiAutocompleteText=connector$19(_MultiAutocompleteText);function MultiAutocompleteText(t){return o$1(ConnectedMultiAutocompleteText,{...t})}const map_state$17=(t,{})=>({ready:t.sync.ready_for_reading,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}),map_dispatch$I={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent},connector$18=connect(map_state$17,map_dispatch$I);function _LabelsEditor(t){const{ready:ee,label_ids:te=[]}=t;if(!ee)return o$1("div",{children:"Loading labels..."});let ne;t.allowed_label_ids&&(ne=new Set(t.allowed_label_ids),te.forEach(ie=>ne==null?void 0:ne.add(ie)));const oe=get_wcomponent_search_options({allowed_wcomponent_ids:ne,wcomponents_by_id:t.wcomponents_by_id,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:t.wc_id_to_counterfactuals_map,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1(MultiAutocompleteText,{placeholder:"Add Label",selected_option_ids:te||[],options:oe,allow_none:!0,on_change:ie=>{t.on_change(ie.filter(_e=>!!_e))},on_mouse_over_option:ie=>t.set_highlighted_wcomponent({id:ie,highlighted:!0}),on_mouse_leave_option:ie=>t.set_highlighted_wcomponent({id:ie,highlighted:!1}),editing_allowed:t.editing_allowed})}const LabelsEditor=connector$18(_LabelsEditor),map_state$16=t=>{const{creation_context:ee}=t.creation_context;return{use_creation_context:t.creation_context.use_creation_context,custom_created_at:ee==null?void 0:ee.custom_created_at,label_ids:ee==null?void 0:ee.label_ids,replace_text_target:ee==null?void 0:ee.replace_text_target,replace_text_replacement:ee==null?void 0:ee.replace_text_replacement}},map_dispatch$H={toggle_use_creation_context:ACTIONS.creation_context.toggle_use_creation_context,set_custom_created_at:ACTIONS.creation_context.set_custom_created_at,set_label_ids:ACTIONS.creation_context.set_label_ids,set_replace_text:ACTIONS.creation_context.set_replace_text},connector$17=connect(map_state$16,map_dispatch$H);function _CreationContextSidePanel(t){return o$1("div",{children:[o$1("p",{children:["Enabled: ",o$1(EditableCheckbox,{value:t.use_creation_context,on_change:()=>t.toggle_use_creation_context()})]}),o$1("p",{children:["Custom created at datetime: ",o$1(EditableCustomDateTime,{value:t.custom_created_at,on_change:ee=>t.set_custom_created_at({custom_created_at:ee})}),t.custom_created_at!==void 0&&o$1("div",{style:{backgroundColor:"pink"},children:["Tip: you only need to set this for easing entry of historical data.  If you want to view the data you are currently entering in a lower time resolution then use the",o$1(Link,{route:"display",sub_route:void 0,item_id:void 0,args:void 0,children:" display options "}),"to change the time resolution."]})]}),o$1("p",{children:["Automatically label with: ",o$1(LabelsEditor,{label_ids:t.label_ids,on_change:ee=>t.set_label_ids({label_ids:ee})})]}),o$1("p",{children:["Automatically replace text:",o$1("br",{}),o$1(EditableText,{placeholder:"Target text...",value:t.replace_text_target||"",conditional_on_change:ee=>t.set_replace_text({value:ee||void 0,value_type:"target"})}),o$1("br",{}),o$1(EditableText,{placeholder:"Replacement text...",value:t.replace_text_replacement||"",conditional_on_change:ee=>t.set_replace_text({value:ee||void 0,value_type:"replacement"})})]})]})}const CreationContextSidePanel=connector$17(_CreationContextSidePanel),_time_resolution_types={second:!0,minute:!0,hour:!0,day:!0},time_resolution_types$1=Object.keys(_time_resolution_types),map_state$15=t=>({time_resolution:t.display_options.time_resolution,display_by_simulated_time:t.display_options.display_by_simulated_time}),map_dispatch$G={set_time_resolution:ACTIONS.display.set_time_resolution},connector$16=connect(map_state$15,map_dispatch$G);function _TimeResolutionOptions(t){const ee=invert_disabled_appearance();return t.display_by_simulated_time?null:o$1(ButtonGroup,{disableElevation:!0,variant:"contained",value:t.time_resolution,children:time_resolution_types.map(te=>o$1(Button$2,{value:te,onClick:()=>t.set_time_resolution({time_resolution:te}),className:ee.inverse_disabled,disabled:t.time_resolution===te,children:te}))})}const TimeResolutionOptions=connector$16(_TimeResolutionOptions),time_resolution_types=time_resolution_types$1.filter(t=>t!=="second");var ActionCommands=(t=>(t.click="click",t.drag="drag",t))(ActionCommands||{});const shortcuts_map={help:{shortcut:["?"],outcome:"Opens this help menu"},fit_view:{shortcut:["space"],outcome:"Fit view to components / cycle between groups of components."},toggle_present_edit:{shortcut:["Ctrl","e"],outcome:"Toggle between presentation and editing modes"},toggle_side:{shortcut:["Ctrl","d","s"],outcome:"Toggle showing side panel"},toggle_time:{shortcut:["Ctrl","d","t"],outcome:"Toggle showing time sliders"},toggle_focused:{shortcut:["Ctrl","d","f"],outcome:'Toggle "focused" mode on and off'},toggle_animating:{shortcut:["Ctrl","d","a"],outcome:"Toggle animating connections"},toggle_circular_connections:{shortcut:["Ctrl","d","c"],outcome:"Toggle showing connections as (more) circular"},select_multiple:{shortcut:["Shift","click","drag"],outcome:"Select multiple nodes"},deselect_multiple:{shortcut:["Shift","Ctrl","click","drag"],outcome:"Deselect multiple nodes"},select_all:{shortcut:["Ctrl","a"],outcome:"Select all nodes on knowledge view"},expand_select_forwards:{shortcut:["Ctrl","s","f"],outcome:"Expand selection towards effects (forwards)"},expand_select_backwards:{shortcut:["Ctrl","s","c"],outcome:"Expand selection towards causes (backwards)"},expand_select:{shortcut:["Ctrl","s","e"],outcome:"Expand selection"},decrease_select:{shortcut:["Ctrl","s","d"],outcome:"Decrease selection (along non circular connections and nodes)"},select_interconnections:{shortcut:["Ctrl","s","i"],outcome:"Select components inbetween (interconnections)"},search:{shortcut:["Ctrl","f"],outcome:"Open the search menu"}},shortcuts_list=[shortcuts_map.help,shortcuts_map.fit_view,shortcuts_map.toggle_present_edit,shortcuts_map.toggle_side,shortcuts_map.toggle_time,shortcuts_map.toggle_focused,shortcuts_map.toggle_animating,shortcuts_map.toggle_circular_connections,shortcuts_map.select_multiple,shortcuts_map.deselect_multiple,shortcuts_map.select_all,shortcuts_map.expand_select_forwards,shortcuts_map.expand_select_backwards,shortcuts_map.expand_select,shortcuts_map.decrease_select,shortcuts_map.select_interconnections,shortcuts_map.search];function intersperse(t,ee){const te=[];for(let ne=0;ne<t.length;++ne){const oe=t[ne];if(te.push(oe),ne>=t.length-1)continue;const ie=t[ne+1];te.push(ee(oe,ie))}return te}const test_array_functions=describe.delay("array functions",()=>{let t=intersperse([],()=>0);test(t,[],"intersperse with no elements should be empty"),t=intersperse(["a"],()=>0),test(t,["a"],"intersperse with 1 element should have no interspersed values"),t=intersperse(["a","b","c"],(ee,te)=>ee.charCodeAt(0)+te.charCodeAt(0)),test(t,["a",195,"b",197,"c"],"intersperse with 3 elements should have interspersed values")});function PlainShortcutKeys(t){return o$1("div",{className:"description",style:{display:"inline"},children:intersperse(t.shortcut,()=>o$1("span",{children:" + "}))})}function ShortcutKeys(t){return o$1(Typography,{component:"dt",style:{display:"inline"},children:t.shortcut.map((ee,te)=>{const ne=ee===ActionCommands.click||ee===ActionCommands.drag?"physical_action":"physical_button";return o$1("div",{style:{display:"inline"},children:[o$1("div",{className:ne,children:ee}),te<t.shortcut.length-1&&o$1("span",{className:"shortcut_plus",children:" + "})]})})})}function ShortcutCommand(t){return o$1(Box,{component:"dl",children:[o$1(ShortcutKeys,{shortcut:t.shortcut}),o$1("div",{style:{display:"inline"},children:["   ",t.outcome," "]})]})}function WarningTriangleV2(t){const{warning:ee,label:te="",always_display:ne=!1}=t;return o$1(Typography,{noWrap:!0,variant:"caption",title:ee,"aria-label":ee,style:{display:ee||ne?"inline":"none"},children:[o$1(default_1$g,{}),o$1("span",{style:{position:"relative",top:-7},children:te})]})}const map_state$14=t=>({enable_angular_connections:t.display_options.enable_angular_connections}),map_dispatch$F={set_or_toggle_enable_angular_connections:ACTIONS.display.set_or_toggle_enable_angular_connections},connector$15=connect(map_state$14,map_dispatch$F);function _ExperimentalFeatures(t){return o$1(k$1,{children:[o$1("b",{children:o$1(ExperimentalWarning,{show_label:!0})}),o$1("p",{className:"section",children:[o$1(ExperimentalWarning,{})," ",o$1("b",{children:["Enable Angular Connections ",o$1("span",{style:{position:"relative",top:"-0.5em"},children:["⌞",o$1("span",{style:{position:"relative",top:"0.8em",left:"-2px"},children:"⌝"})]})]}),o$1(EditableCheckbox,{value:t.enable_angular_connections,on_change:t.set_or_toggle_enable_angular_connections})]})]})}const ExperimentalFeatures=connector$15(_ExperimentalFeatures);function ExperimentalWarning(t){const ee="Experimental feature.  Maybe changed or removed.";return o$1(WarningTriangleV2,{warning:ee,label:t.show_label?ee:""})}const map_state$13=t=>({validity_filter:t.display_options.validity_filter,certainty_formatting:t.display_options.certainty_formatting,display_by_simulated_time:t.display_options.display_by_simulated_time,focused_mode:t.display_options.focused_mode,circular_links:t.display_options.circular_links,display_time_marks:t.display_options.display_time_marks,animate_connections:t.display_options.animate_connections,show_large_grid:t.display_options.show_large_grid,display_time_sliders:t.controls.display_time_sliders}),map_dispatch$E={set_validity_filter:ACTIONS.display.set_validity_filter,set_certainty_formatting:ACTIONS.display.set_certainty_formatting,set_display_by_simulated_time:ACTIONS.display.set_display_by_simulated_time,set_or_toggle_focused_mode:ACTIONS.display.set_or_toggle_focused_mode,set_or_toggle_circular_links:ACTIONS.display.set_or_toggle_circular_links,set_display_time_marks:ACTIONS.display.set_display_time_marks,set_or_toggle_animate_connections:ACTIONS.display.set_or_toggle_animate_connections,set_or_toggle_show_large_grid:ACTIONS.display.set_or_toggle_show_large_grid,set_display_time_sliders:ACTIONS.controls.set_display_time_sliders},connector$14=connect(map_state$13,map_dispatch$E);function _DisplayOptionsSidePanel(t){const ee=validity_filter_descriptions[t.validity_filter];return o$1("div",{className:"side_panel",children:[o$1("p",{className:"section",children:[o$1("b",{children:"Validity filter"}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Show:   ",o$1(AutocompleteText,{placeholder:"",options:validity_filter_display_options,selected_option_id:t.validity_filter,allow_none:!1,on_change:te=>{te&&t.set_validity_filter({validity_filter:te})},editing_allowed:!0})]}),o$1("br",{}),o$1("div",{className:"description",children:[ee.pre,o$1("br",{}),o$1("i",{children:["certainty ",ee.condition]})," ",description_of_certainty,"."]})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Validity formatting"}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Opacity:   ",o$1(AutocompleteText,{placeholder:"",options:certainty_formatting_display_options,selected_option_id:t.certainty_formatting,allow_none:!1,on_change:te=>{te&&t.set_certainty_formatting({certainty_formatting:te})},editing_allowed:!0})]}),o$1("br",{}),o$1("div",{className:"description",children:["Show nodes and connection opacity as ",o$1("i",{children:certainty_formatting_descriptions[t.certainty_formatting]})," ",description_of_certainty,"."]})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Time resolution"}),"  ",o$1(TimeResolutionOptions,{})]}),o$1("p",{className:"section",children:[o$1("b",{children:'Use "Focused" Mode'}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_focused}),o$1(EditableCheckbox,{value:t.focused_mode,on_change:t.set_or_toggle_focused_mode})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Show connections as more circular"}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_circular_connections}),o$1(EditableCheckbox,{value:t.circular_links,on_change:t.set_or_toggle_circular_links})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Animate connections"}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_animating}),o$1(EditableCheckbox,{value:t.animate_connections,on_change:t.set_or_toggle_animate_connections})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Show time markers"}),o$1(EditableCheckbox,{value:t.display_time_marks,on_change:t.set_display_time_marks})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Show large grid (whilst editing)"}),o$1(EditableCheckbox,{value:t.show_large_grid,on_change:t.set_or_toggle_show_large_grid})]}),o$1("hr",{}),o$1(ExperimentalFeatures,{}),o$1("hr",{}),o$1("h3",{children:"Controls"}),o$1("p",{className:"section",children:[o$1("b",{children:'Display time sliders for "created at" and "simulated" time'}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_time}),o$1(EditableCheckbox,{value:t.display_time_sliders,on_change:te=>{t.set_display_time_sliders(te)}})]})]})}const DisplayOptionsSidePanel=connector$14(_DisplayOptionsSidePanel),description_of_certainty="(certainty is the minimum of probability or confidence, e.g. something with 70% probability and 20% confidence is 20% certain)",validity_filter_display_options=[{id:"only_certain_valid",title:"Only valid"},{id:"only_maybe_valid",title:"Only maybe Valid"},{id:"maybe_invalid",title:"Maybe Invalid"},{id:"show_invalid",title:"Invalid"}],default_validity_pre_text="Only show nodes and connections with validity",validity_filter_descriptions={only_certain_valid:{pre:default_validity_pre_text,condition:"100%"},only_maybe_valid:{pre:default_validity_pre_text,condition:"> 50%"},maybe_invalid:{pre:default_validity_pre_text,condition:"> 0%"},show_invalid:{pre:"Show all nodes and connections i.e. with validity",condition:">= 0%"}},certainty_formatting_display_options=[{id:"render_certainty_as_opacity",title:"Use certainty"},{id:"render_certainty_as_easier_opacity",title:"Use certainty (opacity >= 50%)"},{id:"render_100_opacity",title:"Always 100%"}],certainty_formatting_descriptions={render_certainty_as_opacity:"proportional to certainty",render_certainty_as_easier_opacity:"proportional to certainty but no lower than 50% (easier to see)",render_100_opacity:"always 100% (no transparency)"},map_state$12=t=>{var ne;const{wc_label_ids:ee,wc_types:te}=((ne=t.derived.current_composed_knowledge_view)==null?void 0:ne.available_filter_options)||{};return{wc_label_ids:ee,wc_types:te,apply_filter:t.filter_context.apply_filter,filters:t.filter_context.filters,is_on_actions_list_view:get_is_on_actions_list_view(t)}},map_dispatch$D={set_apply_filter:ACTIONS.filter_context.set_apply_filter,set_filters:ACTIONS.filter_context.set_filters},connector$13=connect(map_state$12,map_dispatch$D);function _FiltersSidePanel(t){const{wc_label_ids:ee,wc_types:te,filters:ne}=t,oe=F$1(()=>[...te||[]].concat(ne.exclude_by_component_types).map(se=>({id:se,title:wcomponent_type_to_text(se)})),[te,ne]),ie=F$1(()=>[...te||[]].concat(ne.include_by_component_types).map(se=>({id:se,title:wcomponent_type_to_text(se)})),[te,ne]);return o$1("div",{children:[o$1("p",{children:["Enabled: ",o$1(EditableCheckbox,{value:t.apply_filter,on_change:()=>t.set_apply_filter(!t.apply_filter)})]}),o$1("p",{children:["Filter by label:",o$1(LabelsEditor,{allowed_label_ids:ee,label_ids:t.filters.include_by_label_ids,on_change:_e=>{t.set_filters({filters:{...t.filters,include_by_label_ids:_e}})},editing_allowed:!0})]}),o$1("p",{children:["Exclude by label:",o$1(LabelsEditor,{allowed_label_ids:ee,label_ids:t.filters.exclude_by_label_ids,on_change:_e=>{t.set_filters({filters:{...t.filters,exclude_by_label_ids:_e}})},editing_allowed:!0})]}),o$1("p",{children:["Filter by component type:",o$1(MultiAutocompleteText,{placeholder:"",selected_option_ids:t.filters.include_by_component_types,options:ie,allow_none:!0,on_change:_e=>{t.set_filters({filters:{...t.filters,include_by_component_types:_e}})},editing_allowed:!0})]}),o$1("p",{children:["Exclude by component type:",o$1(MultiAutocompleteText,{placeholder:"",selected_option_ids:t.filters.exclude_by_component_types,options:oe,allow_none:!0,on_change:_e=>{t.set_filters({filters:{...t.filters,exclude_by_component_types:_e}})},editing_allowed:!0})]}),t.is_on_actions_list_view&&o$1(k$1,{children:[o$1("br",{}),o$1("hr",{}),o$1("h3",{children:"Actions list filters"}),o$1("p",{children:["Filter by current knowledge view: ",o$1(EditableCheckbox,{value:t.filters.filter_by_current_knowledge_view,on_change:()=>{const _e={...t.filters,filter_by_current_knowledge_view:!t.filters.filter_by_current_knowledge_view};t.set_filters({filters:_e})}})]}),o$1("p",{children:["Filter by text: ",o$1(EditableTextSingleLine,{size:"small",placeholder:"",editing_allowed:!0,value:t.filters.filter_by_text,on_blur:_e=>{const se={...t.filters,filter_by_text:_e.trim()};t.set_filters({filters:se})},on_blur_type:EditableTextOnBlurType.conditional})]})]})]})}const FiltersSidePanel=connector$13(_FiltersSidePanel),knowledge_view_tree_sort_types=["priority","normal","hidden","archived"],map_state$11=t=>({knowledge_views:t.derived.knowledge_views,nested_knowledge_view_ids_map:t.derived.nested_knowledge_view_ids.map}),connector$12=connect(map_state$11);function _SelectKnowledgeView(t){const{placeholder:ee,selected_option_id:te=void 0,allowed_ids:ne,exclude_ids:oe=new Set,on_change:ie,knowledge_views:_e,nested_knowledge_view_ids_map:se}=t,re=F$1(()=>filter_knowledge_views(_e,ne,oe).map(({id:ce,title:de})=>{let ue="",le=se[ce];for(;le;)ue=" / "+le.title+ue,le=se[(le==null?void 0:le.parent_id)||""];return{id:ce,title:de,subtitle:ue}}).sort((ce,de)=>ce.title<de.title?-1:1),[_e,ne,oe,se]);return o$1(AutocompleteText,{placeholder:ee||"Select knowledge view...",allow_none:!0,selected_option_id:te,options:re,on_change:ie,editing_allowed:t.editing_allowed})}const SelectKnowledgeView=connector$12(_SelectKnowledgeView);function filter_knowledge_views(t,ee,te){let ne=t;return ee&&(ne=ne.filter(({id:oe})=>ee.has(oe))),te.size&&(ne=ne.filter(({id:oe})=>!te.has(oe))),ne}const map_state$10=t=>({knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,editing:!t.display_options.consumption_formatting}),map_dispatch$C={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$11=connect(map_state$10,map_dispatch$C);function _FoundationKnowledgeViewsList(t){const{owner_knowledge_view:ee,knowledge_views_by_id:te,on_change:ne,editing:oe}=t,ie=ee.foundation_knowledge_view_ids||[],_e=new Set(ie),se=[],re=[];ie.forEach(le=>{const pe=te[le];pe?se.push(pe):re.push(le)}),re.length&&console.warn(`Did not find foundational knowledge view ids: ${re.join(", ")}`);const ae=new Set(_e);ae.add(ee.id);const ce=se.length,{parent_knowledge_view_id:de}=ee,ue=!!se.find(le=>le.id===de);return o$1("div",{children:[(oe||se.length>0)&&"Foundational Views",oe&&o$1("span",{children:["(",ce,")"]}),oe&&o$1(SelectKnowledgeView,{placeholder:"Search for knowledge view to add...",exclude_ids:ae,on_change:le=>{le&&ne([le,...ie])}}),oe&&de&&!ue&&o$1(Button,{value:"Use parent view as foundation",onClick:()=>ne([de,...ie])}),se.map((le,pe)=>o$1("div",{style:{display:"flex",flexDirection:"row"},children:[o$1("div",{style:{flex:"1"},children:ce-pe}),o$1("div",{style:{flex:"9"},children:le.title}),o$1("div",{style:{flex:"3"},children:oe&&o$1(Button,{value:"remove",onClick:()=>{ne(remove_element(ie,me=>me===le.id))}})})]},le.id)),re.length>0&&o$1("div",{children:["Could not find ",re.length," knowledge views"]})]})}const FoundationKnowledgeViewsList=connector$11(_FoundationKnowledgeViewsList),map_state$$=(t,ee)=>{const te=get_knowledge_view_from_state(t,ee.knowledge_view_id),{wcomponents_by_id:ne,knowledge_views_by_id:oe}=t.specialised_objects;return{knowledge_view:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,editing:!t.display_options.consumption_formatting,is_current_kv:t.routing.args.subview_id===ee.knowledge_view_id}},connector$10=connect(map_state$$);function _KnowledgeViewActiveCounterFactuals(t){const{editing:ee,knowledge_view:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,on_change:ie}=t,[_e,se]=h$1(t.is_current_kv||t.show_automatically||!1);if(!te)return o$1("div",{});if(!_e)return o$1(Button,{value:"Calculate active assumptions",onClick:()=>se(!0)});const re=te.active_counterfactual_v2_ids||[],ae=get_foundational_knowledge_views(te,oe,!0),ce=F$1(()=>{const de=get_composed_wc_id_maps_object(ae,ne).composed_wc_id_map;return Object.keys(de).map(le=>ne[le]).filter(is_defined).filter(({type:le})=>le==="counterfactualv2").map(le=>({id:le.id,title:get_title$1({wcomponent:le,text_type:RichTextType.plain,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:void 0,created_at_ms:FUTURE_TIME_MS,sim_ms:FUTURE_TIME_MS})}))},[ne,...ae]);if(ee){if(ce.length===0)return o$1("div",{children:"No counterfactuals in composed knowledge view (includes foundational knowledge views)"})}else if(re.length===0)return o$1("div",{children:"No assumptions set"});return o$1("div",{children:o$1(MultiAutocompleteText,{placeholder:"...",allow_none:!0,selected_option_ids:re,options:ce,on_change:ie})})}const KnowledgeViewActiveCounterFactuals=connector$10(_KnowledgeViewActiveCounterFactuals),FUTURE_TIME_MS=new Date().getTime()+1e11;function ListHeader(t){const{items_descriptor:ee,on_click_header:te,other_content:ne=()=>null}=t;return o$1("div",{onClick:oe=>{oe.stopImmediatePropagation(),te&&te()},style:{cursor:te?"pointer":"default"},title:t.items_descriptor_title,children:[ne(),o$1("div",{className:"item_descriptors",children:ee}),o$1("div",{style:{clear:"both"}})]})}var ExpandedListStates=(t=>(t[t.collapsed=0]="collapsed",t[t.partial_expansion=1]="partial_expansion",t[t.expanded=2]="expanded",t))(ExpandedListStates||{});const map_state$_=t=>({editing:!t.display_options.consumption_formatting}),connector$$=connect(map_state$_);function _ExpandableList(t){const ee=t.expanded_initial_state||(t.disable_collapsed?t.disable_partial_collapsed?2:1:0),[te,ne]=h$1(ee),oe=te===2,{header_content:ie=()=>null,content:_e,items_count:se,item_descriptor:re,items_descriptor:ae=get_items_descriptor(re,se,t.editing),items_descriptor_title:ce,disable_partial_collapsed:de=!1}=t;function ue(){let le=(te+1)%3;t.disable_collapsed&&le===0&&++le,de&&le===1&&++le,ne(le)}return o$1("div",{children:[o$1(ListHeader,{items_descriptor:ae,items_descriptor_title:ce,on_click_header:ue,other_content:ie}),_e({disable_partial_collapsed:de,expanded_items:te>0,expanded_item_rows:oe})]})}const ExpandableList=connector$$(_ExpandableList);function get_items_descriptor(t,ee,te=!0){return(te||ee!==void 0&&ee!==0)&&(t+=` (${ee})`),t}function ListHeaderAddButton(t){const{new_item_descriptor:ee,on_pointer_down_new_list_entry:te}=t;return o$1("div",{children:o$1(Button,{fullWidth:!0,onClick:ne=>{ne.stopImmediatePropagation(),te()},children:`New ${ee}`})})}const map_state$Z=t=>({consumption_formatting:t.display_options.consumption_formatting}),connector$_=connect(map_state$Z);function _ExpandableListWithAddButton(t){const{items_count:ee,item_descriptor:te,new_item_descriptor:ne=te,consumption_formatting:oe}=t;return o$1(ExpandableList,{header_content:()=>oe?null:o$1(ListHeaderAddButton,{new_item_descriptor:ne,on_pointer_down_new_list_entry:t.on_click_new_item}),content:t.content,items_count:ee,items_descriptor:t.items_descriptor,item_descriptor:te,disable_collapsed:t.disable_collapsed,disable_partial_collapsed:t.disable_partial_collapsed,expanded_initial_state:t.expanded_initial_state})}const ExpandableListWithAddButton=connector$_(_ExpandableListWithAddButton),EditableListEntry$1="";var Delete={},_interopRequireDefault$a=interopRequireDefaultExports;Object.defineProperty(Delete,"__esModule",{value:!0});var default_1$a=Delete.default=void 0,_createSvgIcon$a=_interopRequireDefault$a(requireCreateSvgIcon()),_jsxRuntime$a=requireJsxRuntime(),_default$a=(0,_createSvgIcon$a.default)((0,_jsxRuntime$a.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}),"Delete");default_1$a=Delete.default=_default$a;function ConfirmatoryButton(t){const[ee,te]=h$1(t.ready_to_progress??!1),{tooltip_text:ne=""}=t;return o$1("div",{style:{display:"flex",justifyContent:"space-between",margin:"4px 0px"},children:[o$1(StyledEngineProvider,{injectFirst:!0,children:o$1(ThemeProvider,{theme:WarningTheme,children:o$1(Button,{color:"secondary",disabled:t.disabled,is_hidden:!ee,onClick:oe=>{oe.stopImmediatePropagation(),te(!1),t.on_click&&t.on_click()},startIcon:t.button_icon,children:o$1(Tooltip,{title:ne,"aria-label":ne,children:o$1(Box,{component:"span",children:"CONFIRM"})})})})}),o$1(StyledEngineProvider,{injectFirst:!0,children:o$1(ThemeProvider,{theme:DefaultTheme,children:o$1(Button,{color:"primary",disabled:t.disabled,fullWidth:!ee,is_hidden:!t.on_click,onClick:oe=>{oe.stopImmediatePropagation(),te(!ee),ee&&t.on_cancel&&t.on_cancel()},startIcon:ee?"":t.button_icon,children:o$1(Tooltip,{title:ee?"":ne,"aria-label":ee?"":ne,children:o$1(Box,{component:"span",children:ee?"Cancel":t.button_text})})})})})]})}const map_state$Y=t=>({consumption_formatting:t.display_options.consumption_formatting}),connector$Z=connect(map_state$Y);function _ConfirmatoryDeleteButton(t){return t.consumption_formatting?null:o$1(ConfirmatoryButton,{disabled:t.disabled,on_click:t.on_delete,button_text:t.button_text??"Delete",button_icon:o$1(default_1$a,{}),tooltip_text:t.tooltip_text})}const ConfirmatoryDeleteButton=connector$Z(_ConfirmatoryDeleteButton);class EditableListEntry extends b$1{constructor(ee){super(ee);const{calc_initial_custom_expansion_state:te}=ee,ne=te&&te(ee.item),oe=ne!==void 0?ne:!!ee.expanded;this.state={internal__expanded:oe}}componentDidUpdate(ee,te){this.props.expanded!==ee.expanded&&this.setState({internal__expanded:!!this.props.expanded})}render(){const{item:ee,get_created_at:te,get_custom_created_at:ne,set_custom_created_at:oe=(we,ye)=>({...we,custom_created_at:ye}),get_summary:ie,get_details:_e,get_details2:se,get_details3:re,crud:ae,delete_button_text:ce,hide_expansion_button:de}=this.props,{update_item:ue,delete_item:le}=ae,pe=ne?ne(ee):void 0,{internal__expanded:me}=this.state,fe=me?"expanded":"",ge=this.props.extra_class_names||"",he=`editable_list_entry ${fe} ${ge}`,be=F$1(()=>le&&(()=>le(ee)),[le,ee]),ve=we=>{ue(oe(ee,we))};return o$1("div",{className:he,children:[o$1("div",{className:"summary_header",children:[o$1("div",{className:"summary",children:ie(ee,ae,me)}),!(de&&de(ee))&&o$1("div",{className:"expansion_button",title:me?"Collapse":"Expand",onClick:()=>this.setState({internal__expanded:!me})})]}),me&&o$1(k$1,{children:[_e(ee,ae),o$1("div",{className:"details2",children:se&&se(ee,ae)}),o$1("div",{children:[be&&o$1(ConfirmatoryDeleteButton,{on_delete:be,button_text:ce}),o$1("br",{}),(te||ne)&&o$1(FormControl,{children:o$1(EditableCustomDateTime,{title:"Created at",invariant_value:te&&te(ee),value:pe,on_change:ve})})]}),o$1("div",{className:"details3",children:re&&re(ee,ae)})]})]})}}function factory_render_list_content(t){const{items:ee,get_id:te,item_props:ne,debug_item_descriptor:oe=""}=t;return _e=>{const{expanded_items:se,expanded_item_rows:re}=_e;return o$1("div",{style:{display:se?"":"none",cursor:"initial"},onClick:ae=>ae.stopPropagation(),children:ee.map((ae,ce)=>o$1("div",{children:[o$1("hr",{className:"entries_horizontal_dividers"}),o$1(EditableListEntry,{item:ae,...ne,expanded:re})]},te(ae)))})}}const view_types_to_maintain=new Set(["knowledge","priorities"]);function optional_view_type(t){return view_types_to_maintain.has(t)?t:"knowledge"}function KnowledgeViewList(t){const{parent_knowledge_view_id:ee,knowledge_views:te,current_view:ne,sort_type:oe}=t;if(!t.editing&&te.length===0)return null;const ie=factory_render_list_content({items:te,get_id:re=>re.id,item_props:{get_summary:factory_get_summary(ne),get_details:factory_get_kv_details(t),get_details3:get_details3$1,calc_initial_custom_expansion_state:factory_calc_initial_custom_expansion_state(t),crud:{update_item:re=>{t.upsert_knowledge_view({knowledge_view:re})}}},debug_item_descriptor:"View"}),_e=calc_expanded_initial_state(t);if(oe==="hidden"||oe==="archived"||oe==="errored")return o$1(ExpandableList,{items_count:te.length,content:ie,item_descriptor:sentence_case(oe)+" "+(t.item_descriptor||"View"),disable_collapsed:!1,expanded_initial_state:_e});const se=(oe==="priority"?"Priority ":"")+(t.item_descriptor||"View");return o$1(ExpandableListWithAddButton,{items_count:te.length,on_click_new_item:()=>{create_new_knowledge_view({knowledge_view:{title:make_default_kv_title(),parent_knowledge_view_id:ee,sort_type:oe},creation_context:t.creation_context})},content:ie,item_descriptor:se,disable_collapsed:!0,expanded_initial_state:_e})}function factory_get_summary(t){const ee=optional_view_type(t);return(te,ne)=>o$1(Link,{route:void 0,sub_route:void 0,item_id:void 0,args:{view:ee,subview_id:te.id},selected_on:new Set(["route","args.subview_id"]),children:te.title})}function get_details3$1(){return o$1("div",{children:[o$1("br",{}),o$1("br",{})]})}function calc_expanded_initial_state(t){const{current_kv_parent_ids:ee,knowledge_views:te,current_subview_id:ne}=t;return!!te.find(({id:ie})=>ie===ne||ee.has(ie))?ExpandedListStates.partial_expansion:void 0}function factory_calc_initial_custom_expansion_state(t){return ee=>t.current_kv_parent_ids.has(ee.id)?!0:void 0}function KnowledgeViewListsSet(t){const{priority:ee,normal:te,hidden:ne,archived:oe,errored:ie}=F$1(()=>{const _e=[],se=[],re=[],ae=[],ce=[];return t.knowledge_views.forEach(de=>{const ue=t.nested_knowledge_view_ids.map[de.id];(ue==null?void 0:ue.sort_type)==="errored"?ce.push(de):de.sort_type==="hidden"?re.push(de):de.sort_type==="archived"?ae.push(de):de.sort_type==="priority"?_e.push(de):se.push(de)}),{priority:_e,normal:se,hidden:re,archived:ae,errored:ce}},[t.knowledge_views]);return o$1("div",{children:[o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:ee,sort_type:"priority"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:te,sort_type:"normal"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:ne,sort_type:"hidden"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:oe,sort_type:"archived"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:ie,sort_type:"errored"})]})}const KnowledgeViewDatetimeLinesConfigForm=t=>{const{editing:ee,knowledge_view:te}=t,ne=get_foundational_knowledge_views(te,t.knowledge_views_by_id,!1),oe=get_composed_datetime_lines_config(ne,!1),{datetime_line_config:ie={}}=te,_e=ie.time_origin_ms??oe.time_origin_ms,se=ue=>{const le={...ie,...ue};t.update_item({...te,datetime_line_config:le})};if(_e===void 0)return ee?o$1("div",{children:[o$1("h4",{children:"Configure X Axis Datetime"}),o$1("p",{children:o$1(EditableCustomDateTime,{title:"Time origin",value:void 0,on_change:ue=>{const le=ue?ue.getTime():void 0;se({time_origin_ms:le})}})})]}):null;const re=inherit_or_default(ie,oe,"time_origin_x"),ae=inherit_or_default(ie,oe,"time_scale"),ce=inherit_or_default(ie,oe,"time_line_number"),de=inherit_or_default(ie,oe,"time_line_spacing_days");return o$1("div",{children:[o$1("h4",{children:"Configure X Axis Datetime"}),o$1("p",{children:o$1(EditableCustomDateTime,{title:"Time origin",value:new Date(_e),on_change:ue=>{const le=ue?ue.getTime():void 0;se({time_origin_ms:le})}})}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Time origin position",value:re.value,allow_undefined:!0,on_blur:ue=>{se({time_origin_x:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:re.source})]}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Time scale",value:ae.value,allow_undefined:!0,on_blur:ue=>{se({time_scale:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:ae.source})]}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Time line number",value:ce.value,allow_undefined:!0,on_blur:ue=>{se({time_line_number:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:ce.source})]}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Days between time line",value:de.value,allow_undefined:!0,on_blur:ue=>{se({time_line_spacing_days:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:de.source})]}),ee&&o$1("p",{children:o$1(Button,{value:"Clear (to inherited or default to month)",fullWidth:!0,onClick:()=>{se({time_scale:void 0,time_line_number:void 0,time_line_spacing_days:void 0})}})}),ee&&o$1("p",{style:{display:"flex",flexDirection:"row",justifyContent:"space-evenly",alignItems:"center"},children:[o$1("div",{children:"Defaults:"}),"  ",o$1(Button,{value:"Week",fullWidth:!1,onClick:()=>{se({time_scale:3,time_line_number:8,time_line_spacing_days:7})}})," ",o$1(Button,{value:"Month",fullWidth:!1,onClick:()=>{se({time_scale:DEFAULT_DATETIME_LINE_CONFIG.time_scale,time_line_number:DEFAULT_DATETIME_LINE_CONFIG.time_line_number,time_line_spacing_days:DEFAULT_DATETIME_LINE_CONFIG.time_line_spacing_days})}})," ",o$1(Button,{value:"Year",fullWidth:!1,onClick:()=>{se({time_scale:.3,time_line_number:2,time_line_spacing_days:365})}})]})]})};function inherit_or_default(t,ee,te){const ne=t[te]??ee[te]??DEFAULT_DATETIME_LINE_CONFIG[te],oe=ne===t[te]?0:ne===ee[te]?1:2;return{value:ne,source:oe}}function IndicateSource(t){if(t.source===0)return null;const ee=t.source===1?"Inherited from foundation":"Default";return o$1("div",{style:{color:"grey",fontSize:11},title:ee,children:t.source===1?"(Inherited)":"(Default)"})}const ExternalLinkIcon$1="";function ExternalLinkIcon(){return o$1("div",{className:"external_link_icon"})}function calc_ids_to_move_and_conflicts(t){const{knowledge_views_by_id:ee,wcomponents_by_id:te}=t,ne=get_knowledge_views_to_move(t),oe=new Set(ne.map(re=>re.id)),ie=get_knowledge_views_to_keep({kv_ids_to_move:oe,knowledge_views_by_id:ee}),{wc_ids_to_move:_e,wcomponents_move_conflicts:se}=get_possible_wc_ids_to_move({knowledge_views_to_move:ne,knowledge_views_to_keep:ie,wcomponents_by_id:te});return{kv_ids_to_move:oe,wc_ids_to_move:_e,wcomponents_move_conflicts:se}}function get_knowledge_views_to_move(t){const ee=[],te=new Set,ne=[t.root_knowledge_view_id_to_move];for(;ne.length;){const oe=ne.pop();if(!oe)break;if(te.has(oe))continue;const ie=t.knowledge_views_by_id[oe],_e=t.nested_knowledge_view_ids_map[oe];if(!_e||!ie){console.error(`kv of id: "${oe}" kv is "${ie?"present":"absent"}" but nested kv map entry is "${_e?"present":"absent"}"`);continue}ee.push(ie),te.add(oe),_e.child_ids.forEach(se=>ne.push(se))}return ee}function get_knowledge_views_to_keep(t){return Object.values(t.knowledge_views_by_id).filter(ee=>!t.kv_ids_to_move.has(ee.id))}function get_possible_wc_ids_to_move(t){const ee={};t.knowledge_views_to_keep.forEach(_e=>{Object.entries(_e.wc_id_map).forEach(([se,re])=>{if(re.blocked||re.passthrough)return;const ae=ee[se]||[];ae.push({kv_id:_e.id,left:re.left,top:re.top}),ee[se]=ae})});const te=new Set(t.knowledge_views_to_keep.map(_e=>_e.id)),ne=new Set(t.knowledge_views_to_move.map(_e=>_e.id));let oe=new Set;const ie={};return t.knowledge_views_to_move.forEach(_e=>Object.entries(_e.wc_id_map).forEach(([se,re])=>{if(re.blocked||re.passthrough||!t.wcomponents_by_id[se]||te.has(se))return;const ae=ee[se],ce=ne.has(se);ae&&!ce?ie[se]=ae:oe.add(se)})),{wc_ids_to_move:oe,wcomponents_move_conflicts:ie}}const test_calc_ids_to_move_and_conflicts_functions=describe.delay("calc_ids_to_move_and_conflicts",()=>{const ee=get_new_knowledge_view_object({id:"uuid A",base_id:1,title:"A"}),te=get_new_knowledge_view_object({id:"uuid B",base_id:1,title:"B",parent_knowledge_view_id:ee.id}),ne=get_new_knowledge_view_object({id:"uuid C",base_id:1,title:"C",parent_knowledge_view_id:te.id}),oe=get_new_knowledge_view_object({id:"uuid I",base_id:1,title:"I",parent_knowledge_view_id:te.id}),ie=get_new_knowledge_view_object({id:"uuid J",base_id:1,title:"J",parent_knowledge_view_id:ee.id}),_e=[ee,te,ne,oe,ie],se={};_e.forEach(we=>se[we.id]=we);const re={},ae=we=>(re[we.id]=we,we),ce=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:ee.title,id:ee.id})),de=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:te.title,id:te.id})),ue=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:ne.title,id:ne.id})),le=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:oe.title,id:oe.id})),pe=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:ie.title,id:ie.id})),me=ae(prepare_new_contextless_wcomponent_object({id:"uuid E",base_id:1,title:"E"})),fe=ae(prepare_new_contextless_wcomponent_object({id:"uuid F",base_id:1,title:"F"})),ge=ae(prepare_new_contextless_wcomponent_object({id:"uuid G",base_id:1,title:"G"})),he=ae(prepare_new_contextless_wcomponent_object({id:"uuid H",base_id:1,title:"H"}));ee.wc_id_map[ce.id]={left:0,top:0},ee.wc_id_map[de.id]={left:0,top:0},ee.wc_id_map[me.id]={left:0,top:0},ee.wc_id_map[fe.id]={left:0,top:0},ee.wc_id_map[le.id]={left:0,top:0},ee.wc_id_map[pe.id]={left:0,top:0},te.wc_id_map[de.id]={left:0,top:0},te.wc_id_map[ue.id]={left:0,top:0},te.wc_id_map[me.id]={left:0,top:0},te.wc_id_map[ge.id]={left:0,top:0},te.wc_id_map[le.id]={left:0,top:0},ne.wc_id_map[ue.id]={left:0,top:0},ne.wc_id_map[fe.id]={left:0,top:0},ne.wc_id_map[he.id]={left:0,top:0},ne.wc_id_map[pe.id]={left:0,top:0},oe.wc_id_map[le.id]={left:0,top:0},ie.wc_id_map[pe.id]={left:0,top:0};const be=get_nested_knowledge_view_ids(_e,1).map,ve=calc_ids_to_move_and_conflicts({root_knowledge_view_id_to_move:te.id,nested_knowledge_view_ids_map:be,knowledge_views_by_id:se,wcomponents_by_id:re});test(ve.kv_ids_to_move,new Set([te.id,ne.id,oe.id])),test(ve.wc_ids_to_move,new Set([de.id,ue.id,le.id,ge.id,he.id])),test(Object.keys(ve.wcomponents_move_conflicts),[me.id,fe.id])}),map_state$X=t=>({bases_by_id:t.user_info.bases_by_id,chosen_base_id:t.user_info.chosen_base_id}),connector$Y=connect(map_state$X);function _SelectBaseToMoveTo(t){const ee=t.base_id_to_move_to===void 0?void 0:`${t.base_id_to_move_to}`,te=Object.values(t.bases_by_id||{}).filter(ne=>ne.id!==t.chosen_base_id&&ne.can_edit).map(ne=>({id:`${ne.id}`,title:ne.title}));return o$1("div",{children:o$1(AutocompleteText,{selected_option_id:ee,allow_none:!0,options:te,on_change:ne=>{const oe=ne===void 0?void 0:parseInt(ne);t.on_change(oe)}})})}const SelectBaseToMoveTo=connector$Y(_SelectBaseToMoveTo),map_state$W=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),connector$X=connect(map_state$W);function _WComponentMoveConflicts(t){const{wcomponents_move_conflicts:ee,wcomponents_by_id:te,knowledge_views_by_id:ne}=t,oe=new Date().getTime(),ie=oe;return o$1("div",{children:Object.entries(ee||{}).map(([_e,se],re)=>{const ae=te[_e],ce=ae&&get_title$1({wcomponent:ae,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:void 0,created_at_ms:oe,sim_ms:ie})||_e;return o$1("div",{children:[o$1(Link,{route:"wcomponents",sub_route:void 0,item_id:_e,args:void 0,children:['Component "',o$1(Markdown,{children:ce}),'" in:']}),o$1("ul",{children:se.map(de=>{const ue=ne[de.kv_id],le=(ue==null?void 0:ue.title)||de.kv_id,pe=lefttop_to_xy(de,!0);return o$1("li",{children:o$1(Link,{route:"wcomponents",sub_route:void 0,item_id:_e,args:{subview_id:de.kv_id,...pe},children:["    ",le]})})})})]},_e)})})}const WComponentMoveConflicts=connector$X(_WComponentMoveConflicts),map_state$V=t=>({nested_knowledge_view_ids_map:t.derived.nested_knowledge_view_ids.map,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,chosen_base_id:t.user_info.chosen_base_id}),connector$W=connect(map_state$V);function _KnowledgeViewChangeBase(t){const{knowledge_view:ee,nested_knowledge_view_ids_map:te,knowledge_views_by_id:ne,wcomponents_by_id:oe,chosen_base_id:ie}=t,[_e,se]=h$1(new Set),[re,ae]=h$1(void 0),[ce,de]=h$1(void 0),[ue,le]=h$1(void 0);if(ie===void 0)return o$1("div",{children:[o$1("h4",{children:"Change base of knowledge view"}),"Need to select a base first"]});if(!re)return o$1("div",{children:[o$1("h4",{children:"Change base of knowledge view"}),o$1(Button,{value:"Check if safe to move",onClick:()=>{const{kv_ids_to_move:fe,wc_ids_to_move:ge,wcomponents_move_conflicts:he}=calc_ids_to_move_and_conflicts({root_knowledge_view_id_to_move:ee.id,nested_knowledge_view_ids_map:te,knowledge_views_by_id:ne,wcomponents_by_id:oe});se(set_union(fe,ge)),ae(he)}})]});const pe=Object.keys(re).length,me=_e.size+pe;return o$1("div",{children:[o$1("h4",{children:"Change base of knowledge view"}),pe>0&&o$1("p",{children:["There are other knowledge views which are not nested under this knowledge view and that contain ",o$1("span",{style:{color:"darkred"},children:[pe," components"]})," that are also in this knowledge view.  These entries can be moved to the new base or left assigned to this base.  All the nested knowledge views and their components will be moved regardless."]}),pe>0&&o$1("p",{children:[o$1("i",{children:o$1("b",{children:[pe," component(s) also present in other knowledge views:"]})}),o$1(WComponentMoveConflicts,{wcomponents_move_conflicts:re})]}),pe===0&&o$1("p",{children:[o$1("i",{children:o$1("b",{children:"Safe to move!"})}),"   All of the knowledge views and components in and nested under this knowledge view are contained in this knowledge view.  None of them are present in any other knowledge views that are not nested under this knowledge view."]}),o$1("p",{children:[o$1("i",{children:o$1("b",{children:"Step 2 of 3: Select base to move to"})}),o$1(SelectBaseToMoveTo,{base_id_to_move_to:ce,on_change:fe=>de(fe)})]}),ce!==void 0&&o$1("div",{children:[_e.size!==me&&o$1(ConfirmatoryButton,{disabled:me===0,button_text:`Move all ${me} components to new base (including conflicted)`,on_click:()=>{const fe=Array.from(_e).concat(Object.keys(re));move_ids_to_new_base(fe,ie,ce,le)}}),o$1(ConfirmatoryButton,{disabled:_e.size===0,button_text:`Move ${_e.size} components (no conflicts) to new base`,on_click:()=>{const fe=Array.from(_e);move_ids_to_new_base(fe,ie,ce,le)}})]}),ue&&o$1("p",{children:[ue.error&&o$1("div",{style:{backgroundColor:"pink"},children:["Got error whilst trying to change base id of components ",o$1("br",{}),o$1("pre",{children:JSON.stringify(ue.error,null,2)})]}),ue.data&&o$1("div",{style:{backgroundColor:"lightgreen"},children:["Successfully changed base id of ",ue.data," components & knowledge views.  Reloading page in ",RELOAD_PAGE_DELAY_IN_SECONDS," seconds"]})]})]})}const KnowledgeViewChangeBase=connector$W(_KnowledgeViewChangeBase),RELOAD_PAGE_DELAY_IN_SECONDS=2;async function move_ids_to_new_base(t,ee,te,ne){const ie=await get_supabase().rpc("move_ids_to_new_base",{ids:t,from_base_id:ee,to_base_id:te});ne(ie),ie.error||setTimeout(()=>document.location.reload(),RELOAD_PAGE_DELAY_IN_SECONDS*1e3)}function get_all_parent_knowledge_view_ids(t,ee){const te=new Set;let ne=t[ee];for(;ne&&ne.parent_id;)te.add(ne.parent_id),ne=t[ne.parent_id];return te}const make_default_kv_title=()=>get_today_str(!1),factory_get_kv_details=t=>(ee,te)=>{const{editing:ne,nested_knowledge_view_ids:oe}=t,ie=oe.map[ee.id],_e=((ie==null?void 0:ie.child_ids)||[]).map(pe=>t.knowledge_views_by_id[pe]).filter(is_defined),se=!!t.wcomponents_by_id[(ee==null?void 0:ee.id)||""],re=ee.base_id!==t.chosen_base_id,ae=(t.bases_by_id||{})[ee.base_id],ce=t.current_subview_id===ee.id,de=F$1(()=>new Set(t.possible_parent_knowledge_view_ids),[t.possible_parent_knowledge_view_ids]);let ue="";ie!=null&&ie.ERROR_is_circular&&(ue="Is circularly nested"),ie!=null&&ie.ERROR_parent_kv_missing&&(ue="Parent knowledge view is missing (may be present in a different knowledge base)");let le="";return ie!=null&&ie.ERROR_parent_from_diff_base&&(le="Parent knowledge view from a different base"),o$1("div",{style:{backgroundColor:"white",border:"thin solid #aaa",borderRadius:3,padding:5,margin:5},children:[re&&o$1("div",{style:{cursor:"pointer"},onClick:()=>t.update_chosen_base_id({base_id:ee.base_id}),title:`Click to change to base ${ee.base_id}`,children:[o$1(WarningTriangle,{message:""}),'  Is part of base "',ae==null?void 0:ae.title,'"']}),o$1("p",{style:{display:"inline-flex"},children:[o$1(EditableTextSingleLine,{placeholder:"Title",value:ee.title,on_blur:pe=>{const me=make_default_kv_title();te.update_item({...ee,title:pe??me})},on_blur_type:EditableTextOnBlurType.conditional}),se&&o$1(Link,{route:"wcomponents",sub_route:void 0,item_id:ee.id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"Component"]}),!se&&ne&&o$1("span",{style:{cursor:"pointer"},onClick:()=>{create_wcomponent({wcomponent:{base_id:ee.base_id,id:ee.id,title:ee.title,type:"statev2"}})},children:[o$1(ExternalLinkIcon,{}),"Create Component"]})]}),(ne||ee.description)&&o$1("p",{children:[ne&&o$1("span",{className:"description_label",children:"Description"}),"  ",o$1(EditableText,{placeholder:"...",value:ee.description,on_blur:pe=>{te.update_item({...ee,description:pe})},on_blur_type:EditableTextOnBlurType.conditional})]}),o$1("div",{children:[o$1("span",{className:"description_label",children:"Active assumptions (counterfactuals)"}),o$1(KnowledgeViewActiveCounterFactuals,{knowledge_view_id:ee.id,on_change:pe=>te.update_item({...ee,active_counterfactual_v2_ids:pe})})]}),o$1("p",{children:o$1(FoundationKnowledgeViewsList,{owner_knowledge_view:ee,on_change:pe=>{te.update_item({...ee,foundation_knowledge_view_ids:pe})}})}),(ne||ue||le)&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Nest under"}),ue&&o$1("div",{style:{backgroundColor:"pink"},children:[" ",ue," "]}),le&&o$1("div",{children:[o$1(WarningTriangle,{message:le})," ",le]}),o$1(SelectKnowledgeView,{selected_option_id:ee.parent_knowledge_view_id,allowed_ids:de,on_change:pe=>{te.update_item({...ee,parent_knowledge_view_id:pe})}})]}),ne&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Sort status"}),o$1(AutocompleteText,{selected_option_id:ee.sort_type,options:knowledge_view_tree_sort_types.map(pe=>({id:pe,title:pe})),allow_none:!1,on_change:pe=>pe&&te.update_item({...ee,sort_type:pe})})]}),o$1("hr",{}),ne&&!ce&&o$1("div",{children:[o$1(Link,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:ee.id},children:"Change to this knowledge view"})," to edit datetime lines config and change the base."]}),ne&&ce&&o$1("div",{children:[o$1(KnowledgeViewDatetimeLinesConfigForm,{editing:ne,knowledge_view:ee,knowledge_views_by_id:t.knowledge_views_by_id,update_item:te.update_item}),o$1("hr",{}),o$1(KnowledgeViewChangeBase,{knowledge_view:ee}),o$1("hr",{}),o$1("br",{})]}),(ne||_e.length>0)&&o$1("p",{children:o$1(KnowledgeViewListsSet,{...t,parent_knowledge_view_id:ee.id,knowledge_views:_e,item_descriptor:"Nested"})}),o$1("br",{})]})},map_state$U=t=>({ready:t.sync.ready_for_reading,knowledge_views:t.derived.knowledge_views,nested_knowledge_view_ids:t.derived.nested_knowledge_view_ids,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,creation_context:t.creation_context,current_view:t.routing.args.view,current_subview_id:t.routing.args.subview_id,editing:!t.display_options.consumption_formatting,chosen_base_id:t.user_info.chosen_base_id,bases_by_id:t.user_info.bases_by_id}),map_dispatch$B={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view,update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$V=connect(map_state$U,map_dispatch$B);function _TopLevelKnowledgeViewListsSet(t){if(t.knowledge_views.length===0)return o$1("div",{style:{cursor:"progress"},children:t.ready?"Automatically creating a knowledge view...":"Loading..."});const ee=F$1(()=>t.knowledge_views.filter(oe=>oe.base_id===t.chosen_base_id).map(oe=>oe.id),[t.knowledge_views]),te=t.nested_knowledge_view_ids.top_ids.map(oe=>t.knowledge_views_by_id[oe]).filter(is_defined),ne=get_all_parent_knowledge_view_ids(t.nested_knowledge_view_ids.map,t.current_subview_id);return o$1(KnowledgeViewListsSet,{...t,parent_knowledge_view_id:void 0,knowledge_views:te,possible_parent_knowledge_view_ids:ee,upsert_knowledge_view:t.upsert_knowledge_view,current_kv_parent_ids:ne,chosen_base_id:t.chosen_base_id,bases_by_id:t.bases_by_id,update_chosen_base_id:t.update_chosen_base_id})}const TopLevelKnowledgeViewListsSet=connector$V(_TopLevelKnowledgeViewListsSet),map_state$T=t=>{const ee=get_current_knowledge_view_from_state(t);return{ready_for_reading:t.sync.ready_for_reading,knowledge_view:ee,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,knowledge_views:t.derived.knowledge_views,nested_knowledge_view_ids:t.derived.nested_knowledge_view_ids,creation_context:t.creation_context,editing:!t.display_options.consumption_formatting,current_view:t.routing.args.view,current_subview_id:t.routing.args.subview_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,chosen_base_id:t.user_info.chosen_base_id,bases_by_id:t.user_info.bases_by_id}},map_dispatch$A={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view,update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$U=connect(map_state$T,map_dispatch$A);function _KnowledgeViewForm(t){const{knowledge_view:ee,upsert_knowledge_view:te}=t;if(!t.ready_for_reading)return o$1("div",{children:"Loading..."});if(!ee)return o$1("div",{children:"No knowledge view selected"});const ne=F$1(()=>t.knowledge_views.filter(se=>se.base_id===t.chosen_base_id).map(se=>se.id),[t.knowledge_views]),oe=get_all_parent_knowledge_view_ids(t.nested_knowledge_view_ids.map,t.current_subview_id),_e={create_item:()=>{throw new Error("Not implemented create knowledge view")},update_item:se=>te({knowledge_view:se}),delete_item:()=>{throw new Error("Not implemented delete knowledge view")}};return factory_get_kv_details({...t,possible_parent_knowledge_view_ids:ne,current_kv_parent_ids:oe,chosen_base_id:t.chosen_base_id,bases_by_id:t.bases_by_id,update_chosen_base_id:t.update_chosen_base_id})(ee,_e)}const KnowledgeViewForm=connector$U(_KnowledgeViewForm);function ViewsSidePanel(t){return o$1(Box,{p:1,pt:5,class:"views_side_panel",children:["Current View:",o$1(KnowledgeViewForm,{}),o$1("br",{}),o$1("br",{}),o$1("br",{}),o$1("br",{}),o$1("br",{}),o$1(TopLevelKnowledgeViewListsSet,{})]})}const map_dispatch$z={change_route:ACTIONS.routing.change_route},connector$T=connect(null,map_dispatch$z);function _SearchSidePanel(t){return o$1(WComponentSearchWindow,{on_change:ee=>{ee&&t.change_route({route:"wcomponents",item_id:ee})},on_blur:()=>{t.change_route({route:"wcomponents"})}})}const SearchSidePanel=connector$T(_SearchSidePanel);function SelectionControlSidePanel(t){const ee=get_store();return o$1("div",{className:"side_panel",children:[o$1("p",{className:"section",children:[o$1(Button,{value:"Expand towards causes (backwards)",fullWidth:!0,onClick:()=>conditionally_select_source_causal_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.expand_select_backwards})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Expand towards effects (forwards)",fullWidth:!0,onClick:()=>conditionally_select_forward_causal_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.expand_select_forwards})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Select all components",fullWidth:!0,onClick:()=>conditionally_select_all_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.select_all})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Expand selection (in all directions)",fullWidth:!0,onClick:()=>conditionally_expand_selected_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.expand_select})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Contract selection (in all directions)",fullWidth:!0,onClick:()=>conditionally_decrease_selected_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.decrease_select})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Select components inbetween",fullWidth:!0,onClick:()=>conditionally_select_interconnections(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.select_interconnections}),o$1("div",{className:"description",children:"Only selects the immediate components inbetween.  e.g. if A ---B--> C ---D--> E, then selecting nodes A and C followed by this command will also select connection B.  But if only node A and node E are selected, then this command will not do anything."})]})]})}const SidePanel$1="",CreateNewWComponent$1="",map_state$S=t=>({current_knowledge_view:get_current_composed_knowledge_view_from_state(t),editing:!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)}),map_dispatch$y={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting},connector$S=connect(map_state$S,map_dispatch$y);function _CreateNewWComponent(t){const{current_knowledge_view:ee,editing:te,base_id:ne}=t;return te?ne===void 0?o$1("div",{class:"create_new_wcomponent",children:"Select a base first."}):ee?o$1("div",{class:"create_new_wcomponent",children:[o$1("h3",{children:"Create new component"}),o$1(ButtonGroup,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:wcomponent_types.map(oe=>o$1(Button$2,{onClick:()=>create_wcomponent_type(ne,oe),children:wcomponent_type_to_text(oe)}))})]}):o$1("div",{class:"create_new_wcomponent",children:[o$1("h3",{children:"Create new component"}),o$1("p",{children:"Please select a knowledge view first"})]}):o$1("div",{class:"create_new_wcomponent",children:o$1(Button,{onClick:()=>t.toggle_consumption_formatting({}),children:"Swap to editing"})})}const CreateNewWComponent=connector$S(_CreateNewWComponent);function create_wcomponent_type(t,ee){create_wcomponent({wcomponent:{base_id:t,type:ee}})}function get_updated_wcomponent(t,ee){const te=ee.type!==void 0&&ee.type!==t.type;return t={...t,...ee},{wcomponent:t,different_type:te}}const ColorPicker$1="",default_color=()=>({r:255,g:255,b:255,a:1});function ColorPicker(t){const[ee,te]=h$1(t.color||default_color());p$1(()=>{te(t.color||default_color())},[color_to_string(t.color)]);const ne=ie=>{const _e=get_valid_new_color(ee,ie);te(_e)},oe=ie=>{const _e=get_valid_new_color(ee,ie);colours_different(ee,_e)&&te(_e),colours_different(t.color,_e)&&t.conditional_on_blur(_e)};return o$1("div",{className:"color_picker",children:[o$1(EditableNumber,{placeholder:"r",value:ee.r,allow_undefined:!1,conditional_on_change:ie=>ne({r:ie}),on_blur:ie=>oe({r:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1(EditableNumber,{placeholder:"g",value:ee.g,allow_undefined:!1,conditional_on_change:ie=>ne({g:ie}),on_blur:ie=>oe({g:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1(EditableNumber,{placeholder:"b",value:ee.b,allow_undefined:!1,conditional_on_change:ie=>ne({b:ie}),on_blur:ie=>oe({b:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1(EditableNumber,{placeholder:"a",value:ee.a,allow_undefined:!1,conditional_on_change:ie=>ne({a:ie}),on_blur:ie=>oe({a:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1("div",{className:"color_swatch",style:{backgroundColor:color_to_string(ee)}})]})}function get_valid_new_color(t,ee){const te={...t,...ee};return validate_color(te)}function validate_color(t){let{r:ee,g:te,b:ne,a:oe}=t;return ee=bounded(ee,0,255),te=bounded(te,0,255),ne=bounded(ne,0,255),oe=bounded(oe,0,1),{r:ee,g:te,b:ne,a:oe}}function colours_different(t,ee){return t?color_to_string(t)!==color_to_string(ee):!0}const WComponentFromTo$1="",map_state$R=t=>{var ee;return{allowed_wcomponent_ids:(ee=t.derived.current_composed_knowledge_view)==null?void 0:ee.wc_ids_by_type.any_node,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$x={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent},connector$R=connect(map_state$R,map_dispatch$x);function _WComponentFromTo(t){const{connection_terminal_description:ee,wcomponent_id:te,connection_terminal_type:ne,allowed_wcomponent_ids:oe,wcomponents_by_id:ie,knowledge_views_by_id:_e,wc_id_to_counterfactuals_map:se,on_update_id:re,on_update_type:ae,set_highlighted_wcomponent:ce}=t,de=te?ie[te]:void 0,ue=get_wcomponent_search_options({wcomponents_by_id:ie,knowledge_views_by_id:_e,wc_id_to_counterfactuals_map:se,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms,exclude_ids:t.exclude_ids}),le=[{id:"validity",title:"Validity"},{id:"state",title:"State"},{id:"meta",title:"Meta"}];return o$1("div",{title:de&&de.title,className:"wcomponent_from_to",children:[o$1("span",{className:"description_label",children:[ee,"  "]}),o$1(AutocompleteText,{placeholder:ee+"...",selected_option_id:te,options:ue,allow_none:!0,on_change:pe=>re(pe),on_mouse_over_option:pe=>ce({id:pe,highlighted:!0}),on_mouse_leave_option:pe=>ce({id:pe,highlighted:!1})}),te&&o$1(Link,{route:void 0,sub_route:void 0,item_id:te,args:void 0,children:o$1(ExternalLinkIcon,{})}),ae&&o$1(AutocompleteText,{placeholder:"attribute...",selected_option_id:ne,options:le,allow_none:!1,on_change:pe=>ae(pe),on_mouse_over_option:pe=>ce({id:te,highlighted:!0}),on_mouse_leave_option:pe=>ce({id:te,highlighted:!1})})]})}const WComponentFromTo=connector$R(_WComponentFromTo),map_state$Q=(t,{wcomponent:ee})=>{const te=get_current_composed_knowledge_view_from_state(t),ne=[];if(te){const{judgement:ie,objective:_e}=te.wc_ids_by_type,se=Array.from(set_union(ie,_e));get_wcomponents_from_state(t,se).forEach((re,ae)=>{wcomponent_is_judgement_or_objective(re,se[ae])&&ne.push(re)})}const oe=get_wc_id_to_counterfactuals_v2_map(t);return{consumption_formatting:t.display_options.consumption_formatting,filtered_wcomponents:ne,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$w={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent},connector$Q=connect(map_state$Q,map_dispatch$w);function _ChosenObjectivesFormFields(t){const{objective_ids:ee=[]}=t.wcomponent;if(t.consumption_formatting&&ee.length===0)return null;const te=get_wcomponent_search_options({wcomponents:t.filtered_wcomponents,wcomponents_by_id:t.wcomponents_by_id,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:t.wc_id_to_counterfactuals_map,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1("div",{children:[o$1("p",{children:["Objectives",o$1(MultiAutocompleteText,{editing_allowed:t.editing_allowed,placeholder:"Objectives...",selected_option_ids:ee,options:te,allow_none:!0,on_change:ne=>t.upsert_wcomponent({objective_ids:ne}),on_mouse_over_option:ne=>t.set_highlighted_wcomponent({id:ne,highlighted:!0}),on_mouse_leave_option:ne=>t.set_highlighted_wcomponent({id:ne,highlighted:!1})})]}),o$1("hr",{}),o$1("br",{})]})}const ChosenObjectivesFormFields=connector$Q(_ChosenObjectivesFormFields),_judgement_operators={"==":!0,"!=":!0,"<":!0,"<=":!0,">":!0,">=":!0},judgement_operators=Object.keys(_judgement_operators),_judgement_trends={improving:!0,worsening:!0,stable:!0,unknown:!0,not_assessed:!0},judgement_trends=Object.keys(_judgement_trends),map_state$P=(t,{wcomponent:ee})=>{const te=ee.judgement_target_wcomponent_id,ne=get_wcomponent_from_state(t,te),oe=get_VAP_set_id_to_counterfactual_v2_map(t,te);return{target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,is_editing:!t.display_options.consumption_formatting}},connector$P=connect(map_state$P);function _JudgementFormFields(t){const{wcomponent:ee,upsert_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:_e}=t,{judgement_manual:se,judgement_trend_manual:re}=ee,ae=se===void 0?void 0:se.toString(),ce=calculate_judgement_value({judgement_wcomponent:ee,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:_e}),ue=get_wcomponent_VAPs_represent(ne,{});let le=[];if(ue===VAPsType.boolean){const pe=get_boolean_representation(ne,!0);le=[{id:"True",title:pe.true},{id:"False",title:pe.false}]}return o$1("p",{children:[o$1(WComponentFromTo,{connection_terminal_description:"Target",wcomponent_id:ne&&ne.id,connection_terminal_type:"meta",on_update_id:pe=>{const me={judgement_target_wcomponent_id:pe};!ee.title&&pe&&(me.title=sentence_case(ee.type)+`: @@${pe}`),te(me)}}),(t.is_editing||ae!==void 0)&&o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Manual:   ",o$1(AutocompleteText,{placeholder:"Manual override...",allow_none:!0,selected_option_id:ae,options:manual_options,on_change:pe=>{te({judgement_manual:pe===void 0?void 0:pe==="true"})}})]})}),ae===void 0&&o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Comparator:   ",o$1(AutocompleteText,{extra_styles:{width:30},placeholder:"Operator...",selected_option_id:ee.judgement_operator,options:judgement_operator_options,on_change:pe=>te({judgement_operator:pe})})," ",ue!==VAPsType.boolean&&o$1(EditableTextSingleLine,{placeholder:"Value...",value:ee.judgement_comparator_value||"",conditional_on_change:pe=>{const me=pe.trim();me!==ee.judgement_comparator_value&&te({judgement_comparator_value:me})}}),ue===VAPsType.boolean&&o$1(AutocompleteText,{placeholder:"Value...",selected_option_id:ee.judgement_comparator_value,options:le,on_change:pe=>{pe&&pe!==ee.judgement_comparator_value&&te({judgement_comparator_value:pe})}})]})}),(t.is_editing||re!==void 0&&re!=="not_assessed")&&o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Manual trend:   ",o$1(AutocompleteText,{placeholder:"Manual trend...",allow_none:!0,selected_option_id:re||"Not assessed",options:manual_trend_options,on_change:pe=>{te({judgement_trend_manual:pe==="not_assessed"?void 0:pe})}})]})}),o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Current value:   ",o$1(JudgementBadge,{judgement:ce,judgement_trend_manual:re,size:"medium"})]})})]})}const JudgementFormFields=connector$P(_JudgementFormFields),judgement_operator_options=judgement_operators.map(t=>({id:t,title:t})),manual_options=[{id:"true",title:"Good"},{id:"false",title:"Bad"}],manual_trend_options=judgement_trends.map(t=>({id:t,title:sentence_case(t).replaceAll("_"," ")})),SIMULATION_JS_RESERVED_WORDS=new Set(["-parent","e","pi","phi","mod","expt","abs","sin","asin","cos","acos","tan","atan","sqrt","log","exp","round","floor","ceiling","RandBeta","RandDist","RandBoolean","Rand","RandNormal","RandExp","RandLognormal","RandBinomial","RandNegativeBinomial","RandGamma","RandPoisson","RandTriangular","Magnitude","Abs","sin","cos","tan","asin","acos","atan","arcsin","arccos","arctan","Sign","Sqrt","Ln","Log","Logit","Expit","Round","Ceiling","Floor","Exp","Sample","IndexOf","Contains","Collapse","Select","Reverse","Reverse","Sort","Sort","Unique","Unique","Union","Intersection","Difference","Factorial","Max","Max","Lookup","Fill","Min","Min","Mean","Mean","Sum","Sum","Product","Product","Median","Median","StdDev","StdDev","Correlation","Keys","Values","Length","Count","Flatten","CDFNormal","PDFNormal","InvNormal","CDFLogNormal","PDFLogNormal","InvLogNormal","CDFt","PDFt","Invt","CDFF","PDFF","InvF","CDFChiSquared","PDFChiSquared","InvChiSquared","CDFExponential","PDFExponential","InvExponential","CDFPoisson","PMFPoisson","SetRandSeed","Alert","Console","Prompt","Confirm","Parse","Split","Join","Trim","Range","Length","IndexOf","Contains","Lowercase","Uppercase","sqrt","sum","ifthenelse","ifthenelse","assert","assert","map","map","map","indexof","filter","map","select","filter","filter","join","repeat","repeat","join","reverse","join","sort","join","unique","unique","join","unique","unique","max","flatten","flatten","min","mean","sum","product","sort","median","mean","stddev","mean","mean","stddev","stddev","sum","count","count","join","flatten","join","flatten","stringbase","vectorbase","Stop","Pause","Time","TimeStep","TimeLength","TimeStart","TimeEnd","Seconds","Minutes","Hours","Days","Weeks","Months","Years","Seasonal","Unitless","RemoveUnits","PastMean","PastMedian","PastValues","PastStdDev","PastCorrelation","PastMax","PastMin","Pulse","Ramp","Step","Delay","Smooth","Delay1","Delay3","Remove","Add","FindAll","ResetTimer","Transition","Value","SetValue","FindIndex","FindState","FindNotState","FindNearby","FindNearest","FindFurthest","Index","Connect","Unconnect","Connected","ConnectionWeight","SetConnectionWeight","Width","Height","Distance","Location","SetLocation","Move","MoveTowards"]);[...SIMULATION_JS_RESERVED_WORDS].forEach(t=>SIMULATION_JS_RESERVED_WORDS.add(t.toLowerCase()));function normalise_calculation_ids(t,ee){let te=t;return te=convert_double_at_sign_uuidv4s_into_square_brackets(ee,te),te}function convert_double_at_sign_uuidv4s_into_square_brackets(t,ee){return t.forEach(te=>{const ne=new RegExp(`@@${te}`,"g"),oe=`[${te}]`;ee=ee.replace(ne,oe)}),ee}const thousands_numbers_commas_regex=/.*?\d{1,3}((?:,\d{3})+)/g;function normalise_calculation_numbers(t){let ee=t;return[...ee.matchAll(thousands_numbers_commas_regex)].forEach(ne=>{const oe=ne[0];oe&&(ee=ee.replaceAll(oe,oe.replaceAll(",","")))}),ee}const numbers_with_percentages_regex=/.*?(\d*(?:\.\d+)?(?:e(?:-|\+)\d+)?\s*\%)/g;function convert_percentages(t){let ee=t;return[...ee.matchAll(numbers_with_percentages_regex)].forEach(ne=>{const oe=ne[1];oe&&(ee=ee.replace(oe,"("+oe.replace(/\s*\%/," * 0.01")+")"))}),ee}const currency_symbol_string_map={"£":"CURRENCY_POUND",$:"CURRENCY_DOLLAR","€":"CURRENCY_EURO","¥":"CURRENCY_YUAN_TWO",Ұ:"CURRENCY_YUAN_ONE","₹":"CURRENCY_RUPEE_RX","₨":"CURRENCY_RUPEE_RS","¢":"CURRENCY_GHANA_CEDI","؋":"CURRENCY_AFGHANISTAN_AFGHANI","฿":"CURRENCY_THAILAND_BAHT","៛":"CURRENCY_CAMBODIA_RIEL","₡":"CURRENCY_COSTA_RICA_COLON","₦":"CURRENCY_NIGERIA_NAIRA","₩":"CURRENCY_KOREA_WON","₪":"CURRENCY_ISRAEL_SHEKEL","₫":"CURRENCY_VIET_NAM_DONG","₭":"CURRENCY_LAOS_KIP","₮":"CURRENCY_MONGOLIA_TUGHRIK","₱":"CURRENCY_PESO","₴":"CURRENCY_UKRAINE_HRYVNIA","₼":"CURRENCY_AZERBAIJAN_MANAT","₽":"CURRENCY_RUSSIA_RUBLE","﷼":"CURRENCY_RIAL","B/.":"CURRENCY_PANAMA_BALBOA",ƒ:"CURRENCY_GUILDER",Kč:"CURRENCY_CZECH_REPUBLIC_KORUNA","S/.":"CURRENCY_PERU_SOL",zł:"CURRENCY_POLAND_ZLOTY",ден:"CURRENCY_MACEDONIA_DENAR","Дин.":"CURRENCY_SERBIA_DINAR",лв:"CURRENCY_LEV_TENGE_SOM","₺":"CURRENCY_TURKEY_LIRA"};function hide_currency_symbols(t){let ee=t;return Object.entries(currency_symbol_string_map).forEach(([te,ne])=>{ee=ee.replaceAll(te,ne)}),ee}function unhide_currency_symbols(t){let ee=t;return Object.entries(currency_symbol_string_map).forEach(([te,ne])=>{ee=ee.replaceAll(new RegExp(ne,"ig"),te)}),ee}function apply_units_from_component(t,ee,te){t=t.trim();const ne=t.match(double_at_mentioned_uuids_regex);if(ne&&ne[0]===t){const oe=ne[0].slice(2),ie=te[oe];ee=ie==null?void 0:ie.units}return ee}function perform_calculations(t,ee){const te={};return t.map(oe=>{const ie=new Model({timeStart:2020,timeLength:1,timeUnits:"Years"}),_e=get_double_at_mentioned_uuids_from_text(oe.value);let se=normalise_calculation_numbers(oe.value);se=convert_percentages(se),se=hide_currency_symbols(se);let re=oe.units;re=apply_units_from_component(se,re,ee),re=hide_currency_symbols(re||""),se=normalise_calculation_ids(se,_e);const ae={name:oe.name,value:se};re!==void 0&&(ae.units=re);const ce=ie.Variable(ae),{warnings:de,errors:ue}=prepare_other_components({model:ie,model_component:ce,values:te,uuids:_e,wcomponents_by_id:ee}),le=run_model(ie,oe.units,ce);return de.length&&(le.warning=de.join(" ")),ue.length&&(le.error&&ue.unshift(le.error),le.error=ue.join(`
`)),te[oe.name]=le,le}).map(oe=>(oe.units=unhide_currency_symbols(oe.units),oe.error&&(oe.error=unhide_currency_symbols(oe.error)),oe))}function prepare_other_components(t){const{model:ee,model_component:te,values:ne,uuids:oe,wcomponents_by_id:ie}=t,_e={};Object.entries(ne).forEach(([de,ue])=>{if(ue.value!==void 0){const le=ee.Variable({name:de,value:ue.value,units:ue.units});_e[de]=le}});const se=new Date().getTime(),re=[],ae=[];return oe.map(de=>{const ue=ie[de];if(!ue)return ae.push(`Could not find wcomponent with id: @@${de}.  Defaulting to value of 1.`),de;const{most_probable_VAP_set_values:le,not_allowed_VAP_set_values:pe}=get_wcomponent_state_value_and_probabilities({wcomponent:ue,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:se,sim_ms:se});if(ue.type==="action"||pe)return re.push(`The wcomponent @@${de} is of type "${ue.type}".  Defaulting to value of 1.`),de;if(le.length===0)return re.push(`The wcomponent @@${de} is missing any value and prediction sets.  Defaulting to value of 1.`),de;let me=le[0].parsed_value;if(me===null)return re.push(`The wcomponent @@${de} has an invalid number "${le[0].original_value}".  Defaulting to value of 1.`),de;if(Number.isNaN(me))return re.push(`The wcomponent @@${de} has an invalid number "${le[0].original_value}".  Defaulting to value of 1.`),de;typeof me=="boolean"&&(me=me?1:0);const fe=ee.Variable({name:de,value:me,units:""});return _e[de]=fe,""}).filter(de=>de.length>0).forEach(de=>{const ue=ee.Variable({name:de,value:1,units:""});_e[de]=ue}),Object.values(_e).forEach(de=>{ee.Link(de,te)}),{warnings:re,errors:ae}}function run_model(t,ee,te,ne=!1){let oe,ie="",_e=te._node.getAttribute("Units");try{oe=t.simulate()._data.data[0][te._node.id]}catch(re){const ae=re,ce=typeof ae.message=="string"&&ae.message.startsWith("Wrong units generated for")&&ae.message.match(/and got (.+?)\.(?:$| Either)/);if(!ee&&ce&&!ne){_e=ce[1],te.units=_e;const de=run_model(t,ee,te,!0);({value:oe,units:_e}=de),de.error&&(ie=de.error)}else ie=`${ae.message||"Unknown calculation error"}`}const se={value:oe,error:ie,units:_e};return se.error||delete se.error,se.units==="Unitless"&&(se.units=""),se}function get_error_or_warning_message(t,ee={display:"flex"}){const te={...ee,color:"lightgrey"};let ne="";return t!=null&&t.error&&(ne=`Error: ${t.error}`,te.color="black"),t!=null&&t.warning&&(t.error&&(ne+=`
----
`),ne+=`Warning: ${t.warning}`),{error_or_warning_message:ne,css:te}}function FormatCalculationErrorOrWarning(t){const{error_or_warning_message:ee,css:te}=t;return o$1("div",{style:{...te,maxHeight:ee.length?100:0,maxWidth:ee.length?100:0,transition:"max-height 1s ease, max-width 1s ease, color 1s ease"},children:o$1(WarningTriangleV2,{warning:ee,always_display:!0})})}function WComponentCausalLinkForm(t){const{wcomponent:ee}=t;return o$1(BasicCausalLinkForm,{effect_string:ee.effect_string,effect_when_true:ee.effect_when_true,effect_when_false:ee.effect_when_false,editing:t.editing,wcomponents_by_id:t.wcomponents_by_id,upsert_wcomponent:t.upsert_wcomponent})}function BasicCausalLinkForm(t){const{effect_string:ee,effect_when_true:te,effect_when_false:ne,editing:oe,wcomponents_by_id:ie,upsert_wcomponent:_e}=t,se=F$1(()=>{if(!ee)return;const le=perform_calculations([{id:-1,name:"",value:ee}],ie)[0],pe=le==null?void 0:le.value;return pe!==void 0&&_e({effect_when_true:pe}),get_error_or_warning_message(le)},[ee]),re=oe||ee!==void 0,ae=te!==void 0,ce=ne!==void 0;return o$1("p",{style:{display:"flex",flexDirection:"column"},children:[re&&o$1("div",{children:[o$1("span",{className:"description_label",children:"Effect"}),"  ",o$1("div",{style:{display:"flex"},children:[se&&o$1(FormatCalculationErrorOrWarning,{...se}),o$1(EditableTextSingleLine,{placeholder:"",value:ee||"",editing_allowed:oe,on_blur:de=>_e({effect_string:de}),on_blur_type:EditableTextOnBlurType.conditional})]})]}),ae&&o$1("div",{children:[o$1("span",{className:"description_label",children:"Effect value"}),"  ",o$1("span",{children:te})]}),ce&&o$1("div",{children:[o$1("span",{className:"description_label",children:"Effect value when false"}),"  ",o$1("span",{children:ne}),oe&&o$1(k$1,{children:[" ",o$1("span",{className:"description_label",style:{cursor:"pointer",color:"#F99"},onClick:()=>_e({effect_when_false:void 0}),children:"Field deprecated (click to remove)"})]})]})]})}const map_state$O=t=>{const ee=get_current_knowledge_view_from_state(t),te=get_current_composed_knowledge_view_from_state(t);return{knowledge_view:ee,editing:!t.display_options.consumption_formatting,composed_wc_id_map:te&&te.composed_wc_id_map,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$v={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$O=connect(map_state$O,map_dispatch$v);function _WComponentCounterfactualForm(t){const{wcomponent:ee,upsert_wcomponent:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,composed_wc_id_map:ie,knowledge_view:_e}=t;if(!ie)return o$1("div",{children:"Counterfactual form can not render: No current knowledge view"});const se=Object.keys(ie).map(me=>ne[me]).filter(is_defined).filter(wcomponent_is_allowed_to_have_state_VAP_sets),re=get_wcomponent_search_options({wcomponents:se,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:void 0,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}),ae=ne[ee.target_wcomponent_id||""];let ce=[],de=[];wcomponent_is_allowed_to_have_state_VAP_sets(ae)&&(ce=ae.values_and_prediction_sets||[],de=ce.map(({id:me,datetime:fe})=>{const ge=uncertain_date_to_string(fe,"minute");return{id:me,title:ge}}));const ue=get_wcomponent_VAPs_represent(ae,ne),le=ce.find(({id:me})=>me===ee.target_VAP_set_id);let pe=!1;return _e&&(pe=(_e.active_counterfactual_v2_ids||[]).includes(ee.id)),o$1("div",{children:[o$1("p",{children:[o$1("span",{className:"description_label",children:"Target component"}),"  ",ee.target_wcomponent_id&&o$1(Link,{route:void 0,sub_route:void 0,item_id:ee.target_wcomponent_id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"  "]}),o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ee.target_wcomponent_id,options:re,on_change:me=>te({target_wcomponent_id:me,target_VAP_set_id:void 0,target_VAP_id:void 0}),on_mouse_over_option:me=>t.set_highlighted_wcomponent({id:me,highlighted:!0}),on_mouse_leave_option:me=>t.set_highlighted_wcomponent({id:me,highlighted:!1})})})]}),ee.target_wcomponent_id&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Target value and prediction set to override"}),"  ",o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ee.target_VAP_set_id,options:de,on_change:me=>{te({target_VAP_set_id:me,target_VAP_id:void 0})}})})]}),ae&&le&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Counterfactual value"}),"  ",convert_VAP_set_to_VAP_visuals({VAP_set:le,VAPs_represent:ue,wcomponent:ae}).map(me=>{const{VAP_id:fe,value_text:ge}=me,he=fe===ee.target_VAP_id;return o$1("div",{children:[o$1("input",{type:"radio",disabled:!t.editing,id:fe,value:ge,checked:he,onChange:()=>te({target_VAP_id:fe})}),o$1("label",{for:fe,children:ge})]})})]}),_e&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Apply counterfactual in this knowledge view"}),"  ",o$1(EditableCheckbox,{value:pe,on_change:()=>{const{id:me}=ee,fe=toggle_item_in_list(_e.active_counterfactual_v2_ids||[],me),ge={..._e,active_counterfactual_v2_ids:fe};t.upsert_knowledge_view({knowledge_view:ge})}}),!le&&pe&&o$1("span",{title:"Will not be applied yet, you need to target a component and one of its value sets",children:o$1(default_1$g,{})})]})]})}const WComponentCounterfactualForm=connector$O(_WComponentCounterfactualForm),UncertainDateTimeForm$1="",map_state$N=t=>({show_unused_fields:!t.display_options.consumption_formatting}),connector$N=connect(map_state$N);function _UncertainDateTimeForm(t){const{datetime:ee,on_change:te,show_unused_fields:ne}=t;return o$1("div",{className:"datetimes",children:[ee.min&&o$1("div",{className:"datetime_section",children:o$1("div",{className:"datetime_value",children:o$1(EditableCustomDateTime,{title:"Minimum datetime",value:ee.min,on_change:oe=>te({...ee,min:oe})})})}),(ne||ee.value)&&o$1("div",{className:"datetime_section",children:o$1("div",{className:"datetime_value",children:o$1(EditableCustomDateTime,{title:"Expected datetime",value:ee.value,on_change:oe=>te({...ee,value:oe})})})}),ee.max&&o$1("div",{className:"datetime_section",children:o$1("div",{className:"datetime_value",children:o$1(EditableCustomDateTime,{title:"Maximum datetime",value:ee.max,on_change:oe=>te({...ee,max:oe})})})})]})}const UncertainDateTimeForm=connector$N(_UncertainDateTimeForm),map_state$M=t=>({creation_context_state:t.creation_context}),connector$M=connect(map_state$M);function _WComponentDateTimeFormField(t){const{wcomponent:ee,creation_context_state:te,upsert_wcomponent:ne}=t,oe=ee.datetime||{};return o$1("p",{children:o$1(UncertainDateTimeForm,{datetime:oe,on_change:ie=>ne({datetime:ie})})})}const WComponentDateTimeFormField=connector$M(_WComponentDateTimeFormField);function EditablePercentage(t){const ee=ratio_to_percentage_string(t.value),{conditional_on_change:te,on_blur:ne,on_blur_type:oe=EditableTextOnBlurType.conditional,disabled:ie}=t;if(!te&&!ne||ie){const _e="editable_percentage"+(ie?"disabled":""),se=t.value!==void 0;return o$1("div",{className:_e,children:[se&&o$1("span",{className:"description_label",children:t.placeholder}),ee||t.placeholder," %"]})}return o$1("div",{className:"editable_percentage",children:[o$1(EditableTextSingleLine,{placeholder:t.placeholder,value:ee,conditional_on_change:_e=>{const se=string_to_percentage(_e);se!==void 0&&te&&te(se)},on_blur:_e=>{const se=string_to_percentage(_e);se!==void 0&&ne&&ne(se)},on_blur_type:oe})," %"]})}function string_to_percentage(t){if(!t)return;const ee=parseFloat(t);return Number.isNaN(ee)?0:bounded(ee,0,100)/100}const PredictionBadge$1="",PredictionBadgeConvictionMask="";function PredictionsBadgeConvictionMask(t){const{size:ee,border_width:te,elements_width:ne,conviction:oe}=t,ie=ee/ne;return o$1("g",{className:"conviction_mask",onMouseEnter:_e=>_e.currentTarget.classList.add("hovered"),onMouseLeave:_e=>_e.currentTarget.classList.remove("hovered"),ref:_e=>{if(!_e)return;const se=_e.getElementsByClassName("parts")[0];Array.from(se.children).forEach(re=>{const ae=re.getAttribute("data-group_id");if(!ae)return;let de=parseInt(ae,10)/100<=oe?"display: none;":"";const ue=130+Math.random()*45;de+=`fill: rgb(${ue},${ue},${ue})`,re.setAttribute("style",de)})},children:[o$1("rect",{x:0,y:0,width:ee+2,height:ee+2,fill:"rgba(0,0,0,0)"}),o$1("g",{className:"parts",children:mask_data.map(_e=>o$1("rect",{"data-group_id":_e[2],x:te+_e[0]*ie,y:te+_e[1]*ie,width:ie,height:ie}))})]})}const mask_data=[[0,9,40],[0,8,30],[0,7,40],[0,6,90],[0,5,10],[0,4,95],[0,3,60],[0,2,60],[0,1,90],[0,0,40],[1,9,20],[1,8,50],[1,7,80],[1,6,60],[1,5,80],[1,4,90],[1,3,90],[1,2,30],[1,1,50],[1,0,30],[2,9,20],[2,8,50],[2,7,80],[2,6,40],[2,5,70],[2,4,20],[2,3,20],[2,2,50],[2,1,60],[2,0,40],[3,9,90],[3,8,50],[3,7,20],[3,6,30],[3,5,60],[3,4,50],[3,3,20],[3,2,2],[3,1,95],[3,0,10],[4,9,80],[4,8,30],[4,7,90],[4,6,60],[4,5,50],[4,4,100],[4,3,40],[4,2,70],[4,1,30],[4,0,98],[5,9,20],[5,8,40],[5,7,70],[5,6,50],[5,5,70],[5,4,90],[5,3,50],[5,2,70],[5,1,10],[5,0,80],[6,9,20],[6,8,5],[6,7,30],[6,6,50],[6,5,70],[6,4,100],[6,3,20],[6,2,90],[6,1,60],[6,0,60],[7,9,30],[7,8,70],[7,7,80],[7,6,70],[7,5,20],[7,4,10],[7,3,30],[7,2,98],[7,1,98],[7,0,90],[8,9,5],[8,8,60],[8,7,95],[8,6,70],[8,5,70],[8,4,80],[8,3,95],[8,2,40],[8,1,95],[8,0,2],[9,9,40],[9,8,40],[9,7,80],[9,6,80],[9,5,90],[9,4,10],[9,3,5],[9,2,60],[9,1,80],[9,0,30]];function calc_new_counterfactual_state(t){let ee,te;const{conviction:ne,probability:oe,counterfactual_conviction:ie,counterfactual_probability:_e}=t,se=_e===void 0&&ie===void 0;return ne!==1&&(te=1),se&&(oe===1&&ne!==1||oe!==1)?ee=1:_e!==0&&(oe===0&&ne!==1||oe!==0)?ee=0:(ee=void 0,te=void 0),{new_counterfactual_probability:ee,new_counterfactual_conviction:te}}const test_calc_new_counterfactual_state=describe.delay("calc_new_counterfactual_state",()=>{let t,ee,te,ne,oe;t=.5,ee=1,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=1,ee=1,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=0,ee=1,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=.5,ee=.5,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,ne=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=1,ee=.5,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,ne=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=0,ee=.5,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,ne=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0)});function PredictionBadge(t){const{size:ee,elements_width:te=10}=t,ne=te*te,oe=ee/te,{counterfactual_probability:ie,counterfactual_conviction:_e,set_counterfactual:se}=t,re=is_num(ie)||is_num(_e),{probability:ae,conviction:ce}=sanitise_props(t),de=is_num(ie)?ie:ae,ue=is_num(_e)?_e:ce;function le(){if(!se)return;const he=calc_new_counterfactual_state({probability:ae,conviction:ce,counterfactual_probability:ie,counterfactual_conviction:_e});se({probability:he.new_counterfactual_probability,conviction:he.new_counterfactual_conviction})}const pe=3,fe=`prediction_badge ${`counterfactual_${re?"":"in"}active`}`,ge="Visual display of probability and confidence";return o$1("div",{style:{cursor:t.disabled?"not-allowed":"pointer"},title:ge,children:o$1("svg",{width:ee+pe*2,height:ee+pe*2,onClick:()=>!t.disabled&&le(),className:fe,children:[o$1("rect",{x:0,y:0,width:ee+pe*2,height:ee+pe*2,className:"outline"}),o$1("g",{children:Array.from(Array(ne)).map((he,be)=>{const ve=be/ne,we=be%te,ye=Math.floor(be/te);return{i:be,i_frac:ve,x:we,y:ye,ys:pe+(te-1-we)*oe,xs:pe+ye*oe}}).map(he=>{const we=(he.i_frac<de?0:1)*255;return{...he,fill:`rgb(${we},${we},${we})`}}).map(he=>o$1("rect",{x:he.xs,y:he.ys,width:oe,height:oe,fill:he.fill}))}),o$1(PredictionsBadgeConvictionMask,{size:ee,border_width:pe,elements_width:te,conviction:ue})]})})}function sanitise_props({probability:t,conviction:ee}){const te=bounded(t,0,1),ne=bounded(ee,0,1);return te!==t&&console.error(`probability: ${t} not in range 0 to 1`),ne!==ee&&console.error(`conviction: ${ee} not in range 0 to 1`),{probability:te,conviction:ne}}function is_num(t){return Number.isFinite(t)}const map_state$L=t=>({creation_context_state:t.creation_context,editing:!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)}),connector$L=connect(map_state$L);function _WComponentEventAtFormField(t){const{wcomponent:ee,creation_context_state:te,upsert_wcomponent:ne,base_id:oe}=t,ie=ee.event_at&&ee.event_at[0],_e=se=>{const re={event_at:[{probability:1,conviction:1,datetime:{},id:"",base_id:oe||-1,explanation:"",...ie||{...get_new_created_ats(te)},...se}]};ne(re)};return o$1("p",{children:[o$1(UncertainDateTimeForm,{datetime:ie?ie.datetime:{},on_change:se=>_e({datetime:se})}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:[o$1(EditablePercentage,{placeholder:"Probability",value:ie==null?void 0:ie.probability,on_blur:se=>_e({probability:se}),on_blur_type:EditableTextOnBlurType.conditional}),o$1(EditablePercentage,{placeholder:"Confidence",value:ie==null?void 0:ie.conviction,on_blur:se=>_e({conviction:se}),on_blur_type:EditableTextOnBlurType.conditional}),"  ",ie&&o$1(PredictionBadge,{disabled:!0,size:20,probability:ie.probability,conviction:ie.conviction})]}),o$1("br",{}),o$1("br",{}),t.editing&&o$1(Button,{fullWidth:!0,value:ie?"Clear Event":"Create Default Event",onClick:()=>{ie?ne({event_at:[]}):_e({conviction:1,probability:1})}})]})}const WComponentEventAtFormField=connector$L(_WComponentEventAtFormField),map_state$K=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),map_dispatch$u={change_route:ACTIONS.routing.change_route},connector$K=connect(map_state$K,map_dispatch$u);function _WComponentBackReferences(t){const{wcomponent_id:ee,wcomponents_by_id:te,knowledge_views_by_id:ne}=t,[oe,ie]=h$1(!1),[_e,se]=h$1([]);if(p$1(()=>{let ce=[];oe&&(ce=Object.values(te).filter(de=>wcomponent_is_not_deleted(de)).filter(de=>de.title.includes(ee)||de.description.includes(ee)||(de.label_ids||[]).includes(ee)||(wcomponent_is_goal(de)||wcomponent_is_action(de))&&(de.parent_goal_or_action_ids||[]).includes(ee)||wcomponent_is_judgement_or_objective(de)&&de.judgement_target_wcomponent_id===ee||wcomponent_has_legitimate_non_empty_state_VAP_sets(de)&&de.values_and_prediction_sets.find(ue=>ue.entries.find(le=>(le.explanation||"").includes(ee)))||wcomponent_has_validity_predictions(de)&&de.validity.find(ue=>(ue.explanation||"").includes(ee))||wcomponent_is_plain_connection(de)&&(de.from_id===ee||de.to_id===ee)||wcomponent_is_state_value(de)&&de.attribute_wcomponent_id===ee).filter(de=>de.id!==ee)),se(ce)},[ee,te,oe]),!oe)return o$1("div",{children:o$1(Button,{value:"Show back references",onClick:()=>ie(!0)})});if(_e.length===0)return o$1("div",{children:"No back references"});const re=new Date().getTime(),ae=re;return o$1("div",{children:["Back references:",_e.map(ce=>o$1("div",{children:o$1(Link,{route:void 0,sub_route:void 0,item_id:ce.id,args:void 0,children:o$1(Markdown,{children:get_title$1({wcomponent:ce,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:void 0,created_at_ms:re,sim_ms:ae})||`No title for component ${ce.id}`})})}))]})}const WComponentBackReferences=connector$K(_WComponentBackReferences),map_state$J=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=get_current_knowledge_view_from_state(t),ne=ee==null?void 0:ee.composed_datetime_line_config;return{kv:te,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,created_at_ms:t.routing.args.created_at_ms,time_origin_ms:ne==null?void 0:ne.time_origin_ms,time_origin_x:ne==null?void 0:ne.time_origin_x,time_scale:ne==null?void 0:ne.time_scale}},map_dispatch$t={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$J=connect(map_state$J,map_dispatch$t);function _ButtonSnapXToDatetime(t){const[ee,te]=h$1(void 0),{kv:ne,wcomponent_id:oe,wcomponents_by_id:ie,created_at_ms:_e,time_origin_ms:se,time_origin_x:re,time_scale:ae,upsert_knowledge_view:ce}=t,de=(oe?[oe]:t.wcomponent_ids)||[],{id:ue,wc_id_map:le}=ne||{},pe=!ne||!ue||le===void 0||se===void 0||re===void 0||ae===void 0||!!oe&&calculate_canvas_x_for_wcomponent_temporal_uncertainty({wcomponent_id:oe,wcomponents_by_id:ie,created_at_ms:_e,time_origin_ms:se,time_origin_x:re,time_scale:ae})===void 0,me=pe?se===void 0?"Disabled as time origin not set":re===void 0?"Disabled as time origin X position is not set":"Diabled":"";let fe="";return ee!==void 0&&(ee?de.length>1&&(fe=`Changed ${ee}`):fe="No changes"),o$1("div",{style:{display:"inline-block"},children:[o$1(Button,{disabled:pe,value:"X by time",title:me,onClick:()=>{if(pe)return;const{number_changed:ge,knowledge_view:he}=calulate_new_positions({wcomponent_ids:de,wcomponents_by_id:ie,kv:ne,wc_id_map:le,created_at_ms:_e,time_origin_ms:se,time_origin_x:re,time_scale:ae});ge&&he&&ce({knowledge_view:he}),te(ge),setTimeout(()=>te(void 0),1e3)},is_left:!0}),fe]})}const ButtonSnapXToDatetime=connector$J(_ButtonSnapXToDatetime);function calulate_new_positions(t){const{wcomponent_ids:ee,wcomponents_by_id:te,kv:ne,wc_id_map:oe,created_at_ms:ie,time_origin_ms:_e,time_origin_x:se,time_scale:re}=t;let ae=0;if(!ne||!oe||_e===void 0||se===void 0||re===void 0)return{number_changed:ae,knowledge_view:void 0};const ce={...oe};ee.forEach(ue=>{const le=oe[ue];if(!le)return;const pe=calculate_canvas_x_for_wcomponent_temporal_uncertainty({wcomponent_id:ue,wcomponents_by_id:te,created_at_ms:ie,time_origin_ms:_e,time_origin_x:se,time_scale:re});if(pe===void 0)return;const me={...le,left:pe};ce[ue]=me,ae+=1});const de=ae?{...ne,wc_id_map:ce}:void 0;return{number_changed:ae,knowledge_view:de}}const map_state$I=(t,ee)=>{const te=get_current_knowledge_view_from_state(t),ne=te==null?void 0:te.id,oe=ee.wcomponent_ids||[ee.wcomponent_id],ie=!!oe.find(se=>t.derived.wcomponent_ids_by_type.any_node.has(se)),_e=!!oe.find(se=>t.derived.wcomponent_ids_by_type.any_link.has(se));return{knowledge_view_id:ne,kv:te,wcomponent_node_present:ie,wcomponent_link_present:_e}},map_dispatch$s={snap_to_grid_knowledge_view_entries:ACTIONS.specialised_object.snap_to_grid_knowledge_view_entries,bulk_add_to_knowledge_view:ACTIONS.specialised_object.bulk_add_to_knowledge_view,bulk_update_knowledge_view_entries:ACTIONS.specialised_object.bulk_update_knowledge_view_entries,change_current_knowledge_view_entries_order:ACTIONS.specialised_object.change_current_knowledge_view_entries_order},connector$I=connect(map_state$I,map_dispatch$s);function _AlignComponentForm(t){const{wcomponent_id:ee,knowledge_view_id:te,kv:ne}=t,oe=t.wcomponent_ids||[t.wcomponent_id],ie=ne&&ee?Object.keys(ne.wc_id_map).findIndex(ae=>ae===ee):void 0,_e=ne?Object.keys(ne.wc_id_map).length:void 0,se=ie!==void 0&&ie+1===_e,re=ie===0;return o$1("div",{children:[o$1("h3",{children:"Align"}),t.wcomponent_node_present&&o$1(k$1,{children:[o$1(Button,{disabled:!te,value:"Snap to grid",onClick:()=>{te&&t.snap_to_grid_knowledge_view_entries({wcomponent_ids:oe,knowledge_view_id:te})},is_left:!0})," ",o$1(ButtonSnapXToDatetime,{...t})," ",o$1(Button,{disabled:!te,value:"Bring here",onClick:()=>{if(!te)return;const ae=get_store().getState(),ce=get_middle_of_screen(ae);t.bulk_add_to_knowledge_view({knowledge_view_id:te,wcomponent_ids:oe,override_entry:ce})},is_left:!0})]}),t.wcomponent_node_present&&t.wcomponent_link_present&&o$1("br",{}),t.wcomponent_link_present&&o$1(k$1,{children:o$1(Button,{disabled:!te,value:"Manually update link location",onClick:()=>{if(!te)return;const ae=get_store().getState(),ce=calculate_middle_connection_curves(oe,ae);ce&&t.bulk_update_knowledge_view_entries({knowledge_view_id:te,changes:ce})},is_left:!0})}),o$1("br",{}),o$1("span",{title:se?"Already at front":"Move to front",children:o$1(Button,{value:"Move to front",disabled:se,onClick:()=>{t.change_current_knowledge_view_entries_order({wcomponent_ids:oe,order:"front"})},is_left:!0})})," ",o$1("span",{title:re?"Already at back":"Move to back",children:o$1(Button,{value:"Move to back",disabled:re,onClick:()=>{t.change_current_knowledge_view_entries_order({wcomponent_ids:oe,order:"back"})},is_left:!0})})]})}const AlignComponentForm=connector$I(_AlignComponentForm);function calculate_middle_connection_curves(t,ee){const te=ee.derived.current_composed_knowledge_view;if(te)return t.map(ne=>get_wcomponent_from_state(ee,ne)).filter(wcomponent_is_plain_connection).map(ne=>{const oe=get_wcomponent_from_state(ee,ne.from_id),ie=get_wcomponent_from_state(ee,ne.to_id),_e=get_connection_termini({wcomponent:ne,from_wc:oe,to_wc:ie,current_composed_knowledge_view:te}),se=derive_connection_coords({..._e,end_size:1,line_behaviour:ne.line_behaviour,circular_links:!0,connection_end_type:ConnectionEndType.positive});if(!se)return;const re=bezier_middle({point1:{x:se.line_start_x,y:se.line_start_y},relative_control_point1:se.relative_control_point1,relative_control_point2:se.relative_control_point2,point2:{x:se.line_end_x,y:se.line_end_y}});return{wcomponent_id:ne.id,left:re.x,top:-re.y}}).filter(ne=>!!ne)}const map_state$H=(t,ee)=>{const{wcomponent_id:te}=ee,ne=get_current_knowledge_view_from_state(t),oe=ne&&ne.wc_id_map[te],ie=t.derived.knowledge_views;return{knowledge_view_id:ne&&ne.id,knowledge_view_entry:oe,all_knowledge_views:ie}},connector$H=connect(map_state$H);function _WComponentPresenceInOtherKVs(t){const{knowledge_view_id:ee,wcomponent_id:te,knowledge_view_entry:ne}=t,oe=t.all_knowledge_views.filter(({id:_e})=>_e!==ee).filter(({wc_id_map:_e})=>{const se=_e[te];return se&&!se.blocked&&!se.passthrough});if(oe.length===0)return null;const ie=!ne||ne.blocked||ne.passthrough;return o$1("div",{children:[ie?"Present":"Also"," in:",oe.map(_e=>{const se=_e.wc_id_map[t.wcomponent_id],re=lefttop_to_xy(se,!0);return o$1("div",{children:o$1(Link,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:_e.id,...re},children:_e.title})})})]})}const WComponentPresenceInOtherKVs=connector$H(_WComponentPresenceInOtherKVs);function get_wcomponent_status_in_knowledge_view(t){const{editing_allowed:ee,wcomponent_id:te,knowledge_view:ne,composed_wc_id_maps_object:oe,foundation_composed_wc_id_map:ie}=t,_e={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},se=ne.wc_id_map[te],re=oe.composed_wc_id_map[te],ae=!!(!se||se.blocked||se.passthrough);return _e.show_wcomponent_status_in_this_kv_section=!!(ne.id&&ae),_e.show_wcomponent_status_in_this_kv_section&&(_e.wcomponent_status_in_this_kv_text=(se!=null&&se.blocked?"Deleted from":"Not present in")+" this knowledge view"+(re&&!re.blocked?" but is present in a foundational knowledge view":"")),_e.show_add_button=_e.show_wcomponent_status_in_this_kv_section&&ee,_e.show_add_button&&(_e.add_button_text=(se!=null&&se.blocked?"Re-add":"Add")+" to current knowledge view"),_e.show_remove_button=!!(ee&&se&&!se.passthrough),_e.show_remove_button&&(_e.remove_button_text="Remove from knowledge view",_e.remove_button_tooltip="Remove from current knowledge view ("+ne.title+")",se!=null&&se.blocked&&ie[te]&&(_e.remove_button_text="Remove block (allow to show through from foundational knowledge view)",_e.remove_button_tooltip="This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view ("+ne.title+")")),_e.show_remove_and_block_button=!!(ee&&se&&!se.blocked&&!se.passthrough&&ie[te]),_e.show_remove_and_block_button&&(_e.remove_and_block_button_text="Remove and Block from knowledge view",_e.remove_and_block_button_tooltip="Remove and Block from showing in current knowledge view ("+ne.title+")"),_e}const map_state$G=(t,ee)=>{const{wcomponent_id:te}=ee,ne=get_current_knowledge_view_from_state(t),oe=ne&&ne.wc_id_map[te],ie=get_current_composed_knowledge_view_from_state(t),_e=ie&&ie.composed_wc_id_map[te],se=get_middle_of_screen(t);return{knowledge_view:ne,composed_knowledge_view_entry:_e,knowledge_view_entry:oe,middle_position_left:se.left,middle_position_top:se.top,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id}},map_dispatch$r={upsert_knowledge_view_entry:ACTIONS.specialised_object.upsert_knowledge_view_entry,bulk_remove_from_knowledge_view:ACTIONS.specialised_object.bulk_remove_from_knowledge_view},connector$G=connect(map_state$G,map_dispatch$r);function _WComponentKnowledgeViewForm(t){const{wcomponent_id:ee,knowledge_view:te,composed_knowledge_view_entry:ne,knowledge_view_entry:oe,editing_allowed:ie,knowledge_views_by_id:_e,wcomponents_by_id:se}=t;if(!te)return null;const re=get_foundational_knowledge_views(te,_e,!0),ae=get_composed_wc_id_maps_object(re,se),ce=get_foundational_knowledge_views(te,_e,!1),de=get_composed_wc_id_maps_object(ce,se),ue=get_wcomponent_status_in_knowledge_view({editing_allowed:ie,wcomponent_id:ee,knowledge_view:te,composed_wc_id_maps_object:ae,foundation_composed_wc_id_map:de.composed_wc_id_map}),{show_wcomponent_status_in_this_kv_section:le,wcomponent_status_in_this_kv_text:pe,show_add_button:me,add_button_text:fe,show_remove_button:ge,remove_button_text:he,remove_button_tooltip:be,show_remove_and_block_button:ve,remove_and_block_button_text:we,remove_and_block_button_tooltip:ye}=ue;function ke($e,Se={}){const Te={...ne||{left:t.middle_position_left,top:t.middle_position_top},...Se};t.upsert_knowledge_view_entry({wcomponent_id:ee,knowledge_view_id:$e,entry:Te})}const Ae=(oe==null?void 0:oe.frame_width)!==void 0&&(oe==null?void 0:oe.frame_height)!==void 0;return o$1("div",{children:[ie&&oe&&!oe.blocked&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Size"}),o$1(Slider,{color:"secondary",defaultValue:1,marks:!0,min:.25,max:2,onChange:($e,Se)=>{const Te=Array.isArray(Se)?Se[0]:Se;ke(te.id,{s:Te})},step:.25,value:oe.s?oe.s:1,valueLabelDisplay:"on"})]}),ie&&oe&&!oe.blocked&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Frame"}),o$1("p",{children:o$1(Button,{value:Ae?"Remove Frame":"Add Frame",onClick:()=>{const $e={};Ae?($e.frame_color=void 0,$e.frame_width=void 0,$e.frame_height=void 0):($e.frame_color=$e.frame_color??default_frame_color,$e.frame_width=$e.frame_width??(h_step+grid_small_step)*2,$e.frame_height=$e.frame_height??(v_step+grid_small_step)*2),ke(te.id,$e)}})}),o$1("span",{className:"description_label",children:"Frame Color"}),o$1(ColorPicker,{color:oe.frame_color,conditional_on_blur:$e=>{ke(te.id,{frame_color:$e})}})]}),ie&&o$1("p",{children:[o$1(AlignComponentForm,{wcomponent_id:ee}),o$1("br",{})]}),o$1("div",{style:{display:"inline-flex"},children:[o$1(MoveToWComponentButton,{wcomponent_id:ee,disable_if_not_present:!0}),o$1(Box,{zIndex:10,m:4,class:"node_handle",children:o$1(ExploreButtonHandle,{wcomponent_id:ee,wcomponent_current_kv_entry:ne,is_highlighted:!0})})]}),le&&o$1("div",{children:[pe,o$1("br",{}),me&&o$1(Button,{value:fe,extra_class_names:"left",onClick:()=>ke(te.id,{blocked:void 0,passthrough:void 0})})]}),ge&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:he,tooltip_text:be,on_delete:()=>{t.bulk_remove_from_knowledge_view({wcomponent_ids:[ee],remove_type:"passthrough"})}})}),ve&&o$1("div",{children:o$1(ConfirmatoryDeleteButton,{button_text:we,tooltip_text:ye,on_delete:()=>{t.bulk_remove_from_knowledge_view({wcomponent_ids:[ee],remove_type:"block"})}})}),ie&&o$1("p",{children:["Add to knowledge view",o$1(SelectKnowledgeView,{on_change:$e=>{$e&&ke($e,{blocked:void 0,passthrough:void 0})}})]}),o$1("p",{children:o$1(WComponentPresenceInOtherKVs,{wcomponent_id:ee})}),o$1("p",{children:o$1(WComponentBackReferences,{wcomponent_id:ee})})]})}const WComponentKnowledgeViewForm=connector$G(_WComponentKnowledgeViewForm),map_state$F=t=>({creation_context_state:t.creation_context}),connector$F=connect(map_state$F);function _WComponentImageForm(t){const{wcomponent:ee,upsert_wcomponent:te}=t,ne=ee.summary_image||void 0;return o$1(TextField,{fullWidth:!0,label:"Summary Image URL",onChange:oe=>{var _e,se;let ie=(_e=oe.target)!=null&&_e.value?(se=oe.target)==null?void 0:se.value:null;ie!==void 0&&te({summary_image:ie})},value:ne,variant:"outlined"})}const WComponentImageForm=connector$F(_WComponentImageForm);function make_valid_selector(t){let ee;if(!t)return;const{target_VAP_set_id:te,target_value:ne,target_value_id_type:oe}=t;return te?ne&&oe?ee={target_VAP_set_id:te,target_value:ne,target_value_id_type:oe}:ee={target_VAP_set_id:te}:ne&&oe?ee={target_value:ne,target_value_id_type:oe}:ee=void 0,ee}const map_state$E=(t,ee)=>{const{target_wcomponent_id:te}=ee.wcomponent,ne=t.specialised_objects.wcomponents_by_id[te||""],oe=wcomponent_is_allowed_to_have_state_VAP_sets(ne)&&ne;return{wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:t.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,editing:!t.display_options.consumption_formatting,target_wcomponent:oe,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t)}},map_dispatch$q={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$E=connect(map_state$E,map_dispatch$q);function _WComponentSubStateForm(t){const{wcomponents_by_id:ee,knowledge_views_by_id:te,wcomponent:ne,upsert_wcomponent:oe,target_wcomponent:ie,wc_id_to_counterfactuals_map:_e}=t,se=Array.from(t.wcomponent_ids_with_state_VAPs).map(le=>ee[le]).filter(is_defined).filter(wcomponent_is_allowed_to_have_state_VAP_sets),re=get_wcomponent_search_options({wcomponents:se,wcomponents_by_id:ee,knowledge_views_by_id:te,wc_id_to_counterfactuals_map:_e,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}),ae=ne.selector||{};let ce=[],de=[],ue=[];return ie&&(ce=ie.values_and_prediction_sets||[],ce=prune_items_by_created_at_and_versions_and_sort_by_datetimes(ce,t.created_at_ms),de=ce.map(({id:le,datetime:pe})=>{const me=uncertain_date_to_string(pe,"minute");return{id:le,title:me}}),ue=convert_VAP_sets_to_visual_sub_state_value_possibilities({selector:ne.selector,target_wcomponent:ie})),o$1("div",{children:[o$1("p",{children:[o$1("span",{className:"description_label",children:"Target component"}),"  ",ne.target_wcomponent_id&&o$1(Link,{route:void 0,sub_route:void 0,item_id:ne.target_wcomponent_id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"  "]}),o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ne.target_wcomponent_id,options:re,on_change:le=>oe({target_wcomponent_id:le,selector:void 0}),on_mouse_over_option:le=>t.set_highlighted_wcomponent({id:le,highlighted:!0}),on_mouse_leave_option:le=>t.set_highlighted_wcomponent({id:le,highlighted:!1})})})]}),ie&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Select value and prediction set timepoint of interest to display"}),"  ",o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ae.target_VAP_set_id,options:de,on_change:le=>{const pe=make_valid_selector({...ae,target_VAP_set_id:le});oe({selector:pe})},retain_options_order:!0})})]}),ie&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Select value possibility of interest to limit display by"}),"  ",o$1("div",{children:[o$1("input",{type:"radio",disabled:!t.editing,id:"not_set_target_value",checked:ae.target_value===void 0||ae.target_value_id_type===void 0,onChange:()=>{const le=make_valid_selector({...ae,target_value:void 0,target_value_id_type:void 0});oe({selector:le})}}),o$1("label",{for:"not_set_target_value",children:"Not set"})]}),ue.map(le=>{const{value:pe,id:me,selected:fe}=le;return o$1("div",{children:[o$1("input",{type:"radio",disabled:!t.editing,id:me,checked:fe||!1,onChange:()=>{const ge=make_valid_selector({...ae,target_value:me||pe,target_value_id_type:me?"id":"value_string"});oe({selector:ge})}}),o$1("label",{for:me,children:pe})]})})]})]})}const WComponentSubStateForm=connector$E(_WComponentSubStateForm);function WComponentConnectionForm(t){const{wcomponent:ee,editing:te,upsert_wcomponent:ne}=t,{line_behaviour:oe}=ee;return o$1("div",{children:te&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Line style behaviour"}),"  ",o$1(AutocompleteText,{selected_option_id:oe,allow_none:!0,options,on_change:ie=>{ne({line_behaviour:ie})}})]})})}const options=connection_line_behaviours.map(t=>({id:t,title:sentence_case(t)})),_wcomponent_statev2_subtypes={boolean:!0,number:!0,other:!0},wcomponent_statev2_subtypes=Object.keys(_wcomponent_statev2_subtypes),wcomponent_type_options=wcomponent_types.map(t=>({id:t,title:wcomponent_type_to_text(t)})),wcomponent_statev2_subtype_options=wcomponent_statev2_subtypes.map(t=>({id:t,title:t})),map_state$D=t=>{var ee;return{current_kv_id:(ee=get_current_knowledge_view_from_state(t))==null?void 0:ee.id,goal_or_action_wcomponent_ids:t.derived.wcomponent_ids_by_type.goal_or_action,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,is_editing:!t.display_options.consumption_formatting,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},connector$D=connect(map_state$D);function _WComponentParentGoalOrActionForm(t){const{wcomponent:ee,wcomponents_by_id:te,upsert_wcomponent:ne}=t,oe=F$1(()=>{const _e=Array.from(t.goal_or_action_wcomponent_ids).map(re=>te[re]).filter(is_defined);function se(re){return re.id===t.current_kv_id?new Date().getTime():re.created_at.getTime()}return sort_list(_e,se,SortDirection.descending)},[t.goal_or_action_wcomponent_ids,te,t.current_kv_id]),ie=get_wcomponent_search_options({wcomponents:oe,wcomponents_by_id:te,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:{},created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Parent Goal (or Action)"}),o$1(MultiAutocompleteText,{placeholder:"Add Label",selected_option_ids:ee.parent_goal_or_action_ids||[],options:ie,allow_none:!0,on_change:_e=>{const se=_e.filter(re=>!!re);ne({parent_goal_or_action_ids:se})}})]})}const WComponentParentGoalOrActionForm=connector$D(_WComponentParentGoalOrActionForm),map_state$C=t=>({current_knowledge_view:get_current_composed_knowledge_view_from_state(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:t.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,editing:!t.display_options.consumption_formatting,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t)}),map_dispatch$p={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$C=connect(map_state$C,map_dispatch$p);function _WComponentStateValueForm(t){const{current_knowledge_view:ee,wcomponents_by_id:te,knowledge_views_by_id:ne,wcomponent:oe,upsert_wcomponent:ie,wc_id_to_counterfactuals_map:_e}=t,se=Array.from(t.wcomponent_ids_with_state_VAPs).map(ue=>te[ue]).filter(is_defined).filter(wcomponent_is_allowed_to_have_state_VAP_sets),re=ee==null?void 0:ee.composed_wc_id_map[oe.id];function ae(ue){const le=ee==null?void 0:ee.composed_wc_id_map[ue.id];return square_distance_between_kv_entries(re,le)}const ce=sort_list(se,ae,SortDirection.ascending),de=get_wcomponent_search_options({wcomponents:ce,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:_e,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1("div",{children:o$1("p",{children:[o$1("span",{className:"description_label",children:"Attribute (target) component"}),"  ",oe.attribute_wcomponent_id&&o$1(Link,{route:void 0,sub_route:void 0,item_id:oe.attribute_wcomponent_id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"  "]}),o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:oe.attribute_wcomponent_id,options:de,on_change:ue=>{const le=te[ue||""];let{value_possibilities:pe}=oe;if((!pe||!Object.keys(pe))&&wcomponent_is_statev2(le)){const me=get_wcomponent_VAPs_represent(le,te),fe=get_possibilities_from_VAP_sets(me,le.value_possibilities,le.values_and_prediction_sets||[]);pe=get_items_by_id(fe,"attribute's possible_values")}ie({attribute_wcomponent_id:ue,value_possibilities:pe})},on_mouse_over_option:ue=>t.set_highlighted_wcomponent({id:ue,highlighted:!0}),on_mouse_leave_option:ue=>t.set_highlighted_wcomponent({id:ue,highlighted:!1})})})]})})}const WComponentStateValueForm=connector$C(_WComponentStateValueForm),PredictionSummary$1="",map_state$B=t=>({time_resolution:t.display_options.time_resolution}),connector$B=connect(map_state$B);function _PredictionSummary(t){const{value:ee,created_at:te,datetime:ne,probability:oe,conviction:ie,time_resolution:_e}=t;return o$1("div",{children:[te&&o$1("div",{style:{display:"inline-flex"},children:["Created:  ",o$1(EditableCustomDateTime,{invariant_value:te,value:void 0})]}),o$1("div",{className:"summary_container",children:[o$1("div",{className:"summary_row",children:[o$1("div",{className:"datetimes",children:uncertain_date_to_string(ne,_e)}),ee&&o$1("div",{children:["      ",ee]})]}),o$1("div",{className:"summary_row",children:[o$1("div",{children:[o$1("span",{className:"description_label",children:"Prob"})," ",oe]}),"   ",o$1("div",{children:[o$1("span",{className:"description_label",children:"Confidence"})," ",ie]})]})]})]})}const PredictionSummary=connector$B(_PredictionSummary);function PredictionViewSummary(t){const{prediction:ee,on_change:te}=t,{datetime:ne,probability:oe,conviction:ie}=ee;return o$1(PredictionSummary,{datetime:ne,probability:o$1(EditablePercentage,{placeholder:"...",value:oe,conditional_on_change:te&&(_e=>te({...ee,probability:_e}))}),conviction:o$1(EditablePercentage,{placeholder:"...",value:ie,conditional_on_change:te&&(_e=>te({...ee,conviction:_e}))})})}function PredictionViewDetails(t){const{on_change:ee,prediction:te}=t,{explanation:ne=""}=te,oe=ee?_e=>{const se={...te,..._e};ee(se)}:void 0,ie=oe?{on_blur:_e=>oe({explanation:_e}),on_blur_type:EditableTextOnBlurType.conditional}:{};return o$1("div",{children:[o$1("br",{}),o$1(UncertainDateTimeForm,{datetime:te.datetime,on_change:_e=>oe&&oe({datetime:_e})}),o$1("br",{}),(t.editing||ne)&&o$1("div",{children:o$1(EditableText,{placeholder:"Explanation",value:ne,...ie})})]})}const NewItemForm$1="";function NewItemForm(t){const{new_item:ee,set_new_item:te,item_descriptor:ne,item_props:oe}=t,{crud:ie}=oe,_e=F$1(()=>({...ie,update_item:te}),[ie,te]);return ee?o$1(Box,{children:o$1(Dialog,{"aria-labelledby":"new_item_title",open:!0,onClose:()=>te(void 0),fullWidth:!0,maxWidth:"sm",children:[o$1(DialogTitle,{id:"new_item_title",children:["New ",ne]}),o$1(DialogContent,{children:o$1(EditableListEntry,{item:ee,...oe,expanded:!0,crud:_e})}),o$1(DialogActions,{children:[o$1(Button,{onClick:()=>{setTimeout(()=>ie.create_item(ee),0)},children:["Add ",ne]}),o$1(Button,{onClick:()=>te(void 0),children:"Cancel"})]})]})}):null}const map_state$A=t=>({created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,creation_context:t.creation_context,editing:!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)}),connector$A=connect(map_state$A);function _PredictionList(t){const[ee,te]=h$1(void 0),{item_descriptor:ne,predictions:oe,update_predictions:ie,created_at_ms:_e,sim_ms:se,editing:re,base_id:ae=-1}=t,ce=F$1(()=>({get_created_at:get_created_at$1,get_custom_created_at:get_custom_created_at$1,get_summary:get_summary$1,get_details:factory_get_details(re),crud:{create_item:ke=>{ie([...oe,ke]),te(void 0)}}}),[re,oe,ie]),de=F$1(()=>({get_created_at:get_created_at$1,get_custom_created_at:get_custom_created_at$1,get_summary:get_summary$1,get_details:factory_get_details(re),crud:{update_item:ke=>{const $e=replace_element(oe,ke,Se=>get_id$2(Se)===get_id$2(ke));ie($e)},delete_item:ke=>{const $e=remove_element(oe,Se=>get_id$2(Se)===get_id$2(ke));ie($e)}},delete_button_text:"Delete "+ne}),[re,oe,ie,ne]),{invalid_future_items:ue,future_items:le,present_item:pe,past_items:me}=partition_and_prune_items_by_datetimes_and_versions({items:oe,created_at_ms:_e,sim_ms:se}),fe=pe?[pe]:[],ge=factory_render_list_content({items:le,get_id:get_id$2,item_props:de}),he=factory_render_list_content({items:fe,get_id:get_id$2,item_props:de}),be=factory_render_list_content({items:me,get_id:get_id$2,item_props:de}),ve=re||le.length>0,we=re||fe.length>0,ye=re||me.length>0;return o$1("div",{children:[re&&o$1(ListHeaderAddButton,{new_item_descriptor:ne,on_pointer_down_new_list_entry:()=>te(prepare_new_item(ae,t.creation_context))}),o$1(NewItemForm,{new_item:ee,set_new_item:te,item_props:ce,item_descriptor:ne}),ue.length>0&&o$1("div",{children:["Hidden (",ue.length,")"]}),oe.length>0&&o$1("div",{children:[ve&&o$1(ExpandableList,{content:ge,item_descriptor:"",items_descriptor:get_items_descriptor("Future",le.length,re),disable_collapsed:!0}),(ve||we)&&o$1("hr",{}),we&&o$1(ExpandableList,{content:he,item_descriptor:"",items_descriptor:get_items_descriptor("Present",fe.length,re),disable_collapsed:!0}),we&&ye&&o$1("hr",{}),ye&&o$1(ExpandableList,{content:be,item_descriptor:"",items_descriptor:get_items_descriptor("Past",me.length,re),disable_collapsed:!0})]})]})}const PredictionList=connector$A(_PredictionList),get_id$2=t=>t.id,get_created_at$1=t=>t.created_at,get_custom_created_at$1=t=>t.custom_created_at;function get_summary$1(t,ee){return o$1(PredictionViewSummary,{prediction:t,on_change:ee.update_item})}function factory_get_details(t){return(ee,te)=>o$1(PredictionViewDetails,{prediction:ee,on_change:te.update_item,editing:t})}function prepare_new_item(t,ee){const te=get_new_created_ats(ee),ne=floor_datetime_to_resolution(te.custom_created_at||te.created_at,"day");return{id:get_new_prediction_id(),...te,base_id:t,datetime:{value:ne},explanation:"",probability:1,conviction:1}}const map_state$z=t=>({consumption_formatting:t.display_options.consumption_formatting}),map_dispatch$o={change_route:ACTIONS.routing.change_route},connector$z=connect(map_state$z,map_dispatch$o);function _WComponentValidityPredictionsForm(t){const{wcomponent:ee}=t,{validity:te=[]}=ee,[ne,oe]=h$1(te.length>0);return t.consumption_formatting&&te.length===0?null:o$1("div",{className:"editable_list_entry padded "+(ne?"expanded":""),children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>oe(!ne),children:[o$1("div",{className:"summary",children:o$1("h4",{style:{display:"inline-block"},children:["Validity Predictions ",!ne&&te.length?`(${te.length})`:""]})}),o$1("div",{className:"expansion_button"})]}),ne&&o$1(PredictionList,{item_descriptor:(wcomponent_is_plain_connection(ee)?"Existence ":"Validity ")+" prediction",predictions:te,update_predictions:ie=>{const _e=new Date().getTime()+1;t.change_route({args:{created_at_ms:_e,sim_ms:_e}}),t.upsert_wcomponent({validity:ie})}})]})}const WComponentValidityPredictionsForm=connector$z(_WComponentValidityPredictionsForm);function format_number_to_significant_figures(t,ee){if(t===0)return"0";const te=Math.floor(Math.log10(Math.abs(t))),ne=te+1-ee,ie=(Math.round(t/Math.pow(10,ne))*Math.pow(10,ne)).toString();if(ne>=0)return ie;{const se=ie.indexOf(".")!==-1;let re=ie+(se?"":".");const ae=(Math.abs(t)>=1?re.length:re.length+te)-1-(t<0?1:0);let ce=ee-ae;ce=Math.max(0,ce),re+="0".repeat(ce);const de=ee+(te<0?-te:0)+1+(t<0?1:0);return re=re.slice(0,de),re}}function str_enum(t){return t.reduce((ee,te)=>(ee[te]=te,ee),Object.create(null))}const NUMBER_DISPLAY_TYPES=str_enum(["bare","simple","scaled","percentage","abbreviated_scaled","scientific"]);function round_to_max_significant_figures(t,ee){if(t===0)return 0;const te=Math.pow(10,ee-Math.floor(Math.log10(Math.abs(t)))-1);return Math.round(t*te)/te}function format_number_to_string(t,ee,te){let ne;if(ee=Math.round(ee),ee=ee<1?1:ee,te===NUMBER_DISPLAY_TYPES.bare)ne=round_to_max_significant_figures(t,ee).toString();else if(te===NUMBER_DISPLAY_TYPES.simple){const oe=round_to_max_significant_figures(t,ee);ne=Math.abs(oe)<1?oe.toString():oe.toLocaleString()}else if(te===NUMBER_DISPLAY_TYPES.scaled)ne=scale_number(t,ee);else if(te===NUMBER_DISPLAY_TYPES.percentage)ne=round_to_max_significant_figures(t*100,ee).toString()+"%";else if(te===NUMBER_DISPLAY_TYPES.abbreviated_scaled)ne=abbreviate_number(t,ee);else if(te===NUMBER_DISPLAY_TYPES.scientific){const oe=minimise_significant_figures(t,ee);ne=t.toExponential(oe-1)}else throw new Error(`Unimplemented display type ${te}`);return ne=ne.replace("e+","e").trim(),ne}function scale_number(t,ee){const te=["","thousand","million","billion","trillion"];let ne=0;for(;Math.abs(t)>=1e3&&ne<te.length-1;)t/=1e3,ne++;const oe=minimise_significant_figures(t,ee);return format_number_to_significant_figures(t,oe)+" "+te[ne]}function abbreviate_number(t,ee){const te=["","k","m","bn","tn"];let ne=0;for(;Math.abs(t)>=1e3&&ne<te.length-1;)t/=1e3,ne++;const oe=minimise_significant_figures(t,ee);return format_number_to_significant_figures(t,oe)+" "+te[ne]}function minimise_significant_figures(t,ee){let te=ee;for(;te>1&&Number.parseFloat(t.toPrecision(te-1))===t;)--te;return te}const d$3="M19 5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 14h-14v-5h14z m0 -12v5h-14v-5h1v-2h12v2z m-3 -2h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function AddRowAbove(t){return o$1(CommonIcon,{...t,d:d$3})}const d$2="M19 2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 7h-14v-5h14z m0 7h-1v2h-12v-2h-1v-5h14z m-3 0h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function AddRowBelow(t){return o$1(CommonIcon,{...t,d:d$2})}function EditableCalculationRowOptions(t){const[ee,te]=h$1(!1);return o$1(k$1,{children:[o$1(Tooltip,{title:"Add above",children:o$1(IconButton,{onClick:()=>t.update_calculations("add_above"),size:"large",children:o$1(AddRowAbove,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),o$1(Tooltip,{title:"Add below",children:o$1(IconButton,{onClick:()=>t.update_calculations("add_below"),size:"large",children:o$1(AddRowBelow,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),o$1(Tooltip,{title:"Move up",children:o$1(IconButton,{onClick:()=>t.update_calculations("move_up"),size:"large",disabled:t.disallowed_commands.has("move_up"),children:o$1(ArrowUpward$1,{})})}),o$1(Tooltip,{title:"Move down",children:o$1(IconButton,{onClick:()=>t.update_calculations("move_down"),size:"large",disabled:t.disallowed_commands.has("move_down"),children:o$1(ArrowDownward$1,{})})}),!ee&&o$1(IconButton,{onClick:()=>te(!0),size:"large",children:o$1(DeleteIcon,{})}),ee&&o$1(ConfirmatoryButton,{on_click:t.delete_calculation,button_text:"",button_icon:o$1(DeleteIcon,{}),ready_to_progress:!0,on_cancel:()=>te(!1)})]})}function EditableCalculationRowResultsFormatting(t){const{result:ee,default_significant_figures:te,temp_result_sig_figs:ne,set_temp_result_sig_figs:oe,result_display_type:ie,update_calculation:_e}=t,se=get_number_display_options(ee,ne??te);return o$1("div",{style:{display:"flex"},children:[o$1("div",{"data-tooltip":"Significant figures","data-tooltip_left_-10":!0,"data-tooltip_bottom_-60":!0,children:o$1(EditableNumber,{size:"small",style:{marginLeft:5,marginTop:5,width:"80px"},placeholder:"Sig. figs",value:ne,allow_undefined:!0,conditional_on_change:re=>{re=sanitise_significant_figures_value(re),oe(re)},on_blur_type:EditableTextOnBlurType.always,on_blur:re=>{re=sanitise_significant_figures_value(re),oe(re??te),_e({result_sig_figs:re})}})}),o$1("div",{"data-tooltip":"Display type","data-tooltip_left_0":!0,"data-tooltip_bottom_-60":!0,style:{marginLeft:"10px",width:"120px"},children:[o$1("div",{className:"description_label",children:"Format"}),o$1(AutocompleteText,{selected_option_id:ie,options:se,retain_options_order:!0,on_change:re=>{const ae=se.find(de=>de.id===re),ce=ae==null?void 0:ae.result_display_type;_e({result_display_type:ce})}})]})]})}function sanitise_significant_figures_value(t){if(t!==void 0)return Math.max(Math.round(t),0)}function get_number_display_options(t,ee){t=t??1000.23;const te={bare:{id:"bare",order:0,result_display_type:"bare",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.bare)},simple:{id:"simple",order:1,result_display_type:"simple",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.simple)},scaled:{id:"scaled",order:2,result_display_type:"scaled",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.scaled)},percentage:{id:"percentage",order:4,result_display_type:"percentage",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.percentage)},abbreviated_scaled:{id:"abbreviated_scaled",order:3,result_display_type:"abbreviated_scaled",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.abbreviated_scaled)},scientific:{id:"scientific",order:5,result_display_type:"scientific",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.scientific)}},ne={...te};return te.abbreviated_scaled.title===te.scaled.title&&delete ne.abbreviated_scaled,te.scaled.title===te.simple.title&&delete ne.scaled,te.simple.title===te.bare.title&&delete ne.simple,Object.values(ne).sort((ie,_e)=>ie.order-_e.order)}const DEFAULT_SIGNIFICANT_FIGURES=2;function get_default_significant_figures(t){const ee=parseInt(t,10);return number_value_is_year(ee)?4:DEFAULT_SIGNIFICANT_FIGURES}function get_default_result_display_type(t){const ee=parseInt(t,10);return number_value_is_year(ee)?NUMBER_DISPLAY_TYPES.bare:t.trim().match(/\d+\.?\d*\s*\%/)?NUMBER_DISPLAY_TYPES.percentage:NUMBER_DISPLAY_TYPES.simple}function number_value_is_year(t){return Number.isSafeInteger(t)&&t>=1900&&t<=2200}function get_valid_calculation_name_id(t,ee=""){const te=ee.toUpperCase(),ne=get_disallowed_ids(t);if(ee&&!ne.has(te))return ee;let oe=name_id_string_to_num(ee||"A"),ie=num_to_name_id_string(oe);for(;ne.has(ie);)oe=increase_candidate_name_id_num(oe),ie=num_to_name_id_string(oe);return ee&&(ie=match_case(ie,ee)),ie}function get_disallowed_ids(t){return new Set([...SIMULATION_JS_RESERVED_WORDS,...t].map(te=>te.toUpperCase().replaceAll(/\s*/g,"")))}function name_id_string_to_num(t){return t=t.toUpperCase(),t.split("").map(ee=>ee.charCodeAt(0)).filter(ee=>ee>=65&&ee<=90)}function num_to_name_id_string(t){return t.map(ee=>String.fromCharCode(ee)).join("")}function increase_candidate_name_id_num(t){let ee=!1;for(let te=t.length-1;te>=0;--te)if(t[te]=t[te]+1,t[te]>90)t[te]=65,ee=!0;else{ee=!1;break}return ee&&t.push(65),t}function match_case(t,ee){return t.split("").map((te,ne)=>{const oe=ee.charCodeAt(ne);return oe>=97&&oe<=122&&(te=te.toLowerCase()),te}).join("")}function make_calculation_safe_for_rich_text(t){return t.replaceAll("*","\\*")}function EditableCalculationRow(t){const{calculation:ee,calculation_result:te,editing:ne,existing_calculation_name_ids:oe,show_options:ie,set_show_options:_e}=t,se=get_default_significant_figures(ee.value),{result_sig_figs:re=se}=ee,[ae,ce]=h$1(re),de=get_default_result_display_type(ee.value),{result_display_type:ue=de}=ee;if(!ne&&!ee.value&&!ee.units)return null;let le=o$1("div",{});if(te!==void 0&&te.value!==void 0){const he=format_number_to_string(te.value,ae??se,ue);le=o$1("div",{children:[" = ",he,te.units&&o$1("span",{style:{fontSize:"14px"},children:[" ",te.units]}),ee.result_description&&o$1("span",{style:{fontSize:"14px"},children:[" ",o$1(RichMarkDown,{text:ee.result_description})]})]})}const pe=ne||should_show_calc_value(ee.value),me=!!ee.value.match(only_double_at_mentioned_uuids_regex),fe={display:"flex"},ge=get_error_or_warning_message(te,fe);return o$1(Box,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",marginBottom:ne?"18px":void 0,flexDirection:ne?"column":"row",style:{display:"flex"},className:"form_section "+(ie?"":"hidden_border"),children:[o$1(FormatCalculationErrorOrWarning,{...ge}),o$1("div",{style:{width:"100%",display:"flex"},children:[o$1(EditableTextSingleLine,{size:"small",placeholder:"",hide_label:!0,value:ee.name,on_blur:he=>{const be=oe.filter(we=>we!==ee.name),ve=get_valid_calculation_name_id(be,he);t.update_calculation({...ee,name:ve})},on_blur_type:EditableTextOnBlurType.conditional}),pe&&o$1(k$1,{children:[" = ",o$1(EditableText,{placeholder:"Calculation",hide_label:!0,value:ne?ee.value:make_calculation_safe_for_rich_text(ee.value),on_blur:he=>t.update_calculation({...ee,value:he}),on_blur_type:EditableTextOnBlurType.conditional})," "]}),ne&&o$1(EditableTextSingleLine,{placeholder:"Units",hide_label:!0,disabled_input:me,title:me?"Editing disabled: edit units of referenced component":void 0,value:(me?te==null?void 0:te.units:ee.units)||"",modify_value_pre_on_blur:he=>me?(te==null?void 0:te.units)||"":he,on_blur:he=>t.update_calculation({...ee,units:he||void 0}),on_blur_type:EditableTextOnBlurType.conditional}),!ne&&le]}),ne&&o$1("div",{style:{...fe,marginTop:void 0},children:[le,o$1(IconButton,{onClick:()=>_e(!ie),size:"small",style:{marginLeft:"auto"},children:o$1(SettingsIcon,{})})]}),t.editing&&ie&&o$1(EditableCalculationRowResultsFormatting,{result:te==null?void 0:te.value,default_significant_figures:se,temp_result_sig_figs:ae,set_temp_result_sig_figs:ce,result_display_type:ue,update_calculation:he=>{t.update_calculation({...ee,...he})}}),t.editing&&ie&&o$1("div",{style:{...fe,marginLeft:10,marginTop:20},children:o$1("div",{style:{display:"flex"},children:o$1(EditableTextSingleLine,{size:"small",placeholder:"Description",value:ee.result_description||"",on_blur_type:EditableTextOnBlurType.conditional,on_blur:he=>{const be=he||void 0;t.update_calculation({...ee,result_description:be})}})})}),t.editing&&ie&&o$1("div",{style:{...fe,justifyContent:"flex-end"},children:o$1(EditableCalculationRowOptions,{delete_calculation:()=>t.update_calculation(null),disallowed_commands:t.disallowed_commands,update_calculations:t.update_calculations})})]})}const CALULATION_SIGNS=/.*[\^*\/+\-()><=].*/g;function should_show_calc_value(t){let ee="";for(;ee=t.replace(double_at_mentioned_uuids_regex_capture_surrounding,"$1$3"),ee!==t;)t=ee;return!!ee.match(CALULATION_SIGNS)}const map_state$y=t=>({editing:!t.display_options.consumption_formatting,wcomponents_by_id:t.derived.composed_wcomponents_by_id}),map_dispatch$n={},connector$y=connect(map_state$y,map_dispatch$n);function _WComponentCalculatonsForm(t){const{wcomponent:ee,wcomponents_by_id:te}=t,{calculations:ne=[]}=ee;ne.forEach((de,ue)=>de.id=de.id??ue);const[oe,ie]=h$1(ne.length>0),_e={};ne.forEach(de=>_e[de.id]=!1);const[se,re]=h$1(_e),ae=perform_calculations(ne,te),ce=ne.map(({name:de})=>de);return o$1("div",{className:"editable_list_entry padded "+(oe?"expanded":""),children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>ie(!oe),children:[o$1("div",{className:"summary",children:[o$1("h4",{style:{display:"inline-block"},children:["Calculations ",!oe&&ne.length?`(${ne.length})`:""]}),o$1("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:o$1(WarningTriangleV2,{warning:"",label:""})})]}),o$1("div",{className:"expansion_button"})]}),oe&&o$1("div",{children:[o$1(Box,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:ne.map((de,ue)=>o$1(EditableCalculationRow,{editing:t.editing,show_options:se[de.id]||!1,set_show_options:le=>{const pe={...se,[de.id]:le};re(pe)},calculation:de,calculation_result:ae[ue],existing_calculation_name_ids:ce,update_calculation:le=>{const me=[...ne.slice(0,ue),le,...ne.slice(ue+1)].filter(ge=>!!ge),fe=me.length?me:void 0;t.upsert_wcomponent({calculations:fe})},disallowed_commands:(()=>{const le=new Set;return ue===0&&le.add("move_up"),ue===ne.length-1&&le.add("move_down"),le})(),update_calculations:le=>{if(le==="move_up"){const pe=ue-1;if(!index_is_in_bounds(ne,pe))return;const me=swap_elements(ne,ue,pe);t.upsert_wcomponent({calculations:me})}else if(le==="move_down"){const pe=ue+1;if(!index_is_in_bounds(ne,pe))return;const me=swap_elements(ne,ue,pe);t.upsert_wcomponent({calculations:me})}else if(le==="add_above"){const pe=prepare_new_calculation(ne),me=insert_element_at_index(ne,pe,ue);t.upsert_wcomponent({calculations:me})}else if(le==="add_below"){const pe=prepare_new_calculation(ne),me=insert_element_at_index(ne,pe,ue+1);t.upsert_wcomponent({calculations:me})}}},de.id))}),t.editing&&o$1(Button,{value:"Add calculation",fullWidth:!0,onClick:()=>{const de=prepare_new_calculation(ne),ue=[...ne,de];t.upsert_wcomponent({calculations:ue})}})]})]})}const WComponentCalculatonsForm=connector$y(_WComponentCalculatonsForm);function prepare_new_calculation(t){let ee=-1;t.forEach(oe=>ee=Math.max(ee,oe.id)),++ee;const te=get_valid_calculation_name_id(t.map(({name:oe})=>oe));return{id:ee,name:te,value:""}}function get_value_possibilities_by_value(t,ee){const te={};return Object.values(t||{}).forEach(ne=>{const oe=ee?ne.value.toLowerCase():ne.value;te[oe]=ne}),te}function update_VAPSets_with_possibilities(t,ee){if(t===void 0)return;const te=ee||{},ne=get_value_possibilities_by_value(te,!1);return t.map(oe=>({...oe,entries:oe.entries.map(ie=>{let{value_id:_e,value:se,description:re}=ie,ae=te[_e||""];return ae||(_e=void 0,ae=ne[ie.value]),ae&&(_e=ae.id,se=ae.value,re=ae.description),{...ie,value_id:_e,value:se,description:re}})}))}const test_update_VAPSets_with_possibilities=describe.delay("update_VAPSets_with_possibilities",()=>{var se,re,ae,ce,de,ue,le,pe,me,fe,ge,he,be,ve,we,ye,ke,Ae,$e,Se,Te,xe,Ie,Pe;const t="val_prob_id_123",ee="val_prob_id_456",te="value abc",ne="value def456",oe={[t]:{id:t,value:te,description:"description abc",order:0},[ee]:{id:ee,value:ne,description:"description def456",order:1}},ie=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...prepare_new_VAP(),value_id:t,value:"old abc value",description:"old abc description"},{...prepare_new_VAP(),value_id:"defunct_id",value:te,description:"old abc description"},{...prepare_new_VAP(),value_id:ee,value:te,description:""}]}];let _e=update_VAPSets_with_possibilities(void 0,void 0);test(_e,void 0,"Undefined initial VAPs returns undefined"),_e=update_VAPSets_with_possibilities(void 0,oe),test(_e,void 0,"Undefined initial VAPs returns undefined"),_e=update_VAPSets_with_possibilities([],oe),test(_e,[],"Empty initial VAPs returns empty"),_e=update_VAPSets_with_possibilities(ie,void 0),test(_e==null?void 0:_e.length,ie.length,"Undefined value_possibilities returns all VAPs"),_e&&(test((re=(se=_e[0])==null?void 0:se.entries[0])==null?void 0:re.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),test((ce=(ae=_e[0])==null?void 0:ae.entries[1])==null?void 0:ce.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),test((ue=(de=_e[0])==null?void 0:de.entries[2])==null?void 0:ue.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids")),console.log("Updates VAPs in VAP Set with value_possibilities ..."),_e=update_VAPSets_with_possibilities(ie,oe),test(Array.isArray(_e),!0,"Returns an array"),_e&&(test((pe=(le=_e[0])==null?void 0:le.entries[0])==null?void 0:pe.value,(me=oe[t])==null?void 0:me.value,"Updates value"),test((ge=(fe=_e[0])==null?void 0:fe.entries[0])==null?void 0:ge.description,(he=oe[t])==null?void 0:he.description,"Updates description"),test((ve=(be=_e[0])==null?void 0:be.entries[1])==null?void 0:ve.value_id,t,"Updates id based on matched value"),test((ye=(we=_e[0])==null?void 0:we.entries[1])==null?void 0:ye.description,(ke=oe[t])==null?void 0:ke.description,"Updates description based on matched value/id"),test(($e=(Ae=_e[0])==null?void 0:Ae.entries[2])==null?void 0:$e.value_id,ee,"Does not update id based on matched value if ID valid"),test((Te=(Se=_e[0])==null?void 0:Se.entries[2])==null?void 0:Te.value,ne,"Updates value"),test((Ie=(xe=_e[0])==null?void 0:xe.entries[2])==null?void 0:Ie.description,(Pe=oe[ee])==null?void 0:Pe.description,"Updates description"))});function ValuePossibilityComponent(t){const{editing:ee,value_possibility:te,count_of_value_possibilities:ne,update_value_possibility:oe}=t,[ie,_e]=h$1(te.value);p$1(()=>_e(te.value),[te.value]);const re=(ne[ie.toLowerCase()]||0)>1?`Current value "${ie}" is already present in other possible values.`:"";return o$1(Box,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",style:{display:"flex"},children:[o$1(Box,{style:{width:"100%"},children:[o$1(WarningTriangleV2,{warning:re,label:"Duplicate"}),o$1(Typography,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:o$1(EditableTextSingleLine,{placeholder:"Possible value",hide_label:!0,value:te.value,conditional_on_change:ae=>_e(ae),on_blur:ae=>{oe({...te,value:ae})},on_blur_type:EditableTextOnBlurType.conditional})})]}),VALUE_POSSIBILITY_IDS_to_text[te.id]&&o$1(Box,{style:{width:100,color:"#cb4",cursor:"pointer"},title:"Using interoperable ID",children:VALUE_POSSIBILITY_IDS_to_text[te.id]}),ee&&o$1(IconButton,{onClick:()=>oe(void 0),size:"large",children:o$1(default_1$a,{})})]},t.value_possibility.id)}function prepare_new_value_possibility(t){const ee=get_max_value_possibilities_order(t);return{id:v4(),value:"",description:"",order:ee+1}}function WComponentValuePossibilitiesForm(t){const[ee,te]=h$1(!1);if(t.VAPs_represent===VAPsType.undefined)return null;const ne=value_possibilities_as_list(t.value_possibilities),{count_of_value_possibilities:oe,max_count:ie}=get_count_of_value_possibilities(ne),_e=ie>1?"Duplicate value possibilities present":"",se=`editable_list_entry padded ${ee?"expanded":""}`,{attribute_wcomponent:re}=t;return o$1("div",{className:se,children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>te(!ee),children:[o$1("div",{className:"summary",children:[o$1("h4",{style:{display:"inline-block"},children:["Possible Values ",!ee&&ne.length?`(${ne.length})`:""]}),o$1("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:o$1(WarningTriangleV2,{warning:_e,label:""})})]}),o$1("div",{className:"expansion_button"})]}),ee&&o$1("div",{children:[o$1(Box,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:ne.map(ae=>o$1(ValuePossibilityComponent,{editing:t.editing,value_possibility:ae,count_of_value_possibilities:oe,update_value_possibility:ce=>{const de={...t.value_possibilities};ce?de[ce.id]=ce:delete de[ae.id];const ue=Object.keys(de).length>0;t.update_value_possibilities(ue?de:void 0)}}))}),t.editing&&o$1(Button,{value:"New possibility",fullWidth:!0,onClick:()=>{const ae=prepare_new_value_possibility(t.value_possibilities),ce={...t.value_possibilities,[ae.id]:ae};t.update_value_possibilities(ce)}}),t.editing&&o$1(Button,{value:"Use defaults",fullWidth:!0,onClick:()=>{const ae=get_possibilities_from_VAP_sets(t.VAPs_represent,void 0,t.values_and_prediction_sets),ce=get_items_by_id(ae,"default_possible_values");t.update_value_possibilities(ce)}}),t.editing&&re&&wcomponent_is_statev2(re)&&o$1(Button,{value:"Use attribute's possibilities",fullWidth:!0,onClick:()=>{const ae=get_possibilities_from_VAP_sets(t.VAPs_represent,re.value_possibilities,re.values_and_prediction_sets||[]),ce=get_items_by_id(ae,"attribute's possible_values");t.update_value_possibilities(ce)}})]})]})}function get_count_of_value_possibilities(t){const ee={};let te=0;return t.forEach(({value:ne})=>{ne=ne.toLowerCase();const oe=(ee[ne]||0)+1;ee[ne]=oe,te=Math.max(te,oe)}),{count_of_value_possibilities:ee,max_count:te}}function value_possibilities_as_list(t){return Object.values(t||{}).sort((ee,te)=>ee.order<te.order?-1:1)}const map_state$x=(t,ee)=>({created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,creation_context:t.creation_context,editing:ee.editing_allowed??!t.display_options.consumption_formatting,current_created_at_ms:t.routing.args.created_at_ms}),map_dispatch$m={change_route:ACTIONS.routing.change_route},connector$x=connect(map_state$x,map_dispatch$m);function _EasyActionValueAndPredictionSets(t){var Ae;const{existing_value_possibilities:ee,values_and_prediction_sets:te,VAPs_represent:ne,base_id:oe,editing:ie,current_created_at_ms:_e,sim_ms:se,creation_context:re,update_VAPSets_and_value_possibilities:ae,change_route:ce}=t;if(!ie||ne!==VAPsType.action)return null;const{latest:de}=group_versions_by_id(te),le=sort_by_uncertain_event_datetimes(de)[0],pe=(Ae=le==null?void 0:le.entries.find($e=>$e.probability===1))==null?void 0:Ae.value_id,me=pe===ACTION_VALUE_POSSIBILITY_ID.action_potential,fe=pe===ACTION_VALUE_POSSIBILITY_ID.action_paused,ge=pe===ACTION_VALUE_POSSIBILITY_ID.action_in_progress,he=pe===ACTION_VALUE_POSSIBILITY_ID.action_completed,be=!le||me||fe,ve=he,we=ge,ye=!le||ge;function ke($e){const Se=set_action_VAP_set_state({existing_value_possibilities:ee,orig_values_and_prediction_sets:te,base_id:oe,creation_context:re,action_value_possibility_id:$e});handle_update_VAP_sets({existing_value_possibilities:ee,new_values_and_prediction_sets:Se,orig_values_and_prediction_sets:te,current_created_at_ms:_e,sim_ms:se,update_VAPSets_and_value_possibilities:ae,change_route:ce})}return o$1("div",{children:[(be||ve)&&o$1(Button,{value:ve?"Restart (In Progress)":"In Progress",fullWidth:!0,color:"secondary",onClick:()=>ke(ACTION_VALUE_POSSIBILITY_ID.action_in_progress)}),we&&o$1(Button,{value:"Pause",fullWidth:!0,color:"secondary",onClick:()=>ke(ACTION_VALUE_POSSIBILITY_ID.action_paused)}),ye&&o$1(Button,{value:"Completed",fullWidth:!0,color:"secondary",onClick:()=>ke(ACTION_VALUE_POSSIBILITY_ID.action_completed)})]})}const EasyActionValueAndPredictionSets=connector$x(_EasyActionValueAndPredictionSets);function get_probable_VAP_set_values_for_display(t,ee){const te=get_VAPs_ordered_by_prob(t.entries,ee),ne=te[0];if(ee===VAPsType.boolean&&ne)return o$1(k$1,{children:ne.probability>.5?"True":"False"});const oe=ee===VAPsType.number,ie=te.filter(({probability:_e})=>_e>0);return o$1(k$1,{children:[ie.map((_e,se)=>o$1("span",{children:[oe?o$1(InvalidNumberWarning$1,{value:_e.value}):_e.value,se<ie.length-1&&", "]},se)),ie.length===0&&"-"]})}function InvalidNumberWarning$1(t){return is_string_valid_number(t.value)?o$1(k$1,{children:t.value}):o$1("span",{style:{borderRadius:5,border:"thin solid #999",padding:"2px 3px 0px 3px"},children:[o$1(WarningTriangle,{message:"Number is invalid",backgroundColor:"white"}),t.value]})}function get_VAP_set_probable_percentages_for_display(t,ee){const te=get_VAPs_ordered_by_prob(t.entries,ee),ne=te[0];return ee===VAPsType.boolean&&ne?ratio_to_percentage_string(ne.probability):te.filter(({probability:ie})=>ie>0).map(ie=>ratio_to_percentage_string(ie.probability)).join(", ")}function get_VAP_set_conviction(t,ee){const te=get_VAPs_ordered_by_prob(t.entries,ee),ne=te[0];if(ee===VAPsType.boolean&&ne)return ratio_to_percentage_string(ne.conviction);const oe=te.filter(({probability:se})=>se>0),ie=new Set;oe.forEach(({conviction:se})=>ie.add(se));const _e=ie.size<=1;return oe.slice(0,_e?1:void 0).map(se=>ratio_to_percentage_string(se.conviction)).join(", ")}const ValueAndPredictions$1="";var LinkOff={},_interopRequireDefault$9=interopRequireDefaultExports;Object.defineProperty(LinkOff,"__esModule",{value:!0});var default_1$9=LinkOff.default=void 0,_createSvgIcon$9=_interopRequireDefault$9(requireCreateSvgIcon()),_jsxRuntime$9=requireJsxRuntime(),_default$9=(0,_createSvgIcon$9.default)((0,_jsxRuntime$9.jsx)("path",{d:"M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5zm-1 4h-2.19l2 2H16zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3 2 4.27z"}),"LinkOff");default_1$9=LinkOff.default=_default$9;const ValuePossibilityLink$1="",d$1="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM19 12h-2v3h-3v2h3v3h2v-3h3v-2h-3z";function AddLinkIcon(t){return o$1(CommonIcon,{...t,d:d$1})}const d="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1z M16 18.17 14.33 16.5l-1.42 1.41L16 21 21.0 15.8l-1.41-1.41z";function LinkWorkingIcon(t){return o$1(CommonIcon,{...t,d})}function ValuePossibilityLink(t){const{editing:ee,VAP:te,value_possibilities:ne,update_VAP:oe}=t,ie=F$1(()=>get_value_possibilities_by_value(t.value_possibilities,!0),[t.value_possibilities]);if(ne===void 0)return o$1("span",{title:"Need to first add value possibilities to link to.",className:"possible_value_link disabled",children:o$1(default_1$9,{})});if(!!ne[te.value_id||""])return o$1("span",{title:"Linked to possible value.  Click to unlink.",className:"possible_value_link "+(ee?"clickable":"disabled"),onClick:()=>{const re={...te};delete re.value_id,oe(re)},children:[o$1(LinkWorkingIcon,{className:"hide_on_hover"}),o$1(default_1$9,{className:"show_on_hover"})]});const se=ie[te.value.toLowerCase()];return se?o$1("span",{title:"Linkable to value possibility.  Click to link.",className:"possible_value_link "+(ee?"clickable":"disabled"),onClick:()=>{const ae=ne[se.id].description||te.description,ce={...te,value_id:se.id,description:ae};oe(ce)},children:o$1(AddLinkIcon,{})}):o$1("span",{title:"No matching value possibility to link to.",className:"possible_value_link disabled",children:o$1(default_1$9,{})})}const map_state$w=t=>({editing:!t.display_options.consumption_formatting}),connector$w=connect(map_state$w);function _ValueAndPredictions(t){const{editing:ee,value_possibilities:te,VAPs_represent:ne}=t,oe=t.values_and_predictions,ie=ne===VAPsType.boolean&&oe.length>=1?"only_one_VAP":"",_e=ne===VAPsType.number,se={get_summary:get_summary({value_possibilities:te,VAPs_represent:ne,editing:ee}),get_details:get_details(ne,ee),extra_class_names:"value_and_prediction",crud:{update_item:ae=>{const ce=get_id$1(ae),de=replace_element(oe,ae,ue=>get_id$1(ue)===ce);t.update_values_and_predictions(de)},delete_item:ae=>{const ce=get_id$1(ae),de=remove_element(oe,ue=>get_id$1(ue)===ce);t.update_values_and_predictions(de)}},delete_button_text:"Delete Value & Prediction",hide_expansion_button:ae=>!ee&&!ae.description&&!ae.source&&(!_e||!ae.min&&!ae.max),calc_initial_custom_expansion_state:ae=>!!(ae.description||ae.source||_e&&(ae.min||ae.max))},re="Value and prediction";return o$1("div",{className:`value_and_predictions ${ie}`,children:[o$1(ListHeader,{items_descriptor:get_items_descriptor(re,oe.length),other_content:()=>!ee||ne===VAPsType.boolean?null:o$1(ListHeaderAddButton,{new_item_descriptor:re,on_pointer_down_new_list_entry:()=>{const ae=[...oe,prepare_new_VAP()];t.update_values_and_predictions(ae)}})}),factory_render_list_content({items:oe,get_id:get_id$1,item_props:se,debug_item_descriptor:re})({expanded_item_rows:!1,expanded_items:!0,disable_partial_collapsed:!1})]})}const ValueAndPredictions=connector$w(_ValueAndPredictions),get_id$1=t=>t.id,get_summary=t=>(ee,te,ne)=>{const{value_possibilities:oe,VAPs_represent:ie,editing:_e}=t,{probability:se,relative_probability:re,conviction:ae,min:ce,value:de,max:ue}=ee,le=ie===VAPsType.boolean,pe=ie===VAPsType.number,me=re!==void 0,fe=me&&!le,ge=!me||le;return o$1("div",{className:"value_and_prediction_summary",children:[o$1("br",{}),o$1("div",{className:"temporal_uncertainty",children:[pe&&(_e&&ne||ce)&&o$1("div",{children:[o$1(InvalidNumberWarning,{value:ce}),o$1(EditableTextSingleLine,{placeholder:"Min",value:ce||"",modify_value_pre_on_blur:he=>he.trim(),on_blur:he=>te.update_item({...ee,min:he}),on_blur_type:EditableTextOnBlurType.conditional}),o$1("br",{})]},"min"),(_e||de)&&o$1("div",{style:{position:"relative"},children:[pe&&o$1(InvalidNumberWarning,{value:de}),o$1(EditableTextSingleLine,{disabled:le,placeholder:"Value",value:le?se>.5?"True":"False":de,modify_value_pre_on_blur:he=>he.trim(),on_blur:he=>te.update_item({...ee,value:he}),on_blur_type:EditableTextOnBlurType.conditional}),!pe&&!le&&o$1("div",{style:{position:"absolute",right:"-25px",top:"15px"},children:o$1(ValuePossibilityLink,{editing:_e,VAP:ee,value_possibilities:oe,update_VAP:he=>te.update_item(he)})}),o$1("br",{})]},"value"),pe&&(_e&&ne||ue)&&o$1("div",{children:[o$1(InvalidNumberWarning,{value:ue}),o$1(EditableTextSingleLine,{placeholder:"Max",value:ue||"",modify_value_pre_on_blur:he=>he.trim(),on_blur:he=>te.update_item({...ee,max:he}),on_blur_type:EditableTextOnBlurType.conditional}),o$1("br",{})]},"max")]}),o$1("div",{className:"predictions",children:[le&&o$1("div",{className:fe?"disabled":"",children:o$1(EditablePercentage,{disabled:fe,placeholder:"Probability",value:se,on_blur:he=>{te.update_item({...ee,probability:he})},on_blur_type:EditableTextOnBlurType.conditional})}),le&&o$1("div",{children:o$1(EditablePercentage,{placeholder:"Confidence",value:ae,on_blur:he=>te.update_item({...ee,conviction:he}),on_blur_type:EditableTextOnBlurType.conditional})}),!le&&re!==void 0&&o$1("div",{className:ge?"disabled":"",children:o$1(EditableNumber,{disabled:ge,placeholder:"Relative probability",size:"medium",value:le?void 0:re,allow_undefined:!0,on_blur:he=>{he=le?void 0:he||0,te.update_item({...ee,relative_probability:he})},on_blur_type:EditableTextOnBlurType.conditional})}),"  ",o$1(PredictionBadge,{disabled:!0,size:20,probability:se,conviction:ae})]})]})},get_details=(t,ee)=>(te,ne)=>t===VAPsType.boolean?o$1("div",{children:[o$1("div",{className:"description_label",children:"Description"}),"Boolean value of this state, i.e. either true (100%), false (0%) or somewhere in between."]}):!ee&&!te.description&&!te.source?o$1(k$1,{}):o$1("div",{children:[(ee||te.description)&&o$1(EditableText,{placeholder:"Description",value:te.description,on_blur:oe=>ne.update_item({...te,description:oe.trim()}),on_blur_type:EditableTextOnBlurType.conditional}),ee&&o$1("br",{}),(ee||te.source)&&o$1(EditableTextSingleLine,{placeholder:"Source",size:"small",value:te.source||"",on_blur:oe=>ne.update_item({...te,source:oe?oe.trim():void 0}),on_blur_type:EditableTextOnBlurType.conditional}),ee&&o$1("br",{})]});function InvalidNumberWarning(t){const ee=is_string_valid_number(t.value||"");return o$1("div",{style:{maxHeight:ee?0:100,overflow:"hidden",transition:"max-height 1s ease 0s"},children:o$1(WarningTriangleV2,{warning:"Number is invalid"})})}const get_summary_for_single_VAP_set=(t,ee)=>(te,ne)=>{let oe=get_VAPs_from_set(te,t);te={...te,entries:oe};const ie=get_probable_VAP_set_values_for_display(te,t),_e=get_VAP_set_probable_percentages_for_display(te,t)+"%",se=get_VAP_set_conviction(te,t)+"%";return o$1(PredictionSummary,{created_at:ee?te.custom_created_at||te.created_at:void 0,value:ie,datetime:te.datetime,probability:_e,conviction:se})},get_details_for_single_VAP_set=(t,ee)=>(te,ne)=>{const oe=get_VAPs_from_set(te,ee);return o$1("div",{className:"VAP_set_details",children:[o$1("br",{}),o$1(UncertainDateTimeForm,{datetime:te.datetime,on_change:ie=>ne.update_item({...te,datetime:ie})}),o$1("div",{children:[o$1("br",{}),o$1(ValueAndPredictions,{value_possibilities:t,VAPs_represent:ee,values_and_predictions:oe,update_values_and_predictions:ie=>{const _e=merge_entries(ie,te,ee),se=set_VAP_probabilities(_e,ee),re={...te,entries:se};ne.update_item(re)}}),o$1("br",{})]}),o$1("br",{})]})},get_details2_for_single_VAP_set=(t,ee)=>(te,ne)=>{const oe=te.shared_entry_values||{},ie=te.entries.map(({explanation:ce})=>ce.trim()).filter(ce=>ce).join(`

`),_e=oe.explanation||ie||"",se=oe.conviction||1,re=t!==VAPsType.boolean,ae=!!(ee||_e);return o$1("div",{className:"shared_VAP_set_details",children:[re&&o$1("div",{children:o$1(EditablePercentage,{disabled:!1,placeholder:"Confidence",value:se,on_blur:ce=>{const de={...te.shared_entry_values,conviction:ce},ue=te.entries.map(le=>({...le,conviction:ce}));ne.update_item({...te,entries:ue,shared_entry_values:de})},on_blur_type:EditableTextOnBlurType.conditional})}),ae&&o$1(EditableText,{placeholder:"Explanation",value:_e,on_blur:ce=>{const de={...te.shared_entry_values,explanation:ce};ne.update_item({...te,shared_entry_values:de})},on_blur_type:EditableTextOnBlurType.conditional}),o$1("br",{})]})};function get_VAPs_from_set(t,ee){let te=t.entries;return ee===VAPsType.boolean&&te.length!==1&&(te=te.slice(0,1)),te}function merge_entries(t,ee,te){return te===VAPsType.boolean&&(t=t.concat(ee.entries.slice(1))),t}function SimplifiedUncertainDatetimeForm(t){const{VAP_set:ee,on_change:te}=t;if(!ee.entries[0])return null;const oe=get_uncertain_datetime(ee.datetime),ie=oe===void 0;return o$1("div",{children:[oe?date2str_auto({date:oe,time_resolution:void 0}):"Is Eternal",o$1("br",{}),ie&&o$1(Button,{value:"Set to 'From today'",onClick:()=>te({...ee,datetime:{value:get_today_date()}})}),!ie&&o$1(Button,{value:"Set to Eternal",onClick:()=>te({...ee,datetime:{}})}),o$1("br",{}),o$1("br",{})]})}const new_value_and_prediction_set__jsx_factory=(t,ee)=>{const te=Object.keys(ee||{}).length>0,ne=t===VAPsType.other&&te,oe=t===VAPsType.boolean||t===VAPsType.action||ne,[ie,_e]=h$1(!oe);return(se,re)=>{const{update_item:ae}=re;return o$1("div",{children:[!ie&&t===VAPsType.boolean&&o$1(SimplifiedBooleanForm,{VAP_set:se,on_change:ae}),!ie&&t===VAPsType.action&&o$1(SimplifiedActionForm,{possible_value_possibilities:ee,VAP_set:se,on_change:ae}),!ie&&ne&&o$1(SimplifiedOtherForm,{possible_value_possibilities:ee,VAP_set:se,on_change:ae}),!ie&&o$1("div",{children:[o$1("span",{className:"description_label",children:"Datetime"}),o$1(SimplifiedUncertainDatetimeForm,{VAP_set:se,on_change:ae})]}),o$1(Button,{value:(ie?"Hide":"Show")+" advanced options",onClick:()=>_e(!ie)}),ie&&o$1("div",{children:[o$1("br",{}),o$1("br",{}),o$1("hr",{}),get_summary_for_single_VAP_set(t,!1)(se,re),get_details_for_single_VAP_set(ee,t)(se,re),get_details2_for_single_VAP_set(t,!0)(se,re)]})]})}};function SimplifiedBooleanForm(t){const{VAP_set:ee,on_change:te}=t,ne=ee.entries[0];if(!ne)return null;const oe=!!ne&&ne.probability===1&&ne.conviction===1,ie=!!ne&&ne.probability===0&&ne.conviction===1;return o$1("div",{children:[oe&&"True",ie&&"False",o$1("br",{}),!oe&&o$1(Button,{value:"Set to True",onClick:()=>{te({...ee,entries:[{...ne,probability:1,conviction:1}]})}}),!ie&&o$1(Button,{value:"Set to False",onClick:()=>{te({...ee,entries:[{...ne,probability:0,conviction:1}]})}}),o$1("br",{}),o$1("br",{})]})}function SimplifiedActionForm(t){return o$1(SimplifiedFormHeader,{...t,title:"Set action status to:"})}function SimplifiedOtherForm(t){return o$1(SimplifiedFormHeader,{...t,title:"Set value to:"})}function SimplifiedFormHeader(t){const{title:ee,possible_value_possibilities:te,VAP_set:ne,on_change:oe}=t,ie=get_VAP_set_certain_selected_value_id(ne),_e=value_possibility_options(te);return o$1("div",{children:[ee,o$1(AutocompleteText,{selected_option_id:ie,options:_e,allow_none:!0,on_change:se=>{if(!se)return;const re=update_VAP_set_VAP_probabilities(ne,se);oe({...ne,entries:re})}}),o$1("br",{}),o$1("br",{})]})}function value_possibility_options(t){return t===void 0?[]:Object.values(t).map(({id:ee,value:te})=>({id:ee,title:sentence_case(te)}))}function get_VAP_set_certain_selected_value_id(t){var oe,ie;let ee;const te=((oe=t.shared_entry_values)==null?void 0:oe.conviction)||0,ne=((ie=t.shared_entry_values)==null?void 0:ie.probability)||0;return t.entries.forEach(_e=>{Math.max(te,_e.conviction)===1&&Math.max(ne,_e.probability)===1&&(ee=_e.value_id)}),ee}const map_state$v=t=>({creation_context:t.creation_context,editing:!t.display_options.consumption_formatting}),connector$v=connect(map_state$v);function _ValueAndPredictionSetOlderVersions(t){const{editing:ee,value_possibilities:te,VAPs_represent:ne,older_VAP_sets:oe,create_item:ie,update_item:_e,delete_item:se}=t,re="Older version",ae=F$1(()=>()=>{const de=create_new_VAP_set_version(t.current_VAP_set,t.creation_context);ie(de)},[t.current_VAP_set,t.creation_context,ie]),ce=F$1(()=>factory_render_list_content({items:oe,get_id,debug_item_descriptor:re,item_props:{get_created_at,get_custom_created_at,get_summary:get_summary_for_single_VAP_set(ne,!0),get_details:get_details_for_single_VAP_set(te,ne),get_details2:get_details2_for_single_VAP_set(ne,ee),extra_class_names:"value_and_prediction_set",crud:{create_item:ie,update_item:_e,delete_item:se},delete_button_text:"Delete Older Set of Value & Predictions"}}),[oe,re,ne,ee,ie,_e,se]);return o$1(ExpandableListWithAddButton,{items_count:oe.length,item_descriptor:re,new_item_descriptor:"Version",content:ce,on_click_new_item:ae})}const ValueAndPredictionSetOlderVersions=connector$v(_ValueAndPredictionSetOlderVersions),get_id=t=>t.id,get_created_at=t=>t.created_at,get_custom_created_at=t=>t.custom_created_at;function ValueAndPredictionSetsComponent(t){const[ee,te]=h$1(void 0),{wcomponent_id:ne,VAPs_represent:oe,update_values_and_predictions:ie,existing_value_possibilities:_e,values_and_prediction_sets:se,invalid_future_items:re,future_items:ae,present_item:ce,past_items:de,previous_versions_by_id:ue,editing:le}=t,pe=ce?[ce]:[],me=factory_render_VAP_set_list_content({existing_value_possibilities:_e,subset_VAP_sets:ae,previous_versions_by_id:ue,all_VAP_sets:se,update_values_and_predictions:ie,wcomponent_id:ne,VAPs_represent:oe,tense:Tense.future,editing:le}),fe=factory_render_VAP_set_list_content({existing_value_possibilities:_e,subset_VAP_sets:pe,previous_versions_by_id:ue,all_VAP_sets:se,update_values_and_predictions:ie,wcomponent_id:ne,VAPs_represent:oe,tense:Tense.present,editing:le}),ge=factory_render_VAP_set_list_content({existing_value_possibilities:_e,subset_VAP_sets:de,previous_versions_by_id:ue,all_VAP_sets:se,update_values_and_predictions:ie,wcomponent_id:ne,VAPs_represent:oe,tense:Tense.past,editing:le}),be={get_created_at:get_actual_created_at_datetime,get_custom_created_at:get_actual_custom_created_at_datetime,get_summary:new_value_and_prediction_set__jsx_factory(oe,_e),get_details:()=>o$1("div",{}),get_details2:()=>o$1("div",{}),extra_class_names:"value_and_prediction_set new",crud:{create_item:Ae=>{const $e=[...se,Ae];ie($e),te(void 0)},update_item:te}},ve="Value Prediction",we=le||ae.length>0,ye=le||pe.length>0,ke=le||de.length>0;return o$1("div",{className:"value_and_prediction_sets",children:[le&&o$1(ListHeaderAddButton,{new_item_descriptor:ve,on_pointer_down_new_list_entry:()=>{const Ae=prepare_new_VAP_set(oe,_e,se,t.base_id,t.creation_context);te(Ae)}}),o$1(NewItemForm,{new_item:ee,set_new_item:te,item_props:be,item_descriptor:ve}),re.length>0&&o$1("div",{children:["Hidden (",re.length,") ",o$1(ActiveCreatedAtFilterWarning,{})]}),we&&o$1(ExpandableList,{content:me,item_descriptor:"",items_descriptor:count_and_versions("Future",ae,ue,le),items_descriptor_title:count_and_versions_title("Future",ae,ue),disable_collapsed:!0}),(we||ye)&&o$1("hr",{}),ye&&o$1(ExpandableList,{content:fe,item_descriptor:"",items_descriptor:count_and_versions("Present",pe,ue,le),items_descriptor_title:count_and_versions_title("Present",pe,ue),disable_collapsed:!0}),ye&&ke&&o$1("hr",{}),ke&&o$1(ExpandableList,{content:ge,item_descriptor:"",items_descriptor:count_and_versions("Past",de,ue,le),items_descriptor_title:count_and_versions_title("Past",de,ue),disable_collapsed:!0})]})}function count_and_versions(t,ee,te,ne){if(!ne)return t;let oe=0;return ee.forEach(({id:ie})=>oe+=(te[ie]||[]).length),oe===0?get_items_descriptor(t,ee.length,ne):`${t} (${ee.length}+)`}function count_and_versions_title(t,ee,te){let ne=0;return ee.forEach(({id:oe})=>ne+=(te[oe]||[]).length),ne===0?`${ee.length} ${t} items`:`${ee.length} ${t} items with ${ne} older versions`}function factory_render_VAP_set_list_content(t){const{existing_value_possibilities:ee,subset_VAP_sets:te,all_VAP_sets:ne,previous_versions_by_id:oe,update_values_and_predictions:ie,VAPs_represent:_e,tense:se,editing:re}=t;return ce=>{const{disable_partial_collapsed:de,expanded_items:ue,expanded_item_rows:le}=ce,pe={create_item:me=>{const fe=[...ne,me];ie(fe)},update_item:me=>{const fe=predicate_by_id_and_created_at(me),ge=replace_element(ne,me,fe);ie(ge)},delete_item:me=>{const fe=predicate_by_id_and_created_at(me),ge=remove_element(ne,fe);ie(ge)}};return o$1("div",{style:{display:ue?"":"none",cursor:"initial"},onClick:me=>me.stopPropagation(),children:te.map(me=>o$1("div",{children:[o$1("hr",{className:"entries_horizontal_dividers"}),o$1(EditableListEntry,{item:me,get_created_at:get_actual_created_at_datetime,get_custom_created_at:get_actual_custom_created_at_datetime,get_summary:get_summary_for_single_VAP_set(_e,!1),get_details:get_details_for_single_VAP_set(ee,_e),get_details2:get_details2_for_single_VAP_set(_e,re),get_details3:get_details3(ee,_e,oe),extra_class_names:`value_and_prediction_set ${se===Tense.future?"future":se===Tense.present?"present":"past"}`,expanded:le,crud:pe,delete_button_text:"Delete Set of Value & Predictions"})]},me.id))})}}const get_actual_created_at_datetime=t=>t.created_at,get_actual_custom_created_at_datetime=t=>t.custom_created_at,predicate_by_id_and_created_at=t=>ee=>t.id===ee.id&&t.created_at.getTime()===ee.created_at.getTime(),get_details3=(t,ee,te)=>(ne,oe)=>o$1(Box,{className:"VAP_set_details",children:[o$1("br",{}),o$1(ValueAndPredictionSetOlderVersions,{value_possibilities:t,VAPs_represent:ee,current_VAP_set:ne,older_VAP_sets:te[ne.id]||[],create_item:oe.create_item,update_item:oe.update_item,delete_item:oe.delete_item}),o$1("br",{}),o$1("br",{})]}),map_state$u=(t,ee)=>({current_created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,creation_context:t.creation_context,editing:ee.editing_allowed??!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)||-1}),map_dispatch$l={change_route:ACTIONS.routing.change_route},connector$u=connect(map_state$u,map_dispatch$l);function _ValueAndPredictionSets(t){const{wcomponent_id:ee,existing_value_possibilities:te,values_and_prediction_sets:ne,VAPs_represent:oe,base_id:ie,current_created_at_ms:_e,sim_ms:se,update_VAPSets_and_value_possibilities:re,change_route:ae}=t,{invalid_future_items:ce,past_items:de,present_item:ue,future_items:le,previous_versions_by_id:pe}=partition_and_prune_items_by_datetimes_and_versions({items:ne,created_at_ms:t.current_created_at_ms,sim_ms:se});return o$1(ValueAndPredictionSetsComponent,{wcomponent_id:ee,VAPs_represent:oe,update_values_and_predictions:me=>{handle_update_VAP_sets({existing_value_possibilities:te,new_values_and_prediction_sets:me,orig_values_and_prediction_sets:ne,current_created_at_ms:_e,sim_ms:se,update_VAPSets_and_value_possibilities:re,change_route:ae})},existing_value_possibilities:t.existing_value_possibilities,values_and_prediction_sets:ne,invalid_future_items:ce,past_items:de,present_item:ue,future_items:le,previous_versions_by_id:pe,base_id:ie,creation_context:t.creation_context,editing:t.editing})}const ValueAndPredictionSets=connector$u(_ValueAndPredictionSets),map_state$t=t=>({wcomponents_by_id:t.derived.composed_wcomponents_by_id,presenting:t.display_options.consumption_formatting}),map_dispatch$k={},connector$t=connect(map_state$t,map_dispatch$k);function _WComponentValueAndPredictionsForm(t){const{editing_allowed:ee,wcomponent:te,upsert_wcomponent:ne,VAPs_represent:oe,orig_values_and_prediction_sets:ie,orig_value_possibilities:_e}=t,se=ie.length>0||ee&&oe===VAPsType.action,[re,ae]=h$1(se),ce=wcomponent_is_statev2(te)&&te.units,[de,ue]=h$1(!!ce),le=de&&(oe===VAPsType.number||!!ce)||t.presenting&&oe===VAPsType.number&&!!ce;return o$1("div",{className:"editable_list_entry padded "+(re?"expanded":""),children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>ae(!re),children:[o$1("div",{className:"summary",children:o$1("h4",{style:{display:"inline-block"},children:["Value Predictions ",!re&&ie.length?`(${ie.length})`:""]})}),o$1("div",{className:"expansion_button"})]}),wcomponent_is_statev2(te)&&o$1("div",{children:[t.editing_allowed&&o$1(IconButton,{onClick:()=>ue(!de),size:"small",style:{marginLeft:"auto",display:"flex"},children:o$1(SettingsIcon,{})}),le&&o$1(EditableTextSingleLine,{style:{padding:"10px 0px"},size:"small",placeholder:"Units",hide_label:!1,disabled:!t.editing_allowed,value:te.units||"",on_blur:pe=>t.upsert_wcomponent({units:pe||void 0}),on_blur_type:EditableTextOnBlurType.conditional})]}),re&&o$1("div",{children:[oe===VAPsType.undefined&&o$1("div",{children:te.type==="state_value"?"Set subtype of target 'state' component to show Value Predictions on this 'state value' component":"Set subtype to show Value Predictions"}),oe===VAPsType.action&&o$1(EasyActionValueAndPredictionSets,{VAPs_represent:oe,base_id:te.base_id,existing_value_possibilities:_e,values_and_prediction_sets:ie,update_VAPSets_and_value_possibilities:({value_possibilities:pe,values_and_prediction_sets:me})=>{ne({value_possibilities:pe,values_and_prediction_sets:me})},editing_allowed:ee}),oe!==VAPsType.undefined&&o$1(ValueAndPredictionSets,{wcomponent_id:te.id,VAPs_represent:oe,existing_value_possibilities:_e,values_and_prediction_sets:ie,update_VAPSets_and_value_possibilities:({value_possibilities:pe,values_and_prediction_sets:me})=>{ne({value_possibilities:pe,values_and_prediction_sets:me})},editing_allowed:ee})]})]})}const WComponentValueAndPredictionsForm=connector$t(_WComponentValueAndPredictionsForm),map_state$s=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id}),map_dispatch$j={},connector$s=connect(map_state$s,map_dispatch$j);function _WComponentStateForm(t){const{editing_allowed:ee,wcomponent:te,upsert_wcomponent:ne,wcomponents_by_id:oe}=t,ie=get_wcomponent_VAPs_represent(te,oe),_e=te.values_and_prediction_sets,se=te.value_possibilities;return o$1(k$1,{children:[(ee&&wcomponent_allowed_calculations(te)||wcomponent_has_calculations(te)&&te.calculations.length>0)&&o$1(WComponentCalculatonsForm,{wcomponent:te,upsert_wcomponent:ne}),_e!==void 0&&(ee||_e.length>0)&&o$1(WComponentValueAndPredictionsForm,{editing_allowed:ee,wcomponent:te,upsert_wcomponent:ne,VAPs_represent:ie,orig_values_and_prediction_sets:_e,orig_value_possibilities:se}),ie!==VAPsType.undefined&&_e!==void 0&&(ee||Object.keys(se||{}).length>0)&&o$1(WComponentValuePossibilitiesForm,{editing:ee,attribute_wcomponent:oe[wcomponent_is_state_value(te)&&te.attribute_wcomponent_id||""],VAPs_represent:ie,value_possibilities:se,values_and_prediction_sets:_e,update_value_possibilities:re=>{const ae=update_VAPSets_with_possibilities(_e,re);ne({value_possibilities:re,values_and_prediction_sets:ae})}})]})}const WComponentStateForm=connector$s(_WComponentStateForm),map_state$r=(t,{wcomponent:ee})=>{let te,ne;wcomponent_is_plain_connection(ee)&&(te=get_wcomponent_from_state(t,ee.from_id),ne=get_wcomponent_from_state(t,ee.to_id));const oe=get_wc_id_to_counterfactuals_v2_map(t),ie=!t.display_options.consumption_formatting,_e=(t.user_info.bases_by_id||{})[ee.base_id],se=!!(_e!=null&&_e.can_edit);return{ready:t.sync.ready_for_reading,base_id:selector_chosen_base_id(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:oe,from_wcomponent:te,to_wcomponent:ne,derived_composed_wcomponents_by_id:t.derived.composed_wcomponents_by_id,derived_composed_wcomponent:t.derived.composed_wcomponents_by_id[ee.id],is_in_editing_mode:ie,allowed_to_edit:se,editing_allowed:ie&&se,base_for_wcomponent:_e,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$i={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent,delete_wcomponent:ACTIONS.specialised_object.delete_wcomponent,update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$r=connect(map_state$r,map_dispatch$i);function _WComponentForm(t){var $e,Se,Te;const{wcomponent:ee,ready:te,base_id:ne,wcomponents_by_id:oe,knowledge_views_by_id:ie,wc_id_to_counterfactuals_map:_e,from_wcomponent:se,to_wcomponent:re,derived_composed_wcomponents_by_id:ae,derived_composed_wcomponent:ce,editing_allowed:de,created_at_ms:ue,sim_ms:le}=t,pe=ee.id,[me,fe]=h$1(pe);if(!te)return o$1("div",{children:"Loading..."});if(!ce)return o$1("div",{children:"Loading..."});if(ne===void 0)return o$1("div",{children:"Choose a base first."});const ge=_e&&(($e=_e[pe])==null?void 0:$e.VAP_sets),he=_$d(!0);if(p$1(()=>fe(pe),[pe]),me!==pe)return he.current=!0,null;const be=he.current;he.current=!1;const ve=xe=>{const Ie=get_updated_wcomponent(ee,xe).wcomponent;t.upsert_wcomponent({wcomponent:Ie})};let we,ye=!1;wcomponent_is_allowed_to_have_state_VAP_sets(ee)&&(we=get_wcomponent_state_UI_value({wcomponent:ce,VAP_set_id_to_counterfactual_v2_map:ge,created_at_ms:ue,sim_ms:le}),ye=(((Se=ee.values_and_prediction_sets)==null?void 0:Se.length)||0)>0);const ke=get_title$1({text_type:de?RichTextType.raw:RichTextType.rich,wcomponent:ce,wcomponents_by_id:ae,knowledge_views_by_id:ie,wc_id_to_counterfactuals_map:_e,created_at_ms:ue,sim_ms:le}),Ae=xe=>ve({title:xe});return o$1(Box,{children:[t.is_in_editing_mode&&!t.allowed_to_edit&&o$1("div",{children:[o$1(WarningTriangle,{message:""}),"  Not allow to edit.  Ask base owner to give you edit permissions."]}),t.wcomponent_from_different_base&&o$1("div",{style:{cursor:"pointer"},onClick:()=>t.update_chosen_base_id({base_id:ee.base_id}),title:`Click to change to base ${ee.base_id}`,children:[o$1(WarningTriangle,{}),'  Is part of base "',(Te=t.base_for_wcomponent)==null?void 0:Te.title,'"']}),o$1(FormControl,{variant:"standard",fullWidth:!0,margin:"normal",style:{fontWeight:600,fontSize:22},children:o$1(EditableText,{editing_allowed:de,placeholder:ee.type==="action"?"Passive imperative title...":ee.type==="relation_link"?"Verb...":"Title...",value:ke,on_blur:Ae,on_blur_type:EditableTextOnBlurType.conditional,force_focus_on_first_render:be,hide_label:!0,spellcheck:!0})}),we&&o$1("span",{children:[o$1("span",{className:"description_label",children:"Value "}),o$1(DisplayValue,{UI_value:we})]}),(de||ee.type!=="statev2"||ye)&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:o$1(AutocompleteText,{editing_allowed:de,placeholder:"Type: ",selected_option_id:ee.type,options:wcomponent_type_options,on_change:xe=>{if(!xe)return;const Pe={...prepare_new_contextless_wcomponent_object({type:xe,base_id:ee.base_id}),...ee};Pe.type=xe,ve(Pe)}})}),wcomponent_is_statev2(ee)&&(de||ee.subtype)&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Subtype"})," ",o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{editing_allowed:de,placeholder:"Subtype...",selected_option_id:ee.subtype,options:wcomponent_statev2_subtype_options,allow_none:!0,on_change:xe=>ve({subtype:xe})})})]}),(de||ee.description)&&o$1(FormControl,{variant:"standard",fullWidth:!0,margin:"normal",children:o$1(EditableText,{editing_allowed:de,placeholder:"Description...",value:ee.description,on_blur:xe=>ve({description:xe}),on_blur_type:EditableTextOnBlurType.conditional,hide_label:!0})}),wcomponent_is_state_value(ee)&&o$1(WComponentStateValueForm,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_sub_state(ee)&&o$1(WComponentSubStateForm,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_counterfactual_v2(ee)&&o$1(WComponentCounterfactualForm,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_plain_connection(ee)&&o$1("div",{children:[o$1("p",{children:o$1(WComponentFromTo,{connection_terminal_description:"From",wcomponent_id:se&&se.id,connection_terminal_type:ee.from_type,on_update_id:xe=>ve({from_id:xe}),on_update_type:xe=>ve({from_type:xe}),exclude_ids:new Set([ee.id])})}),o$1("p",{children:o$1(WComponentFromTo,{connection_terminal_description:"To",wcomponent_id:re&&re.id,connection_terminal_type:ee.to_type,on_update_id:xe=>ve({to_id:xe}),on_update_type:xe=>ve({to_type:xe}),exclude_ids:new Set([ee.id])})}),de&&o$1("p",{style:{display:"flex",alignItems:"center",flexDirection:"column"},children:o$1(Button,{value:"Reverse Direction",onClick:()=>{ve({to_id:ee.from_id,from_id:ee.to_id})}})})]}),wcomponent_is_causal_link(ee)&&o$1(WComponentCausalLinkForm,{wcomponent:ee,from_wcomponent:se,editing:de,wcomponents_by_id:oe,upsert_wcomponent:ve}),wcomponent_is_plain_connection(ee)&&o$1(WComponentConnectionForm,{wcomponent:ee,editing:de,upsert_wcomponent:ve}),wcomponent_is_judgement_or_objective(ee)&&o$1(JudgementFormFields,{wcomponent:ee,upsert_wcomponent:ve}),(wcomponent_is_goal(ee)||wcomponent_is_action(ee))&&o$1(WComponentParentGoalOrActionForm,{wcomponent:ee,upsert_wcomponent:ve}),(de||ee.label_ids&&ee.label_ids.length>0)&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Labels"}),o$1(LabelsEditor,{label_ids:ee.label_ids,on_change:xe=>ve({label_ids:xe})})]}),wcomponent_is_event(ee)&&o$1(WComponentEventAtFormField,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_prioritisation(ee)&&o$1(WComponentDateTimeFormField,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_allowed_to_have_state_VAP_sets(ee)&&o$1(WComponentStateForm,{editing_allowed:de,wcomponent:ee,upsert_wcomponent:ve}),wcomponent_has_objectives(ee)&&o$1(ChosenObjectivesFormFields,{editing_allowed:de,wcomponent:ee,upsert_wcomponent:ve}),wcomponent_can_have_validity_predictions(ee)&&o$1(WComponentValidityPredictionsForm,{editing_allowed:de,wcomponent:ee,upsert_wcomponent:ve}),o$1("br",{}),o$1("br",{}),o$1(FormControl,{variant:"standard",fullWidth:!0,children:[o$1(EditableCustomDateTime,{editing_allowed:de,title:"Created at",invariant_value:ee.created_at,value:ee.custom_created_at,on_change:xe=>{ve({custom_created_at:xe})}}),o$1("br",{})]}),de&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Label color"}),o$1(ColorPicker,{color:ee.label_color,conditional_on_blur:xe=>ve({label_color:xe})})]}),de&&o$1(WComponentImageForm,{wcomponent:ee,upsert_wcomponent:ve}),!de&&ee.summary_image&&o$1("p",{children:o$1("a",{href:ee.summary_image,target:"_blank",children:[o$1(ExternalLinkIcon,{}),"Open image"]})}),de&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Hide node title"}),o$1(EditableCheckbox,{value:ee.hide_title,on_change:xe=>ve({hide_title:xe})}),o$1("span",{className:"description_label",children:"Hide node state"}),o$1(EditableCheckbox,{value:ee.hide_state,on_change:xe=>ve({hide_state:xe})}),o$1("hr",{})]}),o$1(WComponentKnowledgeViewForm,{wcomponent_id:ee.id,editing_allowed:de}),o$1("br",{}),o$1("br",{}),de&&wcomponent_is_not_deleted(ee)&&o$1("div",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Soft Delete (can undo)",tooltip_text:"Remove from all knowledge views",on_delete:()=>t.delete_wcomponent({wcomponent_id:pe})})}),de&&wcomponent_is_deleted(ee)&&o$1("div",{children:o$1(Button,{title:"Undo delete",onClick:()=>ve({deleted_at:void 0}),children:"Restore"})}),o$1("br",{})]})}const WComponentForm=connector$r(_WComponentForm);function EditablePosition(t){const[ee,te]=h$1(0),[ne,oe]=h$1(0),ie=_e=>{t.on_update({change_left:_e.change_left?round_coordinate_small_step(_e.change_left):0,change_top:_e.change_top?round_coordinate_small_step(_e.change_top):0})};return o$1("div",{children:[o$1("p",{style:{fontSize:10,color:"#888"},children:["Increments of ",grid_small_step," pixels"]}),"Move right: ",o$1(EditableNumber,{placeholder:"Right",value:ee,allow_undefined:!1,on_blur:_e=>te(round_coordinate_small_step(_e)),on_blur_type:EditableTextOnBlurType.conditional}),o$1("input",{type:"button",value:"Move",disabled:ee===0,onClick:()=>ie({change_left:ee})}),"  ",o$1("input",{type:"button",value:"←",onClick:()=>ie({change_left:-grid_small_step})}),o$1("input",{type:"button",value:"←←",onClick:()=>ie({change_left:-h_step})}),o$1("input",{type:"button",value:"→→",onClick:()=>ie({change_left:h_step})}),o$1("input",{type:"button",value:"→",onClick:()=>ie({change_left:grid_small_step})}),o$1("br",{}),o$1("br",{}),"Move up: ",o$1(EditableNumber,{placeholder:"Up",value:-ne,allow_undefined:!1,on_blur:_e=>oe(round_coordinate_small_step(-_e)),on_blur_type:EditableTextOnBlurType.conditional}),o$1("input",{type:"button",value:"Move",disabled:ne===0,onClick:()=>ie({change_top:ne})}),"  ",o$1("input",{type:"button",value:"↑",onClick:()=>ie({change_top:-grid_small_step})}),o$1("input",{type:"button",value:"↑↑",onClick:()=>ie({change_top:-v_step})}),o$1("input",{type:"button",value:"↓↓",onClick:()=>ie({change_top:v_step})}),o$1("input",{type:"button",value:"↓",onClick:()=>ie({change_top:grid_small_step})})]})}const map_state$q=t=>{const ee=get_current_composed_knowledge_view_from_state(t),{selected_wcomponent_ids_set:te}=t.meta_wcomponents,{wcomponents_by_id:ne}=t.specialised_objects;return{ready:t.sync.ready_for_reading,selected_wcomponent_ids_set:te,wcomponents_by_id:ne,knowledge_view_id:ee==null?void 0:ee.id,composed_wc_id_map:ee==null?void 0:ee.composed_wc_id_map,editing:!t.display_options.consumption_formatting}},map_dispatch$h={bulk_edit_knowledge_view_entries:ACTIONS.specialised_object.bulk_edit_knowledge_view_entries,bulk_add_to_knowledge_view:ACTIONS.specialised_object.bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view:ACTIONS.specialised_object.bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries:ACTIONS.specialised_object.snap_to_grid_knowledge_view_entries,bulk_edit_wcomponents:ACTIONS.specialised_object.bulk_edit_wcomponents,upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$q=connect(map_state$q,map_dispatch$h);function _WComponentMultipleForm(t){if(!t.ready)return o$1("div",{children:"Loading..."});const{selected_wcomponent_ids_set:ee,composed_wc_id_map:te,knowledge_view_id:ne,wcomponents_by_id:oe,editing:ie,bulk_edit_knowledge_view_entries:_e,bulk_add_to_knowledge_view:se,bulk_remove_from_knowledge_view:re,snap_to_grid_knowledge_view_entries:ae,bulk_edit_wcomponents:ce,upsert_wcomponent:de}=t,ue=get_wcomponents_from_ids(oe,ee).filter(is_defined),le=Array.from(ee),pe=calc_all_wcomponent_ids_present_in_current_kv(le,te),me=new Set,fe=[];let ge;ue.forEach(be=>{(be.label_ids||[]).forEach(ve=>me.add(ve)),wcomponent_is_causal_link(be)&&(fe.push(be.id),ge=ge||be.effect_string)});const he=Array.from(me).sort();return le.length===0?o$1("div",{children:o$1("h2",{children:"No selected components"})}):o$1("div",{children:[o$1("h2",{children:[ie?"Bulk editing":"Viewing"," ",le.length," components"]}),ie&&o$1("p",{children:[o$1("h3",{children:"Position"}),o$1(EditablePosition,{on_update:be=>{_e({wcomponent_ids:le,...be})}})]}),ie&&o$1("p",{children:o$1(AlignComponentForm,{wcomponent_ids:le})}),(ie||he.length>0)&&o$1("p",{children:[o$1("h3",{children:"Labels"}),o$1(LabelsEditor,{label_ids:he,on_change:be=>{const ve=new Set(be),we=new Set(he.filter(ke=>!ve.has(ke))),ye=new Set(be.filter(ke=>!me.has(ke)));ce({wcomponent_ids:le,change:{},remove_label_ids:we,add_label_ids:ye})}})]}),ie&&fe.length>0&&o$1("p",{children:["Causal Connection Values",o$1(BasicCausalLinkForm,{effect_string:ge,effect_when_true:void 0,effect_when_false:void 0,editing:ie,wcomponents_by_id:oe,upsert_wcomponent:be=>ce({wcomponent_ids:fe,change:be})})]}),ie&&o$1("p",{children:["Component types",o$1(AutocompleteText,{placeholder:"Type: ",selected_option_id:void 0,allow_none:!0,options:wcomponent_type_options,on_change:be=>{be&&ue.forEach(ve=>{const ye={...prepare_new_contextless_wcomponent_object({base_id:ve.base_id,type:be}),...ve};ye.type=be,de({wcomponent:ye})})}})]}),ie&&o$1("p",{children:[o$1("h3",{children:"Created at"}),o$1(EditableCustomDateTime,{value:void 0,on_change:be=>ce({wcomponent_ids:le,change:{custom_created_at:be}})})]}),ie&&o$1("p",{children:[o$1("h3",{children:"Add to knowledge view"}),pe?"":o$1("span",{children:[o$1(WarningTriangle,{message:"Not all components present in current view so will be added to center of view."}),"Not all components present in current view so will be added to center of view."]}),o$1(SelectKnowledgeView,{on_change:be=>{if(!be)return;const ve=get_store().getState(),we=get_middle_of_screen(ve);se({wcomponent_ids:le,knowledge_view_id:be,default_entry:we})}})]}),ie&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Delete from knowledge view",tooltip_text:"Delete from knowledge view",on_delete:()=>{re({wcomponent_ids:le,remove_type:"passthrough"})}})}),ie&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Delete and Block from knowledge view",tooltip_text:"Delete and Block from showing in current knowledge view",on_delete:()=>{re({wcomponent_ids:le,remove_type:"block"})}})})]})}const WComponentMultipleForm=connector$q(_WComponentMultipleForm);function calc_all_wcomponent_ids_present_in_current_kv(t,ee){return ee?t.find(te=>!ee[te])===void 0:!1}const map_state$p=(t,ee)=>{const te=get_current_knowledge_view_from_state(t),ne=te&&te.wc_id_map[ee.wcomponent_id];return{knowledge_view_title:te&&te.title,knowledge_view_entry:ne,editing:!t.display_options.consumption_formatting}},map_dispatch$g={bulk_remove_from_knowledge_view:ACTIONS.specialised_object.bulk_remove_from_knowledge_view},connector$p=connect(map_state$p,map_dispatch$g);function _NotFoundWComponentKnowledgeViewForm(t){const{wcomponent_id:ee,knowledge_view_title:te,knowledge_view_entry:ne,editing:oe}=t;return o$1("div",{children:[o$1(WComponentKnowledgeViewForm,{wcomponent_id:ee,editing_allowed:oe}),oe&&ne&&!ne.passthrough&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Delete from knowledge view",tooltip_text:"Delete from current knowledge view ("+te+")",on_delete:()=>{t.bulk_remove_from_knowledge_view({wcomponent_ids:[ee],remove_type:"passthrough"})}})}),o$1("p",{children:o$1(WComponentPresenceInOtherKVs,{wcomponent_id:ee})})]})}const NotFoundWComponentKnowledgeViewForm=connector$p(_NotFoundWComponentKnowledgeViewForm),map_state$o=t=>({}),map_dispatch$f={change_route:ACTIONS.routing.change_route},connector$o=connect(map_state$o,map_dispatch$f);function _ListOrphanedWComponents(t){const[ee,te]=h$1(void 0),ne=F$1(()=>()=>{const ie=get_store().getState(),{wcomponents_by_id:_e,knowledge_views_by_id:se}=ie.specialised_objects,re=new Set;Object.values(se).forEach(de=>{Object.entries(de.wc_id_map).filter(([ue,le])=>!le.blocked&&!le.passthrough).forEach(([ue,le])=>re.add(ue))});const ae=Object.values(_e).filter(de=>wcomponent_is_not_deleted(de)&&!re.has(de.id)),ce=sort_list(ae,de=>(de.modified_at||de.created_at).getTime(),SortDirection.descending);te(ce)},[]);return o$1("div",{children:[o$1("h3",{style:{marginTop:30,marginBottom:0},children:"Orphaned Components"}),o$1("span",{className:"description_label",children:"Show all components in this knowledge base which are not in one or more knowledge views in this base."}),o$1(ButtonGroup,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:o$1(Button$2,{onClick:()=>ne(),children:"Find orphan components"})}),ee&&ee.length>0&&o$1("table",{children:o$1("tbody",{style:{cursor:"pointer"},children:ee.map(oe=>o$1("tr",{onClick:()=>t.change_route({item_id:oe.id}),children:[o$1("td",{children:oe.type}),o$1("td",{children:o$1(RichMarkDown,{text:oe.title})})]}))})}),ee&&ee.length===0&&o$1("p",{children:"No orphaned components found."})]})}const ListOrphanedWComponents=connector$o(_ListOrphanedWComponents),map_state$n=t=>{const{ready_for_reading:ee}=t.sync,{bases_by_id:te,chosen_base_id:ne}=t.user_info,{sub_route:oe,item_id:ie}=t.routing,_e=get_wcomponent_from_state(t,ie),se=t.meta_wcomponents.selected_wcomponent_ids_list;return{bases_by_id:te,chosen_base_id:ne,ready_for_reading:ee,sub_route:oe,item_id:ie,wcomponent:_e,selected_ids:se,editing:!t.display_options.consumption_formatting,wcomponent_ids_searched_for_in_any_base:t.sync.wcomponent_ids_searched_for_in_any_base}},map_dispatch$e={clear_selected_wcomponents:ACTIONS.meta_wcomponents.clear_selected_wcomponents,set_or_toggle_display_select_storage:ACTIONS.controls.set_or_toggle_display_select_storage,request_searching_for_wcomponents_by_id_in_any_base:ACTIONS.sync.request_searching_for_wcomponents_by_id_in_any_base},connector$n=connect(map_state$n,map_dispatch$e);function _WComponentsSidePanel(t){const{ready_for_reading:ee,item_id:te}=t,ne=te?!t.wcomponent_ids_searched_for_in_any_base.has(te):!1,oe=t.wcomponent,ie=t.bases_by_id&&!t.chosen_base_id?0:ee?t.sub_route==="wcomponents_edit_multiple"?2:te===null?3:4:1;if(p$1(()=>{oe||ie===4&&te&&t.request_searching_for_wcomponents_by_id_in_any_base({ids:[te]})},[ee,ie,te,oe,ne]),ie===0)return o$1("div",{children:o$1(Button,{value:"Choose a base to view",onClick:()=>t.set_or_toggle_display_select_storage(!0)})});if(ie===1)return o$1("div",{children:"Loading..."});if(ie===2)return o$1("div",{children:o$1(WComponentMultipleForm,{})});if(ie===3)return o$1("div",{children:[t.selected_ids.length>0&&o$1("p",{children:[o$1("div",{style:{display:"inline-flex"},children:[o$1(LinkButton,{name:`View ${t.selected_ids.length} component(s) already selected`,route:"wcomponents",sub_route:t.selected_ids.length>1?"wcomponents_edit_multiple":void 0,item_id:t.selected_ids.length===1?t.selected_ids[0]:void 0,args:void 0})," ",o$1(Button,{value:"Clear selection",onClick:()=>t.clear_selected_wcomponents({}),is_left:!0})]}),o$1("br",{}),o$1("br",{}),o$1("hr",{})]}),o$1(CreateNewWComponent,{}),o$1(ListOrphanedWComponents,{})]});if(oe){const _e=!!t.wcomponent&&t.wcomponent.base_id!==t.chosen_base_id;return o$1(WComponentForm,{wcomponent:oe,wcomponent_from_different_base:_e})}return o$1("div",{children:["Component not found for id: ",te,o$1("br",{}),o$1("br",{}),ne&&o$1("div",{children:"Searching in other bases..."}),!ne&&o$1("div",{children:["Not found in other bases (that you have access to).",t.editing&&te&&o$1(NotFoundWComponentKnowledgeViewForm,{wcomponent_id:te})]})]})}const WComponentsSidePanel=connector$n(_WComponentsSidePanel),map_state$m=t=>({route:t.routing.route}),connector$m=connect(map_state$m);function _SidePanel(t){return o$1("div",{children:[t.route==="filter"&&o$1(FiltersSidePanel,{}),t.route==="select"&&o$1(SelectionControlSidePanel,{}),t.route==="display"&&o$1(DisplayOptionsSidePanel,{}),t.route==="creation_context"&&o$1(CreationContextSidePanel,{}),t.route==="views"&&o$1(ViewsSidePanel,{}),t.route==="wcomponents"&&o$1(WComponentsSidePanel,{}),t.route==="about"&&o$1(AboutSidePanel,{}),t.route==="search"&&o$1(SearchSidePanel,{})]})}const SidePanel=connector$m(_SidePanel),map_state$l=t=>{const ee=t.routing.args.subview_id;return{ready_for_reading:t.sync.ready_for_reading,presenting:t.display_options.consumption_formatting,view:t.routing.args.view,kv_id:ee,nested_kv_ids_map:t.derived.nested_knowledge_view_ids}},map_dispatch$d={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting,change_route:ACTIONS.routing.change_route},connector$l=connect(map_state$l,map_dispatch$d);function _ViewsBreadcrumb(t){if(!t.ready_for_reading)return null;const{kv_id:ee,nested_kv_ids_map:te}=t;let ne=te.map[ee];const oe=[];let ie=OPTION_NONE_ID;for(;ne;){const se=ne.child_ids.map(re=>te.map[re]).filter(is_defined);if(se.length){const re=se.map(calc_if_is_hidden);oe.unshift({options:re,selected_id:ie,parent_id:ne.id})}ie=ne.id,ne=ne.parent_id!==void 0?te.map[ne.parent_id]:void 0}const _e=te.top_ids.map(se=>te.map[se]).filter(is_defined).map(calc_if_is_hidden);return oe.unshift({options:_e,selected_id:ie,parent_id:void 0}),o$1(Breadcrumbs,{style:{marginTop:"8px"},children:[o$1(Box,{children:o$1(Select,{variant:"standard",label:o$1(Typography,{noWrap:!0,children:"View Type:"}),name:"select_view",value:t.view,children:view_options.map(se=>o$1(MenuItem,{value:se.id,selected:se.id===t.view,onPointerDown:re=>{re.stopImmediatePropagation(),t.change_route({args:{view:se.id}})},children:se.title}))})}),oe.map(se=>o$1(Box,{children:o$1(AutocompleteText,{allow_none:se.parent_id!==void 0,selected_option_id:se.selected_id,options:se.options,on_change:re=>t.change_route({args:{subview_id:re||se.parent_id}}),on_choose_same:re=>t.change_route({args:{subview_id:re||se.parent_id}}),editing_allowed:!0,threshold_minimum_score:!1,retain_options_order:!0})}))]})}const ViewsBreadcrumb=connector$l(_ViewsBreadcrumb),view_options=[{id:"knowledge",title:"Knowledge"},{id:"priorities",title:"Priorities"},{id:"priorities_list",title:"Priorities list"},{id:"actions_list",title:"Actions list"}];function calc_if_is_hidden(t){const ee=t.sort_type==="hidden"||t.sort_type==="archived"||t.sort_type==="errored",te=t.sort_type==="errored"?pink:void 0;return{id:t.id,title:t.title,is_hidden:ee,color:te}}const pink={r:231,g:190,b:201,a:1};var Edit={},_interopRequireDefault$8=interopRequireDefaultExports;Object.defineProperty(Edit,"__esModule",{value:!0});var default_1$8=Edit.default=void 0,_createSvgIcon$8=_interopRequireDefault$8(requireCreateSvgIcon()),_jsxRuntime$8=requireJsxRuntime(),_default$8=(0,_createSvgIcon$8.default)((0,_jsxRuntime$8.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"}),"Edit");default_1$8=Edit.default=_default$8;var PresentToAll={},_interopRequireDefault$7=interopRequireDefaultExports;Object.defineProperty(PresentToAll,"__esModule",{value:!0});var default_1$7=PresentToAll.default=void 0,_createSvgIcon$7=_interopRequireDefault$7(requireCreateSvgIcon()),_jsxRuntime$7=requireJsxRuntime(),_default$7=(0,_createSvgIcon$7.default)((0,_jsxRuntime$7.jsx)("path",{d:"M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16.02H3V4.98h18v14.04zM10 12H8l4-4 4 4h-2v4h-4v-4z"}),"PresentToAll");default_1$7=PresentToAll.default=_default$7;const map_state$k=t=>{const ee=selector_current_user_access_level(t);return{presenting:t.display_options.consumption_formatting,access_level:ee}},map_dispatch$c={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting,change_route:ACTIONS.routing.change_route},connector$k=connect(map_state$k,map_dispatch$c);function _ViewOptions(t){const{access_level:ee}=t,te=ee==="viewer"||ee==="none",ne=!t.presenting,[oe,ie]=h$1(void 0),_e=_$d(!1);p$1(()=>{ee!==void 0&&(_e.current||(_e.current=!0,ie(te)))},[ee]);const se=te?"No editing rights":"",re=te?t.presenting?"rgba(183, 28, 26, 0.5)":"rgba(183, 28, 26)":"",ae=invert_disabled_appearance();return o$1(ButtonGroup,{size:"small",value:t.presenting?"presenting":"editing",children:[o$1(Tooltip,{title:se,"aria-label":se,children:o$1(IconButton,{className:ae.inverse_disabled,disabled:ne,component:ne?"div":void 0,onClick:ne?void 0:t.toggle_consumption_formatting,value:"editing",size:"large",children:o$1(default_1$8,{style:{color:re}})})}),o$1(IconButton,{className:ae.inverse_disabled,disabled:t.presenting,onClick:t.toggle_consumption_formatting,value:"presenting",size:"large",children:o$1(default_1$7,{})})]})}const ViewOptions=connector$k(_ViewOptions);var PermDataSetting={},_interopRequireDefault$6=interopRequireDefaultExports;Object.defineProperty(PermDataSetting,"__esModule",{value:!0});var default_1$6=PermDataSetting.default=void 0,_createSvgIcon$6=_interopRequireDefault$6(requireCreateSvgIcon()),_jsxRuntime$6=requireJsxRuntime(),_default$6=(0,_createSvgIcon$6.default)((0,_jsxRuntime$6.jsx)("path",{d:"M18.99 11.5c.34 0 .67.03 1 .07L20 0 0 20h11.56c-.04-.33-.07-.66-.07-1 0-4.14 3.36-7.5 7.5-7.5zm3.71 7.99c.02-.16.04-.32.04-.49 0-.17-.01-.33-.04-.49l1.06-.83c.09-.08.12-.21.06-.32l-1-1.73c-.06-.11-.19-.15-.31-.11l-1.24.5c-.26-.2-.54-.37-.85-.49l-.19-1.32c-.01-.12-.12-.21-.24-.21h-2c-.12 0-.23.09-.25.21l-.19 1.32c-.3.13-.59.29-.85.49l-1.24-.5c-.11-.04-.24 0-.31.11l-1 1.73c-.06.11-.04.24.06.32l1.06.83c-.02.16-.03.32-.03.49 0 .17.01.33.03.49l-1.06.83c-.09.08-.12.21-.06.32l1 1.73c.06.11.19.15.31.11l1.24-.5c.26.2.54.37.85.49l.19 1.32c.02.12.12.21.25.21h2c.12 0 .23-.09.25-.21l.19-1.32c.3-.13.59-.29.84-.49l1.25.5c.11.04.24 0 .31-.11l1-1.73c.06-.11.03-.24-.06-.32l-1.07-.83zm-3.71 1.01c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"}),"PermDataSetting");default_1$6=PermDataSetting.default=_default$6;const StorageInfo$1="",common="",StorageOption$1="";function get_user_name_for_display(t){var ie;const{users_by_id:ee,current_user_id:te,other_user_id:ne}=t;let oe=((ie=ee[ne])==null?void 0:ie.name)||"";return te?oe=te===ne?"me":oe||"(someone else)":oe=oe||"Someone",o$1("span",{title:ne,children:oe})}function StorageOption(t){const{user:ee,users_by_id:te,base:ne,selected:oe,on_click:ie,on_click_edit:_e}=t,{title:se,public_read:re,access_level:ae}=ne,ce=ae==="owner"?"Editor (Owner)":ae==="editor"?"Editor":ae==="viewer"?"Viewer":ne.public_read?"Viewer (public access)":"?";return o$1("tr",{className:"base_option "+(oe?"selected":""),onClick:ie,children:[o$1("td",{className:"narrow",children:o$1("input",{type:"radio",checked:oe,style:{cursor:"pointer"}})}),o$1("td",{children:se||"(No title)"}),o$1("td",{children:re&&"(Public)"}),o$1("td",{children:get_user_name_for_display({users_by_id:te,current_user_id:ee==null?void 0:ee.id,other_user_id:ne.owner_user_id})}),o$1("td",{children:ce}),o$1("td",{className:"narrow edit_title",onClick:ne.can_edit?de=>{de.stopImmediatePropagation(),_e()}:void 0,children:ne.can_edit&&o$1(default_1$8,{})})]})}var Sync={},_interopRequireDefault$5=interopRequireDefaultExports;Object.defineProperty(Sync,"__esModule",{value:!0});var default_1$5=Sync.default=void 0,_createSvgIcon$5=_interopRequireDefault$5(requireCreateSvgIcon()),_jsxRuntime$5=requireJsxRuntime(),_default$5=(0,_createSvgIcon$5.default)((0,_jsxRuntime$5.jsx)("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"}),"Sync");default_1$5=Sync.default=_default$5;var SyncProblem={},_interopRequireDefault$4=interopRequireDefaultExports;Object.defineProperty(SyncProblem,"__esModule",{value:!0});var default_1$4=SyncProblem.default=void 0,_createSvgIcon$4=_interopRequireDefault$4(requireCreateSvgIcon()),_jsxRuntime$4=requireJsxRuntime(),_default$4=(0,_createSvgIcon$4.default)((0,_jsxRuntime$4.jsx)("path",{d:"M3 12c0 2.21.91 4.2 2.36 5.64L3 20h6v-6l-2.24 2.24C5.68 15.15 5 13.66 5 12c0-2.61 1.67-4.83 4-5.65V4.26C5.55 5.15 3 8.27 3 12zm8 5h2v-2h-2v2zM21 4h-6v6l2.24-2.24C18.32 8.85 19 10.34 19 12c0 2.61-1.67 4.83-4 5.65v2.09c3.45-.89 6-4.01 6-7.74 0-2.21-.91-4.2-2.36-5.64L21 4zm-10 9h2V7h-2v6z"}),"SyncProblem");default_1$4=SyncProblem.default=_default$4;function SyncButton(t){const{state:ee,text:te="Refresh",title:ne="Refresh",on_click:oe,style:ie}=t,_e=ee==="error";return o$1("span",{title:ne,onClick:oe,style:ie,children:[te,!_e&&o$1(default_1$5,{className:ee==="in_progress"?"animate spinning":""}),_e&&o$1(default_1$4,{})]})}function DisplaySupabaseSessionError(t){const{error:ee}=t;return ee===null?null:(ee==null?void 0:ee.message.includes("Thanks for registering"))&&(ee==null?void 0:ee.status)===400?o$1("div",{children:"Please check your email"}):o$1("div",{children:["Error : ",ee.message||ee]})}function DisplaySupabasePostgrestError(t){const{error:ee}=t;if(!ee)return null;const te=ee.message||ee||"An error occured";let ne=`${te}`;return ne==="[object Object]"&&(ne=JSON.stringify(te)),o$1("div",{children:["Error: ",ne]})}const map_state$j=t=>({user:t.user_info.user,users_by_id:t.user_info.users_by_id,chosen_base_id:t.user_info.chosen_base_id,bases_by_id:t.user_info.bases_by_id}),map_dispatch$b={update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$j=connect(map_state$j,map_dispatch$b);function _AvailableBases(t){const{on_choose:ee,on_click_edit:te,user:ne,users_by_id:oe,chosen_base_id:ie,bases_by_id:_e,update_chosen_base_id:se}=t,[re,ae]=h$1("initial"),[ce,de]=h$1(void 0);if(!oe)return"Loading users...";if(!_e)return"Loading bases...";const ue=sort_list(Object.values(_e),le=>le.inserted_at.getTime(),SortDirection.descending);return ue.length===0?null:o$1("div",{style:{margin:10},children:[o$1(SyncButton,{state:re,title:"Refresh sharing options",on_click:async()=>{ae("in_progress");const le=await refresh_bases_for_current_user();ae(le.error?"error":"success"),de(le.error)},style:{float:"right"}}),o$1("h4",{children:"Select a base"}),o$1(DisplaySupabasePostgrestError,{error:ce}),o$1("table",{children:[o$1("thead",{children:o$1("tr",{children:[o$1("th",{}),o$1("th",{children:"Knowledge Base Title"}),o$1("th",{}),o$1("th",{children:"Owner"}),o$1("th",{children:"Access"}),o$1("th",{})]})}),o$1("tbody",{children:ue.map(le=>o$1(StorageOption,{user:ne,users_by_id:oe,base:le,selected:le.id===ie,on_click:()=>{se({base_id:le.id}),ee&&ee()},on_click_edit:()=>te(le.id)}))})]})]})}const AvailableBases=connector$j(_AvailableBases);function BaseFormEditFields(t){const{base:ee,on_save_or_exit:te,user:ne}=t,[oe,ie]=h$1(ee);p$1(()=>ie(ee),[ee]);const[_e,se]=h$1(void 0),re=ee.owner_user_id===ne.id,ae=JSON.stringify(ee)!==JSON.stringify(oe),ce=!!oe.title;function de(ue,le){let pe=ue.currentTarget.value;le&&(pe=pe.trim()),ie({...oe,title:pe})}return re?o$1("div",{children:[o$1("h4",{children:"Edit base"}),"Title   ",o$1("input",{type:"text",placeholder:"title",value:oe.title,onChange:ue=>de(ue,!1),onBlur:ue=>de(ue,!0)}),o$1("br",{}),o$1("br",{}),"Visibility   ",o$1("input",{type:"button",onClick:()=>{ie({...oe,public_read:!oe.public_read})},value:oe.public_read?"Make private":"Publish (make public)"}),o$1("br",{}),o$1("br",{}),"Default view   ",o$1(SelectKnowledgeView,{selected_option_id:oe.default_knowledge_view_id,on_change:ue=>{ie({...oe,default_knowledge_view_id:ue})},editing_allowed:!0}),o$1("br",{}),o$1("br",{}),o$1("div",{children:[ae&&ce&&o$1("input",{type:"button",disabled:!ae||!ce,onClick:async()=>{const ue=await modify_base(oe);if(ue.error)return se(ue.error);se(void 0),pub_sub.user.pub("stale_bases",!1)},value:"Save changes"}),"  ",o$1("input",{type:"button",onClick:te,value:ae?"Cancel":"Back"}),o$1("br",{}),o$1(DisplaySupabasePostgrestError,{error:_e})]}),o$1("br",{}),o$1("hr",{})]}):null}const BaseFormEditSharing$1="";async function get_access_controls_for_base(t){const ee=get_supabase(),{data:te,error:ne}=await ee.from("access_controls").select("*").eq("base_id",t);return{access_controls:te&&te.map(ie=>({...ie,inserted_at:new Date(ie.inserted_at),updated_at:new Date(ie.updated_at)}))||void 0,error:ne}}async function update_access_control(t){const ee={base_id:t.base_id,user_id:t.other_user_id,access_level:t.grant};return await get_supabase().from("access_controls").upsert(ee)}function SelectAccessLevelDropDown(t){const ee=["editor","viewer","none"];return o$1(Select,{variant:"standard",disabled:t.disabled,value:t.current_level,title:t.title||"Select access level",onChange:te=>{const ne=te.currentTarget.getAttribute("data-value");t.on_change(ne)},children:ee.map(te=>o$1(MenuItem,{value:te,children:sentence_case(te)}))})}function AccessControlEntry(t){const{access_control:ee,base_id:te,users_by_id:ne,current_user_id:oe,is_owner:ie,on_update:_e}=t,{user_id:se,access_level:re}=ee,ae=ce=>update_access_control({base_id:te,other_user_id:se,grant:ce}).then(_e);return o$1("tr",{children:[o$1("td",{children:get_user_name_for_display({users_by_id:ne,current_user_id:oe,other_user_id:se})}),o$1("td",{children:o$1(SelectAccessLevelDropDown,{disabled:!ie,current_level:re,title:ie?"Select access level":"Only owners can edit access levels",on_change:ae})}),o$1("br",{})]})}function AddAccessControlEntry(t){const[ee,te]=h$1(""),[ne,oe]=h$1("editor"),[ie,_e]=h$1("initial"),se=ie==="in_progress",re=ie==="success",[ae,ce]=h$1(null),{base_id:de}=t;return o$1("div",{children:["Share with new user: ",o$1("br",{}),o$1("input",{type:"text",placeholder:"User's ID or email",value:ee,disabled:se,style:{minWidth:200},onKeyUp:ue=>te(ue.currentTarget.value),onChange:ue=>te(ue.currentTarget.value),onBlur:ue=>te(ue.currentTarget.value)}),"  ",o$1(SelectAccessLevelDropDown,{current_level:ne,on_change:oe}),o$1("br",{}),se&&o$1("span",{children:"Adding..."}),re&&o$1("span",{children:"Added."}),o$1(DisplaySupabasePostgrestError,{error:ae}),o$1("br",{}),ee&&o$1("input",{type:"button",onClick:async()=>{_e("in_progress");const le=await get_supabase().rpc("invite_user_to_base",{base_id:de,email_or_uid:ee,access_level:ne}),{status:pe,error:me}=le;ce(me),_e(me?"error":"success"),me||(te(""),t.on_add_or_exit(!0))},value:"Add user",disabled:!ee}),"  ",o$1("input",{type:"button",onClick:()=>t.on_add_or_exit(!1),value:"Back"})]})}const map_state$i=t=>({users_by_id:t.user_info.users_by_id}),connector$i=connect(map_state$i);function _BaseFormEditSharing(t){const{user:ee,base:te,on_save_or_exit:ne,users_by_id:oe}=t,[ie,_e]=h$1("initial"),[se,re]=h$1(void 0),[ae,ce]=h$1(void 0),de=te.owner_user_id===ee.id;function ue(){_e("in_progress"),get_access_controls_for_base(te.id).then(le=>{_e(le.error?"error":"success"),re(le.access_controls),ce(le.error||void 0),!le.error&&pub_sub.user.pub("stale_users_by_id",!1)})}return p$1(()=>ue(),[]),oe?o$1("div",{children:[o$1(SyncButton,{state:ie,title:"Refresh sharing options",on_click:()=>ue(),style:{float:"right"}}),o$1("h4",{children:"Sharing options"}),o$1(DisplaySupabasePostgrestError,{error:ae}),se&&o$1("div",{children:[se.length===0&&"Not shared with anyone yet",se.length>0&&o$1("table",{className:"access_controls_table",children:o$1("tbody",{children:se.map(le=>o$1(AccessControlEntry,{access_control:le,base_id:te.id,users_by_id:oe,current_user_id:ee.id,is_owner:de,on_update:pe=>{ce(pe.error||void 0),pe.error||ue()}}))})}),o$1("br",{})]}),!de&&o$1("div",{children:"Sharing with new users (Only owners can do this for now)"}),de&&o$1(AddAccessControlEntry,{base_id:te.id,on_add_or_exit:le=>{le?ue():ne()}})]}):o$1("div",{children:"Fetching users..."})}const BaseFormEditSharing=connector$i(_BaseFormEditSharing),map_state$h=t=>({user:t.user_info.user}),connector$h=connect(map_state$h);function _BaseForm(t){const{base:ee,on_save_or_exit:te,user:ne}=t;return ne?o$1("div",{style:{margin:10},children:[o$1(BaseFormEditFields,{user:ne,base:ee,on_save_or_exit:te}),o$1(BaseFormEditSharing,{user:ne,base:ee,on_save_or_exit:te})]}):"Please sign in"}const BaseForm=connector$h(_BaseForm),map_state$g=t=>({user:t.user_info.user,users_by_id:t.user_info.users_by_id,bases_by_id:t.user_info.bases_by_id}),map_dispatch$a={update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$g=connect(map_state$g,map_dispatch$a);function _StorageOptionsForm(t){const{on_close:ee,user:te,users_by_id:ne,bases_by_id:oe,update_chosen_base_id:ie}=t,[_e,se]=h$1(""),[re,ae]=h$1("initial"),[ce,de]=h$1(void 0),[ue,le]=h$1(void 0);if(!ne)return"Loading users...";if(!oe)return"Loading bases...";const pe=te==null?void 0:te.id,me=Object.keys(oe).length,fe=pe===void 0?void 0:async function(){ae("in_progress");const ge=await create_a_base({owner_user_id:pe,title:_e.trim()});ae(ge.error?"error":"success"),le(ge.base),ge.error||(pub_sub.user.pub("stale_bases",!1),se(""))};return ce!==void 0?o$1("div",{style:{margin:10},children:o$1(BaseForm,{base:oe[ce],on_save_or_exit:()=>de(void 0)})}):o$1("div",{style:{margin:10},children:[o$1(AvailableBases,{on_choose:ee,on_click_edit:ge=>de(ge)}),me>0&&fe&&o$1("hr",{}),fe&&o$1("div",{children:[o$1("h4",{children:["Create ",me?"a new":"your first"," base"]}),o$1("input",{type:"text",value:_e,onKeyUp:ge=>se(ge.currentTarget.value),onChange:ge=>se(ge.currentTarget.value),onBlur:ge=>se(ge.currentTarget.value)}),o$1("br",{}),o$1("input",{type:"button",disabled:!fe||!_e.trim()||re==="in_progress",onClick:fe,value:"Create new base"}),"  ",async_status_to_text(re),"  ",ue&&o$1("input",{type:"button",onClick:()=>{ie({base_id:ue.id}),ee&&ee()},value:"Select new base"})]})]})}const StorageOptionsForm=connector$g(_StorageOptionsForm);function async_status_to_text(t){return t==="initial"?"":t==="in_progress"?"Creating...":t==="success"?"Created.":"Error"}function SelectStorage(t){const{on_close:ee}=t;return o$1(Modal,{title:o$1("div",{style:{margin:10},children:o$1("h2",{style:{display:"inline"},children:"Knowledge Bases"})}),size:"medium",on_close:ee&&(te=>{te==null||te.stopImmediatePropagation(),ee()}),child:o$1(StorageOptionsForm,{on_close:ee})})}const map_state$f=t=>({base_name:selector_chosen_base_name(t),needs_to_create_a_base:selector_needs_to_create_a_base(t),display_select_storage:t.controls.display_select_storage}),map_dispatch$9={set_or_toggle_display_select_storage:ACTIONS.controls.set_or_toggle_display_select_storage},connector$f=connect(map_state$f,map_dispatch$9);function _StorageInfo(t){const{needs_to_create_a_base:ee,display_select_storage:te,set_or_toggle_display_select_storage:ne}=t;return p$1(()=>{ee&&ne(!0)},[ee]),o$1(Typography,{component:"span",children:[o$1(Button$2,{id:"storage_info_button",color:"primary",disableElevation:!0,onClick:()=>ne(!0),size:"small",endIcon:o$1(default_1$6,{titleAccess:"Create and Select Knowledge Bases"}),style:{textTransform:"none"},variant:"contained",children:o$1("span",{class:"storage_name",children:t.base_name||"Choose store"})}),te&&o$1(SelectStorage,{on_close:ee?void 0:()=>ne(!1)})]})}const StorageInfo=connector$f(_StorageInfo);var AccountCircle={},_interopRequireDefault$3=interopRequireDefaultExports;Object.defineProperty(AccountCircle,"__esModule",{value:!0});var default_1$3=AccountCircle.default=void 0,_createSvgIcon$3=_interopRequireDefault$3(requireCreateSvgIcon()),_jsxRuntime$3=requireJsxRuntime(),_default$3=(0,_createSvgIcon$3.default)((0,_jsxRuntime$3.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"}),"AccountCircle");default_1$3=AccountCircle.default=_default$3;const no_user_name="(No user name)";var ExitToApp={},_interopRequireDefault$2=interopRequireDefaultExports;Object.defineProperty(ExitToApp,"__esModule",{value:!0});var default_1$2=ExitToApp.default=void 0,_createSvgIcon$2=_interopRequireDefault$2(requireCreateSvgIcon()),_jsxRuntime$2=requireJsxRuntime(),_default$2=(0,_createSvgIcon$2.default)((0,_jsxRuntime$2.jsx)("path",{d:"M10.09 15.59 11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"ExitToApp");default_1$2=ExitToApp.default=_default$2;const map_state$e=t=>{const{need_to_handle_password_recovery:ee}=t.user_info;return{user:t.user_info.user,need_to_handle_password_recovery:ee}},map_dispatch$8={set_user:ACTIONS.user_info.set_user,set_need_to_handle_password_recovery:ACTIONS.user_info.set_need_to_handle_password_recovery},connector$e=connect(map_state$e,map_dispatch$8);function _UserAccountInfoChangePasswordForm(t){const{on_close:ee,user:te,set_user:ne,need_to_handle_password_recovery:oe,set_need_to_handle_password_recovery:ie}=t,[_e,se]=h$1(""),[re,ae]=h$1(null);if(!te)return null;async function ce(){const ue=get_supabase(),le=te==null?void 0:te.email,pe=await ue.auth.update({email:le,password:_e});ae(pe.error),pe.error||(ne({user:pe.user||void 0}),ie(!1),ee())}const de=use_styles$5();return o$1(FormGroup,{className:"section",children:[oe&&o$1("p",{children:"Please set a new password."}),o$1(Box,{className:de.root,children:[o$1(FormControl,{variant:"standard",children:o$1(TextField,{inputProps:{type:"password"},onBlur:ue=>se(ue.currentTarget.value),onChange:ue=>se(ue.currentTarget.value),onKeyUp:ue=>se(ue.currentTarget.value),label:"password",size:"small",value:_e,variant:"outlined"})}),o$1(Box,{className:de.update_button_container,children:o$1(Button$2,{className:de.update_button,disabled:!(te!=null&&te.email)||!_e,onClick:ce,variant:"contained",children:"Update password"})}),o$1(Box,{children:!oe&&o$1(Button$2,{variant:"contained",onClick:()=>{ee(),ae(null)},children:"Cancel"})})]}),o$1(DisplaySupabaseSessionError,{error:re})]})}const use_styles$5=makeStyles(t=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),UserAccountInfoChangePasswordForm=connector$e(_UserAccountInfoChangePasswordForm),map_state$d=t=>{const{user:ee,users_by_id:te}=t.user_info;return{user:ee,users_by_id:te,need_to_set_user_name:selector_need_to_set_user_name(t)}},map_dispatch$7={},connector$d=connect(map_state$d,map_dispatch$7);function _UserAccountInfoChangeUsernameForm(t){const{on_close:ee,user:te,need_to_set_user_name:ne}=t,[oe,ie]=h$1(""),_e=(t.users_by_id||{})[(te==null?void 0:te.id)||""],se=(_e==null?void 0:_e.name)||"";p$1(()=>ie(se),[se]);const[re,ae]=h$1("initial"),ce=re==="in_progress",[de,ue]=h$1(null);if(!te)return null;const{id:le}=te;async function pe(){var ve;const fe=get_supabase();ae("in_progress");const{data:ge,error:he}=await fe.from("users").upsert({id:le,name:oe}).eq("id",le);ue(he),((ge&&((ve=ge[0])==null?void 0:ve.name))??void 0)&&pub_sub.user.pub("stale_users_by_id",!1),ae(he?"error":"success")}const me=use_styles$4();return o$1(FormGroup,{className:"section",children:[o$1(Box,{className:me.root,children:[o$1(FormControl,{variant:"standard",children:o$1(TextField,{disabled:ce,onChange:fe=>{ie(fe.currentTarget.value)},onBlur:fe=>{ie(fe.currentTarget.value)},placeholder:"Username",size:"small",value:oe,variant:"outlined"})}),o$1(Box,{className:me.update_button_container,children:o$1(Button$2,{className:me.update_button,disabled:!oe||ce,onClick:pe,variant:"contained",children:[ne?"Set":"Change"," username"]})}),o$1(Box,{children:!ne&&o$1(Button$2,{variant:"contained",onClick:()=>{ee(),ue(null)},children:"Close"})})]}),ce&&"Saving...",re==="success"&&"Saved.",o$1(DisplaySupabasePostgrestError,{error:de})]})}const use_styles$4=makeStyles(t=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},username_input:{borderTopRightRadius:0,borderBottomRightRadius:0},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),UserAccountInfoChangeUsernameForm=connector$d(_UserAccountInfoChangeUsernameForm),map_state$c=t=>{const{need_to_handle_password_recovery:ee}=t.user_info;return{user:t.user_info.user,user_name:selector_user_name(t),need_to_set_user_name:selector_need_to_set_user_name(t),need_to_handle_password_recovery:ee}},map_dispatch$6={set_user:ACTIONS.user_info.set_user},connector$c=connect(map_state$c,map_dispatch$6),use_styles$3=makeStyles(t=>({root:{margin:5},section:{display:"flex",justifyContent:"space-between",alignItems:"center"},logout_section:{flexBasis:"100%"},button:{marginBottom:5},label:{marginBottom:10}}));function _UserAccountInfoForm(t){const{user:ee,user_name:te,need_to_set_user_name:ne,need_to_handle_password_recovery:oe,set_user:ie}=t,[_e,se]=h$1("initial"),[re,ae]=h$1(null);if(console.log("user account info form need_to_set_user_name",ne,"form_state",_e),p$1(()=>{ne&&se("updating_username")},[ne,_e]),!ee)return null;if(_e==="updating_password"||oe)return o$1(UserAccountInfoChangePasswordForm,{on_close:()=>se("initial")});if(_e==="updating_username")return o$1(UserAccountInfoChangeUsernameForm,{on_close:()=>se("initial")});const ce=use_styles$3();return o$1(Box,{className:ce.root,children:[o$1(Box,{className:`${ce.section} ${ce.logout_section} section`,children:[o$1("p",{children:["Logged in with",o$1("strong",{children:[" ",ee.email," "]})]}),o$1(Box,{children:o$1(Button$2,{onClick:()=>save_and_optionally_signout(!0),variant:"contained",endIcon:o$1(default_1$2,{}),children:"Log out"})})]}),o$1(Box,{className:`${ce.section} section`,display:"flex",justifyContent:"space-between",children:[o$1(Typography,{component:"p",children:["User name ",o$1("strong",{children:te?`: ${te}`:""}),o$1("br",{}),o$1("small",{children:["user id:   ",ee.id]})]}),o$1(Box,{children:[o$1(Button$2,{className:ce.button,variant:"contained",onClick:()=>se("updating_username"),children:[ne?"Set":"Change"," username"]}),o$1("br",{}),o$1(Button$2,{variant:"contained",onClick:()=>se("updating_password"),children:"Change password"})]})]}),o$1(DisplaySupabaseSessionError,{error:re})]})}const UserAccountInfoForm=connector$c(_UserAccountInfoForm);function UserAccountInfo(t){const{on_close:ee}=t;return o$1(Modal,{title:o$1("div",{style:{margin:10,textAlign:"center"},children:o$1("h2",{children:"User Account"})}),size:"medium",on_close:ee?te=>{te==null||te.stopImmediatePropagation(),ee()}:void 0,child:o$1("div",{style:{textAlign:"center"},children:o$1(UserAccountInfoForm,{on_close:ee})})})}const UserSigninRegisterForm$1="",map_state$b=t=>({}),map_dispatch$5={set_user:ACTIONS.user_info.set_user},connector$b=connect(map_state$b,map_dispatch$5);function _UserSigninRegisterForm(t){const{set_user:ee}=t,te=get_supabase(),[ne,oe]=h$1("initial"),[ie,_e]=h$1(""),[se,re]=h$1(""),[ae,ce]=h$1(null),[de,ue]=h$1(!1),[le,pe]=h$1(!1);function me(ve){_e(ve),ue(!1)}function fe(ve){re(ve),pe(!1)}async function ge(){if(!ie||!se){ie||ue(!0),se||pe(!0);return}const{user:ve,error:we}=await te.auth.signUp({email:ie,password:se},{redirectTo:"https://datacurator.org/app/"});ce(we),we||oe("registered")}async function he(){if(!ie||!se){ie||ue(!0),se||pe(!0);return}const{user:ve,error:we}=await te.auth.signIn({email:ie,password:se});ce(we),ee({user:ve||void 0})}async function be(){if(!ie){ue(!0),pe(!1);return}const{data:ve,error:we}=await te.auth.api.resetPasswordForEmail(ie);ce(we),we||oe("reset_password")}return ne==="initial"?o$1("div",{className:"section",children:[o$1("form",{children:[o$1("br",{}),o$1("br",{}),o$1("input",{type:"email",placeholder:"email",value:ie,onKeyUp:ve=>me(ve.currentTarget.value),onChange:ve=>me(ve.currentTarget.value),onBlur:ve=>me(ve.currentTarget.value)}),o$1("div",{className:"error_form_input_empty "+(de?"":"inactive"),children:"Email required"}),o$1("br",{}),o$1("input",{type:"password",placeholder:"password",value:se,onKeyUp:ve=>fe(ve.currentTarget.value),onChange:ve=>fe(ve.currentTarget.value),onBlur:ve=>fe(ve.currentTarget.value)}),o$1("div",{className:"error_form_input_empty "+(le?"":"inactive"),children:"Password required"})]}),o$1("div",{children:[o$1("br",{}),o$1("input",{type:"button",onClick:he,value:"Signin"}),"  ",o$1("input",{type:"button",onClick:ge,value:"Register"}),o$1("br",{}),o$1("br",{}),o$1("input",{type:"button",onClick:be,value:"Forgot password?"}),o$1("br",{}),o$1("br",{})]}),o$1(DisplaySupabaseSessionError,{error:ae}),o$1("br",{})]}):ne==="reset_password"?o$1("div",{className:"section",children:[o$1("h3",{children:"Password reset"}),o$1("br",{}),!ae&&"Please check your email",o$1(DisplaySupabaseSessionError,{error:ae})]}):o$1("div",{className:"section",children:[o$1("h3",{children:"Registered"}),o$1("br",{}),"Please check your email"]})}const UserSigninRegisterForm=connector$b(_UserSigninRegisterForm);function UserSigninRegister(t){return o$1(Modal,{title:o$1("div",{style:{margin:10,textAlign:"center"},children:o$1("h2",{children:"Signin / Register"})}),size:"medium",on_close:t.on_close,child:o$1("div",{style:{textAlign:"center"},children:o$1(UserSigninRegisterForm,{})})})}const map_state$a=t=>({user:t.user_info.user,bases_by_id:t.user_info.bases_by_id,users_by_id:t.user_info.users_by_id,chosen_base_id:t.user_info.chosen_base_id,user_name:selector_user_name(t),need_to_set_user_name:selector_need_to_set_user_name(t)}),map_dispatch$4={},connector$a=connect(map_state$a,map_dispatch$4);function _UserInfo(t){const{user:ee,bases_by_id:te,users_by_id:ne,chosen_base_id:oe,user_name:ie,need_to_set_user_name:_e}=t,se=!ne,[re,ae]=h$1("hidden"),ce=_$d(ee),de=ie||no_user_name;return p$1(()=>{const ue=!ce.current&&ee;ce.current=ee;const le=te&&oe?!te[oe]:!1;ae(!ee&&le?"signin":se?"loading":_e?"account_info":ue?"hidden":re)},[ee,te,oe,se,_e]),o$1("div",{children:[o$1(Button$2,{color:"primary",endIcon:o$1(default_1$3,{}),fullWidth:!0,disableElevation:!0,onClick:()=>ae(ee?"account_info":"signin"),size:"small",style:{textTransform:"none"},variant:"contained",children:o$1(Typography,{noWrap:!0,children:ee?de:se?"Loading":"Sign in"})}),re==="signin"&&o$1(UserSigninRegister,{on_close:()=>ae("hidden")}),re==="account_info"&&o$1(UserAccountInfo,{on_close:_e?void 0:()=>ae("hidden")})]})}const UserInfo=connector$a(_UserInfo);var Save={},_interopRequireDefault$1=interopRequireDefaultExports;Object.defineProperty(Save,"__esModule",{value:!0});var default_1$1=Save.default=void 0,_createSvgIcon$1=_interopRequireDefault$1(requireCreateSvgIcon()),_jsxRuntime$1=requireJsxRuntime(),_default$1=(0,_createSvgIcon$1.default)((0,_jsxRuntime$1.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"}),"Save");default_1$1=Save.default=_default$1;const map_state$9=t=>({sync_state_specialised_objects:t.sync.specialised_objects,sync_state_bases:t.sync.bases,ready_for_writing:t.sync.ready_for_writing}),map_dispatch$3={update_sync_status:ACTIONS.sync.update_sync_status},connector$9=connect(map_state$9,map_dispatch$3);function _SyncInfo(t){const{sync_state_specialised_objects:ee,sync_state_bases:te,ready_for_writing:ne}=t,oe=ee.status==="FAILED"||te.status==="FAILED",ie=ee.status==="LOADING"||te.status==="LOADING",_e=ee.status==="SAVING"||te.status==="SAVING",se=[ee.error_message,te.error_message].filter(is_defined).join(", "),re=ie||_e,ae=use_styles$2();let ce=sentence_case(ee.status||"");return te.status&&te.status!=="LOADED"&&te.status!=="SAVED"&&(ce+=te.status!==ee.status&&", "+sentence_case(te.status)||""),ce?o$1(Typography,{component:"span",children:o$1(Button$2,{className:ae.button,size:"small",disabled:!ne,onClick:async de=>{de.currentTarget.blur();const ue=get_store();await save_state(ue,!0)},startIcon:oe?o$1(default_1$4,{color:"error"}):o$1(default_1$1,{className:re?"animate spinning":""}),title:oe?se:ce,children:[o$1(Typography,{className:`${ae.animate} ${ae.initially_shown} show`,color:oe?"error":"initial",component:"span",noWrap:!0,children:oe?"Failed!":ce}),o$1(Typography,{className:`${ae.animate} ${ae.initially_hidden} hide`,color:"initial",component:"span",noWrap:!0,children:oe?"Retry Now":"Save Now"}),o$1(Typography,{component:"span",children:" "})]})}):null}const SyncInfo=connector$9(_SyncInfo),use_styles$2=makeStyles(t=>({button:{textTransform:"none","&:hover .show":{fontSize:0},"&:focus .show":{fontSize:0},"&:hover .hide":{fontSize:"initial"},"&:focus .hide":{fontSize:"initial"}},animate:{transitionProperty:"all",transitionDuration:"0.23s"},initially_hidden:{fontSize:0},initially_shown:{fontSize:"initial"}})),HelpMenu$1="",map_state$8=t=>({show:t.display_options.show_help_menu}),map_dispatch$2={set_show_help_menu:ACTIONS.display.set_show_help_menu},connector$8=connect(map_state$8,map_dispatch$2);function _HelpMenu(t){const[ee,te]=h$1("kbd-shortcuts"),ne=oe=>(ie,_e)=>{te(_e?oe:!1)};return t.show?o$1(Modal,{size:"medium",title:"",on_close:()=>t.set_show_help_menu({show:!1}),child:o$1(Box,{p:10,children:[o$1(Typography,{component:"h1",variant:"h5",children:"Tips for using DataCurator"}),o$1(Accordion,{expanded:ee==="kbd-shortcuts",onChange:ne("kbd-shortcuts"),expandIcon:o$1(default_1$i,{}),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:"Commands / shortcuts"})}),o$1(AccordionDetails,{children:o$1(Box,{children:["These shortcuts only work when you are not editing a text field.  Some may only work when you are on the Map (Knowledge) canvas view.",shortcuts_list.map(oe=>o$1(ShortcutCommand,{...oe}))]})})]}),o$1(Accordion,{expanded:ee==="linking-tips",onChange:ne("linking-tips"),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:" Tips on Linking"})}),o$1(AccordionDetails,{children:o$1(Box,{children:tips_on_linking.map(oe=>o$1(Typography,{component:"p",paragraph:!0,children:oe}))})})]}),o$1(Accordion,{expanded:ee==="general-tips",onChange:ne("general-tips"),expandIcon:o$1(default_1$i,{}),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:"General tips"})}),o$1(AccordionDetails,{children:o$1(Box,{children:general_tips.map(oe=>o$1(Typography,{component:"p",paragraph:!0,children:oe}))})})]}),o$1(Accordion,{expanded:ee==="detailed-tips",onChange:ne("detailed-tips"),expandIcon:o$1(default_1$i,{}),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:"Detailed tips"})}),o$1(AccordionDetails,{children:o$1(Box,{children:detailed_tips.map(oe=>o$1(Typography,{component:"p",paragraph:!0,children:oe}))})})]})]})}):null}const HelpMenu=connector$8(_HelpMenu),tips_on_linking=[`Type "@@" in any text field to access a menu to link to any other component.
    This will insert the id of that component, e.g.  @@12345678-abcd-4123-abcd-1234567890ab.`,`Follow "@@some-id" with .url, .title and .description to get the attributes
    of that component e.g. "@@12345678-abcd-4123-abcd-1234567890ab.title".  Or if it has an
    associated knowledge view then add .map to go to that knowledge view.`,o$1("span",{children:["Markdown is available so you can use things like ",o$1("b",{children:"**some text**"}),'to make it bold once it is rendered during presentation mode. Other Markdown syntax like "1. some text" will give you numbered lists. See the full ',o$1("a",{href:"https: //www.markdownguide.org/basic-syntax/",children:"Markdown guide here"})]})],general_tips=[o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:'"Should" word usage'}),'If you find yourself writing states with "should", e.g. "People ',o$1("b",{children:"should"}),' listen more and be less reductionist" then you might consider separating this out into its 4 separate parts and phrasing as the positive or desired state.  Specifically:',o$1("ol",{children:[o$1("li",{children:`the attribute, e.g.: "People listen more and be less reductionist".  Note it is usually easier to express this as the desired state of the attribute instead of the pure attribute itself which is usually longer and less easy to work with: "People's ability to listen and what degree of complexity they can hold in their minds about different subjects".`}),o$1("li",{children:'the current value, e.g.: "False"'}),o$1("li",{children:"the other possibilities.  If the value is a boolean i.e. True/False then this can be skipped otherwise if it is a number or other type of value then add the other different possible values."}),o$1("li",{children:"the judgement or objective about the desired value, e.g.: create a judgement or objective node, target your state node, and choose the desired value via the comparator"})]})]}),o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:'"Action" node type versus "State"'}),"The action and state node types are very similar.  The former can be used to draw attention to the areas where you or a team member can have an effect on the project.  You can use actions to represent the activity of third party actors but this usually draws unwarranted attention to these components."]})],detailed_tips=[o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:"State subtypes"}),"There are three State subtypes:",o$1("ol",{children:[o$1("li",{children:"boolean, e.g. True / False"}),o$1("li",{children:"number"}),o$1("li",{children:"other"})]}),"Often you can represent the same attribute in different ways and this will depend on what level of detail is salient to the conversation / the model of the scenario you are interested in.",o$1("ol",{children:[o$1("li",{children:'a boolean, with title "The medical response was fast" or "The medical response time was adequate"'}),o$1("li",{children:'"other" with title "The medical response", with values of "Very slow", "Slow", "Medium", "Fast", "Very fast" etc.'}),o$1("li",{children:'"number" with title "The medical response speed", where the value perhaps represents the time in minutes until aid was first administered.'})]})]}),o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:"Multidimensional states"}),'Often there can be attributes / concepts which have two dimensions to them which are salient together, e.g. "The medical response was fast and effective".  These can be modelled using states with titles and subtypes in many ways, for example:',o$1("ol",{children:[o$1("li",{children:'a boolean, with title "The medical response was (adequately) fast and effective"'}),o$1("li",{children:'"number" with title "The medical response speed and effectiveness", where the value is derived from some formula to calculate a single number based of the two attributes of speed and effectiveness.'})]}),'If the concept later needs to be analysed / comprehended / explored in greater detail it can be decomposed.  Either it could be change to a subtype of "other" with title "The medical response speed and effectiveness", with values of "fast and effective", "fast but ineffective", "slow but effective", "slow and ineffective".  Or replaced by two new seperate states, one for "Medical response speed" and one for "Medical response effectiveness".  In the latter case deleting the first node from the knowledge views would be best.  In the former case, ',o$1("a",{href:"https: //github.com/centerofci/data-curator2/issues/36",children:"versioning the whole component"})," would make this easier from a user's perspective."]}),o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:"Temporal uncertainty"}),o$1("p",{children:'Part of making predictions is knowing when some event may occur.  For this we have a very simple "Temporal Uncertainty" form that has three fields: Min, Expected and Max datetime.'}),o$1("p",{children:"It's important to note that this represents a single event and not a distribution of similar events.  It is also not directly the uncertain temporal range a state might exist over.  i.e. the min is the earliest when the event can occur.  This is easier to understand if you talk about the max value.  The max is the latest the event can occur.  This means the state (associate with state transition events) will occur from the max of an event marking its existence but might occur earlier: up to an including the min datetime of the event."}),o$1("p",{children:"A concrete example: you will switch on the light in 1 minute (min), likely in 5 minutes (expected) or at most in 10 minutes (max).  But this does not mean the room will be lit from 1 minutes time to 10 minutes time."}),o$1("p",{children:"The current form is also woefully simplistic for a lot of the uncertain temporal distributions you have inside your head, use almost all the time, use seamlessly, unconsciously, and yet are vital to coordinated effective collaboration, for (complex) interventions."}),o$1("p",{children:"For example: when are you going to get funding for project X, when will have a hire for position Y, when will your change job, when will you next go shopping (if it's not raining AND someone else not gone yet AND time after 7 am AND time less 10 am then ...)."})]})];var Close={},_interopRequireDefault=interopRequireDefaultExports;Object.defineProperty(Close,"__esModule",{value:!0});var default_1=Close.default=void 0,_createSvgIcon=_interopRequireDefault(requireCreateSvgIcon()),_jsxRuntime=requireJsxRuntime(),_default=(0,_createSvgIcon.default)((0,_jsxRuntime.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");default_1=Close.default=_default;const map_state$7=t=>({display_side_panel:t.controls.display_side_panel}),map_dispatch$1={set_or_toggle_display_side_panel:ACTIONS.controls.set_or_toggle_display_side_panel},connector$7=connect(map_state$7,map_dispatch$1);function _SidePanelOrMenuButton(t){return o$1(IconButton,{"aria-label":"open side panel",color:"inherit",edge:"end",onClick:t.set_or_toggle_display_side_panel,size:"small",children:t.display_side_panel?o$1(default_1,{}):o$1(default_1$c,{})})}const SidePanelOrMenuButton=connector$7(_SidePanelOrMenuButton);function ActiveUserWidget(){return use_styles$1(),h$1(!1),null}withStyles(t=>({badge:{top:2,right:"-0.42em",zIndex:1}}))(Badge);const use_styles$1=makeStyles(t=>({button:{display:"inline-block",marginRight:"1em",border:`1px ${t.palette.divider} solid`},icon:{position:"relative",zIndex:10}}));function uuid_v4_for_tests(t){if(!Number.isInteger(t))throw new Error("uuid_v4_for_tests id must be an integer");if(t<0||t>10)throw new Error("uuid_v4_for_tests id must be 0-9 inclusive");return`${t}0000000-0000-4000-a000-000000000000`}const run_apply_units_from_component_tests=describe.delay("apply_units_from_component",()=>{let t,ee,te,ne,oe;const ie=uuid_v4_for_tests(1),_e=uuid_v4_for_tests(2),re=prepare_new_contextless_wcomponent_object({base_id:0,id:ie,title:"Some state component",type:"statev2",units:"seconds"});te={[ie]:re},ee=`@@${ie}`,t="",oe="seconds",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Can access a wcomponent's value and uses its units when no units given by calculation"),ee=`  @@${ie}  `,t="",oe="seconds",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Uses a wcomponent's units, even with surrounding whitespace"),ee=`@@${ie}`,t="Unitless",oe="seconds",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Silently uses a wcomponent's units even when units given by calculation"),ee=`@@${ie} + 1`,t="meters",oe="meters",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Ignores component units if calculation value is not just a @@uuid"),ee=`@@${_e}`,t="meters",oe=void 0,ne=apply_units_from_component(ee,t,te),test(ne,oe,"Defaults units to undefined when component can not be found, even if calculation has units given")}),run_convert_percentages_tests=describe.delay("convert_percentages",()=>{let t="",ee="",te="";t="90 %",ee="(90 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbol to numbers"),t="90 % / 10%",ee="(90 * 0.01) / (10 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbols without spaces to numbers"),t="90.123 %",ee="(90.123 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbols with decimal places"),t=".123 %",ee="(.123 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbols with decimal point and no leading digit"),t="90.123 % - -90.123 %",ee="(90.123 * 0.01) - -(90.123 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert negative or positive percentage symbols"),t="9.1e+1 % - 9.1e-1 %",ee="(9.1e+1 * 0.01) - (9.1e-1 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert scientific notation percentage symbols")}),run_currency_symbol_functions_tests=describe.delay("currency symbols",()=>{const t=Object.keys(currency_symbol_string_map).join(""),ee=Object.values(currency_symbol_string_map).join("");describe("hide_currency_symbols",()=>{let te="",ne="",oe="";te=`${t}90 ${t} / year`,ne=`${ee}90 ${ee} / year`,oe=hide_currency_symbols(te),test(oe,ne,"Convert currency symbols to ascii strings")}),describe("unhide_currency_symbols",()=>{let te="",ne="",oe="";te=`${ee}90 ${ee} / year`,ne=`${t}90 ${t} / year`,oe=unhide_currency_symbols(te),test(oe,ne,"Converts currency ascii strings back to symbols"),te="Currency_pound90 Currency_pound / year",ne="£90 £ / year",oe=unhide_currency_symbols(te),test(oe,ne,"Copes with Simulation.JS changing capitalisation of unit words")})}),run_normalise_calculation_ids_tests=describe.delay("normalise_calculation_ids",()=>{const t=uuid_v4_for_tests(1);let ee="",te="",ne="";ee="[A] + 3",te="[A] + 3",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Original square bracket IDs ignored"),ee="[A] + B",te="[A] + [B]",ne=normalise_calculation_ids(ee,[]);const oe="Skipping for now as auto wrapping in square brackets is error prone and invalidates a lot of the SimulationJS keywords, syntax, language constructs.";test.skip(ne,te,`${oe} Non square bracket id put into square brackets`),ee="A + [B]",te="[A] + [B]",ne=normalise_calculation_ids(ee,[]),test.skip(ne,te,`${oe} Beginning with non square bracket id put into square brackets`),ee="A-B",te="[A]-[B]",ne=normalise_calculation_ids(ee,[]),test.skip(ne,te,`${oe} Non square bracket ids with no spaces and a negation sign between are put into square brackets`),ee=`[A] + @@${t}`,te=`[A] + [${t}]`,ne=normalise_calculation_ids(ee,[t]),test(ne,te,"@@ uuid id put into square brackets"),ee="B + B",te="[B] + [B]",ne=normalise_calculation_ids(ee,[]),test.skip(ne,te,`${oe} Repeated non square bracket id dealt with correctly`),ee="sin(1) + B",te="sin(1) + [B]",ne=normalise_calculation_ids(ee,[]),test.skip(ne,te,`${oe} Simulation.js functions not processed into square brackets`),ee="A>B",te="[A]>[B]",ne=normalise_calculation_ids(ee,[]),test.skip(ne,te,`${oe} Simulation.js equality signs not processed into square brackets`),ee="[Some agent].FindAll([Some state]) + B",te="[Some agent].FindAll([Some state]) + [B]",ne=normalise_calculation_ids(ee,[]),test.skip(ne,te,`${oe} Simulation.js agent functions not processed into square brackets`),ee="[ Some variable ] + [ another variable ]",te="[ Some variable ] + [ another variable ]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Existing square bracket id with spaces is not altered"),ee="{4 miles} / {6.4e3 meters}",te="{4 miles} / {6.4e3 meters}",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Units inside curly braces are left unaltered"),ee="{7 Widgets/Years^2}",te="{7 Widgets/Years^2}",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Compound units and those raised to power inside curly braces are left unaltered"),ee=`{@@${t} meters}`,te=`{[${t}] meters}`,ne=normalise_calculation_ids(ee,[t]),test.skip(ne,te,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Double @ reference uuids and their units are preserved in curly braces~~"),ee=`x <- 2
    If x > 10 Then
      'Big'
    Else
      'Small'
    End If`,te=ee,ne=normalise_calculation_ids(ee,[]),test(ne,te,"Should not wrap variables, key words, or literal strings in square brackets")}),run_normalise_calculation_numbers_tests=describe.delay("normalise_calculation_numbers",()=>{const t=uuid_v4_for_tests(1);let ee="",te="",ne="";ee=`B + [A] @@${t} + 3.1 + {4.2 km}`,te=`B + [A] @@${t} + 3.1 + {4.2 km}`,ne=normalise_calculation_numbers(ee),test(ne,te,"Non and square bracket IDs, @@uuids, decimal numbers, and curly bracket numbers with units are left unchanged"),ee="3,200 + 1,800.0",te="3200 + 1800.0",ne=normalise_calculation_numbers(ee),test(ne,te,"Thousands commas are removed from numbers"),ee="3,20 + 1,80.0",te="3,20 + 1,80.0",ne=normalise_calculation_numbers(ee),test(ne,te,"Non-thousands commas are ignored"),ee="1,200,300 10,300,400 100,200,300",te="1200300 10300400 100200300",ne=normalise_calculation_numbers(ee),test(ne,te,"Thousands commas are removed from millions"),ee="1,200,300,400 10,200,300,400 100,200,300,400",te="1200300400 10200300400 100200300400",ne=normalise_calculation_numbers(ee),test(ne,te,"Thousands commas are removed from billions")}),run_perform_calculations_test=describe.delay("perform_calculations",()=>{let t=[],ee=[],te=[];describe("basic functionality",()=>{t=[];const _e={};te=[],ee=perform_calculations(t,_e),test(ee,te,"No calculations should return no results"),t=[{id:0,name:"A",value:"3"},{id:1,name:"B",value:"4"},{id:2,name:"C",value:"[A] + [B]"}],ee=perform_calculations(t,_e),te=[{value:3,units:""},{value:4,units:""},{value:7,units:""}],test(ee,te,"3 simple calculations should return 3 results"),t=[{id:0,name:"A",value:"3 + 1"},{id:1,name:"C",value:"[A] + [some_undeclared_variable]"},{id:2,name:"D",value:"5 + 1"}],ee=perform_calculations(t,_e),te=[{value:3+1,units:""},{value:void 0,error:"The primitive [some_undeclared_variable] could not be found.",units:""},{value:5+1,units:""}],test(ee,te,"Failure to find a value should still perform other valid calculations"),t=[{id:0,name:"A",value:"1 + 1"},{id:1,name:"A",value:"[A] * 2"},{id:2,name:"A",value:"[A] * 2"}],ee=perform_calculations(t,_e),te=[{value:1+1,units:""},{value:4,units:""},{value:8,units:""}],test(ee,te,"Can cope with self reference"),t=[{id:0,name:" A ",value:"1 + 1"},{id:1,name:"B",value:"[ A ] * 2"}],ee=perform_calculations(t,_e),te=[{value:1+1,units:""},{value:4,units:""}],test(ee,te,"Can cope with references with spaces")});const ne=uuid_v4_for_tests(1),oe=0;let ie;describe("Can use wcomponent values",()=>{ie=prepare_new_VAP_set(VAPsType.number,void 0,[],oe,{}),ie.entries[0].value="12.3";const _e=prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,title:"Some state component",type:"statev2",values_and_prediction_sets:[ie],units:"seconds"}),se={[ne]:_e};t=[{id:0,name:"A",value:`@@${ne}`,units:"meters"}],ee=perform_calculations(t,se),te=[{value:12.3,units:"seconds"}],test(ee,te,"Can access a wcomponent's value and overrides any units given in calculation with wcomponent's units"),t=[{id:0,name:"A",value:`@@${ne} * 10`,units:"meters"}],ee=perform_calculations(t,se),te=[{value:123,units:"meters"}],test(ee,te,"Can reference wcomponent values in a calculation and uses units given, overriding components units"),t=[{id:0,name:"A",value:`{@@${ne} meters}`}],ee=perform_calculations(t,se),te=[{value:12.3,units:"meters"}],test.skip(ee,te,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Calculations can reference wcomponent values and assign units~~"),t=[{id:0,name:"A",value:`@@${ne}.value`,units:"meters"}],ee=perform_calculations(t,se),te=[{value:void 0,units:"meters",error:"Object function not used on object"}],test(ee,te,'Can not currently access the ".value" of a component in an equation')}),describe("Can use wcomponent boolean values",()=>{ie=prepare_new_VAP_set(VAPsType.boolean,void 0,[],oe,{}),test(ie.entries[1].value_id,VALUE_POSSIBILITY_IDS.boolean_false,"Test is setting the correct VAP set entry"),ie.entries[1].probability=1;const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"statev2",subtype:"boolean",values_and_prediction_sets:[ie]})};t=[{id:0,name:"A",value:`IfThenElse(@@${ne}, 15, 10)`}],ee=perform_calculations(t,_e),te=[{value:10,units:""}],test(ee,te,"Can use wcomponent boolean values")}),describe("Can use values with units",()=>{t=[{id:0,name:"A",value:"{2 Meters} + {10 Centimeters}",units:"Meters"}],ee=perform_calculations(t,{}),te=[{value:2.1,units:"Meters"}],test(ee,te,"Computes correct value and includes units in result")}),describe("Can use values without units being initially defined",()=>{t=[{id:0,name:"A",value:"{2 Meters}"}],ee=perform_calculations(t,{}),te=[{value:2,units:"Meters"}],test(ee,te,"Computes correct units")}),describe("Can use values with units initially being undefined",()=>{t=[{id:0,name:"A",value:"{2 Meters}",units:void 0}],ee=perform_calculations(t,{}),te=[{value:2,units:"Meters"}],test(ee,te,"Computes correct units")}),describe("Does not compute units if some are already specified",()=>{t=[{id:0,name:"A",value:"{2 Meters}",units:"kg"}],ee=perform_calculations(t,{}),te=[{value:void 0,units:"kg",error:"Wrong units generated for [A]. Expected Kg, and got Meters."}],test(ee,te,"Computes correct units")}),describe(`Sets units to "" if 'Unitless' is specified`,()=>{t=[{id:0,name:"A",value:"2",units:"Unitless"}],ee=perform_calculations(t,{}),te=[{value:2,units:""}],test(ee,te,'Computes correct units of "" when "Unitless" is specified'),t=[{id:0,name:"A",value:"{2 Meters}",units:"Unitless"}],ee=perform_calculations(t,{}),te=[{value:void 0,units:"",error:"Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."}],test(ee,te,'Computes correct units of "" when "Unitless" is specified as the units even though it conflicts with units given in calculation')}),describe("Can process numbers with thousands comma seperators",()=>{t=[{id:0,name:"A",value:"1,200,300e4 / {4,001,000e3 km}",units:"1/km"}],ee=perform_calculations(t,{}),te=[{value:3,units:"1/km"}],test(ee,te,"Can compute numbers with thousands commas")}),describe("Can process numbers with compound units",()=>{t=[{id:0,name:"A",value:"{7 Widgets/Years^2}*{10 Years}",units:"Widgets/Years"}],ee=perform_calculations(t,{}),te=[{value:70,units:"Widgets/Years"}],test(ee,te,"Widgets/Years^2  *  Years")}),describe("hide_currency_symbols",()=>{t=[{id:0,name:"A",value:"{90 £ / year}",units:""},{id:1,name:"B",value:"{10 £ / year}",units:""},{id:2,name:"C",value:"[A]+[B]",units:""}],ee=perform_calculations(t,{}),te=[{value:90,units:"£/(Year)"},{value:10,units:"£/(Year)"},{value:100,units:"£/(Year)"}],test(ee,te,"Handles currency symbols specified inside curly braces"),t=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"£ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],ee=perform_calculations(t,{}),te=[{value:90,units:"£ / year"},{value:10,units:"£ / year"},{value:100,units:"£ / year"}],test(ee,te,"Handles currency symbols specified inside units field, and preserves them precisely"),t=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"$ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],ee=perform_calculations(t,{}),te=[{value:90,units:"£ / year"},{value:10,units:"$ / year"},{value:void 0,units:"£ / year",error:"Incompatible units for the addition of £/(Year) and $/(Year)."}],test(ee,te,"Correctly formats currency symbols in error messages")}),describe("Handles reserved words correctly",()=>{t=[{id:0,name:"A",value:"0.5 * (180 / Pi)"}],ee=perform_calculations(t,{}),te=[{value:28.6478897565412,units:""}],test(ee,te,'Can run calculations using reserved word "Pi"')}),describe("Defaults to 1 for missing or invalid or incomplete components",()=>{t=[{id:0,name:"A",value:`1 + @@${ne}`}],describe("Missing component",()=>{te=[{value:2,units:"",error:`Could not find wcomponent with id: @@${ne}.  Defaulting to value of 1.`}],ee=perform_calculations(t,{}),test(ee,te,"Can run calculations using missing uuids.  Will default to 1 and provide a warning.")}),describe("Invalid component: action type",()=>{te=[{value:2,units:"",warning:`The wcomponent @@${ne} is of type "action".  Defaulting to value of 1.`}];const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"action",values_and_prediction_sets:[]})};ee=perform_calculations(t,_e),test(ee,te,"Can run calculations using actions.  Will default to 1 and provide a warning.")}),describe("Invalid component: statev2 with subtype number but invalid number parsed to null",()=>{te=[{value:2,units:"",warning:`The wcomponent @@${ne} has an invalid number "".  Defaulting to value of 1.`}],ie=prepare_new_VAP_set(VAPsType.number,void 0,[],oe,{}),ie.entries[0].value="";const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"statev2",subtype:"number",values_and_prediction_sets:[ie]})};ee=perform_calculations(t,_e),test(ee,te,"Can run calculations using statev2 with invalid number of null.  Will default to 1 and provide a warning.")}),describe("Invalid component: statev2 with subtype number but invalid number parsed to NaN",()=>{te=[{value:2,units:"",warning:`The wcomponent @@${ne} has an invalid number "some invalid number".  Defaulting to value of 1.`}],ie=prepare_new_VAP_set(VAPsType.number,void 0,[],oe,{}),ie.entries[0].value="some invalid number";const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"statev2",subtype:"number",values_and_prediction_sets:[ie]})};ee=perform_calculations(t,_e),test(ee,te,"Can run calculations using statev2 with invalid number of NaN.  Will default to 1 and provide a warning.")}),describe("Incomplete component: statev2 type with no VAP sets",()=>{te=[{value:2,units:"",warning:`The wcomponent @@${ne} is missing any value and prediction sets.  Defaulting to value of 1.`}];const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"statev2",values_and_prediction_sets:[]})};ee=perform_calculations(t,_e),test(ee,te,"Can run calculations using statev2 with no VAPsets.  Will default to 1 and provide a warning.")})}),describe("Coerces statev2 wcomponents with boolean subtype into 0 or 1",()=>{t=[{id:0,name:"A",value:`1 + @@${ne}`}],describe("coerces true to 1",()=>{te=[{value:2,units:""}],ie=prepare_new_VAP_set(VAPsType.boolean,void 0,[],oe,{}),test(ie.entries[0].value_id,VALUE_POSSIBILITY_IDS.boolean_true,"Test is setting the correct VAP set entry"),ie.entries[0].probability=1;const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"statev2",subtype:"boolean",values_and_prediction_sets:[ie]})};ee=perform_calculations(t,_e),test(ee,te,"Can run calculations using statev2 boolean subtypes.  Will coerce true to 1 and not provide a warning.")}),describe("coerces false to 0",()=>{te=[{value:1,units:""}],ie=prepare_new_VAP_set(VAPsType.boolean,void 0,[],oe,{}),test(ie.entries[1].value_id,VALUE_POSSIBILITY_IDS.boolean_false,"Test is setting the correct VAP set entry"),ie.entries[1].probability=1;const _e={[ne]:prepare_new_contextless_wcomponent_object({base_id:oe,id:ne,type:"statev2",subtype:"boolean",values_and_prediction_sets:[ie]})};ee=perform_calculations(t,_e),test(ee,te,"Can run calculations using statev2 boolean subtypes.  Will coerce false to 0 and not provide a warning.")})})});function get_angle_from_start_connector(t,ee){const te=angle_of_normal_to_connection_with_direction[ee];return t+=1e-4,get_angle_from_connector({connection_angle:t,angle_of_normal_to_connector_surface:te,offset_direction:-1})}function get_angle_from_end_connector(t,ee){const te=angle_of_normal_to_connection_with_direction[ee];return t+=Math.PI,get_angle_from_connector({connection_angle:t,angle_of_normal_to_connector_surface:te,offset_direction:1})}const angle_of_normal_to_connection_location={left:rads._180,top:rads._90,right:0,bottom:-rads._90},angle_of_normal_to_connection_with_direction={right:angle_of_normal_to_connection_location.right,left:angle_of_normal_to_connection_location.left},max_connection_angle_from_normal=rads._50;function get_angle_from_connector(t){const ee=normalise_angle_between_neg_Pi_and_Pi(t.connection_angle-t.angle_of_normal_to_connector_surface),ne=bounded(ee,-max_connection_angle_from_normal,max_connection_angle_from_normal);return bounded(ne,-max_connection_angle_from_normal,max_connection_angle_from_normal)+t.angle_of_normal_to_connector_surface}const test_get_angle=describe.skip("get_angle (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{const te=[{ex:10,ey:0},{ex:10,ey:-10},{ex:0,ey:-10},{ex:-10,ey:-10},{ex:-10,ey:0},{ex:-10,ey:10},{ex:0,ey:10},{ex:10,ey:10}],ne=["0.00","-0.79","-1.57","-2.36","3.14","2.36","1.57","0.79"];te.forEach(({ex:_e,ey:se},re)=>{const ae=get_angle(0,0,_e,se).toFixed(2);test(ae,ne[re])});const oe=["-0.79","-0.87","-0.87","-0.87","0.09","0.09","0.09","0.00"];te.forEach(({ex:_e,ey:se},re)=>{const ae=get_angle(0,0,_e,se),ce=get_angle_from_start_connector(ae,"right").toFixed(2);test(ce,oe[re])});const ie=["3.93","3.14","3.05","3.05","4.01","4.01","4.01","4.01"];te.forEach(({ex:_e,ey:se},re)=>{const ae=get_angle(0,0,_e,se),ce=get_angle_from_end_connector(ae,"left").toFixed(2);test(ce,ie[re])})}),test_derive_connection_coords=describe.delay("derive_connection_coords",()=>{let t,ee;describe("connection between two nodes",()=>{t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component.kv_wc_entry={top:0,left:NODE_WIDTH+100},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:349,line_end_y:-77,connection_end_x:350,connection_end_y:-77,end_angle:3.142},`two nodes not overlapping horizontally
                    [from]----->[to]`),t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component.kv_wc_entry={top:0,left:NODE_WIDTH+10},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:130,y:0},relative_control_point2:{x:130,y:0},line_end_x:511,line_end_y:-47,connection_end_x:510,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other:
                    [from] [to]`),t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component.kv_wc_entry={top:0,left:NODE_WIDTH-10},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:120,y:0},relative_control_point2:{x:120,y:0},line_end_x:491,line_end_y:-47,connection_end_x:490,connection_end_y:-47,end_angle:0},`two nodes overlapping horizontally
                    [fr.[to]`),t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component.kv_wc_entry={top:0,left:-10},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:241,line_end_y:-47,connection_end_x:240,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other in the other direction
                    [to] [from]`),t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component.kv_wc_entry={top:0,left:-50},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:201,line_end_y:-47,connection_end_x:200,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally and far from each other in the other direction
                    [to]<-----[from]`),describe("of different sizes",()=>{t=test_helper__get_args();const ne=2,oe=NODE_WIDTH*ne,ie=NODE_WIDTH+110,se=NODE_WIDTH*1;t.connection_from_component.kv_wc_entry={top:0,left:0,s:ne},t.connection_to_component.kv_wc_entry={top:0,left:ie},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:oe,line_start_y:-160,relative_control_point1:{x:55,y:0},relative_control_point2:{x:55,y:0},line_end_x:ie+se+1,line_end_y:-47,connection_end_x:ie+se,connection_end_y:-47,end_angle:0},`two nodes that if of same size would not overlap horizontally,
                        [from]----->[to]
                but one is bigger so they do overlap
                        [F R O M]
                             [to ]
            `)})}),t=test_helper__get_args(),t.connection_to_component=t.connection_from_component,ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:NODE_WIDTH,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:NODE_WIDTH+1,line_end_y:-47,connection_end_x:NODE_WIDTH,connection_end_y:-47,end_angle:0},"connection from a node back to itself"),t=test_helper__get_args(),t.end_size=0;let te=[];t.console_warn=(...ne)=>te=ne,derive_connection_coords(t),test(te,['Invalid connection end_size "0", defaulting to 1'],"Should log a warning message about invalid end_size: 0,"),describe("connection between nothing and a node",()=>{t=test_helper__get_args(),t.connection_from_component=void 0,t.connection_to_component.kv_wc_entry={top:0,left:0},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:-150,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"straight line from nothing to one node"),t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component=void 0,ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:399,line_end_y:-77,connection_end_x:400,connection_end_y:-77,end_angle:3.142},"straight line from one node to nothing")}),describe("connection between a node and a connection",()=>{t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component={kv_wc_entry:{top:0,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:0,connection_end_x:-100,connection_end_y:0,end_angle:0},"connect from one node to a second connection"),t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_to_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:200,connection_end_x:-100,connection_end_y:200,end_angle:0},"connect from one node to a second connection above and left"),t=test_helper__get_args(),t.connection_from_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"right",attribute:"state"}},t.connection_to_component.kv_wc_entry={top:0,left:0},ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:-100,line_start_y:200,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"connect from a second connection above and left to a node")}),describe("angular connections",()=>{t=test_helper__get_args(),t.connection_from_component.kv_wc_entry={top:0,left:0},t.connection_from_component.wcomponent_type="causal_link",t.connection_to_component.kv_wc_entry={top:200,left:100},t.line_behaviour=ConnectionLineBehaviour.angular,ee=derive_connection_coords(t),test(test_helper__round_derived_connection_coords(ee),{line_start_x:0,line_start_y:0,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:100+HALF_NODE_WIDTH,line_end_y:-200,connection_end_x:100+HALF_NODE_WIDTH,connection_end_y:-200,end_angle:3.142/2},"connect from a connection above to a node below")})});function test_helper__get_args(){return{connection_from_component:{kv_wc_entry:{top:0,left:0},wcomponent_type:"statev2",connection_terminal_type:{side:"right",attribute:"state"}},connection_to_component:{kv_wc_entry:{top:0,left:NODE_WIDTH+100},wcomponent_type:"statev2",connection_terminal_type:{side:"left",attribute:"state"}},line_behaviour:void 0,circular_links:!0,end_size:1,connection_end_type:ConnectionEndType.positive}}function test_helper__round_derived_connection_coords(t){return t?{line_start_x:round_to_max_significant_figures(t.line_start_x,2),line_start_y:round_to_max_significant_figures(t.line_start_y,2),relative_control_point1:{x:round_to_max_significant_figures(t.relative_control_point1.x,2),y:round_to_max_significant_figures(t.relative_control_point1.y,2)},relative_control_point2:{x:round_to_max_significant_figures(t.relative_control_point2.x,2),y:round_to_max_significant_figures(t.relative_control_point2.y,2)},line_end_x:round_to_max_significant_figures(t.line_end_x,3),line_end_y:round_to_max_significant_figures(t.line_end_y,3),connection_end_x:round_to_max_significant_figures(t.connection_end_x,3),connection_end_y:round_to_max_significant_figures(t.connection_end_y,3),end_angle:round_to_max_significant_figures(t.end_angle,4)}:null}const test_correct_datetime_for_local_time_zone=describe.delay("correct_datetime_for_local_time_zone",()=>{let t;t=correct_datetime_for_local_time_zone("2021-04-16 15:00"),test(t&&t.toISOString(),"2021-04-16T14:00:00.000Z","Subtracts one hour (as datetime is during summer time BST; and also passes when test is performed during GMT)"),t=correct_datetime_for_local_time_zone("2021-04-16 00:00"),test(t&&t.toISOString(),"2021-04-15T23:00:00.000Z","Subtracts one hour, goes back one day (as datetime is during summer time BST; and also passes when test is performed during GMT)"),t=correct_datetime_for_local_time_zone("2021-04-16"),test.skip(t&&t.toISOString(),"2021-04-15T23:00:00.000Z","")}),run_number_to_significant_figures_test=describe.delay("run_number_to_significant_figures_test",()=>{let t="";t=format_number_to_significant_figures(0,2),test(t,"0","Zero"),describe("Positive numbers",()=>{t=format_number_to_significant_figures(27e5,2),test(t,"2700000","2.7 million to 2 sf"),t=format_number_to_significant_figures(27e6,2),test(t,"27000000","27 million to 2 sf"),t=format_number_to_significant_figures(27e7,2),test(t,"270000000","270 million to 2 sf"),t=format_number_to_significant_figures(2700000002e-1,2),test(t,"270000000","270.2 million to 2 sf")}),describe("Positive with decimals numbers",()=>{t=format_number_to_significant_figures(27,5),test(t,"27.000","27 to 5 sf"),t=format_number_to_significant_figures(2700000002e-1,10),test(t,"270000000.2","270.2 million to 10 sf"),t=format_number_to_significant_figures(2700000002e-1,11),test(t,"270000000.20","270.2 million to 11 sf")}),describe("Negative numbers",()=>{t=format_number_to_significant_figures(-27,5),test(t,"-27.000","-27 to 5 sf"),t=format_number_to_significant_figures(-2700000002e-1,11),test(t,"-270000000.20","-270.2 million to 11 sf"),t=format_number_to_significant_figures(-2700000002e-1,2),test(t,"-270000000","-270.2 million to 2 sf")}),describe("Small numbers",()=>{t=format_number_to_significant_figures(1236e-7,3),test(t,"0.000124","0.0001236 to 3 sf"),t=format_number_to_significant_figures(1236e-7,5),test(t,"0.00012360","0.0001236 to 5 sf"),t=format_number_to_significant_figures(-1236e-7,3),test(t,"-0.000124","-0.0001236 to 3 sf"),t=format_number_to_significant_figures(-1236e-7,5),test(t,"-0.00012360","-0.0001236 to 5 sf")}),describe("Floating point precision numbers",()=>{t=format_number_to_significant_figures(.01264,2),test(t,"0.013","0.01264 to 2 sf, tests when floating point precision results in 0.013000000000000001"),t=format_number_to_significant_figures(17.955*100,7),test(t,"1795.500","17.955*100 to 7 sf, tests when floating point precision results in 1795.4999999999998")})}),run_number_to_string_test=describe.delay("run_number_to_string_test",()=>{let t="";t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.bare),test(t,"1300","bare number"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.simple),test(t,"1,300","simple number"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"1.3 thousand","scaled number"),t=format_number_to_string(.1264,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"13%","number as percentage"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"1.3 k","abbreviated scaled number"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1.3e3","scientific number"),t=format_number_to_string(.1264,-.2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1e-1","Copes with significant_figures that are fractional and or < 1"),t=format_number_to_string(27e6,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"27 million","27 million"),t=format_number_to_string(27e7,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"270 million","270 million"),t=format_number_to_string(27e8,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"2.7 billion","2.7 billion"),describe("negative numbers",()=>{t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.bare),test(t,"-1300","bare number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.simple),test(t,"-1,300","simple number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"-1.3 thousand","scaled number"),t=format_number_to_string(-.1264,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"-13%","percentage number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"-1.3 k","abbreviated scaled number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"-1.3e3","scientific number")}),describe("less than 1 numbers",()=>{t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.bare),test(t,"0.0013","bare number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.simple),test(t,"0.0013","simple number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"0.0013","scaled number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"0.13%","percentage number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"0.0013","abbreviated scaled number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1.3e-3","scientific number"),t=format_number_to_string(-.001264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"-1.3e-3","0> num >-1 scientific number")}),describe("no unnecessary significant figures",()=>{t=format_number_to_string(1,2,NUMBER_DISPLAY_TYPES.bare),test(t,"1","bare number"),t=format_number_to_string(1,2,NUMBER_DISPLAY_TYPES.simple),test(t,"1","simple number"),t=format_number_to_string(1e3,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"1 thousand","scaled number"),t=format_number_to_string(10,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"1000%","percentage number"),t=format_number_to_string(1e3,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"1 k","abbreviated scaled number"),t=format_number_to_string(1e3,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1e3","scientific number")}),describe("handles 0",()=>{t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.bare),test(t,"0","bare number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.simple),test(t,"0","simple number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"0","scaled number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"0%","percentage number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"0","abbreviated scaled number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"0e0","scientific number")})});var _listCacheClear,hasRequired_listCacheClear;function require_listCacheClear(){if(hasRequired_listCacheClear)return _listCacheClear;hasRequired_listCacheClear=1;function t(){this.__data__=[],this.size=0}return _listCacheClear=t,_listCacheClear}var eq_1,hasRequiredEq;function requireEq(){if(hasRequiredEq)return eq_1;hasRequiredEq=1;function t(ee,te){return ee===te||ee!==ee&&te!==te}return eq_1=t,eq_1}var _assocIndexOf,hasRequired_assocIndexOf;function require_assocIndexOf(){if(hasRequired_assocIndexOf)return _assocIndexOf;hasRequired_assocIndexOf=1;var t=requireEq();function ee(te,ne){for(var oe=te.length;oe--;)if(t(te[oe][0],ne))return oe;return-1}return _assocIndexOf=ee,_assocIndexOf}var _listCacheDelete,hasRequired_listCacheDelete;function require_listCacheDelete(){if(hasRequired_listCacheDelete)return _listCacheDelete;hasRequired_listCacheDelete=1;var t=require_assocIndexOf(),ee=Array.prototype,te=ee.splice;function ne(oe){var ie=this.__data__,_e=t(ie,oe);if(_e<0)return!1;var se=ie.length-1;return _e==se?ie.pop():te.call(ie,_e,1),--this.size,!0}return _listCacheDelete=ne,_listCacheDelete}var _listCacheGet,hasRequired_listCacheGet;function require_listCacheGet(){if(hasRequired_listCacheGet)return _listCacheGet;hasRequired_listCacheGet=1;var t=require_assocIndexOf();function ee(te){var ne=this.__data__,oe=t(ne,te);return oe<0?void 0:ne[oe][1]}return _listCacheGet=ee,_listCacheGet}var _listCacheHas,hasRequired_listCacheHas;function require_listCacheHas(){if(hasRequired_listCacheHas)return _listCacheHas;hasRequired_listCacheHas=1;var t=require_assocIndexOf();function ee(te){return t(this.__data__,te)>-1}return _listCacheHas=ee,_listCacheHas}var _listCacheSet,hasRequired_listCacheSet;function require_listCacheSet(){if(hasRequired_listCacheSet)return _listCacheSet;hasRequired_listCacheSet=1;var t=require_assocIndexOf();function ee(te,ne){var oe=this.__data__,ie=t(oe,te);return ie<0?(++this.size,oe.push([te,ne])):oe[ie][1]=ne,this}return _listCacheSet=ee,_listCacheSet}var _ListCache,hasRequired_ListCache;function require_ListCache(){if(hasRequired_ListCache)return _ListCache;hasRequired_ListCache=1;var t=require_listCacheClear(),ee=require_listCacheDelete(),te=require_listCacheGet(),ne=require_listCacheHas(),oe=require_listCacheSet();function ie(_e){var se=-1,re=_e==null?0:_e.length;for(this.clear();++se<re;){var ae=_e[se];this.set(ae[0],ae[1])}}return ie.prototype.clear=t,ie.prototype.delete=ee,ie.prototype.get=te,ie.prototype.has=ne,ie.prototype.set=oe,_ListCache=ie,_ListCache}var _stackClear,hasRequired_stackClear;function require_stackClear(){if(hasRequired_stackClear)return _stackClear;hasRequired_stackClear=1;var t=require_ListCache();function ee(){this.__data__=new t,this.size=0}return _stackClear=ee,_stackClear}var _stackDelete,hasRequired_stackDelete;function require_stackDelete(){if(hasRequired_stackDelete)return _stackDelete;hasRequired_stackDelete=1;function t(ee){var te=this.__data__,ne=te.delete(ee);return this.size=te.size,ne}return _stackDelete=t,_stackDelete}var _stackGet,hasRequired_stackGet;function require_stackGet(){if(hasRequired_stackGet)return _stackGet;hasRequired_stackGet=1;function t(ee){return this.__data__.get(ee)}return _stackGet=t,_stackGet}var _stackHas,hasRequired_stackHas;function require_stackHas(){if(hasRequired_stackHas)return _stackHas;hasRequired_stackHas=1;function t(ee){return this.__data__.has(ee)}return _stackHas=t,_stackHas}var _freeGlobal,hasRequired_freeGlobal;function require_freeGlobal(){if(hasRequired_freeGlobal)return _freeGlobal;hasRequired_freeGlobal=1;var t=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal;return _freeGlobal=t,_freeGlobal}var _root,hasRequired_root;function require_root(){if(hasRequired_root)return _root;hasRequired_root=1;var t=require_freeGlobal(),ee=typeof self=="object"&&self&&self.Object===Object&&self,te=t||ee||Function("return this")();return _root=te,_root}var _Symbol,hasRequired_Symbol;function require_Symbol(){if(hasRequired_Symbol)return _Symbol;hasRequired_Symbol=1;var t=require_root(),ee=t.Symbol;return _Symbol=ee,_Symbol}var _getRawTag,hasRequired_getRawTag;function require_getRawTag(){if(hasRequired_getRawTag)return _getRawTag;hasRequired_getRawTag=1;var t=require_Symbol(),ee=Object.prototype,te=ee.hasOwnProperty,ne=ee.toString,oe=t?t.toStringTag:void 0;function ie(_e){var se=te.call(_e,oe),re=_e[oe];try{_e[oe]=void 0;var ae=!0}catch{}var ce=ne.call(_e);return ae&&(se?_e[oe]=re:delete _e[oe]),ce}return _getRawTag=ie,_getRawTag}var _objectToString,hasRequired_objectToString;function require_objectToString(){if(hasRequired_objectToString)return _objectToString;hasRequired_objectToString=1;var t=Object.prototype,ee=t.toString;function te(ne){return ee.call(ne)}return _objectToString=te,_objectToString}var _baseGetTag,hasRequired_baseGetTag;function require_baseGetTag(){if(hasRequired_baseGetTag)return _baseGetTag;hasRequired_baseGetTag=1;var t=require_Symbol(),ee=require_getRawTag(),te=require_objectToString(),ne="[object Null]",oe="[object Undefined]",ie=t?t.toStringTag:void 0;function _e(se){return se==null?se===void 0?oe:ne:ie&&ie in Object(se)?ee(se):te(se)}return _baseGetTag=_e,_baseGetTag}var isObject_1,hasRequiredIsObject;function requireIsObject(){if(hasRequiredIsObject)return isObject_1;hasRequiredIsObject=1;function t(ee){var te=typeof ee;return ee!=null&&(te=="object"||te=="function")}return isObject_1=t,isObject_1}var isFunction_1,hasRequiredIsFunction;function requireIsFunction(){if(hasRequiredIsFunction)return isFunction_1;hasRequiredIsFunction=1;var t=require_baseGetTag(),ee=requireIsObject(),te="[object AsyncFunction]",ne="[object Function]",oe="[object GeneratorFunction]",ie="[object Proxy]";function _e(se){if(!ee(se))return!1;var re=t(se);return re==ne||re==oe||re==te||re==ie}return isFunction_1=_e,isFunction_1}var _coreJsData,hasRequired_coreJsData;function require_coreJsData(){if(hasRequired_coreJsData)return _coreJsData;hasRequired_coreJsData=1;var t=require_root(),ee=t["__core-js_shared__"];return _coreJsData=ee,_coreJsData}var _isMasked,hasRequired_isMasked;function require_isMasked(){if(hasRequired_isMasked)return _isMasked;hasRequired_isMasked=1;var t=require_coreJsData(),ee=function(){var ne=/[^.]+$/.exec(t&&t.keys&&t.keys.IE_PROTO||"");return ne?"Symbol(src)_1."+ne:""}();function te(ne){return!!ee&&ee in ne}return _isMasked=te,_isMasked}var _toSource,hasRequired_toSource;function require_toSource(){if(hasRequired_toSource)return _toSource;hasRequired_toSource=1;var t=Function.prototype,ee=t.toString;function te(ne){if(ne!=null){try{return ee.call(ne)}catch{}try{return ne+""}catch{}}return""}return _toSource=te,_toSource}var _baseIsNative,hasRequired_baseIsNative;function require_baseIsNative(){if(hasRequired_baseIsNative)return _baseIsNative;hasRequired_baseIsNative=1;var t=requireIsFunction(),ee=require_isMasked(),te=requireIsObject(),ne=require_toSource(),oe=/[\\^$.*+?()[\]{}|]/g,ie=/^\[object .+?Constructor\]$/,_e=Function.prototype,se=Object.prototype,re=_e.toString,ae=se.hasOwnProperty,ce=RegExp("^"+re.call(ae).replace(oe,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function de(ue){if(!te(ue)||ee(ue))return!1;var le=t(ue)?ce:ie;return le.test(ne(ue))}return _baseIsNative=de,_baseIsNative}var _getValue,hasRequired_getValue;function require_getValue(){if(hasRequired_getValue)return _getValue;hasRequired_getValue=1;function t(ee,te){return ee==null?void 0:ee[te]}return _getValue=t,_getValue}var _getNative,hasRequired_getNative;function require_getNative(){if(hasRequired_getNative)return _getNative;hasRequired_getNative=1;var t=require_baseIsNative(),ee=require_getValue();function te(ne,oe){var ie=ee(ne,oe);return t(ie)?ie:void 0}return _getNative=te,_getNative}var _Map,hasRequired_Map;function require_Map(){if(hasRequired_Map)return _Map;hasRequired_Map=1;var t=require_getNative(),ee=require_root(),te=t(ee,"Map");return _Map=te,_Map}var _nativeCreate,hasRequired_nativeCreate;function require_nativeCreate(){if(hasRequired_nativeCreate)return _nativeCreate;hasRequired_nativeCreate=1;var t=require_getNative(),ee=t(Object,"create");return _nativeCreate=ee,_nativeCreate}var _hashClear,hasRequired_hashClear;function require_hashClear(){if(hasRequired_hashClear)return _hashClear;hasRequired_hashClear=1;var t=require_nativeCreate();function ee(){this.__data__=t?t(null):{},this.size=0}return _hashClear=ee,_hashClear}var _hashDelete,hasRequired_hashDelete;function require_hashDelete(){if(hasRequired_hashDelete)return _hashDelete;hasRequired_hashDelete=1;function t(ee){var te=this.has(ee)&&delete this.__data__[ee];return this.size-=te?1:0,te}return _hashDelete=t,_hashDelete}var _hashGet,hasRequired_hashGet;function require_hashGet(){if(hasRequired_hashGet)return _hashGet;hasRequired_hashGet=1;var t=require_nativeCreate(),ee="__lodash_hash_undefined__",te=Object.prototype,ne=te.hasOwnProperty;function oe(ie){var _e=this.__data__;if(t){var se=_e[ie];return se===ee?void 0:se}return ne.call(_e,ie)?_e[ie]:void 0}return _hashGet=oe,_hashGet}var _hashHas,hasRequired_hashHas;function require_hashHas(){if(hasRequired_hashHas)return _hashHas;hasRequired_hashHas=1;var t=require_nativeCreate(),ee=Object.prototype,te=ee.hasOwnProperty;function ne(oe){var ie=this.__data__;return t?ie[oe]!==void 0:te.call(ie,oe)}return _hashHas=ne,_hashHas}var _hashSet,hasRequired_hashSet;function require_hashSet(){if(hasRequired_hashSet)return _hashSet;hasRequired_hashSet=1;var t=require_nativeCreate(),ee="__lodash_hash_undefined__";function te(ne,oe){var ie=this.__data__;return this.size+=this.has(ne)?0:1,ie[ne]=t&&oe===void 0?ee:oe,this}return _hashSet=te,_hashSet}var _Hash,hasRequired_Hash;function require_Hash(){if(hasRequired_Hash)return _Hash;hasRequired_Hash=1;var t=require_hashClear(),ee=require_hashDelete(),te=require_hashGet(),ne=require_hashHas(),oe=require_hashSet();function ie(_e){var se=-1,re=_e==null?0:_e.length;for(this.clear();++se<re;){var ae=_e[se];this.set(ae[0],ae[1])}}return ie.prototype.clear=t,ie.prototype.delete=ee,ie.prototype.get=te,ie.prototype.has=ne,ie.prototype.set=oe,_Hash=ie,_Hash}var _mapCacheClear,hasRequired_mapCacheClear;function require_mapCacheClear(){if(hasRequired_mapCacheClear)return _mapCacheClear;hasRequired_mapCacheClear=1;var t=require_Hash(),ee=require_ListCache(),te=require_Map();function ne(){this.size=0,this.__data__={hash:new t,map:new(te||ee),string:new t}}return _mapCacheClear=ne,_mapCacheClear}var _isKeyable,hasRequired_isKeyable;function require_isKeyable(){if(hasRequired_isKeyable)return _isKeyable;hasRequired_isKeyable=1;function t(ee){var te=typeof ee;return te=="string"||te=="number"||te=="symbol"||te=="boolean"?ee!=="__proto__":ee===null}return _isKeyable=t,_isKeyable}var _getMapData,hasRequired_getMapData;function require_getMapData(){if(hasRequired_getMapData)return _getMapData;hasRequired_getMapData=1;var t=require_isKeyable();function ee(te,ne){var oe=te.__data__;return t(ne)?oe[typeof ne=="string"?"string":"hash"]:oe.map}return _getMapData=ee,_getMapData}var _mapCacheDelete,hasRequired_mapCacheDelete;function require_mapCacheDelete(){if(hasRequired_mapCacheDelete)return _mapCacheDelete;hasRequired_mapCacheDelete=1;var t=require_getMapData();function ee(te){var ne=t(this,te).delete(te);return this.size-=ne?1:0,ne}return _mapCacheDelete=ee,_mapCacheDelete}var _mapCacheGet,hasRequired_mapCacheGet;function require_mapCacheGet(){if(hasRequired_mapCacheGet)return _mapCacheGet;hasRequired_mapCacheGet=1;var t=require_getMapData();function ee(te){return t(this,te).get(te)}return _mapCacheGet=ee,_mapCacheGet}var _mapCacheHas,hasRequired_mapCacheHas;function require_mapCacheHas(){if(hasRequired_mapCacheHas)return _mapCacheHas;hasRequired_mapCacheHas=1;var t=require_getMapData();function ee(te){return t(this,te).has(te)}return _mapCacheHas=ee,_mapCacheHas}var _mapCacheSet,hasRequired_mapCacheSet;function require_mapCacheSet(){if(hasRequired_mapCacheSet)return _mapCacheSet;hasRequired_mapCacheSet=1;var t=require_getMapData();function ee(te,ne){var oe=t(this,te),ie=oe.size;return oe.set(te,ne),this.size+=oe.size==ie?0:1,this}return _mapCacheSet=ee,_mapCacheSet}var _MapCache,hasRequired_MapCache;function require_MapCache(){if(hasRequired_MapCache)return _MapCache;hasRequired_MapCache=1;var t=require_mapCacheClear(),ee=require_mapCacheDelete(),te=require_mapCacheGet(),ne=require_mapCacheHas(),oe=require_mapCacheSet();function ie(_e){var se=-1,re=_e==null?0:_e.length;for(this.clear();++se<re;){var ae=_e[se];this.set(ae[0],ae[1])}}return ie.prototype.clear=t,ie.prototype.delete=ee,ie.prototype.get=te,ie.prototype.has=ne,ie.prototype.set=oe,_MapCache=ie,_MapCache}var _stackSet,hasRequired_stackSet;function require_stackSet(){if(hasRequired_stackSet)return _stackSet;hasRequired_stackSet=1;var t=require_ListCache(),ee=require_Map(),te=require_MapCache(),ne=200;function oe(ie,_e){var se=this.__data__;if(se instanceof t){var re=se.__data__;if(!ee||re.length<ne-1)return re.push([ie,_e]),this.size=++se.size,this;se=this.__data__=new te(re)}return se.set(ie,_e),this.size=se.size,this}return _stackSet=oe,_stackSet}var _Stack,hasRequired_Stack;function require_Stack(){if(hasRequired_Stack)return _Stack;hasRequired_Stack=1;var t=require_ListCache(),ee=require_stackClear(),te=require_stackDelete(),ne=require_stackGet(),oe=require_stackHas(),ie=require_stackSet();function _e(se){var re=this.__data__=new t(se);this.size=re.size}return _e.prototype.clear=ee,_e.prototype.delete=te,_e.prototype.get=ne,_e.prototype.has=oe,_e.prototype.set=ie,_Stack=_e,_Stack}var _arrayEach,hasRequired_arrayEach;function require_arrayEach(){if(hasRequired_arrayEach)return _arrayEach;hasRequired_arrayEach=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length;++ne<oe&&te(ee[ne],ne,ee)!==!1;);return ee}return _arrayEach=t,_arrayEach}var _defineProperty,hasRequired_defineProperty;function require_defineProperty(){if(hasRequired_defineProperty)return _defineProperty;hasRequired_defineProperty=1;var t=require_getNative(),ee=function(){try{var te=t(Object,"defineProperty");return te({},"",{}),te}catch{}}();return _defineProperty=ee,_defineProperty}var _baseAssignValue,hasRequired_baseAssignValue;function require_baseAssignValue(){if(hasRequired_baseAssignValue)return _baseAssignValue;hasRequired_baseAssignValue=1;var t=require_defineProperty();function ee(te,ne,oe){ne=="__proto__"&&t?t(te,ne,{configurable:!0,enumerable:!0,value:oe,writable:!0}):te[ne]=oe}return _baseAssignValue=ee,_baseAssignValue}var _assignValue,hasRequired_assignValue;function require_assignValue(){if(hasRequired_assignValue)return _assignValue;hasRequired_assignValue=1;var t=require_baseAssignValue(),ee=requireEq(),te=Object.prototype,ne=te.hasOwnProperty;function oe(ie,_e,se){var re=ie[_e];(!(ne.call(ie,_e)&&ee(re,se))||se===void 0&&!(_e in ie))&&t(ie,_e,se)}return _assignValue=oe,_assignValue}var _copyObject,hasRequired_copyObject;function require_copyObject(){if(hasRequired_copyObject)return _copyObject;hasRequired_copyObject=1;var t=require_assignValue(),ee=require_baseAssignValue();function te(ne,oe,ie,_e){var se=!ie;ie||(ie={});for(var re=-1,ae=oe.length;++re<ae;){var ce=oe[re],de=_e?_e(ie[ce],ne[ce],ce,ie,ne):void 0;de===void 0&&(de=ne[ce]),se?ee(ie,ce,de):t(ie,ce,de)}return ie}return _copyObject=te,_copyObject}var _baseTimes,hasRequired_baseTimes;function require_baseTimes(){if(hasRequired_baseTimes)return _baseTimes;hasRequired_baseTimes=1;function t(ee,te){for(var ne=-1,oe=Array(ee);++ne<ee;)oe[ne]=te(ne);return oe}return _baseTimes=t,_baseTimes}var isObjectLike_1,hasRequiredIsObjectLike;function requireIsObjectLike(){if(hasRequiredIsObjectLike)return isObjectLike_1;hasRequiredIsObjectLike=1;function t(ee){return ee!=null&&typeof ee=="object"}return isObjectLike_1=t,isObjectLike_1}var _baseIsArguments,hasRequired_baseIsArguments;function require_baseIsArguments(){if(hasRequired_baseIsArguments)return _baseIsArguments;hasRequired_baseIsArguments=1;var t=require_baseGetTag(),ee=requireIsObjectLike(),te="[object Arguments]";function ne(oe){return ee(oe)&&t(oe)==te}return _baseIsArguments=ne,_baseIsArguments}var isArguments_1,hasRequiredIsArguments;function requireIsArguments(){if(hasRequiredIsArguments)return isArguments_1;hasRequiredIsArguments=1;var t=require_baseIsArguments(),ee=requireIsObjectLike(),te=Object.prototype,ne=te.hasOwnProperty,oe=te.propertyIsEnumerable,ie=t(function(){return arguments}())?t:function(_e){return ee(_e)&&ne.call(_e,"callee")&&!oe.call(_e,"callee")};return isArguments_1=ie,isArguments_1}var isArray_1,hasRequiredIsArray;function requireIsArray(){if(hasRequiredIsArray)return isArray_1;hasRequiredIsArray=1;var t=Array.isArray;return isArray_1=t,isArray_1}var isBuffer={exports:{}},stubFalse_1,hasRequiredStubFalse;function requireStubFalse(){if(hasRequiredStubFalse)return stubFalse_1;hasRequiredStubFalse=1;function t(){return!1}return stubFalse_1=t,stubFalse_1}isBuffer.exports;var hasRequiredIsBuffer;function requireIsBuffer(){return hasRequiredIsBuffer||(hasRequiredIsBuffer=1,function(t,ee){var te=require_root(),ne=requireStubFalse(),oe=ee&&!ee.nodeType&&ee,ie=oe&&!0&&t&&!t.nodeType&&t,_e=ie&&ie.exports===oe,se=_e?te.Buffer:void 0,re=se?se.isBuffer:void 0,ae=re||ne;t.exports=ae}(isBuffer,isBuffer.exports)),isBuffer.exports}var _isIndex,hasRequired_isIndex;function require_isIndex(){if(hasRequired_isIndex)return _isIndex;hasRequired_isIndex=1;var t=9007199254740991,ee=/^(?:0|[1-9]\d*)$/;function te(ne,oe){var ie=typeof ne;return oe=oe??t,!!oe&&(ie=="number"||ie!="symbol"&&ee.test(ne))&&ne>-1&&ne%1==0&&ne<oe}return _isIndex=te,_isIndex}var isLength_1,hasRequiredIsLength;function requireIsLength(){if(hasRequiredIsLength)return isLength_1;hasRequiredIsLength=1;var t=9007199254740991;function ee(te){return typeof te=="number"&&te>-1&&te%1==0&&te<=t}return isLength_1=ee,isLength_1}var _baseIsTypedArray,hasRequired_baseIsTypedArray;function require_baseIsTypedArray(){if(hasRequired_baseIsTypedArray)return _baseIsTypedArray;hasRequired_baseIsTypedArray=1;var t=require_baseGetTag(),ee=requireIsLength(),te=requireIsObjectLike(),ne="[object Arguments]",oe="[object Array]",ie="[object Boolean]",_e="[object Date]",se="[object Error]",re="[object Function]",ae="[object Map]",ce="[object Number]",de="[object Object]",ue="[object RegExp]",le="[object Set]",pe="[object String]",me="[object WeakMap]",fe="[object ArrayBuffer]",ge="[object DataView]",he="[object Float32Array]",be="[object Float64Array]",ve="[object Int8Array]",we="[object Int16Array]",ye="[object Int32Array]",ke="[object Uint8Array]",Ae="[object Uint8ClampedArray]",$e="[object Uint16Array]",Se="[object Uint32Array]",Te={};Te[he]=Te[be]=Te[ve]=Te[we]=Te[ye]=Te[ke]=Te[Ae]=Te[$e]=Te[Se]=!0,Te[ne]=Te[oe]=Te[fe]=Te[ie]=Te[ge]=Te[_e]=Te[se]=Te[re]=Te[ae]=Te[ce]=Te[de]=Te[ue]=Te[le]=Te[pe]=Te[me]=!1;function xe(Ie){return te(Ie)&&ee(Ie.length)&&!!Te[t(Ie)]}return _baseIsTypedArray=xe,_baseIsTypedArray}var _baseUnary,hasRequired_baseUnary;function require_baseUnary(){if(hasRequired_baseUnary)return _baseUnary;hasRequired_baseUnary=1;function t(ee){return function(te){return ee(te)}}return _baseUnary=t,_baseUnary}var _nodeUtil={exports:{}};_nodeUtil.exports;var hasRequired_nodeUtil;function require_nodeUtil(){return hasRequired_nodeUtil||(hasRequired_nodeUtil=1,function(t,ee){var te=require_freeGlobal(),ne=ee&&!ee.nodeType&&ee,oe=ne&&!0&&t&&!t.nodeType&&t,ie=oe&&oe.exports===ne,_e=ie&&te.process,se=function(){try{var re=oe&&oe.require&&oe.require("util").types;return re||_e&&_e.binding&&_e.binding("util")}catch{}}();t.exports=se}(_nodeUtil,_nodeUtil.exports)),_nodeUtil.exports}var isTypedArray_1,hasRequiredIsTypedArray;function requireIsTypedArray(){if(hasRequiredIsTypedArray)return isTypedArray_1;hasRequiredIsTypedArray=1;var t=require_baseIsTypedArray(),ee=require_baseUnary(),te=require_nodeUtil(),ne=te&&te.isTypedArray,oe=ne?ee(ne):t;return isTypedArray_1=oe,isTypedArray_1}var _arrayLikeKeys,hasRequired_arrayLikeKeys;function require_arrayLikeKeys(){if(hasRequired_arrayLikeKeys)return _arrayLikeKeys;hasRequired_arrayLikeKeys=1;var t=require_baseTimes(),ee=requireIsArguments(),te=requireIsArray(),ne=requireIsBuffer(),oe=require_isIndex(),ie=requireIsTypedArray(),_e=Object.prototype,se=_e.hasOwnProperty;function re(ae,ce){var de=te(ae),ue=!de&&ee(ae),le=!de&&!ue&&ne(ae),pe=!de&&!ue&&!le&&ie(ae),me=de||ue||le||pe,fe=me?t(ae.length,String):[],ge=fe.length;for(var he in ae)(ce||se.call(ae,he))&&!(me&&(he=="length"||le&&(he=="offset"||he=="parent")||pe&&(he=="buffer"||he=="byteLength"||he=="byteOffset")||oe(he,ge)))&&fe.push(he);return fe}return _arrayLikeKeys=re,_arrayLikeKeys}var _isPrototype,hasRequired_isPrototype;function require_isPrototype(){if(hasRequired_isPrototype)return _isPrototype;hasRequired_isPrototype=1;var t=Object.prototype;function ee(te){var ne=te&&te.constructor,oe=typeof ne=="function"&&ne.prototype||t;return te===oe}return _isPrototype=ee,_isPrototype}var _overArg,hasRequired_overArg;function require_overArg(){if(hasRequired_overArg)return _overArg;hasRequired_overArg=1;function t(ee,te){return function(ne){return ee(te(ne))}}return _overArg=t,_overArg}var _nativeKeys,hasRequired_nativeKeys;function require_nativeKeys(){if(hasRequired_nativeKeys)return _nativeKeys;hasRequired_nativeKeys=1;var t=require_overArg(),ee=t(Object.keys,Object);return _nativeKeys=ee,_nativeKeys}var _baseKeys,hasRequired_baseKeys;function require_baseKeys(){if(hasRequired_baseKeys)return _baseKeys;hasRequired_baseKeys=1;var t=require_isPrototype(),ee=require_nativeKeys(),te=Object.prototype,ne=te.hasOwnProperty;function oe(ie){if(!t(ie))return ee(ie);var _e=[];for(var se in Object(ie))ne.call(ie,se)&&se!="constructor"&&_e.push(se);return _e}return _baseKeys=oe,_baseKeys}var isArrayLike_1,hasRequiredIsArrayLike;function requireIsArrayLike(){if(hasRequiredIsArrayLike)return isArrayLike_1;hasRequiredIsArrayLike=1;var t=requireIsFunction(),ee=requireIsLength();function te(ne){return ne!=null&&ee(ne.length)&&!t(ne)}return isArrayLike_1=te,isArrayLike_1}var keys_1,hasRequiredKeys;function requireKeys(){if(hasRequiredKeys)return keys_1;hasRequiredKeys=1;var t=require_arrayLikeKeys(),ee=require_baseKeys(),te=requireIsArrayLike();function ne(oe){return te(oe)?t(oe):ee(oe)}return keys_1=ne,keys_1}var _baseAssign,hasRequired_baseAssign;function require_baseAssign(){if(hasRequired_baseAssign)return _baseAssign;hasRequired_baseAssign=1;var t=require_copyObject(),ee=requireKeys();function te(ne,oe){return ne&&t(oe,ee(oe),ne)}return _baseAssign=te,_baseAssign}var _nativeKeysIn,hasRequired_nativeKeysIn;function require_nativeKeysIn(){if(hasRequired_nativeKeysIn)return _nativeKeysIn;hasRequired_nativeKeysIn=1;function t(ee){var te=[];if(ee!=null)for(var ne in Object(ee))te.push(ne);return te}return _nativeKeysIn=t,_nativeKeysIn}var _baseKeysIn,hasRequired_baseKeysIn;function require_baseKeysIn(){if(hasRequired_baseKeysIn)return _baseKeysIn;hasRequired_baseKeysIn=1;var t=requireIsObject(),ee=require_isPrototype(),te=require_nativeKeysIn(),ne=Object.prototype,oe=ne.hasOwnProperty;function ie(_e){if(!t(_e))return te(_e);var se=ee(_e),re=[];for(var ae in _e)ae=="constructor"&&(se||!oe.call(_e,ae))||re.push(ae);return re}return _baseKeysIn=ie,_baseKeysIn}var keysIn_1,hasRequiredKeysIn;function requireKeysIn(){if(hasRequiredKeysIn)return keysIn_1;hasRequiredKeysIn=1;var t=require_arrayLikeKeys(),ee=require_baseKeysIn(),te=requireIsArrayLike();function ne(oe){return te(oe)?t(oe,!0):ee(oe)}return keysIn_1=ne,keysIn_1}var _baseAssignIn,hasRequired_baseAssignIn;function require_baseAssignIn(){if(hasRequired_baseAssignIn)return _baseAssignIn;hasRequired_baseAssignIn=1;var t=require_copyObject(),ee=requireKeysIn();function te(ne,oe){return ne&&t(oe,ee(oe),ne)}return _baseAssignIn=te,_baseAssignIn}var _cloneBuffer={exports:{}};_cloneBuffer.exports;var hasRequired_cloneBuffer;function require_cloneBuffer(){return hasRequired_cloneBuffer||(hasRequired_cloneBuffer=1,function(t,ee){var te=require_root(),ne=ee&&!ee.nodeType&&ee,oe=ne&&!0&&t&&!t.nodeType&&t,ie=oe&&oe.exports===ne,_e=ie?te.Buffer:void 0,se=_e?_e.allocUnsafe:void 0;function re(ae,ce){if(ce)return ae.slice();var de=ae.length,ue=se?se(de):new ae.constructor(de);return ae.copy(ue),ue}t.exports=re}(_cloneBuffer,_cloneBuffer.exports)),_cloneBuffer.exports}var _copyArray,hasRequired_copyArray;function require_copyArray(){if(hasRequired_copyArray)return _copyArray;hasRequired_copyArray=1;function t(ee,te){var ne=-1,oe=ee.length;for(te||(te=Array(oe));++ne<oe;)te[ne]=ee[ne];return te}return _copyArray=t,_copyArray}var _arrayFilter,hasRequired_arrayFilter;function require_arrayFilter(){if(hasRequired_arrayFilter)return _arrayFilter;hasRequired_arrayFilter=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length,ie=0,_e=[];++ne<oe;){var se=ee[ne];te(se,ne,ee)&&(_e[ie++]=se)}return _e}return _arrayFilter=t,_arrayFilter}var stubArray_1,hasRequiredStubArray;function requireStubArray(){if(hasRequiredStubArray)return stubArray_1;hasRequiredStubArray=1;function t(){return[]}return stubArray_1=t,stubArray_1}var _getSymbols,hasRequired_getSymbols;function require_getSymbols(){if(hasRequired_getSymbols)return _getSymbols;hasRequired_getSymbols=1;var t=require_arrayFilter(),ee=requireStubArray(),te=Object.prototype,ne=te.propertyIsEnumerable,oe=Object.getOwnPropertySymbols,ie=oe?function(_e){return _e==null?[]:(_e=Object(_e),t(oe(_e),function(se){return ne.call(_e,se)}))}:ee;return _getSymbols=ie,_getSymbols}var _copySymbols,hasRequired_copySymbols;function require_copySymbols(){if(hasRequired_copySymbols)return _copySymbols;hasRequired_copySymbols=1;var t=require_copyObject(),ee=require_getSymbols();function te(ne,oe){return t(ne,ee(ne),oe)}return _copySymbols=te,_copySymbols}var _arrayPush,hasRequired_arrayPush;function require_arrayPush(){if(hasRequired_arrayPush)return _arrayPush;hasRequired_arrayPush=1;function t(ee,te){for(var ne=-1,oe=te.length,ie=ee.length;++ne<oe;)ee[ie+ne]=te[ne];return ee}return _arrayPush=t,_arrayPush}var _getPrototype,hasRequired_getPrototype;function require_getPrototype(){if(hasRequired_getPrototype)return _getPrototype;hasRequired_getPrototype=1;var t=require_overArg(),ee=t(Object.getPrototypeOf,Object);return _getPrototype=ee,_getPrototype}var _getSymbolsIn,hasRequired_getSymbolsIn;function require_getSymbolsIn(){if(hasRequired_getSymbolsIn)return _getSymbolsIn;hasRequired_getSymbolsIn=1;var t=require_arrayPush(),ee=require_getPrototype(),te=require_getSymbols(),ne=requireStubArray(),oe=Object.getOwnPropertySymbols,ie=oe?function(_e){for(var se=[];_e;)t(se,te(_e)),_e=ee(_e);return se}:ne;return _getSymbolsIn=ie,_getSymbolsIn}var _copySymbolsIn,hasRequired_copySymbolsIn;function require_copySymbolsIn(){if(hasRequired_copySymbolsIn)return _copySymbolsIn;hasRequired_copySymbolsIn=1;var t=require_copyObject(),ee=require_getSymbolsIn();function te(ne,oe){return t(ne,ee(ne),oe)}return _copySymbolsIn=te,_copySymbolsIn}var _baseGetAllKeys,hasRequired_baseGetAllKeys;function require_baseGetAllKeys(){if(hasRequired_baseGetAllKeys)return _baseGetAllKeys;hasRequired_baseGetAllKeys=1;var t=require_arrayPush(),ee=requireIsArray();function te(ne,oe,ie){var _e=oe(ne);return ee(ne)?_e:t(_e,ie(ne))}return _baseGetAllKeys=te,_baseGetAllKeys}var _getAllKeys,hasRequired_getAllKeys;function require_getAllKeys(){if(hasRequired_getAllKeys)return _getAllKeys;hasRequired_getAllKeys=1;var t=require_baseGetAllKeys(),ee=require_getSymbols(),te=requireKeys();function ne(oe){return t(oe,te,ee)}return _getAllKeys=ne,_getAllKeys}var _getAllKeysIn,hasRequired_getAllKeysIn;function require_getAllKeysIn(){if(hasRequired_getAllKeysIn)return _getAllKeysIn;hasRequired_getAllKeysIn=1;var t=require_baseGetAllKeys(),ee=require_getSymbolsIn(),te=requireKeysIn();function ne(oe){return t(oe,te,ee)}return _getAllKeysIn=ne,_getAllKeysIn}var _DataView,hasRequired_DataView;function require_DataView(){if(hasRequired_DataView)return _DataView;hasRequired_DataView=1;var t=require_getNative(),ee=require_root(),te=t(ee,"DataView");return _DataView=te,_DataView}var _Promise,hasRequired_Promise;function require_Promise(){if(hasRequired_Promise)return _Promise;hasRequired_Promise=1;var t=require_getNative(),ee=require_root(),te=t(ee,"Promise");return _Promise=te,_Promise}var _Set,hasRequired_Set;function require_Set(){if(hasRequired_Set)return _Set;hasRequired_Set=1;var t=require_getNative(),ee=require_root(),te=t(ee,"Set");return _Set=te,_Set}var _WeakMap,hasRequired_WeakMap;function require_WeakMap(){if(hasRequired_WeakMap)return _WeakMap;hasRequired_WeakMap=1;var t=require_getNative(),ee=require_root(),te=t(ee,"WeakMap");return _WeakMap=te,_WeakMap}var _getTag,hasRequired_getTag;function require_getTag(){if(hasRequired_getTag)return _getTag;hasRequired_getTag=1;var t=require_DataView(),ee=require_Map(),te=require_Promise(),ne=require_Set(),oe=require_WeakMap(),ie=require_baseGetTag(),_e=require_toSource(),se="[object Map]",re="[object Object]",ae="[object Promise]",ce="[object Set]",de="[object WeakMap]",ue="[object DataView]",le=_e(t),pe=_e(ee),me=_e(te),fe=_e(ne),ge=_e(oe),he=ie;return(t&&he(new t(new ArrayBuffer(1)))!=ue||ee&&he(new ee)!=se||te&&he(te.resolve())!=ae||ne&&he(new ne)!=ce||oe&&he(new oe)!=de)&&(he=function(be){var ve=ie(be),we=ve==re?be.constructor:void 0,ye=we?_e(we):"";if(ye)switch(ye){case le:return ue;case pe:return se;case me:return ae;case fe:return ce;case ge:return de}return ve}),_getTag=he,_getTag}var _initCloneArray,hasRequired_initCloneArray;function require_initCloneArray(){if(hasRequired_initCloneArray)return _initCloneArray;hasRequired_initCloneArray=1;var t=Object.prototype,ee=t.hasOwnProperty;function te(ne){var oe=ne.length,ie=new ne.constructor(oe);return oe&&typeof ne[0]=="string"&&ee.call(ne,"index")&&(ie.index=ne.index,ie.input=ne.input),ie}return _initCloneArray=te,_initCloneArray}var _Uint8Array,hasRequired_Uint8Array;function require_Uint8Array(){if(hasRequired_Uint8Array)return _Uint8Array;hasRequired_Uint8Array=1;var t=require_root(),ee=t.Uint8Array;return _Uint8Array=ee,_Uint8Array}var _cloneArrayBuffer,hasRequired_cloneArrayBuffer;function require_cloneArrayBuffer(){if(hasRequired_cloneArrayBuffer)return _cloneArrayBuffer;hasRequired_cloneArrayBuffer=1;var t=require_Uint8Array();function ee(te){var ne=new te.constructor(te.byteLength);return new t(ne).set(new t(te)),ne}return _cloneArrayBuffer=ee,_cloneArrayBuffer}var _cloneDataView,hasRequired_cloneDataView;function require_cloneDataView(){if(hasRequired_cloneDataView)return _cloneDataView;hasRequired_cloneDataView=1;var t=require_cloneArrayBuffer();function ee(te,ne){var oe=ne?t(te.buffer):te.buffer;return new te.constructor(oe,te.byteOffset,te.byteLength)}return _cloneDataView=ee,_cloneDataView}var _cloneRegExp,hasRequired_cloneRegExp;function require_cloneRegExp(){if(hasRequired_cloneRegExp)return _cloneRegExp;hasRequired_cloneRegExp=1;var t=/\w*$/;function ee(te){var ne=new te.constructor(te.source,t.exec(te));return ne.lastIndex=te.lastIndex,ne}return _cloneRegExp=ee,_cloneRegExp}var _cloneSymbol,hasRequired_cloneSymbol;function require_cloneSymbol(){if(hasRequired_cloneSymbol)return _cloneSymbol;hasRequired_cloneSymbol=1;var t=require_Symbol(),ee=t?t.prototype:void 0,te=ee?ee.valueOf:void 0;function ne(oe){return te?Object(te.call(oe)):{}}return _cloneSymbol=ne,_cloneSymbol}var _cloneTypedArray,hasRequired_cloneTypedArray;function require_cloneTypedArray(){if(hasRequired_cloneTypedArray)return _cloneTypedArray;hasRequired_cloneTypedArray=1;var t=require_cloneArrayBuffer();function ee(te,ne){var oe=ne?t(te.buffer):te.buffer;return new te.constructor(oe,te.byteOffset,te.length)}return _cloneTypedArray=ee,_cloneTypedArray}var _initCloneByTag,hasRequired_initCloneByTag;function require_initCloneByTag(){if(hasRequired_initCloneByTag)return _initCloneByTag;hasRequired_initCloneByTag=1;var t=require_cloneArrayBuffer(),ee=require_cloneDataView(),te=require_cloneRegExp(),ne=require_cloneSymbol(),oe=require_cloneTypedArray(),ie="[object Boolean]",_e="[object Date]",se="[object Map]",re="[object Number]",ae="[object RegExp]",ce="[object Set]",de="[object String]",ue="[object Symbol]",le="[object ArrayBuffer]",pe="[object DataView]",me="[object Float32Array]",fe="[object Float64Array]",ge="[object Int8Array]",he="[object Int16Array]",be="[object Int32Array]",ve="[object Uint8Array]",we="[object Uint8ClampedArray]",ye="[object Uint16Array]",ke="[object Uint32Array]";function Ae($e,Se,Te){var xe=$e.constructor;switch(Se){case le:return t($e);case ie:case _e:return new xe(+$e);case pe:return ee($e,Te);case me:case fe:case ge:case he:case be:case ve:case we:case ye:case ke:return oe($e,Te);case se:return new xe;case re:case de:return new xe($e);case ae:return te($e);case ce:return new xe;case ue:return ne($e)}}return _initCloneByTag=Ae,_initCloneByTag}var _baseCreate,hasRequired_baseCreate;function require_baseCreate(){if(hasRequired_baseCreate)return _baseCreate;hasRequired_baseCreate=1;var t=requireIsObject(),ee=Object.create,te=function(){function ne(){}return function(oe){if(!t(oe))return{};if(ee)return ee(oe);ne.prototype=oe;var ie=new ne;return ne.prototype=void 0,ie}}();return _baseCreate=te,_baseCreate}var _initCloneObject,hasRequired_initCloneObject;function require_initCloneObject(){if(hasRequired_initCloneObject)return _initCloneObject;hasRequired_initCloneObject=1;var t=require_baseCreate(),ee=require_getPrototype(),te=require_isPrototype();function ne(oe){return typeof oe.constructor=="function"&&!te(oe)?t(ee(oe)):{}}return _initCloneObject=ne,_initCloneObject}var _baseIsMap,hasRequired_baseIsMap;function require_baseIsMap(){if(hasRequired_baseIsMap)return _baseIsMap;hasRequired_baseIsMap=1;var t=require_getTag(),ee=requireIsObjectLike(),te="[object Map]";function ne(oe){return ee(oe)&&t(oe)==te}return _baseIsMap=ne,_baseIsMap}var isMap_1,hasRequiredIsMap;function requireIsMap(){if(hasRequiredIsMap)return isMap_1;hasRequiredIsMap=1;var t=require_baseIsMap(),ee=require_baseUnary(),te=require_nodeUtil(),ne=te&&te.isMap,oe=ne?ee(ne):t;return isMap_1=oe,isMap_1}var _baseIsSet,hasRequired_baseIsSet;function require_baseIsSet(){if(hasRequired_baseIsSet)return _baseIsSet;hasRequired_baseIsSet=1;var t=require_getTag(),ee=requireIsObjectLike(),te="[object Set]";function ne(oe){return ee(oe)&&t(oe)==te}return _baseIsSet=ne,_baseIsSet}var isSet_1,hasRequiredIsSet;function requireIsSet(){if(hasRequiredIsSet)return isSet_1;hasRequiredIsSet=1;var t=require_baseIsSet(),ee=require_baseUnary(),te=require_nodeUtil(),ne=te&&te.isSet,oe=ne?ee(ne):t;return isSet_1=oe,isSet_1}var _baseClone,hasRequired_baseClone;function require_baseClone(){if(hasRequired_baseClone)return _baseClone;hasRequired_baseClone=1;var t=require_Stack(),ee=require_arrayEach(),te=require_assignValue(),ne=require_baseAssign(),oe=require_baseAssignIn(),ie=require_cloneBuffer(),_e=require_copyArray(),se=require_copySymbols(),re=require_copySymbolsIn(),ae=require_getAllKeys(),ce=require_getAllKeysIn(),de=require_getTag(),ue=require_initCloneArray(),le=require_initCloneByTag(),pe=require_initCloneObject(),me=requireIsArray(),fe=requireIsBuffer(),ge=requireIsMap(),he=requireIsObject(),be=requireIsSet(),ve=requireKeys(),we=requireKeysIn(),ye=1,ke=2,Ae=4,$e="[object Arguments]",Se="[object Array]",Te="[object Boolean]",xe="[object Date]",Ie="[object Error]",Pe="[object Function]",je="[object GeneratorFunction]",De="[object Map]",We="[object Number]",ze="[object Object]",Le="[object RegExp]",qt="[object Set]",Vt="[object String]",Be="[object Symbol]",Ce="[object WeakMap]",Ee="[object ArrayBuffer]",Ve="[object DataView]",Fe="[object Float32Array]",Ut="[object Float64Array]",Ye="[object Int8Array]",Je="[object Int16Array]",Qt="[object Int32Array]",Wt="[object Uint8Array]",en="[object Uint8ClampedArray]",Me="[object Uint16Array]",Ue="[object Uint32Array]",qe={};qe[$e]=qe[Se]=qe[Ee]=qe[Ve]=qe[Te]=qe[xe]=qe[Fe]=qe[Ut]=qe[Ye]=qe[Je]=qe[Qt]=qe[De]=qe[We]=qe[ze]=qe[Le]=qe[qt]=qe[Vt]=qe[Be]=qe[Wt]=qe[en]=qe[Me]=qe[Ue]=!0,qe[Ie]=qe[Pe]=qe[Ce]=!1;function Kt(Re,Xe,Ze,rn,Yt,Ge){var Oe,Jt=Xe&ye,Xt=Xe&ke,an=Xe&Ae;if(Ze&&(Oe=Yt?Ze(Re,rn,Yt,Ge):Ze(Re)),Oe!==void 0)return Oe;if(!he(Re))return Re;var tn=me(Re);if(tn){if(Oe=ue(Re),!Jt)return _e(Re,Oe)}else{var Qe=de(Re),nn=Qe==Pe||Qe==je;if(fe(Re))return ie(Re,Jt);if(Qe==ze||Qe==$e||nn&&!Yt){if(Oe=Xt||nn?{}:pe(Re),!Jt)return Xt?re(Re,oe(Oe,Re)):se(Re,ne(Oe,Re))}else{if(!qe[Qe])return Yt?Re:{};Oe=le(Re,Qe,Jt)}}Ge||(Ge=new t);var on=Ge.get(Re);if(on)return on;Ge.set(Re,Oe),be(Re)?Re.forEach(function(He){Oe.add(Kt(He,Xe,Ze,He,Re,Ge))}):ge(Re)&&Re.forEach(function(He,Ke){Oe.set(Ke,Kt(He,Xe,Ze,Ke,Re,Ge))});var cn=an?Xt?ce:ae:Xt?we:ve,_n=tn?void 0:cn(Re);return ee(_n||Re,function(He,Ke){_n&&(Ke=He,He=Re[Ke]),te(Oe,Ke,Kt(He,Xe,Ze,Ke,Re,Ge))}),Oe}return _baseClone=Kt,_baseClone}var clone_1,hasRequiredClone;function requireClone(){if(hasRequiredClone)return clone_1;hasRequiredClone=1;var t=require_baseClone(),ee=4;function te(ne){return t(ne,ee)}return clone_1=te,clone_1}var constant_1,hasRequiredConstant;function requireConstant(){if(hasRequiredConstant)return constant_1;hasRequiredConstant=1;function t(ee){return function(){return ee}}return constant_1=t,constant_1}var _createBaseFor,hasRequired_createBaseFor;function require_createBaseFor(){if(hasRequired_createBaseFor)return _createBaseFor;hasRequired_createBaseFor=1;function t(ee){return function(te,ne,oe){for(var ie=-1,_e=Object(te),se=oe(te),re=se.length;re--;){var ae=se[ee?re:++ie];if(ne(_e[ae],ae,_e)===!1)break}return te}}return _createBaseFor=t,_createBaseFor}var _baseFor,hasRequired_baseFor;function require_baseFor(){if(hasRequired_baseFor)return _baseFor;hasRequired_baseFor=1;var t=require_createBaseFor(),ee=t();return _baseFor=ee,_baseFor}var _baseForOwn,hasRequired_baseForOwn;function require_baseForOwn(){if(hasRequired_baseForOwn)return _baseForOwn;hasRequired_baseForOwn=1;var t=require_baseFor(),ee=requireKeys();function te(ne,oe){return ne&&t(ne,oe,ee)}return _baseForOwn=te,_baseForOwn}var _createBaseEach,hasRequired_createBaseEach;function require_createBaseEach(){if(hasRequired_createBaseEach)return _createBaseEach;hasRequired_createBaseEach=1;var t=requireIsArrayLike();function ee(te,ne){return function(oe,ie){if(oe==null)return oe;if(!t(oe))return te(oe,ie);for(var _e=oe.length,se=ne?_e:-1,re=Object(oe);(ne?se--:++se<_e)&&ie(re[se],se,re)!==!1;);return oe}}return _createBaseEach=ee,_createBaseEach}var _baseEach,hasRequired_baseEach;function require_baseEach(){if(hasRequired_baseEach)return _baseEach;hasRequired_baseEach=1;var t=require_baseForOwn(),ee=require_createBaseEach(),te=ee(t);return _baseEach=te,_baseEach}var identity_1,hasRequiredIdentity;function requireIdentity(){if(hasRequiredIdentity)return identity_1;hasRequiredIdentity=1;function t(ee){return ee}return identity_1=t,identity_1}var _castFunction,hasRequired_castFunction;function require_castFunction(){if(hasRequired_castFunction)return _castFunction;hasRequired_castFunction=1;var t=requireIdentity();function ee(te){return typeof te=="function"?te:t}return _castFunction=ee,_castFunction}var forEach_1,hasRequiredForEach;function requireForEach(){if(hasRequiredForEach)return forEach_1;hasRequiredForEach=1;var t=require_arrayEach(),ee=require_baseEach(),te=require_castFunction(),ne=requireIsArray();function oe(ie,_e){var se=ne(ie)?t:ee;return se(ie,te(_e))}return forEach_1=oe,forEach_1}var each,hasRequiredEach;function requireEach(){return hasRequiredEach||(hasRequiredEach=1,each=requireForEach()),each}var _baseFilter,hasRequired_baseFilter;function require_baseFilter(){if(hasRequired_baseFilter)return _baseFilter;hasRequired_baseFilter=1;var t=require_baseEach();function ee(te,ne){var oe=[];return t(te,function(ie,_e,se){ne(ie,_e,se)&&oe.push(ie)}),oe}return _baseFilter=ee,_baseFilter}var _setCacheAdd,hasRequired_setCacheAdd;function require_setCacheAdd(){if(hasRequired_setCacheAdd)return _setCacheAdd;hasRequired_setCacheAdd=1;var t="__lodash_hash_undefined__";function ee(te){return this.__data__.set(te,t),this}return _setCacheAdd=ee,_setCacheAdd}var _setCacheHas,hasRequired_setCacheHas;function require_setCacheHas(){if(hasRequired_setCacheHas)return _setCacheHas;hasRequired_setCacheHas=1;function t(ee){return this.__data__.has(ee)}return _setCacheHas=t,_setCacheHas}var _SetCache,hasRequired_SetCache;function require_SetCache(){if(hasRequired_SetCache)return _SetCache;hasRequired_SetCache=1;var t=require_MapCache(),ee=require_setCacheAdd(),te=require_setCacheHas();function ne(oe){var ie=-1,_e=oe==null?0:oe.length;for(this.__data__=new t;++ie<_e;)this.add(oe[ie])}return ne.prototype.add=ne.prototype.push=ee,ne.prototype.has=te,_SetCache=ne,_SetCache}var _arraySome,hasRequired_arraySome;function require_arraySome(){if(hasRequired_arraySome)return _arraySome;hasRequired_arraySome=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length;++ne<oe;)if(te(ee[ne],ne,ee))return!0;return!1}return _arraySome=t,_arraySome}var _cacheHas,hasRequired_cacheHas;function require_cacheHas(){if(hasRequired_cacheHas)return _cacheHas;hasRequired_cacheHas=1;function t(ee,te){return ee.has(te)}return _cacheHas=t,_cacheHas}var _equalArrays,hasRequired_equalArrays;function require_equalArrays(){if(hasRequired_equalArrays)return _equalArrays;hasRequired_equalArrays=1;var t=require_SetCache(),ee=require_arraySome(),te=require_cacheHas(),ne=1,oe=2;function ie(_e,se,re,ae,ce,de){var ue=re&ne,le=_e.length,pe=se.length;if(le!=pe&&!(ue&&pe>le))return!1;var me=de.get(_e),fe=de.get(se);if(me&&fe)return me==se&&fe==_e;var ge=-1,he=!0,be=re&oe?new t:void 0;for(de.set(_e,se),de.set(se,_e);++ge<le;){var ve=_e[ge],we=se[ge];if(ae)var ye=ue?ae(we,ve,ge,se,_e,de):ae(ve,we,ge,_e,se,de);if(ye!==void 0){if(ye)continue;he=!1;break}if(be){if(!ee(se,function(ke,Ae){if(!te(be,Ae)&&(ve===ke||ce(ve,ke,re,ae,de)))return be.push(Ae)})){he=!1;break}}else if(!(ve===we||ce(ve,we,re,ae,de))){he=!1;break}}return de.delete(_e),de.delete(se),he}return _equalArrays=ie,_equalArrays}var _mapToArray,hasRequired_mapToArray;function require_mapToArray(){if(hasRequired_mapToArray)return _mapToArray;hasRequired_mapToArray=1;function t(ee){var te=-1,ne=Array(ee.size);return ee.forEach(function(oe,ie){ne[++te]=[ie,oe]}),ne}return _mapToArray=t,_mapToArray}var _setToArray,hasRequired_setToArray;function require_setToArray(){if(hasRequired_setToArray)return _setToArray;hasRequired_setToArray=1;function t(ee){var te=-1,ne=Array(ee.size);return ee.forEach(function(oe){ne[++te]=oe}),ne}return _setToArray=t,_setToArray}var _equalByTag,hasRequired_equalByTag;function require_equalByTag(){if(hasRequired_equalByTag)return _equalByTag;hasRequired_equalByTag=1;var t=require_Symbol(),ee=require_Uint8Array(),te=requireEq(),ne=require_equalArrays(),oe=require_mapToArray(),ie=require_setToArray(),_e=1,se=2,re="[object Boolean]",ae="[object Date]",ce="[object Error]",de="[object Map]",ue="[object Number]",le="[object RegExp]",pe="[object Set]",me="[object String]",fe="[object Symbol]",ge="[object ArrayBuffer]",he="[object DataView]",be=t?t.prototype:void 0,ve=be?be.valueOf:void 0;function we(ye,ke,Ae,$e,Se,Te,xe){switch(Ae){case he:if(ye.byteLength!=ke.byteLength||ye.byteOffset!=ke.byteOffset)return!1;ye=ye.buffer,ke=ke.buffer;case ge:return!(ye.byteLength!=ke.byteLength||!Te(new ee(ye),new ee(ke)));case re:case ae:case ue:return te(+ye,+ke);case ce:return ye.name==ke.name&&ye.message==ke.message;case le:case me:return ye==ke+"";case de:var Ie=oe;case pe:var Pe=$e&_e;if(Ie||(Ie=ie),ye.size!=ke.size&&!Pe)return!1;var je=xe.get(ye);if(je)return je==ke;$e|=se,xe.set(ye,ke);var De=ne(Ie(ye),Ie(ke),$e,Se,Te,xe);return xe.delete(ye),De;case fe:if(ve)return ve.call(ye)==ve.call(ke)}return!1}return _equalByTag=we,_equalByTag}var _equalObjects,hasRequired_equalObjects;function require_equalObjects(){if(hasRequired_equalObjects)return _equalObjects;hasRequired_equalObjects=1;var t=require_getAllKeys(),ee=1,te=Object.prototype,ne=te.hasOwnProperty;function oe(ie,_e,se,re,ae,ce){var de=se&ee,ue=t(ie),le=ue.length,pe=t(_e),me=pe.length;if(le!=me&&!de)return!1;for(var fe=le;fe--;){var ge=ue[fe];if(!(de?ge in _e:ne.call(_e,ge)))return!1}var he=ce.get(ie),be=ce.get(_e);if(he&&be)return he==_e&&be==ie;var ve=!0;ce.set(ie,_e),ce.set(_e,ie);for(var we=de;++fe<le;){ge=ue[fe];var ye=ie[ge],ke=_e[ge];if(re)var Ae=de?re(ke,ye,ge,_e,ie,ce):re(ye,ke,ge,ie,_e,ce);if(!(Ae===void 0?ye===ke||ae(ye,ke,se,re,ce):Ae)){ve=!1;break}we||(we=ge=="constructor")}if(ve&&!we){var $e=ie.constructor,Se=_e.constructor;$e!=Se&&"constructor"in ie&&"constructor"in _e&&!(typeof $e=="function"&&$e instanceof $e&&typeof Se=="function"&&Se instanceof Se)&&(ve=!1)}return ce.delete(ie),ce.delete(_e),ve}return _equalObjects=oe,_equalObjects}var _baseIsEqualDeep,hasRequired_baseIsEqualDeep;function require_baseIsEqualDeep(){if(hasRequired_baseIsEqualDeep)return _baseIsEqualDeep;hasRequired_baseIsEqualDeep=1;var t=require_Stack(),ee=require_equalArrays(),te=require_equalByTag(),ne=require_equalObjects(),oe=require_getTag(),ie=requireIsArray(),_e=requireIsBuffer(),se=requireIsTypedArray(),re=1,ae="[object Arguments]",ce="[object Array]",de="[object Object]",ue=Object.prototype,le=ue.hasOwnProperty;function pe(me,fe,ge,he,be,ve){var we=ie(me),ye=ie(fe),ke=we?ce:oe(me),Ae=ye?ce:oe(fe);ke=ke==ae?de:ke,Ae=Ae==ae?de:Ae;var $e=ke==de,Se=Ae==de,Te=ke==Ae;if(Te&&_e(me)){if(!_e(fe))return!1;we=!0,$e=!1}if(Te&&!$e)return ve||(ve=new t),we||se(me)?ee(me,fe,ge,he,be,ve):te(me,fe,ke,ge,he,be,ve);if(!(ge&re)){var xe=$e&&le.call(me,"__wrapped__"),Ie=Se&&le.call(fe,"__wrapped__");if(xe||Ie){var Pe=xe?me.value():me,je=Ie?fe.value():fe;return ve||(ve=new t),be(Pe,je,ge,he,ve)}}return Te?(ve||(ve=new t),ne(me,fe,ge,he,be,ve)):!1}return _baseIsEqualDeep=pe,_baseIsEqualDeep}var _baseIsEqual,hasRequired_baseIsEqual;function require_baseIsEqual(){if(hasRequired_baseIsEqual)return _baseIsEqual;hasRequired_baseIsEqual=1;var t=require_baseIsEqualDeep(),ee=requireIsObjectLike();function te(ne,oe,ie,_e,se){return ne===oe?!0:ne==null||oe==null||!ee(ne)&&!ee(oe)?ne!==ne&&oe!==oe:t(ne,oe,ie,_e,te,se)}return _baseIsEqual=te,_baseIsEqual}var _baseIsMatch,hasRequired_baseIsMatch;function require_baseIsMatch(){if(hasRequired_baseIsMatch)return _baseIsMatch;hasRequired_baseIsMatch=1;var t=require_Stack(),ee=require_baseIsEqual(),te=1,ne=2;function oe(ie,_e,se,re){var ae=se.length,ce=ae,de=!re;if(ie==null)return!ce;for(ie=Object(ie);ae--;){var ue=se[ae];if(de&&ue[2]?ue[1]!==ie[ue[0]]:!(ue[0]in ie))return!1}for(;++ae<ce;){ue=se[ae];var le=ue[0],pe=ie[le],me=ue[1];if(de&&ue[2]){if(pe===void 0&&!(le in ie))return!1}else{var fe=new t;if(re)var ge=re(pe,me,le,ie,_e,fe);if(!(ge===void 0?ee(me,pe,te|ne,re,fe):ge))return!1}}return!0}return _baseIsMatch=oe,_baseIsMatch}var _isStrictComparable,hasRequired_isStrictComparable;function require_isStrictComparable(){if(hasRequired_isStrictComparable)return _isStrictComparable;hasRequired_isStrictComparable=1;var t=requireIsObject();function ee(te){return te===te&&!t(te)}return _isStrictComparable=ee,_isStrictComparable}var _getMatchData,hasRequired_getMatchData;function require_getMatchData(){if(hasRequired_getMatchData)return _getMatchData;hasRequired_getMatchData=1;var t=require_isStrictComparable(),ee=requireKeys();function te(ne){for(var oe=ee(ne),ie=oe.length;ie--;){var _e=oe[ie],se=ne[_e];oe[ie]=[_e,se,t(se)]}return oe}return _getMatchData=te,_getMatchData}var _matchesStrictComparable,hasRequired_matchesStrictComparable;function require_matchesStrictComparable(){if(hasRequired_matchesStrictComparable)return _matchesStrictComparable;hasRequired_matchesStrictComparable=1;function t(ee,te){return function(ne){return ne==null?!1:ne[ee]===te&&(te!==void 0||ee in Object(ne))}}return _matchesStrictComparable=t,_matchesStrictComparable}var _baseMatches,hasRequired_baseMatches;function require_baseMatches(){if(hasRequired_baseMatches)return _baseMatches;hasRequired_baseMatches=1;var t=require_baseIsMatch(),ee=require_getMatchData(),te=require_matchesStrictComparable();function ne(oe){var ie=ee(oe);return ie.length==1&&ie[0][2]?te(ie[0][0],ie[0][1]):function(_e){return _e===oe||t(_e,oe,ie)}}return _baseMatches=ne,_baseMatches}var isSymbol_1,hasRequiredIsSymbol;function requireIsSymbol(){if(hasRequiredIsSymbol)return isSymbol_1;hasRequiredIsSymbol=1;var t=require_baseGetTag(),ee=requireIsObjectLike(),te="[object Symbol]";function ne(oe){return typeof oe=="symbol"||ee(oe)&&t(oe)==te}return isSymbol_1=ne,isSymbol_1}var _isKey,hasRequired_isKey;function require_isKey(){if(hasRequired_isKey)return _isKey;hasRequired_isKey=1;var t=requireIsArray(),ee=requireIsSymbol(),te=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ne=/^\w*$/;function oe(ie,_e){if(t(ie))return!1;var se=typeof ie;return se=="number"||se=="symbol"||se=="boolean"||ie==null||ee(ie)?!0:ne.test(ie)||!te.test(ie)||_e!=null&&ie in Object(_e)}return _isKey=oe,_isKey}var memoize_1,hasRequiredMemoize;function requireMemoize(){if(hasRequiredMemoize)return memoize_1;hasRequiredMemoize=1;var t=require_MapCache(),ee="Expected a function";function te(ne,oe){if(typeof ne!="function"||oe!=null&&typeof oe!="function")throw new TypeError(ee);var ie=function(){var _e=arguments,se=oe?oe.apply(this,_e):_e[0],re=ie.cache;if(re.has(se))return re.get(se);var ae=ne.apply(this,_e);return ie.cache=re.set(se,ae)||re,ae};return ie.cache=new(te.Cache||t),ie}return te.Cache=t,memoize_1=te,memoize_1}var _memoizeCapped,hasRequired_memoizeCapped;function require_memoizeCapped(){if(hasRequired_memoizeCapped)return _memoizeCapped;hasRequired_memoizeCapped=1;var t=requireMemoize(),ee=500;function te(ne){var oe=t(ne,function(_e){return ie.size===ee&&ie.clear(),_e}),ie=oe.cache;return oe}return _memoizeCapped=te,_memoizeCapped}var _stringToPath,hasRequired_stringToPath;function require_stringToPath(){if(hasRequired_stringToPath)return _stringToPath;hasRequired_stringToPath=1;var t=require_memoizeCapped(),ee=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,te=/\\(\\)?/g,ne=t(function(oe){var ie=[];return oe.charCodeAt(0)===46&&ie.push(""),oe.replace(ee,function(_e,se,re,ae){ie.push(re?ae.replace(te,"$1"):se||_e)}),ie});return _stringToPath=ne,_stringToPath}var _arrayMap,hasRequired_arrayMap;function require_arrayMap(){if(hasRequired_arrayMap)return _arrayMap;hasRequired_arrayMap=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length,ie=Array(oe);++ne<oe;)ie[ne]=te(ee[ne],ne,ee);return ie}return _arrayMap=t,_arrayMap}var _baseToString,hasRequired_baseToString;function require_baseToString(){if(hasRequired_baseToString)return _baseToString;hasRequired_baseToString=1;var t=require_Symbol(),ee=require_arrayMap(),te=requireIsArray(),ne=requireIsSymbol(),oe=1/0,ie=t?t.prototype:void 0,_e=ie?ie.toString:void 0;function se(re){if(typeof re=="string")return re;if(te(re))return ee(re,se)+"";if(ne(re))return _e?_e.call(re):"";var ae=re+"";return ae=="0"&&1/re==-oe?"-0":ae}return _baseToString=se,_baseToString}var toString_1,hasRequiredToString;function requireToString(){if(hasRequiredToString)return toString_1;hasRequiredToString=1;var t=require_baseToString();function ee(te){return te==null?"":t(te)}return toString_1=ee,toString_1}var _castPath,hasRequired_castPath;function require_castPath(){if(hasRequired_castPath)return _castPath;hasRequired_castPath=1;var t=requireIsArray(),ee=require_isKey(),te=require_stringToPath(),ne=requireToString();function oe(ie,_e){return t(ie)?ie:ee(ie,_e)?[ie]:te(ne(ie))}return _castPath=oe,_castPath}var _toKey,hasRequired_toKey;function require_toKey(){if(hasRequired_toKey)return _toKey;hasRequired_toKey=1;var t=requireIsSymbol(),ee=1/0;function te(ne){if(typeof ne=="string"||t(ne))return ne;var oe=ne+"";return oe=="0"&&1/ne==-ee?"-0":oe}return _toKey=te,_toKey}var _baseGet,hasRequired_baseGet;function require_baseGet(){if(hasRequired_baseGet)return _baseGet;hasRequired_baseGet=1;var t=require_castPath(),ee=require_toKey();function te(ne,oe){oe=t(oe,ne);for(var ie=0,_e=oe.length;ne!=null&&ie<_e;)ne=ne[ee(oe[ie++])];return ie&&ie==_e?ne:void 0}return _baseGet=te,_baseGet}var get_1,hasRequiredGet;function requireGet(){if(hasRequiredGet)return get_1;hasRequiredGet=1;var t=require_baseGet();function ee(te,ne,oe){var ie=te==null?void 0:t(te,ne);return ie===void 0?oe:ie}return get_1=ee,get_1}var _baseHasIn,hasRequired_baseHasIn;function require_baseHasIn(){if(hasRequired_baseHasIn)return _baseHasIn;hasRequired_baseHasIn=1;function t(ee,te){return ee!=null&&te in Object(ee)}return _baseHasIn=t,_baseHasIn}var _hasPath,hasRequired_hasPath;function require_hasPath(){if(hasRequired_hasPath)return _hasPath;hasRequired_hasPath=1;var t=require_castPath(),ee=requireIsArguments(),te=requireIsArray(),ne=require_isIndex(),oe=requireIsLength(),ie=require_toKey();function _e(se,re,ae){re=t(re,se);for(var ce=-1,de=re.length,ue=!1;++ce<de;){var le=ie(re[ce]);if(!(ue=se!=null&&ae(se,le)))break;se=se[le]}return ue||++ce!=de?ue:(de=se==null?0:se.length,!!de&&oe(de)&&ne(le,de)&&(te(se)||ee(se)))}return _hasPath=_e,_hasPath}var hasIn_1,hasRequiredHasIn;function requireHasIn(){if(hasRequiredHasIn)return hasIn_1;hasRequiredHasIn=1;var t=require_baseHasIn(),ee=require_hasPath();function te(ne,oe){return ne!=null&&ee(ne,oe,t)}return hasIn_1=te,hasIn_1}var _baseMatchesProperty,hasRequired_baseMatchesProperty;function require_baseMatchesProperty(){if(hasRequired_baseMatchesProperty)return _baseMatchesProperty;hasRequired_baseMatchesProperty=1;var t=require_baseIsEqual(),ee=requireGet(),te=requireHasIn(),ne=require_isKey(),oe=require_isStrictComparable(),ie=require_matchesStrictComparable(),_e=require_toKey(),se=1,re=2;function ae(ce,de){return ne(ce)&&oe(de)?ie(_e(ce),de):function(ue){var le=ee(ue,ce);return le===void 0&&le===de?te(ue,ce):t(de,le,se|re)}}return _baseMatchesProperty=ae,_baseMatchesProperty}var _baseProperty,hasRequired_baseProperty;function require_baseProperty(){if(hasRequired_baseProperty)return _baseProperty;hasRequired_baseProperty=1;function t(ee){return function(te){return te==null?void 0:te[ee]}}return _baseProperty=t,_baseProperty}var _basePropertyDeep,hasRequired_basePropertyDeep;function require_basePropertyDeep(){if(hasRequired_basePropertyDeep)return _basePropertyDeep;hasRequired_basePropertyDeep=1;var t=require_baseGet();function ee(te){return function(ne){return t(ne,te)}}return _basePropertyDeep=ee,_basePropertyDeep}var property_1,hasRequiredProperty;function requireProperty(){if(hasRequiredProperty)return property_1;hasRequiredProperty=1;var t=require_baseProperty(),ee=require_basePropertyDeep(),te=require_isKey(),ne=require_toKey();function oe(ie){return te(ie)?t(ne(ie)):ee(ie)}return property_1=oe,property_1}var _baseIteratee,hasRequired_baseIteratee;function require_baseIteratee(){if(hasRequired_baseIteratee)return _baseIteratee;hasRequired_baseIteratee=1;var t=require_baseMatches(),ee=require_baseMatchesProperty(),te=requireIdentity(),ne=requireIsArray(),oe=requireProperty();function ie(_e){return typeof _e=="function"?_e:_e==null?te:typeof _e=="object"?ne(_e)?ee(_e[0],_e[1]):t(_e):oe(_e)}return _baseIteratee=ie,_baseIteratee}var filter_1,hasRequiredFilter;function requireFilter(){if(hasRequiredFilter)return filter_1;hasRequiredFilter=1;var t=require_arrayFilter(),ee=require_baseFilter(),te=require_baseIteratee(),ne=requireIsArray();function oe(ie,_e){var se=ne(ie)?t:ee;return se(ie,te(_e,3))}return filter_1=oe,filter_1}var _baseHas,hasRequired_baseHas;function require_baseHas(){if(hasRequired_baseHas)return _baseHas;hasRequired_baseHas=1;var t=Object.prototype,ee=t.hasOwnProperty;function te(ne,oe){return ne!=null&&ee.call(ne,oe)}return _baseHas=te,_baseHas}var has_1,hasRequiredHas;function requireHas(){if(hasRequiredHas)return has_1;hasRequiredHas=1;var t=require_baseHas(),ee=require_hasPath();function te(ne,oe){return ne!=null&&ee(ne,oe,t)}return has_1=te,has_1}var isEmpty_1,hasRequiredIsEmpty;function requireIsEmpty(){if(hasRequiredIsEmpty)return isEmpty_1;hasRequiredIsEmpty=1;var t=require_baseKeys(),ee=require_getTag(),te=requireIsArguments(),ne=requireIsArray(),oe=requireIsArrayLike(),ie=requireIsBuffer(),_e=require_isPrototype(),se=requireIsTypedArray(),re="[object Map]",ae="[object Set]",ce=Object.prototype,de=ce.hasOwnProperty;function ue(le){if(le==null)return!0;if(oe(le)&&(ne(le)||typeof le=="string"||typeof le.splice=="function"||ie(le)||se(le)||te(le)))return!le.length;var pe=ee(le);if(pe==re||pe==ae)return!le.size;if(_e(le))return!t(le).length;for(var me in le)if(de.call(le,me))return!1;return!0}return isEmpty_1=ue,isEmpty_1}var isUndefined_1,hasRequiredIsUndefined;function requireIsUndefined(){if(hasRequiredIsUndefined)return isUndefined_1;hasRequiredIsUndefined=1;function t(ee){return ee===void 0}return isUndefined_1=t,isUndefined_1}var _baseMap,hasRequired_baseMap;function require_baseMap(){if(hasRequired_baseMap)return _baseMap;hasRequired_baseMap=1;var t=require_baseEach(),ee=requireIsArrayLike();function te(ne,oe){var ie=-1,_e=ee(ne)?Array(ne.length):[];return t(ne,function(se,re,ae){_e[++ie]=oe(se,re,ae)}),_e}return _baseMap=te,_baseMap}var map_1,hasRequiredMap;function requireMap(){if(hasRequiredMap)return map_1;hasRequiredMap=1;var t=require_arrayMap(),ee=require_baseIteratee(),te=require_baseMap(),ne=requireIsArray();function oe(ie,_e){var se=ne(ie)?t:te;return se(ie,ee(_e,3))}return map_1=oe,map_1}var _arrayReduce,hasRequired_arrayReduce;function require_arrayReduce(){if(hasRequired_arrayReduce)return _arrayReduce;hasRequired_arrayReduce=1;function t(ee,te,ne,oe){var ie=-1,_e=ee==null?0:ee.length;for(oe&&_e&&(ne=ee[++ie]);++ie<_e;)ne=te(ne,ee[ie],ie,ee);return ne}return _arrayReduce=t,_arrayReduce}var _baseReduce,hasRequired_baseReduce;function require_baseReduce(){if(hasRequired_baseReduce)return _baseReduce;hasRequired_baseReduce=1;function t(ee,te,ne,oe,ie){return ie(ee,function(_e,se,re){ne=oe?(oe=!1,_e):te(ne,_e,se,re)}),ne}return _baseReduce=t,_baseReduce}var reduce_1,hasRequiredReduce;function requireReduce(){if(hasRequiredReduce)return reduce_1;hasRequiredReduce=1;var t=require_arrayReduce(),ee=require_baseEach(),te=require_baseIteratee(),ne=require_baseReduce(),oe=requireIsArray();function ie(_e,se,re){var ae=oe(_e)?t:ne,ce=arguments.length<3;return ae(_e,te(se,4),re,ce,ee)}return reduce_1=ie,reduce_1}var isString_1,hasRequiredIsString;function requireIsString(){if(hasRequiredIsString)return isString_1;hasRequiredIsString=1;var t=require_baseGetTag(),ee=requireIsArray(),te=requireIsObjectLike(),ne="[object String]";function oe(ie){return typeof ie=="string"||!ee(ie)&&te(ie)&&t(ie)==ne}return isString_1=oe,isString_1}var _asciiSize,hasRequired_asciiSize;function require_asciiSize(){if(hasRequired_asciiSize)return _asciiSize;hasRequired_asciiSize=1;var t=require_baseProperty(),ee=t("length");return _asciiSize=ee,_asciiSize}var _hasUnicode,hasRequired_hasUnicode;function require_hasUnicode(){if(hasRequired_hasUnicode)return _hasUnicode;hasRequired_hasUnicode=1;var t="\\ud800-\\udfff",ee="\\u0300-\\u036f",te="\\ufe20-\\ufe2f",ne="\\u20d0-\\u20ff",oe=ee+te+ne,ie="\\ufe0e\\ufe0f",_e="\\u200d",se=RegExp("["+_e+t+oe+ie+"]");function re(ae){return se.test(ae)}return _hasUnicode=re,_hasUnicode}var _unicodeSize,hasRequired_unicodeSize;function require_unicodeSize(){if(hasRequired_unicodeSize)return _unicodeSize;hasRequired_unicodeSize=1;var t="\\ud800-\\udfff",ee="\\u0300-\\u036f",te="\\ufe20-\\ufe2f",ne="\\u20d0-\\u20ff",oe=ee+te+ne,ie="\\ufe0e\\ufe0f",_e="["+t+"]",se="["+oe+"]",re="\\ud83c[\\udffb-\\udfff]",ae="(?:"+se+"|"+re+")",ce="[^"+t+"]",de="(?:\\ud83c[\\udde6-\\uddff]){2}",ue="[\\ud800-\\udbff][\\udc00-\\udfff]",le="\\u200d",pe=ae+"?",me="["+ie+"]?",fe="(?:"+le+"(?:"+[ce,de,ue].join("|")+")"+me+pe+")*",ge=me+pe+fe,he="(?:"+[ce+se+"?",se,de,ue,_e].join("|")+")",be=RegExp(re+"(?="+re+")|"+he+ge,"g");function ve(we){for(var ye=be.lastIndex=0;be.test(we);)++ye;return ye}return _unicodeSize=ve,_unicodeSize}var _stringSize,hasRequired_stringSize;function require_stringSize(){if(hasRequired_stringSize)return _stringSize;hasRequired_stringSize=1;var t=require_asciiSize(),ee=require_hasUnicode(),te=require_unicodeSize();function ne(oe){return ee(oe)?te(oe):t(oe)}return _stringSize=ne,_stringSize}var size_1,hasRequiredSize;function requireSize(){if(hasRequiredSize)return size_1;hasRequiredSize=1;var t=require_baseKeys(),ee=require_getTag(),te=requireIsArrayLike(),ne=requireIsString(),oe=require_stringSize(),ie="[object Map]",_e="[object Set]";function se(re){if(re==null)return 0;if(te(re))return ne(re)?oe(re):re.length;var ae=ee(re);return ae==ie||ae==_e?re.size:t(re).length}return size_1=se,size_1}var transform_1,hasRequiredTransform;function requireTransform(){if(hasRequiredTransform)return transform_1;hasRequiredTransform=1;var t=require_arrayEach(),ee=require_baseCreate(),te=require_baseForOwn(),ne=require_baseIteratee(),oe=require_getPrototype(),ie=requireIsArray(),_e=requireIsBuffer(),se=requireIsFunction(),re=requireIsObject(),ae=requireIsTypedArray();function ce(de,ue,le){var pe=ie(de),me=pe||_e(de)||ae(de);if(ue=ne(ue,4),le==null){var fe=de&&de.constructor;me?le=pe?new fe:[]:re(de)?le=se(fe)?ee(oe(de)):{}:le={}}return(me?t:te)(de,function(ge,he,be){return ue(le,ge,he,be)}),le}return transform_1=ce,transform_1}var _isFlattenable,hasRequired_isFlattenable;function require_isFlattenable(){if(hasRequired_isFlattenable)return _isFlattenable;hasRequired_isFlattenable=1;var t=require_Symbol(),ee=requireIsArguments(),te=requireIsArray(),ne=t?t.isConcatSpreadable:void 0;function oe(ie){return te(ie)||ee(ie)||!!(ne&&ie&&ie[ne])}return _isFlattenable=oe,_isFlattenable}var _baseFlatten,hasRequired_baseFlatten;function require_baseFlatten(){if(hasRequired_baseFlatten)return _baseFlatten;hasRequired_baseFlatten=1;var t=require_arrayPush(),ee=require_isFlattenable();function te(ne,oe,ie,_e,se){var re=-1,ae=ne.length;for(ie||(ie=ee),se||(se=[]);++re<ae;){var ce=ne[re];oe>0&&ie(ce)?oe>1?te(ce,oe-1,ie,_e,se):t(se,ce):_e||(se[se.length]=ce)}return se}return _baseFlatten=te,_baseFlatten}var _apply,hasRequired_apply;function require_apply(){if(hasRequired_apply)return _apply;hasRequired_apply=1;function t(ee,te,ne){switch(ne.length){case 0:return ee.call(te);case 1:return ee.call(te,ne[0]);case 2:return ee.call(te,ne[0],ne[1]);case 3:return ee.call(te,ne[0],ne[1],ne[2])}return ee.apply(te,ne)}return _apply=t,_apply}var _overRest,hasRequired_overRest;function require_overRest(){if(hasRequired_overRest)return _overRest;hasRequired_overRest=1;var t=require_apply(),ee=Math.max;function te(ne,oe,ie){return oe=ee(oe===void 0?ne.length-1:oe,0),function(){for(var _e=arguments,se=-1,re=ee(_e.length-oe,0),ae=Array(re);++se<re;)ae[se]=_e[oe+se];se=-1;for(var ce=Array(oe+1);++se<oe;)ce[se]=_e[se];return ce[oe]=ie(ae),t(ne,this,ce)}}return _overRest=te,_overRest}var _baseSetToString,hasRequired_baseSetToString;function require_baseSetToString(){if(hasRequired_baseSetToString)return _baseSetToString;hasRequired_baseSetToString=1;var t=requireConstant(),ee=require_defineProperty(),te=requireIdentity(),ne=ee?function(oe,ie){return ee(oe,"toString",{configurable:!0,enumerable:!1,value:t(ie),writable:!0})}:te;return _baseSetToString=ne,_baseSetToString}var _shortOut,hasRequired_shortOut;function require_shortOut(){if(hasRequired_shortOut)return _shortOut;hasRequired_shortOut=1;var t=800,ee=16,te=Date.now;function ne(oe){var ie=0,_e=0;return function(){var se=te(),re=ee-(se-_e);if(_e=se,re>0){if(++ie>=t)return arguments[0]}else ie=0;return oe.apply(void 0,arguments)}}return _shortOut=ne,_shortOut}var _setToString,hasRequired_setToString;function require_setToString(){if(hasRequired_setToString)return _setToString;hasRequired_setToString=1;var t=require_baseSetToString(),ee=require_shortOut(),te=ee(t);return _setToString=te,_setToString}var _baseRest,hasRequired_baseRest;function require_baseRest(){if(hasRequired_baseRest)return _baseRest;hasRequired_baseRest=1;var t=requireIdentity(),ee=require_overRest(),te=require_setToString();function ne(oe,ie){return te(ee(oe,ie,t),oe+"")}return _baseRest=ne,_baseRest}var _baseFindIndex,hasRequired_baseFindIndex;function require_baseFindIndex(){if(hasRequired_baseFindIndex)return _baseFindIndex;hasRequired_baseFindIndex=1;function t(ee,te,ne,oe){for(var ie=ee.length,_e=ne+(oe?1:-1);oe?_e--:++_e<ie;)if(te(ee[_e],_e,ee))return _e;return-1}return _baseFindIndex=t,_baseFindIndex}var _baseIsNaN,hasRequired_baseIsNaN;function require_baseIsNaN(){if(hasRequired_baseIsNaN)return _baseIsNaN;hasRequired_baseIsNaN=1;function t(ee){return ee!==ee}return _baseIsNaN=t,_baseIsNaN}var _strictIndexOf,hasRequired_strictIndexOf;function require_strictIndexOf(){if(hasRequired_strictIndexOf)return _strictIndexOf;hasRequired_strictIndexOf=1;function t(ee,te,ne){for(var oe=ne-1,ie=ee.length;++oe<ie;)if(ee[oe]===te)return oe;return-1}return _strictIndexOf=t,_strictIndexOf}var _baseIndexOf,hasRequired_baseIndexOf;function require_baseIndexOf(){if(hasRequired_baseIndexOf)return _baseIndexOf;hasRequired_baseIndexOf=1;var t=require_baseFindIndex(),ee=require_baseIsNaN(),te=require_strictIndexOf();function ne(oe,ie,_e){return ie===ie?te(oe,ie,_e):t(oe,ee,_e)}return _baseIndexOf=ne,_baseIndexOf}var _arrayIncludes,hasRequired_arrayIncludes;function require_arrayIncludes(){if(hasRequired_arrayIncludes)return _arrayIncludes;hasRequired_arrayIncludes=1;var t=require_baseIndexOf();function ee(te,ne){var oe=te==null?0:te.length;return!!oe&&t(te,ne,0)>-1}return _arrayIncludes=ee,_arrayIncludes}var _arrayIncludesWith,hasRequired_arrayIncludesWith;function require_arrayIncludesWith(){if(hasRequired_arrayIncludesWith)return _arrayIncludesWith;hasRequired_arrayIncludesWith=1;function t(ee,te,ne){for(var oe=-1,ie=ee==null?0:ee.length;++oe<ie;)if(ne(te,ee[oe]))return!0;return!1}return _arrayIncludesWith=t,_arrayIncludesWith}var noop_1,hasRequiredNoop;function requireNoop(){if(hasRequiredNoop)return noop_1;hasRequiredNoop=1;function t(){}return noop_1=t,noop_1}var _createSet,hasRequired_createSet;function require_createSet(){if(hasRequired_createSet)return _createSet;hasRequired_createSet=1;var t=require_Set(),ee=requireNoop(),te=require_setToArray(),ne=1/0,oe=t&&1/te(new t([,-0]))[1]==ne?function(ie){return new t(ie)}:ee;return _createSet=oe,_createSet}var _baseUniq,hasRequired_baseUniq;function require_baseUniq(){if(hasRequired_baseUniq)return _baseUniq;hasRequired_baseUniq=1;var t=require_SetCache(),ee=require_arrayIncludes(),te=require_arrayIncludesWith(),ne=require_cacheHas(),oe=require_createSet(),ie=require_setToArray(),_e=200;function se(re,ae,ce){var de=-1,ue=ee,le=re.length,pe=!0,me=[],fe=me;if(ce)pe=!1,ue=te;else if(le>=_e){var ge=ae?null:oe(re);if(ge)return ie(ge);pe=!1,ue=ne,fe=new t}else fe=ae?[]:me;e:for(;++de<le;){var he=re[de],be=ae?ae(he):he;if(he=ce||he!==0?he:0,pe&&be===be){for(var ve=fe.length;ve--;)if(fe[ve]===be)continue e;ae&&fe.push(be),me.push(he)}else ue(fe,be,ce)||(fe!==me&&fe.push(be),me.push(he))}return me}return _baseUniq=se,_baseUniq}var isArrayLikeObject_1,hasRequiredIsArrayLikeObject;function requireIsArrayLikeObject(){if(hasRequiredIsArrayLikeObject)return isArrayLikeObject_1;hasRequiredIsArrayLikeObject=1;var t=requireIsArrayLike(),ee=requireIsObjectLike();function te(ne){return ee(ne)&&t(ne)}return isArrayLikeObject_1=te,isArrayLikeObject_1}var union_1,hasRequiredUnion;function requireUnion(){if(hasRequiredUnion)return union_1;hasRequiredUnion=1;var t=require_baseFlatten(),ee=require_baseRest(),te=require_baseUniq(),ne=requireIsArrayLikeObject(),oe=ee(function(ie){return te(t(ie,1,ne,!0))});return union_1=oe,union_1}var _baseValues,hasRequired_baseValues;function require_baseValues(){if(hasRequired_baseValues)return _baseValues;hasRequired_baseValues=1;var t=require_arrayMap();function ee(te,ne){return t(ne,function(oe){return te[oe]})}return _baseValues=ee,_baseValues}var values_1,hasRequiredValues;function requireValues(){if(hasRequiredValues)return values_1;hasRequiredValues=1;var t=require_baseValues(),ee=requireKeys();function te(ne){return ne==null?[]:t(ne,ee(ne))}return values_1=te,values_1}var lodash;if(typeof commonjsRequire=="function")try{lodash={clone:requireClone(),constant:requireConstant(),each:requireEach(),filter:requireFilter(),has:requireHas(),isArray:requireIsArray(),isEmpty:requireIsEmpty(),isFunction:requireIsFunction(),isUndefined:requireIsUndefined(),keys:requireKeys(),map:requireMap(),reduce:requireReduce(),size:requireSize(),transform:requireTransform(),union:requireUnion(),values:requireValues()}}catch{}lodash||(lodash=window._);var lodash_1=lodash,_$b=lodash_1,graph=Graph$2,DEFAULT_EDGE_NAME="\0",GRAPH_NODE="\0",EDGE_KEY_DELIM="";function Graph$2(t){this._isDirected=_$b.has(t,"directed")?t.directed:!0,this._isMultigraph=_$b.has(t,"multigraph")?t.multigraph:!1,this._isCompound=_$b.has(t,"compound")?t.compound:!1,this._label=void 0,this._defaultNodeLabelFn=_$b.constant(void 0),this._defaultEdgeLabelFn=_$b.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[GRAPH_NODE]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}Graph$2.prototype._nodeCount=0;Graph$2.prototype._edgeCount=0;Graph$2.prototype.isDirected=function(){return this._isDirected};Graph$2.prototype.isMultigraph=function(){return this._isMultigraph};Graph$2.prototype.isCompound=function(){return this._isCompound};Graph$2.prototype.setGraph=function(t){return this._label=t,this};Graph$2.prototype.graph=function(){return this._label};Graph$2.prototype.setDefaultNodeLabel=function(t){return _$b.isFunction(t)||(t=_$b.constant(t)),this._defaultNodeLabelFn=t,this};Graph$2.prototype.nodeCount=function(){return this._nodeCount};Graph$2.prototype.nodes=function(){return _$b.keys(this._nodes)};Graph$2.prototype.sources=function(){var t=this;return _$b.filter(this.nodes(),function(ee){return _$b.isEmpty(t._in[ee])})};Graph$2.prototype.sinks=function(){var t=this;return _$b.filter(this.nodes(),function(ee){return _$b.isEmpty(t._out[ee])})};Graph$2.prototype.setNodes=function(t,ee){var te=arguments,ne=this;return _$b.each(t,function(oe){te.length>1?ne.setNode(oe,ee):ne.setNode(oe)}),this};Graph$2.prototype.setNode=function(t,ee){return _$b.has(this._nodes,t)?(arguments.length>1&&(this._nodes[t]=ee),this):(this._nodes[t]=arguments.length>1?ee:this._defaultNodeLabelFn(t),this._isCompound&&(this._parent[t]=GRAPH_NODE,this._children[t]={},this._children[GRAPH_NODE][t]=!0),this._in[t]={},this._preds[t]={},this._out[t]={},this._sucs[t]={},++this._nodeCount,this)};Graph$2.prototype.node=function(t){return this._nodes[t]};Graph$2.prototype.hasNode=function(t){return _$b.has(this._nodes,t)};Graph$2.prototype.removeNode=function(t){var ee=this;if(_$b.has(this._nodes,t)){var te=function(ne){ee.removeEdge(ee._edgeObjs[ne])};delete this._nodes[t],this._isCompound&&(this._removeFromParentsChildList(t),delete this._parent[t],_$b.each(this.children(t),function(ne){ee.setParent(ne)}),delete this._children[t]),_$b.each(_$b.keys(this._in[t]),te),delete this._in[t],delete this._preds[t],_$b.each(_$b.keys(this._out[t]),te),delete this._out[t],delete this._sucs[t],--this._nodeCount}return this};Graph$2.prototype.setParent=function(t,ee){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(_$b.isUndefined(ee))ee=GRAPH_NODE;else{ee+="";for(var te=ee;!_$b.isUndefined(te);te=this.parent(te))if(te===t)throw new Error("Setting "+ee+" as parent of "+t+" would create a cycle");this.setNode(ee)}return this.setNode(t),this._removeFromParentsChildList(t),this._parent[t]=ee,this._children[ee][t]=!0,this};Graph$2.prototype._removeFromParentsChildList=function(t){delete this._children[this._parent[t]][t]};Graph$2.prototype.parent=function(t){if(this._isCompound){var ee=this._parent[t];if(ee!==GRAPH_NODE)return ee}};Graph$2.prototype.children=function(t){if(_$b.isUndefined(t)&&(t=GRAPH_NODE),this._isCompound){var ee=this._children[t];if(ee)return _$b.keys(ee)}else{if(t===GRAPH_NODE)return this.nodes();if(this.hasNode(t))return[]}};Graph$2.prototype.predecessors=function(t){var ee=this._preds[t];if(ee)return _$b.keys(ee)};Graph$2.prototype.successors=function(t){var ee=this._sucs[t];if(ee)return _$b.keys(ee)};Graph$2.prototype.neighbors=function(t){var ee=this.predecessors(t);if(ee)return _$b.union(ee,this.successors(t))};Graph$2.prototype.isLeaf=function(t){var ee;return this.isDirected()?ee=this.successors(t):ee=this.neighbors(t),ee.length===0};Graph$2.prototype.filterNodes=function(t){var ee=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});ee.setGraph(this.graph());var te=this;_$b.each(this._nodes,function(ie,_e){t(_e)&&ee.setNode(_e,ie)}),_$b.each(this._edgeObjs,function(ie){ee.hasNode(ie.v)&&ee.hasNode(ie.w)&&ee.setEdge(ie,te.edge(ie))});var ne={};function oe(ie){var _e=te.parent(ie);return _e===void 0||ee.hasNode(_e)?(ne[ie]=_e,_e):_e in ne?ne[_e]:oe(_e)}return this._isCompound&&_$b.each(ee.nodes(),function(ie){ee.setParent(ie,oe(ie))}),ee};Graph$2.prototype.setDefaultEdgeLabel=function(t){return _$b.isFunction(t)||(t=_$b.constant(t)),this._defaultEdgeLabelFn=t,this};Graph$2.prototype.edgeCount=function(){return this._edgeCount};Graph$2.prototype.edges=function(){return _$b.values(this._edgeObjs)};Graph$2.prototype.setPath=function(t,ee){var te=this,ne=arguments;return _$b.reduce(t,function(oe,ie){return ne.length>1?te.setEdge(oe,ie,ee):te.setEdge(oe,ie),ie}),this};Graph$2.prototype.setEdge=function(){var t,ee,te,ne,oe=!1,ie=arguments[0];typeof ie=="object"&&ie!==null&&"v"in ie?(t=ie.v,ee=ie.w,te=ie.name,arguments.length===2&&(ne=arguments[1],oe=!0)):(t=ie,ee=arguments[1],te=arguments[3],arguments.length>2&&(ne=arguments[2],oe=!0)),t=""+t,ee=""+ee,_$b.isUndefined(te)||(te=""+te);var _e=edgeArgsToId(this._isDirected,t,ee,te);if(_$b.has(this._edgeLabels,_e))return oe&&(this._edgeLabels[_e]=ne),this;if(!_$b.isUndefined(te)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(t),this.setNode(ee),this._edgeLabels[_e]=oe?ne:this._defaultEdgeLabelFn(t,ee,te);var se=edgeArgsToObj(this._isDirected,t,ee,te);return t=se.v,ee=se.w,Object.freeze(se),this._edgeObjs[_e]=se,incrementOrInitEntry(this._preds[ee],t),incrementOrInitEntry(this._sucs[t],ee),this._in[ee][_e]=se,this._out[t][_e]=se,this._edgeCount++,this};Graph$2.prototype.edge=function(t,ee,te){var ne=arguments.length===1?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,t,ee,te);return this._edgeLabels[ne]};Graph$2.prototype.hasEdge=function(t,ee,te){var ne=arguments.length===1?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,t,ee,te);return _$b.has(this._edgeLabels,ne)};Graph$2.prototype.removeEdge=function(t,ee,te){var ne=arguments.length===1?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,t,ee,te),oe=this._edgeObjs[ne];return oe&&(t=oe.v,ee=oe.w,delete this._edgeLabels[ne],delete this._edgeObjs[ne],decrementOrRemoveEntry(this._preds[ee],t),decrementOrRemoveEntry(this._sucs[t],ee),delete this._in[ee][ne],delete this._out[t][ne],this._edgeCount--),this};Graph$2.prototype.inEdges=function(t,ee){var te=this._in[t];if(te){var ne=_$b.values(te);return ee?_$b.filter(ne,function(oe){return oe.v===ee}):ne}};Graph$2.prototype.outEdges=function(t,ee){var te=this._out[t];if(te){var ne=_$b.values(te);return ee?_$b.filter(ne,function(oe){return oe.w===ee}):ne}};Graph$2.prototype.nodeEdges=function(t,ee){var te=this.inEdges(t,ee);if(te)return te.concat(this.outEdges(t,ee))};function incrementOrInitEntry(t,ee){t[ee]?t[ee]++:t[ee]=1}function decrementOrRemoveEntry(t,ee){--t[ee]||delete t[ee]}function edgeArgsToId(t,ee,te,ne){var oe=""+ee,ie=""+te;if(!t&&oe>ie){var _e=oe;oe=ie,ie=_e}return oe+EDGE_KEY_DELIM+ie+EDGE_KEY_DELIM+(_$b.isUndefined(ne)?DEFAULT_EDGE_NAME:ne)}function edgeArgsToObj(t,ee,te,ne){var oe=""+ee,ie=""+te;if(!t&&oe>ie){var _e=oe;oe=ie,ie=_e}var se={v:oe,w:ie};return ne&&(se.name=ne),se}function edgeObjToId(t,ee){return edgeArgsToId(t,ee.v,ee.w,ee.name)}var version="2.1.8",lib$1={Graph:graph,version},_$a=lodash_1,Graph$1=graph,json={write,read};function write(t){var ee={options:{directed:t.isDirected(),multigraph:t.isMultigraph(),compound:t.isCompound()},nodes:writeNodes(t),edges:writeEdges(t)};return _$a.isUndefined(t.graph())||(ee.value=_$a.clone(t.graph())),ee}function writeNodes(t){return _$a.map(t.nodes(),function(ee){var te=t.node(ee),ne=t.parent(ee),oe={v:ee};return _$a.isUndefined(te)||(oe.value=te),_$a.isUndefined(ne)||(oe.parent=ne),oe})}function writeEdges(t){return _$a.map(t.edges(),function(ee){var te=t.edge(ee),ne={v:ee.v,w:ee.w};return _$a.isUndefined(ee.name)||(ne.name=ee.name),_$a.isUndefined(te)||(ne.value=te),ne})}function read(t){var ee=new Graph$1(t.options).setGraph(t.value);return _$a.each(t.nodes,function(te){ee.setNode(te.v,te.value),te.parent&&ee.setParent(te.v,te.parent)}),_$a.each(t.edges,function(te){ee.setEdge({v:te.v,w:te.w,name:te.name},te.value)}),ee}var _$9=lodash_1,components_1=components;function components(t){var ee={},te=[],ne;function oe(ie){_$9.has(ee,ie)||(ee[ie]=!0,ne.push(ie),_$9.each(t.successors(ie),oe),_$9.each(t.predecessors(ie),oe))}return _$9.each(t.nodes(),function(ie){ne=[],oe(ie),ne.length&&te.push(ne)}),te}var _$8=lodash_1,priorityQueue=PriorityQueue$2;function PriorityQueue$2(){this._arr=[],this._keyIndices={}}PriorityQueue$2.prototype.size=function(){return this._arr.length};PriorityQueue$2.prototype.keys=function(){return this._arr.map(function(t){return t.key})};PriorityQueue$2.prototype.has=function(t){return _$8.has(this._keyIndices,t)};PriorityQueue$2.prototype.priority=function(t){var ee=this._keyIndices[t];if(ee!==void 0)return this._arr[ee].priority};PriorityQueue$2.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key};PriorityQueue$2.prototype.add=function(t,ee){var te=this._keyIndices;if(t=String(t),!_$8.has(te,t)){var ne=this._arr,oe=ne.length;return te[t]=oe,ne.push({key:t,priority:ee}),this._decrease(oe),!0}return!1};PriorityQueue$2.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var t=this._arr.pop();return delete this._keyIndices[t.key],this._heapify(0),t.key};PriorityQueue$2.prototype.decrease=function(t,ee){var te=this._keyIndices[t];if(ee>this._arr[te].priority)throw new Error("New priority is greater than current priority. Key: "+t+" Old: "+this._arr[te].priority+" New: "+ee);this._arr[te].priority=ee,this._decrease(te)};PriorityQueue$2.prototype._heapify=function(t){var ee=this._arr,te=2*t,ne=te+1,oe=t;te<ee.length&&(oe=ee[te].priority<ee[oe].priority?te:oe,ne<ee.length&&(oe=ee[ne].priority<ee[oe].priority?ne:oe),oe!==t&&(this._swap(t,oe),this._heapify(oe)))};PriorityQueue$2.prototype._decrease=function(t){for(var ee=this._arr,te=ee[t].priority,ne;t!==0&&(ne=t>>1,!(ee[ne].priority<te));)this._swap(t,ne),t=ne};PriorityQueue$2.prototype._swap=function(t,ee){var te=this._arr,ne=this._keyIndices,oe=te[t],ie=te[ee];te[t]=ie,te[ee]=oe,ne[ie.key]=t,ne[oe.key]=ee};var _$7=lodash_1,PriorityQueue$1=priorityQueue,dijkstra_1=dijkstra$1,DEFAULT_WEIGHT_FUNC$1=_$7.constant(1);function dijkstra$1(t,ee,te,ne){return runDijkstra(t,String(ee),te||DEFAULT_WEIGHT_FUNC$1,ne||function(oe){return t.outEdges(oe)})}function runDijkstra(t,ee,te,ne){var oe={},ie=new PriorityQueue$1,_e,se,re=function(ae){var ce=ae.v!==_e?ae.v:ae.w,de=oe[ce],ue=te(ae),le=se.distance+ue;if(ue<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+ae+" Weight: "+ue);le<de.distance&&(de.distance=le,de.predecessor=_e,ie.decrease(ce,le))};for(t.nodes().forEach(function(ae){var ce=ae===ee?0:Number.POSITIVE_INFINITY;oe[ae]={distance:ce},ie.add(ae,ce)});ie.size()>0&&(_e=ie.removeMin(),se=oe[_e],se.distance!==Number.POSITIVE_INFINITY);)ne(_e).forEach(re);return oe}var dijkstra=dijkstra_1,_$6=lodash_1,dijkstraAll_1=dijkstraAll;function dijkstraAll(t,ee,te){return _$6.transform(t.nodes(),function(ne,oe){ne[oe]=dijkstra(t,oe,ee,te)},{})}var _$5=lodash_1,tarjan_1=tarjan$1;function tarjan$1(t){var ee=0,te=[],ne={},oe=[];function ie(_e){var se=ne[_e]={onStack:!0,lowlink:ee,index:ee++};if(te.push(_e),t.successors(_e).forEach(function(ce){_$5.has(ne,ce)?ne[ce].onStack&&(se.lowlink=Math.min(se.lowlink,ne[ce].index)):(ie(ce),se.lowlink=Math.min(se.lowlink,ne[ce].lowlink))}),se.lowlink===se.index){var re=[],ae;do ae=te.pop(),ne[ae].onStack=!1,re.push(ae);while(_e!==ae);oe.push(re)}}return t.nodes().forEach(function(_e){_$5.has(ne,_e)||ie(_e)}),oe}var _$4=lodash_1,tarjan=tarjan_1,findCycles_1=findCycles;function findCycles(t){return _$4.filter(tarjan(t),function(ee){return ee.length>1||ee.length===1&&t.hasEdge(ee[0],ee[0])})}var _$3=lodash_1,floydWarshall_1=floydWarshall,DEFAULT_WEIGHT_FUNC=_$3.constant(1);function floydWarshall(t,ee,te){return runFloydWarshall(t,ee||DEFAULT_WEIGHT_FUNC,te||function(ne){return t.outEdges(ne)})}function runFloydWarshall(t,ee,te){var ne={},oe=t.nodes();return oe.forEach(function(ie){ne[ie]={},ne[ie][ie]={distance:0},oe.forEach(function(_e){ie!==_e&&(ne[ie][_e]={distance:Number.POSITIVE_INFINITY})}),te(ie).forEach(function(_e){var se=_e.v===ie?_e.w:_e.v,re=ee(_e);ne[ie][se]={distance:re,predecessor:ie}})}),oe.forEach(function(ie){var _e=ne[ie];oe.forEach(function(se){var re=ne[se];oe.forEach(function(ae){var ce=re[ie],de=_e[ae],ue=re[ae],le=ce.distance+de.distance;le<ue.distance&&(ue.distance=le,ue.predecessor=de.predecessor)})})}),ne}var _$2=lodash_1,topsort_1=topsort$1;topsort$1.CycleException=CycleException;function topsort$1(t){var ee={},te={},ne=[];function oe(ie){if(_$2.has(te,ie))throw new CycleException;_$2.has(ee,ie)||(te[ie]=!0,ee[ie]=!0,_$2.each(t.predecessors(ie),oe),delete te[ie],ne.push(ie))}if(_$2.each(t.sinks(),oe),_$2.size(ee)!==t.nodeCount())throw new CycleException;return ne}function CycleException(){}CycleException.prototype=new Error;var topsort=topsort_1,isAcyclic_1=isAcyclic;function isAcyclic(t){try{topsort(t)}catch(ee){if(ee instanceof topsort.CycleException)return!1;throw ee}return!0}var _$1=lodash_1,dfs_1=dfs$2;function dfs$2(t,ee,te){_$1.isArray(ee)||(ee=[ee]);var ne=(t.isDirected()?t.successors:t.neighbors).bind(t),oe=[],ie={};return _$1.each(ee,function(_e){if(!t.hasNode(_e))throw new Error("Graph does not have node: "+_e);doDfs(t,_e,te==="post",ie,ne,oe)}),oe}function doDfs(t,ee,te,ne,oe,ie){_$1.has(ne,ee)||(ne[ee]=!0,te||ie.push(ee),_$1.each(oe(ee),function(_e){doDfs(t,_e,te,ne,oe,ie)}),te&&ie.push(ee))}var dfs$1=dfs_1,postorder_1=postorder;function postorder(t,ee){return dfs$1(t,ee,"post")}var dfs=dfs_1,preorder_1=preorder;function preorder(t,ee){return dfs(t,ee,"pre")}var _=lodash_1,Graph=graph,PriorityQueue=priorityQueue,prim_1=prim;function prim(t,ee){var te=new Graph,ne={},oe=new PriorityQueue,ie;function _e(re){var ae=re.v===ie?re.w:re.v,ce=oe.priority(ae);if(ce!==void 0){var de=ee(re);de<ce&&(ne[ae]=ie,oe.decrease(ae,de))}}if(t.nodeCount()===0)return te;_.each(t.nodes(),function(re){oe.add(re,Number.POSITIVE_INFINITY),te.setNode(re)}),oe.decrease(t.nodes()[0],0);for(var se=!1;oe.size()>0;){if(ie=oe.removeMin(),_.has(ne,ie))te.setEdge(ie,ne[ie]);else{if(se)throw new Error("Input graph is not connected: "+t);se=!0}t.nodeEdges(ie).forEach(_e)}return te}var alg$1={components:components_1,dijkstra:dijkstra_1,dijkstraAll:dijkstraAll_1,findCycles:findCycles_1,floydWarshall:floydWarshall_1,isAcyclic:isAcyclic_1,postorder:postorder_1,preorder:preorder_1,prim:prim_1,tarjan:tarjan_1,topsort:topsort_1},lib=lib$1,graphlib={Graph:lib.Graph,json,alg:alg$1,version:lib.version};const index=getDefaultExportFromCjs(graphlib),GraphLib=_mergeNamespaces({__proto__:null,default:index},[graphlib]),alg=(index||GraphLib).alg;function make_graph(t){const{items:ee,get_id:te,get_head_ids:ne,get_tail_ids:oe}=t,ie=new graphlib.Graph;ee.forEach(se=>ie.setNode(te(se),se));const _e=se=>ie.hasNode(se);return ee.forEach(se=>{const re=te(se);ne(se).filter(_e).forEach(ae=>ie.setEdge(re,ae)),oe(se).filter(_e).forEach(ae=>ie.setEdge(ae,re))}),ie}function find_leaf_group_ids(t){const{graph:ee}=t,te=get_graph_groups({graph:ee}),ne=[];return te.forEach(oe=>{find_leaf_ids(oe).forEach(_e=>{const se=[_e,...find_all_predecessor_ids(ee,_e)];ne.push(se)})}),ne}function get_graph_groups(t){const{graph:ee}=t;return alg.components(ee).map(ne=>{const oe=new graphlib.Graph;return ne.forEach(ie=>{oe.setNode(ie,ee.node(ie)),(ee.nodeEdges(ie)||[]).forEach(se=>oe.setEdge(se))}),oe})}function find_leaf_ids(t){return t.nodes().filter(te=>(t.successors(te)||[]).length===0)}function find_leaf_ids_for_id(t,ee){const te=find_leaf_ids(t),ne=alg.dijkstra(t,ee);return te.filter(oe=>ne[oe].distance<Number.POSITIVE_INFINITY)}function find_all_predecessor_ids(t,ee,te=!1){const ne=t.predecessors(ee)||[],oe=new Set;let ie=ne.pop()||"";for(;ie;){if(!oe.has(ie)&&(te||ie!==ee)){oe.add(ie);const _e=t.predecessors(ie)||[];ne.push(..._e)}ie=ne.pop()||""}return Array.from(oe)}const test_graph_related_functions=describe.delay("graph related functions",()=>{const t=ge=>ge.id,ee=ge=>ge.head_ids,te=ge=>ge.tail_ids,ne=ge=>make_graph({items:ge,get_id:t,get_head_ids:ee,get_tail_ids:te});function oe(ge,he,be){test(ge.node(he),be.item);const ve=ge.outEdges(he)||[];test(ve.map(ye=>ye.w),be.head_ids);const we=ge.inEdges(he)||[];test(we.map(ye=>ye.v),be.tail_ids)}function ie(){const ge=[{id:"1",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function _e(){const ge=[{id:"1",head_ids:["2","4"],tail_ids:[]},{id:"2",head_ids:["1","3"],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function se(){const ge=[{id:"1",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:[],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:["5"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function re(){const ge=[{id:"1",head_ids:[],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["4"],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:["5"],tail_ids:[]},{id:"7",head_ids:["6"],tail_ids:[]},{id:"8",head_ids:["10"],tail_ids:[]},{id:"9",head_ids:["8"],tail_ids:[]},{id:"10",head_ids:["9"],tail_ids:[]},{id:"11",head_ids:["12","13"],tail_ids:["12","13"]},{id:"12",head_ids:["11","13"],tail_ids:["11","13"]},{id:"13",head_ids:["12","11"],tail_ids:["12","11"]},{id:"14",head_ids:["14"],tail_ids:["14"]},{id:"15",head_ids:[],tail_ids:["16"]},{id:"16",head_ids:[],tail_ids:[]},{id:"17",head_ids:["16"],tail_ids:[]},{id:"15b",head_ids:[],tail_ids:[]},{id:"16b",head_ids:["15b"],tail_ids:["17b"]},{id:"17b",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function ae(){const ge=[{id:"4",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["2","1","4","7"],tail_ids:[]},{id:"1",head_ids:["5","6","9"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:[],tail_ids:[]},{id:"7",head_ids:["8"],tail_ids:[]},{id:"8",head_ids:["7"],tail_ids:[]},{id:"9",head_ids:["5"],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function ce(){const ge=[{id:"1",head_ids:["2"],tail_ids:["3"]}],he=ne(ge);return{items:ge,graph:he}}const de=ie(),ue=re(),le=_e(),pe=se(),me=ae(),fe=ce();describe("graph",()=>{oe(de.graph,"0",{item:void 0,head_ids:[],tail_ids:[]}),oe(de.graph,"1",{item:de.items[0],head_ids:[],tail_ids:[]}),oe(ue.graph,"1",{item:ue.items[0],head_ids:[],tail_ids:[]}),oe(ue.graph,"2",{item:ue.items[1],head_ids:["3"],tail_ids:[]}),oe(ue.graph,"3",{item:ue.items[2],head_ids:["4"],tail_ids:["2"]}),oe(ue.graph,"4",{item:ue.items[3],head_ids:[],tail_ids:["3"]}),oe(ue.graph,"5",{item:ue.items[4],head_ids:[],tail_ids:["6"]}),oe(ue.graph,"6",{item:ue.items[5],head_ids:["5"],tail_ids:["7"]}),oe(ue.graph,"7",{item:ue.items[6],head_ids:["6"],tail_ids:[]}),oe(ue.graph,"8",{item:ue.items[7],head_ids:["10"],tail_ids:["9"]}),oe(ue.graph,"9",{item:ue.items[8],head_ids:["8"],tail_ids:["10"]}),oe(ue.graph,"10",{item:ue.items[9],head_ids:["9"],tail_ids:["8"]}),oe(ue.graph,"11",{item:ue.items[10],head_ids:["12","13"],tail_ids:["12","13"]}),oe(ue.graph,"12",{item:ue.items[11],head_ids:["11","13"],tail_ids:["11","13"]}),oe(ue.graph,"13",{item:ue.items[12],head_ids:["11","12"],tail_ids:["11","12"]}),oe(ue.graph,"14",{item:ue.items[13],head_ids:["14"],tail_ids:["14"]}),oe(ue.graph,"15",{item:ue.items[14],head_ids:[],tail_ids:["16"]}),oe(ue.graph,"16",{item:ue.items[15],head_ids:["15"],tail_ids:["17"]}),oe(ue.graph,"17",{item:ue.items[16],head_ids:["16"],tail_ids:[]}),oe(ue.graph,"15b",{item:ue.items[17],head_ids:[],tail_ids:["16b"]}),oe(ue.graph,"16b",{item:ue.items[18],head_ids:["15b"],tail_ids:["17b"]}),oe(ue.graph,"17b",{item:ue.items[19],head_ids:["16b"],tail_ids:[]}),oe(fe.graph,"1",{item:fe.items[0],head_ids:[],tail_ids:[]})}),describe("find_leaf_ids",()=>{test(find_leaf_ids(le.graph),["3","4"]),test(find_leaf_ids(pe.graph),["2","3","5"]),test(find_leaf_ids(me.graph),["5","6"])}),describe("find_leaf_ids_for_id",()=>{test(find_leaf_ids_for_id(me.graph,"12"),[]),test(find_leaf_ids_for_id(me.graph,"1"),["5","6"]),test(find_leaf_ids_for_id(me.graph,"2"),["5","6"]),test(find_leaf_ids_for_id(me.graph,"7"),[])}),describe("find_leaf_group_ids",()=>{test(find_leaf_group_ids(de),[["1"]]),test(find_leaf_group_ids(le),[["3","2","1"],["4","1","2"]])}),describe("find_all_predecessor_ids",()=>{test(find_all_predecessor_ids(de.graph,"1"),[]),test(find_all_predecessor_ids(le.graph,"1"),["2"]),test(find_all_predecessor_ids(le.graph,"2"),["1"]),test(find_all_predecessor_ids(le.graph,"3"),["2","1"]),test(find_all_predecessor_ids(le.graph,"4"),["1","2"]),test(find_all_predecessor_ids(me.graph,"2"),["4","3"]),test(find_all_predecessor_ids(me.graph,"8"),["7","3","2","4"]),test(find_all_predecessor_ids(me.graph,"5"),["9","1","3","2","4"])})}),test_stable_stringify=describe.delay("stable_stringify",()=>{let t="";t=stable_stringify({a:1,b:2,c:3}),test(t,'{"a":1,"b":2,"c":3}',"regular object"),t=stable_stringify({c:3,b:2,a:1}),test(t,'{"c":3,"b":2,"a":1}',"regular object with keys in reverse order remains unchanged by default"),t=stable_stringify({c:3,b:2,a:1},{sort_items:!0}),test(t,'{"a":1,"b":2,"c":3}',"regular object with keys in reverse order are sorted if requested"),t=stable_stringify({a:{b:{c:3}}}),test(t,'{"a":{"b":{"c":3}}}',"nested object"),t=stable_stringify({a:void 0}),test(t,"{}","object with undefined not rendered by default"),t=stable_stringify({a:void 0},{render_undefined:!0}),test(t,'{"a":undefined}',"object with undefined rendered when render_undefined is true")}),run_get_rich_text_tests=describe.delay("run_get_rich_text_tests",()=>{let t;describe("replace_ids_in_text",()=>{const ee=uuid_v4_for_tests(1),te=uuid_v4_for_tests(2),ne=uuid_v4_for_tests(3),ie=new Date("2021-05-12").getTime(),_e={use_creation_context:!1,creation_context:{label_ids:[]}},se={[ee]:prepare_new_wcomponent_object({base_id:-1,id:ee,title:`@@${ne} was told @@${te} is here`},_e),[te]:prepare_new_wcomponent_object({base_id:-1,id:te,title:"Person A"},_e),[ne]:prepare_new_wcomponent_object({base_id:-1,id:ne,title:"Person B"},_e)},re={},ae={text_type:RichTextType.rich,wcomponents_by_id:se,knowledge_views_by_id:re,wc_id_to_counterfactuals_map:void 0,created_at_ms:ie,sim_ms:ie};t=replace_ids_in_text({...ae,text_type:RichTextType.raw,text:`Yesterday @@${ee} today`}),test(t,`Yesterday @@${ee} today`,"Should not replace ids when text_type is RichTextType.raw"),t=replace_ids_in_text({...ae,text_type:RichTextType.plain,text:`Yesterday @@${ee} today`}),test(t,"Yesterday Person B was told Person A is here today","Should replace ids with only text and no links when text_type is RichTextType.plain"),t=replace_ids_in_text({...ae,text_type:RichTextType.rich,text:`Yesterday @@${ee} today`}),test(t,`Yesterday [Person B was told Person A is here](#wcomponents/${ee}) today`,"Should replace ids with text and links when text_type is RichTextType.rich.  And should not render lower depth links so as not to have nested broken links.")}),describe("get_title",()=>{const ee=new Date("2021-05-12"),te=ee.getTime(),ne={use_creation_context:!1,creation_context:{label_ids:[]}},oe=Se=>{const Te={id:"vps"+Se.id,created_at:ee,base_id:-1,datetime:{},entries:[{id:"VAP"+Se.id,explanation:"",probability:1,conviction:1,value:"",description:""}]};return prepare_new_wcomponent_object({...Se,base_id:-1,type:"statev2",subtype:"boolean",values_and_prediction_sets:[Te]},ne)},ie=uuid_v4_for_tests(1),_e=uuid_v4_for_tests(2),se=uuid_v4_for_tests(3),re=uuid_v4_for_tests(4),ae=uuid_v4_for_tests(5),ce=uuid_v4_for_tests(6),de=uuid_v4_for_tests(7),ue=uuid_v4_for_tests(8),le=uuid_v4_for_tests(9),pe=oe({id:ie,title:"aaa"}),me=oe({id:_e,title:`bbb @@${ie}`}),fe=oe({id:se,title:"ccc ${value}"}),ge=oe({id:re,title:`ddd @@${se}`}),he=oe({id:ae,title:`eee \${value} @@${re}`}),be=oe({id:ce,title:`fff @@${ae}`}),ve=oe({id:de,title:`ggg @@${ce}`}),we=oe({id:ue,title:`Recursive @@${ue}`}),ye=oe({id:le,title:`Recursive @@${le}.title`}),ke={[pe.id]:pe,[me.id]:me,[fe.id]:fe,[ge.id]:ge,[he.id]:he,[be.id]:be,[ve.id]:ve,[we.id]:we,[ye.id]:ye},Ae={};function $e(Se){const{id:Te,text_type:xe,wc_id_to_counterfactuals_map:Ie}=Se;return get_title$1({text_type:xe,wcomponents_by_id:ke,knowledge_views_by_id:Ae,wcomponent:ke[Te],wc_id_to_counterfactuals_map:Ie,created_at_ms:te,sim_ms:te})}describe("get_title",()=>{const Se={[pe.id]:"aaa",[me.id]:`bbb @@${ie}`,[fe.id]:"ccc ${value}",[ge.id]:`ddd @@${se}`,[he.id]:`eee \${value} @@${re}`},Te={[pe.id]:"aaa",[me.id]:"bbb aaa",[fe.id]:"ccc True",[ge.id]:"ddd ccc True",[he.id]:"eee True ddd ccc True"},xe={[pe.id]:"aaa",[me.id]:`bbb [aaa](#wcomponents/${ie})`,[fe.id]:"ccc True",[ge.id]:`ddd [ccc True](#wcomponents/${se})`,[he.id]:`eee True [ddd ccc True](#wcomponents/${re})`};Object.entries(Se).forEach(([Ie,Pe])=>{t=$e({id:Ie,text_type:RichTextType.raw}),test(t,Pe)}),Object.entries(Te).forEach(([Ie,Pe])=>{t=$e({id:Ie,text_type:RichTextType.plain}),test(t,Pe)}),Object.entries(xe).forEach(([Ie,Pe])=>{t=$e({id:Ie,text_type:RichTextType.rich}),test(t,Pe)})}),describe("depth_limit",()=>{t=$e({id:ve.id,text_type:RichTextType.rich}),test(t,`ggg [fff eee True ddd @@${se}](#wcomponents/${ce})`,"Should stop recursively rendering ids when a depth limit is reached"),t=$e({id:we.id,text_type:RichTextType.rich}),test(t,"Recursive [Recursive Recursive Recursive @@80000000-0000-4000-a000-000000000000](#wcomponents/80000000-0000-4000-a000-000000000000)","Should handle recursion for normal recursive titles."),t=$e({id:ye.id,text_type:RichTextType.rich}),test(!0,!0,"Should handle recursion for '.title' functional ids of recursive titles.")}),describe("counterfactuals",()=>{const Se={[fe.id]:"ccc False",[ge.id]:`ddd [ccc False](#wcomponents/${se})`,[he.id]:`eee True [ddd ccc False](#wcomponents/${re})`},Te={[fe.id]:{VAP_sets:{[`vps${se}`]:[{id:"wc999000",type:"counterfactualv2",created_at:ee,base_id:-1,title:"",description:"",target_wcomponent_id:fe.id,target_VAP_set_id:`vps${se}`,target_VAP_id:VAP_visual_false_id}]}}};Object.entries(Se).forEach(([xe,Ie])=>{t=$e({id:xe,text_type:RichTextType.rich,wc_id_to_counterfactuals_map:Te}),test(t,Ie,"Should override values correctly using counterfactualv2 value")})})}),describe.skip("replace_ids_in_text -> replace_calculations_with_results",()=>{const ee=uuid_v4_for_tests(1),ne=new Date("2023-08-14").getTime(),oe={use_creation_context:!1,creation_context:{label_ids:[]}},ie={[ee]:prepare_new_wcomponent_object({base_id:-1,id:ee,title:"UK Homes"},oe)},_e={},se={text_type:RichTextType.rich,wcomponents_by_id:ie,knowledge_views_by_id:_e,wc_id_to_counterfactuals_map:void 0,created_at_ms:ne,sim_ms:ne};let ae=replace_ids_in_text({...se,text:`
    $$!
    value: 123
    $$!
    `});test(ae,`
123
`,"Should replace calculation with string value")})}),run_remove_rich_text_tests=describe.delay("remove_rich_text",()=>{let t,ee,te;t="Something [linked](http://example.com).",ee=remove_rich_text(t),te="Something linked.",test(ee,te,"Should remove links in middle"),t="[Linked](http://example.com) here.",ee=remove_rich_text(t),te="Linked here.",test(ee,te,"Should remove links at start"),t="[Linked](http://example.com) here and [here](https://other.example.com)",ee=remove_rich_text(t),te="Linked here and here",test(ee,te,"Should remove multiple links at start"),t="<auto generated>Text with <auto generated> in it <auto generated>",ee=remove_rich_text(t),te="Text with in it",test(ee,te,"Should remove <auto generated> tags"),t="Italicised <i>text<i/>",ee=remove_rich_text(t),te="Italicised text",test(ee,te,"Should remove tags")}),run_replace_normal_ids_tests=describe.delay("replace_normal_ids",()=>{let t="",ee="",te="";const ne=uuid_v4_for_tests(1),oe=uuid_v4_for_tests(9),ie={use_creation_context:!1,creation_context:{label_ids:[]}},_e={[ne]:prepare_new_wcomponent_object({base_id:-1,id:ne,title:"Title 1"},ie)};let se;describe("render_links: true",()=>{se={wcomponents_by_id:_e,depth_limit:2,render_links:!0,root_url:"http://datacurator.org",get_title:re=>re.title},t="",te="",ee=replace_normal_ids(t,1,se),test(ee,te,"Should handle replacing ids in empty string"),t=`Some text
    with an @@id in
    it: @@${ne}.
    `,te=`Some text
    with an @@id in
    it: [Title 1](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).
    `,ee=replace_normal_ids(t,1,se),test(ee,te,"Should replace id with component title"),t=`An @@id to a component that's not found: @@${oe}.`,te="An @@id to a component that's not found: ✗[@@90000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/90000000-0000-4000-a000-000000000000) (not found).",ee=replace_normal_ids(t,1,se),test(ee,te,"Should handle missing components"),t=`Out of depth @@${ne}.`,te="Out of depth [@@10000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).",ee=replace_normal_ids(t,2,se),test(ee,te,"Should not replace with component title when depth is exceeded")}),describe("render_links: false",()=>{se={wcomponents_by_id:_e,depth_limit:2,render_links:!1,root_url:"http://datacurator.org",get_title:re=>re.title},t=`Some @@id: @@${ne}.`,te="Some @@id: Title 1.",ee=replace_normal_ids(t,1,se),test(ee,te,"Should replace id with component title but no link when render_links is false"),t=`An @@id to a component that's not found: @@${oe}.`,te="An @@id to a component that's not found: ✗@@90000000-0000-4000-a000-000000000000 (not found).",ee=replace_normal_ids(t,1,se),test(ee,te,"Should handle missing components but not add link when render_links is false"),t=`Out of depth @@${ne}.`,te="Out of depth @@10000000-0000-4000-a000-000000000000.",ee=replace_normal_ids(t,2,se),test(ee,te,"Should not replace with component title when depth is exceeded and not add link when render_links is false")})}),test_get_ids_from_text=describe.delay("get_ids_from_text",()=>{let t=[];t=get_double_at_mentioned_uuids_from_text(""),test(t,[],"Should find no IDs in empty string"),t=get_double_at_mentioned_uuids_from_text("asd @@wc123 asd name@example.com #label dfg @@345 sf"),test(t,[],'Should not find old ids of "wc123", "345"');const ee=uuid_v4_for_tests(1),te=uuid_v4_for_tests(2);t=get_double_at_mentioned_uuids_from_text(`asd @@${ee} asd name@example.com #label dfg @@${te} sf`),test(t,[ee,te],"Should find uuid ids")}),test_derived_composed_wcomponents_by_id_reducer=describe.delay("derived_composed_wcomponents_by_id_reducer",()=>{const t=new Date("2023-10-05"),ee=new Date("2023-10-06"),te=new Date("2023-10-07"),ne=uuid_v4_for_tests(1),oe=uuid_v4_for_tests(2),ie=uuid_v4_for_tests(3);let _e,se,re,ae,ce,de;function ue(me){return prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",...me})}function le(me){return prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",...me})}function pe(me,fe,ge){let he=get_starting_state$1(!1);const be=get_new_knowledge_view_object({base_id:-1,id:ie,title:"Test KV",sort_type:"priority"},{});return he=root_reducer$1(he,ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:be})),he=root_reducer$1(he,ACTIONS.routing.change_route({args:{view:"knowledge",subview_id:be.id}})),he=root_reducer$1(he,ACTIONS.specialised_object.upsert_wcomponent({wcomponent:me,add_to_knowledge_view:{id:be.id,position:{left:0,top:0}}})),he=root_reducer$1(he,ACTIONS.specialised_object.upsert_wcomponent({wcomponent:fe,add_to_knowledge_view:{id:be.id,position:{left:300,top:0}}})),ge&&(he=root_reducer$1(he,ACTIONS.routing.change_route({args:{created_at_datetime:ge}}))),he}se=ue({id:oe,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:ee,entries:[],datetime:{}}]}),re=le({id:ne,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:ee,entries:[],datetime:{}}],attribute_wcomponent_id:se.id}),describe("state_value VAPs should be composed into statev2 wcomponent",()=>{var me;_e=pe(se,re,te),ae=_e.derived.composed_wcomponents_by_id,ce=ae[se.id],de=(ce==null?void 0:ce.values_and_prediction_sets)||[],test((me=de[0])==null?void 0:me.id,"vps22222","The composed wcomponent should have VAP sets from the state value component that targets it"),test(ce==null?void 0:ce._derived__using_value_from_wcomponent_id,re.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set to the state_value's ID")}),describe("Components created after current created_at datetime are still present in composed_wcomponents_by_id",()=>{_e=pe(se,re,t),ae=_e.derived.composed_wcomponents_by_id,test(se.created_at.getTime()>_e.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_statev2 wcomponent based on its created_at"),test(re.created_at.getTime()>_e.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_state_value wcomponent based on its created_at"),test(new Set(Object.keys(ae)),new Set([ne,oe]),"derived.composed_wcomponents_by_id should still contain the components when the created_at filter is set to before the created_at of the two components")}),describe("state_value created after statev2 and filtered out by created_at datetime",()=>{var me;se=ue({id:oe,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:ee,entries:[],datetime:{}}]}),re=le({id:ne,created_at:te,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:te,entries:[],datetime:{}}],attribute_wcomponent_id:se.id}),_e=pe(se,re,ee),ae=_e.derived.composed_wcomponents_by_id,ce=ae[se.id],de=(ce==null?void 0:ce.values_and_prediction_sets)||[],test((me=de[0])==null?void 0:me.id,"vps1","The composed wcomponent should have VAP sets from the original statev2 component as the state_value that targets it should be filtered out based on created_at time"),test(ce==null?void 0:ce._derived__using_value_from_wcomponent_id,void 0,"The composed wcomponent should NOT have _derived__using_value_from_wcomponent_id set")}),describe("state_value VAPs filtered out by created_at datetime",()=>{se=ue({id:oe,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:ee,entries:[],datetime:{}}]}),re=le({id:ne,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:te,entries:[],datetime:{}}],attribute_wcomponent_id:se.id}),_e=pe(se,re,ee),ae=_e.derived.composed_wcomponents_by_id,ce=ae[se.id],de=(ce==null?void 0:ce.values_and_prediction_sets)||[],test(de.length,0,"The composed wcomponent should have VAP sets from the state_value component that targets it but these VAPs should be filtered out based on created_at time"),test(ce==null?void 0:ce._derived__using_value_from_wcomponent_id,re.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set")})}),test_get_composed_wcomponents_by_id=describe.delay("get_composed_wcomponents_by_id",()=>{var re;const ee=new Date("2024-10-08"),te={use_creation_context:!0,creation_context:{custom_created_at:ee,label_ids:[]}},ne=prepare_new_contextless_wcomponent_object({type:"statev2",base_id:-1,values_and_prediction_sets:[prepare_new_VAP_set(VAPsType.number,{1:{id:"1",order:1,value:"10",description:""}},[],-1,te)]}),oe=prepare_new_contextless_wcomponent_object({type:"state_value",base_id:-1,values_and_prediction_sets:[prepare_new_VAP_set(VAPsType.number,{2:{id:"2",order:1,value:"20",description:""}},[],-1,te)],attribute_wcomponent_id:ne.id});let _e=get_composed_wcomponents_by_id({wcomponents_by_id:{[ne.id]:ne,[oe.id]:oe},composed_visible_wc_id_map:{[ne.id]:{left:0,top:0},[oe.id]:{left:0,top:0}},created_at_ms:ee.getTime()})[ne.id];if(!wcomponent_is_statev2(_e))throw new Error("Expected composed wcomponent to be statev2");test(_e._derived__using_value_from_wcomponent_id,oe.id,"should populate the _derived__using_value_from_wcomponent_id field of the statev2 with the id of the state_value component that is targeting it.");let se=(_e.values_and_prediction_sets||[])[0];test((re=se==null?void 0:se.entries[0])==null?void 0:re.value,"20","should replace the VAP set of a statev2 with the VAP set of the state_value component that is targeting it.")}),test_calc_if_wcomponent_should_exclude_because_label_or_type=describe.delay("calc_if_wcomponent_should_exclude_because_label_or_type",()=>{const t=prepare_new_contextless_wcomponent_object({id:"1",base_id:1}),ee=prepare_new_contextless_wcomponent_object({id:"2",base_id:1,label_ids:[t.id]}),te=prepare_new_contextless_wcomponent_object({id:"3",base_id:1,label_ids:[]}),ne={exclude_by_label_ids:new Set,include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},oe={exclude_by_label_ids:new Set([t.id]),include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},ie={exclude_by_label_ids:new Set,include_by_label_ids:new Set([t.id]),exclude_by_component_types:new Set,include_by_component_types:new Set},_e={exclude_by_label_ids:new Set([t.id]),include_by_label_ids:new Set([t.id]),exclude_by_component_types:new Set,include_by_component_types:new Set};let{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,ne);test(se,!1),test(re,!1),{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,oe),test(se,!0),test(re,!1),{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,ie),test(se,!1),test(re,!1),{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(te,ie),test(se,!1),test(re,!0),{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,_e),test(se,!0),test(re,!1),{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(t,oe),test(se,!0),test(re,!1),{should_exclude:se,lacks_include:re}=calc_if_wcomponent_should_exclude_because_label_or_type(t,ie),test(se,!1),test(re,!1)}),wcomponent_id=uuid_v4_for_tests(1);function test_helper__make_knowledge_view$1(t,ee,te){const oe={id:ee,foundation_knowledge_view_ids:te?[te]:void 0,wc_id_map:{},title:"",description:"",sort_type:"normal",created_at:new Date("2023-03-22 15:15:00"),base_id:1,goal_ids:[]};return t&&(oe.wc_id_map[wcomponent_id]=t),oe}const run_get_composed_wc_id_maps_object_tests=describe.delay("get_composed_wc_id_maps_object",()=>{const t=new Date("2023-03-22 15:15:00");let ee,te;ee=get_composed_wc_id_maps_object([],{}),te={composed_wc_id_map:{},composed_blocked_wc_id_map:{}},test(ee,te);const ne=[{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, defined in foundation, ",test_description_part2:"should return entry in foundation"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"missing in current, blocked in foundation, ",test_description_part2:"should return entry in blocked"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, missing in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, defined in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, passthrough in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, blocked in foundation, ",test_description_part2:"should return entry in current not foundation and NOT show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, defined in foundation, ",test_description_part2:"should return (passthrough) entry from foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"passthrough entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, missing in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, defined in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"}];ne.forEach(oe=>{const ie=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_foundation_kv,"kv1"),_e=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_current_kv,"kv2","kv1");ee=get_composed_wc_id_maps_object([ie,_e],{}),test(ee.composed_wc_id_map[wcomponent_id],oe.expected_result_in_composed_wc_id_map,"composed_wc_id_map "+oe.test_description+oe.test_description_part2),test(ee.composed_blocked_wc_id_map[wcomponent_id],oe.expected_result_in_composed_blocked_wc_id_map,"composed_blocked_wc_id_map "+oe.test_description+oe.test_description_part2)}),describe("deleted wcomponent",()=>{ne.forEach(oe=>{const ie=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_foundation_kv,"kv1"),_e=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_current_kv,"kv2","kv1");ee=get_composed_wc_id_maps_object([ie,_e],{[wcomponent_id]:{id:wcomponent_id,deleted_at:t,type:"statev2",title:"",description:"",created_at:t,base_id:1}}),test(ee.composed_wc_id_map[wcomponent_id],void 0,"composed_wc_id_map "+oe.test_description+"should not return any entry"),test(ee.composed_blocked_wc_id_map[wcomponent_id],void 0,"composed_blocked_wc_id_map "+oe.test_description+"should not return any entry")})})}),test_knowledge_views_derived_reducer=describe.delay("knowledge_views_derived_reducer",()=>{describe("calculate_wc_ids_to_exclude_based_on_filters",()=>{let t={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""},ee=new Set;const te=prepare_new_contextless_wcomponent_object({id:"node1",base_id:-1,type:"statev2",label_ids:[]}),ne=prepare_new_contextless_wcomponent_object({id:"node2",base_id:-1,type:"statev2",label_ids:["123"]}),oe=[te,ne],ie=prepare_new_contextless_wcomponent_object({id:"link1_no_label",base_id:-1,type:"causal_link",label_ids:[],from_id:te.id,to_id:ne.id}),_e=prepare_new_contextless_wcomponent_object({id:"link2_no_label_no_from",base_id:-1,type:"causal_link",label_ids:[],from_id:te.id,to_id:ne.id}),se=prepare_new_contextless_wcomponent_object({id:"link3_no_label_no_to",base_id:-1,type:"causal_link",label_ids:[],from_id:te.id,to_id:ne.id}),re=prepare_new_contextless_wcomponent_object({id:"link4_has_label",base_id:-1,type:"causal_link",label_ids:["123"],from_id:te.id,to_id:ne.id}),ae=prepare_new_contextless_wcomponent_object({id:"link5_has_label_no_from",base_id:-1,type:"causal_link",label_ids:["123"],from_id:void 0,to_id:ne.id}),ce=prepare_new_contextless_wcomponent_object({id:"link6_has_label_no_to",base_id:-1,type:"causal_link",label_ids:["123"],from_id:ne.id,to_id:void 0}),de=[ie,_e,se,re,ae,ce];let ue=calculate_wc_ids_to_exclude_based_on_filters(t,ee,oe,de);test(ue,new Set,"no filters"),t.include_by_label_ids=["123"],ue=calculate_wc_ids_to_exclude_based_on_filters(t,ee,oe,de),test(ue,new Set([te.id,ie.id,_e.id,se.id,re.id]),"filter out components not labelled")})}),run_specialised_objects_accessors_tests=describe.delay("specialised_objects accessors tests",()=>{describe("get_current_temporal_value_certainty_from_wcomponent",()=>{const t=new Date("2023-10-09"),ee=new Date("2023-10-10");let te,ne,oe,ie;function _e(se,re){const ae=prepare_new_contextless_wcomponent_object({base_id:-1,created_at:t,type:"statev2",values_and_prediction_sets:se}),ce={[ae.id]:ae};return get_current_temporal_value_certainty_from_wcomponent(ae.id,ce,re)}ne=t.getTime(),oe=_e(void 0,ne),ie=void 0,test(oe,ie,"No VAP sets should result in undefined value"),ne=t.getTime(),oe=_e([],ne),ie=void 0,test(oe,ie,"Empty VAP sets should result in undefined value"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}],oe=_e(te,ne),ie={certainty:void 0,temporal_uncertainty:{}},test(oe,ie,"VAP sets with one VAPset should result in that VAP set's empty datetime being returned"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{value:ee}}],oe=_e(te,ne),ie={certainty:void 0,temporal_uncertainty:{value:ee}},test(oe,ie,"VAP sets with one VAPset should result in that VAP set's datetime and value being returned"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:ee,datetime:{},entries:[]}],oe=_e(te,ne),ie=void 0,test.skip(oe,ie,"VAP sets with one VAPset created after current created_at should return undefined"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,datetime:{value:ee},entries:[{id:"",description:"",value:"",explanation:"",probability:1,conviction:1}]}],oe=_e(te,ne),ie={certainty:1,temporal_uncertainty:{value:ee}},test(oe,ie,"VAP sets with one VAPset with an 100% probable & confident (conviction) entry should be 100% certain"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,datetime:{value:ee},entries:[{id:"",description:"",value:"",explanation:"",probability:.5,conviction:.5},{id:"",description:"",value:"",explanation:"",probability:.9,conviction:.9}]}],oe=_e(te,ne),ie={certainty:.81,temporal_uncertainty:{value:ee}},test(oe,ie,"VAP sets with one VAPset with two entries should take highest certainty")})}),test_tidy_wcomponent=describe.delay("tidy_wcomponent",()=>{const ee=new Date("2021-05-12"),te=new Date("2021-05-13"),ne={use_creation_context:!1,creation_context:{label_ids:[]}};let oe,ie,_e,se,re={};const ae=-1;oe=prepare_new_wcomponent_object({base_id:ae,type:"statev2",subtype:"other"},ne),oe.values_and_prediction_sets=[{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),id:"vps2",created_at:te,custom_created_at:void 0},{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),id:"vps1",created_at:ee,custom_created_at:void 0}],_e=tidy_wcomponent(oe,re),test(_e.values_and_prediction_sets.map(({id:de})=>de),["vps1","vps2"],"",!1),oe=prepare_new_wcomponent_object({base_id:ae,type:"statev2",subtype:"other"},ne),ie=[{...prepare_new_VAP(),id:"VAP1",relative_probability:5},{...prepare_new_VAP(),id:"VAP2",relative_probability:0}],oe.values_and_prediction_sets=[{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),entries:ie}],_e=tidy_wcomponent(oe,re),test(_e.values_and_prediction_sets[0].entries.map(({probability:de})=>de),[1,0],"",!1),oe={...oe,subtype:"boolean"},_e=tidy_wcomponent(oe,re),se=_e.values_and_prediction_sets[0].entries,test(se.map(({relative_probability:de})=>de),[5,0],"",!1),test(se.map(({probability:de})=>de),[1,0],"",!1),ie=[{...prepare_new_VAP(),id:"VAP1",relative_probability:5,probability:0},{...prepare_new_VAP(),id:"VAP2",relative_probability:0,probability:1}];let ce=[{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),entries:ie}];oe={...oe,subtype:"boolean",values_and_prediction_sets:ce},_e=tidy_wcomponent(oe,re),se=_e.values_and_prediction_sets[0].entries,test(se.map(({relative_probability:de})=>de),[5,0],"",!1),test(se.map(({probability:de})=>de),[0,1],"",!1),describe("Ensuring _derived__using_value_from_wcomponent_id is not saved",()=>{const de=console.error;let ue="";console.error=le=>{ue=le},oe={...oe,_derived__using_value_from_wcomponent_id:"123"},_e=tidy_wcomponent(oe,re),console.error=de,test(ue.length>0,!0,"Should log an error to the console when wcomponent with _derived__using_value_from_wcomponent_id is tidied before attempting to be saved"),test(_e._derived__using_value_from_wcomponent_id,void 0,"Should delete wcomponent._derived__using_value_from_wcomponent_id")})}),test_refresh_bases_for_current_user=describe.delay("refresh_bases_for_current_user",()=>{const t=new Date,ee=new Date,te="123",ne="987",oe={id:1,inserted_at:t,updated_at:ee,owner_user_id:te,public_read:!1,title:"owned by this user",access_level:"owner",can_edit:!0},ie={id:2,inserted_at:t,updated_at:ee,owner_user_id:ne,public_read:!1,title:"editable by this user",access_level:"editor",can_edit:!0},_e={id:3,inserted_at:t,updated_at:ee,owner_user_id:ne,public_read:!1,title:"viewable by this user",access_level:"viewer",can_edit:!1},se={id:3,inserted_at:t,updated_at:ee,owner_user_id:ne,public_read:!0,title:"public viewable by this user",access_level:"viewer",can_edit:!1},re=[oe,ie,_e,se];function ae(de){return selector_needs_to_create_a_base({user_info:de})}let ce={user:{id:te},chosen_base_id:void 0,bases_by_id:void 0};test(ae(ce),!1),[oe,ie].forEach(de=>{ce=user_info_reducer({user_info:ce},ACTIONS.user_info.update_bases({bases:[de]})).user_info,test(ce.chosen_base_id,de.id),test(ae(ce),!1)}),ce=user_info_reducer({user_info:ce},ACTIONS.user_info.update_bases({bases:[_e,se]})).user_info,test(ce.chosen_base_id,void 0),test(ae(ce),!0),ce=user_info_reducer({user_info:{user:{id:te},chosen_base_id:100,bases_by_id:void 0}},ACTIONS.user_info.update_bases({bases:[_e,se]})).user_info,test(ce.chosen_base_id,void 0),test(ae(ce),!0),[oe,ie].forEach(de=>{ce=user_info_reducer({user_info:{user:{id:te},chosen_base_id:100,bases_by_id:void 0}},ACTIONS.user_info.update_bases({bases:[]})).user_info,test(ce.chosen_base_id,void 0),test(ae(ce),!0)}),re.forEach(({id:de})=>{ce=user_info_reducer({user_info:{user:{id:te},chosen_base_id:de,bases_by_id:void 0}},ACTIONS.user_info.update_bases({bases:re})).user_info,test(ce.chosen_base_id,de),test(ae(ce),!1)})}),regexp_unquoted=/(?:^)([^",\n\r]*),?/g,regexp_quoted=/(?:^)"([^"]+|"")*",?/g,regexp_new_line=/(?:^)([\n\r]+)/g;function csv_to_array(t){const ee=[];let te,ne,oe,ie,_e=[],se=!1,re=!0,ae=2;do{if(se=!1,re&&(re=!1,ae=2,_e=[],ee.push(_e)),te=t.match(regexp_unquoted),ne=t.match(regexp_quoted),ne&&ne.length){ie=ne[0],se=ie.endsWith(",");const ce=(se?ie.slice(1,-2):ie.slice(1,-1)).replace(/""/g,'"');_e.push(ce),t=t.slice(ie.length),se||(ae-=1)}else if(te.length){ie=te[0],se=ie.endsWith(",");const ce=se?ie.slice(0,-1):ie;_e.push(ce),t=t.slice(ie.length),se||(ae-=1)}oe=t.match(regexp_new_line),!se&&oe&&oe.length&&(re=!0,ae=2,t=t.slice(oe[0].length)),t===""&&(ae-=1)}while(ae>0);return ee}const test_csv_to_array=describe.delay("csv_to_array",()=>{test(csv_to_array(""),[[""]]),test(csv_to_array(","),[["",""]]),test(csv_to_array("a"),[["a"]]),test(csv_to_array("a,"),[["a",""]]),test(csv_to_array(",a"),[["","a"]]),test(csv_to_array(",a,"),[["","a",""]]),test(csv_to_array("a,a"),[["a","a"]]),test(csv_to_array("a,a,"),[["a","a",""]]),test(csv_to_array(",a,a"),[["","a","a"]]),test(csv_to_array(",a,a,"),[["","a","a",""]]),test(csv_to_array(`
`),[[""],[""]]),test(csv_to_array(`a
a`),[["a"],["a"]]),test(csv_to_array(`,
,`),[["",""],["",""]]),test(csv_to_array(`a,
a,`),[["a",""],["a",""]]),test(csv_to_array(`,a
,a`),[["","a"],["","a"]]),test(csv_to_array(`,a,
,a,`),[["","a",""],["","a",""]]),test(csv_to_array('""'),[[""]]),test(csv_to_array('"",'),[["",""]]),test(csv_to_array(',""'),[["",""]]),test(csv_to_array(',"",'),[["","",""]]),test(csv_to_array('","'),[[","]]),test(csv_to_array('",",'),[[",",""]]),test(csv_to_array(',","'),[["",","]]),test(csv_to_array(',",",'),[["",",",""]]),test(csv_to_array('"",""'),[["",""]]),test(csv_to_array('"a"'),[["a"]]),test(csv_to_array('"a",'),[["a",""]]),test(csv_to_array(',"a"'),[["","a"]]),test(csv_to_array(',"a",'),[["","a",""]]),test(csv_to_array('"a","a"'),[["a","a"]]),test(csv_to_array('"a","a",'),[["a","a",""]]),test(csv_to_array(',"a","a"'),[["","a","a"]]),test(csv_to_array(',"a","a",'),[["","a","a",""]]),test(csv_to_array('""""'),[['"']]),test(csv_to_array('"""",'),[['"',""]]),test(csv_to_array(',""""'),[["",'"']]),test(csv_to_array(',"""",'),[["",'"',""]]),test(csv_to_array('"""a"""'),[['"a"']]),test(csv_to_array('"""a""","""a"""'),[['"a"','"a"']]),test(csv_to_array('""""""'),[['""']]),test(csv_to_array('"a""a"'),[['a"a']]),test(csv_to_array('"a"",""a"'),[['a","a']]),test(csv_to_array(`""
`),[[""],[""]])}),run_list_function_tests=describe.delay("list functions",()=>{describe("index_is_in_bounds",()=>{test(index_is_in_bounds([],0),!1,"empty list, any number"),test(index_is_in_bounds(["A"],-1),!1,"list with one element, index -1"),test(index_is_in_bounds(["A"],0),!0,"list with one element, index 0"),test(index_is_in_bounds(["A"],1),!1,"list with one element, index 1"),test(index_is_in_bounds(["A","B"],1),!0,"list with two elements, index 1"),test(index_is_in_bounds(["A","B"],2),!1,"list with two elements, index 2")}),describe("swap_elements",()=>{test(swap_elements([],0,0),[],"empty list, any indices, should be noop"),test(swap_elements(["A","B"],-1,0),["A","B"],"invalid first index of -1, should be noop"),test(swap_elements(["A","B"],2,0),["A","B"],"invalid first index of 2, should be noop"),test(swap_elements(["A","B"],0,-1),["A","B"],"invalid second index of -1, should be noop"),test(swap_elements(["A","B"],0,2),["A","B"],"invalid second index of 2, should be noop"),test(swap_elements(["A","B"],0,1),["B","A"],"should swap"),test(swap_elements(["A","B"],1,0),["B","A"],"should swap"),test(swap_elements(["A","B"],1,1),["A","B"],"should handle noop")}),describe("insert_element_at_index",()=>{test(insert_element_at_index([],"A",0),["A"],"insertion works at index 0"),test(insert_element_at_index([],"A",-2),["A"],"insertion works at any negative index"),test(insert_element_at_index([],"A",2),["A"],"insertion works at any positive index"),test(insert_element_at_index(["A","B","C"],"D",0),["D","A","B","C"],"insertion works at index 0"),test(insert_element_at_index(["A","B","C"],"D",-2),["D","A","B","C"],"insertion works at any negative index"),test(insert_element_at_index(["A","B","C"],"D",2),["A","B","D","C"],"insertion works at an positive index that is in the list"),test(insert_element_at_index(["A","B","C"],"D",3),["A","B","C","D"],"insertion works at an positive index that is the length of the list"),test(insert_element_at_index(["A","B","C"],"D",4),["A","B","C","D"],"insertion works at any positive index that is > list length")})}),run_get_wcomponent_VAPs_represent_tests=describe.delay("get_wcomponent_VAPs_represent",()=>{const t=uuid_v4_for_tests(1),ee=uuid_v4_for_tests(2);let te,ne,oe,ie,_e,se;te=void 0,oe={},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,"Should return undefined for undefined WComponent"),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:void 0}),oe={},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return undefined for WComponent.type of "statev2" and subtype of undefined'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"boolean"}),oe={},ie=void 0,_e=VAPsType.boolean,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return boolean for WComponent.type of "statev2" and subtype of boolean'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"number"}),oe={},ie=void 0,_e=VAPsType.number,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return number for WComponent.type of "statev2" and subtype of number'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"other"}),oe={},ie=void 0,_e=VAPsType.other,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return other for WComponent.type of "statev2" and subtype of other'),describe("state_value",()=>{ne=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"number"}),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:ne.id}),oe={[ne.id]:ne},ie=void 0,_e=VAPsType.number,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return number for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of number'),ne=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"boolean"}),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:ne.id}),oe={[ne.id]:ne},ie=void 0,_e=VAPsType.boolean,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return boolean for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of boolean'),ne=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"other"}),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:ne.id}),oe={[ne.id]:ne},ie=void 0,_e=VAPsType.other,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return other for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of other'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:"some unknown uuid"}),oe={},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return undefined for WComponent.type of "state_value" targeting an unknown stateV2 wcomponent'),describe("protected from recursion",()=>{te=prepare_new_contextless_wcomponent_object({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:t}),oe={[te.id]:te},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return undefined for WComponent.type of "state_value" targeting itself (accidentally)'),ne=prepare_new_contextless_wcomponent_object({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:ee}),te=prepare_new_contextless_wcomponent_object({base_id:-1,id:ee,type:"state_value",attribute_wcomponent_id:t}),oe={[ne.id]:ne,[te.id]:te},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return undefined for two WComponent.type of "state_value" targeting each other with infinite recursion')})}),describe("other types",()=>{te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"action"}),oe={},ie=void 0,_e=VAPsType.action,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return action for WComponent.type of "action"'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"process"}),oe={},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return undefined for WComponent.type of "process"'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"causal_link"}),oe={},ie=void 0,_e=VAPsType.undefined,se=get_wcomponent_VAPs_represent(te,oe,ie),test(se,_e,'Should return undefined for WComponent.type of "causal_link"')})}),run_parse_value_tests=describe.delay("parse_value",()=>{describe("parse_VAP_value",()=>{let t;describe('VAPsType "number"',()=>{const ee=te=>parse_VAP_value({value:te,id:"",description:"",explanation:"",probability:1,conviction:1},VAPsType.number);t=ee(""),test(t,null,"Should parse empty string as valid but null"),t=ee("   "),test(t,null,"Should parse string of spaces as valid but null"),t=ee("123"),test(t,123,"Should parse valid number"),t=ee("  123  "),test(t,123,"Should parse valid number with whitespace"),t=ee("123abc"),test(Number.isNaN(t),!0,"Should parse number with appended invalid characters as invalid NaN"),t=ee("abc123"),test(Number.isNaN(t),!0,"Should parse number with prepended invalid characters as invalid NaN"),t=ee("123%"),test(t,1.23,"Should parse number with appended %"),t=ee("123 %"),test(t,1.23,"Should parse number with appended whitespace %"),t=ee("123%%"),test(Number.isNaN(t),!0,"Should parse number with appended % and further invalid characters as invalid NaN"),t=ee("1e-3%"),test(t,1e-5,"Should parse negative exponent number with appended %"),t=ee(".3 e 2 %"),test(t,.3,"Should parse fractional number with exponent with appended % and interspersed whitespace")})}),describe("is_string_valid_number",()=>{test(is_string_valid_number(""),!0,"empty string is valid number"),test(is_string_valid_number("   "),!0,"string of spaces is valid number"),test(is_string_valid_number("123"),!0,"valid number"),test(is_string_valid_number("  123  "),!0,"valid number with whitespace"),test(is_string_valid_number("123abc"),!1,"number with appended invalid characters"),test(is_string_valid_number("abc123"),!1,"number with prepended invalid characters"),test(is_string_valid_number("123%"),!0,"number with appended % (valid)"),test(is_string_valid_number("a90%"),!1,"number with appended % but prepended character (invalid)"),test(is_string_valid_number("123 %"),!0,"number with appended whitespace % (valid)"),test(is_string_valid_number("123%%"),!1,"number with appended % and further invalid characters"),test(is_string_valid_number("1e-3%"),!0,"negative exponent number with appended % (valid)"),test(is_string_valid_number(".3 e 2 %"),!0,"fractional number with exponent with appended % and interspersed whitespace (valid)")})}),test_calc_connection_wcomponent_should_display=describe.delay("calc_connection_wcomponent_should_display",()=>{const t=new Date("2024-08-29T11:00:00.000Z"),ee=t.getTime(),te=new Date("2024-08-29T11:00:00.000Z").getTime(),ne=()=>{let _e=prepare_new_contextless_wcomponent_object({type:"causal_link",base_id:-1,created_at:t});if(!wcomponent_is_causal_link(_e))throw new Error(`Need a causal_link component for tests but got "${_e.type}"`);const se=prepare_new_contextless_wcomponent_object({type:"causal_link",base_id:-1,created_at:t}),re=prepare_new_contextless_wcomponent_object({type:"statev2",base_id:-1,created_at:t});return{wcomponent:_e,kv_entry:{left:0,top:0},validity_filter:{only_certain_valid:!1,only_maybe_valid:!1,maybe_invalid:!1,show_invalid:!0},from_wc:se,to_wc:re,from_wc__kv_entry:{left:0,top:0},to_wc__kv_entry:{left:0,top:0},created_at_ms:ee,sim_ms:te,selected_wcomponent_ids_set:new Set,wc_ids_excluded_by_filters:new Set}};let oe=ne(),ie=calc_connection_wcomponent_should_display(oe);test(ie,{display_certainty:1},"should display"),oe=ne(),oe.wcomponent.created_at=new Date(ee+1),ie=calc_connection_wcomponent_should_display(oe),test(ie,!1,"should not display if created in future"),oe=ne(),oe.wc_ids_excluded_by_filters.add(oe.wcomponent.id),ie=calc_connection_wcomponent_should_display(oe),test(ie,!1,"should not display if it list of ids excluded by filters"),oe=ne(),oe.from_wc=void 0,oe.from_wc__kv_entry=void 0,ie=calc_connection_wcomponent_should_display(oe),test(ie,{display_certainty:1},"should display if from_wc not present"),oe=ne(),oe.to_wc=void 0,oe.to_wc__kv_entry=void 0,ie=calc_connection_wcomponent_should_display(oe),test(ie,{display_certainty:1},"should display if to_wc not present"),oe=ne(),oe.from_wc=void 0,oe.from_wc__kv_entry=void 0,oe.wc_ids_excluded_by_filters.add(oe.wcomponent.id),ie=calc_connection_wcomponent_should_display(oe),test(ie,!1,"should not display if from_wc not present and id is in list of ids excluded by filters")}),test_get_wcomponent_state_UI_value=describe.delay("get_wcomponent_state_UI_value",()=>{const t=new Date("2021-05-01 00:00"),ee=new Date("2021-05-01 00:01"),te=new Date("2021-05-01 00:02");function ne(ue,le){const pe={};return ue.forEach(me=>{le.forEach(fe=>{if(me.VAP_set_id!==fe.id)return;const ge=pe[fe.id]||[];ge.push({base_id:-1,id:"",created_at:ee,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:fe.id,target_VAP_id:me.VAP_id}),pe[fe.id]=ge})}),pe}function oe(ue,le,pe){const{counterfactuals_data:me=[],datetime:fe={}}=pe||{},ge=le.map((be,ve)=>({base_id:-1,id:`vps${ve}`,created_at:ee,version:1,datetime:fe,entries:be}));ue={...ue,values_and_prediction_sets:ge};const he=ne(me,ge);return get_wcomponent_state_UI_value({wcomponent:ue,VAP_set_id_to_counterfactual_v2_map:he,created_at_ms:ee.getTime(),sim_ms:ee.getTime()})}const ie={base_id:-1,id:"",created_at:ee,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]};let _e;const se={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},re={...se,id:"VAP100",value:"A100",probability:1,conviction:1},ae={...re,id:"VAP80",value:"A80",probability:.8},ce={...re,id:"VAP20",value:"A20",probability:.2},de={...re,id:"VAP0",value:"A0",probability:0};describe("Basic tests of get_wcomponent_state_UI_value",()=>{_e=oe(ie,[]),test(_e,void 0,"No VAP (value and prediction) sets should return undefined"),_e=oe(ie,[[]]),test(_e,void 0,"No value defined in a VAP (value and prediction) set should return undefined"),_e=oe(ie,[[{...re,value:"  "}]]),test(_e,{values_string:"not defined",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with whitespace string value should be trimmed to nothing and then shown as 'not defined'"),_e=oe(ie,[[re]]),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with certainty"),_e=oe(ie,[[ce,ae]]),test(_e,{values_string:"A80, A20",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"Multiple VAPs with both uncertain should result in both being shown, with the most probable first"),_e=oe(ie,[[de,re]]),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain first, should only show the certain one"),_e=oe(ie,[[re,de]]),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain last, should only show the certain one"),_e=oe(ie,[[ce,ce,ce,ce]]),test(_e,{values_string:"A20, A20, A20, (1 more)",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},'Shows "(1 more)" when there are more than 3 values')}),describe("number subtype",()=>{const ue={...ie,subtype:"number"},le={...se,id:"VAP1",value:"33",probability:1,conviction:1};_e=oe(ue,[[le]]),test(_e,{values_string:"33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number value string");const pe={...se,id:"VAP1",value:"33abc",probability:1,conviction:1};_e=oe(ue,[[pe]]),test(_e,{values_string:"NaN",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A number with invalid characters in value string");const me={...se,id:"VAP1",value:"33%",probability:1,conviction:1};_e=oe(ue,[[me]]),test(_e,{values_string:"0.33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number percentage")}),describe("boolean subtype",()=>{const ue={...ie,subtype:"boolean"};_e=oe(ue,[[re]]),test(_e,{values_string:"True",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"100% confident boolean should render as True"),_e=oe(ue,[[{...re,probability:.51}]]),test(_e,{values_string:"True",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},">50% confident boolean should render as True"),_e=oe(ue,[[{...re,probability:.5}]]),test(_e,{values_string:"False",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"<=50% confident boolean should render as False"),_e=oe(ue,[[de]]),test(_e,{values_string:"False",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"0% confident boolean should render as False")}),describe("StateValue replacing VAPSets",()=>{const ue={...ie,_derived__using_value_from_wcomponent_id:"abc123"};_e=oe(ue,[[re]]),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),describe("datetime",()=>{_e=oe(ie,[[re]],{datetime:{min:te}}),test(_e,void 0,"When datetime.min is in the future, no value should be shown"),_e=oe(ie,[[re]],{datetime:{min:ee}}),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.min is the present sim datetime, a value should be shown"),_e=oe(ie,[[re]],{datetime:{max:ee}}),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is the present sim datetime, a value should be shown"),_e=oe(ie,[[re]],{datetime:{max:t}}),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is in the past, a value should still be shown because the 'max' represents the lastest time this change to state could have occured, and the state represents the most current value"),_e=oe(ie,[[re]],{datetime:{value:te}}),test(_e,void 0,"When datetime.value is the future, no value should be shown"),_e=oe(ie,[[re]],{datetime:{value:ee}}),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the present sim datetime, a value should be shown"),_e=oe(ie,[[re]],{datetime:{value:t}}),test(_e,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the past, a value should still be shown, for the same reason as when datetime.max is in the past")})}),test_get_wcomponent_state_value_and_probabilities=describe.delay("get_wcomponent_state_value_and_probabilities",()=>{const t=new Date("2021-05-01 00:00"),ee=new Date("2021-05-01 00:01"),te=new Date("2021-05-01 00:02");function ne(he,be){if(!he||!be)return;const ve={};let we=0;return he.forEach(ye=>{be.forEach(ke=>{if(ye.VAP_set_id!==ke.id)return;const Ae=ve[ke.id]||[];Ae.push({base_id:-1,id:`cf${we++}`,created_at:ee,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:ke.id,target_VAP_id:ye.VAP_id}),ve[ke.id]=Ae})}),ve}function oe(he){return he.map((be,ve)=>({base_id:-1,id:`vps${ve}`,created_at:ee,version:1,datetime:{},entries:[],...be}))}function ie(he,be,ve){const{apply_counterfactuals_v2:we,datetime:ye={}}=ve||{};if(be){const Ae=be.map(Se=>({datetime:ye,entries:Se})),$e=oe(Ae);he={...he,values_and_prediction_sets:$e}}const ke=ne(we,he.values_and_prediction_sets);return get_wcomponent_state_value_and_probabilities({wcomponent:he,VAP_set_id_to_counterfactual_v2_map:ke,created_at_ms:ee.getTime(),sim_ms:ee.getTime()})}const _e={base_id:-1,id:"",created_at:ee,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]},se={..._e,subtype:"boolean"};let re;const ae={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},ce={...ae,id:"VAP100",value:"A100",probability:1,conviction:1},de={...ce,id:"VAP80",value:"A80",probability:.8},ue={...ce,id:"VAP20",value:"A20",probability:.2},le={...ce,id:"VAP0",value:"A0",probability:0},pe={...ce,id:"VAP100c50",value:"A100c50",conviction:.8},me={...ce,id:"VAP100c0",value:"A100c0",conviction:0},fe=[pe],ge=[me];describe("Basic functionality",()=>{re=ie(_e,[]),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"No VAP (value and prediction) defined"),re=ie(_e,[[]]),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"No value defined in VAP (value and prediction)"),re=ie(_e,[[ce]]),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Single with certainty"),re=ie(_e,[[ue,de]]),test(re,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:.8,conviction:1,probability:.8,value_id:void 0},{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with both uncertain"),re=ie(_e,[[ce,ue]]),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with one certain, one uncertain, should only show certain");let he=oe([{datetime:{value:t},id:"vap_set_0",entries:[{...ce,value:"A100a"}]},{datetime:{value:ee},id:"vap_set_1",entries:[{...ce,value:"A100b"}]},{datetime:{value:te},id:"vap_set_2",entries:[{...ce,value:"A100c"}]}]),be={..._e,values_and_prediction_sets:he};re=get_wcomponent_state_value_and_probabilities({wcomponent:be,VAP_set_id_to_counterfactual_v2_map:void 0,created_at_ms:ee.getTime(),sim_ms:ee.getTime()}),test(re,{most_probable_VAP_set_values:[{original_value:"A100b",parsed_value:"A100b",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple VAP sets, each with one single VAP, should pick current VAP set"),re=ie(_e,[[le]]),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance: Should return no value when no chance")}),describe("should use first VAP set when both VAP sets conflict at same datetime",()=>{re=ie(_e,[[ce],[ue]]),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"certain first and uncertain last"),re=ie(_e,[[ue],[ce]]),test(re,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"uncertain first and certain last")}),describe("handling boolean subtype",()=>{re=ie(se,[[le]]),test(re,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:!1,certainty:0,conviction:1,probability:0,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance boolean: Should return a value with probability of 0 when no chance of a boolean value"),re=ie(se,[[ce]]),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:!0,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should handle boolean, probability of 1, by returning true"),describe('uncertainty for "boolean" subtype',()=>{re=ie(se,[[ue]]),test(re,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:!1,certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),re=ie(se,[fe]),test(re,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:!0,certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),re=ie(se,[ge]),test(re,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:!0,certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")})}),describe('uncertainty for "other" subtype',()=>{re=ie(_e,[[ue]]),test(re,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),re=ie(_e,[fe]),test(re,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:"A100c50",certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),re=ie(_e,[ge]),test(re,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:"A100c0",certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")}),describe("counterfactuals",()=>{re=ie(_e,[[ce]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:ce.id}]}),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"No op counterfactual is applied to something already with certainty of 1"),re=ie(_e,[[de]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:de.id}]}),test(re,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP that had certainty of < 1"),re=ie(_e,[[de,ue]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:ue.id}]}),test(re,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP set with two VAPs that had certainty of < 1"),re=ie(_e,[[ce,le]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:le.id}]}),test(re,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:"A0",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactuals to force one option possibility over another that was certain"),re=ie(_e,[[ce,le]]),test.skip(re,{most_probable_VAP_set_values:[{certainty:1,conviction:1,original_value:"A100",parsed_value:"A100",probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["123"]},"Skipping because counterfactuals version 2 only works to force things to be true, not to be false.  For forcing something to be true, then you can use a StateValue component instead.")}),describe("StateValue replacing VAPSets",()=>{const he={..._e,_derived__using_value_from_wcomponent_id:"abc123"};re=ie(he,[[ce]]),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),describe('Parsing "number" subtype',()=>{var we;const he={..._e,subtype:"number"},be={...ae,id:"VAP1",value:"33",probability:1,conviction:1},ve={...ae,id:"VAP1",value:"44abc",probability:1,conviction:1};re=ie(he,[[be]]),test(re,{most_probable_VAP_set_values:[{original_value:"33",parsed_value:33,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Correctly parses valid number"),re=ie(he,[[ve]]),test(re,{most_probable_VAP_set_values:[{original_value:"44abc",parsed_value:Number.NaN,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Errors when parsing number appended with invalid characters"),test(Number.isNaN((we=re.most_probable_VAP_set_values[0])==null?void 0:we.parsed_value),!0,"Error is Number.NaN")}),describe("values before, at, after a datetime.min, datetime.value, datetime.max",()=>{describe("in the future",()=>{re=ie(_e,[[ce]],{datetime:{min:te}}),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.min is in future"),re=ie(_e,[[ce]],{datetime:{value:te}}),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.value is in future"),re=ie(_e,[[ce]],{datetime:{max:te}}),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")}),re=ie(_e,[[ce]],{datetime:{min:ee}}),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.min is at the same time (or earlier)"),re=ie(_e,[[ce]],{datetime:{value:ee}}),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.value is at the same time (or earlier)"),re=ie(_e,[[ce]],{datetime:{max:ee}}),test(re,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")})}),run_EditableCalculationRow_tests=describe.delay("EditableCalculationRow support functions",()=>{describe("should_show_calc_value",()=>{let t,ee;t="(@@02d4a5f4-4abd-41a2-bb50-e68e358a3169/@@e34796cf-ab9e-47b8-9ea5-20cb00fb611d)*@@86635a8b-f4f8-4489-8a02-b4f09c0a22ec",ee=should_show_calc_value(t),test(ee,!0,"Should return true for calculation with wcomponent ids")})}),run_get_default_formatting_function_tests=describe.delay("get default formatting function",()=>{const t=[{calc_value:"  81.2  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when valid number with decimal space",expected_result_display_type:NUMBER_DISPLAY_TYPES.simple,test_description__result_display_type:"Should assign simple type when only valid number"},{calc_value:"  1899  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (1899) outside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.simple,test_description__result_display_type:"Should assign simple type when integer number (1899) outside of 1900-2200"},{calc_value:"  1900  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (1900) inside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.bare,test_description__result_display_type:"Should assign simple type when integer number (1900) inside of 1900-2200"},{calc_value:"  2200  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (2200) inside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.bare,test_description__result_display_type:"Should assign simple type when integer number (2200) inside of 1900-2200"},{calc_value:"  2201  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (2201) outside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.simple,test_description__result_display_type:"Should assign simple type when integer number (2201) outside of 1900-2200"},{calc_value:"  81.2 %  ",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:NUMBER_DISPLAY_TYPES.percentage,test_description__result_display_type:"Should assign percentage type when % included with valid number containing spaces and decimal"},{calc_value:"83%",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:NUMBER_DISPLAY_TYPES.percentage,test_description__result_display_type:"Should assign percentage type when % included with simple valid number without spaces or decimal"}];describe("get_default_significant_figures",()=>{let ee;t.forEach(te=>{ee=get_default_significant_figures(te.calc_value),test(ee,te.expected_sig_figs,te.test_description__sig_figs)})}),describe("get_default_result_display_type",()=>{let ee;t.forEach(te=>{ee=get_default_result_display_type(te.calc_value),test(ee,te.expected_result_display_type,te.test_description__result_display_type)})})}),run_get_valid_calculation_name_id_tests=describe.delay("get_valid_calculation_name_id",()=>{let t,ee,te,ne;ee=[],t=void 0,te="A",ne=get_valid_calculation_name_id(ee,t),test(ne,te,"Without any other IDs"),ee=["A"],t=void 0,te="B",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With an existing ID of "A"'),ee=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],t=void 0,te="AA",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With existing IDs of "A" up to "Z"'),ee=["A","B"],t="a",te="c",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With existing IDs of "A" and "B", and given a  lower case "a"'),ee=["food"],t="Food",te="Fooe",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With an existing ID of "food" and given "Food"')}),run_make_calculation_safe_for_rich_text_tests=describe.delay("make_calculation_safe_for_rich_text",()=>{let t,ee,te;t="A * B * C",te="A \\* B \\* C",ee=make_calculation_safe_for_rich_text(t),test(ee,te,"Should escape *")});function test_helper__make_knowledge_view(t,ee,te){const ne=new Date("2023-03-22 15:15:00");return{id:ee,foundation_knowledge_view_ids:te?[te]:void 0,wc_id_map:t,title:"some title of "+ee,description:"",sort_type:"normal",created_at:ne,base_id:1,goal_ids:[]}}const run_get_wcomponent_status_in_knowledge_view_tests=describe.delay("get_UI_data__wcomponent_add_or_for_knowledge_view",()=>{describe("simple single knowledge view with no foundation",()=>{const t=test_helper__make_knowledge_view({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0}},"kv1"),ee={[t.id]:t},te=get_foundational_knowledge_views(t,ee,!0),ne=get_composed_wc_id_maps_object(te,{}),oe=get_foundational_knowledge_views(t,ee,!1),ie=get_composed_wc_id_maps_object(oe,{});test(ne,{composed_wc_id_map:{wc2:{left:20,top:0}},composed_blocked_wc_id_map:{wc4:{left:40,top:0,blocked:!0}}},"Sanity check (no1) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),test(ie,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}},"Sanity check (no2) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function re(de,ue){return get_wcomponent_status_in_knowledge_view({editing_allowed:de,wcomponent_id:ue,knowledge_view:t,composed_wc_id_maps_object:ne,foundation_composed_wc_id_map:ie.composed_wc_id_map})}let ae,ce;describe("editing_allowed is true",()=>{ae=re(!0,"wc1"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent not yet added to knowledge view"),ae=re(!0,"wc2"),ce={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},test(ae,ce,"with normal wcomponent entry in knowledge view"),ae=re(!0,"wc3"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent removed from this knowledge view"),ae=re(!0,"wc4"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},test(ae,ce,"with wcomponent blocked from this knowledge view")}),describe("editing_allowed is false",()=>{ae=re(!1,"wc1"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent not yet added to knowledge view"),ae=re(!1,"wc2"),ce={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with normal wcomponent entry in knowledge view"),ae=re(!1,"wc3"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent removed from this knowledge view"),ae=re(!1,"wc4"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent blocked from this knowledge view")})}),describe("knowledge view with single knowledge view foundation",()=>{const t=test_helper__make_knowledge_view({wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222},wc9:{left:90,top:222,passthrough:!0},wc10:{left:100,top:222,passthrough:!0},wc11:{left:110,top:222,passthrough:!0},wc12:{left:120,top:222,passthrough:!0},wc13:{left:130,top:222,blocked:!0},wc14:{left:140,top:222,blocked:!0},wc15:{left:150,top:222,blocked:!0},wc16:{left:160,top:222,blocked:!0}},"kv1"),ee=test_helper__make_knowledge_view({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0},wc6:{left:60,top:0},wc7:{left:70,top:0,passthrough:!0},wc8:{left:80,top:0,blocked:!0},wc10:{left:100,top:0},wc11:{left:110,top:0,passthrough:!0},wc12:{left:120,top:0,blocked:!0},wc14:{left:140,top:0},wc15:{left:150,top:0,passthrough:!0},wc16:{left:160,top:0,blocked:!0}},"kv2",t.id),te={[t.id]:t,[ee.id]:ee},ne=get_foundational_knowledge_views(ee,te,!0),oe=get_composed_wc_id_maps_object(ne,{}),ie=get_foundational_knowledge_views(ee,te,!1),_e=get_composed_wc_id_maps_object(ie,{});test(oe,{composed_wc_id_map:{wc2:{left:20,top:0},wc5:{left:50,top:222},wc6:{left:60,top:0},wc7:{left:70,top:222},wc10:{left:100,top:0},wc14:{left:140,top:0}},composed_blocked_wc_id_map:{wc4:{blocked:!0,left:40,top:0},wc8:{blocked:!0,left:80,top:0},wc12:{blocked:!0,left:120,top:0},wc13:{blocked:!0,left:130,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:0}}},"Sanity check (no3) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),test(_e,{composed_wc_id_map:{wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222}},composed_blocked_wc_id_map:{wc13:{blocked:!0,left:130,top:222},wc14:{blocked:!0,left:140,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:222}}},"Sanity check (no4) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function ae(ue,le){return get_wcomponent_status_in_knowledge_view({editing_allowed:ue,wcomponent_id:le,knowledge_view:ee,composed_wc_id_maps_object:oe,foundation_composed_wc_id_map:_e.composed_wc_id_map})}let ce,de;describe("editing_allowed is true",()=>{describe("with wcomponent not yet added to foundational knowledge view",()=>{ce=ae(!0,"wc1"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc2"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc3"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc4"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with wcomponent blocked from this top/current/child knowledge view")}),describe("with wcomponent added to foundational knowledge view",()=>{ce=ae(!0,"wc5"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc6"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!0,remove_and_block_button_text:"Remove and Block from knowledge view",remove_and_block_button_tooltip:"Remove and Block from showing in current knowledge view (some title of kv2)"},test(ce,de,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc7"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc8"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove block (allow to show through from foundational knowledge view)",remove_button_tooltip:"This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with wcomponent blocked from this top/current/child knowledge view")}),describe("with wcomponent removed from foundational knowledge view",()=>{ce=ae(!0,"wc9"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc10"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc11"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc12"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with wcomponent blocked from this top/current/child knowledge view")}),describe("with wcomponent removed and blocked in foundational knowledge view",()=>{ce=ae(!0,"wc13"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc14"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc15"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc16"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,de,"and with wcomponent blocked from this top/current/child knowledge view")})}),describe("editing_allowed is false",()=>{describe("with wcomponent not yet added to foundational knowledge view",()=>{ce=ae(!1,"wc1"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent blocked from this knowledge view")}),describe("with wcomponent added to foundational knowledge view",()=>{ce=ae(!1,"wc1"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent blocked from this knowledge view")}),describe("with wcomponent removed from foundational knowledge view",()=>{ce=ae(!1,"wc1"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent blocked from this knowledge view")}),describe("with wcomponent removed and blocked in foundational knowledge view",()=>{ce=ae(!1,"wc1"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),de={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),de={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,de,"with wcomponent blocked from this knowledge view")})})})});function run_all_tests(){tests_stats.reset(),run_apply_units_from_component_tests(),run_convert_percentages_tests(),run_currency_symbol_functions_tests(),run_normalise_calculation_ids_tests(),run_normalise_calculation_numbers_tests(),run_perform_calculations_test(),test_get_angle(),test_derive_connection_coords(),test_calculate_new_zoom_xy(),test_correct_datetime_for_local_time_zone(),test_handle_on_blur(),test_calc_ids_to_move_and_conflicts_functions(),test_get_actions_parent_ids(),run_number_to_significant_figures_test(),run_number_to_string_test(),test_graph_related_functions(),test_stable_stringify(),test_get_tense_of_uncertain_datetime(),test_partition_sorted_items_by_datetimes(),test_sort_by_uncertain_event_datetimes(),test_partition_items_by_created_at_datetime(),test_calc_new_counterfactual_state(),test_add_newlines_to_markdown(),run_get_rich_text_tests(),run_remove_rich_text_tests(),run_replace_normal_ids_tests(),test_get_ids_from_text(),test_derived_composed_wcomponents_by_id_reducer(),test_get_composed_wcomponents_by_id(),test_calc_if_wcomponent_should_exclude_because_label_or_type(),run_get_composed_wc_id_maps_object_tests(),test_knowledge_views_derived_reducer(),test_merge_routing_state(),test_routing_state_to_string(),run_specialised_objects_accessors_tests(),test_tidy_wcomponent(),test_merge_knowledge_views(),test_merge_wcomponent(),test_refresh_bases_for_current_user(),test_array_functions(),test_binary_search_functions(),test_csv_to_array(),test_cloneable_generator_factory(),run_list_function_tests(),test_prepare_new_VAP_set(),test_update_VAPSets_with_possibilities(),run_get_wcomponent_VAPs_represent_tests(),run_parse_value_tests(),test_default_possible_values(),test_get_possibilities_from_VAP_sets(),test_calc_connection_wcomponent_should_display(),test_get_wcomponent_state_UI_value(),test_get_wcomponent_state_value_and_probabilities(),test_partition_and_prune_items_by_datetimes_and_versions(),run_EditableCalculationRow_tests(),run_get_default_formatting_function_tests(),run_get_valid_calculation_name_id_tests(),run_make_calculation_safe_for_rich_text_tests(),run_get_wcomponent_status_in_knowledge_view_tests(),tests_stats.print()}function setup_tests_for_browser(){window.run_tests=run_all_tests}const map_state$6=t=>({display_side_panel:t.controls.display_side_panel,animate_connections:t.display_options.animate_connections,network_functional:t.sync.network_functional,network_function_last_checked:t.sync.network_function_last_checked}),connector$6=connect(map_state$6);function App(t){return p$1(()=>{t.network_functional||setTimeout(()=>check_and_handle_connection_and_session(get_store()),1e3)},[t.network_functional,t.network_function_last_checked]),o$1(StyledEngineProvider,{injectFirst:!0,children:o$1(ThemeProvider,{theme:DefaultTheme,children:[o$1(CssBaseline,{}),o$1(StyledApp,{...t})]})})}const App$1=connector$6(App);function StyledApp(t){const ee=use_styles();return o$1(k$1,{children:[!t.network_functional&&o$1(Modal,{title:"",size:"small",child:o$1(Box,{children:[o$1(Typography,{id:"modal-modal-title",variant:"h6",component:"h2",children:"Reconnecting..."}),o$1(Typography,{id:"modal-modal-description",sx:{mt:2},children:["Last attempt: ",date_to_string({date:t.network_function_last_checked,time_resolution:"second"})]})]})}),o$1(Box,{id:"app",className:ee.root,children:[o$1(AppBar,{elevation:1,id:"header",position:"fixed",className:"app_header "+ee.app_bar,children:o$1(Toolbar,{variant:"dense",className:ee.toolbar,children:[o$1(Box,{className:`${ee.toolbar_section} ${ee.grow} ${ee.small_full_width}`,children:[o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(ViewOptions,{})}),o$1(Box,{className:`${ee.toolbar_item} ${ee.grow}`,children:o$1(ViewsBreadcrumb,{})})]}),o$1(Box,{className:`${ee.toolbar_section} ${ee.small_full_width}`,justifyContent:"flex-end",children:[o$1(Box,{className:`${ee.toolbar_item}`,children:[o$1(ActiveCreatedAtFilterWarning,{}),o$1(ActiveFilterWarning,{}),o$1(ActiveCreationContextWarning,{})]}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(ActiveUserWidget,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(SyncInfo,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(StorageInfo,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(UserInfo,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(SidePanelOrMenuButton,{})})]})]})}),o$1(Box,{id:"app_content",component:"div",className:clsx(ee.content,{[ee.content_with_open_side_panel]:t.display_side_panel,animate_connections:t.animate_connections}),children:o$1(MainAreaRouter,{})}),o$1(Drawer,{anchor:"right",className:ee.drawer,open:t.display_side_panel,variant:"persistent",children:o$1(Box,{component:"aside",className:ee.side_panel,id:"side_panel",children:o$1(Box,{id:"side_panel_content",className:ee.side_panel_content,children:[o$1(AppMenuItemsContainer,{}),o$1(SidePanel,{})]})})}),o$1(Box,{className:ee.help_popup,children:o$1(HelpMenu,{})})]})]})}const use_styles=makeStyles(t=>({root:{width:"100%",height:"100%",overflow:"hidden",display:"flex"},app_bar:{transition:t.transitions.create(["all"],{easing:t.transitions.easing.sharp,duration:t.transitions.duration.leavingScreen}),zIndex:t.zIndex.drawer+1},app_bar_with_open_side_panel:{},content:{width:"100%",flexGrow:1,display:"flex",marginRight:-SIDE_PANEL_WIDTH,transition:t.transitions.create(["margin"],{easing:t.transitions.easing.sharp,duration:t.transitions.duration.leavingScreen})},content_with_open_side_panel:{marginRight:0,transition:t.transitions.create(["margin"],{easing:t.transitions.easing.easeOut,duration:t.transitions.duration.enteringScreen})},drawer:{width:SIDE_PANEL_WIDTH,flexShrink:0},side_panel:{backgroundColor:t.palette.background.paper,width:SIDE_PANEL_WIDTH,position:"relative",paddingTop:50},side_panel_content:{marginTop:10,padding:10},sidebar_toolbar:{flexGrow:1,justifyContent:"flex-end"},toolbar:{flexGrow:1,justifyContent:"space-between",flexWrap:"wrap",[t.breakpoints.up("md")]:{flexWrap:"nowrap"}},toolbar_section:{display:"inherit",flexGrow:0,flexShrink:1,flexBasis:"auto",marginRight:5,"&:last-child":{marginRight:0},"&:empty":{display:"none"}},toolbar_item:{marginRight:5,"&:last-child":{marginRight:0}},help_popup:{position:"relative",zIndex:t.zIndex.drawer+1},small_full_width:{[t.breakpoints.down("md")]:{flexGrow:0,flexShrink:1,flexBasis:"100%",margin:0}},grow:{flexGrow:1},hide:{display:"none"},warning_icon:{color:t.palette.warning.main}}));setup_tests_for_browser();const probabilities=[{min:0,max:0,lambda:.2,k:.4,reverse:!1,text:"No chance"},{min:0,max:5,lambda:.2,k:.4,reverse:!1,text:"Remote chance"},{min:5,max:20,lambda:.5,k:2.8,reverse:!1,text:"Highly unlikely"},{min:20,max:35,lambda:1.5,k:1.9,reverse:!1,text:"Unlikely"},{min:35,max:50,lambda:1.8,k:3.3,reverse:!1,text:"Realistic probability"},{min:50,max:75,lambda:1.8,k:2.6,reverse:!0,text:"Likely or probable"},{min:75,max:95,lambda:1.1,k:1.6,reverse:!0,text:"Highly likely"},{min:95,max:100,lambda:.2,k:.4,reverse:!0,text:"Almost certain"},{min:100,max:100,lambda:.2,k:.4,reverse:!0,text:"Certain"}].map(t=>({...t,mean:Math.round((t.max+t.min)/2)})).map(t=>Object.freeze(t)),probabilities_plus_anchors=probabilities.map(({mean:t})=>t).concat([25,50,75]).sort((t,ee)=>t<ee?-1:1);function probability_is_in_range(t){const{min:ee,max:te,probability:ne}=t;return ee<=ne&&(ne<te||ne===0&&te===0||ne===100&&ee===100)}function get_probability_option(t){return probabilities.find(({min:ee,max:te})=>probability_is_in_range({min:ee,max:te,probability:t}))}function ProbablitySelection(t){const{probability:ee,set_probability:te}=t;return o$1("div",{children:[o$1("input",{type:"range",min:0,max:100,value:ee,onChange:ne=>te(parseFloat(ne.currentTarget.value)),list:"tickmarks_probability"}),o$1("datalist",{id:"tickmarks_probability",children:probabilities_plus_anchors.map(ne=>o$1("option",{value:ne,children:ne}))}),probabilities.map(({text:ne,min:oe,max:ie,mean:_e})=>{const se=probability_is_in_range({min:oe,max:ie,probability:ee});return o$1("span",{style:{backgroundColor:se?"blue":"",color:se?"white":"",border:"thin solid #aaa",borderRadius:3,margin:"2px 4px",padding:"2px 4px",cursor:"pointer"},onClick:()=>te(_e),children:[" ",ne," "]})})]})}function ProbabilityGraph(t){const{calc_x:ee,reverse:te,size:ne=400}=t,oe=.02,ie=4,_e=ne/ie,se=ie/oe,re=ce=>te?ne-ce:ce,ae=Array.from(Array(se)).map((ce,de)=>de*oe).map(ce=>({x1:re(ce*_e),y1:ne-ee(ce),x2:re((ce+oe)*_e),y2:ne-ee(ce+oe)}));return o$1("svg",{width:ne+1,height:ne,style:{margin:5},children:[o$1("line",{x1:1,y1:ne,x2:1,y2:0,stroke:"black"}),Array.from(Array(9)).map((ce,de)=>{const ue=ne*((de+1)/10);return o$1("line",{x1:ue,y1:ne,x2:ue,y2:0,stroke:"#bbb"})}),o$1("line",{x1:ne*.5,y1:ne,x2:ne*.5,y2:0,stroke:"#555"}),o$1("line",{x1:ne,y1:ne,x2:ne,y2:0,stroke:"black"}),o$1("g",{children:ae.map(({x1:ce,y1:de,x2:ue,y2:le})=>o$1("line",{x1:ce,y1:de,x2:ue,y2:le,stroke:"black"}))})]})}function factory_scaled_weibull(t){const{lambda:ee,k:te,scale:ne}=t;return oe=>te/ee*(oe/ee)**(te-1)*Math.exp(-((oe/ee)**te))*ne}const PredictionsGraph="";function WeibullGraphMaker(){const[t,ee]=h$1(1),[te,ne]=h$1(1),[oe,ie]=h$1(1),[_e,se]=h$1(!1);function re(de){ee(de);const ue=get_probability_option(de);ue&&(ne(ue.lambda),ie(ue.k),se(ue.reverse))}const ae=100,ce=factory_scaled_weibull({lambda:te,k:oe,scale:ae});return o$1("div",{children:["Probability: ",t,"%",o$1(ProbabilityGraph,{calc_x:ce,size:ae*4,reverse:_e}),o$1("br",{}),o$1(ProbablitySelection,{probability:t,set_probability:re}),o$1("br",{}),o$1("br",{}),"Lambda: ",te,o$1("input",{type:"range",value:te,max:10,step:.1,onChange:de=>ne(parseFloat(de.currentTarget.value.slice(0,4)))}),"k: ",oe,o$1("input",{type:"range",value:oe,max:10,step:.1,onChange:de=>ie(parseFloat(de.currentTarget.value.slice(0,4)))}),o$1("br",{}),o$1("hr",{}),o$1("br",{})]})}function DemoPredictionsGraph(){return o$1(WeibullGraphMaker,{})}function DemoPredictionsBadge(){const[t,ee]=h$1(1),[te,ne]=h$1(1),[oe,ie]=h$1(50),[_e,se]=h$1(void 0),[re,ae]=h$1(void 0);function ce(de){se(de.probability),ae(de.conviction)}return o$1("div",{children:[o$1("br",{}),"   ",o$1(PredictionBadge,{size:oe,probability:t/100,conviction:te/100,counterfactual_probability:_e,counterfactual_conviction:re,set_counterfactual:ce}),o$1("br",{}),o$1("br",{}),"Probability: ",t,"%",o$1(ProbablitySelection,{probability:t,set_probability:ee}),o$1("br",{}),"Confidence: ",te,"%",o$1(ProbablitySelection,{probability:te,set_probability:ne}),o$1("br",{}),"Size: ",oe,o$1("input",{type:"range",min:1,max:100,value:oe,onChange:de=>ie(parseInt(de.currentTarget.value,10))})]})}const SandBox$1="";function SandBox(){return o$1("div",{children:"..."})}const map_state$5=t=>({editing:!t.display_options.consumption_formatting}),map_dispatch={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting},connector$5=connect(map_state$5,map_dispatch);function _SandboxEditableCustomDateTime(t){const ee=get_today_str(),[te,ne]=h$1(new Date(ee));return p$1(()=>{t.editing||t.toggle_consumption_formatting({})},[]),o$1("div",{children:["EditableCustomDateTime",o$1(EditableCustomDateTime,{value:te,on_change:oe=>oe&&ne(oe)})]})}const SandboxEditableCustomDateTime=connector$5(_SandboxEditableCustomDateTime),map_state$4=(t,{judgement:ee})=>{const te=ee.judgement_target_wcomponent_id,ne=t.specialised_objects.wcomponents_by_id[te];return{wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,target_wcomponent:ne,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map(t)}},connector$4=connect(map_state$4),_ProjectJudgementEntry=t=>{var ce,de;if(!t.target_wcomponent)return o$1("div",{children:["Can not find judgement's target wcomponent of id: ",t.judgement.judgement_target_wcomponent_id]});const{knowledge_view:ee,judgement:te,target_wcomponent:ne,wc_id_to_counterfactuals_map:oe,wcomponents_by_id:ie,knowledge_views_by_id:_e,created_at_ms:se,sim_ms:re}=t,ae=oe&&((ce=oe[ne.id])==null?void 0:ce.VAP_sets);return o$1("div",{style:{display:"flex",flexDirection:"row",flexBasis:"100",padding:"3px 5px",margin:2,borderBottom:"thin solid #aaa"},children:[o$1("div",{style:{flex:"5",cursor:"pointer"},onClick:()=>{const ue=ne.id,le=get_url_for_wcomponent({knowledge_view:ee,wcomponent_id:ue});window.location.href=le},children:o$1(RichMarkDown,{text:get_title$1({wcomponents_by_id:ie,knowledge_views_by_id:_e,wcomponent:ne,wc_id_to_counterfactuals_map:oe,created_at_ms:se,sim_ms:re})})}),o$1("div",{style:{flex:"1",textAlign:"right"},children:(de=get_wcomponent_state_UI_value({wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:ae,created_at_ms:se,sim_ms:re}))==null?void 0:de.values_string}),o$1("div",{style:{flex:"1"},children:[" ",te.judgement_operator," ",te.judgement_comparator_value]}),o$1("a",{style:{flex:"4",cursor:"pointer",display:"flex",textDecoration:"inherit",color:"inherit"},href:(()=>{const ue=te.id;return get_url_for_wcomponent({knowledge_view:ee,wcomponent_id:ue})})(),children:[o$1(JudgementBadge,{judgement:calculate_judgement_value({judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:ae,created_at_ms:se,sim_ms:re}),judgement_trend_manual:te.judgement_trend_manual,size:"medium"}),o$1(RichMarkDown,{text:get_title$1({wcomponents_by_id:ie,knowledge_views_by_id:_e,wcomponent:te,wc_id_to_counterfactuals_map:void 0,created_at_ms:se,sim_ms:re})})]})]})},ProjectJudgementEntry=connector$4(_ProjectJudgementEntry);function get_url_for_wcomponent(t){const ee=t.knowledge_view.wc_id_map[t.wcomponent_id],te=lefttop_to_xy({...ee,zoom:100},!0),ne=te&&te.x||0,oe=te&&te.y||0;return`/app${format_wcomponent_url("",t.wcomponent_id)}&x=${ne}&y=${oe}&zoom=100&view=knowledge&subview_id=${t.knowledge_view.id}`}const map_state$3=(t,{knowledge_view_id:ee})=>({judgements:t.derived.wcomponent_ids_by_type.judgement,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_view:t.specialised_objects.knowledge_views_by_id[ee]}),connector$3=connect(map_state$3),_ProjectDashboard=t=>{const{knowledge_view:ee}=t;if(!ee)return o$1("div",{children:["Can not find Knowledge view of id: ",t.knowledge_view_id]});const ne=Object.keys(ee.wc_id_map).filter(ie=>t.judgements.has(ie)).map(ie=>t.wcomponents_by_id[ie]).filter(ie=>!!ie).sort((ie,_e)=>ie.judgement_target_wcomponent_id<_e.judgement_target_wcomponent_id?-1:ie.judgement_target_wcomponent_id>_e.judgement_target_wcomponent_id?1:0),oe=new Date().getTime();return o$1("div",{style:{display:"flex",flexDirection:"column"},children:ne.map(ie=>o$1(ProjectJudgementEntry,{knowledge_view:ee,judgement:ie,created_at_ms:oe,sim_ms:oe}))})},ProjectDashboard=connector$3(_ProjectDashboard),map_state$2=t=>({knowledge_views:t.derived.knowledge_views}),connector$2=connect(map_state$2),_DemoProjectDashboard=t=>{const[ee,te]=h$1(void 0);return o$1("div",{children:["DemoProjectDashboard",t.knowledge_views.map(ne=>o$1("div",{onClick:()=>te(ne.id),style:{fontWeight:ne.id===ee?"bold":"initial",cursor:"pointer"},children:ne.title})),ee&&o$1("div",{children:[o$1("hr",{}),o$1(ProjectDashboard,{knowledge_view_id:ee})]})]})},DemoProjectDashboard=connector$2(_DemoProjectDashboard);function sandbox_code(){const t=new Date("2021-01-01"),ee={use_creation_context:!0,creation_context:{custom_created_at:t,label_ids:[]}},te=prepare_new_VAP_set(VAPsType.undefined,{},[],-1,ee);te.entries[0].value="thing",te.entries[0].probability=.6,te.shared_entry_values={conviction:.4};const ne={type:"statev2",subtype:"boolean",id:"wc11",created_at:t,base_id:-1,title:"wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title ",description:"wc11 description",values_and_prediction_sets:[te]},oe={type:"judgement",id:"wc12",created_at:t,base_id:-1,title:"wc12 title",description:"wc12 description",judgement_target_wcomponent_id:ne.id,judgement_operator:"==",judgement_comparator_value:"True"},ie={...oe,id:"wc13",judgement_operator:"!="},_e=prepare_new_VAP_set(VAPsType.undefined,{},[],-1,ee);_e.entries[0].probability=0;const se={...ne,id:"wc14",created_at:t,base_id:-1,title:"wc14 title ${value}",description:"wc14 description",values_and_prediction_sets:[_e]},re=[ne,oe,ie,se],ae={id:"kv10",title:"kv10 title",description:"kv10 description",wc_id_map:{[ne.id]:{left:400,top:100},[se.id]:{left:700,top:100}},created_at:t,base_id:-1,goal_ids:[],sort_type:"normal"};return{wcomponents:re,wc11:ne,kv10:ae}}function SandboxWComponentCanvasNode(){const{wcomponents:t,wc11:ee,kv10:te}=sandbox_code();let ne=get_starting_state$1(!1);ne={...ne,routing:{route:"wcomponents",sub_route:null,item_id:ee.id,args:{...ne.routing.args,view:"knowledge",subview_id:te.id}}};const oe=get_store({load_state_from_storage:!1,override_preloaded_state:ne});return oe.dispatch(ACTIONS.specialised_object.replace_all_specialised_objects({specialised_objects:{wcomponents:t,knowledge_views:[te]}})),o$1(Provider,{store:oe,children:o$1(WComponentCanvasNodes,{wcomponents:t})})}const map_state$1=t=>({rich_text_formatting:t.display_options.consumption_formatting}),connector$1=connect(map_state$1);function _WComponentCanvasNodes(t){return o$1("div",{children:["WComponentCanvasNodes ",""+t.rich_text_formatting,t.wcomponents.map(({id:ee})=>o$1(WComponentCanvasNode,{id:ee}))]})}const WComponentCanvasNodes=connector$1(_WComponentCanvasNodes),map_state=t=>({}),connector=connect(map_state);function _SandBoxConnected(t){const[ee,te]=h$1("testing 123");return o$1("div",{children:o$1(EditableTextSingleLine,{placeholder:"1",force_focus_on_first_render:!0,value:ee,on_blur:te,on_blur_type:EditableTextOnBlurType.conditional})})}const SandBoxConnected=connector(_SandBoxConnected);let is_supabase_recovery_email=document.location.hash.includes("type=recovery");const supabase=get_supabase(),supabase_auth_state_change={subscribers:[]};supabase.auth.onAuthStateChange(()=>{supabase_auth_state_change.subscribers.forEach(t=>t())});window.supabase=supabase;function SandBoxSupabase(){const[t,ee]=h$1(supabase.auth.user()),[te,ne]=h$1(""),[oe,ie]=h$1(""),[_e,se]=h$1(null),[re,ae]=h$1(!1),[ce,de]=h$1(!1),[ue,le]=h$1(is_supabase_recovery_email),[pe,me]=h$1(!1),[fe,ge]=h$1(null),[he,be]=h$1(void 0),[ve,we]=h$1(void 0);p$1(()=>{var Ce;if(!he)return we(void 0);if(!ve||!he.find(({id:Ee})=>Ee===ve))return we((Ce=he.filter(Ee=>Ee.owner_user_id===(t==null?void 0:t.id))[0])==null?void 0:Ce.id)},[he]);const ye=he==null?void 0:he.find(({id:Ce})=>Ce===ve),[ke,Ae]=h$1({}),[$e,Se]=h$1(void 0),Te=Ce=>{Se(Ce&&sort_list(Ce,Ee=>Ee.inserted_at.getTime(),SortDirection.ascending))};p$1(()=>{ve?get_access_controls({base_id:ve,set_postgrest_error:ge,set_access_controls:Te}):Te(void 0)},[ve]);const[xe,Ie]=h$1(void 0),Pe=xe&&xe[0],je=!!t&&t.id===(ye==null?void 0:ye.owner_user_id);p$1(()=>{const Ce=async()=>{const Ve=supabase.auth.user();ee(Ve),ne((Ve==null?void 0:Ve.email)||te);const{data:Fe,error:Ut}=await supabase.from("users").select("*");ge(Ut);const Ye={};(Fe||[]).forEach(Je=>Ye[Je.id]=Je),Ae(Ye)};return Ce(),supabase_auth_state_change.subscribers.push(Ce),()=>{const{subscribers:Ve}=supabase_auth_state_change;supabase_auth_state_change.subscribers=Ve.filter(Fe=>Fe!==Ce)}},[]);async function De(){me(!0);const{user:Ce,error:Ee}=await supabase.auth.signUp({email:te,password:oe});me(!1),se(Ee),ae(!0)}async function We(){me(!0);const{user:Ce,error:Ee}=await supabase.auth.signIn({email:te,password:oe});me(!1),se(Ee),ee(Ce)}async function ze(){me(!0);const{data:Ce,error:Ee}=await supabase.auth.api.resetPasswordForEmail(te);me(!1),se(Ee),de(!Ee)}async function Le(){const Ce=t==null?void 0:t.email;me(!0);const Ee=await supabase.auth.update({email:Ce,password:oe});me(!1),se(Ee.error),ee(Ee.user),le(!!Ee.error),is_supabase_recovery_email=!1}async function qt(){me(!0);const{error:Ce}=await supabase.auth.signOut();me(!1),se(Ce),ee(supabase.auth.user()),ie("")}const Vt="d9e6dde1-15e7-4bdf-a6ca-3cc769c131ee";if(ce)return o$1("div",{children:[o$1("h3",{children:"Password reset"}),o$1("br",{}),!_e&&"Please check your email",o$1(DisplaySupabaseSessionError,{error:_e})]});if(!t||ue)return o$1("div",{children:[ue?"Reset password":"Signin / Register",o$1("br",{}),o$1("form",{children:[o$1("input",{type:"email",placeholder:"email",value:te,disabled:ue,onKeyUp:Ce=>ne(Ce.currentTarget.value),onChange:Ce=>ne(Ce.currentTarget.value),onBlur:Ce=>ne(Ce.currentTarget.value)}),o$1("br",{}),o$1("input",{type:"password",placeholder:"password",value:oe,onKeyUp:Ce=>ie(Ce.currentTarget.value),onChange:Ce=>ie(Ce.currentTarget.value),onBlur:Ce=>ie(Ce.currentTarget.value)}),o$1("br",{})]}),ue&&o$1("div",{children:[pe&&o$1(default_1$5,{className:"animate spinning"}),o$1("input",{type:"button",value:"Update password",disabled:pe||!(t!=null&&t.email)||!oe,onClick:Le}),o$1("br",{}),!is_supabase_recovery_email&&o$1("input",{type:"button",onClick:()=>le(!1),value:"Cancel"}),o$1("br",{})]}),!ue&&o$1("div",{children:[pe&&o$1(default_1$5,{className:"animate spinning"}),o$1("input",{type:"button",value:"Signin",disabled:pe||!te||!oe,onClick:We}),o$1("input",{type:"button",value:"Register",disabled:pe||!te||!oe,onClick:De}),o$1("br",{}),o$1("input",{type:"button",value:"Forgot password?",disabled:pe||!te,onClick:ze}),o$1("br",{})]}),o$1(DisplaySupabaseSessionError,{error:_e})]});if(re)return o$1("div",{children:[o$1("h3",{children:"Registered"}),o$1("br",{}),"Please check your email"]});const Be=t.id;return o$1("div",{children:["Logged in with ",t.email," ",t.id,o$1("br",{}),pe&&o$1(default_1$5,{className:"animate spinning"}),o$1("input",{type:"button",value:"Log out",disabled:pe,onClick:qt}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>le(!0),value:"Change password"}),o$1("br",{}),o$1(Username,{user:t,users_by_id:ke,set_postgrest_error:ge}),o$1("br",{}),o$1(DisplaySupabaseSessionError,{error:_e}),o$1("br",{}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>get_all_bases2({set_postgrest_error:ge,set_bases:be,user_id:Be}),value:"Get all bases"}),o$1("input",{type:"button",onClick:()=>get_or_create_an_owned_base({user_id:Be,set_postgrest_error:ge,set_current_base_id:we}),value:"Get a base (optionally create)"}),o$1("br",{}),o$1("br",{}),o$1(DisplaySupabasePostgrestError,{error:fe}),o$1("h3",{children:"Bases"}),o$1("br",{}),he&&o$1("div",{children:[he.length," bases ",o$1("br",{}),he.map(Ce=>{const{access_level:Ee}=Ce,Ve=Ee==="editor"?"Editor":Ee==="viewer"?"Viewer":Ce.public_read?"Viewer (public access)":"?";return o$1("div",{style:{fontWeight:Ce.id===(ye==null?void 0:ye.id)?"bold":void 0},children:[o$1("input",{type:"radio",checked:Ce.id===(ye==null?void 0:ye.id),onClick:()=>we(Ce.id)}),"  ",Ce.public_read?"Public":"Private","   title: ",Ce.title,"   owned by: ",get_user_name_for_display({users_by_id:ke,current_user_id:Be,other_user_id:Ce.owner_user_id}),"   id: ",Ce.id,"  ",Ce.owner_user_id!==t.id&&o$1("span",{children:["access: ",Ve,"  "]})]})})]}),ye&&o$1("div",{children:[o$1("hr",{}),o$1("br",{}),o$1("h3",{children:"Base modification"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Ce={...ye,title:"Title changed"};modify_base_wrapper({base:Ce,set_postgrest_error:ge,set_bases:be,user_id:Be})},value:"Modify base (change title)"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Ce={...ye,title:"Primary"};modify_base_wrapper({base:Ce,set_postgrest_error:ge,set_bases:be,user_id:Be})},value:"Modify base (reset title)"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Ce={...ye,owner_user_id:Vt};modify_base_wrapper({base:Ce,set_postgrest_error:ge,set_bases:be,user_id:Be})},value:"Modify base (change owner to user_1 -- should FAIL if different user)"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Ce={...ye,public_read:!ye.public_read};modify_base_wrapper({base:Ce,set_postgrest_error:ge,set_bases:be,user_id:Be})},value:"Modify base (toggle public read)"}),o$1("br",{})]}),ye&&ve&&o$1("div",{children:[o$1("hr",{}),o$1("br",{}),o$1("h3",{children:"Base sharing"}),o$1("br",{}),ye.public_read?"Is PUBLIC":"Is private (not public)",o$1("br",{}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>get_access_controls({base_id:ve,set_postgrest_error:ge,set_access_controls:Te}),value:"Refresh sharing info"}),o$1("br",{}),$e&&o$1("div",{children:[$e.length," access controls",$e.map(Ce=>o$1("div",{children:o$1(AccessControlEntry,{access_control:Ce,base_id:ve,users_by_id:ke,current_user_id:t==null?void 0:t.id,is_owner:je,on_update:Ee=>on_update_access_control({base_id:ve,res:Ee,set_postgrest_error:ge,set_access_controls:Te})})})),o$1("br",{}),"Id or email address of user's account:",o$1(AddAccessControlEntry,{base_id:ve,on_add_or_exit:Ce=>{Ce&&get_access_controls({base_id:ve,set_postgrest_error:ge,set_access_controls:Te})}})]})]}),ve!==void 0&&o$1("div",{children:[o$1("hr",{}),o$1("br",{}),o$1("h3",{children:"Knowledge Views"}),o$1("br",{}),o$1("input",{type:"button",onClick:async()=>{const{error:Ce,value:Ee}=await supabase_get_knowledge_views({supabase,base_id:ve});ge(Ce||null),Ie(Ee)},value:`Get knowledge views for base ${ve}`}),o$1("input",{type:"button",onClick:async()=>{const{error:Ce,value:Ee}=await supabase_get_knowledge_views({supabase,all_bases:!0});ge(Ce||null),Ie(Ee)},value:"Get all knowledge views"}),o$1("input",{type:"button",onClick:()=>create_knowledge_views({base_id:ve,set_postgrest_error:ge,set_knowledge_views:Ie}),value:`Create knowledge view in base ${ve}`})]}),xe&&o$1("div",{children:[xe.length," knowledge views",xe.map(Ce=>o$1("div",{children:[o$1("b",{children:"base_id"}),": ",Ce.base_id,"  ",o$1("b",{children:"id"}),": ",Ce.id,"  ",o$1("b",{children:"title"}),": ",Ce.title,"  ",o$1("b",{children:"description"}),": ",Ce.description,"  ",o$1("b",{children:"wc_id_map ids"}),": ",JSON.stringify(Object.keys(Ce.wc_id_map||{})),"  ",o$1("b",{children:"json"}),": ",JSON.stringify({...Ce,base_id:void 0,id:void 0,title:void 0,description:void 0}),"  ",o$1("hr",{})]}))]}),xe&&Pe&&o$1("div",{children:o$1("input",{type:"button",onClick:()=>modify_knowledge_view({knowledge_view:Pe,current_knowledge_views:xe,set_postgrest_error:ge,set_knowledge_views:Ie}),value:"Modify a knowledge view (set random title) then fetch all for all bases"})})]})}function Username(t){var ce;const[ee,te]=h$1(""),[ne,oe]=h$1(!1),{user:ie,users_by_id:_e,set_postgrest_error:se}=t,re=((ce=_e[ie.id])==null?void 0:ce.name)||"";p$1(()=>{ee!==re&&te(re)},[re]);async function ae(de){var me;oe(!0);const{id:ue}=ie,{data:le,error:pe}=await supabase.from("users").upsert({id:ue,name:de}).eq("id",ue);se(pe),te(le&&((me=le[0])==null?void 0:me.name)||""),oe(!1)}return o$1("div",{children:[ne?"Saving":"Your"," user name:",o$1("input",{type:"text",placeholder:"username",value:ee,disabled:ne,onKeyUp:de=>te(de.currentTarget.value),onChange:de=>te(de.currentTarget.value),onBlur:async de=>{te(de.currentTarget.value),ae(de.currentTarget.value)}}),o$1("br",{})]})}async function get_or_create_an_owned_base(t){const{base:ee,error:te}=await get_an_owned_base_optionally_create(t.user_id);t.set_postgrest_error(te),t.set_current_base_id(ee==null?void 0:ee.id)}async function get_an_owned_base_optionally_create(t){const ee=await get_an_owned_base(t);if(ee.error||ee.base)return ee;const te=await create_a_base({owner_user_id:t});return te.error?te:await get_an_owned_base(t)}async function get_an_owned_base(t){const ee=get_supabase(),{data:te,error:ne}=await ee.from("bases").select("*").eq("owner_user_id",t).order("inserted_at",{ascending:!0});return{base:te&&te[0]||void 0,error:ne}}async function get_all_bases2(t){const ee=await get_all_bases(t.user_id);t.set_postgrest_error(ee.error),t.set_bases(ee.data)}async function modify_base_wrapper(t){const{base:ee,set_postgrest_error:te,set_bases:ne}=t,oe=await modify_base(ee);te(oe.error),oe.error||await get_all_bases2({set_postgrest_error:te,set_bases:ne,user_id:t.user_id})}async function get_access_controls(t){const ee=await get_access_controls_for_base(t.base_id);t.set_postgrest_error(ee.error),t.set_access_controls(ee.access_controls)}async function on_update_access_control(t){t.set_postgrest_error(t.res.error),t.res.error||await get_access_controls(t)}async function create_knowledge_views(t){const te=generate_default_data(t.base_id).knowledge_views[0],{data:ne,error:oe}=await supabase.from("knowledge_views").insert(knowledge_view_app_to_supabase(te,t.base_id));t.set_postgrest_error(oe);const ie=(ne||[]).map(knowledge_view_supabase_to_app);t.set_knowledge_views(ie)}async function modify_knowledge_view(t){const{knowledge_view:ee,current_knowledge_views:te,set_postgrest_error:ne,set_knowledge_views:oe}=t,ie={...ee,title:"Some new title "+Math.random()},_e=knowledge_view_app_to_supabase(ie),se=await supabase.rpc("update_knowledge_view",{item:_e});let re=se.error;if(se.status===404&&(re={message:"Not Found",details:"",hint:"",code:"404"}),ne(re),re)return;const ae=se.data;if(!ae)return;const ce=knowledge_view_supabase_to_app(ae),de=replace_element(te,ce,ue=>ue.id===ee.id);oe(de)}function generate_default_data(t){const ee=prepare_new_contextless_wcomponent_object({base_id:t,title:"wc1"}),te=[ee];return{knowledge_views:[get_new_knowledge_view_object({id:v4(),base_id:t,title:"kv1",wc_id_map:{[ee.id]:{left:0,top:0}}})],wcomponents:te}}function DevLandingPage(){return o$1(Container,{maxWidth:"md",children:o$1("ul",{children:[o$1("li",{children:o$1("a",{href:"/production_landing_page/",children:"Landing page"})}),o$1("li",{children:o$1("a",{href:"/app/",children:"app"})}),o$1("li",{children:o$1("a",{href:"/sim/",children:"Sim"})}),o$1("li",{children:o$1("a",{href:"/data/",children:"Data"})}),o$1("li",{children:o$1("a",{href:"/project_dashboard",children:"Project dashboard"})}),o$1("li",{children:o$1("a",{href:"/prob_graph",children:"Probability graph"})}),o$1("li",{children:o$1("a",{href:"/prob_badge",children:"Probability badge"})}),o$1("li",{children:o$1("a",{href:"/sandbox/editable_custom_datetime",children:"Sandbox - EditableCustomDateTime"})}),o$1("li",{children:o$1("a",{href:"/sandbox/canvas_nodes",children:"Sandbox - WComponentNode"})}),o$1("li",{children:o$1("a",{href:"/sandbox/circular_connections",children:"Sandbox - Circular Connections"})}),o$1("li",{children:o$1("a",{href:"/sandbox/supabase",children:"Sandbox - Supabase"})}),o$1("li",{children:o$1("a",{href:"/sandbox/connected",children:"Sandbox - Connected"})}),o$1("li",{children:o$1("a",{href:"/sandbox",children:"Sandbox"})})]})})}const ScenarioGroupRunResult="";function ScenarioGroupRunResultComponent(t){const{scenario_group_run_result:ee}=t,te=as_percent(ee.total_completed/ee.total_to_run),ne=te===100,oe="scenario_group_run_result "+(ne?" complete ":" incomplete "),ie=F$1(()=>{if(!ne)return"Pending...";const{total_to_run:_e}=ee;let se=0,re=0,ae=0,ce=0;ee.results.forEach(fe=>{se+=fe.sim_time_seconds,re+=fe.result.all_companies_solvent?1:0,ae+=fe.result.customer_demand_fulfilled_percentage,ce+=fe.result.total_company_profit});const de=round_number(se/_e/(3600*24),1),ue=as_percent(re/_e),le=round_number(ae/_e,1),pe=round_number(ce/_e,1);return`Mean --- Run time (days) ${de} --- Solvent: ${ue}% --- Demand met: ${le}% --- Company profit ${pe}$`},[ne]);return o$1("div",{className:oe,children:[date2str_auto({date:ee.started,time_resolution:"second"}),"  ",te,"%    ",ie]})}function as_percent(t){return Math.round(t*100)}let scenario_group_run=0;const beer_game_simulator={schedule_sim:(t,ee,te)=>{let ne=[];const oe={id:`${++scenario_group_run}`,started:new Date,...t,total_completed:0,results:ne};te(oe),run_sims(oe,ee,_e=>{ne=[...ne,_e],te({...oe,total_completed:ne.length,results:ne})})}};async function run_sims(t,ee,te){const{total_to_run:ne,max_sim_time_seconds:oe}=t;for(let ie=0;ie<ne;++ie){const _e=run_simulation__beer_game(oe,ee);te(_e)}}function run_simulation__beer_game(t,ee){var me;const ne=t/86400,oe=get_new_actor_customers(ee),ie=get_new_actor_retailer(ee),_e=get_new_actor_wholesaler(ee),se=get_new_actor_distributor(ee),re=get_new_actor_manufacturer(ee);let ae="time_limit",ce={},de=0;for(;de<ne&&ae!=="end_condition";++de){let fe=0;console.group(`day: ${de}`);do{++fe;const ge=ce[de]||[];delete ce[de];const he=[...oe.process(de,fe,ge),...ie.process(de,fe,ge),..._e.process(de,fe,ge),...se.process(de,fe,ge),...re.process(de,fe,ge)];if(ce=add_messages_by_delivery_day(ce,de,he),console.log("iteration",fe,"current_messages",ge,"all_new_messages",he,"existing_messages_by_day",ce),ie.get_end_condition_met()||_e.get_end_condition_met()||se.get_end_condition_met()||re.get_end_condition_met()){ae="end_condition";break}}while((me=ce[de])!=null&&me.length);console.groupEnd()}const ue=ie.get_is_solvent()&&_e.get_is_solvent()&&se.get_is_solvent()&&re.get_is_solvent(),le=ie.get_company_profit()+_e.get_company_profit()+se.get_company_profit()+re.get_company_profit();return{started:new Date,sim_time_seconds:de*86400,status:"complete",stop_reason:ae,result:{total_customer_demand:oe.get_total_customer_demand(),customer_demand_fulfilled_percentage:oe.get_customer_demand_fulfilled_percentage(),all_companies_solvent:ue,total_company_profit:le}}}function add_messages_by_delivery_day(t,ee,te){return validate_new_messages(te),t={...t},te.forEach(ne=>{const oe=ee+ne.delivery_delay_days;let ie=t[oe]||[];ie=[...ie,ne],t[oe]=ie}),t}function validate_new_messages(t){if(t.find(te=>te.delivery_delay_days<0))throw new Error("Invalid message")}function factory_is_a_message(t){return function(ee){return ee.type===t}}const accept_demand_from_map={retailer:"consumer",wholesaler:"retailer",distributor:"wholesaler",manufacturer:"distributor"},accept_product_from_map={consumer:"retailer",retailer:"wholesaler",wholesaler:"distributor",distributor:"manufacturer",manufacturer:void 0},is_a_product_demand_message=factory_is_a_message("product_demand"),is_a_product_demand_fulfilment_message=factory_is_a_message("product_demand_fulfilment");function get_new_actor_customers(t){const{consumers_initial_demand:ee,consumers_demand_increase_delay_days:te,consumers_increased_demand:ne}=t,oe=accept_product_from_map.consumer;let ie=0,_e=0;return{process:(se,re,ae)=>{const ce=[];if(re===1){const de=se<te?ee:ne;ie+=de;const ue={type:"product_demand",origin:"consumer",delivery_delay_days:0,demand:de};console.log(`consumer demanded ${de}`),ce.push(ue)}return ae.forEach(de=>{is_a_product_demand_fulfilment_message(de)&&de.origin===oe&&(_e+=de.demand_fulfilled,console.log(`consumer recieved ${de.demand_fulfilled}`))}),ce},get_end_condition_met:()=>!1,get_total_customer_demand:()=>ie,get_customer_demand_fulfilled_percentage:()=>_e/ie*100}}function get_common_business_starting_state(t){const ee=t.retailer_initial_balance,te=t.retailer_initial_stock,ne=t.retailer_storage,oe=Math.round(ne*.8),_e={balance:ee,stock:te,storage:ne,pending_delivery:0,stock_to_dispatch:0,target_stock_level:oe,spoiled_stock:0};function se(re){if(re<0)throw new Error(`val: ${re} < 0`);return re}return{get_balance:()=>_e.balance,set_balance:re=>_e.balance=re,get_stock:()=>_e.stock,set_stock:re=>{_e.stock=se(re);const ae=_e.stock-_e.storage;ae>0&&(_e.spoiled_stock+=ae,_e.stock=_e.storage)},get_storage:()=>_e.storage,get_pending_delivery:()=>_e.pending_delivery,set_pending_delivery:re=>_e.pending_delivery=se(re),get_stock_to_dispatch:()=>_e.stock_to_dispatch,set_stock_to_dispatch:re=>_e.stock_to_dispatch=se(re),get_target_stock_level:()=>_e.target_stock_level,is_solvent:()=>_e.balance>=0,get_profit:()=>_e.balance-ee,get_spoiled_stock:()=>_e.spoiled_stock}}function common_business_message_processor(t,ee,te,ne){const oe=[],ie=accept_demand_from_map[t],_e=accept_product_from_map[t];return ne.forEach(se=>{if(is_a_product_demand_message(se)&&se.origin===ie){const re=dispatch_stock(t,ee,se.demand,te);oe.push(re)}if(is_a_product_demand_fulfilment_message(se)&&se.origin===_e){const re=ee.get_stock(),ae=re+se.demand_fulfilled;console.log(`${t} got delivery ${re} -> ${ae}`),ee.set_stock(ae)}}),oe}function dispatch_stock(t,ee,te,ne){if(te<=0)throw new Error("Demand must be greater than 0 to dispatch");const oe=ee.get_stock(),ie=Math.min(te,oe);ee.set_stock(oe-ie);const _e=te-ie,se=ee.get_stock_to_dispatch();ee.set_stock_to_dispatch(se+_e);const re=t==="retailer"?0:ne.transport_time_in_days,ae=get_price_of_sellers_product(t,ne),ce=ee.get_balance(),de=ie*ae,ue=ce+de;return ee.set_balance(ue),console.log(`${t} got demand ${te}, fulfilled: ${ie} for ${de}$ now has ${ue}$`),{type:"product_demand_fulfilment",origin:t,delivery_delay_days:re,demand_fulfilled:ie}}function get_price_of_sellers_product(t,ee){const te=t==="retailer"?ee.retailer_initial_price:t==="wholesaler"?ee.wholesaler_initial_price:t==="distributor"?ee.distributor_initial_price:t==="manufacturer"?ee.manufacturer_initial_price:0;if(te<0)throw new Error("Price should always be >= 0");return te}function common_business_day_processor(t,ee,te,ne,oe,ie){const _e=[],se=ee.get_stock_to_dispatch();if(se&&ee.get_stock()){const re=Math.min(se,ee.get_stock());ee.set_stock_to_dispatch(se-re);const ae=dispatch_stock(t,ee,re,te);console.log(`^^ ${t} shipped late product ^^`),_e.push(ae)}if(oe===1&&ne%te.days_between_stock_take===0){const re=ee.get_pending_delivery(),ae=(ee.get_target_stock_level()-(ee.get_stock()+re))*te.demand_signal_multiplier,ce=accept_product_from_map[t],de=get_price_of_sellers_product(ce,te),ue=ae*de,le=ee.get_balance(),pe=ue<=le?ae:Math.floor(le/de),me=le-pe*de;if(ee.set_balance(me),pe>0){if(t!=="manufacturer"){const fe={type:"product_demand",origin:t,delivery_delay_days:0,demand:pe};ee.set_pending_delivery(re+pe),_e.push(fe)}ie&&ie(pe)}}return _e}function get_new_actor_retailer(t){const ee="retailer",te=get_common_business_starting_state(t);return{process:(ne,oe,ie)=>{let _e=common_business_message_processor(ee,te,t,ie);const se=common_business_day_processor(ee,te,t,ne,oe);return _e=_e.concat(se),_e},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}function get_new_actor_wholesaler(t){const ee="wholesaler",te=get_common_business_starting_state(t);return{process:(ne,oe,ie)=>{let _e=common_business_message_processor(ee,te,t,ie);const se=common_business_day_processor(ee,te,t,ne,oe);return _e=_e.concat(se),_e},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}function get_new_actor_distributor(t){const ee="distributor",te=get_common_business_starting_state(t);return{process:(ne,oe,ie)=>{let _e=common_business_message_processor(ee,te,t,ie);const se=common_business_day_processor(ee,te,t,ne,oe);return _e=_e.concat(se),_e},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}function get_new_actor_manufacturer(t){const ee="manufacturer",te=get_common_business_starting_state(t),ne={};return{process:(oe,ie,_e)=>{if(ie===1){const ce=te.get_stock(),de=ce+(ne[oe]||0);de>ce&&console.log("Manufactuer made new_stock ",ce,de),te.set_stock(de)}let se=common_business_message_processor(ee,te,t,_e);const ae=common_business_day_processor(ee,te,t,oe,ie,ce=>{const de=oe+t.manufacturing_delay_in_days;if(ne[de])throw new Error(`Already making goods for day: ${de}`);ce&&console.log("Manufactuer scheduling to make new_stock ",ce),ne[de]=ce});return se=se.concat(ae),se},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}const SimulationScenarioSummary$1="";function SimulationScenarioSummary(t){const{scenario_kv_id:ee,knowledge_views_by_id:te,wcomponents_by_id:ne,created_at_ms:oe,sim_ms:ie}=t,_e=te[ee],[se,re]=h$1([]),ae=xe=>{const Ie=upsert_entry(se,xe,Pe=>Pe.id===xe.id);re(Ie)};if(!_e)return o$1("div",{children:["Unknown scenario knowledge view for id: ",ee]});const ce=F$1(()=>calculate_composed_knowledge_view({knowledge_view:_e,knowledge_views_by_id:te,wcomponents_by_id:ne}),[_e,te,ne]),de={attribute_to_wc_id_map:t.simulation.attribute_to_wc_id_map,wcomponents_by_id:ne,composed_kv:ce,created_at_ms:oe,sim_ms:ie},ue=get_attribute_initial_number("consumers_initial_demand",de),le=get_attribute_initial_number("consumers_demand_increase_delay_days",de),pe=get_attribute_initial_number("consumers_increased_demand",de);if(!ue)return o$1("div",{children:[_e.title," missing consumers_initial_demand attribute"]});if(!le)return o$1("div",{children:[_e.title," missing consumers_demand_increase_delay_days attribute"]});if(!pe)return o$1("div",{children:[_e.title," missing consumers_increased_demand attribute"]});const me=get_attribute_initial_number("retailer_initial_price",de),fe=get_attribute_initial_number("retailer_initial_balance",de),ge=get_attribute_initial_number("retailer_initial_stock",de),he=get_attribute_initial_number("retailer_storage",de);if(!me)return o$1("div",{children:[_e.title," missing retailer_initial_price attribute"]});if(!fe)return o$1("div",{children:[_e.title," missing retailer_initial_balance attribute"]});if(!ge)return o$1("div",{children:[_e.title," missing retailer_initial_stock attribute"]});if(!he)return o$1("div",{children:[_e.title," missing retailer_storage attribute"]});const be=get_attribute_initial_number("wholesaler_initial_price",de);if(!be)return o$1("div",{children:[_e.title," missing wholesaler_initial_price attribute"]});const ve=get_attribute_initial_number("distributor_initial_price",de);if(!ve)return o$1("div",{children:[_e.title," missing distributor_initial_price attribute"]});const we=get_attribute_initial_number("manufacturer_initial_price",de),ye=get_attribute_initial_number("manufacturing_delay_in_days",de);if(!we)return o$1("div",{children:[_e.title," missing manufacturer_initial_price attribute"]});if(!ye)return o$1("div",{children:[_e.title," missing manufacturing_delay_in_days attribute"]});const ke=get_attribute_initial_number("demand_signal_multiplier",de);if(!ke)return o$1("div",{children:[_e.title," missing demand_signal_multiplier attribute"]});const Ae=get_attribute_initial_number("days_between_stock_take",de);if(!Ae)return o$1("div",{children:[_e.title," missing days_between_stock_take attribute"]});const $e=get_attribute_initial_number("transport_time_in_days",de);if(!$e)return o$1("div",{children:[_e.title," missing transport_time_in_days attribute"]});const Se={total_to_run:1,max_sim_time_seconds:3600*24*365},Te={consumers_initial_demand:ue.parsed_value,consumers_demand_increase_delay_days:le.parsed_value,consumers_increased_demand:pe.parsed_value,retailer_initial_price:me.parsed_value,retailer_initial_balance:fe.parsed_value,retailer_initial_stock:ge.parsed_value,retailer_storage:he.parsed_value,wholesaler_initial_price:be.parsed_value,distributor_initial_price:ve.parsed_value,manufacturer_initial_price:we.parsed_value,manufacturing_delay_in_days:ye.parsed_value,demand_signal_multiplier:ke.parsed_value,days_between_stock_take:Ae.parsed_value,transport_time_in_days:$e.parsed_value};return o$1("div",{className:"scenario_summary",children:[_e.title,o$1("div",{className:"simulation_run",children:[o$1(Button,{value:"Run",onClick:()=>{beer_game_simulator.schedule_sim(Se,Te,ae)}}),o$1(Button,{value:"Run x100",onClick:()=>{beer_game_simulator.schedule_sim({...Se,total_to_run:100},Te,ae)}})]}),o$1("br",{}),"retailer_initial_stock: ",ge==null?void 0:ge.parsed_value,"  retailer_storage: ",he==null?void 0:he.parsed_value,"  demand_signal_multiplier: ",ke==null?void 0:ke.parsed_value,o$1("br",{}),se.map(xe=>o$1(ScenarioGroupRunResultComponent,{scenario_group_run_result:xe},xe.started.getTime()))]})}function get_attribute_initial_number(t,ee){const te=get_attribute_initial_value(t,ee);if(!te)return te;const{parsed_value:ne}=te;return Number.isFinite(ne)?{...te,parsed_value:ne}:!1}function get_attribute_initial_value(t,ee){var le;const{attribute_to_wc_id_map:te,wcomponents_by_id:ne,composed_kv:oe,created_at_ms:ie,sim_ms:_e}=ee,se=te[t]||"",re=ne[se];if(!re)return!1;const ce=(le=oe.wc_id_to_active_counterfactuals_v2_map[re.id])==null?void 0:le.VAP_sets;return get_wcomponent_state_value_and_probabilities({wcomponent:re,VAP_set_id_to_counterfactual_v2_map:ce,created_at_ms:ie,sim_ms:_e}).most_probable_VAP_set_values[0]}function SimulationSummary(t){const{foundational_knowledge_view_id:ee,scenario_knowledge_view_ids:te}=t.simulation,{knowledge_views_by_id:ne,wcomponents_by_id:oe}=t,ie=ne[ee];if(!ie)return o$1("div",{children:["Unknown simulation base knowledge view for id: ",ee]});const _e=new Date().getTime(),se=_e;return o$1("div",{children:[o$1("h4",{children:ie.title}),o$1("i",{children:"Scenarios"}),te.map(re=>o$1(SimulationScenarioSummary,{simulation:t.simulation,scenario_kv_id:re,knowledge_views_by_id:ne,wcomponents_by_id:oe,created_at_ms:_e,sim_ms:se},re))]})}async function get_simulations(){return[{foundational_knowledge_view_id:"01ee3824-9445-4059-8714-912a011962bf",scenario_knowledge_view_ids:["fa166715-c167-4efc-bc25-12fad9f531f1","2b56dbff-d82a-4fab-9082-68237b5cf6b3","219fdd22-4175-4aad-bb06-3fca7ad4d206"],attribute_to_wc_id_map:{consumers_initial_demand:"af4290c5-75c5-4716-88da-43c7d99b7f9f",consumers_demand_increase_delay_days:"73ac5288-da5d-49a9-b859-f0e58dca4de7",consumers_increased_demand:"994983bc-5a16-49f9-bba3-c7eca7e54847",retailer_initial_price:"a853ddc2-14ed-432f-9093-217bb4fbda3c",retailer_initial_balance:"dbe718aa-6591-4417-ac84-300105662b2c",retailer_initial_stock:"a349eb23-6b0c-4ad5-8908-655ce465a898",retailer_storage:"99842a46-a7a2-443d-b8f6-9821d350ab5e",wholesaler_initial_price:"4f0b8a29-8423-42b9-b124-edd3af00fd6b",distributor_initial_price:"ac7aad82-f16d-4e9c-9997-8d4381da6673",manufacturer_initial_price:"44bc6ef5-438f-4522-9972-b27a5908f5bc",manufacturing_delay_in_days:"54e9e4a5-35a5-4d49-81be-85cbe399e867",demand_signal_multiplier:"0e05530e-aef4-4e86-8feb-0a67073e9b51",days_between_stock_take:"10061767-0f73-486c-86da-411a05232edf",transport_time_in_days:"25aaa820-a4b6-4ba5-988e-9d74a05bea08"}}]}const base_id=16,initial_data={};function SimHome(){const[t,ee]=h$1(initial_data),[te,ne]=h$1({}),[oe,ie]=h$1([]);return p$1(()=>{supabase_load_data(!0,base_id).then(_e=>{ee(get_items_by_id(_e.knowledge_views,"")),ne(get_items_by_id(_e.wcomponents,""))}),get_simulations().then(_e=>ie(_e))},[]),t===initial_data?o$1("div",{children:[o$1("h2",{children:"Simulations"}),"Loading..."]}):o$1("div",{children:[o$1("h2",{children:"Simulations"}),oe.map(_e=>o$1(SimulationSummary,{simulation:_e,knowledge_views_by_id:t,wcomponents_by_id:te}))]})}function get_current_kv(t=!1){const te=get_state().derived.current_composed_knowledge_view;if(t&&!te)throw new Error("Lacking current_composed_knowledge_view");return te}function get_wcomponents_by_id(){return get_state().specialised_objects.wcomponents_by_id}function get_connection_map(t={}){const ee=get_current_kv(!0),te=get_wcomponents_by_id(),{causal_only:ne=!0}=t,oe=new Set(Object.keys(ee.composed_visible_wc_id_map)),se=Array.from(ne?ee.wc_ids_by_type.causal_link:ee.wc_ids_by_type.any_link).filter(ce=>oe.has(ce)).map(ce=>te[ce]).filter(wcomponent_is_plain_connection).filter(ce=>ce.from_id&&ce.to_id).filter(ce=>te[ce.from_id]&&te[ce.to_id]),re=new Set,ae={};return se.forEach(ce=>{re.add(ce.from_id),re.add(ce.to_id);const de=ae[ce.from_id]||{};ae[ce.from_id]=de;const ue=de[ce.to_id]||[];de[ce.to_id]=ue;let le=1;wcomponent_is_causal_link(ce)&&(le=ce.effect_when_true??1),ue.push(le)}),{node_ids_connections_map:ae,node_ids:re}}function get_connection_matrix(t={}){const{node_ids_connections_map:ee,node_ids:te}=get_connection_map(t),ne=[],oe=[""];return ne.push(oe),Array.from(te).forEach(ie=>oe.push(ie)),Array.from(te).forEach(ie=>{const _e=[ie];Array.from(te).forEach(se=>{const re=(ee[se]||{})[ie]||[];_e.push(re)}),ne.push(_e)}),ne}function get_component_id_to_label_ids_map(){const t=get_current_kv(!0),ee=get_wcomponents_by_id(),ne=Object.keys(t.composed_visible_wc_id_map).map(ie=>ee[ie]).filter(is_defined),oe={};return ne.forEach(ie=>{!ie.label_ids||ie.label_ids.length===0||(oe[ie.id]=ie.label_ids)}),oe}function get_component_id_to_label_names_map(){const t=get_wcomponents_by_id(),ee=get_component_id_to_label_ids_map(),te={},ne={};return Object.entries(ee).forEach(([oe,ie])=>{const _e=ie.map(se=>{const re=t[se];if(!re)return"";const ae=te[se]||re.title;return te[se]=ae,ae});ne[oe]=_e}),ne}function convert_matrix_component_ids(t,ee){return t.map(ne=>ne.map(oe=>typeof oe!="string"?oe:oe?ee(oe):""))}function matrix_component_ids_to_labels(t,ee){const te={},ne={};return convert_matrix_component_ids(ee,ie=>{let _e=te[ie]||"";if(!_e){_e=(t[ie]||[]).join(",");const re=(ne[_e]||0)+1;ne[_e]=re,_e+=`_${re}`,te[ie]=_e}return _e})}function matrix_component_ids_to_titles(t,ee){return convert_matrix_component_ids(ee,ne=>{var oe;return((oe=t[ne])==null?void 0:oe.title)||""})}function matrix_to_csv(t){const ee=[];return t.forEach(te=>{const ne=[];te.forEach(oe=>{typeof oe=="string"?ne.push(oe):oe.length===0?ne.push(""):oe.length===1?ne.push((oe[0]||0).toString()):ne.push(JSON.stringify(oe))}),ee.push(ne.join(",")+`
`)}),ee.join("")}function get_current_visible_graph(){return{get_connection_map,get_connection_matrix,get_component_id_to_label_names_map}}function get_current_wcomponent(){const t=get_state(),ee=t.routing.item_id||"";return t.specialised_objects.wcomponents_by_id[ee]}function get_selected_wcomponents(){const t=get_state();return t.meta_wcomponents.selected_wcomponent_ids_list.map(ee=>get_wcomponent_from_state(t,ee)).filter(is_a_wcomponent)}function get_action_wcomponent_elapsed_minutes(t,ee){let te=0;return wcomponent_is_action(t)&&get_action_active_date_ranges(t).forEach(({start:oe,stop:ie})=>te+=ie.getTime()-oe.getTime()),te=Math.round(te/1e3),ee?seconds_to_string(te):round_seconds_to_minutes(te)}function round_seconds_to_minutes(t){return Number.parseFloat((t/60).toFixed(2))}function seconds_to_string(t){const ee=t%60;t=Math.round((t-ee)/60);const te=t%60;t=Math.round((t-te)/60);const ne=t%24;t=Math.round((t-ne)/24);let oe="";return t&&(oe+=`${t} days`),(t||ne)&&(oe+=` ${ne} hours`),(t||ne||te)&&(oe+=` ${te} minutes`),oe+=` ${ee} seconds`,oe=oe.trim(),oe}function get_selected_wcomponents_elapsed_minutes(t){const te=get_selected_wcomponents().map(ne=>get_action_wcomponent_elapsed_minutes(ne,!1)).reduce((ne,oe)=>ne+oe,0)*60;return t?seconds_to_string(te):round_seconds_to_minutes(te)}function setup_console_api(){const t={get_current_visible_graph,matrix_component_ids_to_labels,matrix_component_ids_to_titles,matrix_to_csv,get_current_kv,get_wcomponents_by_id,create_wcomponent,get_current_wcomponent,get_selected_wcomponents,get_action_wcomponent_elapsed_minutes,get_selected_wcomponents_elapsed_minutes};window.console_api=t}function get_state(){return window.debug_state}const origin_left=500,origin_top=300,origin={left:origin_left,top:origin_top};function SandboxCircularConnections(){const[t,ee]=h$1(700),[te,ne]=h$1(100),[oe,ie]=h$1(0),_e=oe===0||oe===1,se=oe===0||oe===2,re={left:t,top:te},ae={kv_wc_entry:origin,wcomponent_type:"statev2",connection_terminal_type:{side:"right",attribute:"state"}},ce={kv_wc_entry:origin,wcomponent_type:"statev2",connection_terminal_type:{side:"left",attribute:"state"}};return o$1("div",{style:{width:"100%",height:"100%"},onMouseMove:de=>{ee(de.x),ne(de.y)},onClick:()=>ie((oe+1)%3),children:[o$1(ConnectableCanvasNode,{node_main_content:o$1("div",{style:{height:100},children:"Node 1"}),terminals:[],position:origin}),o$1(ConnectableCanvasNode,{node_main_content:o$1("div",{style:{height:100},children:"Node 2"}),terminals:[],position:re}),o$1("svg",{width:1300,height:1e3,style:{zIndex:1e3,position:"absolute"},children:[_e&&o$1("g",{children:[o$1(CanvasConnection,{connection_from_component:ae,connection_to_component:{...ce,kv_wc_entry:re},line_behaviour:ConnectionLineBehaviour.curve,circular_links:!0}),o$1(CanvasConnection,{connection_from_component:{...ae,kv_wc_entry:re},connection_to_component:ce,line_behaviour:ConnectionLineBehaviour.curve,circular_links:!0})]}),se&&o$1("g",{children:[o$1(CanvasConnection,{connection_from_component:ae,connection_to_component:{...ce,kv_wc_entry:re},line_behaviour:ConnectionLineBehaviour.curve,circular_links:!1}),o$1(CanvasConnection,{connection_from_component:{...ae,kv_wc_entry:re},connection_to_component:ce,line_behaviour:ConnectionLineBehaviour.curve,circular_links:!1})]})]})]})}const TableDisplayMultiDimensionalData$1="";function TableDisplayMultiDimensionalData(t){return o$1("table",{class:"multi_dimensional_data_table",children:[o$1("thead",{}),o$1("tbody",{children:t.data.map(ee=>o$1("tr",{children:ee.map(te=>o$1("td",{children:te}))}))})]})}function MultidimensionalDataForm(t){const[ee,te]=h$1(""),[ne,oe]=h$1(void 0),[ie,_e]=h$1("number"),[se,re]=h$1([]);return o$1("div",{children:["Title ",o$1("input",{type:"text",value:ee,style:{width:250},onChange:ae=>te(ae.currentTarget.value)}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Type   ",o$1(AutocompleteText,{editing_allowed:!0,selected_option_id:ie,options:wcomponent_statev2_subtype_options,allow_none:!1,on_change:ae=>ae&&_e(ae)})]}),o$1("br",{}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Date (Optional)   ",o$1("input",{type:"date",value:ne==null?void 0:ne.toISOString(),onChange:ae=>{oe(ae.currentTarget.valueAsDate||void 0)}})]}),o$1("br",{}),o$1("br",{}),"Input ",o$1("textarea",{value:"",rows:1,onChange:ae=>{const ce=ae.currentTarget.value;re(ce.split(`
`).map(de=>de.split("	")))}}),o$1("br",{}),o$1("input",{type:"button",value:"Add",onChange:ae=>{const ce={id:Math.random().toString(),base_id:-1,type:"multidimensional_state",title:ee,description:"",created_at:new Date},de={id:ce.id,schema_version:1,author_id:"abc",data_type:ie,schema_description:"",schema:{dimensions:[]},dimension_data:{},data:[]};t.add_multidimensional_state(ce),t.add_multidimensional_state_data(de)}}),o$1("br",{}),"Parsed value:",o$1(TableDisplayMultiDimensionalData,{data:se})]})}function get_starting_state(t){return{multidimensional_states:[],multidimensional_state_datas:[]}}function load_local_data(){const t=localStorage.getItem("x_data_app")||"{}";return{...get_starting_state(),...JSON.parse(t)}}function save_local_data(t){t={...load_local_data(),...t},localStorage.saveItem("x_data_app",JSON.stringify(t))}function GenericData(){const[t,ee]=h$1({}),{multidimensional_states:te,multidimensional_state_datas:ne}=load_local_data(),oe=_e=>{save_local_data({multidimensional_states:_e}),ee({})},ie=_e=>{save_local_data({multidimensional_state_datas:_e}),ee({})};return o$1("div",{children:["GenericData",o$1(MultidimensionalDataForm,{add_multidimensional_state:_e=>{oe([...te,_e])},add_multidimensional_state_data:_e=>{ie([...ne,_e])}}),o$1("hr",{}),te.map(_e=>o$1("div",{children:_e.title}))]})}function DataApp(){const[t,ee]=h$1("generic_data"),te=t==="generic_data";return o$1("div",{children:[o$1("div",{children:o$1("button",{onClick:()=>ee("generic_data"),style:{backgroundColor:te?"white":""},children:"Data"})}),o$1("br",{}),te&&o$1(GenericData,{})]})}const root_reducer=(t,ee)=>t;let cached_store;function get_data_app_store(t={}){const{use_cache:ee=!0,override_preloaded_state:te={},load_state_from_storage:ne=!1}=t;if(cached_store&&ee)return cached_store;const oe={...get_starting_state(),...te},ie=createStore(root_reducer,oe);return ie.load_state_from_storage=ne,cached_store=ie,ie}const root=document.getElementById("root");if(root)if(root.innerText="",window.location.pathname===""||window.location.pathname==="/")D$1(o$1(DevLandingPage,{}),root);else if(window.location.pathname==="/project_dashboard")D$1(o$1(Provider,{store:get_store({load_state_from_storage:!0}),children:o$1(DemoProjectDashboard,{})}),root);else if(window.location.pathname==="/prob_graph")D$1(o$1(DemoPredictionsGraph,{}),root);else if(window.location.pathname==="/prob_badge")D$1(o$1(DemoPredictionsBadge,{}),root);else if(window.location.pathname==="/sandbox/editable_custom_datetime")D$1(o$1(Provider,{store:get_store({load_state_from_storage:!1}),children:o$1(SandboxEditableCustomDateTime,{})}),root);else if(window.location.pathname==="/sandbox/canvas_nodes")D$1(o$1(SandboxWComponentCanvasNode,{}),root);else if(window.location.pathname==="/sandbox/circular_connections")D$1(o$1(SandboxCircularConnections,{}),root);else if(window.location.pathname==="/sandbox/connected")D$1(o$1(Provider,{store:get_store({load_state_from_storage:!1}),children:o$1(SandBoxConnected,{})}),root);else if(window.location.pathname==="/sandbox/supabase")D$1(o$1(SandBoxSupabase,{}),root);else if(window.location.pathname==="/sandbox")D$1(o$1(SandBox,{}),root);else if(window.location.pathname==="/app/"||window.location.pathname==="/app"){const t=get_store({load_state_from_storage:!0});D$1(o$1(Provider,{store:t,children:o$1(App$1,{})}),root)}else if(window.location.pathname==="/privacy-policy")D$1(o$1("div",{children:"Will render public/privacy-policy.html"}),root);else if(window.location.pathname==="/privacy-policy/")D$1(o$1("div",{children:"Will need to remove trailing / and link to privacy-policy or privacy-policy.html to render correctly"}),root);else if(window.location.pathname==="/terms-and-conditions")D$1(o$1("div",{children:"Will render public/terms-and-conditions.html"}),root);else if(window.location.pathname==="/terms-and-conditions/")D$1(o$1("div",{children:"Will need to remove trailing / and link to terms-and-conditions or terms-and-conditions.html to render correctly"}),root);else if(window.location.pathname==="/sim/"||window.location.pathname==="/sim")D$1(o$1(SimHome,{}),root);else if(window.location.pathname==="/data/"||window.location.pathname==="/data"){const t=get_data_app_store({load_state_from_storage:!1});D$1(o$1(Provider,{store:t,children:o$1(DataApp,{})}),root)}else root.innerText="Unknown path: "+window.location.pathname;set_window_title();setup_window_on_focus_listener();setup_console_api();
