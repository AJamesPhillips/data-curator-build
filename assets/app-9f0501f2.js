var D1=Object.defineProperty;var R1=(e,t,n)=>t in e?D1(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var ke=(e,t,n)=>(R1(e,typeof t!="symbol"?t+"":t,n),n);import{g as Ce,s as gh,A as O1,a as Nn,p as En,t as wh,r as Z,W as M1,D as bh}from"./set_window_title-f59a22c7.js";import{u as _,b as Se,H as q1,c as In,i as Q,r as ee,a as se,y as V1,B as I,A as Mi,d as qi,e as Vi,F as ot,f as ai,R as hu,g as Pi,h as Ni,S as Uc,T as Wc,j as He,I as ue,k as F1,l as z1,D as gu,n as yh,M as rs,o as L1,m as Pt,p as Dn,q as kh,s as B1,t as xh,v as U1,w as W1,x as H1,z as G1,E as K1,G as Y1,J as J1,K as Sh,L as Ah,N as X1,O as Z1,P as Q1,Q as ek,U as tk}from"./common_style_libraries-98c71f0d.js";import{j as nk,n as ik,o as P,d as D,A as De,y as re,p as jo,r as ok,s as sk,e as $h,b as wu,t as rk,T as z,u as Ch,k as Re,v as jh,i as _k,P as ak}from"./common_libraries-f830e8e5.js";function ck(e,t){for(var n=0;n<t.length;n++){const i=t[n];if(typeof i!="string"&&!Array.isArray(i)){for(const o in i)if(o!=="default"&&!(o in e)){const s=Object.getOwnPropertyDescriptor(i,o);s&&Object.defineProperty(e,o,s.get?s:{enumerable:!0,get:()=>i[o]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}function lk(e){return e&&(e.min||e.value||e.max)}function Th(e){return lk(e)===void 0}const dk={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function nn(e,t){const n={M:e.getMonth()+1,d:e.getDate(),h:e.getHours(),m:e.getMinutes(),s:e.getSeconds()};return t=t.replace(/MMM/g,function(i){return dk[e.getMonth()]||""}),t=t.replace(/(M+|d+|h+|m+|s+)/g,function(i){const o=i.slice(-1);return((i.length>1?"0":"")+n[o]).slice(-2)}),t.replace(/(y+)/g,function(i){return e.getFullYear().toString().slice(-i.length)})}function _s(e){const{date:t,time_resolution:n="minute",trim_midnight:i=!0}=e,s=nn(t,n==="day"?"yyyy-MM-dd":n==="hour"?"yyyy-MM-dd hh:00":n==="minute"?"yyyy-MM-dd hh:mm":"yyyy-MM-dd hh:mm:ss");return i?s.replace(" 00:00",""):s}function as(e=!0){return nn(new Date,"yyyy-MM-dd")+(e?" 00:00":"")}function uk(){return new Date(as())}new Date().getTimezoneOffset()*6e4;function ii(e){const{date:t,time_resolution:n,trim_midnight:i}=e;return t&&pl(t)?_s({date:t,time_resolution:n,trim_midnight:i}):""}function ul(e,t){let n="Eternal";if(!Th(e)){const i=ii({date:e.min,time_resolution:t}),o=ii({date:e.value,time_resolution:t}),s=ii({date:e.max,time_resolution:t});if(o&&!i&&!s)return o;n=[i,i?" ":"","<",o?" ":"",o,o?" ":"","<",s?" ":"",s].filter(a=>a).join("")}return n}function pl(e){return!Number.isNaN(e.getTime())}function Hi(e){const t=new Date(e);return pl(t)?t:void 0}function Go(e,t={}){const n=t.sort_items??!1,i=t.render_undefined??!1,o=typeof t.space=="number"?Array(t.space+1).join(" "):t.space||"",s=typeof t.cycles=="boolean"?t.cycles:!1,r=t.replacer||((l,d)=>pk(d)?d.toISOString():d instanceof Set?Array.from(d).sort():d),a=t.comparison_function&&function(l){return function(d,p){return t.comparison_function({key:d,value:l[d]},{key:p,value:l[p]})}},c=[];return function l(d,p,f,m){const v=o?`
`+new Array(m+1).join(o):"",h=o?": ":":";if(f=r.call(d,p,f),f===void 0)return i?"undefined":void 0;if(typeof f!="object"||f===null)return JSON.stringify(f);if(Array.isArray(f)){const g=[];for(let k=0;k<f.length;k++){const y=l(f,k,f[k],m+1)||JSON.stringify(null);g.push(v+o+y)}return"["+g.join(",")+v+"]"}if(c.indexOf(f)!==-1){if(s)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else c.push(f);let w=Object.keys(f);n&&(w=w.sort(a&&a(f)));const b=[];return w.forEach(g=>{const k=l(f,g,f[g],m+1);if(!k)return;const y=JSON.stringify(g)+h+k;b.push(v+o+y)}),c.splice(c.indexOf(f),1),"{"+b.join(",")+v+"}"}({"":e},"",e,0)}function pk(e){return Object.prototype.toString.call(e)==="[object Date]"}let lt={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0};const bu={get:()=>lt,reset:()=>{lt={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0}},print:()=>{const e=lt;console.log(`
describe: ${e.describe_run+e.describe_skipped}
tests: ${e.test_run+e.test_skipped}`);const t=e.describe_skipped+e.test_skipped;console.log(`%cskipped: ${t}`,`color:${t?"tan":"LightGrey"};font-weight:bold;`),e.test_failed.length&&console.error("failed: "+e.test_failed.join(`
failed: `)),console.log(`%cpassed: ${e.test_passed}${e.test_failed.length?`
failed: ${e.test_failed.length}`:""}
    `,`color:${e.test_failed.length?"red":"green"};font-weight:bold;`)}},Ph=!0,mk=(e,t,n="",i=Ph)=>{lt.test_run+=1;const o={render_undefined:!0,sort_items:i},s=Go(e,o),r=Go(t,o);if(s===r){lt.test_passed+=1;const c=n.split(`
`).filter(l=>l.trim())[0];console.log(`pass:  ${c}`)}else{const c=`${n} "${s}" !== "${r}"`;Zi(c,e,t,i)}};function Zi(e,t,n,i=Ph){lt.test_failed.push(e),console.error(`fail:  ${e}`);const o={render_undefined:!0,sort_items:i};try{if((t==null?void 0:t.constructor)===Object&&(n==null?void 0:n.constructor)===Object){const s=[...new Set([...Object.keys(t),...Object.keys(n)])];s.sort(),s.forEach(r=>{const[a,c]=[t,n],l=a[r],d=c[r],p=Go(l,o),f=Go(d,o);if(!(p===f))console.debug(`Test failure: different values for key "${r}", got: '${p}', but expected: '${f}'`);else if(p==="undefined"){const v=r in a,h=r in c;v!==h&&console.debug(`Test failure: key "${r}", got: ${v?"present":"not present"}, but expected: ${h?"present":"not present"}`)}})}}catch(s){console.debug("error in providing debugging for test failure",s)}}const u=mk;u.skip=(e,t,n="")=>{lt.test_skipped+=1,console.warn("skipping  "+n)};const fk=async(e,t)=>{let n;if(Nh(t))n=async()=>{lt.describe_run+=1,console.group(e);try{await t()}catch(i){Zi(`error in test: ${i}`,null,null)}console.groupEnd()},await n();else{const i=t;n=()=>{lt.describe_run+=1,console.group(e);try{i()}catch(o){Zi(`error in test: ${o}`,null,null)}console.groupEnd()},n()}return n},x=fk;x.skip=e=>{function t(){lt.describe_skipped+=1,console.warn("skipping  "+e)}return t};x.delay=(e,t)=>{let n;if(Nh(t))n=async()=>{lt.describe_run+=1,console.group(e);try{await t()}catch(i){Zi(`error in test: ${i}`,null,null)}console.groupEnd()};else{const i=t;n=()=>{lt.describe_run+=1,console.group(e);try{i()}catch(o){Zi(`error in test: ${o}`,null,null)}console.groupEnd()}}return n};function Nh(e){return e.constructor.name==="AsyncFunction"}var te=(e=>(e[e.past=0]="past",e[e.present=1]="present",e[e.future=2]="future",e[e.eternal=3]="eternal",e))(te||{});function he(e,t){const{min:n,value:i,max:o}=e.datetime||{},[s,r]=n===void 0?[!1,0]:[!0,n.getTime()],[a,c]=i===void 0?[!1,0]:[!0,i.getTime()],[l,d]=o===void 0?[!1,0]:[!0,o.getTime()];if(s){if(r>t)return te.future;if(r===t||!l&&r<t)return te.present}if(l)return d<=t?te.past:te.present;if(a){if(c<t)return te.past;if(c===t)return te.present;if(c>t)return te.future}return te.eternal}const vk=x.delay("get_tense_of_uncertain_datetime",()=>{let e;const n=new Date("2021-04-01 00:01").getTime(),i=new Date("2021-04-01 00:02"),o=i.getTime(),s=new Date("2021-04-01 00:03"),r=s.getTime(),a=new Date("2021-04-01 00:04"),c=a.getTime(),d=new Date("2021-04-01 00:05").getTime();e=he({datetime:{}},n),u(e,te.eternal),e=he({datetime:{min:i}},n),u(e,te.future),e=he({datetime:{min:i}},o),u(e,te.present),e=he({datetime:{min:i}},r),u(e,te.present),e=he({datetime:{value:i}},n),u(e,te.future),e=he({datetime:{value:i}},o),u(e,te.present),e=he({datetime:{value:i}},r),u(e,te.past),e=he({datetime:{max:i}},n),u(e,te.present),e=he({datetime:{max:i}},o),u(e,te.past),e=he({datetime:{max:i}},r),u(e,te.past),e=he({datetime:{min:i,max:s}},n),u(e,te.future),e=he({datetime:{min:i,max:s}},o),u(e,te.present),e=he({datetime:{min:i,max:s}},r),u(e,te.past),e=he({datetime:{min:i,max:s}},c),u(e,te.past),e=he({datetime:{min:i,value:s,max:a}},n),u(e,te.future),e=he({datetime:{min:i,value:s,max:a}},o),u(e,te.present),e=he({datetime:{min:i,value:s,max:a}},r),u(e,te.present),e=he({datetime:{min:i,value:s,max:a}},c),u(e,te.past),e=he({datetime:{min:i,value:s,max:a}},d),u(e,te.past)});function hk(e){return e.custom_created_at||e.created_at}function gk(e){return hk(e).getTime()}function wk(e){const{items:t,created_at_ms:n}=e,i=[],o=[];return t.forEach(s=>{gk(s)>n?i.push(s):o.push(s)}),{invalid_future_items:i,current_items:o}}const bk=x.delay("partition_items_by_created_at_datetime",()=>{function e(m){const v=wk(m);return{invalid_future_items:v.invalid_future_items.map(({id:h})=>h),current_items:v.current_items.map(({id:h})=>h)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime(),p={base_id:-1,id:"1",created_at:s},f={base_id:-1,id:"2",created_at:a};t=[],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[]}),t=[p,f],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:c}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:r}),u(n,{invalid_future_items:[f.id],current_items:[p.id]}),n=e({items:t,created_at_ms:o}),u(n,{invalid_future_items:[p.id,f.id],current_items:[]})});var Eh=(e=>(e[e.ascending=0]="ascending",e[e.descending=1]="descending",e))(Eh||{});function yk(e,t,n){const i=kk(n);return e.map((o,s)=>({item:o,key_value:t(o,s)})).sort(i).map(({item:o})=>o)}function kk(e){const t=e===0,n=t?-1:1,i=t?1:-1;return(o,s)=>o.key_value<s.key_value?n:o.key_value>s.key_value?i:0}function xk(e,t=Eh.descending){return yk(e,({datetime:i})=>{if(Th(i))return Number.NEGATIVE_INFINITY;const{max:o,value:s,min:r}=i;return r?r.getTime()*10+2:s?s.getTime()*10+1:o?o.getTime()*10:1},t)}function Sk(e){const{sorted_items:t,sim_ms:n}=e;let i=[],o=[],s=[];const r=[];t.forEach(c=>{const l=he(c,n);l===te.past?i.push(c):l===te.future?r.push(c):l===te.present?o.push(c):s.push(c)}),o.length!==1&&(o.length>1?(i=o.slice(1).concat(i),o=o.slice(0,1)):i.length&&(o=i.slice(0,1),i=i.slice(1))),s.length&&(o.length!==1&&(o=s.slice(0,1),s=s.slice(1)),i=i.concat(s));const a=o[0];return{past_items:i,present_item:a,future_items:r}}const Ak=x.delay("partition_sorted_items_by_datetimes",()=>{function e(p){var m;const f=Sk(p);return{past_items:f.past_items.map(({id:v})=>v),present_item:(m=f.present_item)==null?void 0:m.id,future_items:f.future_items.map(({id:v})=>v)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime();t=[],n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:[],present_item:void 0,future_items:[]}),t=[{id:"10",datetime:{}},{id:"11",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:["11"],present_item:"10",future_items:[]},"Can handle multiple eternal elements"),t=[{id:"30",datetime:{value:a}},{id:"20",datetime:{value:s}},{id:"10",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:"10",future_items:["30","20"]},"Should partition eternal item as present if other items are in the future"),n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:["10"],present_item:"20",future_items:["30"]},"Should partition eternal item as past if other items are in the present"),n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]},"Should partition eternal item and other past items as past if other items are in the present"),n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]}),t=[{id:"40",datetime:{min:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"40",future_items:[]},"Should find min datetime as present when sim_ms is equal to min datetime"),n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:void 0,future_items:["40"]},"Should find min datetime as future when sim_ms is before min datetime"),t=[{id:"50",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"50",future_items:[]},"Should find max datetime as present when sim_ms is equal to max datetime"),t=[{id:"50",datetime:{max:s}},{id:"60",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["60"],present_item:"50",future_items:[]},"Should find max datetime as past when sim_ms is later than max datetime but when no other item is present, will use one as present item")}),$k=x.delay("sort_by_uncertain_event_datetimes",()=>{function e(C){return xk(C).map(({id:A})=>A)}function t(C,N){const A=[...C].reverse(),R=N.map(({id:T})=>T);i=e(C);const M=e(A);u(i,M,"",!1),u(i,R,"",!1)}let n=[],i,o;const s=new Date("2021-04-01 00:00"),r=new Date("2021-04-01 00:01"),a=new Date("2021-04-01 00:02"),c=new Date("2021-04-01 00:03");let l=0;const d=()=>`${l++}`,p={id:d(),datetime:{}},f={id:d(),datetime:{}},m={id:d(),datetime:{value:r}},v={id:d(),datetime:{value:a}},h={id:d(),datetime:{max:r}},w={id:d(),datetime:{max:a}},b={id:d(),datetime:{min:r}},g={id:d(),datetime:{min:a}},k={id:d(),datetime:{min:s,max:c}},y={id:d(),datetime:{min:r,max:a}};n=[],i=e(n),u(i,[],"",!1),n=[p,f];const $=[...n].reverse();i=e(n);const j=e($);u(JSON.stringify(i)!==JSON.stringify(j),!0,"Should be different (indeterminant sort)"),n=[p,m,v],o=[v,m,p],t(n,o),n=[p,b,g],o=[g,b,p],t(n,o),n=[p,h,w],o=[w,h,p],t(n,o),n=[p,m,v,b,g,h,w],o=[g,v,w,b,m,h,p],t(n,o),n=[p,k,y],o=[y,k,p],t(n,o)}),Ck=x.delay("correct_datetime_for_local_time_zone",()=>{let e;e=Hi("2021-04-16 15:00"),u(e&&e.toISOString(),"2021-04-16T14:00:00.000Z","Subtracts one hour (as datetime is during summer time BST; and also passes when test is performed during GMT)"),e=Hi("2021-04-16 00:00"),u(e&&e.toISOString(),"2021-04-15T23:00:00.000Z","Subtracts one hour, goes back one day (as datetime is during summer time BST; and also passes when test is performed during GMT)"),e=Hi("2021-04-16"),u.skip(e&&e.toISOString(),"2021-04-15T23:00:00.000Z","")}),Fi=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})$/gi,jk=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,Ih=/([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,Dh=/@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}/gi,Tk=/(.*)(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})(.*)/gi,Pk=/^\s*(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\s*$/gi;function en(e,t=!1){return t?!!e.match(jk):!!e.match(Fi)}const Nk=/.*?(@@\w*\d+)\.([\w]+)/g,Ek=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\.([\w]+)/gi;function bn(e){return(e.match(Dh)||[]).map(n=>n.slice(2))}function yu(e){return e.match(Ih)||[]}function To(e){if(!Number.isInteger(e))throw new Error("uuid_v4_for_tests id must be an integer");if(e<0)throw new Error("uuid_v4_for_tests id must be >=0");return`${e}0000000-0000-4000-a000-000000000000`}const Ik=x.delay("id_regexs",()=>{x("uuids_regex",()=>{let e="77777777-7777-4777-8777-777777777777".match(Fi);u(e!==null,!0,"should match a valid uuid"),u(e==null?void 0:e[0],"77777777-7777-4777-8777-777777777777","should match a valid uuid"),e="77777777-7777-0777-0777-777777777777".match(Fi),u(e===null,!0,"should fail to match a invalid uuid"),e=" 77777777-7777-4777-8777-777777777777".match(Fi),u(e===null,!0,"should fail to match a valid uuid with leading space"),e="77777777-7777-4777-8777-777777777777 ".match(Fi),u(e===null,!0,"should fail to match a valid uuid with trailing space"),x("is_valid_uuid",()=>{u(en("77777777-7777-4777-8777-777777777777"),!0,"should match a valid uuid"),u(en("77777777-7777-0777-0777-777777777777"),!1,"should fail to match a invalid uuid"),u(en(" 77777777-7777-4777-8777-777777777777"),!1,"should fail to match a valid uuid with leading space"),u(en("77777777-7777-4777-8777-777777777777 "),!1,"should fail to match a valid uuid with trailing space"),u(en("77777777-7777-4777-8777-777777777777 ",!0),!0,"should match a valid uuid with trailing space if starts_with is true")})}),x("uuids_regexes",()=>{const e=`  77777777-7777-4777-8777-777777777777
        77777777-7777-0777-0777-777777777777
        11111111-1111-4111-8111-111111111111
        `.match(Ih);u(e!==null,!0,"should match a string with valid uuids"),u(e==null?void 0:e.length,2,"should match 2 valid uuids"),u(e==null?void 0:e[0],"77777777-7777-4777-8777-777777777777","should match first valid uuid"),u(e==null?void 0:e[1],"11111111-1111-4111-8111-111111111111","should match second valid uuid")})}),Dk=x.delay("get_ids_from_text",()=>{let e=[];x("get_double_at_mentioned_uuids_from_text",()=>{e=bn(""),u(e,[],"Should find no IDs in empty string"),e=bn("asd @@wc123 asd name@example.com #label dfg @@345 sf"),u(e,[],'Should not find old ids of "wc123", "345"');const t=To(1),n=To(2);e=bn(`asd @@${t} asd name@example.com #label dfg @@${n} sf`),u(e,[t,n],"Should find uuid ids")}),x("get_uuids_from_text",()=>{e=yu(""),u(e,[],"Should find no IDs in empty string");const t=To(1),n=To(2);e=yu(`1 + [${t}] + (2 + [${n}]) * 3`),u(e,[t,n],"Should find uuid ids")})});async function Rk(){(await vk)(),(await bk)(),(await Ak)(),(await $k)(),(await Ik)(),(await Dk)(),(await Ck)()}function le(e){if(!Number.isInteger(e))throw new Error("uuid_v4_for_tests id must be an integer");if(e<0)throw new Error("uuid_v4_for_tests id must be >=0");return`${e}0000000-0000-4000-a000-000000000000`}var Po,Ok=new Uint8Array(16);function Mk(){if(!Po&&(Po=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!Po))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Po(Ok)}const qk=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Vk(e){return typeof e=="string"&&qk.test(e)}var Te=[];for(var Us=0;Us<256;++Us)Te.push((Us+256).toString(16).substr(1));function Fk(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(Te[e[t+0]]+Te[e[t+1]]+Te[e[t+2]]+Te[e[t+3]]+"-"+Te[e[t+4]]+Te[e[t+5]]+"-"+Te[e[t+6]]+Te[e[t+7]]+"-"+Te[e[t+8]]+Te[e[t+9]]+"-"+Te[e[t+10]]+Te[e[t+11]]+Te[e[t+12]]+Te[e[t+13]]+Te[e[t+14]]+Te[e[t+15]]).toLowerCase();if(!Vk(n))throw TypeError("Stringified UUID is invalid");return n}function ml(e,t,n){e=e||{};var i=e.random||(e.rng||Mk)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,t){n=n||0;for(var o=0;o<16;++o)t[n+o]=i[o];return t}return Fk(i)}function io(){return ml()}const zk=()=>"pr"+io(),Lk=()=>"vps"+io(),Bk=()=>"VAP"+io(),Uk=["meta","validity","state"],Wk=["right","left"];var ci=(e=>(e.curve="curve",e.straight="straight",e.angular="angular",e))(ci||{});const Hk=["curve","straight","angular"];function Rh(e){return!!e}function fl(e){return dt("event",e)}function Qe(e){return dt("statev2",e)}function gt(e,t=""){return dt("state_value",e,t)}function Oh(e){return dt("process",e)}function dt(e,t,n=""){let i=!1;return n=typeof n=="string"?n:"",t?t.type!==e?n&&console.error(`wcomponent with id "${n}" is not a ${e}`):i=!0:n&&console.error(`wcomponent with id "${n}" does not exist`),i}function et(e,t=""){return dt("action",e,t)}function Rn(e,t=""){return dt("goal",e,t)}function Mh(e,t=""){return et(e,void 0)||Rn(e,t)}function an(e){return dt("causal_link",e)}function Gk(e){return dt("relation_link",e)}function ye(e){return an(e)||Gk(e)}function li(e){return e==="causal_link"||e==="relation_link"}function Kk(e){return fl(e)||Qe(e)||Oh(e)||et(e)||Rn(e)||oo(e)||gt(e)||vl(e)}function ut(e,t=""){return dt("judgement",e,void 0)||dt("objective",e,t)}function oo(e,t=""){return dt("sub_state",e,t)}function vl(e,t=""){return dt("counterfactualv2",e,t)}function Yk(e){return ye(e)}function hl(e){return e.event_at!==void 0}function gl(e){return e?e.deleted_at!==void 0:void 0}function so(e){return e?e.deleted_at===void 0:void 0}function wi(e){const{validity:t}=e;return t!==void 0&&t.length>0}const Jk=new Set(["counterfactualv2","sub_state"]);function qh(e){return!Jk.has(e.type)}function On(e){return e.values_and_prediction_sets!==void 0}function Xk(e){return(e==null?void 0:e.value_possibilities)!==void 0}function Ke(e){return Qe(e)||gt(e)||et(e)}function bi(e){return On(e)&&e.values_and_prediction_sets.length>0&&Ke(e)}function Zk(e){return e.calculations!==void 0}function Qk(e){return Qe(e)||et(e)}function q(e){const t={id:io(),created_at:new Date,base_id:e.base_id,title:"",description:"",type:"process"};e.custom_created_at||e.created_at||t.custom_created_at||t.created_at;let n;if(e.type==="causal_link"||e.type==="relation_link"){let i={...t,from_id:"",to_id:"",from_type:"state",to_type:"state",...e,type:e.type};an(i)&&(i={effect_string:"1",effect_when_true:1,effect_when_false:void 0,values_and_prediction_sets:[],...i}),n=i}else e.type==="judgement"||e.type==="objective"?n={...t,judgement_target_wcomponent_id:"",judgement_operator:"==",judgement_comparator_value:"True",judgement_manual:void 0,...e,type:e.type}:e.type==="statev2"?n={...t,subtype:void 0,values_and_prediction_sets:[],...e,type:e.type}:e.type==="goal"?n={...t,objective_ids:[],...e,type:e.type}:e.type==="action"?n={...t,values_and_prediction_sets:[],reason_for_status:"",depends_on_action_ids:[],...e,type:e.type}:n={...t,...e,type:e.type||"process"};return n}function qt(e){return q(e)}function Xn(e,t,n){e=e.trim();const i=e.match(Dh);if(i&&i[0]===e){const o=i[0].slice(2),s=n[o];t=s==null?void 0:s.units}return t}const e2=x.delay("apply_units_from_component",()=>{let e,t,n={},i,o;const s=le(1),r=le(2),c=q({base_id:0,id:s,title:"Some state component",type:"statev2",units:"seconds"});n={[s]:c},t=`@@${s}`,e="",o="seconds",i=Xn(t,e,n),u(i,o,"Can access a wcomponent's value and uses its units when no units given by calculation"),t=`  @@${s}  `,e="",o="seconds",i=Xn(t,e,n),u(i,o,"Uses a wcomponent's units, even with surrounding whitespace"),t=`@@${s}`,e="Unitless",o="seconds",i=Xn(t,e,n),u(i,o,"Silently uses a wcomponent's units even when units given by calculation"),t=`@@${s} + 1`,e="meters",o="meters",i=Xn(t,e,n),u(i,o,"Ignores component units if calculation value is not just a @@uuid"),t=`@@${r}`,e="meters",o=void 0,i=Xn(t,e,n),u(i,o,"Defaults units to undefined when component can not be found, even if calculation has units given")}),t2=/.*?(\d*(?:\.\d+)?(?:e(?:-|\+)\d+)?\s*\%)/g;function pn(e){let t=e;return[...t.matchAll(t2)].forEach(i=>{const o=i[1];o&&(t=t.replace(o,"("+o.replace(/\s*\%/," * 0.01")+")"))}),t}const n2=x.delay("convert_percentages",()=>{let e="",t="",n="";e="90 %",t="(90 * 0.01)",n=pn(e),u(n,t,"Convert percentage symbol to numbers"),e="90 % / 10%",t="(90 * 0.01) / (10 * 0.01)",n=pn(e),u(n,t,"Convert percentage symbols without spaces to numbers"),e="90.123 %",t="(90.123 * 0.01)",n=pn(e),u(n,t,"Convert percentage symbols with decimal places"),e=".123 %",t="(.123 * 0.01)",n=pn(e),u(n,t,"Convert percentage symbols with decimal point and no leading digit"),e="90.123 % - -90.123 %",t="(90.123 * 0.01) - -(90.123 * 0.01)",n=pn(e),u(n,t,"Convert negative or positive percentage symbols"),e="9.1e+1 % - 9.1e-1 %",t="(9.1e+1 * 0.01) - (9.1e-1 * 0.01)",n=pn(e),u(n,t,"Convert scientific notation percentage symbols")}),Qi={"£":"CURRENCY_POUND",$:"CURRENCY_DOLLAR","€":"CURRENCY_EURO","¥":"CURRENCY_YUAN_TWO",Ұ:"CURRENCY_YUAN_ONE","₹":"CURRENCY_RUPEE_RX","₨":"CURRENCY_RUPEE_RS","¢":"CURRENCY_GHANA_CEDI","؋":"CURRENCY_AFGHANISTAN_AFGHANI","฿":"CURRENCY_THAILAND_BAHT","៛":"CURRENCY_CAMBODIA_RIEL","₡":"CURRENCY_COSTA_RICA_COLON","₦":"CURRENCY_NIGERIA_NAIRA","₩":"CURRENCY_KOREA_WON","₪":"CURRENCY_ISRAEL_SHEKEL","₫":"CURRENCY_VIET_NAM_DONG","₭":"CURRENCY_LAOS_KIP","₮":"CURRENCY_MONGOLIA_TUGHRIK","₱":"CURRENCY_PESO","₴":"CURRENCY_UKRAINE_HRYVNIA","₼":"CURRENCY_AZERBAIJAN_MANAT","₽":"CURRENCY_RUSSIA_RUBLE","﷼":"CURRENCY_RIAL",ƒ:"CURRENCY_GUILDER",Kč:"CURRENCY_CZECH_REPUBLIC_KORUNA",zł:"CURRENCY_POLAND_ZLOTY",ден:"CURRENCY_MACEDONIA_DENAR",Дин:"CURRENCY_SERBIA_DINAR",лв:"CURRENCY_LEV_TENGE_SOM","₺":"CURRENCY_TURKEY_LIRA"},i2=new Set(Object.values(Qi).map(e=>e.toLowerCase()));function Hc(e){let t=e;return Object.entries(Qi).forEach(([n,i])=>{t=t.replaceAll(n,i)}),t}function Ko(e){let t=e;return Object.entries(Qi).forEach(([n,i])=>{t=t.replaceAll(new RegExp(i,"ig"),n)}),t}const o2=x.delay("currency symbols",()=>{const e=Object.keys(Qi).join(""),t=Object.values(Qi).join("");x("hide_currency_symbols",()=>{let n="",i="",o="";n=`${e}90 ${e} / year`,i=`${t}90 ${t} / year`,o=Hc(n),u(o,i,"Convert currency symbols to ascii strings")}),x("unhide_currency_symbols",()=>{let n="",i="",o="";n=`${t}90 ${t} / year`,i=`${e}90 ${e} / year`,o=Ko(n),u(o,i,"Converts currency ascii strings back to symbols"),n="Currency_pound90 Currency_pound / year",i="£90 £ / year",o=Ko(n),u(o,i,"Copes with Simulation.JS changing capitalisation of unit words")})}),Gc=new Set(["-parent","e","pi","phi","mod","expt","abs","sin","asin","cos","acos","tan","atan","sqrt","log","exp","round","floor","ceiling","RandBeta","RandDist","RandBoolean","Rand","RandNormal","RandExp","RandLognormal","RandBinomial","RandNegativeBinomial","RandGamma","RandPoisson","RandTriangular","Magnitude","Abs","sin","cos","tan","asin","acos","atan","arcsin","arccos","arctan","Sign","Sqrt","Ln","Log","Logit","Expit","Round","Ceiling","Floor","Exp","Sample","IndexOf","Contains","Collapse","Select","Reverse","Reverse","Sort","Sort","Unique","Unique","Union","Intersection","Difference","Factorial","Max","Max","Lookup","Fill","Min","Min","Mean","Mean","Sum","Sum","Product","Product","Median","Median","StdDev","StdDev","Correlation","Keys","Values","Length","Count","Flatten","CDFNormal","PDFNormal","InvNormal","CDFLogNormal","PDFLogNormal","InvLogNormal","CDFt","PDFt","Invt","CDFF","PDFF","InvF","CDFChiSquared","PDFChiSquared","InvChiSquared","CDFExponential","PDFExponential","InvExponential","CDFPoisson","PMFPoisson","SetRandSeed","Alert","Console","Prompt","Confirm","Parse","Split","Join","Trim","Range","Length","IndexOf","Contains","Lowercase","Uppercase","sqrt","sum","ifthenelse","ifthenelse","assert","assert","map","map","map","indexof","filter","map","select","filter","filter","join","repeat","repeat","join","reverse","join","sort","join","unique","unique","join","unique","unique","max","flatten","flatten","min","mean","sum","product","sort","median","mean","stddev","mean","mean","stddev","stddev","sum","count","count","join","flatten","join","flatten","stringbase","vectorbase","Stop","Pause","Time","TimeStep","TimeLength","TimeStart","TimeEnd","Seconds","Minutes","Hours","Days","Weeks","Months","Years","Seasonal","Unitless","RemoveUnits","PastMean","PastMedian","PastValues","PastStdDev","PastCorrelation","PastMax","PastMin","Pulse","Ramp","Step","Delay","Smooth","Delay1","Delay3","Remove","Add","FindAll","ResetTimer","Transition","Value","SetValue","FindIndex","FindState","FindNotState","FindNearby","FindNearest","FindFurthest","Index","Connect","Unconnect","Connected","ConnectionWeight","SetConnectionWeight","Width","Height","Distance","Location","SetLocation","Move","MoveTowards"]);[...Gc].forEach(e=>Gc.add(e.toLowerCase()));function Ue(e,t){let n=e;return n=s2(t,n),n}function s2(e,t){return e.forEach(n=>{const i=new RegExp(`@@${n}`,"g"),o=`[${n}]`;t=t.replace(i,o)}),t}const r2=x.delay("normalise_calculation_ids",()=>{const e=le(1);let t="",n="",i="";t="[A] + 3",n="[A] + 3",i=Ue(t,[]),u(i,n,"Original square bracket IDs ignored"),t="[A] + B",n="[A] + [B]",i=Ue(t,[]);const o="Skipping for now as auto wrapping in square brackets is error prone and invalidates a lot of the SimulationJS keywords, syntax, language constructs.";u.skip(i,n,`${o} Non square bracket id put into square brackets`),t="A + [B]",n="[A] + [B]",i=Ue(t,[]),u.skip(i,n,`${o} Beginning with non square bracket id put into square brackets`),t="A-B",n="[A]-[B]",i=Ue(t,[]),u.skip(i,n,`${o} Non square bracket ids with no spaces and a negation sign between are put into square brackets`),t=`[A] + @@${e}`,n=`[A] + [${e}]`,i=Ue(t,[e]),u(i,n,"@@ uuid id put into square brackets"),t="B + B",n="[B] + [B]",i=Ue(t,[]),u.skip(i,n,`${o} Repeated non square bracket id dealt with correctly`),t="sin(1) + B",n="sin(1) + [B]",i=Ue(t,[]),u.skip(i,n,`${o} Simulation.js functions not processed into square brackets`),t="A>B",n="[A]>[B]",i=Ue(t,[]),u.skip(i,n,`${o} Simulation.js equality signs not processed into square brackets`),t="[Some agent].FindAll([Some state]) + B",n="[Some agent].FindAll([Some state]) + [B]",i=Ue(t,[]),u.skip(i,n,`${o} Simulation.js agent functions not processed into square brackets`),t="[ Some variable ] + [ another variable ]",n="[ Some variable ] + [ another variable ]",i=Ue(t,[]),u(i,n,"Existing square bracket id with spaces is not altered"),t="{4 miles} / {6.4e3 meters}",n="{4 miles} / {6.4e3 meters}",i=Ue(t,[]),u(i,n,"Units inside curly braces are left unaltered"),t="{7 Widgets/Years^2}",n="{7 Widgets/Years^2}",i=Ue(t,[]),u(i,n,"Compound units and those raised to power inside curly braces are left unaltered"),t=`{@@${e} meters}`,n=`{[${e}] meters}`,i=Ue(t,[e]),u.skip(i,n,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Double @ reference uuids and their units are preserved in curly braces~~"),t=`x <- 2
    If x > 10 Then
      'Big'
    Else
      'Small'
    End If`,n=t,i=Ue(t,[]),u(i,n,"Should not wrap variables, key words, or literal strings in square brackets")}),_2=/.*?\d{1,3}((?:,\d{3})+)/g;function Zn(e){let t=e;return[...t.matchAll(_2)].forEach(i=>{const o=i[0];o&&(t=t.replaceAll(o,o.replaceAll(",","")))}),t}const a2=x.delay("normalise_calculation_numbers",()=>{const e=le(1);let t="",n="",i="";t=`B + [A] @@${e} + 3.1 + {4.2 km}`,n=`B + [A] @@${e} + 3.1 + {4.2 km}`,i=Zn(t),u(i,n,"Non and square bracket IDs, @@uuids, decimal numbers, and curly bracket numbers with units are left unchanged"),t="3,200 + 1,800.0",n="3200 + 1800.0",i=Zn(t),u(i,n,"Thousands commas are removed from numbers"),t="3,20 + 1,80.0",n="3,20 + 1,80.0",i=Zn(t),u(i,n,"Non-thousands commas are ignored"),t="1,200,300 10,300,400 100,200,300",n="1200300 10300400 100200300",i=Zn(t),u(i,n,"Thousands commas are removed from millions"),t="1,200,300,400 10,200,300,400 100,200,300,400",n="1200300400 10200300400 100200300400",i=Zn(t),u(i,n,"Thousands commas are removed from billions")});function c2(e,t){return Vh(new Date(e),t).getTime()}function Vh(e,t){const n=_s({date:e,time_resolution:t});return new Date(n)}function ro(){return{created_at:new Date,custom_created_at:void 0}}var E=(e=>(e[e.boolean=0]="boolean",e[e.number=1]="number",e[e.other=2]="other",e[e.action=3]="action",e[e.undefined=4]="undefined",e))(E||{});function Me(){return{id:Bk(),explanation:"",probability:0,conviction:1,value:"",description:""}}function wl(e,t){const n=e.length>1;let i=0;return e=e.map(o=>{const s=n?o.relative_probability===void 0?o.probability:o.relative_probability:void 0;return s!==void 0&&(i+=s),{...o,relative_probability:s}}),t!==E.boolean&&(i=i||1,e=e.map(o=>{const r=(o.relative_probability===void 0?1:o.relative_probability)/i;return{...o,probability:r}})),e}const Fh=["potential","in progress","paused","completed","failed","rejected"];new Set(Fh);var $e=(e=>(e.action_potential="action__value_possibility__potential_id",e.action_in_progress="action__value_possibility__in_progress_id",e.action_paused="action__value_possibility__paused_id",e.action_completed="action__value_possibility__completed_id",e.action_failed="action__value_possibility__failed_id",e.action_rejected="action__value_possibility__rejected_id",e))($e||{});const we={uncertainty:"value_possibility_uncertainty_id__undefined__",boolean_true:"value_possibility_true_id",boolean_false:"value_possibility_false_id",...$e},l2=["action__value_possibility__potential_id","action__value_possibility__in_progress_id","action__value_possibility__paused_id","action__value_possibility__completed_id","action__value_possibility__failed_id","action__value_possibility__rejected_id"],Kc={[we.uncertainty]:"Uncertainty",[we.boolean_true]:"True",[we.boolean_false]:"False",[we.action_potential]:"Potential",[we.action_in_progress]:"In Progress",[we.action_paused]:"Paused",[we.action_completed]:"Completed",[we.action_failed]:"Failed",[we.action_rejected]:"Rejected"};function bl(e,t){return t===E.boolean?e.probability>.5:t===E.number?zh(e.value):e.value}function Ne(e){return!Number.isNaN(zh(e))}function zh(e){if(e=e.trim(),e==="")return null;const t=e.split(",");for(let s=1;s<t.length;++s){let r=t[s]||"";if(r=r.split(/[^\d]/)[0]||"",r.length!==3)return Number.NaN}e=t.join("");const n=e.match(/^(-?[0-9]*\.?[0-9]*)\s*(?:(e)\s*(-?[0-9]+))?\s*(%)?$/);let i=NaN,o=!0;for(;o&&n;){const[,s,r,a,c]=n;if(!s||(i=parseFloat(s),Number.isNaN(i)))break;r&&a&&(i=i*10**parseInt(a)),c&&(i=i/100),o=!1}return i}function d2(e,t){let n=bl(e,t);return t===E.boolean&&(n=e.value_id===we.boolean_true),n}function Qn(e,t){return e===E.boolean?t=[{value:"True",id:we.boolean_true,order:0},{value:"False",id:we.boolean_false,order:1}]:e===E.action?t=l2.map((n,i)=>({id:n,value:Kc[n]||"?",order:i})):t.length===0&&(e===E.number?["1"]:[""]).forEach((n,i)=>{t.push({value:n,order:i})}),t}const u2=x.delay("default_possible_values",()=>{const e=[{id:"730a7cb4-7523-45f7-bfde-a00d0acb9f65",value:"",description:"",order:0},{id:"724c4da6-f4ee-4680-a493-556ee241f29d",value:"",description:"",order:1}];let t=Qn(E.boolean,e);u.skip(t.length,1,"If boolean and given more than one value possibility, it should be reduced back to 1"),t=Qn(E.boolean,[]),u(t.length,2,"If boolean and no value possibilities, it should create 2"),t=Qn(E.action,[]),u(t.length,Fh.length,"If action and no value possibilities, it should create the set"),t=Qn(E.other,[]),u(t.length,1,"If other and no value possibilities, it should create an empty value"),t=Qn(E.number,[]),u(t.length,1,"If other and no value possibilities, it should create an empty value")});function yl(e){let t=-1;if(e){let n;Array.isArray(e)?n=e:n=Object.values(e),n.forEach(({order:i=-1})=>t=Math.max(t,i))}return t}function p2(e){let t=yl(e);return e.map(i=>{const o=i.id||ml(),s=i.order??++t;return{description:"",...i,id:o,order:s}})}function yn(e,t,n){const i=m2(e,t,n);return p2(i)}function m2(e,t,n){const i=Object.values(t||{}).map(s=>({...s,id:void 0,value_id:s.id}));n.forEach(s=>{s.entries.forEach(({value_id:r,value:a})=>{i.push({value_id:r,value:a})})});const o=Lh(i,t);return Qn(e,o)}function Lh(e,t={}){let n=[];const i=new Set;let o=0;return e.forEach(({value_id:s})=>{const r=t[s||""];!r||i.has(r.value)||(n.push(r),o=Math.max(o,r.order),i.add(r.value))}),e.forEach(({value:s,value_id:r})=>{i.has(s)||(n.push({value:s,id:r,order:++o}),i.add(s))}),e.length===0&&(n=Object.values(t)),n.sort((s,r)=>(s.order??0)<(r.order??0)?-1:1)}const f2=x.delay("get_possibilities_from_VAP_sets",()=>{var s,r,a,c,l,d,p;const e=E.number,t="val_prob_id_123",n=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...Me(),value_id:t,value:"abc",description:""},{...Me(),value_id:void 0,value:"duplicated",description:""},{...Me(),value_id:void 0,value:"duplicated",description:""}]}];let i=yn(e,void 0,n);u(i.length,2,"Should get possibilities for all unique values and remove duplicates"),u((s=i[0])==null?void 0:s.value,"abc"),u.skip(((r=i[0])==null?void 0:r.id)!==t,!0,"Should set a new ID"),u((a=i[1])==null?void 0:a.value,"duplicated"),u(((c=i[1])==null?void 0:c.id)!==void 0,!0,"Should set a new ID if original is undefined");let o={[t]:{id:t,value:"new abc",description:"",order:1}};i=yn(e,o,n),u((l=i[0])==null?void 0:l.value,"new abc"),u((d=i[0])==null?void 0:d.id,t,"Should reuse existing ID"),u((p=i[1])==null?void 0:p.order,2,"Should increment off maximum order")});function Ie(e,t,n,i){const o=ro(),s=v2(e,t,n),r=e===E.action?{value:new Date}:n.length>0?{value:new Date}:{};return{id:Lk(),...o,base_id:i,datetime:r,entries:s}}function v2(e,t,n){const o=yn(e,t,n).map(r=>({...Me(),value:r.value,value_id:r.id,description:r.description||""}));return wl(o,e)}function h2(e){return{...e,...ro(),entries:e.entries.map(n=>({...n,explanation:""})),shared_entry_values:{...e.shared_entry_values,explanation:void 0}}}const g2=x.delay("prepare_new_VAP_set",()=>{const e=[{...Ie(E.other,void 0,[],1),entries:[{...Me(),value_id:"1",value:"a"},{...Me(),value_id:"2",value:"b"}]},{...Ie(E.other,void 0,[],1),entries:[{...Me(),value_id:"1",value:"a"},{...Me(),value_id:"2",value:"b"}]}],t={1:{id:"1",value:"a",description:"",order:0},2:{id:"2",value:"b",description:"",order:1}},n=Ie(E.other,t,e,1);u(n.entries.length,2,"If there are only two unique possibilities, only return 2 VAPs")}),Bh="toggle_linked_datetime_sliders",w2=()=>({type:Bh}),b2=e=>e.type===Bh,Uh="set_display_time_sliders",y2=e=>({type:Uh,display_time_sliders:e}),k2=e=>e.type===Uh,Wh="toggle_display_time_sliders",x2=()=>({type:Wh}),S2=e=>e.type===Wh,Hh="set_or_toggle_display_side_panel",A2=e=>(typeof e!="boolean"&&(e=void 0),{type:Hh,display_side_panel:e}),$2=e=>e.type===Hh,Gh="set_or_toggle_display_select_storage",C2=e=>(typeof e!="boolean"&&(e=void 0),{type:Gh,display_select_storage:e}),j2=e=>e.type===Gh,T2={toggle_linked_datetime_sliders:w2,set_display_time_sliders:y2,toggle_display_time_sliders:x2,set_or_toggle_display_side_panel:A2,set_or_toggle_display_select_storage:C2},Kh="toggle_consumption_formatting",P2=()=>({type:Kh}),N2=e=>e.type===Kh,Yh="set_or_toggle_focused_mode",E2=e=>({type:Yh,focused_mode:e}),I2=e=>e.type===Yh,Jh="set_time_resolution",D2=e=>({type:Jh,...e}),R2=e=>e.type===Jh,Xh="set_validity_filter",O2=e=>({type:Xh,...e}),M2=e=>e.type===Xh,Zh="set_certainty_formatting",q2=e=>({type:Zh,...e}),V2=e=>e.type===Zh,Qh="set_display_by_simulated_time",F2=e=>({type:Qh,display_by_simulated_time:e}),z2=e=>e.type===Qh,eg="set_display_time_marks",L2=e=>({type:eg,display_time_marks:e}),B2=e=>e.type===eg,tg="set_or_toggle_animate_connections",U2=e=>({type:tg,animate_connections:e}),W2=e=>e.type===tg,ng="set_or_toggle_circular_links",H2=e=>({type:ng,circular_links:e}),G2=e=>e.type===ng,ig="set_show_help_menu",K2=e=>({type:ig,...e}),Y2=e=>e.type===ig,og="set_or_toggle_show_large_grid",J2=e=>({type:og,show_large_grid:e}),X2=e=>e.type===og,Z2={toggle_consumption_formatting:P2,set_or_toggle_focused_mode:E2,set_time_resolution:D2,set_validity_filter:O2,set_certainty_formatting:q2,set_display_by_simulated_time:F2,set_display_time_marks:L2,set_or_toggle_animate_connections:U2,set_or_toggle_circular_links:H2,set_show_help_menu:K2,set_or_toggle_show_large_grid:J2},sg="set_apply_filter",Q2=e=>({type:sg,apply_filter:e}),ex=e=>e.type===sg,rg="set_filters",tx=e=>({type:rg,...e}),nx=e=>e.type===rg,ix={set_apply_filter:Q2,set_filters:tx},_g="key_down",ox=e=>({type:_g,...e}),sx=e=>e.type===_g,ag="key_up",rx=e=>({type:ag,...e}),_x=e=>e.type===ag,cg="clear_all_keys",ax=()=>({type:cg}),cx=e=>e.type===cg,lx={key_down:ox,key_up:rx,clear_all_keys:ax},lg="set_action_ids_to_show",dx=e=>({type:lg,...e}),ux=e=>e.type===lg,px={set_action_ids_to_show:dx},dg="change_route",mx=e=>{const t=e.args;return t&&(t.x=Ws(t.x),t.y=Ws(t.y),t.zoom=Ws(t.zoom)),{type:dg,...e}};function Ws(e){return e===void 0?e:Math.round(e)}const ug=e=>e.type===dg,fx={change_route:mx};function Ft(e,t,n){return e[t]===n?e:{...e,[t]:n}}function O(e,t,n,i){const o=Ft(e[t],n,i);return Ft(e,t,o)}function cs(e,t,n,i,o){const s=Ft(e[t][n],i,o),r=Ft(e[t],n,s);return Ft(e,t,r)}function pg(e,t,n,i,o,s){const r=Ft(e[t][n][i],o,s),a=Ft(e[t][n],i,r),c=Ft(e[t],n,a);return Ft(e,t,c)}function ku(e,t){return e?vx(e,t||""):new Date}function vx(e,t){const n=new Date(e+" "+t);return Number.isNaN(n.getTime())?new Date:n}function mg(e){return e.ms===void 0?{ms:e.datetime.getTime(),datetime:e.datetime}:{ms:e.ms,datetime:new Date(e.ms)}}function xu(e,t,n=console.warn){return t===void 0?e?e.getTime():void 0:(e!==void 0&&n("do not set both new_ms and new_datetime"),t)}const hx=(e,t)=>{if(gx(t)){const{ms:n,datetime:i}=mg(t),o={...e.routing.args,created_at_datetime:i,created_at_ms:n};e.controls.linked_datetime_sliders&&(o.sim_datetime=i,o.sim_ms=n),e=O(e,"routing","args",o)}return e},fg="change_display_at_created_datetime",vg=e=>({type:fg,...e}),gx=e=>e.type===fg,wx={change_display_at_created_datetime:vg},bx=3600*1e3;function yx(e){setTimeout(()=>{e.dispatch(vg({datetime:new Date}))},bx)}const kx=(e,t)=>{if(Sx(t)){const{ms:n,datetime:i}=mg(t),o={...e.routing.args,sim_datetime:i,sim_ms:n};e.controls.linked_datetime_sliders&&(o.created_at_datetime=i,o.created_at_ms=n),e=O(e,"routing","args",o)}return e},hg="change_display_at_sim_datetime",xx=e=>({type:hg,...e}),Sx=e=>e.type===hg,Ax={change_display_at_sim_datetime:xx},$x=(e,t)=>(Tx(t)&&(e=O(e,"search","search_fields",t.search_fields)),Nx(t)&&(e=O(e,"search","search_type",t.search_type)),e),kl="update_search_fields",Cx="update_search_type",jx=e=>({type:kl,...e}),Tx=e=>e.type===kl,Px=e=>({type:kl,...e}),Nx=e=>e.type===Cx,Ex={update_search_fields:jx,update_search_type:Px};function gg(e,t={},n={},i={},o={},s={},r={},a={},c={}){return{...e,...t,...n,...i,...o,...s,...r,...a,...c}}const wg="bulk_edit_knowledge_view_entries",Ix=e=>({type:wg,...e}),Dx=e=>e.type===wg,bg="bulk_update_knowledge_view_entries",Rx=e=>({type:bg,...e}),Ox=e=>e.type===bg,yg="snap_to_grid_knowledge_view_entries",Mx=e=>({type:yg,...e}),qx=e=>e.type===yg,kg="change_current_knowledge_view_entries_order",Vx=e=>({type:kg,...e}),Fx=e=>e.type===kg,xg="bulk_add_to_knowledge_view",zx=e=>({type:xg,...e}),Lx=e=>e.type===xg,Sg="bulk_remove_from_knowledge_view",Bx=e=>({type:Sg,...e}),Ux=e=>e.type===Sg,Wx={bulk_edit_knowledge_view_entries:Ix,bulk_update_knowledge_view_entries:Rx,bulk_add_to_knowledge_view:zx,bulk_remove_from_knowledge_view:Bx,snap_to_grid_knowledge_view_entries:Mx,change_current_knowledge_view_entries_order:Vx},Ag="upsert_knowledge_view_entry",Hx=e=>({type:Ag,...e}),Gx=e=>e.type===Ag,$g="upsert_knowledge_view",Kx=e=>({type:$g,...e}),Cg=e=>e.type===$g,Yx={upsert_knowledge_view_entry:Hx,upsert_knowledge_view:Kx,...Wx};function Mn(e){return e&&(e.min||e.value||e.max)}function jg(e){return Mn(e)===void 0}var ve=(e=>(e[e.ascending=0]="ascending",e[e.descending=1]="descending",e))(ve||{});function be(e,t,n){const i=Jx(n);return e.map((o,s)=>({item:o,key_value:t(o,s)})).sort(i).map(({item:o})=>o)}function Jx(e){const t=e===0,n=t?-1:1,i=t?1:-1;return(o,s)=>o.key_value<s.key_value?n:o.key_value>s.key_value?i:0}function Xx(e){return e.custom_created_at||e.created_at}function ze(e){return Xx(e).getTime()}function Tg(e){return Mn(e.datetime)}function _o(e){const{items:t,created_at_ms:n}=e,i=[],o=[];return t.forEach(s=>{ze(s)>n?i.push(s):o.push(s)}),{invalid_future_items:i,current_items:o}}const Zx=x.delay("partition_items_by_created_at_datetime",()=>{function e(m){const v=_o(m);return{invalid_future_items:v.invalid_future_items.map(({id:h})=>h),current_items:v.current_items.map(({id:h})=>h)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime(),p={base_id:-1,id:"1",created_at:s},f={base_id:-1,id:"2",created_at:a};t=[],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[]}),t=[p,f],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:c}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:r}),u(n,{invalid_future_items:[f.id],current_items:[p.id]}),n=e({items:t,created_at_ms:o}),u(n,{invalid_future_items:[p.id,f.id],current_items:[]})});function ls(e){const t={};e.forEach(o=>{const s=t[o.id]||[];s.push(o),t[o.id]=s});const n={};return{latest:Object.values(t).map(o=>{const s=be(o,ze,ve.descending),r=s[0];return n[r.id]=s.slice(1),r}),previous_versions_by_id:n}}function pe(e,t){return t?e.specialised_objects.wcomponents_by_id[t]:void 0}function Pg(e,t){return t=t||[],t=t instanceof Set?Array.from(t):t,t.map(n=>e[n])}function kn(e,t){return t=t||[],t=t instanceof Set?Array.from(t):t,t.map(n=>pe(e,n))}function _e(e){return e.derived.current_composed_knowledge_view}function Be(e){return e.specialised_objects.knowledge_views_by_id[e.routing.args.subview_id]}function Qx(e,t){const n=Be(e);if(!n)return!1;const i=n.wc_id_map[t];return!!i&&!i.passthrough}function di(e,t){return e.specialised_objects.knowledge_views_by_id[t]}function Ng(e,t){const n=new Set(e.map(r=>r.id));e=e.filter(r=>r.base_id===t);const i=new Set(e.map(r=>r.id)),o={top_ids:[],map:{}},s=[];return e.forEach(r=>{const{parent_knowledge_view_id:a,title:c,sort_type:l="normal"}=r;a?s.push({...r,parent_knowledge_view_id:a}):(o.top_ids.push(r.id),o.map[r.id]={id:r.id,title:c,sort_type:l,parent_id:void 0,child_ids:[]})}),Eg(n,i,s,o,t),o}function Eg(e,t,n,i,o){if(n.length===0)return;const s=[];if(n.forEach(r=>{const a=i.map[r.parent_knowledge_view_id];if(a){const{id:c,title:l,sort_type:d="normal"}=r;a.child_ids.push(c),i.map[c]={id:c,title:l,sort_type:d,parent_id:a.id,child_ids:[]}}else s.push(r)}),n.length===s.length){const r=s.filter(a=>a.base_id===o);r.length&&console.warn(`Maybe broken knowledge view tree.  Look in "Views" for:
 * ${r.map(a=>`${a.title} ${a.id}`).join(`
 * `)}`),s.forEach(({id:a,title:c,parent_knowledge_view_id:l})=>{i.top_ids.push(a);const d=t.has(l),p=!e.has(l),f=!d&&!p;i.map[a]={id:a,title:c,sort_type:"errored",parent_id:void 0,child_ids:[],ERROR_is_circular:d,ERROR_parent_kv_missing:p,ERROR_parent_from_diff_base:f}})}else Eg(e,t,s,i,o)}function eS(e){e.top_ids=Su(e.top_ids,e.map),Object.values(e.map).forEach(t=>{t.child_ids=Su(t.child_ids,e.map)})}const tS={priority:"0",normal:"1",hidden:"2",archived:"3",errored:"4"};function Su(e,t){return be(e,n=>{const i=t[n];return tS[i.sort_type]+i.title.toLowerCase()},ve.ascending)}function nS(e,t){return!!t[e]}function iS(e,t,n){const i=xl(e,t,n);return Mn(i==null?void 0:i.temporal_uncertainty)}function xl(e,t,n){const i=t[e];if(fl(i)){const{event_at:o=[]}=i,s=o[0];if(!s)return;const r=s.datetime,a=s.probability*s.conviction;return{temporal_uncertainty:r,certainty:a}}else if(oo(i)){const{target_wcomponent_id:o,selector:s}=i,r=t[o||""],a=Ke(r)&&r;if(!a||!s)return;const{target_VAP_set_id:c}=s;if(!c)return;let{values_and_prediction_sets:l}=a;l=l.filter(({id:p})=>p===c),l=_o({items:l,created_at_ms:n}).current_items,l=be(l,ze,ve.descending);const d=l[0];return Au(d)}else if(i&&bi(i)){const o=Ig(i);if(o)return Au(o)}}function Ig(e){let t=e.values_and_prediction_sets||[];t=ls(t).latest;const n=t[0];if(n&&t.length===1)return n;const i=t.filter(s=>!jg(s.datetime)),o=i[0];return o&&i.length===1?o:!1}function Au(e){var i;if(!e)return;let t;const n=(i=e.shared_entry_values)==null?void 0:i.conviction;return e.entries.forEach(o=>{const s=o.probability*(n!==void 0?n:o.conviction);t=Math.max(t||0,s)}),{temporal_uncertainty:e.datetime,certainty:t}}const oS=(e,t)=>{if(rS(t)){const{id:n,highlighted:i}=t;let o=new Set(e.meta_wcomponents.highlighted_wcomponent_ids);n===void 0?o=new Set:i?o.add(n):o.delete(n),e=O(e,"meta_wcomponents","highlighted_wcomponent_ids",o);let{neighbour_ids_of_highlighted_wcomponent:s}=e.meta_wcomponents;if(e.display_options.focused_mode){const a=_e(e);if(a&&(s=new Set,n!==void 0&&t.highlighted)){const c=a.wc_id_connections_map[n];c&&(s=new Set(c),e.derived.wcomponent_ids_by_type.any_node.has(n)&&c.forEach(l=>{const d=a.wc_id_connections_map[l];d&&d.forEach(p=>s.add(p))}))}}else s.size&&(s=new Set);e=O(e,"meta_wcomponents","neighbour_ids_of_highlighted_wcomponent",s)}return e},Dg="set_highlighted_wcomponent",sS=e=>({type:Dg,id:e.id,highlighted:e.highlighted}),rS=e=>e.type===Dg,_S={set_highlighted_wcomponent:sS},Rg="replace_all_specialised_objects",aS=e=>({type:Rg,...e}),Og=e=>e.type===Rg,Mg="clear_from_mem_all_specialised_objects",cS=()=>({type:Mg}),qg=e=>e.type===Mg,lS={replace_all_specialised_objects:aS,clear_from_mem_all_specialised_objects:cS},Vg="bulk_edit_wcomponents",dS=e=>({type:Vg,...e}),uS=e=>e.type===Vg,pS={bulk_edit_wcomponents:dS},Fg="upsert_wcomponent",mS=e=>({type:Fg,...e}),ds=e=>e.type===Fg,zg="delete_wcomponent",fS=e=>({type:zg,...e}),vS=e=>e.type===zg,Lg="add_wcomponents_to_store",hS=e=>({type:Lg,...e}),gS=e=>e.type===Lg,wS={upsert_wcomponent:mS,delete_wcomponent:fS,add_wcomponents_to_store:hS,...pS},bS=gg(_S,lS,wS,Yx),Bg="set_find_all_causal_paths_wcomponent_ids",yS=e=>({type:Bg,...e}),kS=e=>e.type===Bg,xS={set_find_all_causal_paths_wcomponent_ids:yS},Ug="clicked_wcomponent",SS=e=>({type:Ug,...e}),AS=e=>e.type===Ug,Wg="clear_selected_wcomponents",$S=()=>({type:Wg}),CS=e=>e.type===Wg,Hg="set_selected_wcomponents",jS=e=>({type:Hg,...e}),TS=e=>e.type===Hg,Gg="pointerupdown_on_connection_terminal",PS=e=>({type:Gg,...e}),Kg=e=>e.type===Gg,NS=e=>Kg(e)&&e.up_down==="up",ES=e=>Kg(e)&&e.up_down==="down",Yg="pointerupdown_on_component",IS=e=>({type:Yg,...e}),Jg=e=>e.type===Yg,DS=e=>Jg(e)&&e.up_down==="up",RS=e=>Jg(e)&&e.up_down==="down",Xg="clear_pointerupdown_on_connection_terminal",OS=()=>({type:Xg}),MS=e=>e.type===Xg,Zg="set_wcomponent_ids_to_move",qS=e=>({type:Zg,...e}),VS=e=>e.type===Zg,FS={clicked_wcomponent:SS,clear_selected_wcomponents:$S,set_selected_wcomponents:jS,pointerupdown_on_connection_terminal:PS,pointerupdown_on_component:IS,clear_pointerupdown_on_connection_terminal:OS,set_wcomponent_ids_to_move:qS},Qg="set_frame_is_resizing",zS=e=>({type:Qg,...e}),LS=e=>e.type===Qg,BS=gg({set_frame_is_resizing:zS},FS,xS),ew="update_sync_status",US=e=>({type:ew,...e}),WS=e=>e.type===ew,tw="debug_refresh_all_specialised_object_ids_pending_save",HS=()=>({type:tw}),GS=e=>e.type===tw,nw="update_specialised_object_sync_info",KS=e=>({type:nw,...e}),iw=e=>e.type===nw,ow="update_network_status",YS=e=>({type:ow,...e}),JS=e=>e.type===ow,sw="request_searching_for_wcomponents_by_id_in_any_base",XS=e=>({type:sw,...e}),ZS=e=>e.type===sw,rw="searching_for_wcomponents_by_id_in_any_base",QS=()=>({type:rw}),eA=e=>e.type===rw,_w="searched_for_wcomponents_by_id_in_any_base",tA=e=>({type:_w,...e}),nA=e=>e.type===_w,iA={update_sync_status:US,debug_refresh_all_specialised_object_ids_pending_save:HS,update_specialised_object_sync_info:KS,update_network_status:YS,request_searching_for_wcomponents_by_id_in_any_base:XS,searching_for_wcomponents_by_id_in_any_base:QS,searched_for_wcomponents_by_id_in_any_base:tA},aw="set_user",oA=e=>({type:aw,...e}),sA=e=>e.type===aw,cw="set_need_to_handle_password_recovery",rA=e=>({type:cw,need_to_handle_password_recovery:e}),_A=e=>e.type===cw,lw="set_users",aA=e=>({type:lw,...e}),cA=e=>e.type===lw,dw="update_chosen_base_id",lA=e=>({type:dw,...e}),dA=e=>e.type===dw,uw="update_bases",uA=e=>({type:uw,...e}),pA=e=>e.type===uw,mA={set_user:oA,set_need_to_handle_password_recovery:rA,set_users:aA,update_chosen_base_id:lA,update_bases:uA},S={controls:T2,filter_context:ix,display:Z2,sync:iA,routing:fx,global_keys:lx,display_at_created_datetime:wx,display_at_sim_datetime:Ax,search:Ex,specialised_object:bS,meta_wcomponents:BS,user_info:mA,view_priorities:px},on={debug:e=>{console.debug(e)},log:e=>{console.log(e)},info:e=>{console.info(e)},warn:e=>{console.warn(e)},error:e=>{console.error(e)}};function pw(e){const{wcomponent_ids:t,knowledge_view_ids:n}=e.sync.specialised_object_ids_pending_save;return t.size+n.size>0}function fA(e){const{wcomponent_ids:t,knowledge_view_ids:n}=e.sync.specialised_object_ids_pending_save,o=t.values().next();if(!o.done)return{id:o.value,object_type:"wcomponent"};const r=n.values().next();if(!r.done)return{id:r.value,object_type:"knowledge_view"}}function vA(e){const{user:t,users_by_id:n}=e.user_info;return t&&n?n[t.id]:void 0}function us(e){const t=vA(e);return t==null?void 0:t.name}function Sl(e){const{user:t,users_by_id:n}=e.user_info;return t&&n&&!us(e)}function ao(e,t=""){const{bases_by_id:n,chosen_base_id:i}=e.user_info,o=n&&n[i||""];function s(r){t&&console.error(r+t)}return n||s("No state.user_info.bases_by_id present"),i===void 0&&s("No state.user_info.chosen_base_id present"),o===void 0&&s("No chosen_base present"),o}function hA(e){const t=ao(e),n=pt(e);return t?t.title:n===void 0?"Not set":`Unknown Store: ${n}`}function mw(e){const{user:t,bases_by_id:n}=e.user_info;if(t&&n)return Object.values(n).filter(i=>i.can_edit)}function gA(e){const t=mw(e);return t===void 0?void 0:t.length>0}function pt(e){return e.user_info.chosen_base_id}function fw(e){const{bases_by_id:t}=e.user_info;return t===void 0?!1:gA(e)===!1&&ao(e)===void 0}function wA(e){const t=ao(e);return t==null?void 0:t.access_level}function We(e){return{id:io(),...ro(),title:"",description:"",wc_id_map:{},goal_ids:[],sort_type:"normal",...e}}function bA(e){const t=e.store||Ae(),n=pt(t.getState()),i={...e.knowledge_view,base_id:n},o=We(i);t.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:o}))}function $u(e,t){t.dispatch(S.routing.change_route({route:"wcomponents",args:{subview_id:e}}))}function vw(e){const{last_source_of_truth_value:t,current_value:n,source_of_truth_value:i,get_custom_field_merger:o}=e;let s={...i},r=!1,a=[];return yA(n,t,i).forEach(l=>{const p=(o(l)||kA(l))(e);r=r||p.needs_save,p.unresolvable_conflict&&a.push(l),s[l]=p.value}),{value:s,needs_save:r,unresolvable_conflicted_fields:a}}function yA(...e){const t=new Set;return e.forEach(n=>{Object.keys(n).forEach(i=>{t.add(i)})}),Array.from(t)}function kA(e){const t=new Set(["needs_save","saving"]),n=new Set(["id","created_at","modified_at"]);function i(o){const s=o.source_of_truth_value[e],r=o.current_value[e];let a=!1,c=!1;return t.has(e)?{needs_save:a,unresolvable_conflict:c,value:r}:n.has(e)?{needs_save:a,unresolvable_conflict:c,value:s}:hw(e)(o)}return i}function hw(e){function t(i,o){return JSON.stringify(i)===JSON.stringify(o)}function n(i){const o=i.source_of_truth_value[e],s=i.current_value[e],r=i.last_source_of_truth_value[e];let a=!1,c=!1,l;return i.update_successful||t(o,r)?(l=s,a=!t(s,o)):(l=o,t(s,r)||(c=!t(s,o),c&&console.debug("unresolvable_conflict with field: ",e,"last_source_of_truth_field_value",r,"source_of_truth_field_value",o,"current_field_value",s))),{needs_save:a,unresolvable_conflict:c,value:l}}return n}function mn(e){return vw({...e,get_custom_field_merger:xA})}function xA(e){if(e!=="wc_id_map")return;function t(n,i){return JSON.stringify(n)===JSON.stringify(i)}return n=>{const i=n.source_of_truth_value.wc_id_map,o=n.current_value.wc_id_map,s=n.last_source_of_truth_value.wc_id_map;let r=!1,a=!1,c;return n.update_successful||t(i,s)?(c=o,r=!t(o,i)):(c=i,t(o,s)||Array.from(new Set(Object.keys(o).concat(Object.keys(i)))).forEach(d=>{const p=hw(d)({source_of_truth_value:i,current_value:o,last_source_of_truth_value:s,update_successful:n.update_successful});c[d]=p.value,p.unresolvable_conflict&&console.debug("unresolvable_conflict in wc_id_map with wc_id: ",d,"last_source_of_truth_value",s[d],"source_of_truth_value",i[d],"current_value",o[d]),r=r||p.needs_save,a=a||p.unresolvable_conflict})),{needs_save:r,unresolvable_conflict:a,value:c}}}const SA=x.delay("merge knowledge view functions",()=>{const e=new Date("2021-01-01"),t=new Date("2021-02-02");function n(o,s=!0){if(!o&&s)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return o?o.getTime():void 0}const i=o=>({left:o,top:o});x("should handle adding entry on client",()=>{const o=We({wc_id_map:{},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(1)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(1)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(1)}),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])}),x("should handle adding entries on client and remote",()=>{const o=We({wc_id_map:{},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(1)},needs_save:!0,saving:!0},r={...o,wc_id_map:{2:i(3)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(1),2:i(3)}),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),x("should handle nonconflicting changing different entries on client and remote",()=>{const o=We({wc_id_map:{0:i(1),2:i(3)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(4),2:i(3)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(1),2:i(5)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(4),2:i(5)}),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),x("should handle conflict changing same entries on client and remote",()=>{const o=We({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(3)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(2)}),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,["wc_id_map"])}),x("should handle resolveable conflict changing same entries on client and remote",()=>{const o=We({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(2)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(2)}),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])}),x("should handle non and conflict changes and second client change",()=>{const o=We({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(4),1:i(10)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(2),1:i(10)}),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,["wc_id_map"])})});function bt(e){return vw({...e,get_custom_field_merger:AA})}function AA(e){}const $A=x.delay("merge_wcomponent",()=>{const e=new Date("2021-01-01"),t=new Date("2021-02-02");function n(i,o=!0){if(!i&&o)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return i?i.getTime():void 0}x("should handle update on client",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TB",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(a.value.title,"TB"),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])}),x("should handle nonconflicting updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TA",description:"DX",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TB"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),x("should handle conflicting updates",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TX",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TX"),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,["title"])}),x("should handle multiple updates on client",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TB",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(a.value.title,"TC"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),x("should handle nonconflicting updates with multiple client updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TA",description:"DX",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TC"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),x("should handle conflicting updates with multiple client updates",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TX",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TX"),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,["title"])}),x("should handle non and conflicting updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TB",description:"DB",needs_save:!0,saving:!0},s={...i,title:"TB",description:"DB"},r={...i,title:"TA",description:"DX",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TB"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,["description"])}),x("should handle non and conflicting updates with multiple client updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TC",description:"DC",needs_save:!0,saving:!0},s={...i,title:"TB",description:"DB"},r={...i,title:"TA",description:"DX",modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TC"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,["description"])}),x("should handle different custom created at",()=>{const i=q({base_id:-1,custom_created_at:new Date("2021"),modified_at:e}),o={...i,custom_created_at:new Date("2015"),needs_save:!0,saving:!0},s={...i,custom_created_at:new Date("2015")},r={...i,custom_created_at:new Date("2015"),modified_at:t},a=bt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(new Date("2021"),new Date("2021")),u(a.value.custom_created_at,new Date("2015")),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])})});function CA(e,t){return e.sync.last_source_of_truth_specialised_objects_by_id.wcomponents[t||""]}function jA(e,t){return e.sync.last_source_of_truth_specialised_objects_by_id.knowledge_views[t||""]}const me=e=>e!==void 0;function co(e){return e={...e},delete e.needs_save,delete e.saving,e}function eo(e){return{...e,created_at:new Date(e.created_at),custom_created_at:Gi(e.custom_created_at),modified_at:Gi(e.modified_at),datetime:TA(e.datetime)}}const Gi=e=>e===void 0?void 0:new Date(e);function TA(e){if(e)return{...e,value:Gi(e.value),min:Gi(e.min),max:Gi(e.max)}}function Al(e,t,n=!1){e=co(e);let i=e.wc_id_map;return n&&(i=PA(i)),e={...e,...eo(e),wc_id_map:i,sort_type:e.sort_type||"normal"},e=NA(e),e=EA(e),e}function PA(e){const t={...e};return Object.entries(t).forEach(([n,i])=>{i.passthrough&&delete t[n]}),t}function NA(e){const t=e.goal_ids||[];return{...e,goal_ids:t}}function EA(e){const{wc_id_map:t}=e,n={...t};return Object.values(n).forEach(i=>{i.deleted&&(delete i.deleted,i.blocked=!0)}),{...e,wc_id_map:n}}async function gw(e){const t=e.converter_app_to_supabase(e.item),n=await e.supabase.from(e.table).insert(t).eq("id",t.id).select(),o=(n.data||[]).map(e.converter_supabase_to_app).filter(me)[0];return{status:n.status,item:o,error:n.error||void 0}}const IA=1e3;async function ui(e){const t=e.offset||0,n=e.specific_ids?100:IA,i=t+n-1;let o=e.supabase.from(e.table).select().order("id",{ascending:!0});if(e.base_id!==void 0&&(o=o.eq("base_id",e.base_id)),e.specific_ids===void 0)o=o.range(t,i);else{const l=e.specific_ids.slice(t,i+1);o=o.in("id",l)}const s=await o;let r=s.error||void 0,a=(s.data||[]).map(l=>e.converter(l));const c=e.specific_ids&&t+n<e.specific_ids.length;if(!r&&(a.length===n||c)){const l=await ui({...e,offset:t+n});l.error?r=l.error:a=a.concat(l.value)}return{error:r,value:a}}function ww(e,t){if(t=e.base_id??t,t===void 0)throw new Error("Must provide base_id for app_item_to_supabase");const n=co(e);return delete n.base_id,{id:e.id,modified_at:e.modified_at?e.modified_at.toISOString():void 0,base_id:t,json:n,title:e.title}}function $l(e){let{json:t}=e;const{id:n,base_id:i,modified_at:o}=e,s=o?new Date(o+"Z"):void 0;return delete t.base_id,t={...t,id:n,base_id:i,modified_at:s},t}const bw="knowledge_views";function yw(e){return ui({...e,table:bw,converter:Cl,specific_ids:e.ids})}async function DA(e){const t=e.wcomponents_from_other_bases.filter(r=>so(r)),n=Array.from(new Set(t.map(r=>r.id))),i=new Set(e.knowledge_views.map(r=>r.id)),o=e.knowledge_views.map(r=>r.parent_knowledge_view_id).filter(me).filter(r=>!i.has(r));let s=n.concat(o);return e.knowledge_views.map(r=>r.foundation_knowledge_view_ids).forEach(r=>{r==null||r.filter(a=>!i.has(a)).forEach(a=>s.push(a))}),s=Array.from(new Set(s)),await yw({supabase:e.supabase,ids:s,all_bases:!0})}async function RA(e){return e.knowledge_view.modified_at?MA(e):OA(e)}async function OA(e){return gw({supabase:e.supabase,table:bw,item:e.knowledge_view,converter_app_to_supabase:kw,converter_supabase_to_app:Cl})}async function MA(e){const t=kw(e.knowledge_view),n=await e.supabase.rpc("update_knowledge_view",{item:t});if(n.status===401)return{status:n.status,error:{message:"JWT expired"},item:void 0};let i,o=n.error||void 0;try{let s=n.data;n.status===409&&(s=JSON.parse(n.error.details)),i=Cl(s)}catch(s){console.error("Exception whilst handling rpc update_knowledge_view response",s),o=s}return{status:n.status,error:o,item:i}}function kw(e,t){return ww(e,t)}function Cl(e){let t=$l(e);return t=Al(t),t}const qA={event:!0,statev2:!0,state_value:!0,sub_state:!0,multidimensional_state:!0,process:!0,action:!0,actor:!0,causal_link:!0,relation_link:!0,judgement:!0,objective:!0,counterfactualv2:!0,goal:!0},jl=Object.keys(qA).sort().filter(e=>e!=="multidimensional_state"),VA=new Set(jl);function Tl(e){if(e=co(e),e=FA(e),e=zA(e),e=LA(e),e={...eo(e)},wi(e)&&(e.validity=e.validity.map(BA)),On(e)){const t=e.values_and_prediction_sets;e.values_and_prediction_sets=t&&t.map(UA)}return hl(e)&&(e.event_at=e.event_at.map(eo)),ye(e)&&(e.from_type=Cu(e.from_type),e.to_type=Cu(e.to_type),e.from_type=ju(e.from_type),e.to_type=ju(e.to_type)),e}function Cu(e){return e==="meta-effector"||e==="meta-effected"?"meta":e==="effector"||e==="effected"?"state":e||"state"}function ju(e){return e==="value"?"state":e||"state"}function FA(e){return!Oh(e)||!e.is_action?e:{...e,is_action:void 0,type:"action"}}function zA(e){if(et(e)){const t=e.depends_on_action_ids||[];e={...e,depends_on_action_ids:t}}return e}function LA(e){if(Rn(e)){const t=e.objective_ids||[];e={...e,objective_ids:t}}return e}const BA=e=>eo(e),UA=e=>eo(e),Pl="wcomponents";async function WA(e){const t=await ui({...e,table:Pl,converter:lo,specific_ids:e.ids}),n=t.value.filter(me);return{error:t.error,wcomponents:n}}async function xw(e){const t=await ui({supabase:e.supabase,all_bases:!0,base_id:void 0,specific_ids:e.ids,table:Pl,converter:lo}),n=t.value.filter(me);return{error:t.error,wcomponents:n}}async function HA(e){const t=new Set(e.wcomponents.map(s=>s.id)),n=new Set;function i(s,r){s.forEach(a=>{if(!en(a)){console.trace(`Found invalid UUID "${a}".  Source of ids: "${r}"`);return}t.has(a)||n.add(a)})}e.knowledge_views.forEach(s=>{i(Object.keys(s.wc_id_map),`wc_id_map of knowledge view "${s.id}"`)}),e.wcomponents.forEach(s=>{const r=`wcomponent "${s.id}"`;i(s.label_ids||[],r);let a=bn(s.title);i(a,r),a=bn(s.description),i(a,r),et(s)&&i(s.parent_goal_or_action_ids||[],r)});const o=Array.from(n);return await xw({supabase:e.supabase,ids:o})}async function GA(e){return e.wcomponent.modified_at?YA(e):KA(e)}async function KA(e){return await gw({supabase:e.supabase,table:Pl,item:e.wcomponent,converter_app_to_supabase:Nl,converter_supabase_to_app:lo})}async function YA(e){const t=Nl(e.wcomponent),n=await e.supabase.rpc("update_wcomponent",{item:t});if(n.status===401)return{status:n.status,error:{message:"JWT expired"},item:void 0};let i,o=n.error||void 0;try{let s=n.data;n.status===409&&(s=JSON.parse(n.error.details)),i=lo(s)}catch(s){console.error("Exception whilst handling rpc update_wcomponent response",s),o=s}return{status:n.status,error:o,item:i}}function Nl(e,t){return{...ww(e,t),type:e.type,attribute_id:gt(e)?e.attribute_wcomponent_id:void 0}}function lo(e){let t=$l(e);if(JA(t))return t=Tl(t),t}function JA(e){if(VA.has(e.type))return e;console.warn(`Unsupported wcomponent type "${e.type}", id "${e.id}", title: "${e.title}".  This wcomponent will not be used.`)}function Sw(e){if(e){if("type"in e&&typeof e.type=="string")return e.type+": "+(e.message||"<no message>");if(`${e}`.includes("[object"))return JSON.stringify(e)}return`${e}`}let Ei=0;async function Aw(e,t=!1){const n=e.getState();if(!n.sync.ready_for_writing){const s=new Error(`Inconsistent state violation.  Save state called whilst state.sync.status: "${n.sync.specialised_objects.status}", ready_for_writing: ${n.sync.ready_for_writing}`);return on.error(s),Promise.reject(s)}const i=fA(n);if(!i){const{wcomponent_ids:s,knowledge_view_ids:r}=n.sync.specialised_object_ids_pending_save,a=JSON.stringify(Array.from(s)),c=JSON.stringify(Array.from(r));if(e.dispatch(S.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})),t)return console.log(`No ids need to be saved: "${a}", "${c}"`),Promise.resolve();const l=new Error(`Inconsistent state violation.  No ids need to be saved: "${a}", "${c}"`);return on.error(l),Promise.reject(l)}e.dispatch(S.sync.update_sync_status({status:"SAVING",data_type:"specialised_objects"}));let o;i.object_type==="knowledge_view"?o=XA(i.id,e):o=ZA(i.id,e);try{Ei+=1,await o&&(Ei=0),Ei<10?e.dispatch(S.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})):e.dispatch(S.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:"Try manually saving or refresh the page.  Failing that contact the team.",attempt:Ei}))}catch(s){on.error(`Got error saving ${i.object_type} ${i.id}.  Error: ${s instanceof Error?s.message:s}`),e.dispatch(S.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:`${s}`,attempt:Ei}))}return Promise.resolve()}async function XA(e,t){const n="knowledge_view",i=di(t.getState(),e),o=$w(e,t,n,i);if(o.error)return o.error;const s=o.initial_item,r=Ce(),a=await RA({supabase:r,knowledge_view:s}),c=Cw(e,t,n,a);if(c.error)return c.error;const{create_successful:l,update_successful:d,latest_source_of_truth_value:p}=c,f=jA(t.getState(),e),m=di(t.getState(),e);t.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:p,is_source_of_truth:!0}));const v=jw({object_type:n,initial_item:s,last_source_of_truth_value:f,current_value:m});if(v.error)return v.error;if(v.merge_args){const h=mn({...v.merge_args,source_of_truth_value:p,update_successful:d});h.needs_save&&t.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:{...h.value},is_source_of_truth:!1})),h.unresolvable_conflicted_fields.length}return Promise.resolve(l||d)}async function ZA(e,t){const n="wcomponent",i=pe(t.getState(),e),o=$w(e,t,n,i);if(o.error)return o.error;const s=o.initial_item,r=Ce(),a=await GA({supabase:r,wcomponent:s}),c=Cw(e,t,n,a);if(c.error)return c.error;const{create_successful:l,update_successful:d,latest_source_of_truth_value:p}=c,f=CA(t.getState(),e),m=pe(t.getState(),e);t.dispatch(S.specialised_object.upsert_wcomponent({wcomponent:p,is_source_of_truth:!0}));const v=jw({object_type:n,initial_item:s,last_source_of_truth_value:f,current_value:m});if(v.error)return v.error;if(v.merge_args){const h=bt({...v.merge_args,source_of_truth_value:p,update_successful:d});h.needs_save&&t.dispatch(S.specialised_object.upsert_wcomponent({wcomponent:{...h.value},is_source_of_truth:!1})),h.unresolvable_conflicted_fields.length}return Promise.resolve(l||d)}function $w(e,t,n,i){return i?(t.dispatch(S.sync.update_specialised_object_sync_info({id:i.id,object_type:n,saving:!0})),{error:void 0,initial_item:i}):(t.dispatch(S.sync.debug_refresh_all_specialised_object_ids_pending_save()),{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${n}" but no item for id: "${e}".  Updating all specialised_object_ids_pending_save.`)),initial_item:void 0})}function Cw(e,t,n,i){const o=i.status===201,s=i.status===200;if(!o&&!s&&i.status!==409){const a=Sw(i.error);return{error:Promise.reject(new Error(`save_"${n}" got "${i.status}" error: "${a}"`)),create_successful:o,update_successful:s,latest_source_of_truth_value:void 0}}const r=i.item;return r?{error:void 0,create_successful:o,update_successful:s,latest_source_of_truth_value:r}:{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${n}" got "${i.status}" but no latest_source_of_truth_value item.  Error: "${JSON.stringify(i.error)}".`)),create_successful:o,update_successful:s,latest_source_of_truth_value:r}}function jw(e){const{object_type:t,initial_item:n,last_source_of_truth_value:i,current_value:o}=e;return i?o?{error:void 0,merge_args:{last_source_of_truth_value:i,current_value:o}}:{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${t}" found "${t}" last_source_of_truth_value but no current_value for id "${n.id}".`)),merge_args:void 0}:n.modified_at?{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${t}" found no last_source_of_truth_value "${t}" for id: "${n.id}" but "${t}" had a modified_at already set`)),merge_args:void 0}:{error:void 0,merge_args:void 0}}async function Tw(e){if(!QA(e,!0))return Promise.resolve();await Aw(e)}function QA(e,t){if(!e.load_state_from_storage)return!1;const n=e.getState(),{ready_for_writing:i,specialised_objects:o}=n.sync;return!(!i||t&&o.status==="FAILED"||t&&!pw(n))}async function Pw(e){const t=Ae(),n=Ce();try{await Tw(t)}catch(i){on.debug(`Error saving state before signout ${i}`)}try{if(e){on.debug("Signing out with supabase.auth.signOut()");const{error:i}=await n.auth.signOut();localStorage.clear()}}catch(i){on.debug(`Error signing out ${i}`)}window.location.reload()}const Nw=[];function e3(){window.addEventListener("focus",function(){Nw.forEach(e=>e())},!1)}function t3(e){Nw.push(e)}let Tu=!1;function n3(e){if(Tu){console.error("Already run register_window_focus_session_check");return}Tu=!0,t3(()=>{Ew(e)})}async function Ew(e){if(!e.load_state_from_storage)return;const t=Ce(),n=await i3(e,t);o3(n,e)}async function i3(e,t){var n,i,o;if(!e.getState().user_info.user)return console.log("User not signed in once yet."),0;try{console.log("On window focus event, checking connection and session with supabase.auth.getSession()");const s=await t.auth.getSession();if(((n=s.error)==null?void 0:n.message)==="Not logged in."||((i=s.error)==null?void 0:i.status)===401)return 1;if(((o=s.error)==null?void 0:o.message)==="Network request failed")return console.log("Network error"),2;if(s.error){debugger;return console.log("Unexpected error whilst check_connection_and_session",s.error),3}else return 4}catch(s){return console.error("Unexpected exception whilst check_connection_and_session",s),3}}function o3(e,t){if(e===0)return;if(e===1){on.info("User not logged in.  Reloading page."),window.location.reload();return}else if(e===3){Pw(!1);return}let n=!0;switch(e){case 2:n=!1;break}t.dispatch(S.sync.update_network_status({network_functional:n,last_checked:new Date}))}function s3(e){let t="";e.subscribe(()=>{const n=e.getState(),i=Be(n);if(i&&i.title!==t){t=i.title;const o=(t?t+" | ":"")+O1.NAME;gh(o)}})}function r3(e){_3(e)}function _3(e){e.subscribe(()=>{const t=e.getState();t.routing.route,a3(t)&&e.dispatch(S.controls.set_or_toggle_display_side_panel(!0))})}function a3(e){return e.last_action?!e.controls.display_side_panel&&ug(e.last_action)&&e.last_action.route!==void 0&&(e.last_action.route==="search"||e.last_action.route==="filter"):!1}function Yc(e,t){let n;const i=()=>{n&&(clearTimeout(n),n=void 0)};let o;return{throttled:(...a)=>{i(),o=a,n=setTimeout(()=>{e(...a),o=void 0},t)},cancel:i,flush:()=>{i(),o&&(e(...o),o=void 0)}}}function Iw(e,t){let n;const i=()=>{n&&(clearTimeout(n),n=void 0)};let o={args:void 0},s;const r=(...l)=>(o.args=l,n||(n=setTimeout(()=>{e(...o.args),o.args=void 0,n=void 0},t),s=performance.now()+t),s);let a;return{throttled:r,cancel:i,flush:()=>(a||(a=new Promise(l=>{setTimeout(()=>{if(i(),a=void 0,o.args){const d=o.args;o.args=void 0,l(e(...d))}l(void 0)},0)})),a)}}function El(e={}){const t={};function n(s,r){const a=e[s];if(a){const d=a(r);if(!d.continue)return;r=d.message}const c=t[s];(c===void 0?[]:c).forEach(d=>{setTimeout(()=>d(r),0)})}function i(s,r){const a=t[s],c=a===void 0?[]:a;return c.push(r),t[s]=c,o(s,r)}function o(s,r){return()=>{const a=t[s],l=(a===void 0?[]:a).filter(d=>d!==r);t[s]=l}}return{pub:n,sub:i}}const Il=El({canvas_node_drag_relative_position:c3});let dn;function c3(e){const t=(dn==null?void 0:dn.left)!==e.left||(dn==null?void 0:dn.top)!==e.top;return dn=e,{continue:t,message:e}}function l3(e){Il.pub("throttled_canvas_node_drag_relative_position",e)}const d3=Iw(l3,30);Il.sub("canvas_node_drag_relative_position",d3.throttled);const u3=El(),p3=El(),G={canvas:Il,global_keys:u3,user:p3};function m3(e,t){t.ctrl_key&&t.key==="f"&&(t.event.preventDefault(),e.dispatch(S.routing.change_route({route:"search"})))}const Dl=uo(e=>Object.keys(e.composed_visible_wc_id_map)),Dw=uo((e,t)=>{const n=[...t],i=new Set(n),{wc_id_connections_map:o,composed_visible_wc_id_map:s}=e;return t.forEach(r=>{const a=o[r];a&&a.forEach(c=>{i.has(c)||s[r]&&(n.push(c),i.add(c))})}),n}),Rw=uo((e,t,n)=>{const i=new Set(t),o=new Set,{wc_id_connections_map:s,composed_visible_wc_id_map:r,wc_ids_by_type:a}=e;return t.forEach(c=>{const l=s[c];if(!l)o.add(c);else{const d=Array.from(l).filter(p=>r[p]).filter(p=>i.has(p));if(d.length<=1)o.add(c);else if(a.any_node.has(c)){let p;Array.from(d).map(m=>n[m]).filter(ye).find(m=>{const v=m.from_id===c;if(p===void 0)p=v;else if(p!==v)return!0;return!1})||o.add(c)}}}),t.filter(c=>!o.has(c))}),Ow=qw("forward"),Mw=qw("source");function qw(e){const t=e==="forward";return uo((n,i,o)=>{const s=[...i],r=new Set(s);function a(d){r.has(d)||(r.add(d),s.push(d))}const{wc_id_connections_map:c,composed_visible_wc_id_map:l}=n;return i.forEach(d=>{const p=c[d];if(!p)return;Array.from(p).concat([d]).filter(m=>l[m]).map(m=>o[m]).filter(an).filter(m=>(t?m.from_id:m.to_id)===d||m.id===d).forEach(({id:m,from_id:v,to_id:h})=>{a(m),a(t?h:v)})}),s})}const Vw=uo((e,t)=>{const n=new Set(t),i=[...t],o=new Set(i),{wc_id_connections_map:s,composed_visible_wc_id_map:r}=e;function a(c){return!r[c]}return t.forEach(c=>{if(a(c))return;const l=s[c];l&&l.forEach(d=>{if(a(d))return;const p=s[d];p&&p.forEach(f=>{f!==c&&n.has(f)&&(a(f)||o.has(d)||(i.push(d),o.add(d)))})})}),i});function uo(e){return t=>{const n=t.getState(),i=_e(n);if(!i||!(n.routing.args.view==="knowledge"))return;const s=n.meta_wcomponents.selected_wcomponent_ids_list,{wcomponents_by_id:r}=n.specialised_objects,a=e(i,s,r);t.dispatch(S.meta_wcomponents.set_selected_wcomponents({ids:a})),t.dispatch(S.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))}}function f3(e){h3(e)}function v3(e,t){t.key==="a"&&t.ctrl_key&&(t.event.preventDefault(),Dl(e))}function h3(e){G.canvas.sub("canvas_area_select",t=>{const n=e.getState(),i=_e(n);if(!i||!(n.routing.args.view==="knowledge"))return;const{start_x:s,start_y:r,end_x:a,end_y:c}=t,l=-r,d=-c,p=Object.entries(i.composed_visible_wc_id_map).filter(([v,h])=>h.left>=s&&h.left<=a&&h.top<=l&&h.top>=d).map(([v])=>v).filter(v=>!i.wc_ids_by_type.any_link.has(v)),f=n.global_keys.keys_down.has("Control"),m=g3(f,n,p);e.dispatch(S.meta_wcomponents.set_selected_wcomponents({ids:m})),e.dispatch(S.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))})}function g3(e,t,n){let i=[];if(e){const o=new Set(t.meta_wcomponents.selected_wcomponent_ids_set);n.forEach(s=>o.delete(s)),i=Array.from(o)}else{const o=t.meta_wcomponents.selected_wcomponent_ids_list,s=new Set(o),r=n.filter(a=>!s.has(a));i=o.concat(r)}return i}function w3(e){b3(e)}function b3(e){let t="";G.global_keys.sub("key_down",n=>{if(t){y3(t,n,e);return}const i=n.ctrl_key&&k3.has(n.key);if(t=i?t=n.key:"",i){n.event.preventDefault();return}n.ctrl_key&&n.key==="e"?(n.event.preventDefault(),e.dispatch(S.display.toggle_consumption_formatting())):n.shift_key&&n.key==="?"?(n.event.preventDefault(),e.getState().display_options.show_help_menu||e.dispatch(S.display.set_show_help_menu({show:!0}))):(v3(e,n),m3(e,n))}),G.global_keys.sub("key_up",n=>{n.key==="Control"&&(t="")})}function y3(e,t,n){let i=!1;e==="d"?i=x3(t.key,n):e==="s"&&(i=S3(t.key,n)),i&&t.event.preventDefault()}const k3=new Set(["d","s"]);function x3(e,t){let n=!0;return e==="f"?t.dispatch(S.display.set_or_toggle_focused_mode()):e==="t"?t.dispatch(S.controls.toggle_display_time_sliders()):e==="s"?t.dispatch(S.controls.set_or_toggle_display_side_panel()):e==="a"?t.dispatch(S.display.set_or_toggle_animate_connections()):e==="c"?t.dispatch(S.display.set_or_toggle_circular_links()):n=!1,n}function S3(e,t){let n=!0;return e==="a"?Dl(t):e==="e"?Dw(t):e==="d"?Rw(t):e==="f"?Ow(t):e==="c"?Mw(t):e==="i"?Vw(t):n=!1,n}function A3(e){document.onkeydown=t=>{const n={event:t,time_stamp:t.timeStamp,alt_key:t.altKey,code:t.code,ctrl_key:t.ctrlKey,key:t.key,meta_key:t.metaKey,shift_key:t.shiftKey};e.dispatch(S.global_keys.key_down(n)),G.global_keys.pub("key_down",n)},document.onkeyup=t=>{const n={event:t,time_stamp:t.timeStamp,alt_key:t.altKey,code:t.code,ctrl_key:t.ctrlKey,key:t.key,meta_key:t.metaKey,shift_key:t.shiftKey};e.dispatch(S.global_keys.key_up(n)),G.global_keys.pub("key_up",n)},window.onfocus=()=>{e.getState().global_keys.keys_down.size!==0&&e.dispatch(S.global_keys.clear_all_keys())}}function yi(e,t){const n={};return e.forEach(i=>{n[i]=t[i]}),n}function $3(e){const t=yi(["display_time_sliders","display_side_panel"],e.controls);En("controls",t)}function C3(e){const t=Nn("controls");return{linked_datetime_sliders:!1,display_time_sliders:!1,display_side_panel:!0,display_select_storage:e.storage_location===void 0,...t}}function Fw(e){return{only_certain_valid:e==="only_certain_valid",only_maybe_valid:e==="only_maybe_valid",maybe_invalid:e==="maybe_invalid",show_invalid:e==="show_invalid"}}function zw(e){return{render_certainty_as_opacity:e==="render_certainty_as_opacity",render_certainty_as_easier_opacity:e==="render_certainty_as_easier_opacity",render_100_opacity:e==="render_100_opacity"}}function j3(e){const t=yi(["consumption_formatting","time_resolution","display_by_simulated_time","display_time_marks","animate_connections","circular_links","show_large_grid","validity_filter","certainty_formatting"],e.display_options);En("display_options",t)}function T3(){const e=Nn("display_options"),t=e.validity_filter||"show_invalid",n=e.certainty_formatting||"render_certainty_as_opacity",i=Fw(t),o=zw(n);return{consumption_formatting:!0,focused_mode:!1,time_resolution:"minute",display_by_simulated_time:!1,display_time_marks:!1,animate_connections:!1,circular_links:!0,show_help_menu:!1,show_large_grid:!1,validity_filter:t,certainty_formatting:n,derived_validity_filter:i,derived_certainty_formatting:o,...e}}const Pu=()=>{const e=Nn("experimental_features");return{enable_angular_connections:e.enable_angular_connections??!1,enable_action_kanban_view:e.enable_action_kanban_view??!1}},Ki={get_state:Pu,set_state_and_reload_page:e=>{const n={...Pu(),...e};En("experimental_features",n),document.location.reload()}};function P3(e){const t=yi(["apply_filter","filters"],e.filter_context);En("filter_context",t)}function N3(){const e=Nn("filter_context");e.filters instanceof Array&&delete e.filters;const{apply_filter:t=!1,filters:n={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""}}=e;return{apply_filter:t,filters:n}}function E3(e){const t=yi(["search_fields","search_type"],e.search);En("search",t)}function I3(){return{search_fields:"all",search_type:"best",...Nn("search")}}function D3(e){const t=yi([],e.sync);En("sync",t)}function R3(){const e=Nn("sync"),t={status:void 0,error_message:"",retry_attempt:void 0,loading_base_id:void 0};return{last_source_of_truth_specialised_objects_by_id:{wcomponents:{},knowledge_views:{}},specialised_object_ids_pending_save:{wcomponent_ids:new Set,knowledge_view_ids:new Set},specialised_objects_save_conflicts:{wcomponent_conflicts_by_id:{},knowledge_view_conflicts_by_id:{}},ready_for_reading:!1,ready_for_writing:!1,network_functional:!0,network_function_last_checked:void 0,wcomponent_ids_to_search_for_in_any_base:new Set,wcomponent_ids_searching_for_in_any_base:new Set,wcomponent_ids_searched_for_in_any_base:new Set,bases:{...t},specialised_objects:{...t},...e}}const O3={wcomponents_by_id:{},knowledge_views_by_id:{}},M3=void 0,{wcomponents_by_id:q3,knowledge_views_by_id:V3}=O3,F3=Object.values(q3).map(Tl),z3=Object.values(V3).map(e=>Al(e)),L3={wcomponents:F3,knowledge_views:z3};function B3(e){const t=yi(["has_signed_in_at_least_once","chosen_base_id"],e.user_info);En("user_info",t)}function U3(e){const t=Nn("user_info"),i=(a=>document.location.hash.includes(a))("type=recovery"),o=e.storage_location!==void 0?e.storage_location:t.chosen_base_id;return{has_signed_in_at_least_once:!1,user:M3,need_to_handle_password_recovery:i,users_by_id:void 0,bases_by_id:void 0,...t,chosen_base_id:o}}function W3(e){$3(e),j3(e),P3(e),E3(e),D3(e),B3(e)}const H3=(e,t)=>{if(b2(t)){const n=!e.controls.linked_datetime_sliders;e=O(e,"controls","linked_datetime_sliders",n)}if(k2(t)){const{display_time_sliders:n}=t;e=O(e,"controls","display_time_sliders",n)}if(S2(t)){const{display_time_sliders:n}=e.controls;e=O(e,"controls","display_time_sliders",!n)}if($2(t)){const{display_side_panel:n}=e.controls,i=t.display_side_panel??!n;e=O(e,"controls","display_side_panel",i)}if(j2(t)){const{display_select_storage:n}=e.controls,i=t.display_select_storage??!n;e=O(e,"controls","display_select_storage",i)}return e};function G3({probability:e,conviction:t}){return e>0&&e<1||t!==1}function Lw({probability:e,conviction:t}){return Math.min(e,t)}var J=(e=>(e[e.past=0]="past",e[e.present=1]="present",e[e.future=2]="future",e[e.eternal=3]="eternal",e))(J||{});function ge(e,t){const{min:n,value:i,max:o}=e.datetime||{},[s,r]=n===void 0?[!1,0]:[!0,n.getTime()],[a,c]=i===void 0?[!1,0]:[!0,i.getTime()],[l,d]=o===void 0?[!1,0]:[!0,o.getTime()];if(s){if(r>t)return J.future;if(r===t||!l&&r<t)return J.present}if(l)return d<=t?J.past:J.present;if(a){if(c<t)return J.past;if(c===t)return J.present;if(c>t)return J.future}return J.eternal}const K3=x.delay("get_tense_of_uncertain_datetime",()=>{let e;const n=new Date("2021-04-01 00:01").getTime(),i=new Date("2021-04-01 00:02"),o=i.getTime(),s=new Date("2021-04-01 00:03"),r=s.getTime(),a=new Date("2021-04-01 00:04"),c=a.getTime(),d=new Date("2021-04-01 00:05").getTime();e=ge({datetime:{}},n),u(e,J.eternal),e=ge({datetime:{min:i}},n),u(e,J.future),e=ge({datetime:{min:i}},o),u(e,J.present),e=ge({datetime:{min:i}},r),u(e,J.present),e=ge({datetime:{value:i}},n),u(e,J.future),e=ge({datetime:{value:i}},o),u(e,J.present),e=ge({datetime:{value:i}},r),u(e,J.past),e=ge({datetime:{max:i}},n),u(e,J.present),e=ge({datetime:{max:i}},o),u(e,J.past),e=ge({datetime:{max:i}},r),u(e,J.past),e=ge({datetime:{min:i,max:s}},n),u(e,J.future),e=ge({datetime:{min:i,max:s}},o),u(e,J.present),e=ge({datetime:{min:i,max:s}},r),u(e,J.past),e=ge({datetime:{min:i,max:s}},c),u(e,J.past),e=ge({datetime:{min:i,value:s,max:a}},n),u(e,J.future),e=ge({datetime:{min:i,value:s,max:a}},o),u(e,J.present),e=ge({datetime:{min:i,value:s,max:a}},r),u(e,J.present),e=ge({datetime:{min:i,value:s,max:a}},c),u(e,J.past),e=ge({datetime:{min:i,value:s,max:a}},d),u(e,J.past)});function Y3(e){const{items:t,sim_ms:n}=e,i=ps(t);return Bw({sorted_items:i,sim_ms:n})}function ps(e,t=ve.descending){return be(e,({datetime:i})=>{if(jg(i))return Number.NEGATIVE_INFINITY;const{max:o,value:s,min:r}=i;return r?r.getTime()*10+2:s?s.getTime()*10+1:o?o.getTime()*10:1},t)}function Bw(e){const{sorted_items:t,sim_ms:n}=e;let i=[],o=[],s=[];const r=[];t.forEach(c=>{const l=ge(c,n);l===J.past?i.push(c):l===J.future?r.push(c):l===J.present?o.push(c):s.push(c)}),o.length!==1&&(o.length>1?(i=o.slice(1).concat(i),o=o.slice(0,1)):i.length&&(o=i.slice(0,1),i=i.slice(1))),s.length&&(o.length!==1&&(o=s.slice(0,1),s=s.slice(1)),i=i.concat(s));const a=o[0];return{past_items:i,present_item:a,future_items:r}}const J3=x.delay("partition_sorted_items_by_datetimes",()=>{function e(p){var m;const f=Bw(p);return{past_items:f.past_items.map(({id:v})=>v),present_item:(m=f.present_item)==null?void 0:m.id,future_items:f.future_items.map(({id:v})=>v)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime();t=[],n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:[],present_item:void 0,future_items:[]}),t=[{id:"10",datetime:{}},{id:"11",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:["11"],present_item:"10",future_items:[]},"Can handle multiple eternal elements"),t=[{id:"30",datetime:{value:a}},{id:"20",datetime:{value:s}},{id:"10",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:"10",future_items:["30","20"]},"Should partition eternal item as present if other items are in the future"),n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:["10"],present_item:"20",future_items:["30"]},"Should partition eternal item as past if other items are in the present"),n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]},"Should partition eternal item and other past items as past if other items are in the present"),n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]}),t=[{id:"40",datetime:{min:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"40",future_items:[]},"Should find min datetime as present when sim_ms is equal to min datetime"),n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:void 0,future_items:["40"]},"Should find min datetime as future when sim_ms is before min datetime"),t=[{id:"50",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"50",future_items:[]},"Should find max datetime as present when sim_ms is equal to max datetime"),t=[{id:"50",datetime:{max:s}},{id:"60",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["60"],present_item:"50",future_items:[]},"Should find max datetime as past when sim_ms is later than max datetime but when no other item is present, will use one as present item")}),X3=x.delay("sort_by_uncertain_event_datetimes",()=>{function e(C){return ps(C).map(({id:A})=>A)}function t(C,N){const A=[...C].reverse(),R=N.map(({id:T})=>T);i=e(C);const M=e(A);u(i,M,"",!1),u(i,R,"",!1)}let n=[],i,o;const s=new Date("2021-04-01 00:00"),r=new Date("2021-04-01 00:01"),a=new Date("2021-04-01 00:02"),c=new Date("2021-04-01 00:03");let l=0;const d=()=>`${l++}`,p={id:d(),datetime:{}},f={id:d(),datetime:{}},m={id:d(),datetime:{value:r}},v={id:d(),datetime:{value:a}},h={id:d(),datetime:{max:r}},w={id:d(),datetime:{max:a}},b={id:d(),datetime:{min:r}},g={id:d(),datetime:{min:a}},k={id:d(),datetime:{min:s,max:c}},y={id:d(),datetime:{min:r,max:a}};n=[],i=e(n),u(i,[],"",!1),n=[p,f];const $=[...n].reverse();i=e(n);const j=e($);u(JSON.stringify(i)!==JSON.stringify(j),!0,"Should be different (indeterminant sort)"),n=[p,m,v],o=[v,m,p],t(n,o),n=[p,b,g],o=[g,b,p],t(n,o),n=[p,h,w],o=[w,h,p],t(n,o),n=[p,m,v,b,g,h,w],o=[g,v,w,b,m,h,p],t(n,o),n=[p,k,y],o=[y,k,p],t(n,o)});function xn(e){const{invalid_future_items:t,current_items:n}=_o(e),{latest:i,previous_versions_by_id:o}=ls(n),s=Y3({items:i,sim_ms:e.sim_ms});return{invalid_future_items:t,...s,previous_versions_by_id:o}}function Z3(e,t){const n=Uw(e,t);return ps(n)}function Uw(e,t){const{current_items:n}=_o({items:e,created_at_ms:t}),{latest:i}=ls(n);return i}const Q3=x.delay("partition_and_prune_items_by_datetimes_and_versions",()=>{const e=new Date("2021-04-01 00:00"),t=new Date("2021-04-01 00:01"),n=new Date("2021-04-01 00:02");function i(s){return s.map((r,a)=>({base_id:-1,id:`vps${a}`,created_at:t,version:1,datetime:{},entries:[],...r}))}let o=i([{datetime:{value:e},id:"vap_set_0"},{datetime:{value:t},id:"vap_set_1"},{datetime:{value:n},id:"vap_set_2"}]);x("all items created in future",()=>{const s=xn({items:o,created_at_ms:e.getTime(),sim_ms:t.getTime()});u(s.invalid_future_items,o,"should have all invalid future items"),u(s.past_items,[],"should have no past items"),u(s.present_item,void 0,"should have no present item"),u(s.future_items,[],"should have no future items"),u(s.previous_versions_by_id,{},"should have empty map of previous versions")}),x("all items created in past, sim_ms in middle",()=>{const s=xn({items:o,created_at_ms:t.getTime(),sim_ms:t.getTime()});u(s.invalid_future_items,[],"should have no invalid future items"),u(s.past_items,[o[0]],"vap_set_0 should be the one past item"),u(s.present_item,o[1],"vap_set_1 should be the one present item"),u(s.future_items,[o[2]],"vap_set_2 should be the one future item"),u(s.previous_versions_by_id,{vap_set_0:[],vap_set_1:[],vap_set_2:[]},"vap sets should have no previous versions")})}),Rl=()=>({is_valid:!0,certainty:1});function Ol(e){const{wcomponent:t,created_at_ms:n,sim_ms:i}=e;if(!wi(t))return;const o=xn({items:t.validity,created_at_ms:n,sim_ms:i}).present_item;if(!o)return;const s=o.probability>.5,r=Lw(o);return{is_valid:s,certainty:r}}function Ww(e){const{wcomponents_by_id:t,created_at_ms:n}=e,i={...t};return Object.keys(e.composed_visible_wc_id_map||{}).forEach(o=>{const s=t[o];if(s&&gt(s)){const r=t[s.attribute_wcomponent_id||""];if(!Qe(r))return;let a;s.values_and_prediction_sets&&(a=_o({items:s.values_and_prediction_sets,created_at_ms:n}).current_items,a=be(a,ze,ve.descending));const c={...r,values_and_prediction_sets:a,value_possibilities:s.value_possibilities,_derived__using_value_from_wcomponent_id:s.id};i[c.id]=c}}),i}function e$(e,t){var c,l;const n=e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id,i=(c=e.derived.current_composed_knowledge_view)==null?void 0:c.composed_visible_wc_id_map,o=(l=t.derived.current_composed_knowledge_view)==null?void 0:l.composed_visible_wc_id_map;if(!(n||i!==o))return t;const a=t$(t);return t=O(t,"derived","composed_wcomponents_by_id",a),t}function t$(e){const{wcomponents_by_id:t}=e.specialised_objects,{composed_visible_wc_id_map:n}=e.derived.current_composed_knowledge_view||{},{created_at_ms:i}=e.routing.args;return Ww({composed_visible_wc_id_map:n,wcomponents_by_id:t,created_at_ms:i})}function n$(e,t){return e.has(t)||(e=new Set(e),e.add(t)),e}function i$(e,t){return e.has(t)&&(e=new Set(e),e.delete(t)),e}function xt(...e){let t=[];return e.forEach(n=>t=t.concat(Array.from(n))),new Set(t)}function o$(e,t){const n=new Set(e);return t.forEach(i=>n.delete(i)),n.size===e.size?e:n}function Hw(){return{event:new Set,statev2:new Set,state_value:new Set,sub_state:new Set,multidimensional_state:new Set,process:new Set,action:new Set,actor:new Set,causal_link:new Set,relation_link:new Set,judgement:new Set,objective:new Set,counterfactualv2:new Set,goal:new Set,judgement_or_objective:new Set,goal_or_action:new Set,has_objectives:new Set,any_link:new Set,any_node:new Set,any_state_VAPs:new Set,has_single_datetime:new Set}}function Gw(e,t){const n=Hw(),i=new Set;return t.forEach(o=>{const s=e[o];if(!s){console.warn(`Could not find wcomponent by id: ${o}.  Wrong ID or in another base?`);return}gl(s)||(n[s.type].add(o),bi(s)&&Ig(s)&&i.add(s.id))}),n.judgement_or_objective=xt(n.judgement,n.objective),n.goal_or_action=xt(n.goal,n.action),n.has_objectives=xt(n.action,n.goal),n.any_link=xt(n.causal_link,n.relation_link),n.any_node=o$(new Set(t),n.any_link),n.any_state_VAPs=xt(n.statev2,n.causal_link,n.action),n.has_single_datetime=xt(n.event,n.sub_state,i),n}const st=20,pi=st*18,Sn=st*8;function to(e,t){return Math.round(e/t)*t}function zt(e){return to(e,st)}function Kw(e){return{left:e.x,top:-e.y}}function ms(e,t="small"){return t==="small"?{left:zt(e.left),top:zt(e.top)}:{left:to(e.left,pi),top:to(e.top,Sn)}}const Ee=250,Yw=(e=!1)=>e?120:59,mi=Ee/2,Jw=e=>Yw(e)/2;function s$(e){return{left:e.left-mi,top:e.top-Jw(!1)}}function r$(e,t){const n=e.s??1,i=e.left+n*mi,o=e.top+n*Jw(t);return{left:i,top:o}}function _$(e,t){return!e||!t?Number.POSITIVE_INFINITY:(e.left-t.left)**2+(e.top-t.top)**2}const Yi={time_origin_x:0,time_scale:1,time_line_number:4,time_line_spacing_days:30};function a$(e){const t=e.time_origin_ms??new Date().getTime(),n=e.time_origin_x??0,i=e.time_scale??1;return{time_origin_ms:t,time_origin_x:n,time_scale:i}}function Ml(e){const t=iS(e.wcomponent_id,e.wcomponents_by_id,e.created_at_ms);if(!t)return;const n=c$({datetime:t,...e});return zt(n)}function c$(e){const t=e.datetime.getTime()-e.time_origin_ms,n=e.time_scale/wh;return t*n+e.time_origin_x}function Xw(e){return`${e.left},${e.top}`}function Zw(e,t){const n={};return Object.entries(e).forEach(([i,o])=>{if(ye(t[i]))return;const s=ms(o,"large"),r=Xw(s),a=n[r]||[];a.push(i),n[r]=a}),n}const l$=/(.*?)(?:\[([^\]]*)\]\([^\)]*\))/g,d$=/(.*?)(\<[^\>]*\>)/g;function tn(e){return e=e.replaceAll(" <auto generated>",""),e=e.replaceAll(l$,"$1$2"),e=e.replaceAll(d$,"$1"),e}function u$(e){const t=new Set,n=new Set;e.forEach(o=>{o.label_ids&&o.label_ids.forEach(s=>t.add(s)),n.add(o.type)});const i=Array.from(n).sort();return{wc_label_ids:t,wc_types:i}}function Rt(e,t){const{id:n,label_ids:i=[],type:o}=e,{exclude_by_label_ids:s,include_by_label_ids:r,exclude_by_component_types:a,include_by_component_types:c}=t,l=s.has(n)||!!i.find(h=>s.has(h)),d=r.size>0&&!r.has(n)&&!i.find(h=>r.has(h)),p=a.has(o),f=c.size>0&&!c.has(o);return{should_exclude:l||p,lacks_include:d||f}}function at(e,t){let n={};e.forEach(s=>{Object.entries(s.wc_id_map).forEach(([r,a])=>{a.passthrough||(delete n[r],n[r]=a)})}),p$(n,t);const i=m$(n);n=i.composed_wc_id_map;const o=i.composed_blocked_wc_id_map;return{composed_wc_id_map:n,composed_blocked_wc_id_map:o}}function p$(e,t){Object.keys(e).forEach(n=>{const i=t[n];gl(i)&&delete e[n]})}function m$(e){const t={};return Object.entries(e).forEach(([n,i])=>{i.blocked&&(t[n]=i,delete e[n])}),{composed_wc_id_map:e,composed_blocked_wc_id_map:t}}function Nu(e){let t=e.routing.args.subview_id;return t=en(t)?t:"",di(e,t)}const f$=(e,t)=>{e.specialised_objects.knowledge_views_by_id!==t.specialised_objects.knowledge_views_by_id&&(t=v$(t));const i=Nu(e),o=Nu(t);(i==null?void 0:i.id)!==(o==null?void 0:o.id)&&(t=O(t,"derived","current_composed_knowledge_view",void 0));const r=i!==o,a=e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id,c=e.meta_wcomponents.selected_wcomponent_ids_set!==t.meta_wcomponents.selected_wcomponent_ids_set,l=r||a||c,d=e.routing.args.created_at_ms!==t.routing.args.created_at_ms,p=d||e.filter_context!==t.filter_context||a,f=e.display_options.display_time_marks!==t.display_options.display_time_marks,m=d||f;if(o){if(l){let v=Qw(t,o);v=Jc(t,v),v=tb(t,v),t=O(t,"derived","current_composed_knowledge_view",v)}else if(p){const v=Jc(t,t.derived.current_composed_knowledge_view);t=O(t,"derived","current_composed_knowledge_view",v)}else if(m){let{current_composed_knowledge_view:v}=t.derived;v=y$(v,f,t,o),t=O(t,"derived","current_composed_knowledge_view",v)}}return t};function v$(e){const{knowledge_views_by_id:t}=e.specialised_objects,n=pt(e),o=Object.values(t).map(a=>({...a,title:tn(a.title)})),s=be(o,({title:a})=>a,ve.ascending),r=Ng(s,n);return eS(r),e={...e,derived:{...e.derived,knowledge_views:s,nested_knowledge_view_ids:r}},e}function Qw(e,t){const{knowledge_views_by_id:n,wcomponents_by_id:i}=e.specialised_objects,{current_composed_knowledge_view:o}=e.derived;return h$({knowledge_view:t,current_composed_knowledge_view:o,knowledge_views_by_id:n,wcomponents_by_id:i})}function h$(e){const{knowledge_view:t,knowledge_views_by_id:n,wcomponents_by_id:i}=e,o=e.current_composed_knowledge_view||{composed_visible_wc_id_map:{},active_judgement_or_objective_ids_by_target_id:{},active_judgement_or_objective_ids_by_goal_or_action_id:{},filters:{wc_ids_excluded_by_any_filter:new Set,wc_ids_excluded_by_filters:new Set,wc_ids_excluded_by_created_at_datetime_filter:new Set,vap_set_number_excluded_by_created_at_datetime_filter:0},wc_id_to_active_counterfactuals_v2_map:{}},s=$t(t,n,!0),{composed_wc_id_map:r,composed_blocked_wc_id_map:a}=at(s,i),c=b$(r,i),l=Object.keys(r),d=Gw(i,l),p=[],f=[];l.forEach(k=>{const y=i[k];y?p.push(y):f.push(k)});const m=o.wc_id_to_active_counterfactuals_v2_map,v=g$({current_wc_id_to_active_counterfactuals_v2_map:m,wc_ids_by_type:d,wcomponents_by_id:i,active_counterfactual_ids:t.active_counterfactual_v2_ids||[]}),h=w$(d.any_link,i),w=u$(p),b=eb(s,!0),g={...t,...o,composed_wc_id_map:r,composed_blocked_wc_id_map:a,overlapping_wc_ids:c,wcomponent_unfound_ids:f,wc_id_to_active_counterfactuals_v2_map:v,wc_ids_by_type:d,wc_id_connections_map:h,available_filter_options:w,composed_datetime_line_config:b};return delete g.wc_id_map,delete g.datetime_line_config,g}function $t(e,t,n){const{foundation_knowledge_view_ids:i=[]}=e,o=i.map(s=>t[s]).filter(me);return n&&o.push(e),o}function g$(e){return e.current_wc_id_to_active_counterfactuals_v2_map}function w$(e,t){const n={};function i(s,r){const a=n[s]||new Set;a.add(r),n[s]=a}function o(s,r){i(s,r),i(r,s)}return e.forEach(s=>{const r=t[s];ye(r)&&(r.from_id&&o(r.from_id,r.id),r.to_id&&o(r.to_id,r.id))}),n}function eb(e,t){let n={};return t&&(n={...Yi}),e.forEach(i=>{const{datetime_line_config:o}=i;o&&(n.time_origin_ms=o.time_origin_ms??n.time_origin_ms,n.time_origin_x=o.time_origin_x??n.time_origin_x,n.time_scale=o.time_scale??n.time_scale,n.time_line_number=o.time_line_number??n.time_line_number,n.time_line_spacing_days=o.time_line_spacing_days??n.time_line_spacing_days)}),n}function Jc(e,t){if(!t)return;const{wc_ids_by_type:n,composed_wc_id_map:i}=t,o=kn(e,n.any_node).filter(Kk),s=kn(e,n.any_link).filter(ye),r=o.concat(s);let a=new Set;e.filter_context.apply_filter&&(a=Xc(e.filter_context.filters,e.meta_wcomponents.selected_wcomponent_ids_set,o,s));const{created_at_ms:c}=e.routing.args;let l=0;const d=r.filter(v=>(bi(v)&&v.values_and_prediction_sets.forEach(h=>{ze(h)>c&&++l}),ze(v)>c)).map(({id:v})=>v),p=new Set(d),f=xt(a,p),m={...i};return f.forEach(v=>{delete m[v]}),{...t,composed_visible_wc_id_map:m,filters:{wc_ids_excluded_by_any_filter:f,wc_ids_excluded_by_filters:a,wc_ids_excluded_by_created_at_datetime_filter:p,vap_set_number_excluded_by_created_at_datetime_filter:l}}}function Xc(e,t,n,i){const o=new Set,{exclude_by_label_ids:s,include_by_label_ids:r,exclude_by_component_types:a,include_by_component_types:c}=e,l=new Set(s),d=new Set(r),p=new Set(a),f=new Set(c),m={exclude_by_label_ids:l,include_by_label_ids:d,include_by_label_ids_list:r,exclude_by_component_types:p,include_by_component_types:f};return n.forEach(v=>{const{should_exclude:h,lacks_include:w}=Rt(v,m);(h||w)&&o.add(v.id)}),i.forEach(v=>{const{from_id:h,to_id:w}=v;let b=!1;//!from_id || !to_id
b=b||!!h&&!t.has(h)&&o.has(h)||!!w&&!t.has(w)&&o.has(w);const g=Rt(v,m);b=b||g.should_exclude,b&&o.add(v.id)}),o}function b$(e,t){const n=Zw(e,t),i={};return Object.values(n).forEach(o=>{o.length<=1||o.forEach((s,r)=>{const a=r+1;i[s]=[...o.slice(a),...o.slice(0,a)]})}),i}function y$(e,t,n,i){if(e){if(t&&!n.display_options.display_time_marks){const{knowledge_views_by_id:o,wcomponents_by_id:s}=n.specialised_objects,r=$t(i,o,!0),a=at(r,s);e={...e,...a}}else e=tb(n,e);return e}}function tb(e,t){if(!t)return;const{display_time_marks:n}=e.display_options,{wc_ids_by_type:i,composed_wc_id_map:o,composed_datetime_line_config:s}=t,{time_origin_ms:r,time_origin_x:a,time_scale:c}=s,{wcomponents_by_id:l}=e.specialised_objects,{created_at_ms:d}=e.routing.args;if(!n||r===void 0)return t;const p={...o};let f=!1;return Array.from(i.has_single_datetime).forEach(m=>{const v=o[m];if(!v)return;const h=Ml({wcomponent_id:m,wcomponents_by_id:l,created_at_ms:d,time_origin_ms:r,time_origin_x:a,time_scale:c});h===void 0||v.left===h||(f=!0,p[m]={...v,left:h})}),f?{...t,composed_wc_id_map:p}:t}function k$(e,t){if(e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id){const n=Object.keys(t.specialised_objects.wcomponents_by_id),i=Gw(t.specialised_objects.wcomponents_by_id,n);t=O(t,"derived","wcomponent_ids_by_type",i);const o=nb(t,t.derived.wcomponent_ids_by_type.judgement_or_objective),s=x$(o);t=O(t,"derived","judgement_or_objective_ids_by_target_id",s);const r=kn(t,t.derived.wcomponent_ids_by_type.goal).filter(me).filter(Rn),a=S$(r);t=O(t,"derived","judgement_or_objective_ids_by_goal_or_action_id",a)}return t=f$(e,t),t=e$(e,t),t=A$(e,t),t}function nb(e,t){return kn(e,t).filter(me).filter(ut)}function x$(e){const t={};return e.forEach(n=>{const i=n.judgement_target_wcomponent_id;if(!i)return;const o=t[i]||[];o.push(n.id),t[i]=o}),t}function S$(e){const t={};return e.forEach(({id:n,objective_ids:i})=>{t[n]=i||[]}),t}function A$(e,t){var l;let{current_composed_knowledge_view:n}=t.derived;const i=((l=e.derived.current_composed_knowledge_view)==null?void 0:l.id)!==(n==null?void 0:n.id),o=e.derived.judgement_or_objective_ids_by_target_id!==t.derived.judgement_or_objective_ids_by_target_id,{created_at_ms:s,sim_ms:r}=t.routing.args,a=e.routing.args.created_at_ms!==s,c=e.routing.args.sim_ms!==r;if(n&&(i||o||a||c)){let d=function($){return w[$]};const p={},f={},{wc_ids_by_type:m,composed_visible_wc_id_map:v}=n,h=nb(t,m.judgement_or_objective),w={};h.forEach($=>{if(!v[$.id])return;const{is_valid:j}=Ol({wcomponent:$,created_at_ms:s,sim_ms:r})||Rl();j&&(w[$.id]=!0)});const b={};Object.keys(v).forEach(($,j)=>{b[$]=j});const g=$=>b[$]||-1,{judgement_or_objective_ids_by_target_id:k,judgement_or_objective_ids_by_goal_or_action_id:y}=t.derived;Object.keys(v).forEach($=>{const j=k[$],C=y[$];if(j){const N=j.filter(d);if(N.length){const A=be(N,g,ve.descending);p[$]=A}}if(C){const N=C.filter(d);if(N.length){const A=be(N,g,ve.descending);f[$]=A}}}),n={...n,active_judgement_or_objective_ids_by_target_id:p,active_judgement_or_objective_ids_by_goal_or_action_id:f},t=O(t,"derived","current_composed_knowledge_view",n)}return t}const $$=(e,t)=>{if(N2(t)&&(e=O(e,"display_options","consumption_formatting",!e.display_options.consumption_formatting)),I2(t)){const n=No(t.focused_mode,e.display_options.focused_mode);e=O(e,"display_options","focused_mode",n)}if(R2(t)&&(e=O(e,"display_options","time_resolution",t.time_resolution)),M2(t)){e=O(e,"display_options","validity_filter",t.validity_filter);const n=Fw(t.validity_filter);e=O(e,"display_options","derived_validity_filter",n)}if(V2(t)){e=O(e,"display_options","certainty_formatting",t.certainty_formatting);const n=zw(t.certainty_formatting);e=O(e,"display_options","derived_certainty_formatting",n)}if(z2(t)&&(e=O(e,"display_options","display_by_simulated_time",t.display_by_simulated_time)),B2(t)&&(e=O(e,"display_options","display_time_marks",t.display_time_marks)),W2(t)){const n=No(t.animate_connections,e.display_options.animate_connections);e=O(e,"display_options","animate_connections",n)}if(G2(t)){const n=No(t.circular_links,e.display_options.circular_links);e=O(e,"display_options","circular_links",n)}if(Y2(t)&&(e=O(e,"display_options","show_help_menu",t.show)),X2(t)){const n=No(t.show_large_grid,e.display_options.show_large_grid);e=O(e,"display_options","show_large_grid",n)}return e};function No(e,t){return e===void 0&&(e=!t),e}function ib(e){return e.routing.args.view==="actions_list"}function C$(e){let t=e.derived.wcomponent_ids_by_type.action;const{apply_filter:n,filters:i}=e.filter_context;if(!n)return t;const{filter_by_current_knowledge_view:o,filter_by_text:s}=i;if(o){const r=_e(e);r&&(t=r.wc_ids_by_type.action)}if(s){const r=Array.from(t).map(a=>e.specialised_objects.wcomponents_by_id[a]).filter(Rh).filter(a=>a.title.includes(s)||a.description.includes(s)).map(a=>a.id);t=new Set(r)}return t}const j$=(e,t)=>{if(ex(t)&&(e=O(e,"filter_context","apply_filter",t.apply_filter)),nx(t)){e=O(e,"filter_context","filters",t.filters);const n=ib(e),{exclude_by_label_ids:i,include_by_label_ids:o,exclude_by_component_types:s,include_by_component_types:r,filter_by_current_knowledge_view:a,filter_by_text:c}=t.filters,l=i.length+o.length+s.length+r.length>0||n&&(a||c.length>0);e=O(e,"filter_context","apply_filter",l)}return e},T$=(e,t)=>{let n=!1;if(sx(t)){n=!0;const i=new Set([...e.global_keys.keys_down]);i.add(t.key),e={...e,global_keys:{...e.global_keys,last_key:t.key,last_key_time_stamp:t.time_stamp,keys_down:i}}}if(_x(t)){n=!0;let i=new Set([...e.global_keys.keys_down]);i.delete(t.key),e={...e,global_keys:{...e.global_keys,last_key:t.key,last_key_time_stamp:t.time_stamp,keys_down:i}}}return cx(t)&&(n=!0,e=O(e,"global_keys","keys_down",new Set)),n&&(e=P$(e)),e};function P$(e){const{keys_down:t}=e.global_keys,n=t.has("Control"),i=t.has("Shift"),o={...e.global_keys,derived:{shift_down:i,control_down:n,shift_or_control_down:n||i}};return{...e,global_keys:o}}const N$=(e,t)=>(ux(t)&&(e=O(e,"view_priorities","action_ids_to_show",t.action_ids),e=O(e,"view_priorities","date_shown",t.date_shown)),e);function Mt(e,t,n){const{route:i,sub_route:o,item_id:s,args:r}=e,a=t.args||{};a.created_at_ms=xu(a.created_at_datetime,a.created_at_ms,n),a.created_at_datetime=a.created_at_ms?new Date(a.created_at_ms):void 0,a.sim_ms=xu(a.sim_datetime,a.sim_ms,n),a.sim_datetime=a.sim_ms?new Date(a.sim_ms):void 0,Object.keys(a).forEach(l=>{if(l==="storage_location")return;const d=a[l];(d===void 0||d==="")&&delete a[l]});const c={...r,...a};return{route:t.route||i,sub_route:t.sub_route===null?null:t.sub_route||o,item_id:t.item_id===null?null:t.item_id||s,args:c}}const E$=x.delay("merge_routing_state",()=>{const e=new Date("2021-04-09 23:25:26"),t=new Date("2022-01-01 01:01:01"),n=new Date("2023-01-01 01:01:01"),i={route:"wcomponents",sub_route:null,item_id:"wc53611570523449304",args:{created_at_datetime:e,created_at_ms:e.getTime(),sim_datetime:e,sim_ms:e.getTime(),view:"knowledge",subview_id:"kv7207606403961189",zoom:100,x:0,y:0,storage_location:1}};let o,s,r;const a=c=>r=c;o={args:{x:0}},s=Mt(i,o),u(s,i),o={args:{zoom:void 0}},s=Mt(i,o),u(s,i),o={args:{created_at_datetime:t,created_at_ms:n.getTime()}},r="",s=Mt(i,o,a),u(s.args.created_at_datetime,n),u(s.args.created_at_ms,n.getTime()),u(r,"do not set both new_ms and new_datetime"),o={args:{sim_datetime:t,sim_ms:n.getTime()}},r="",s=Mt(i,o,a),u(s.args.sim_datetime,n),u(s.args.sim_ms,n.getTime()),u(r,"do not set both new_ms and new_datetime"),o={args:{sim_ms:void 0,created_at_ms:void 0}},s=Mt(i,o),u(s.args.sim_ms,e.getTime(),"should leave sim_ms unchanged when called with `{ args: { sim_ms: undefined }}`"),u(s.args.created_at_ms,e.getTime(),"should leave created_at_ms unchanged when called with `{ args: { created_at_ms: undefined }}`"),o={args:{storage_location:void 0}},s=Mt(i,o),u(s.args.storage_location,void 0)}),ob={views:[],wcomponents:["wcomponents_edit_multiple"],search:[],filter:[],select:[],display:[],statements:[],objects:["objects_bulk_import","objects_bulk_import/setup"],patterns:[],about:[]},sb=Object.keys(ob),I$={actions_list:!0,knowledge:!0},D$=Object.keys(I$),R$=e=>D$.includes(e),rb={view:!0,subview_id:!0,zoom:!0,x:!0,y:!0,storage_location:!0,cdate:!0,ctime:!0,sdate:!0,stime:!0},O$=Object.keys(rb).length;function fi(e){const t=e.sub_route?`${e.sub_route}/`:"",n=e.item_id?`${e.item_id}/`:"",i=e.args,o=Zc(i);return"#"+e.route+"/"+t+n+o}const M$=new Set(["order","rotation","created_at_datetime","created_at_ms","sim_datetime","sim_ms"]);function Zc(e){const t={...e,cdate:nn(e.created_at_datetime,"yyyy-MM-dd"),ctime:nn(e.created_at_datetime,"hh:mm:ss"),sdate:nn(e.sim_datetime,"yyyy-MM-dd"),stime:nn(e.sim_datetime,"hh:mm:ss")};return Object.keys(e).filter(i=>!M$.has(i)).sort().concat(["sdate","stime","cdate","ctime"]).map(i=>`&${i}=${t[i]??""}`).join("")}function q$(e){const t=_b(e);return!t.route||t.args_from_url.length!==O$}function _b(e){const n=(e.split("#")[1]||"").split("&"),o=n[0].split("/").filter(l=>!!l),{route:s,sub_route:r,item_id:a}=V$(o),c=n.slice(1).map(l=>l.split("=")).filter(l=>rb[l[0]]);return{route:s,sub_route:r,item_id:a,args_from_url:c}}function ab(e,t){const{route:n,sub_route:i,item_id:o,args_from_url:s}=_b(e),r=F$(t.args,s);return{route:n,sub_route:i,item_id:o,args:r}}function V$(e){let t=e[0],n=null,i=null;if(!sb.includes(t))t="wcomponents";else{const o=e.slice(1).join("/")||null;ob[t].includes(o)?n=o:i=o}return{route:t,sub_route:n,item_id:i}}function F$(e,t){e={...e};let n=null,i=null,o=null,s=null;return t.forEach(r=>{const[a,c]=r;a==="cdate"?n=c:a==="ctime"?i=c:a==="sdate"?o=c:a==="stime"?s=c:z$(e,a,c)}),e.created_at_datetime=ku(n,i),e.sim_datetime=o?ku(o,s):e.created_at_datetime,e.created_at_ms=e.created_at_datetime.getTime(),e.sim_ms=e.sim_datetime.getTime(),e}function z$(e,t,n){t==="view"?R$(n)&&(e.view=n):B$(t)?e[t]=U$(n):t==="subview_id"?e.subview_id=n:t==="storage_location"&&(e.storage_location=W$(n))}const L$=new Set(["x","y","zoom"]);function B$(e){return L$.has(e)}function U$(e){const t=parseInt(e);return Number.isNaN(t)?0:t}function W$(e){const t=parseInt(e);return Number.isNaN(t)?void 0:t}const H$=x.delay("routing_state_to_string",()=>{let e,t;e={route:"wcomponents",sub_route:null,item_id:"wc88",args:{view:"knowledge",subview_id:"kv77",zoom:100,x:101,y:158,storage_location:void 0,created_at_datetime:new Date("2020-10-21T17:04:24.000Z"),created_at_ms:1603299864e3,sim_datetime:new Date("2021-04-26T09:23:13.000Z"),sim_ms:1619428993e3}},t=fi(e),u(t,"#wcomponents/wc88/&storage_location=&subview_id=kv77&view=knowledge&x=101&y=158&zoom=100&sdate=2021-04-26&stime=10:23:13&cdate=2020-10-21&ctime=18:04:24")}),G$=60*1e3;function cb(e,t){let n=Number.NEGATIVE_INFINITY;return bi(e)&&e.type==="action"&&e.values_and_prediction_sets.forEach(i=>{var s;const o=((s=Mn(i.datetime))==null?void 0:s.getTime())||Number.NEGATIVE_INFINITY;n=Math.max(n,o)}),n=Math.max(n+G$,t.routing.args.sim_ms),n}const K$=(e,t)=>{if(ug(t)){const{route:n,sub_route:i,item_id:o,args:s}=e.routing,r=Mt(e.routing,t);(n!==r.route||i!==r.sub_route||o!==r.item_id||Zc(s)!==Zc(r.args))&&(e={...e,routing:r})}if(ds(t)){const n=cb(t.wcomponent,e);n!==e.routing.args.sim_ms&&(e=cs(e,"routing","args","sim_ms",n))}return e},Y$=(e,t)=>{if(kS(t)){const n=t.side==="right"?"find_all_causal_paths_from_wcomponent_ids":"find_all_causal_paths_to_wcomponent_ids";e=O(e,"meta_wcomponents",n,t.ids)}return e};function ql(e,t,n){const i=e.findIndex(n);return i<0?(console.error(`Can not find element by predicate: ${n.toString()}`),e):[...e.slice(0,i),t,...e.slice(i+1)]}function fs(e,t){const n=e.filter(i=>!t(i));return n.length===e.length?e:n}function lb(e,t,n){const i=n||(s=>s===t),o=e.filter(s=>!i(s));return o.length===e.length&&o.push(t),o}function St(e,t){return e.length>0&&t>=0&&t<e.length}function yt(e,t,n){if(!St(e,t)||!St(e,n))return e;const i=Math.min(t,n),o=Math.max(t,n),s=[...e],r=s[i];return s[i]=s[o],s[o]=r,s}function kt(e,t,n){return n<=0?e=[t,...e]:n>=e.length?e=[...e,t]:e=[...e.slice(0,n),t,...e.slice(n)],e}const J$=(e,t)=>{const n=e.meta_wcomponents.selected_wcomponent_ids_list;if(AS(t)){const{id:i}=t;let o=[...e.meta_wcomponents.selected_wcomponent_ids_list];const{shift_or_control_down:s}=e.global_keys.derived;s?o=lb(o,i):o=[i];const r={...e.meta_wcomponents,selected_wcomponent_ids_list:o,last_clicked_wcomponent_id:i};e={...e,meta_wcomponents:r}}if(CS(t)&&(e=X$(e)),TS(t)&&(e=Z$(e,t)),RS(t)){const i={wcomponent_id:t.wcomponent_id,terminal_type:void 0};e=O(e,"meta_wcomponents","last_pointer_down_connection_terminal",i)}if(ES(t)){const{wcomponent_id:i,terminal_type:o}=t;e=O(e,"meta_wcomponents","last_pointer_down_connection_terminal",{wcomponent_id:i,terminal_type:o})}return MS(t)&&(e=O(e,"meta_wcomponents","last_pointer_down_connection_terminal",void 0)),VS(t)&&(e=O(e,"meta_wcomponents","wcomponent_ids_to_move_set",t.wcomponent_ids_to_move)),n!==e.meta_wcomponents.selected_wcomponent_ids_list&&(e=db(e)),e};function X$(e){return e=O(e,"meta_wcomponents","selected_wcomponent_ids_list",[]),e}function Z$(e,t){return e=O(e,"meta_wcomponents","selected_wcomponent_ids_list",[...t.ids]),e}function db(e){const t=new Set(e.meta_wcomponents.selected_wcomponent_ids_list),n={};e.meta_wcomponents.selected_wcomponent_ids_list.forEach((o,s)=>n[o]=s);const i={...e.meta_wcomponents,selected_wcomponent_ids_set:t,selected_wcomponent_ids_to_ordinal_position_map:n};return{...e,meta_wcomponents:i}}const Q$=(e,t)=>(e=Y$(e,t),e=J$(e,t),LS(t)&&(e=O(e,"meta_wcomponents","frame_is_resizing",t.frame_is_resizing)),e);function eC(e,t){return t=tC(e,t),t}function tC(e,t){const n=e.sync.ready_for_reading!==t.sync.ready_for_reading;if((e.routing.item_id!==t.routing.item_id||n)&&t.routing.item_id&&en(t.routing.item_id)){const i=[t.routing.item_id];t=O(t,"meta_wcomponents","selected_wcomponent_ids_list",i),t=db(t)}return t}function oe(e,t,n=new Set){let i=E.undefined;do{if(n.has((e==null?void 0:e.id)||"")){console.log(`Recursion prevented in "get_wcomponent_VAPs_represent" for wcomponent id: "${e==null?void 0:e.id}" type: "${e==null?void 0:e.type}"`);break}if(e&&n.add(e.id),!Ke(e))break;if(Qe(e))i=nC(e.subtype);else if(et(e))i=E.action;else if(gt(e)){const o=t[e.attribute_wcomponent_id||""];o&&(i=oe(o,t,n))}else console.error(`Unimplemented "get_wcomponent_VAPs_represent" for wcomponent id: "${e.id}" type: "${e.type}"`)}while(!1);return i}function nC(e){return e==="boolean"?E.boolean:e==="number"?E.number:e==="other"?E.other:E.undefined}function Vt(e,t){if(wi(e)){const n=be(e.validity,ze,ve.ascending);e.validity=n}if(On(e)){const n=be(e.values_and_prediction_sets||[],ze,ve.ascending),i=oe(e,t),o=n.map(s=>({...s,entries:wl(s.entries,i)}));e.values_and_prediction_sets=o}return Ke(e)&&(e._derived__using_value_from_wcomponent_id&&console.error(`WComponent "${e.id}" had _derived__using_value_from_wcomponent_id set ("${e._derived__using_value_from_wcomponent_id}") but this should never happen and only be used on wcomponents from state.derived.composed_wcomponents_by_id`),delete e._derived__using_value_from_wcomponent_id),e}function ub(e,t,n,i){let{wcomponent_ids:o,knowledge_view_ids:s}=e.sync.specialised_object_ids_pending_save;const r=t==="wcomponent";let a=r?o:s;return a=i?n$(a,n):i$(a,n),e=cs(e,"sync","specialised_object_ids_pending_save",r?"wcomponent_ids":"knowledge_view_ids",a),e}function iC(e,t){return t=Vt(t,e.specialised_objects.wcomponents_by_id),t=co(t),e=pg(e,"sync","last_source_of_truth_specialised_objects_by_id","wcomponents",t.id,t),e}function oC(e,t){return t=co(t),e=pg(e,"sync","last_source_of_truth_specialised_objects_by_id","knowledge_views",t.id,t),e}function sC(e,t){return pb(e,t,!1)}function pb(e,t,n){return e={...e,needs_save:!0,modified_by_username:us(t)},n&&(e.deleted_at=new Date),e}function Ut(e,t,n){const i={...e.specialised_objects.knowledge_views_by_id};return t=n?t:sC(t,e),i[t.id]=t,e=O(e,"specialised_objects","knowledge_views_by_id",i),e=ub(e,"knowledge_view",t.id,!!t.needs_save),e}const rC=(e,t)=>(Dx(t)&&(e=dC(e,t)),Ox(t)&&(e=uC(e,t)),qx(t)&&(e=cC(e,t)),Fx(t)&&(e=lC(e,t)),Lx(t)&&(e=_C(e,t)),Ux(t)&&(e=aC(e,t)),e);function _C(e,t){const{knowledge_view_id:n,wcomponent_ids:i,override_entry:o,default_entry:s}=t,r=e.specialised_objects.knowledge_views_by_id[n],a=_e(e);if(!r)console.error(`Could not find knowledge view for bulk_add_to_knowledge_view by id: "${n}"`);else if(!a)console.error("There should always be a current knowledge view if bulk editing position of world components");else{let c={};i.forEach(d=>{let p={...s,...a.composed_wc_id_map[d],...o,blocked:void 0,passthrough:void 0};if(p.left===void 0||p.top===void 0){console.error(`we should always have an entry but no bulk_entry provided and wcomponent "${d}" lacking entry in composed_kv composed_wc_id_map for "${n}"`);return}c[d]=p}),c={...r.wc_id_map,...c};const l={...r,wc_id_map:c};e=Ut(e,l)}return e}function aC(e,t){const{wcomponent_ids:n,remove_type:i}=t,o=i==="block",s=Be(e),r=_e(e);if(!s||!r)console.error("There should always be a current and current composed knowledge view if bulk editing (removing) positions of world components");else{const a={...s.wc_id_map};n.forEach(l=>{const d=o?r.composed_wc_id_map[l]:s.wc_id_map[l];if(!d)return;const p=o?{...d,blocked:!0,passthrough:void 0}:{...d,blocked:void 0,passthrough:!0};a[l]=p});const c={...s,wc_id_map:a};e=Ut(e,c)}return e}function cC(e,t){const{wcomponent_ids:n,knowledge_view_id:i}=t,o=e.specialised_objects.knowledge_views_by_id[i];if(o){const s={...o.wc_id_map};n.forEach(a=>{const c=o.wc_id_map[a];if(!c)return;const l=ms(c,"large");s[a]=l});const r={...o,wc_id_map:s};e=Ut(e,r)}return e}function lC(e,t){const{wcomponent_ids:n,order:i}=t,o=Be(e),s=_e(e);if(!o||!s)return console.error("There should always be a current knowledge view and current composed knowledge view if bulk editing (moving to top) world components"),e;let r={};i==="front"?(r={...o.wc_id_map},n.forEach(c=>{const l=s.composed_wc_id_map[c];l&&(delete r[c],r[c]=l)})):i==="back"&&(n.forEach(c=>{const l=s.composed_wc_id_map[c];l&&(r[c]=l)}),r={...r,...o.wc_id_map});const a={...o,wc_id_map:r};return e=Ut(e,a),e}function dC(e,t){const{wcomponent_ids:n,change_left:i,change_top:o}=t,s=Be(e),r=_e(e);if(s&&r){const a={...s.wc_id_map};n.forEach(l=>{const d=r.composed_wc_id_map[l];if(!d||d.blocked||d.passthrough)return;const p={...d};p.left+=i,p.top+=o,a[l]=p});const c={...s,wc_id_map:a};e=Ut(e,c)}else console.error("There should always be a current knowledge view if bulk editing position of world components");return e}function uC(e,t){const{knowledge_view_id:n,changes:i}=t,o=e.specialised_objects.knowledge_views_by_id[n];if(o){const s={...o.wc_id_map};i.forEach(a=>{const c=o.wc_id_map[a.wcomponent_id];if(!c)return;const l={...c,left:a.left,top:a.top};s[a.wcomponent_id]=l});const r={...o,wc_id_map:s};e=Ut(e,r)}return e}const pC=(e,t)=>{if(Cg(t)&&(e=Ut(e,t.knowledge_view,t.is_source_of_truth)),ds(t)){const{wcomponent:n,add_to_knowledge_view:i,add_to_top:o}=t;if(i){const r={...i.position};e=Eu(e,i.id,n.id,r,o)}const s=e.specialised_objects.knowledge_views_by_id[n.id];if(s&&s.title!==n.title){const r={...s,title:n.title};e=Ut(e,r,t.is_source_of_truth)}}if(Gx(t)&&(e=Eu(e,t.knowledge_view_id,t.wcomponent_id,t.entry)),iw(t)&&t.object_type==="knowledge_view"){let n=di(e,t.id);n?(n={...n,saving:t.saving},e=cs(e,"specialised_objects","knowledge_views_by_id",t.id,n)):console.error(`Could not find knowledge_view by id: "${t.id}" whilst handling is_update_specialised_object_sync_info`)}return e=rC(e,t),e};function Eu(e,t,n,i,o){const s=di(e,t);return s?mC(e,s,n,i,o):(console.error(`Could not find knowledge_view for id: "${t}"`),e)}function mC(e,t,n,i,o=!0){let s={...t.wc_id_map};const r=s[n];r&&(r.blocked&&!i.blocked||r.passthrough&&!i.passthrough)&&delete s[n],o?s[n]=i:s={[n]:i,...s};const a={...t,wc_id_map:s};return Ut(e,a)}function rn(e,t){const n={};return e.forEach(i=>{if(n[i.id])throw new Error(`Duplicate "${t}".id: "${n[i.id]}".  "${n[i.id].title}" and "${i.title}"`);n[i.id]=i}),n}const fC=(e,t)=>{if(Og(t)){const{wcomponents:n,knowledge_views:i}=t.specialised_objects,o=rn(n,"wcomponents"),s=rn(i,"knowledge_views");e={...e,specialised_objects:{wcomponents_by_id:o,knowledge_views_by_id:s}}}return qg(t)&&(e={...e,specialised_objects:{wcomponents_by_id:{},knowledge_views_by_id:{}}}),e};function Qc(e,t,n,i=!1){const o={...e.specialised_objects.wcomponents_by_id};return t=n?t:pb(t,e,i),o[t.id]=t,e=O(e,"specialised_objects","wcomponents_by_id",o),e=ub(e,"wcomponent",t.id,!!t.needs_save),e}function vC(e,t){const n={...e.specialised_objects.wcomponents_by_id};return t.forEach(i=>n[i.id]=i),e=O(e,"specialised_objects","wcomponents_by_id",n),e}const hC=(e,t)=>(uS(t)&&(e=gC(e,t)),e);function gC(e,t){const{wcomponent_ids:n,change:i,remove_label_ids:o,add_label_ids:s}=t,r=kn(e,n).filter(me);return r.length&&r.forEach(a=>{const c={...a,...i},l=wC(c,o,s),d=Vt(l,e.specialised_objects.wcomponents_by_id);e=Qc(e,d,!1)}),e}function wC(e,t,n){let{label_ids:i}=e;if(i&&t&&(i=i.filter(o=>!t.has(o))),n){const o=i||[],s=new Set(o);Array.from(n).forEach(r=>{s.has(r)||o.push(r)}),i=o}return{...e,label_ids:i}}const bC=(e,t)=>{if(ds(t)){const n=Vt(t.wcomponent,e.specialised_objects.wcomponents_by_id);e=Qc(e,n,t.is_source_of_truth)}if(vS(t)){const{wcomponent_id:n}=t;let{wcomponents_by_id:i}=e.specialised_objects;const o=i[n];o&&(e=Qc(e,o,!1,!0))}if(gS(t)){const n=t.wcomponents.map(i=>Vt(i,e.specialised_objects.wcomponents_by_id));e=vC(e,n)}if(iw(t)&&t.object_type==="wcomponent"){let n=pe(e,t.id);n?(n={...n,saving:t.saving},e=cs(e,"specialised_objects","wcomponents_by_id",t.id,n)):console.error(`Could not find wcomponent by id: "${t.id}" whilst handling is_update_specialised_object_sync_info`)}return e=hC(e,t),e},yC=(e,t)=>(e=oS(e,t),e=fC(e,t),e=bC(e,t),e=pC(e,t),e),kC=(e,t)=>{if(WS(t)){const{status:n,loading_base_id:i,error_message:o="",attempt:s}=t,r={...e.sync[t.data_type],status:n,error_message:o,retry_attempt:s};i!==void 0&&(r.loading_base_id=i),e=O(e,"sync",t.data_type,r),e=Iu(e)}if(GS(t)){const n=Object.values(e.specialised_objects.wcomponents_by_id),i=Object.values(e.specialised_objects.knowledge_views_by_id),o=Du({wcomponents:n,knowledge_views:i});e=Hs(e,o)}if(qg(t)&&(e=Hs(e,{knowledge_view_ids:new Set,wcomponent_ids:new Set}),e=O(e,"sync","last_source_of_truth_specialised_objects_by_id",{wcomponents:{},knowledge_views:{}}),e=O(e,"sync","specialised_objects",{status:void 0,loading_base_id:void 0,error_message:"",retry_attempt:0}),e=Iu(e)),Og(t)){const{wcomponents:n,knowledge_views:i}=t.specialised_objects,o=Du({wcomponents:n,knowledge_views:i});e=Hs(e,o);const s={wcomponents:rn(n,"wcomponents"),knowledge_views:rn(i,"knowledge_views")};e=O(e,"sync","last_source_of_truth_specialised_objects_by_id",s)}if(ds(t)&&t.is_source_of_truth&&(e=iC(e,t.wcomponent)),Cg(t)&&t.is_source_of_truth&&(e=oC(e,t.knowledge_view)),JS(t)&&(e=O(e,"sync","network_functional",t.network_functional),e=O(e,"sync","network_function_last_checked",t.last_checked)),ZS(t)){const n=new Set(e.sync.wcomponent_ids_to_search_for_in_any_base),{wcomponent_ids_searching_for_in_any_base:i,wcomponent_ids_searched_for_in_any_base:o}=e.sync;t.ids.filter(s=>!n.has(s)&&!i.has(s)&&!o.has(s)&&!e.specialised_objects.wcomponents_by_id[s]).forEach(s=>n.add(s)),e=O(e,"sync","wcomponent_ids_to_search_for_in_any_base",n)}if(eA(t)){const n=xt(e.sync.wcomponent_ids_to_search_for_in_any_base,e.sync.wcomponent_ids_searching_for_in_any_base);e=O(e,"sync","wcomponent_ids_to_search_for_in_any_base",new Set),e=O(e,"sync","wcomponent_ids_searching_for_in_any_base",n)}if(nA(t)){const n=new Set(e.sync.wcomponent_ids_searching_for_in_any_base),i=new Set(e.sync.wcomponent_ids_searched_for_in_any_base);t.ids.forEach(o=>{n.delete(o),i.add(o)}),e=O(e,"sync","wcomponent_ids_searching_for_in_any_base",n),e=O(e,"sync","wcomponent_ids_searched_for_in_any_base",i)}return e};function Iu(e){const{bases:t,specialised_objects:n}=e.sync,i=xC(n);return e=O(e,"sync","ready_for_reading",i.ready_for_reading),e=O(e,"sync","ready_for_writing",i.ready_for_writing),e}function xC(e){const{status:t}=e;return{ready_for_reading:t!==void 0&&t!=="LOADING",ready_for_writing:t==="SAVED"||t==="LOADED"||t==="FAILED"}}function Du(e){const t=new Set(e.wcomponents.filter(i=>i.needs_save).map(({id:i})=>i)),n=new Set(e.knowledge_views.filter(i=>i.needs_save).map(({id:i})=>i));return{wcomponent_ids:t,knowledge_view_ids:n}}function Hs(e,t){return O(e,"sync","specialised_object_ids_pending_save",t)}const ei=(e,t)=>{var n,i;if(sA(t)){const o=((n=e.user_info.user)==null?void 0:n.id)!==((i=t.user)==null?void 0:i.id);e=O(e,"user_info","user",t.user);const s=e.user_info.has_signed_in_at_least_once||!!t.user;e=O(e,"user_info","has_signed_in_at_least_once",s),o&&G.user.pub("changed_user",!0)}if(cA(t)){let o;t.users&&(o={},t.users.forEach(s=>o[s.id]=s)),e=O(e,"user_info","users_by_id",o)}if(_A(t)&&(e=O(e,"user_info","need_to_handle_password_recovery",t.need_to_handle_password_recovery)),pA(t)){const{bases:o}=t,s=SC(o);e=O(e,"user_info","bases_by_id",s);let r=!1;if(e.user_info.user){const a=e.user_info.chosen_base_id;e=AC(e),r=a!==e.user_info.chosen_base_id}G.user.pub("changed_bases",!0),r&&G.user.pub("changed_chosen_base_id",!0)}if(dA(t)){const o=e.user_info.chosen_base_id;e=O(e,"user_info","chosen_base_id",t.base_id),o!==e.user_info.chosen_base_id&&G.user.pub("changed_chosen_base_id",!0)}return e};function SC(e){let t;return e&&(t={},e.forEach(n=>t[n.id]=n)),t}function AC(e){var i;const{bases_by_id:t,chosen_base_id:n}=e.user_info;if(t&&(n===void 0||!t[n])){const o=mw(e),s=o&&((i=o[0])==null?void 0:i.id);e=O(e,"user_info","chosen_base_id",s)}return e}const mb=e=>(t,n)=>{t=t||e;const i=t;return t=$$(t,n),t=kC(t,n),t=K$(t,n),t=T$(t,n),t=hx(t,n),t=kx(t,n),t=yC(t,n),t=Q$(t,n),t=H3(t,n),t=j$(t,n),t=ei(t,n),t=N$(t,n),t=$x(t,n),t={...t,last_action:n},t=k$(i,t),t=eC(i,t),window.debug_state=t,t},$C=e=>{let t;const n=CC();TC(e);function i(){const o=e.getState();if(o.routing===t)return;const s=jC(t,o.routing);t=o.routing,n(s,o.routing)}return i(),i};let Lo=!1;function CC(){const e=Yc(n=>{const i=fi(n);window.DEBUG_ROUTING&&console.log("DELAYED changing route from ",window.location.hash.toString(),"   to:   ",i),window.location.hash=i,Lo=!1},1e3),t=Yc(n=>{const i=fi(n),o=q$(window.location.toString());window.DEBUG_ROUTING&&console.log(`Debounced changing route from "${o?"incomplete":"complete"}"`,window.location.hash.toString(),"   to:   ",i),o?history.replaceState(null,"",i):window.location.hash=i,Lo=!1},0);return(n,i)=>{Lo=!0,n?e.throttled(i):(e.cancel(),t.cancel(),t.throttled(i))}}function jC(e,t){return!e||!e.args?!1:e.args.x!==t.args.x||e.args.y!==t.args.y}function TC(e){window.onhashchange=t=>{var o,s,r,a;if(Lo)return;const n=t,i=e.getState();if(i.sync.ready_for_reading){const c="#"+(n.newURL.split("#")[1]||""),l=fi(i.routing);if(l===c){window.DEBUG_ROUTING&&console.log("on hash change but no difference to current hash route_from_state",l);return}window.DEBUG_ROUTING&&console.log("on hash change difference.  new url is: ",c,"   state is:   ",l),e.dispatch(S.meta_wcomponents.clear_selected_wcomponents());const p=ab(n.newURL,i.routing);((o=p==null?void 0:p.args)==null?void 0:o.created_at_ms)!==void 0&&((s=p==null?void 0:p.args)==null||delete s.created_at_datetime),((r=p==null?void 0:p.args)==null?void 0:r.sim_ms)!==void 0&&((a=p==null?void 0:p.args)==null||delete a.sim_datetime),e.dispatch(S.routing.change_route(p))}}}function PC(e){const t=e.getState();let{chosen_base_id:n}=t.user_info;e.subscribe(()=>{const i=e.getState(),{chosen_base_id:o}=i.user_info,{storage_location:s}=i.routing.args;s===void 0?s!==o&&(console.log(`Change storage_location in route to "${o}" as nothing was set`),e.dispatch(S.routing.change_route({args:{storage_location:o}}))):s!==o&&(n!==o?e.dispatch(S.routing.change_route({args:{storage_location:o}})):e.dispatch(S.user_info.update_chosen_base_id({base_id:s}))),n=o})}const NC={sync_storage_location_subscriber:PC};function EC(e){G.canvas.sub("canvas_right_click",t=>{e.dispatch(S.meta_wcomponents.clear_selected_wcomponents());const{route:n,item_id:i,sub_route:o}=e.getState().routing;(n==="wcomponents"&&i||o==="wcomponents_edit_multiple")&&e.dispatch(S.routing.change_route({route:"wcomponents",sub_route:null,item_id:null}))})}function qe(e,t,n){return Math.max(Math.min(e,n),t)}function Ru(e,t,n,i=0,o=1){const r=(qe(e,i,o)-i)/(o-i);return t+r*(n-t)}const Vl=e=>qe(e,10,400),Fe=100,IC=.01;function DC(e){const{zoom:t,wheel_change:n}=e,i=t-n*IC*t;return Vl(Math.round(i))}function fb(e){const{old:t,new_zoom:n,pointer_x:i,pointer_y:o,client_width:s,client_height:r}=e,a=i/s,c=o/r,l=Fe/n-Fe/t.zoom,d=a*s*l,p=c*r*l,f=t.x-d,m=t.y+p;return{x:f,y:m}}const RC=x.skip("calculate_new_zoom_xy (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{let e,s,r,a;const c={pointer_x:5,pointer_y:15},l={pointer_x:5+900,pointer_y:15+600};function d(p){const f=p.pointer==="top_left"?c:l;return fb({old:{x:p.x,y:p.y,zoom:p.zoom},new_zoom:p.new_zoom,...f,client_width:900,client_height:600})}a="top_left",e=d({x:0,y:0,zoom:10,new_zoom:200,pointer:a}),u(e,{x:0,y:0}),e=d({x:100,y:100,zoom:200,new_zoom:200,pointer:a}),u(e,{x:100,y:100}),e=d({x:100,y:100,zoom:200,new_zoom:10,pointer:a}),u(e,{x:100,y:100}),a="bottom_right",s=100,r=50,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900,y:600}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900+100,y:600+100}),s=200,r=100,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900/2,y:600/2}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900/2+100,y:600/2+100}),s=100,r=200,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900/2,y:-600/2}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900/2+100,y:-600/2+100}),s=50,r=100,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900,y:-600}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900+100,y:-600+100}),s=50,r=50,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:0,y:0}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:100,y:100})}),Ji=440,OC=100;function MC(){const e=new Date,t=e.getTime(),i={route:"wcomponents",sub_route:null,item_id:null,args:{view:"knowledge",subview_id:"",zoom:100,x:0,y:0,storage_location:void 0,created_at_datetime:e,created_at_ms:t,sim_datetime:e,sim_ms:t}};return ab(window.location.toString(),i)}const vs=48,qC=e=>e?300:120,VC=e=>e?Ji:0,Fl=e=>document.body.clientWidth-VC(e),zl=e=>document.body.clientHeight-vs-qC(e),vb=e=>Fl(e)/2,hb=e=>zl(e)/2;function FC(e,t,n){const i=to(e.x+vb(t)*(Fe/e.zoom),pi),o=to(e.y-hb(n)*(Fe/e.zoom)+vs,Sn);return{x:i,y:o}}function zC(e,t){const n=e.x-vb(t.display_side_panel)*(Fe/e.zoom),i=e.y+(hb(t.display_time_sliders)+vs)*(Fe/e.zoom);return{x:n,y:i}}function ki(e){const t=FC(e.routing.args,e.controls.display_side_panel,e.controls.display_time_sliders);return Kw(t)}const LC={display_side_panel:!1,display_time_sliders:!1};function vi(e,t,n){if(!e)return;const{left:i,top:o,zoom:s=OC}=e,r=o!==void 0?-1*o:void 0;return t&&i!==void 0&&r!==void 0?{...zC({x:i,y:r,zoom:s},n||LC),zoom:s}:{x:i,y:r,zoom:s}}function BC(e,t,n){let i=e?t[e]:void 0;for(;i;){const o=n[i.id];if(et(o)||Rn(o))return[o.id];i=i.parent_knowledge_view_id?t[i.parent_knowledge_view_id]:void 0}return[]}const UC=60*1e3;function xi(e){const t=e.store||Ae(),n=t.getState();let i=qt(e.wcomponent);i=WC(i,n),i=HC(i,n),i=KC(i,n);const o=GC(e.add_to_knowledge_view,i,n),s=!ut(i);let r=ze(i);r=Math.max(r+UC,n.routing.args.created_at_ms);const a=cb(i,n);return t.dispatch(S.specialised_object.upsert_wcomponent({wcomponent:i,add_to_knowledge_view:o,add_to_top:s})),t.dispatch(S.meta_wcomponents.clear_selected_wcomponents()),t.dispatch(S.routing.change_route({route:"wcomponents",item_id:i.id,args:{created_at_ms:r,sim_ms:a}})),!0}function WC(e,t){if(ut(e)){const n=t.meta_wcomponents.selected_wcomponent_ids_list,i=n[0];if(n.length===1&&i){const o=pe(t,i);o&&(e={...e,judgement_target_wcomponent_id:o.id})}}return e}function HC(e,t){if(!et(e)||e.parent_goal_or_action_ids)return e;const n=_e(t),{wcomponents_by_id:i,knowledge_views_by_id:o}=t.specialised_objects,s=n==null?void 0:n.id,r=BC(s,o,i);return{...e,parent_goal_or_action_ids:r}}function GC(e,t,n){const i=_e(n);if(!e&&i){let o;ut(t)?o=t.judgement_target_wcomponent_id:gt(t)&&(o=t.attribute_wcomponent_id);let s=i.composed_wc_id_map[o||""];s||(s=ki(n)),e={id:i.id,position:s}}return e}function KC(e,t){if(gt(e)){const{wcomponents_by_id:n}=t.specialised_objects;let{attribute_wcomponent_id:i,value_possibilities:o}=e;const s=t.meta_wcomponents.selected_wcomponent_ids_list,r=s[0];if(s.length===1&&r){const a=pe(t,r);if(a&&Qe(a)){const c=a;if(i=a.id,!o||!Object.keys(o).length){const l=oe(c,n),d=yn(l,c.value_possibilities,c.values_and_prediction_sets||[]);o=rn(d,"attribute's possible_values")}}}e={...e,attribute_wcomponent_id:i,value_possibilities:o}}return e}function YC(e){return()=>{const t=e.getState(),{last_pointer_down_connection_terminal:n}=t.meta_wcomponents;if(!n)return;const i=pt(t);if(i===void 0)return;if(t.global_keys.last_key==="Escape"||t.display_options.consumption_formatting){e.dispatch(S.meta_wcomponents.clear_pointerupdown_on_connection_terminal());return}if(!t.last_action)return;let o=!1;const{terminal_type:s,wcomponent_id:r}=n,a=(s==null?void 0:s.attribute)||"state";let c=s==null?void 0:s.side,l,d="state",p=((s==null?void 0:s.side)||"right")==="right"?"left":"right";if(DS(t.last_action))l=t.last_action.wcomponent_id,o=r===l&&(s==null?void 0:s.side)===void 0;else if(NS(t.last_action))l=t.last_action.wcomponent_id,d=t.last_action.terminal_type.attribute,p=t.last_action.terminal_type.side;else return;if(o=o||r===l&&c===p,e.dispatch(S.meta_wcomponents.clear_pointerupdown_on_connection_terminal()),o)return;c=p==="right"?"left":"right";const f=c==="right";xi({wcomponent:{base_id:i,type:a==="meta"||d==="meta"?"relation_link":"causal_link",from_id:f?r:l,to_id:f?l:r,from_type:f?a:d,to_type:f?d:a}})}}function JC(e){function t(){const n=e.getState(),{last_pointer_down_connection_terminal:i}=n.meta_wcomponents;i&&e.dispatch(S.meta_wcomponents.clear_pointerupdown_on_connection_terminal())}G.canvas.sub("canvas_right_click",()=>{t()}),G.canvas.sub("canvas_pointer_down",()=>{t()}),G.canvas.sub("canvas_pointer_up",()=>{t()})}function XC(e){G.canvas.sub("canvas_double_tap",t=>{const n=e.getState(),i=Be(n);if(!i){console.error("No current_knowledge_view despite canvas double_tap");return}const o=pt(n);if(o===void 0){console.error("No base_id despite canvas double_tap");return}if(n.display_options.consumption_formatting||n.routing.args.view!=="knowledge")return;const s=ZC(t),r={id:i.id,position:s};xi({wcomponent:{base_id:o,type:"statev2"},add_to_knowledge_view:r,store:e})})}function ZC(e){const t=s$(Kw(e));return ms(t,"large")}function QC(e){ej(e);const t=YC(e);return()=>{t()}}function ej(e){EC(e),XC(e),JC(e)}function tj(){return{composed_wcomponents_by_id:{},wcomponent_ids_by_type:Hw(),knowledge_views:[],nested_knowledge_view_ids:{top_ids:[],map:{}},judgement_or_objective_ids_by_target_id:{},judgement_or_objective_ids_by_goal_or_action_id:{},current_composed_knowledge_view:void 0}}function nj(){return{last_key:void 0,last_key_time_stamp:void 0,keys_down:new Set,derived:{shift_down:!1,control_down:!1,shift_or_control_down:!1}}}function ij(){return{action_ids_to_show:[],date_shown:void 0}}function oj(){return{selected_wcomponent_ids_list:[],selected_wcomponent_ids_set:new Set,selected_wcomponent_ids_to_ordinal_position_map:{},highlighted_wcomponent_ids:new Set,neighbour_ids_of_highlighted_wcomponent:new Set,last_clicked_wcomponent_id:void 0,last_pointer_down_connection_terminal:void 0,wcomponent_ids_to_move_set:new Set,frame_is_resizing:!1,find_all_causal_paths_from_wcomponent_ids:[],find_all_causal_paths_to_wcomponent_ids:[]}}function sj(){return{wcomponents_by_id:{},knowledge_views_by_id:{}}}function gb(){const e=MC(),{storage_location:t}=e.args,n=U3({storage_location:t});return{controls:C3({storage_location:t}),filter_context:N3(),specialised_objects:sj(),last_action:void 0,display_options:T3(),sync:R3(),routing:e,global_keys:nj(),meta_wcomponents:oj(),search:I3(),user_info:n,view_priorities:ij(),derived:tj()}}function zi(e){const{current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,disable_if_not_present:o,display_side_panel:s,display_time_sliders:r}=e;let{created_at_ms:a,selected_wcomponent_ids_set:c}=e,l,d=[];if(t){const{composed_wc_id_map:p,composed_visible_wc_id_map:f,wc_ids_by_type:m}=t,v=n[i];l=v&&ze(v);const{any_node:h}=m;c=new Set(c),c.delete(i);const w=_j({initial_wcomponent:v,disable_if_not_present:o,composed_visible_wc_id_map:f,selected_wcomponent_ids_set:c,wcomponents_by_id:n,composed_wc_id_map:p,display_side_panel:s,display_time_sliders:r,any_node:h});d=w.positions,w.wcomponent_created_at_ms&&(l=Math.max(w.wcomponent_created_at_ms,l||0)),l&&(a=Math.max(a,l))}return{positions:d,go_to_datetime_ms:a}}function rj(e){const{current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,selected_wcomponent_ids_set:o,created_at_ms:s,disable_if_not_present:r}=e,a={current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,selected_wcomponent_ids_set:o,created_at_ms:s,disable_if_not_present:r},{positions:c,go_to_datetime_ms:l}=zi({...a,display_side_panel:!1,display_time_sliders:!1}),d=zi({...a,display_side_panel:!0,display_time_sliders:!1}).positions,p=zi({...a,display_side_panel:!1,display_time_sliders:!0}).positions,f=zi({...a,display_side_panel:!0,display_time_sliders:!0}).positions;return{positions_no_sidepanel_or_timesliders:c,positions_sidepanel_no_timesliders:d,positions_timesliders_no_sidepanel:p,positions_with_sidepanel_or_timesliders:f,go_to_datetime_ms:l}}function _j(e){const{initial_wcomponent:t,disable_if_not_present:n,composed_visible_wc_id_map:i,selected_wcomponent_ids_set:o,wcomponents_by_id:s,composed_wc_id_map:r,display_side_panel:a,display_time_sliders:c,any_node:l}=e;let d=[],p;const f={display_side_panel:a,display_time_sliders:c},m=r[(t==null?void 0:t.id)||""];if(t&&m){const{left:v,top:h}=r$(m,!!t.summary_image),w=vi({left:v,top:h,zoom:Fe},!0,f);d.push(w)}else if(!n&&i){let v=Mu(o,i),h=Ou(v,s,r,f);h.position_groups.length===0&&(v=Mu(l,i),h=Ou(v,s,r,f)),p=h.wcomponent_created_at_ms,d=h.position_groups.map(w=>vi({left:(w.min_left+w.max_left)/2,top:(w.min_top+w.max_top)/2,zoom:w.zoom},!0,f))}return{positions:d,wcomponent_created_at_ms:p}}function Ou(e,t,n,i){const o=[];let s;const r=Array.from(e);for(let a=0;a<r.length;++a){const c=r[a];if(!c)continue;const l=t[c],d=n[c];if(!l||!d)continue;const p=d.s??1,f=Yw(!!l.summary_image),m=d.left-Ee,v=d.left+Ee*p+Ee,h=d.top-f,w=d.top+f*p;if(!o.find(g=>{const k={min_left:Math.min(g.min_left,m),max_left:Math.max(g.max_left,v),min_top:Math.min(g.min_top,h),max_top:Math.max(g.max_top,w)},{zoom:y,fits:$}=aj(k,i);return $?(g.min_left=k.min_left,g.max_left=k.max_left,g.min_top=k.min_top,g.max_top=k.max_top,g.zoom=y,!0):!1})){if(o.length>10)break;const g={min_left:m,max_left:v,min_top:h,max_top:w,zoom:Fe};o.push(g)}s=ze(l)}return{position_groups:o,wcomponent_created_at_ms:s}}function aj(e,t){const n=e.max_left-e.min_left,i=e.max_top-e.min_top,o=Fl(t.display_side_panel)/n*Fe,s=zl(t.display_time_sliders)/i*Fe,r=Math.min(o,s),a=Vl(Math.min(Fe,r));return{zoom:a,fits:r>=a}}function Mu(e,t){const n=new Set(e);return e.forEach(i=>{t[i]||n.delete(i)}),n}function hs(e){return e.controls.display_time_sliders}function cj(e){const t=e.getState();if(!lj(t)){const n=ao(t),i=t.specialised_objects.knowledge_views_by_id[(n==null?void 0:n.default_knowledge_view_id)||""],o=t.derived.knowledge_views[0],s=i||o,r=t.controls.display_side_panel,a=hs(t);if(!s)return;const c=dj(t,s,r,a),l={subview_id:s.id,...c};e.dispatch(S.routing.change_route({args:l}))}}function lj(e){const{subview_id:t}=e.routing.args;return!!e.specialised_objects.knowledge_views_by_id[t]}function dj(e,t,n,i){let o=Qw(e,t);o=Jc(e,o);const{wcomponents_by_id:s}=e.specialised_objects,r=e.routing.item_id||"",{created_at_ms:a}=e.routing.args,{selected_wcomponent_ids_set:c}=e.meta_wcomponents,l=zi({current_composed_knowledge_view:o,wcomponents_by_id:s,initial_wcomponent_id:r,selected_wcomponent_ids_set:c,created_at_ms:a,disable_if_not_present:!1,display_side_panel:n,display_time_sliders:i});return{x:0,y:0,z:0,...l.positions[0],created_at_ms:l.go_to_datetime_ms}}function uj(e){const t=e.getState();if(!t.sync.ready_for_reading||t.derived.knowledge_views.length)return;const n=pt(t);if(n===void 0){console.error("Can not create knowledge view without chosen_base_id");return}const i=We({title:"All",base_id:n});e.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:i}))}function pj(e){const t=new Set(["wcomponents","knowledge_views"]);let n=[],i=[];if(e){const r=Object.keys(e).filter(l=>!t.has(l));if(r.length)throw new Error(`Unexpected keys "${r.join(", ")}" in specialised objects state`);const a=Array.from(t).filter(l=>!Object.hasOwnProperty.call(e,l));if(a.length)throw new Error(`Expected keys "${a.join(", ")}" missing in specialised objects state`);n=e.wcomponents.map(Tl);const c=new Set(n.map(({id:l})=>l));i=e.knowledge_views.map(l=>Al(l,c,!0))}return{wcomponents:n,knowledge_views:i}}function mj(e){try{return pj(e)}catch(t){throw console.error("Error parsing specialised objects state from server"),t}}async function fj(e,t){if(!e)return Promise.resolve(L3);const n=Ce(),i=await yw({supabase:n,base_id:t});if(i.error)return Promise.reject(i.error);const o=await WA({supabase:n,base_id:t});if(o.error)return Promise.reject(o.error);const s=await HA({supabase:n,base_id:t,knowledge_views:i.value,wcomponents:o.wcomponents});if(s.error)return Promise.reject(s.error);const r=await DA({supabase:n,knowledge_views:i.value,wcomponents_from_other_bases:s.wcomponents});if(r.error)return Promise.reject(r.error);const a=[...o.wcomponents,...s.wcomponents],c=[...i.value,...r.value];return Promise.resolve({knowledge_views:c,wcomponents:a})}function Gs(e){let t=e.getState();const{dispatch:n}=e,{chosen_base_id:i}=t.user_info;i!==t.sync.specialised_objects.loading_base_id&&(e.dispatch(S.specialised_object.clear_from_mem_all_specialised_objects()),i!==void 0&&(n(S.sync.update_sync_status({status:"LOADING",data_type:"specialised_objects",loading_base_id:i})),fj(e.load_state_from_storage,i).then(o=>mj(o)).then(o=>{n(S.specialised_object.replace_all_specialised_objects({specialised_objects:o})),n(S.sync.update_sync_status({status:"LOADED",data_type:"specialised_objects"})),uj(e),cj(e)}).catch(o=>{const s=Sw(o);console.error(o),n(S.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:s}))})))}function vj(e){G.user.sub("changed_bases",()=>{const{ready_for_reading:o}=e.getState().sync;o||Gs(e)}),G.user.sub("changed_chosen_base_id",()=>Gs(e));const t=e.getState(),{user:n,chosen_base_id:i}=t.user_info;n&&i!==void 0&&Gs(e),hj(e)}function hj(e){const t=Ce(),n=Iw(async()=>{const i=e.getState();if(!i.sync.wcomponent_ids_to_search_for_in_any_base.size)return;const o=Array.from(i.sync.wcomponent_ids_to_search_for_in_any_base);e.dispatch(S.sync.searching_for_wcomponents_by_id_in_any_base());const s=await xw({supabase:t,ids:o});e.dispatch(S.sync.searched_for_wcomponents_by_id_in_any_base({ids:o})),e.dispatch(S.specialised_object.add_wcomponents_to_store({wcomponents:s.wcomponents}))},50);e.subscribe(()=>{const i=e.getState();i.sync.ready_for_reading&&i.sync.wcomponent_ids_to_search_for_in_any_base.size&&n.throttled()}),G.user.sub("changed_chosen_base_id",()=>{n.cancel()})}function gj(e,t){if(e&&pw(t))return!0}function wj(e,t){let n=performance.now();const i=30*1e3;window.onbeforeunload=()=>{const o=t.getState();let s=gj(e,o);return s&&(s=performance.now()-n>i),s&&(n=performance.now()),s}}async function bj(e){const n=await Ce().from("bases").select("*, access_controls(access_level,user_id)").order("inserted_at",{ascending:!0}),i=n.data?n.data.map(o=>kj(o,o.access_controls,e)):void 0;return{error:n.error,data:i}}async function yj(e){const{owner_user_id:t,title:n="Primary"}=e,o=await Ce().from("bases").insert({owner_user_id:t,title:n}).select();return{base:o.data&&o.data[0]||void 0,error:o.error}}function wb(e){return{id:e.id,inserted_at:e.inserted_at,updated_at:e.updated_at,owner_user_id:e.owner_user_id,public_read:e.public_read,title:e.title,default_knowledge_view_id:e.default_knowledge_view_id}}function kj(e,t,n){let{inserted_at:i,updated_at:o}=e;const{owner_user_id:s,public_read:r}=e;i=new Date(i),o=new Date(o);const a=t==null?void 0:t.find(d=>d.user_id===n),c=(a==null?void 0:a.access_level)||(n===s?"owner":r?"viewer":"none"),l=c==="owner"||c==="editor";return{...wb(e),inserted_at:i,updated_at:o,access_level:c,can_edit:l}}async function xj(e){const t=wb(e);return await Ce().from("bases").update(t).eq("id",t.id)}async function el(e,t=!1){e||(e=Ae()),t&&e.dispatch(S.user_info.update_bases({bases:void 0}));const{user:n}=e.getState().user_info;e.dispatch(S.sync.update_sync_status({status:"LOADING",data_type:"bases"}));const{data:i,error:o}=await bj(n==null?void 0:n.id);e.dispatch(S.user_info.update_bases({bases:i}));const s=o?"FAILED":"LOADED";return e.dispatch(S.sync.update_sync_status({status:s,data_type:"bases"})),{error:o||void 0}}function Sj(e){if(!e.load_state_from_storage)return;const t=e.getState(),{users_by_id:n}=t.user_info;n||qu(e),G.user.sub("changed_user",()=>{var s;(s=ao(e.getState()))!=null&&s.public_read||e.dispatch(S.specialised_object.clear_from_mem_all_specialised_objects()),G.user.pub("stale_users_by_id",!0),G.user.pub("stale_bases",!0)}),G.user.sub("stale_users_by_id",s=>{s&&e.dispatch(S.user_info.set_users({users:void 0})),qu(e)}),G.user.sub("stale_bases",s=>{el(e,s)});let i=!0;const o=Ce();o.auth.onAuthStateChange(()=>{setTimeout(async()=>{const s=e.getState().user_info.user,a=(await o.auth.getUser()).data.user||void 0;(s==null?void 0:s.id)!==(a==null?void 0:a.id)?e.dispatch(S.user_info.set_user({user:a})):i&&el(e),i=!1},0)})}async function qu(e){const t=Ce(),{data:n,error:i}=await t.from("users").select();i&&console.error("Error getting users",i),n&&e.dispatch(S.user_info.set_users({users:n}))}let Ks;function Ae(e={}){const{use_cache:t=!0,override_preloaded_state:n={},load_state_from_storage:i=!1}=e;if(Ks&&t)return Ks;const o={...gb(),...n},s=mb(o),r=nk(s,o);r.load_state_from_storage=i,Ks=r;const a=()=>{const c=r.getState();W3(c),Tw(r)};return r.subscribe(a),wj(i,r),r.subscribe($C(r)),r.subscribe(QC(r)),r3(r),w3(r),f3(r),yx(r),A3(r),NC.sync_storage_location_subscriber(r),Sj(r),vj(r),n3(r),s3(r),r}const bb="VAP_uncertainty_id__undefined__",yb="VAP_false_id__undefined__";function Aj(e,t){let n=t===E.boolean?e.entries.slice(0,1):e.entries;return n=$j(n,t),{...e,entries:n}}function $j(e,t){if(t===E.boolean){const n=e[0];if(!n)return e;const i={...n,probability:1-n.probability,id:yb,value_id:we.boolean_false,description:""};e=[{...n,value_id:we.boolean_true},i]}return e}function Cj(e,t){const n=1-e,i={VAP_id:bb,value_id:we.uncertainty,value_text:"?",certainty:n,parsed_value:null};return[...t,i]}function gs(e){const{VAP_set_id_to_counterfactual_v2_map:t}=e;let{VAP_set:n}=e;const i=(t==null?void 0:t[n.id])||[];let o=!1,s;return i.forEach(r=>{const{target_VAP_id:a}=r;a&&(n=jj(n,a),o=!0,s=r.id)}),{...n,has_any_counterfactual_applied:o,active_counterfactual_v2_id:s}}function jj(e,t){const n=t===bb?0:1,i={...e.shared_entry_values,conviction:n},o=e.entries.map(s=>{const r=s.id===t?1:0;return{...s,probability:r,relative_probability:0,conviction:n}});return{...e,shared_entry_values:i,entries:o,target_VAP_id:t}}function ws(e,t){const n=e[0];return t===E.boolean&&n?[n]:e.sort((i,o)=>i.probability>o.probability?-1:i.probability<o.probability?1:0)}function An(e){const{wcomponent:t,VAP_set_id_to_counterfactual_v2_map:n,created_at_ms:i,sim_ms:o}=e;if(!Ke(t))return{most_probable_VAP_set_values:[],not_allowed_VAP_set_values:!0};const r=oe(t,{}),{values_and_prediction_sets:a=[]}=t,{present_item:c}=xn({items:a,created_at_ms:i,sim_ms:o}),l=c===void 0?void 0:gs({VAP_set:c,VAP_set_id_to_counterfactual_v2_map:n}),{most_probable_VAP_set_values:d,any_uncertainty:p}=Tj(l,r);let f=[l==null?void 0:l.active_counterfactual_v2_id,t._derived__using_value_from_wcomponent_id].filter(me);return f=f.length?f:void 0,{most_probable_VAP_set_values:d,any_uncertainty:p,counterfactual_applied:l==null?void 0:l.has_any_counterfactual_applied,derived__using_value_from_wcomponent_ids:f}}function Tj(e,t){if(!e||e.entries.length===0)return{most_probable_VAP_set_values:[],any_uncertainty:!1};const n=ws(e.entries,t);let i=!1,o=[];for(const s of n){const r=bl(s,t),a=Lw(s),c=G3(s);if(i=i||c,t===E.boolean||c||s.probability!==0){const d={probability:s.probability,conviction:s.conviction,certainty:a,original_value:s.value,parsed_value:r,value_id:s.value_id};if(s.probability===1&&s.conviction===1){i=!1,o=[d];break}o.push(d)}}return{most_probable_VAP_set_values:o,any_uncertainty:i}}function Ll(e,t){let n="",i="";if(Qe(e)){const{value_possibilities:o={}}=e,s=o[we.boolean_true],r=o[we.boolean_false];n=(s==null?void 0:s.value)||n,i=(r==null?void 0:r.value)||i}return n=n?t?n+" (True)":n:"True",i=i?t?i+" (False)":i:"False",{true:n,false:i}}function kb(e,t){let n;return typeof e=="boolean"?n=e?t.true:t.false:n=`${e}`,n}function bs(e){const{most_probable_VAP_set_values:t,any_uncertainty:n,counterfactual_applied:i,derived__using_value_from_wcomponent_ids:o}=An(e),s=Ll(e.wcomponent),r=[];t.forEach(l=>{const d=kb(l.parsed_value,s);r.push(d)});const a=t.length>0,c=Pj(r);return a?{values_string:c,counterfactual_applied:i,uncertain:n,derived__using_values_from_wcomponent_ids:o}:void 0}const Ys=3;function Pj(e){let t=e.slice(0,Ys).join(", ").trim()||"not defined";return e.length>Ys&&(t+=`, (${e.length-Ys} more)`),t}function Nj(e){let t="";if(ye(e.wcomponent)){const n=e.wcomponents_by_id[e.wcomponent.from_id],i=e.wcomponents_by_id[e.wcomponent.to_id];(n||i)&&(t=`${n?"@@"+n.id:"_"} -> ${i?"@@"+i.id:"_"} <auto generated>`)}else if(vl(e.wcomponent)){t="Counterfactual (no target set) <auto generated>";const n=e.wcomponent.target_wcomponent_id;n&&(t=`Counterfactual of: @@${n} <auto generated>`)}else if(oo(e.wcomponent)){t="Sub state (no target set) <auto generated>";const{target_wcomponent_id:n,selector:i}=e.wcomponent;if(n){if(t=`Sub state of @@${n}`,i!=null&&i.target_value&&(i!=null&&i.target_value_id_type)){const{target_value:o,target_value_id_type:s}=i;let r="";if(s==="id"){const a=e.wcomponents_by_id[n];if(Xk(a)){const c=((a==null?void 0:a.value_possibilities)||{})[o];c&&(r=c.value)}}else r=o;t+=": "+r}t+=" <auto generated>"}}else if(gt(e.wcomponent)){t="State value (no target attribute set) <auto generated>";const{attribute_wcomponent_id:n}=e.wcomponent;n&&(t=n?`Alternative state value for @@${n} `:"No target attribute ",t+="<auto generated>")}return t}const Ej=(e,t)=>`✗${e} (${t})`,xb=(e,t,n="")=>`${e}#wcomponents/${t}`+(n?`&subview_id=${n}`:""),Yo=(e,t,n="□",i="")=>`[${n}](${xb(e,t,i)})`;function Sb(e,t,n){const{get_title:i,root_url:o,render_links:s,depth_limit:r}=n;if(t>=r)return e;const a=Ij(e);return a.length===0||(a.forEach(({id:c,funktion:l})=>{const d=n.wcomponents_by_id[c];if(!Oj(l))return;let p="";if(l==="map"){const m=n.knowledge_views_by_id[c],v=(m==null?void 0:m.title)||c;p=Yo(o,d?c:"",v,c)}else if(d)if(l==="url")p=xb(o,c);else if(l==="value"){const m=new Date().getTime(),v=bs({wcomponent:d,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:m,sim_ms:m});p=(v==null?void 0:v.values_string)||""}else p=s?Yo(o,c):"",l==="title"?p=i(d):l==="description"&&(p+=d.description);else return;const f=new RegExp(`@@${c}.${l}`,"g");e=e.replace(f,p)}),t<r&&(e=Sb(e,t+1,n))),e}function Ij(e){return[...e.matchAll(Ek),...e.matchAll(Nk)].map(n=>({id:n[1].slice(2),funktion:n[2]}))}const Dj={url:!0,title:!0,description:!0,map:!0,value:!0},Rj=new Set(Object.keys(Dj));function Oj(e){return Rj.has(e)}function Zt(e,t,n){const{root_url:i,depth_limit:o,get_title:s,render_links:r}=n;return bn(e).forEach(c=>{const l=new RegExp(`@@${c}`,"g"),d=n.wcomponents_by_id[c];if(!d){const m=r?Yo(i,c,`@@${c}`):`@@${c}`;e=e.replace(l,Ej(m,"not found"));return}const p=t<o?s(d):`@@${c}`,f=r?Yo(i,c,p):p;e=e.replace(l,f)}),e}const Mj=3;var fe=(e=>(e[e.raw=0]="raw",e[e.plain=1]="plain",e[e.rich=2]="rich",e))(fe||{});function mt(e){const{wcomponent:t,wc_id_to_counterfactuals_map:n,created_at_ms:i,sim_ms:o}=e,s=e.text_type??2;let r=t.title;if(r||(r=Nj(e)),s===0)return r;const a=qj({text:r,wcomponent:t,wc_id_to_counterfactuals_map:n,created_at_ms:i,sim_ms:o});return ni({...e,text:a,text_type:s})}function qj(e){var r;let{text:t}=e;const{wcomponent:n,wc_id_to_counterfactuals_map:i={}}=e;if(!t.includes("${value}"))return t;const o=(r=i[n.id])==null?void 0:r.VAP_sets,s=bs({wcomponent:n,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return s&&(t=t.replace(/\$\{value\}/g,`${s.values_string}`)),t}function ni(e){const{text:t,text_type:n,wcomponents_by_id:i,knowledge_views_by_id:o,depth_limit:s=Mj,current_depth:r=0,root_url:a="",wc_id_to_counterfactuals_map:c,created_at_ms:l,sim_ms:d}=e;return n===0?t:Vj(t,n,i,o,s,r,a,c,l,d)}function Vj(e,t,n,i,o,s,r,a,c,l){t=t===2?s===0?2:1:t;function d(f){return mt({text_type:t,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:a,created_at_ms:c,sim_ms:l,depth_limit:o,current_depth:s+1,root_url:r,wcomponent:f})}const p={wcomponents_by_id:n,knowledge_views_by_id:i,depth_limit:o,render_links:t===2,root_url:r,get_title:d};return e=Sb(e,s,p),e=Zt(e,s,p),e}const Ab=[{source:/^Degree$/i,targetString:"Degrees"},{source:/^Radians?$/i,targetString:"Degrees"},{source:/^Ampere$/i,targetString:"Amperes"},{source:/^Gram$/i,targetString:"Grams"},{source:/^Second$/i,targetString:"Seconds"},{source:/^Meter$/i,targetString:"Meters"},{source:/^(Meters? ?Squared?|Squared? ?Meters?)$/i,targetString:"Meters^2"},{source:/^(Centimeters? ?Squared?|Squared? ?Centimeters?)$/i,targetString:"Centimeters^2"},{source:/^(Centimeters? ?Cubed?|Cubic ?Centimeters?)$/i,targetString:"Centimeters^3"},{source:/^(Meters? Cubed?|Cubic ?Meters?)$/i,targetString:"Meters^3"},{source:/^(Kilometers? ?Cubed?|Cubic ?Kilometers?)$/i,targetString:"Kilometers^3"},{source:/^(Inches? Squared?|Squared? ?Inches?)$/i,targetString:"Inches^2"},{source:/^(Miles? ?Squared?|Squared? ?Miles?)$/i,targetString:"Miles^2"},{source:/^(Kilometers? Squared?|Squared? ?Kilometers?)$/i,targetString:"Kilometers^2"},{source:/^Acre? ?(Feet|Foot)$/i,targetString:"Acres,Feet"},{source:/^Meters? ?per ?Seconds?$/i,targetString:"Meters,Seconds^-1"},{source:/^Meters? ?per ?Seconds? ?Squared?$/i,targetString:"Meters,Seconds^-2"},{source:/^(Foot|Feet) ?per ?Seconds?$/i,targetString:"Feet,Seconds^-1"},{source:/^(Foot|Feet) ?per ?Seconds? ?Squared?$/i,targetString:"Feet,Seconds^-2"},{source:/^Miles? ?per ?Hours?$/i,targetString:"Miles,Hours^-1"},{source:/^Miles? ?per ?Hours? ?Squared?$/i,targetString:"Miles,Hours^-2"},{source:/^Kilometers? ?per ?Hours?$/i,targetString:"Kilometers,Hours^-1"},{source:/^Kilometers? ?per ?Hours? ?Squared?$/i,targetString:"Kilometers,Hours^-2"},{source:/^Liters? ?per ?Seconds?$/i,targetString:"Liters,Seconds^-1"},{source:/^(Cubic ?Meters?|Meters? ?Cubed?) ?per ?Seconds?$/i,targetString:"Meters^3,Seconds^-1"},{source:/^(Squared? ?Yards?|Yards? ?Squared?)$/i,targetString:"Yards^2"},{source:/^(Squared? ?(Feet|Foot)|(Feet|Foot) ?Squared?)$/i,targetString:"Feet^2"},{source:/^(Squared? Millimeters?|Millimeters? ?Squared?)$/i,targetString:"Millimeters^2"},{source:/^(Millimeters? ?Cubed?|Cubic ?Millimeters?)$/i,targetString:"Millimeters^3"},{source:/^Gallons? ?per ?Seconds?$/i,targetString:"Gallons,Seconds^-1"},{source:/^Gallons? ?per ?Minutes?$/i,targetString:"Gallons,Minutes^-1"},{source:/^Pounds? ?per ?Seconds?$/i,targetString:"Pounds,Seconds^-1"},{source:/^Kilograms? ?per ?Seconds?$/i,targetString:"Kilograms,Seconds^-1"},{source:/^Dollars? ?per ?Seconds?$/i,targetString:"Dollars,Seconds^-1"},{source:/^Dollars? ?per ?Hours?$/i,targetString:"Dollars,Hours^-1"},{source:/^Dollars? ?per ?Days?$/i,targetString:"Dollars,Days^-1"},{source:/^Dollars? ?per ?Weeks?$/i,targetString:"Dollars,Weeks^-1"},{source:/^Dollars? ?per ?Months?$/i,targetString:"Dollars,Months^-1"},{source:/^Dollars? ?per ?Quarters?$/i,targetString:"Dollars,Quarters^-1"},{source:/^Dollars? ?per ?Years?$/i,targetString:"Dollars,Years^-1"},{source:/^Euros? ?per ?Seconds?$/i,targetString:"Euros,Seconds^-1"},{source:/^Euros? ?per ?Hours?$/i,targetString:"Euros,Hours^-1"},{source:/^Euros? ?per ?Days?$/i,targetString:"Euros,Days^-1"},{source:/^Euros? ?per ?Weeks?$/i,targetString:"Euros,Weeks^-1"},{source:/^Euros? ?per ?Months?$/i,targetString:"Euros,Months^-1"},{source:/^Euros? ?per ?Quarters?$/i,targetString:"Euros,Quarters^-1"},{source:/^Euros? ?per ?Years?$/i,targetString:"Euros,Years^-1"},{source:/^Centimeters?$/i,targetString:"Meters"},{source:/^Millimeters?$/i,targetString:"Meters"},{source:/^Kilometers?$/i,targetString:"Meters"},{source:/^Inch(es)?$/i,targetString:"Meters"},{source:/^(Foot|Feet)$/i,targetString:"Meters"},{source:/^Yards?$/i,targetString:"Meters"},{source:/^Miles?$/i,targetString:"Meters"},{source:/^Acres?$/i,targetString:"Meters^2"},{source:/^Hectares?$/i,targetString:"Meters^2"},{source:/^Liters?$/i,targetString:"Meters^3"},{source:/^Gallons?$/i,targetString:"Meters^3"},{source:/^Quarts?$/i,targetString:"Meters^3"},{source:/^Fluid ?Ounces?$/i,targetString:"Meters^3"},{source:/^Years?$/i,targetString:"Seconds"},{source:/^Quarters?$/i,targetString:"Seconds"},{source:/^Months?$/i,targetString:"Seconds"},{source:/^Weeks?$/i,targetString:"Seconds"},{source:/^Days?$/i,targetString:"Seconds"},{source:/^Hours?$/i,targetString:"Seconds"},{source:/^Minutes?$/i,targetString:"Seconds"},{source:/^Kilograms?$/i,targetString:"Grams"},{source:/^Milligrams?$/i,targetString:"Grams"},{source:/^Ounces?$/i,targetString:"Grams"},{source:/^Pounds?$/i,targetString:"Grams"},{source:/^Tonnes?$/i,targetString:"Grams"},{source:/^Tons?$/i,targetString:"Grams"},{source:/^Watts?$/i,targetString:"Joules,Seconds^-1"},{source:/^Kilowatts?$/i,targetString:"Watts"},{source:/^Megawatts?$/i,targetString:"Watts"},{source:/^Gigawatts?$/i,targetString:"Watts"},{source:/^Calories?$/i,targetString:"Joules"},{source:/^Kilocalories?$/i,targetString:"Joules"},{source:/^(BTUs?|British ?Thermal ?units?)$/i,targetString:"Joules"},{source:/^Kilojoules?$/i,targetString:"Joules"},{source:/^Joules?$/i,targetString:"Newtons,Meters"},{source:/^Coulombs?$/i,targetString:"Amperes,Seconds"},{source:/^Volts?$/i,targetString:"Watts,Amperes^-1"},{source:/^Millivolts?$/i,targetString:"Volts"},{source:/^Kilovolts?$/i,targetString:"Volts"},{source:/^Newtons?$/i,targetString:"Kilograms,Meters,Seconds^-2"},{source:/^Pounds? ?Force$/i,targetString:"Pounds,Feet per Second Squared"},{source:/^Atoms?$/i,targetString:"Moles"},{source:/^Molecules?$/i,targetString:"Moles"},{source:/^Farads?$/i,targetString:"Joules,Volts^-2"},{source:/^Pascals?$/i,targetString:"Newton,Meters^-2"},{source:/^Kilopascals?$/i,targetString:"Pascals"},{source:/^Bars?$/i,targetString:"Pascals"},{source:/^Atmospheres?$/i,targetString:"Pascals"},{source:/^Pounds? ?per ?Squared? ?Inch(es)?$/i,targetString:"Pascals"}],Fj=new Set(Ab.map(e=>e.targetString.toLowerCase()));function tl(e,t){const{expected_units:n,actual_units:i}=e,o=ht(n,!0,t),s=ht(i,!0,t),r=[],a=new Set;function c(f){const m=f.replace(/s$/g,""),v=m+"s";return a.has(m)||a.has(v)?!1:s.has(m)||s.has(v)?(a.add(m),a.add(v),r.push({name:m,scale:1,target:v}),!1):!0}const l=Array.from(o).filter(f=>c(f)),d=Array.from(s).filter(f=>c(f)),p=new Set(l.concat(d));return{suggested_custom_units:r,unhandled_units:p}}function ht(e,t,n){const i=e.toLowerCase().replace(/[()]/g," ").split(/[*/]/g).map(o=>{if(o=o.trim(),o===""||o==="unitless")return;if(i2.has(o)||Fj.has(o))return t?void 0:o;const s=Ab.find(a=>a.source.test(o));if(s)return t?void 0:s.targetString.toLowerCase();const r=n.find(a=>a.name.toLowerCase()===o||a.target.toLowerCase()===o);return r?t?void 0:r.target.toLowerCase():o}).filter(o=>o!==void 0);return new Set(i)}function H(e,t,n){const i={};return e.map(s=>{const r=new ik({timeStart:2020,timeLength:1,timeUnits:"Years"});n&&(r.customUnits=n);const a=bn(s.value);let c=Zn(s.value);c=pn(c),c=Hc(c);let l=s.units;l=Xn(c,l,t),l=Hc(l||""),c=Ue(c,a);const d={name:s.name,value:c,units:l},p=r.Variable(d),{warnings:f,errors:m}=zj({model:r,model_component:p,values:i,uuids:a,wcomponents_by_id:t}),v=$b(r,s.units,p);return a.length===1&&(v.source_wcomponent_id=a[0]),f.length&&(v.warning=f.join(" ")),m.length&&(v.error&&m.unshift(v.error),v.error=m.join(`
`)),i[s.name]=v,v}).map(s=>(s.units=Ko(s.units),s.error&&(s.error=Ko(s.error)),s))}function zj(e){const{model:t,model_component:n,values:i,uuids:o,wcomponents_by_id:s}=e,r={};Object.entries(i).forEach(([p,f])=>{if(f.value!==void 0){const m=t.Variable({name:p,value:f.value,units:f.units});r[p]=m}});const a=new Date().getTime(),c=[],l=[];return o.map(p=>{const f=s[p];if(!f)return l.push(`Could not find wcomponent with id: @@${p}.  Defaulting to value of 1.`),p;const{most_probable_VAP_set_values:m,not_allowed_VAP_set_values:v}=An({wcomponent:f,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:a,sim_ms:a}),h=mt({wcomponent:f,wcomponents_by_id:s,knowledge_views_by_id:{},wc_id_to_counterfactuals_map:void 0,created_at_ms:a,sim_ms:a})||"no title";if(f.type==="action"||v)return c.push(`The wcomponent "${h}" (@@${p}) is of type "${f.type}".  Defaulting to value of 1.`),p;if(m.length===0)return c.push(`The wcomponent "${h}" (@@${p}) is missing any value and prediction sets.  Defaulting to value of 1.`),p;let w=m[0].parsed_value;if(w===null)return c.push(`The wcomponent "${h}" (@@${p}) has an invalid number "${m[0].original_value}".  Defaulting to value of 1.`),p;if(Number.isNaN(w))return c.push(`The wcomponent "${h}" (@@${p}) has an invalid number "${m[0].original_value}".  Defaulting to value of 1.`),p;typeof w=="boolean"&&(w=w?1:0);const b=t.Variable({name:p,value:w,units:""});return r[p]=b,""}).filter(p=>p.length>0).forEach(p=>{const f=t.Variable({name:p,value:1,units:""});r[p]=f}),Object.values(r).forEach(p=>{t.Link(p,n)}),{warnings:c,errors:l}}function $b(e,t,n,i=!1){let o,s=!1,r="",a=n._node.getAttribute("Units");try{o=e.simulate()._data.data[0][n._node.id]}catch(l){const d=l;if(s=nl(d),!t&&s&&!i){a=s.actual_units,n.units=a;const p=$b(e,t,n,!0);({value:o,units:a}=p),p.error&&(r=p.error)}else r=`${d.message||"Unknown calculation error"}`}const c={value:o,error:r,units:a};if(c.error||delete c.error,s){const{suggested_custom_units:l}=tl(s,[]);l.length>0&&(c.suggested_custom_units=l)}return c.units==="Unitless"&&(c.units=""),c}function nl(e){const t=typeof e.message=="string"&&e.message.startsWith("Wrong units generated for")&&(e.message.match(/Expected (.+?),? and got (.+?)\.(?:$| Either)/)||!1);if(!t)return!1;let n=t[1];return n==="no units"&&(n=""),{expected_units:n,actual_units:t[2]}}const Lj=x.delay("perform_calculations",()=>{let e=[],t=[],n=[],i,o;x("basic functionality",()=>{e=[];const c={};n=[],t=H(e,c),u(t,n,"No calculations should return no results"),e=[{id:0,name:"A",value:"3"},{id:1,name:"B",value:"4"},{id:2,name:"C",value:"[A] + [B]"}],t=H(e,c),n=[{value:3,units:""},{value:4,units:""},{value:7,units:""}],u(t,n,"3 simple calculations should return 3 results"),e=[{id:0,name:"A",value:"3 + 1"},{id:1,name:"C",value:"[A] + [some_undeclared_variable]"},{id:2,name:"D",value:"5 + 1"}],t=H(e,c),n=[{value:3+1,units:""},{value:void 0,error:"The primitive [some_undeclared_variable] could not be found.",units:""},{value:5+1,units:""}],u(t,n,"Failure to find a value should still perform other valid calculations"),e=[{id:0,name:"A",value:"1 + 1"},{id:1,name:"A",value:"[A] * 2"},{id:2,name:"A",value:"[A] * 2"}],t=H(e,c),n=[{value:1+1,units:""},{value:4,units:""},{value:8,units:""}],u(t,n,"Can cope with self reference"),e=[{id:0,name:" A ",value:"1 + 1"},{id:1,name:"B",value:"[ A ] * 2"}],t=H(e,c),n=[{value:1+1,units:""},{value:4,units:""}],u(t,n,"Can cope with references with spaces")}),x("formatting functionality",()=>{const c={};n=[],t=H(e,c),e=[{id:0,name:"A",value:"3,000,100.200"}],t=H(e,c),n=[{value:30001002e-1,units:""}],u(t,n,"Should be able to ignore commas")});const s=le(1),r=0;let a;x("Can use wcomponent values",()=>{a=Ie(E.number,void 0,[],r),a.entries[0].value="12.3";const c=q({base_id:r,id:s,title:"Some state component",type:"statev2",values_and_prediction_sets:[a],units:"seconds"}),l={[s]:c};e=[{id:0,name:"A",value:`@@${s}`,units:"meters"}],t=H(e,l),n=[{value:12.3,units:"seconds",source_wcomponent_id:s}],u(t,n,"Can access a wcomponent's value and overrides any units given in calculation with wcomponent's units"),e=[{id:0,name:"A",value:`@@${s} * 10`,units:"meters"}],t=H(e,l),n=[{value:123,units:"meters",source_wcomponent_id:s}],u(t,n,"Can reference wcomponent values in a calculation and uses units given, overriding components units"),e=[{id:0,name:"A",value:`@@${s} * @@${s}`,units:"meters"}],t=H(e,l),n=[{value:151.29,units:"meters"}],u(t,n,"Can reference same wcomponent values in a calculation but then will not give a reference to the original wcomponent i.e. wcomponent_id will be undefined"),e=[{id:0,name:"A",value:`{@@${s} meters}`}],t=H(e,l),n=[{value:12.3,units:"meters",source_wcomponent_id:s}],u.skip(t,n,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Calculations can reference wcomponent values and assign units~~"),e=[{id:0,name:"A",value:`@@${s}.value`,units:"meters"}],t=H(e,l),n=[{value:void 0,units:"meters",source_wcomponent_id:s,error:"Object function not used on object"}],u(t,n,'Can not currently access the ".value" of a component in an equation')}),x("Can use wcomponent boolean values",()=>{a=Ie(E.boolean,void 0,[],r),u(a.entries[1].value_id,we.boolean_false,"Test is setting the correct VAP set entry"),a.entries[1].probability=1;const c={[s]:q({base_id:r,id:s,type:"statev2",subtype:"boolean",values_and_prediction_sets:[a]})};e=[{id:0,name:"A",value:`IfThenElse(@@${s}, 15, 10)`}],t=H(e,c),n=[{value:10,units:"",source_wcomponent_id:s}],u(t,n,"Can use wcomponent boolean values")}),x("Can use values with units",()=>{e=[{id:0,name:"A",value:"{2 Meters} + {10 Centimeters}",units:"Meters"}],t=H(e,{}),n=[{value:2.1,units:"Meters"}],u(t,n,"Computes correct value and includes units in result")}),x("Can use values without units being initially defined",()=>{e=[{id:0,name:"A",value:"{2 Meters}"}],t=H(e,{}),n=[{value:2,units:"Meters"}],u(t,n,"Computes correct units")}),x("Can use values with units initially being undefined",()=>{e=[{id:0,name:"A",value:"{2 Meters}",units:void 0}],t=H(e,{}),n=[{value:2,units:"Meters"}],u(t,n,"Computes correct units")}),x("Does not compute units if some are already specified",()=>{e=[{id:0,name:"A",value:"{2 Meters}",units:"kg"}],t=H(e,{}),n=[{value:void 0,units:"kg",error:"Wrong units generated for [A]. Expected Kg, and got Meters."}],u(t,n,"Computes correct units")}),x("Handling custom and missing puralisation of units",()=>{e=[{id:0,name:"number of days per person",value:"1",units:"days / person"},{id:1,name:"number of seconds per person",value:"[number of days per person]",units:"seconds / person"}],t=H(e,{}),n=[{value:1,units:"days / person"},{value:86400,units:"seconds / person"}],u(t,n,"Forces conversion of units"),e=[{id:0,name:"trades people",value:"180,000",units:"people"},{id:1,name:"people days per home",value:"30",units:"people * days / home"},{id:2,name:"days per year",value:"250",units:"days / year"},{id:3,name:"",value:"([trades people] * [days per year]) / [people days per home]",units:"Home / Year"}],t=H(e,{}).slice(-1),n=[{value:15e5,units:"Home / Year"}],u(t,n,"Computes correct units"),e=[{id:0,name:"trades people",value:"180,000",units:"people"},{id:1,name:"people days per home",value:"30",units:"people * days / home"},{id:2,name:"days per year",value:"250",units:"days / year"},{id:3,name:"",value:"([trades people] * [days per year]) / [people days per home]",units:"Homes / Year"}];let c=[];i=H(e,{},c).pop(),o={error:"Wrong units generated for [New Variable]. Expected Homes/(Year), and got Home/(Seconds).",units:"Homes / Year",suggested_custom_units:[{name:"home",scale:1,target:"homes"}],value:void 0},u(i,o,"Will fail to handle custom units when not given"),c=[{name:"Homes",scale:1,target:"Home"}],i=H(e,{},c).pop(),o={value:15e5,units:"Homes / Year"},u(i,o,"Can set custom units in either order, test 1"),c=[{name:"Home",scale:1,target:"Homes"}],i=H(e,{},c).pop(),o={value:15e5,units:"Homes / Year"},u(i,o,"Can set custom units in either order, test 2"),c=[{name:"HoMe",scale:1,target:"hOmEs"}],i=H(e,{},c).pop(),o={value:15e5,units:"Homes / Year"},u(i,o,"Can set custom units with mixed case"),e=[{id:0,name:"trades people",value:"180,000",units:"people"},{id:1,name:"people days per home",value:"30",units:"people * days / home"},{id:2,name:"days per year",value:"250",units:"days / year"},{id:3,name:"",value:"([trades people] * [days per year]) / [people days per home]",units:"UK Dwellings / Year"}],c=[{name:"home",scale:1,target:"homes"},{name:"UK Dwellings",scale:1,target:"homes"}],i=H(e,{},c).pop(),o={value:15e5,units:"UK Dwellings / Year"},u(i,o,"Can handle custom units with spaces in them")}),x(`Sets units to "" if 'Unitless' is specified`,()=>{e=[{id:0,name:"A",value:"2",units:"Unitless"}],t=H(e,{}),n=[{value:2,units:""}],u(t,n,'Computes correct units of "" when "Unitless" is specified'),e=[{id:0,name:"A",value:"{2 Meters}",units:"Unitless"}],t=H(e,{}),n=[{value:void 0,units:"",error:"Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."}],u(t,n,'Computes correct units of "" when "Unitless" is specified as the units even though it conflicts with units given in calculation')}),x("Can process numbers with thousands comma seperators",()=>{e=[{id:0,name:"A",value:"1,200,300e4 / {4,001,000e3 km}",units:"1/km"}],t=H(e,{}),n=[{value:3,units:"1/km"}],u(t,n,"Can compute numbers with thousands commas")}),x("Can process numbers with compound units",()=>{e=[{id:0,name:"A",value:"{7 Widgets/Years^2}*{10 Years}",units:"Widgets/Years"}],t=H(e,{}),n=[{value:70,units:"Widgets/Years"}],u(t,n,"Widgets/Years^2  *  Years")}),x("hide_currency_symbols",()=>{e=[{id:0,name:"A",value:"{90 £ / year}",units:""},{id:1,name:"B",value:"{10 £ / year}",units:""},{id:2,name:"C",value:"[A]+[B]",units:""}],t=H(e,{}),n=[{value:90,units:"£/(Year)"},{value:10,units:"£/(Year)"},{value:100,units:"£/(Year)"}],u(t,n,"Handles currency symbols specified inside curly braces"),e=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"£ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],t=H(e,{}),n=[{value:90,units:"£ / year"},{value:10,units:"£ / year"},{value:100,units:"£ / year"}],u(t,n,"Handles currency symbols specified inside units field, and preserves them precisely"),e=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"$ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],t=H(e,{}),n=[{value:90,units:"£ / year"},{value:10,units:"$ / year"},{value:void 0,units:"£ / year",error:"Incompatible units for the addition of £/(Year) and $/(Year)."}],u(t,n,"Correctly formats currency symbols in error messages")}),x("Handles reserved words correctly",()=>{e=[{id:0,name:"A",value:"0.5 * (180 / Pi)"}],t=H(e,{}),n=[{value:28.6478897565412,units:""}],u(t,n,'Can run calculations using reserved word "Pi"')}),x("Defaults to 1 for missing or invalid or incomplete components",()=>{e=[{id:0,name:"A",value:`1 + @@${s}`}],x("Missing component",()=>{n=[{value:2,units:"",source_wcomponent_id:s,error:`Could not find wcomponent with id: @@${s}.  Defaulting to value of 1.`}],t=H(e,{}),u(t,n,"Can run calculations using missing uuids.  Will default to 1 and provide a warning.")}),x("Invalid component: action type",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) is of type "action".  Defaulting to value of 1.`}];const c={[s]:q({base_id:r,id:s,type:"action",values_and_prediction_sets:[]})};t=H(e,c),u(t,n,"Can run calculations using actions.  Will default to 1 and provide a warning.")}),x("Invalid component: statev2 with subtype number but invalid number parsed to null",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) has an invalid number "".  Defaulting to value of 1.`}],a=Ie(E.number,void 0,[],r),a.entries[0].value="";const c={[s]:q({base_id:r,id:s,type:"statev2",subtype:"number",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 with invalid number of null.  Will default to 1 and provide a warning.")}),x("Invalid component: statev2 with subtype number but invalid number parsed to NaN",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) has an invalid number "some invalid number".  Defaulting to value of 1.`}],a=Ie(E.number,void 0,[],r),a.entries[0].value="some invalid number";const c={[s]:q({base_id:r,id:s,type:"statev2",subtype:"number",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 with invalid number of NaN.  Will default to 1 and provide a warning.")}),x("Incomplete component: statev2 type with no VAP sets",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) is missing any value and prediction sets.  Defaulting to value of 1.`}];const c={[s]:q({base_id:r,id:s,type:"statev2",values_and_prediction_sets:[]})};t=H(e,c),u(t,n,"Can run calculations using statev2 with no VAPsets.  Will default to 1 and provide a warning.")})}),x("Coerces statev2 wcomponents with boolean subtype into 0 or 1",()=>{e=[{id:0,name:"A",value:`1 + @@${s}`}],x("coerces true to 1",()=>{n=[{value:2,units:"",source_wcomponent_id:s}],a=Ie(E.boolean,void 0,[],r),u(a.entries[0].value_id,we.boolean_true,"Test is setting the correct VAP set entry"),a.entries[0].probability=1;const c={[s]:q({base_id:r,id:s,type:"statev2",subtype:"boolean",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 boolean subtypes.  Will coerce true to 1 and not provide a warning.")}),x("coerces false to 0",()=>{n=[{value:1,units:"",source_wcomponent_id:s}],a=Ie(E.boolean,void 0,[],r),u(a.entries[1].value_id,we.boolean_false,"Test is setting the correct VAP set entry"),a.entries[1].probability=1;const c={[s]:q({base_id:r,id:s,type:"statev2",subtype:"boolean",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 boolean subtypes.  Will coerce false to 0 and not provide a warning.")})})}),Bj=x.delay("error_is_units_error",()=>{let e=new Error("Wrong units generated for [New Variable]. Expected Homes/(Year), and got Home/(Seconds)."),t=nl(e),n={expected_units:"Homes/(Year)",actual_units:"Home/(Seconds)"};u(t,n,"Handles units error correctly"),e=new Error("Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."),t=nl(e),n={expected_units:"",actual_units:"Meters"},u(t,n,"Handles unitless error correctly")}),Uj=x.delay("extract_units",()=>{const e="thing * kg * kg * meters / (second)";let t=ht(e,!1,[]),n=new Set(["thing","kg","meters","seconds"]);u(t,n,"Extracts units from a string"),t=ht(e,!0,[]),n=new Set(["thing","kg"]),u(t,n,"Ignores known units"),t=ht(e,!1,[{name:"kg",scale:1,target:"kilograms"}]),n=new Set(["thing","kilograms","meters","seconds"]),u(t,n,"Converts known custom units"),t=ht(e,!0,[{name:"kg",scale:1,target:"kilograms"}]),n=new Set(["thing"]),u(t,n,"Ignores known units and known custom units"),t=ht(e,!1,[{name:"KG",scale:1,target:"KILOGRAMS"}]),n=new Set(["thing","kilograms","meters","seconds"]),u(t,n,"Custom units with uppercase names are handled correctly"),t=ht(e.toUpperCase(),!1,[{name:"kg",scale:1,target:"kilograms"}]),n=new Set(["thing","kilograms","meters","seconds"]),u(t,n,"Units string units with uppercase names are handled correctly"),t=ht(e,!0,[{name:"kg",scale:1,target:"thing"}]),n=new Set([]),u(t,n,"Units that are custom unit targets are ignored"),t=ht("unitless",!1,[]),n=new Set([]),u(t,n,"unitless is ignored"),t=ht("",!1,[]),n=new Set([]),u(t,n,"no units are ignored")}),Wj=x.delay("suggest_missing_units",()=>{const e={expected_units:"niedźwiedz * Bear * Homes/Day",actual_units:"home * bears/(seconds)"};let t=[],n=tl(e,t),i={suggested_custom_units:[{name:"bear",scale:1,target:"bears"},{name:"home",scale:1,target:"homes"}],unhandled_units:new Set(["niedźwiedz"])};u(n,i,"Suggests custom units"),t=[{name:"bear",scale:1,target:"bears"},{name:"niedźwiedz",scale:1,target:"bears"}],n=tl(e,t),i={suggested_custom_units:[{name:"home",scale:1,target:"homes"}],unhandled_units:new Set},u(n,i,"Suggests custom units whilst ignoring known custom units")}),Ve={_0:0,_5:.08726646259971647,_10:.17453292519943295,_15:.2617993877991494,_20:.3490658503988659,_25:.4363323129985824,_30:.5235987755982988,_35:.6108652381980153,_40:.6981317007977318,_45:.7853981633974483,_50:.8726646259971648,_55:.9599310885968813,_60:1.0471975511965976,_65:1.1344640137963142,_70:1.2217304763960306,_75:1.3089969389957472,_80:1.3962634015954636,_85:1.48352986419518,_90:1.5707963267948966,_95:1.6580627893946132,_100:1.7453292519943295,_105:1.8325957145940461,_110:1.9198621771937625,_115:2.007128639793479,_120:2.0943951023931953,_125:2.1816615649929116,_130:2.2689280275926285,_135:2.356194490192345,_140:2.443460952792061,_145:2.530727415391778,_150:2.6179938779914944,_155:2.705260340591211,_160:2.792526803190927,_165:2.8797932657906435,_170:2.96705972839036,_175:3.0543261909900767,_180:3.141592653589793,_185:3.2288591161895095,_190:3.3161255787892263,_195:3.4033920413889422,_200:3.490658503988659,_205:3.5779249665883754,_210:3.6651914291880923,_215:3.752457891787808,_220:3.839724354387525,_225:3.9269908169872414,_230:4.014257279586958,_235:4.101523742186674,_240:4.1887902047863905,_245:4.276056667386108,_250:4.363323129985823,_255:4.4505895925855405,_260:4.537856055185257,_265:4.625122517784973,_270:4.71238898038469,_275:4.799655442984406,_280:4.886921905584122,_285:4.974188368183839,_290:5.061454830783556,_295:5.148721293383272,_300:5.235987755982989,_305:5.323254218582705,_310:5.410520681182422,_315:5.497787143782138,_320:5.585053606381854,_325:5.672320068981571,_330:5.759586531581287,_335:5.846852994181004,_340:5.93411945678072,_345:6.021385919380437,_350:6.1086523819801535,_355:6.19591884457987};function Bo(e,t,n,i){const o=i-t,s=n-e;return Math.atan2(o,s)}const Vu=Math.PI*2;function Hj(e){return e+Vu*Math.floor((Math.PI-e)/Vu)}function Gj(e,t){const n=Cb[t];return e+=1e-4,jb({connection_angle:e,angle_of_normal_to_connector_surface:n,offset_direction:-1})}function Kj(e,t){const n=Cb[t];return e+=Math.PI,jb({connection_angle:e,angle_of_normal_to_connector_surface:n,offset_direction:1})}const Fu={left:Ve._180,top:Ve._90,right:0,bottom:-Ve._90},Cb={right:Fu.right,left:Fu.left},Eo=Ve._50;function jb(e){const t=Hj(e.connection_angle-e.angle_of_normal_to_connector_surface),i=qe(t,-Eo,Eo);return qe(i,-Eo,Eo)+e.angle_of_normal_to_connector_surface}const Yj=x.skip("get_angle (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{const n=[{ex:10,ey:0},{ex:10,ey:-10},{ex:0,ey:-10},{ex:-10,ey:-10},{ex:-10,ey:0},{ex:-10,ey:10},{ex:0,ey:10},{ex:10,ey:10}],i=["0.00","-0.79","-1.57","-2.36","3.14","2.36","1.57","0.79"];n.forEach(({ex:r,ey:a},c)=>{const l=Bo(0,0,r,a).toFixed(2);u(l,i[c])});const o=["-0.79","-0.87","-0.87","-0.87","0.09","0.09","0.09","0.00"];n.forEach(({ex:r,ey:a},c)=>{const l=Bo(0,0,r,a),d=Gj(l,"right").toFixed(2);u(d,o[c])});const s=["3.93","3.14","3.05","3.05","4.01","4.01","4.01","4.01"];n.forEach(({ex:r,ey:a},c)=>{const l=Bo(0,0,r,a),d=Kj(l,"left").toFixed(2);u(d,s[c])})});function Ze(e,t){if(e===0)return 0;const n=Math.pow(10,t-Math.floor(Math.log10(Math.abs(e)))-1);return Math.round(e*n)/n}function Lt(e,t){const n=t*Math.cos(e),i=t*Math.sin(e);return{x:n,y:i}}function oi(e,t){return{x:e.x+t.x,y:e.y+t.y}}var Bt=(e=>(e[e.positive=0]="positive",e[e.negative=1]="negative",e[e.noop=2]="noop",e))(Bt||{});function Jj(e){const{type:t,x:n,y:i,end_angle:o,opacity:s,blur:r,size:a,is_hovered:c,is_highlighted:l}=e;let d=`${l?"highlighted":""} ${c?"hovered":""}`;const p=s*(1-r/100),f={fillOpacity:p};let m;t===0?m=Zj(o,a):t===1?m=t4(o,a):(f.fillOpacity=0,f.strokeOpacity=p,m=i4(o),d+=" noop_end ");const v=Xj({x:n,y:i},m);return _("polygon",{className:"connection_end "+d,points:v,style:f})}function Xj(e,t){const{x:n,y:i}=e;let o=`${n}, ${-i} `;return t.forEach(s=>o+=`${n+s.x}, ${-i-s.y} `),o}function Zj(e,t){const n=zu(e,1,t),i=zu(e,-1,t);return[n,i]}const Qj=Ve._25;function zu(e,t,n){return Lt(e+t*Qj,n)}const Tb=12,e4=Tb/2,il=4;function t4(e,t){t=t/10;const n=Lt(e+Ve._90,e4*t),i=oi(Lt(e,il*t),n),o=oi(Lt(e-Ve._90,Tb*t),i),s=oi(Lt(e-Ve._180,il*t),o);return[n,i,o,s]}const Li=9,n4=Math.sin(Ve._45)*Li*2;function i4(e){const t=Lt(e+Ve._315,Li),n=oi(Lt(e+Ve._45,Li),t),i=oi(Lt(e+Ve._135,Li),n),o=oi(Lt(e+Ve._225,Li),i);return[t,n,i,o]}const o4=12,Jo=o4/2,s4=-6,r4=27;let Pb=22;try{navigator.platform.indexOf("Win")>-1&&(Pb=17)}catch{}const _4={meta:0,validity:1,state:2};function Nb(e,t=1){const n=_4[e.attribute],i=t**1.14,o=(r4+n*Pb)*i;return{left:s4+(e.side==="right"?Ee:0)*t,top:o}}function Xo(e){const{kv_wc_entry:t,wcomponent_type:n,connection_terminal_type:i}=e;if(li(n))return t;const s=t.s||1;let{left:r,top:a}=Nb(i,s);return r+=t.left+Jo,a+=t.top+Jo,{left:r,top:a}}const a4=45,Lu=e=>{let t=0;if(li(e.wcomponent_type))t=0;else{const{s:n=1}=e.kv_wc_entry;t=Ee*n}return t+a4},c4=30,Js=30,Bu=150;function Oe(e){e.end_size===0&&((e.console_warn||console.warn)(`Invalid connection end_size "${e.end_size}", defaulting to 1`),e.end_size=1);const{connection_from_component:t,connection_to_component:n,line_behaviour:i,circular_links:o,end_size:s,connection_end_type:r}=e;if(!t||!n)return d4(e);if(i===ci.angular)return u4({connection_from_component:t,connection_to_component:n,end_size:s,connection_end_type:r});const{offset_line_start_y:a,offset_connection_start_y:c,invert_end_angle:l,circular_link_from_below_to:d}=l4({circular_links:o,connection_from_component:t,connection_to_component:n}),p=Xo(t),f=p.left,m=-p.top+a,v=Xo(n),h=v.left,w=-v.top+c;let b=1,g=1;d!==void 0&&(f<h?d?b=-1:g=-1:d?g=-1:b=-1);let k={x:0,y:0},y=k,j=Bo(f,m,h,w)+Ve._180;if(i===void 0||i===ci.curve){const A=(h-f)/2,R=Math.max(Math.abs(A),Js)*(Math.sign(A)||-1);let M=R*b,T=-R*g,B=0,ne=0;const Ye=h<=f;if(!o&&Ye){const _t=w-m;M=Math.min(-M,300),T=Math.max(-T,-300),B=_t||-Js,ne=-_t||-Js}j=l?0:Ve._180,k={x:M,y:B},y={x:T,y:ne}}const{line_end_x:C,line_end_y:N}=Eb({connection_end_type:r,end_size:s,end_angle:j,connection_end_x:h,connection_end_y:w});return{line_start_x:f,line_start_y:m,relative_control_point1:k,relative_control_point2:y,line_end_x:C,line_end_y:N,connection_end_x:h,connection_end_y:w,end_angle:j}}function l4(e){const t={offset_line_start_y:0,offset_connection_start_y:0,invert_end_angle:!1,circular_link_from_below_to:void 0};if(!e.circular_links)return t;const{connection_from_component:n,connection_to_component:i}=e,o=li(n.wcomponent_type),s=li(i.wcomponent_type);let r=o||s?0:c4;return n.kv_wc_entry.left<i.kv_wc_entry.left-Lu(n)||(i.kv_wc_entry.left<n.kv_wc_entry.left-Lu(i)?(t.offset_line_start_y=r,t.offset_connection_start_y=r,i.connection_terminal_type={...i.connection_terminal_type,side:"right"},n.connection_terminal_type={...n.connection_terminal_type,side:"left"},t.invert_end_angle=!0):(t.circular_link_from_below_to=i.kv_wc_entry.top<n.kv_wc_entry.top,t.circular_link_from_below_to?(n.connection_terminal_type={...n.connection_terminal_type,side:"left"},t.offset_line_start_y=r):(i.connection_terminal_type={...i.connection_terminal_type,side:"right"},t.offset_connection_start_y=r,t.invert_end_angle=!0))),t}function d4(e){const{connection_from_component:t,connection_to_component:n,end_size:i,connection_end_type:o}=e;let s=0;const r={x:0,y:0},a=r;let c;if(t)s=t.kv_wc_entry.left+Ee,c=Xo(t);else{if(!n)return null;s=n.kv_wc_entry.left-Bu,c=Xo(n)}const l=-c.top,d=s+Bu,p=l,f=Ve._180,{line_end_x:m,line_end_y:v}=Eb({connection_end_type:o,end_size:i,end_angle:f,connection_end_x:d,connection_end_y:p});return{line_start_x:s,line_start_y:l,relative_control_point1:r,relative_control_point2:a,line_end_x:m,line_end_y:v,connection_end_x:d,connection_end_y:p,end_angle:f}}function Eb(e){const{connection_end_type:t,end_angle:n,connection_end_x:i,connection_end_y:o}=e,s=e.end_size/10,r=t===Bt.negative?il*s:t===Bt.noop?n4:9*s,a=i+Math.cos(n)*r,c=o+Math.sin(n)*r;return{line_end_x:a,line_end_y:c}}function u4(e){const{connection_from_component:t,connection_to_component:n}=e,i=80,o=0,s=t.kv_wc_entry,r=n.kv_wc_entry;let a=s.left,c=-s.top,l=r.left,d=-r.top;li(t.wcomponent_type)||(a+=mi*(s.s||1),c-=i*(s.s||1)),li(n.wcomponent_type)||(l+=mi*(r.s||1),d+=o);const p=3.142/2;return{line_start_x:a,line_start_y:c,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:l,line_end_y:d,connection_end_x:l,connection_end_y:d,end_angle:p}}function p4(e){const t=Uu(e.point1,e.relative_control_point1),n=Uu(e.point2,e.relative_control_point2),i=Kn(e.point1,t),o=Kn(t,n),s=Kn(n,e.point2),r=Kn(i,o),a=Kn(o,s);return Kn(r,a)}function Uu(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Kn(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}const m4=x.delay("derive_connection_coords",()=>{let e,t;x("connection between two nodes",()=>{e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ee+100},t=Oe(e),u(nt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:349,line_end_y:-77,connection_end_x:350,connection_end_y:-77,end_angle:3.142},`two nodes not overlapping horizontally
                    [from]----->[to]`),e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ee+10},t=Oe(e),u(nt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:130,y:0},relative_control_point2:{x:130,y:0},line_end_x:511,line_end_y:-47,connection_end_x:510,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other:
                    [from] [to]`),e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ee-10},t=Oe(e),u(nt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:120,y:0},relative_control_point2:{x:120,y:0},line_end_x:491,line_end_y:-47,connection_end_x:490,connection_end_y:-47,end_angle:0},`two nodes overlapping horizontally
                    [fr.[to]`),e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:-10},t=Oe(e),u(nt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:241,line_end_y:-47,connection_end_x:240,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other in the other direction
                    [to] [from]`),e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:-50},t=Oe(e),u(nt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:201,line_end_y:-47,connection_end_x:200,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally and far from each other in the other direction
                    [to]<-----[from]`),x("of different sizes",()=>{e=Xe();const i=2,o=Ee*i,s=Ee+110,a=Ee*1;e.connection_from_component.kv_wc_entry={top:0,left:0,s:i},e.connection_to_component.kv_wc_entry={top:0,left:s},t=Oe(e),u(nt(t),{line_start_x:o,line_start_y:-160,relative_control_point1:{x:55,y:0},relative_control_point2:{x:55,y:0},line_end_x:s+a+1,line_end_y:-47,connection_end_x:s+a,connection_end_y:-47,end_angle:0},`two nodes that if of same size would not overlap horizontally,
                        [from]----->[to]
                but one is bigger so they do overlap
                        [F R O M]
                             [to ]
            `)})}),e=Xe(),e.connection_to_component=e.connection_from_component,t=Oe(e),u(nt(t),{line_start_x:Ee,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:Ee+1,line_end_y:-47,connection_end_x:Ee,connection_end_y:-47,end_angle:0},"connection from a node back to itself"),e=Xe(),e.end_size=0;let n=[];e.console_warn=(...i)=>n=i,Oe(e),u(n,['Invalid connection end_size "0", defaulting to 1'],"Should log a warning message about invalid end_size: 0,"),x("connection between nothing and a node",()=>{e=Xe(),e.connection_from_component=void 0,e.connection_to_component.kv_wc_entry={top:0,left:0},t=Oe(e),u(nt(t),{line_start_x:-150,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"straight line from nothing to one node"),e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component=void 0,t=Oe(e),u(nt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:399,line_end_y:-77,connection_end_x:400,connection_end_y:-77,end_angle:3.142},"straight line from one node to nothing")}),x("connection between a node and a connection",()=>{e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component={kv_wc_entry:{top:0,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},t=Oe(e),u(nt(t),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:0,connection_end_x:-100,connection_end_y:0,end_angle:0},"connect from one node to a second connection"),e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},t=Oe(e),u(nt(t),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:200,connection_end_x:-100,connection_end_y:200,end_angle:0},"connect from one node to a second connection above and left"),e=Xe(),e.connection_from_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"right",attribute:"state"}},e.connection_to_component.kv_wc_entry={top:0,left:0},t=Oe(e),u(nt(t),{line_start_x:-100,line_start_y:200,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"connect from a second connection above and left to a node")}),x("angular connections",()=>{e=Xe(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_from_component.wcomponent_type="causal_link",e.connection_to_component.kv_wc_entry={top:200,left:100},e.line_behaviour=ci.angular,t=Oe(e),u(nt(t),{line_start_x:0,line_start_y:0,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:100+mi,line_end_y:-200,connection_end_x:100+mi,connection_end_y:-200,end_angle:3.142/2},"connect from a connection above to a node below")})});function Xe(){return{connection_from_component:{kv_wc_entry:{top:0,left:0},wcomponent_type:"statev2",connection_terminal_type:{side:"right",attribute:"state"}},connection_to_component:{kv_wc_entry:{top:0,left:Ee+100},wcomponent_type:"statev2",connection_terminal_type:{side:"left",attribute:"state"}},line_behaviour:void 0,circular_links:!0,end_size:1,connection_end_type:Bt.positive}}function nt(e){return e?{line_start_x:Ze(e.line_start_x,2),line_start_y:Ze(e.line_start_y,2),relative_control_point1:{x:Ze(e.relative_control_point1.x,2),y:Ze(e.relative_control_point1.y,2)},relative_control_point2:{x:Ze(e.relative_control_point2.x,2),y:Ze(e.relative_control_point2.y,2)},line_end_x:Ze(e.line_end_x,3),line_end_y:Ze(e.line_end_y,3),connection_end_x:Ze(e.connection_end_x,3),connection_end_y:Ze(e.connection_end_y,3),end_angle:Ze(e.end_angle,4)}:null}function F(e){return _(q1,{xsUp:e.is_hidden,children:_(Se,{className:e.className,title:e.title,color:e.color||"primary",style:{...e.style,pointerEvents:"initial"},disabled:e.disabled||!1,disableElevation:e.disableElevation||!0,disableFocusRipple:e.disableFocusRipple||!1,endIcon:e.endIcon,fullWidth:e.fullWidth||!1,href:e.href,size:e.size||"small",startIcon:e.startIcon,variant:e.variant||"contained",onPointerDown:t=>{t.currentTarget.focus(),t.stopImmediatePropagation(),t.preventDefault(),e.onPointerDown&&e.onPointerDown(t)},onClick:t=>{t.currentTarget.focus(),t.stopImmediatePropagation(),t.preventDefault(),e.onClick&&e.onClick(t)},children:e.children||e.value})})}function f4(e,t){for(;e;){const{classList:n}=e;if(n&&n.contains(t))break;e=e.parentElement}return e}function v4(e,t){for(;e;){const{classList:n}=e;if(n&&t.find(i=>n.contains(i)))break;e=e.parentElement}return e}const h4=e=>({time_resolution:e.display_options.time_resolution,presenting:e.display_options.consumption_formatting}),g4=P(h4);function w4(e){const t=k4(e),[n,i]=D(!1),o=t?"":"no_entry",{on_change:s}=e;if(!s)return _("div",{className:o,children:t});const{invariant_value:r,show_now_shortcut_button:a=!1,show_today_shortcut_button:c=!0}=e,l=Wu(t),d=e.editing_allowed!==void 0?!e.editing_allowed:e.presenting,p=`editable_field ${l?"":"invalid"} ${o} ${d?"not_editable":""}`,f=(e.title||"DateTime")+(e.invariant_value&&e.value?" (custom)":"");function m(w){s&&y4(e.value,w)&&s(w)}const v=De(void 0),h=De(m);return h.current=m,re(()=>()=>{if(!v.current||!(document.activeElement===v.current))return;const b=Zo({working_value:v.current.value,invariant_value:r});h.current(b)},[]),_("div",{className:p,title:f,children:[_(In,{disabled:d,type:"text",label:f,value:t,onFocus:()=>i(!0),inputRef:w=>{if(!w||(v.current=w,!n))return;const b=Ib(e),g=ii({date:b,time_resolution:"minute",trim_midnight:!1});w.value=g,w.setSelectionRange(0,w.value.length)},onKeyDown:w=>{const b=w.key==="Enter",g=w.key==="Escape";(b||g)&&w.currentTarget.blur()},onChange:w=>{const b=Wu(w.currentTarget.value),g=f4(w.currentTarget,"editable_field");g&&(b?g.classList.remove("invalid"):g.classList.add("invalid"))},onBlur:w=>{const b=w.currentTarget.value,g=Zo({working_value:b,invariant_value:r});m(g),i(!1)},size:"small",variant:"outlined",fullWidth:!0}),n&&a&&_(b4,{on_change:m}),n&&c&&_(F,{value:"Today",onPointerDown:()=>{const w=as();m(new Date(w))}})]})}const Ct=g4(w4);function Wu(e){if(!e.trim())return!0;const t=Hi(e);return!!t&&pl(t)}function b4(e){return _(F,{value:"Now",onClick:()=>{const t=new Date(new Date().getTime()+3e4),n=nn(t,"yyyy-MM-dd hh:mm");e.on_change(new Date(n))}})}function Ib(e){return e.value||e.invariant_value}function y4(e,t){const n=e==null?void 0:e.getTime(),i=t==null?void 0:t.getTime();return n!==i}function k4(e){const t=Ib(e);return ii({date:t,time_resolution:e.time_resolution})}function Zo(e){const{working_value:t,invariant_value:n}=e;let i=Hi(t);return i&&i.getTime()===(n&&n.getTime())&&(i=void 0),i}const x4=x.delay("handle_on_blur",()=>{let e,t,n;e=void 0,t="2020-01-01",n=Zo({invariant_value:e,working_value:t}),u(n==null?void 0:n.getTime(),new Date("2020-01-01T00:00:00.000Z").getTime()),e=void 0,t="2021-04-25 08:37",n=Zo({invariant_value:e,working_value:t}),u(n==null?void 0:n.getTime(),new Date("2021-04-25T07:37:00.000Z").getTime())});function Db(e){const{knowledge_views_by_id:t,wcomponents_by_id:n}=e,i=S4(e),o=new Set(i.map(c=>c.id)),s=A4({kv_ids_to_move:o,knowledge_views_by_id:t}),{wc_ids_to_move:r,wcomponents_move_conflicts:a}=$4({knowledge_views_to_move:i,knowledge_views_to_keep:s,wcomponents_by_id:n});return{kv_ids_to_move:o,wc_ids_to_move:r,wcomponents_move_conflicts:a}}function S4(e){const t=[],n=new Set,i=[e.root_knowledge_view_id_to_move];for(;i.length;){const o=i.pop();if(!o)break;if(n.has(o))continue;const s=e.knowledge_views_by_id[o],r=e.nested_knowledge_view_ids_map[o];if(!r||!s){console.error(`kv of id: "${o}" kv is "${s?"present":"absent"}" but nested kv map entry is "${r?"present":"absent"}"`);continue}t.push(s),n.add(o),r.child_ids.forEach(a=>i.push(a))}return t}function A4(e){return Object.values(e.knowledge_views_by_id).filter(t=>!e.kv_ids_to_move.has(t.id))}function $4(e){const t={};e.knowledge_views_to_keep.forEach(r=>{Object.entries(r.wc_id_map).forEach(([a,c])=>{if(c.blocked||c.passthrough)return;const l=t[a]||[];l.push({kv_id:r.id,left:c.left,top:c.top}),t[a]=l})});const n=new Set(e.knowledge_views_to_keep.map(r=>r.id)),i=new Set(e.knowledge_views_to_move.map(r=>r.id)),o=new Set,s={};return e.knowledge_views_to_move.forEach(r=>Object.entries(r.wc_id_map).forEach(([a,c])=>{if(c.blocked||c.passthrough||!e.wcomponents_by_id[a]||n.has(a))return;const l=t[a],d=i.has(a);l&&!d?s[a]=l:o.add(a)})),{wc_ids_to_move:o,wcomponents_move_conflicts:s}}const C4=x.delay("calc_ids_to_move_and_conflicts",()=>{const t=We({id:"uuid A",base_id:1,title:"A"}),n=We({id:"uuid B",base_id:1,title:"B",parent_knowledge_view_id:t.id}),i=We({id:"uuid C",base_id:1,title:"C",parent_knowledge_view_id:n.id}),o=We({id:"uuid I",base_id:1,title:"I",parent_knowledge_view_id:n.id}),s=We({id:"uuid J",base_id:1,title:"J",parent_knowledge_view_id:t.id}),r=[t,n,i,o,s],a={};r.forEach($=>a[$.id]=$);const c={},l=$=>(c[$.id]=$,$),d=l(q({base_id:1,title:t.title,id:t.id})),p=l(q({base_id:1,title:n.title,id:n.id})),f=l(q({base_id:1,title:i.title,id:i.id})),m=l(q({base_id:1,title:o.title,id:o.id})),v=l(q({base_id:1,title:s.title,id:s.id})),h=l(q({id:"uuid E",base_id:1,title:"E"})),w=l(q({id:"uuid F",base_id:1,title:"F"})),b=l(q({id:"uuid G",base_id:1,title:"G"})),g=l(q({id:"uuid H",base_id:1,title:"H"}));t.wc_id_map[d.id]={left:0,top:0},t.wc_id_map[p.id]={left:0,top:0},t.wc_id_map[h.id]={left:0,top:0},t.wc_id_map[w.id]={left:0,top:0},t.wc_id_map[m.id]={left:0,top:0},t.wc_id_map[v.id]={left:0,top:0},n.wc_id_map[p.id]={left:0,top:0},n.wc_id_map[f.id]={left:0,top:0},n.wc_id_map[h.id]={left:0,top:0},n.wc_id_map[b.id]={left:0,top:0},n.wc_id_map[m.id]={left:0,top:0},i.wc_id_map[f.id]={left:0,top:0},i.wc_id_map[w.id]={left:0,top:0},i.wc_id_map[g.id]={left:0,top:0},i.wc_id_map[v.id]={left:0,top:0},o.wc_id_map[m.id]={left:0,top:0},s.wc_id_map[v.id]={left:0,top:0};const k=Ng(r,1).map,y=Db({root_knowledge_view_id_to_move:n.id,nested_knowledge_view_ids_map:k,knowledge_views_by_id:a,wcomponents_by_id:c});u(y.kv_ids_to_move,new Set([n.id,i.id,o.id])),u(y.wc_ids_to_move,new Set([p.id,f.id,m.id,b.id,g.id])),u(Object.keys(y.wcomponents_move_conflicts),[h.id,w.id])});function xe(e,t){if(e===0)return"0";const n=Math.floor(Math.log10(Math.abs(e))),i=n+1-t,s=(Math.round(e/Math.pow(10,i))*Math.pow(10,i)).toString();if(i>=0)return s;{const a=s.indexOf(".")!==-1;let c=s+(a?"":".");const l=(Math.abs(e)>=1?c.length:c.length+n)-1-(e<0?1:0);let d=t-l;d=Math.max(0,d),c+="0".repeat(d);const p=t+(n<0?-n:0)+1+(e<0?1:0);return c=c.slice(0,p),c}}const j4=x.delay("run_number_to_significant_figures",()=>{let e="";e=xe(0,2),u(e,"0","Zero"),x("Positive numbers",()=>{e=xe(27e5,2),u(e,"2700000","2.7 million to 2 sf"),e=xe(27e6,2),u(e,"27000000","27 million to 2 sf"),e=xe(27e7,2),u(e,"270000000","270 million to 2 sf"),e=xe(2700000002e-1,2),u(e,"270000000","270.2 million to 2 sf")}),x("Positive with decimals numbers",()=>{e=xe(27,5),u(e,"27.000","27 to 5 sf"),e=xe(2700000002e-1,10),u(e,"270000000.2","270.2 million to 10 sf"),e=xe(2700000002e-1,11),u(e,"270000000.20","270.2 million to 11 sf")}),x("Negative numbers",()=>{e=xe(-27,5),u(e,"-27.000","-27 to 5 sf"),e=xe(-2700000002e-1,11),u(e,"-270000000.20","-270.2 million to 11 sf"),e=xe(-2700000002e-1,2),u(e,"-270000000","-270.2 million to 2 sf")}),x("Small numbers",()=>{e=xe(1236e-7,3),u(e,"0.000124","0.0001236 to 3 sf"),e=xe(1236e-7,5),u(e,"0.00012360","0.0001236 to 5 sf"),e=xe(-1236e-7,3),u(e,"-0.000124","-0.0001236 to 3 sf"),e=xe(-1236e-7,5),u(e,"-0.00012360","-0.0001236 to 5 sf")}),x("Floating point precision numbers",()=>{e=xe(.01264,2),u(e,"0.013","0.01264 to 2 sf, tests when floating point precision results in 0.013000000000000001"),e=xe(17.955*100,7),u(e,"1795.500","17.955*100 to 7 sf, tests when floating point precision results in 1795.4999999999998")})});function T4(e){return e.reduce((t,n)=>(t[n]=n,t),Object.create(null))}const V=T4(["bare","simple","scaled","percentage","abbreviated_scaled","scientific"]);function W(e,t,n){let i;if(t=Math.round(t),t=t<1?1:t,n===V.bare)i=Ze(e,t).toString();else if(n===V.simple){const o=Ze(e,t);i=Math.abs(o)<1?o.toString():o.toLocaleString()}else if(n===V.scaled)i=P4(e,t);else if(n===V.percentage)i=Ze(e*100,t).toString()+"%";else if(n===V.abbreviated_scaled)i=N4(e,t);else if(n===V.scientific){const o=Bl(e,t);i=e.toExponential(o-1)}else throw new Error(`Unimplemented display type ${n}`);return i=i.replace("e+","e").trim(),i}function P4(e,t){const n=["","thousand","million","billion","trillion"];let i=0;for(;Math.abs(e)>=1e3&&i<n.length-1;)e/=1e3,i++;const o=Bl(e,t);return xe(e,o)+" "+n[i]}function N4(e,t){const n=["","k","m","bn","tn"];let i=0;for(;Math.abs(e)>=1e3&&i<n.length-1;)e/=1e3,i++;const o=Bl(e,t);return xe(e,o)+" "+n[i]}function Bl(e,t){let n=t;for(;n>1&&Number.parseFloat(e.toPrecision(n-1))===e;)--n;return n}const E4=x.delay("run_number_to_string",()=>{let e="";e=W(1264,2,V.bare),u(e,"1300","bare number"),e=W(1264,2,V.simple),u(e,"1,300","simple number"),e=W(1264,2,V.scaled),u(e,"1.3 thousand","scaled number"),e=W(.1264,2,V.percentage),u(e,"13%","number as percentage"),e=W(1264,2,V.abbreviated_scaled),u(e,"1.3 k","abbreviated scaled number"),e=W(1264,2,V.scientific),u(e,"1.3e3","scientific number"),e=W(.1264,-.2,V.scientific),u(e,"1e-1","Copes with significant_figures that are fractional and or < 1"),e=W(27e6,2,V.scaled),u(e,"27 million","27 million"),e=W(27e7,2,V.scaled),u(e,"270 million","270 million"),e=W(27e8,2,V.scaled),u(e,"2.7 billion","2.7 billion"),x("negative numbers",()=>{e=W(-1264,2,V.bare),u(e,"-1300","bare number"),e=W(-1264,2,V.simple),u(e,"-1,300","simple number"),e=W(-1264,2,V.scaled),u(e,"-1.3 thousand","scaled number"),e=W(-.1264,2,V.percentage),u(e,"-13%","percentage number"),e=W(-1264,2,V.abbreviated_scaled),u(e,"-1.3 k","abbreviated scaled number"),e=W(-1264,2,V.scientific),u(e,"-1.3e3","scientific number")}),x("less than 1 numbers",()=>{e=W(.001264,2,V.bare),u(e,"0.0013","bare number"),e=W(.001264,2,V.simple),u(e,"0.0013","simple number"),e=W(.001264,2,V.scaled),u(e,"0.0013","scaled number"),e=W(.001264,2,V.percentage),u(e,"0.13%","percentage number"),e=W(.001264,2,V.abbreviated_scaled),u(e,"0.0013","abbreviated scaled number"),e=W(.001264,2,V.scientific),u(e,"1.3e-3","scientific number"),e=W(-.001264,2,V.scientific),u(e,"-1.3e-3","0> num >-1 scientific number")}),x("no unnecessary significant figures",()=>{e=W(1,2,V.bare),u(e,"1","bare number"),e=W(1,2,V.simple),u(e,"1","simple number"),e=W(1e3,2,V.scaled),u(e,"1 thousand","scaled number"),e=W(10,2,V.percentage),u(e,"1000%","percentage number"),e=W(1e3,2,V.abbreviated_scaled),u(e,"1 k","abbreviated scaled number"),e=W(1e3,2,V.scientific),u(e,"1e3","scientific number")}),x("handles 0",()=>{e=W(0,2,V.bare),u(e,"0","bare number"),e=W(0,2,V.simple),u(e,"0","simple number"),e=W(0,2,V.scaled),u(e,"0","scaled number"),e=W(0,2,V.percentage),u(e,"0%","percentage number"),e=W(0,2,V.abbreviated_scaled),u(e,"0","abbreviated scaled number"),e=W(0,2,V.scientific),u(e,"0e0","scientific number")})});var Xs,Hu;function I4(){if(Hu)return Xs;Hu=1;function e(){this.__data__=[],this.size=0}return Xs=e,Xs}var Zs,Gu;function Ul(){if(Gu)return Zs;Gu=1;function e(t,n){return t===n||t!==t&&n!==n}return Zs=e,Zs}var Qs,Ku;function ys(){if(Ku)return Qs;Ku=1;var e=Ul();function t(n,i){for(var o=n.length;o--;)if(e(n[o][0],i))return o;return-1}return Qs=t,Qs}var er,Yu;function D4(){if(Yu)return er;Yu=1;var e=ys(),t=Array.prototype,n=t.splice;function i(o){var s=this.__data__,r=e(s,o);if(r<0)return!1;var a=s.length-1;return r==a?s.pop():n.call(s,r,1),--this.size,!0}return er=i,er}var tr,Ju;function R4(){if(Ju)return tr;Ju=1;var e=ys();function t(n){var i=this.__data__,o=e(i,n);return o<0?void 0:i[o][1]}return tr=t,tr}var nr,Xu;function O4(){if(Xu)return nr;Xu=1;var e=ys();function t(n){return e(this.__data__,n)>-1}return nr=t,nr}var ir,Zu;function M4(){if(Zu)return ir;Zu=1;var e=ys();function t(n,i){var o=this.__data__,s=e(o,n);return s<0?(++this.size,o.push([n,i])):o[s][1]=i,this}return ir=t,ir}var or,Qu;function ks(){if(Qu)return or;Qu=1;var e=I4(),t=D4(),n=R4(),i=O4(),o=M4();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,or=s,or}var sr,ep;function q4(){if(ep)return sr;ep=1;var e=ks();function t(){this.__data__=new e,this.size=0}return sr=t,sr}var rr,tp;function V4(){if(tp)return rr;tp=1;function e(t){var n=this.__data__,i=n.delete(t);return this.size=n.size,i}return rr=e,rr}var _r,np;function F4(){if(np)return _r;np=1;function e(t){return this.__data__.get(t)}return _r=e,_r}var ar,ip;function z4(){if(ip)return ar;ip=1;function e(t){return this.__data__.has(t)}return ar=e,ar}var cr,op;function Rb(){if(op)return cr;op=1;var e=typeof jo=="object"&&jo&&jo.Object===Object&&jo;return cr=e,cr}var lr,sp;function Nt(){if(sp)return lr;sp=1;var e=Rb(),t=typeof self=="object"&&self&&self.Object===Object&&self,n=e||t||Function("return this")();return lr=n,lr}var dr,rp;function Si(){if(rp)return dr;rp=1;var e=Nt(),t=e.Symbol;return dr=t,dr}var ur,_p;function L4(){if(_p)return ur;_p=1;var e=Si(),t=Object.prototype,n=t.hasOwnProperty,i=t.toString,o=e?e.toStringTag:void 0;function s(r){var a=n.call(r,o),c=r[o];try{r[o]=void 0;var l=!0}catch{}var d=i.call(r);return l&&(a?r[o]=c:delete r[o]),d}return ur=s,ur}var pr,ap;function B4(){if(ap)return pr;ap=1;var e=Object.prototype,t=e.toString;function n(i){return t.call(i)}return pr=n,pr}var mr,cp;function Ai(){if(cp)return mr;cp=1;var e=Si(),t=L4(),n=B4(),i="[object Null]",o="[object Undefined]",s=e?e.toStringTag:void 0;function r(a){return a==null?a===void 0?o:i:s&&s in Object(a)?t(a):n(a)}return mr=r,mr}var fr,lp;function qn(){if(lp)return fr;lp=1;function e(t){var n=typeof t;return t!=null&&(n=="object"||n=="function")}return fr=e,fr}var vr,dp;function xs(){if(dp)return vr;dp=1;var e=Ai(),t=qn(),n="[object AsyncFunction]",i="[object Function]",o="[object GeneratorFunction]",s="[object Proxy]";function r(a){if(!t(a))return!1;var c=e(a);return c==i||c==o||c==n||c==s}return vr=r,vr}var hr,up;function U4(){if(up)return hr;up=1;var e=Nt(),t=e["__core-js_shared__"];return hr=t,hr}var gr,pp;function W4(){if(pp)return gr;pp=1;var e=U4(),t=function(){var i=/[^.]+$/.exec(e&&e.keys&&e.keys.IE_PROTO||"");return i?"Symbol(src)_1."+i:""}();function n(i){return!!t&&t in i}return gr=n,gr}var wr,mp;function Ob(){if(mp)return wr;mp=1;var e=Function.prototype,t=e.toString;function n(i){if(i!=null){try{return t.call(i)}catch{}try{return i+""}catch{}}return""}return wr=n,wr}var br,fp;function H4(){if(fp)return br;fp=1;var e=xs(),t=W4(),n=qn(),i=Ob(),o=/[\\^$.*+?()[\]{}|]/g,s=/^\[object .+?Constructor\]$/,r=Function.prototype,a=Object.prototype,c=r.toString,l=a.hasOwnProperty,d=RegExp("^"+c.call(l).replace(o,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function p(f){if(!n(f)||t(f))return!1;var m=e(f)?d:s;return m.test(i(f))}return br=p,br}var yr,vp;function G4(){if(vp)return yr;vp=1;function e(t,n){return t==null?void 0:t[n]}return yr=e,yr}var kr,hp;function Vn(){if(hp)return kr;hp=1;var e=H4(),t=G4();function n(i,o){var s=t(i,o);return e(s)?s:void 0}return kr=n,kr}var xr,gp;function Wl(){if(gp)return xr;gp=1;var e=Vn(),t=Nt(),n=e(t,"Map");return xr=n,xr}var Sr,wp;function Ss(){if(wp)return Sr;wp=1;var e=Vn(),t=e(Object,"create");return Sr=t,Sr}var Ar,bp;function K4(){if(bp)return Ar;bp=1;var e=Ss();function t(){this.__data__=e?e(null):{},this.size=0}return Ar=t,Ar}var $r,yp;function Y4(){if(yp)return $r;yp=1;function e(t){var n=this.has(t)&&delete this.__data__[t];return this.size-=n?1:0,n}return $r=e,$r}var Cr,kp;function J4(){if(kp)return Cr;kp=1;var e=Ss(),t="__lodash_hash_undefined__",n=Object.prototype,i=n.hasOwnProperty;function o(s){var r=this.__data__;if(e){var a=r[s];return a===t?void 0:a}return i.call(r,s)?r[s]:void 0}return Cr=o,Cr}var jr,xp;function X4(){if(xp)return jr;xp=1;var e=Ss(),t=Object.prototype,n=t.hasOwnProperty;function i(o){var s=this.__data__;return e?s[o]!==void 0:n.call(s,o)}return jr=i,jr}var Tr,Sp;function Z4(){if(Sp)return Tr;Sp=1;var e=Ss(),t="__lodash_hash_undefined__";function n(i,o){var s=this.__data__;return this.size+=this.has(i)?0:1,s[i]=e&&o===void 0?t:o,this}return Tr=n,Tr}var Pr,Ap;function Q4(){if(Ap)return Pr;Ap=1;var e=K4(),t=Y4(),n=J4(),i=X4(),o=Z4();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,Pr=s,Pr}var Nr,$p;function e7(){if($p)return Nr;$p=1;var e=Q4(),t=ks(),n=Wl();function i(){this.size=0,this.__data__={hash:new e,map:new(n||t),string:new e}}return Nr=i,Nr}var Er,Cp;function t7(){if(Cp)return Er;Cp=1;function e(t){var n=typeof t;return n=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null}return Er=e,Er}var Ir,jp;function As(){if(jp)return Ir;jp=1;var e=t7();function t(n,i){var o=n.__data__;return e(i)?o[typeof i=="string"?"string":"hash"]:o.map}return Ir=t,Ir}var Dr,Tp;function n7(){if(Tp)return Dr;Tp=1;var e=As();function t(n){var i=e(this,n).delete(n);return this.size-=i?1:0,i}return Dr=t,Dr}var Rr,Pp;function i7(){if(Pp)return Rr;Pp=1;var e=As();function t(n){return e(this,n).get(n)}return Rr=t,Rr}var Or,Np;function o7(){if(Np)return Or;Np=1;var e=As();function t(n){return e(this,n).has(n)}return Or=t,Or}var Mr,Ep;function s7(){if(Ep)return Mr;Ep=1;var e=As();function t(n,i){var o=e(this,n),s=o.size;return o.set(n,i),this.size+=o.size==s?0:1,this}return Mr=t,Mr}var qr,Ip;function Hl(){if(Ip)return qr;Ip=1;var e=e7(),t=n7(),n=i7(),i=o7(),o=s7();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,qr=s,qr}var Vr,Dp;function r7(){if(Dp)return Vr;Dp=1;var e=ks(),t=Wl(),n=Hl(),i=200;function o(s,r){var a=this.__data__;if(a instanceof e){var c=a.__data__;if(!t||c.length<i-1)return c.push([s,r]),this.size=++a.size,this;a=this.__data__=new n(c)}return a.set(s,r),this.size=a.size,this}return Vr=o,Vr}var Fr,Rp;function Gl(){if(Rp)return Fr;Rp=1;var e=ks(),t=q4(),n=V4(),i=F4(),o=z4(),s=r7();function r(a){var c=this.__data__=new e(a);this.size=c.size}return r.prototype.clear=t,r.prototype.delete=n,r.prototype.get=i,r.prototype.has=o,r.prototype.set=s,Fr=r,Fr}var zr,Op;function Kl(){if(Op)return zr;Op=1;function e(t,n){for(var i=-1,o=t==null?0:t.length;++i<o&&n(t[i],i,t)!==!1;);return t}return zr=e,zr}var Lr,Mp;function Mb(){if(Mp)return Lr;Mp=1;var e=Vn(),t=function(){try{var n=e(Object,"defineProperty");return n({},"",{}),n}catch{}}();return Lr=t,Lr}var Br,qp;function qb(){if(qp)return Br;qp=1;var e=Mb();function t(n,i,o){i=="__proto__"&&e?e(n,i,{configurable:!0,enumerable:!0,value:o,writable:!0}):n[i]=o}return Br=t,Br}var Ur,Vp;function Vb(){if(Vp)return Ur;Vp=1;var e=qb(),t=Ul(),n=Object.prototype,i=n.hasOwnProperty;function o(s,r,a){var c=s[r];(!(i.call(s,r)&&t(c,a))||a===void 0&&!(r in s))&&e(s,r,a)}return Ur=o,Ur}var Wr,Fp;function $s(){if(Fp)return Wr;Fp=1;var e=Vb(),t=qb();function n(i,o,s,r){var a=!s;s||(s={});for(var c=-1,l=o.length;++c<l;){var d=o[c],p=r?r(s[d],i[d],d,s,i):void 0;p===void 0&&(p=i[d]),a?t(s,d,p):e(s,d,p)}return s}return Wr=n,Wr}var Hr,zp;function _7(){if(zp)return Hr;zp=1;function e(t,n){for(var i=-1,o=Array(t);++i<t;)o[i]=n(i);return o}return Hr=e,Hr}var Gr,Lp;function Ht(){if(Lp)return Gr;Lp=1;function e(t){return t!=null&&typeof t=="object"}return Gr=e,Gr}var Kr,Bp;function a7(){if(Bp)return Kr;Bp=1;var e=Ai(),t=Ht(),n="[object Arguments]";function i(o){return t(o)&&e(o)==n}return Kr=i,Kr}var Yr,Up;function Cs(){if(Up)return Yr;Up=1;var e=a7(),t=Ht(),n=Object.prototype,i=n.hasOwnProperty,o=n.propertyIsEnumerable,s=e(function(){return arguments}())?e:function(r){return t(r)&&i.call(r,"callee")&&!o.call(r,"callee")};return Yr=s,Yr}var Jr,Wp;function je(){if(Wp)return Jr;Wp=1;var e=Array.isArray;return Jr=e,Jr}var Bi={exports:{}},Xr,Hp;function c7(){if(Hp)return Xr;Hp=1;function e(){return!1}return Xr=e,Xr}Bi.exports;var Gp;function po(){return Gp||(Gp=1,function(e,t){var n=Nt(),i=c7(),o=t&&!t.nodeType&&t,s=o&&!0&&e&&!e.nodeType&&e,r=s&&s.exports===o,a=r?n.Buffer:void 0,c=a?a.isBuffer:void 0,l=c||i;e.exports=l}(Bi,Bi.exports)),Bi.exports}var Zr,Kp;function Fb(){if(Kp)return Zr;Kp=1;var e=9007199254740991,t=/^(?:0|[1-9]\d*)$/;function n(i,o){var s=typeof i;return o=o??e,!!o&&(s=="number"||s!="symbol"&&t.test(i))&&i>-1&&i%1==0&&i<o}return Zr=n,Zr}var Qr,Yp;function Yl(){if(Yp)return Qr;Yp=1;var e=9007199254740991;function t(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=e}return Qr=t,Qr}var e_,Jp;function l7(){if(Jp)return e_;Jp=1;var e=Ai(),t=Yl(),n=Ht(),i="[object Arguments]",o="[object Array]",s="[object Boolean]",r="[object Date]",a="[object Error]",c="[object Function]",l="[object Map]",d="[object Number]",p="[object Object]",f="[object RegExp]",m="[object Set]",v="[object String]",h="[object WeakMap]",w="[object ArrayBuffer]",b="[object DataView]",g="[object Float32Array]",k="[object Float64Array]",y="[object Int8Array]",$="[object Int16Array]",j="[object Int32Array]",C="[object Uint8Array]",N="[object Uint8ClampedArray]",A="[object Uint16Array]",R="[object Uint32Array]",M={};M[g]=M[k]=M[y]=M[$]=M[j]=M[C]=M[N]=M[A]=M[R]=!0,M[i]=M[o]=M[w]=M[s]=M[b]=M[r]=M[a]=M[c]=M[l]=M[d]=M[p]=M[f]=M[m]=M[v]=M[h]=!1;function T(B){return n(B)&&t(B.length)&&!!M[e(B)]}return e_=T,e_}var t_,Xp;function Jl(){if(Xp)return t_;Xp=1;function e(t){return function(n){return t(n)}}return t_=e,t_}var Ui={exports:{}};Ui.exports;var Zp;function Xl(){return Zp||(Zp=1,function(e,t){var n=Rb(),i=t&&!t.nodeType&&t,o=i&&!0&&e&&!e.nodeType&&e,s=o&&o.exports===i,r=s&&n.process,a=function(){try{var c=o&&o.require&&o.require("util").types;return c||r&&r.binding&&r.binding("util")}catch{}}();e.exports=a}(Ui,Ui.exports)),Ui.exports}var n_,Qp;function js(){if(Qp)return n_;Qp=1;var e=l7(),t=Jl(),n=Xl(),i=n&&n.isTypedArray,o=i?t(i):e;return n_=o,n_}var i_,em;function zb(){if(em)return i_;em=1;var e=_7(),t=Cs(),n=je(),i=po(),o=Fb(),s=js(),r=Object.prototype,a=r.hasOwnProperty;function c(l,d){var p=n(l),f=!p&&t(l),m=!p&&!f&&i(l),v=!p&&!f&&!m&&s(l),h=p||f||m||v,w=h?e(l.length,String):[],b=w.length;for(var g in l)(d||a.call(l,g))&&!(h&&(g=="length"||m&&(g=="offset"||g=="parent")||v&&(g=="buffer"||g=="byteLength"||g=="byteOffset")||o(g,b)))&&w.push(g);return w}return i_=c,i_}var o_,tm;function Ts(){if(tm)return o_;tm=1;var e=Object.prototype;function t(n){var i=n&&n.constructor,o=typeof i=="function"&&i.prototype||e;return n===o}return o_=t,o_}var s_,nm;function Lb(){if(nm)return s_;nm=1;function e(t,n){return function(i){return t(n(i))}}return s_=e,s_}var r_,im;function d7(){if(im)return r_;im=1;var e=Lb(),t=e(Object.keys,Object);return r_=t,r_}var __,om;function Zl(){if(om)return __;om=1;var e=Ts(),t=d7(),n=Object.prototype,i=n.hasOwnProperty;function o(s){if(!e(s))return t(s);var r=[];for(var a in Object(s))i.call(s,a)&&a!="constructor"&&r.push(a);return r}return __=o,__}var a_,sm;function Fn(){if(sm)return a_;sm=1;var e=xs(),t=Yl();function n(i){return i!=null&&t(i.length)&&!e(i)}return a_=n,a_}var c_,rm;function zn(){if(rm)return c_;rm=1;var e=zb(),t=Zl(),n=Fn();function i(o){return n(o)?e(o):t(o)}return c_=i,c_}var l_,_m;function u7(){if(_m)return l_;_m=1;var e=$s(),t=zn();function n(i,o){return i&&e(o,t(o),i)}return l_=n,l_}var d_,am;function p7(){if(am)return d_;am=1;function e(t){var n=[];if(t!=null)for(var i in Object(t))n.push(i);return n}return d_=e,d_}var u_,cm;function m7(){if(cm)return u_;cm=1;var e=qn(),t=Ts(),n=p7(),i=Object.prototype,o=i.hasOwnProperty;function s(r){if(!e(r))return n(r);var a=t(r),c=[];for(var l in r)l=="constructor"&&(a||!o.call(r,l))||c.push(l);return c}return u_=s,u_}var p_,lm;function Ql(){if(lm)return p_;lm=1;var e=zb(),t=m7(),n=Fn();function i(o){return n(o)?e(o,!0):t(o)}return p_=i,p_}var m_,dm;function f7(){if(dm)return m_;dm=1;var e=$s(),t=Ql();function n(i,o){return i&&e(o,t(o),i)}return m_=n,m_}var Wi={exports:{}};Wi.exports;var um;function v7(){return um||(um=1,function(e,t){var n=Nt(),i=t&&!t.nodeType&&t,o=i&&!0&&e&&!e.nodeType&&e,s=o&&o.exports===i,r=s?n.Buffer:void 0,a=r?r.allocUnsafe:void 0;function c(l,d){if(d)return l.slice();var p=l.length,f=a?a(p):new l.constructor(p);return l.copy(f),f}e.exports=c}(Wi,Wi.exports)),Wi.exports}var f_,pm;function h7(){if(pm)return f_;pm=1;function e(t,n){var i=-1,o=t.length;for(n||(n=Array(o));++i<o;)n[i]=t[i];return n}return f_=e,f_}var v_,mm;function Bb(){if(mm)return v_;mm=1;function e(t,n){for(var i=-1,o=t==null?0:t.length,s=0,r=[];++i<o;){var a=t[i];n(a,i,t)&&(r[s++]=a)}return r}return v_=e,v_}var h_,fm;function Ub(){if(fm)return h_;fm=1;function e(){return[]}return h_=e,h_}var g_,vm;function ed(){if(vm)return g_;vm=1;var e=Bb(),t=Ub(),n=Object.prototype,i=n.propertyIsEnumerable,o=Object.getOwnPropertySymbols,s=o?function(r){return r==null?[]:(r=Object(r),e(o(r),function(a){return i.call(r,a)}))}:t;return g_=s,g_}var w_,hm;function g7(){if(hm)return w_;hm=1;var e=$s(),t=ed();function n(i,o){return e(i,t(i),o)}return w_=n,w_}var b_,gm;function td(){if(gm)return b_;gm=1;function e(t,n){for(var i=-1,o=n.length,s=t.length;++i<o;)t[s+i]=n[i];return t}return b_=e,b_}var y_,wm;function nd(){if(wm)return y_;wm=1;var e=Lb(),t=e(Object.getPrototypeOf,Object);return y_=t,y_}var k_,bm;function Wb(){if(bm)return k_;bm=1;var e=td(),t=nd(),n=ed(),i=Ub(),o=Object.getOwnPropertySymbols,s=o?function(r){for(var a=[];r;)e(a,n(r)),r=t(r);return a}:i;return k_=s,k_}var x_,ym;function w7(){if(ym)return x_;ym=1;var e=$s(),t=Wb();function n(i,o){return e(i,t(i),o)}return x_=n,x_}var S_,km;function Hb(){if(km)return S_;km=1;var e=td(),t=je();function n(i,o,s){var r=o(i);return t(i)?r:e(r,s(i))}return S_=n,S_}var A_,xm;function Gb(){if(xm)return A_;xm=1;var e=Hb(),t=ed(),n=zn();function i(o){return e(o,n,t)}return A_=i,A_}var $_,Sm;function b7(){if(Sm)return $_;Sm=1;var e=Hb(),t=Wb(),n=Ql();function i(o){return e(o,n,t)}return $_=i,$_}var C_,Am;function y7(){if(Am)return C_;Am=1;var e=Vn(),t=Nt(),n=e(t,"DataView");return C_=n,C_}var j_,$m;function k7(){if($m)return j_;$m=1;var e=Vn(),t=Nt(),n=e(t,"Promise");return j_=n,j_}var T_,Cm;function Kb(){if(Cm)return T_;Cm=1;var e=Vn(),t=Nt(),n=e(t,"Set");return T_=n,T_}var P_,jm;function x7(){if(jm)return P_;jm=1;var e=Vn(),t=Nt(),n=e(t,"WeakMap");return P_=n,P_}var N_,Tm;function $i(){if(Tm)return N_;Tm=1;var e=y7(),t=Wl(),n=k7(),i=Kb(),o=x7(),s=Ai(),r=Ob(),a="[object Map]",c="[object Object]",l="[object Promise]",d="[object Set]",p="[object WeakMap]",f="[object DataView]",m=r(e),v=r(t),h=r(n),w=r(i),b=r(o),g=s;return(e&&g(new e(new ArrayBuffer(1)))!=f||t&&g(new t)!=a||n&&g(n.resolve())!=l||i&&g(new i)!=d||o&&g(new o)!=p)&&(g=function(k){var y=s(k),$=y==c?k.constructor:void 0,j=$?r($):"";if(j)switch(j){case m:return f;case v:return a;case h:return l;case w:return d;case b:return p}return y}),N_=g,N_}var E_,Pm;function S7(){if(Pm)return E_;Pm=1;var e=Object.prototype,t=e.hasOwnProperty;function n(i){var o=i.length,s=new i.constructor(o);return o&&typeof i[0]=="string"&&t.call(i,"index")&&(s.index=i.index,s.input=i.input),s}return E_=n,E_}var I_,Nm;function Yb(){if(Nm)return I_;Nm=1;var e=Nt(),t=e.Uint8Array;return I_=t,I_}var D_,Em;function id(){if(Em)return D_;Em=1;var e=Yb();function t(n){var i=new n.constructor(n.byteLength);return new e(i).set(new e(n)),i}return D_=t,D_}var R_,Im;function A7(){if(Im)return R_;Im=1;var e=id();function t(n,i){var o=i?e(n.buffer):n.buffer;return new n.constructor(o,n.byteOffset,n.byteLength)}return R_=t,R_}var O_,Dm;function $7(){if(Dm)return O_;Dm=1;var e=/\w*$/;function t(n){var i=new n.constructor(n.source,e.exec(n));return i.lastIndex=n.lastIndex,i}return O_=t,O_}var M_,Rm;function C7(){if(Rm)return M_;Rm=1;var e=Si(),t=e?e.prototype:void 0,n=t?t.valueOf:void 0;function i(o){return n?Object(n.call(o)):{}}return M_=i,M_}var q_,Om;function j7(){if(Om)return q_;Om=1;var e=id();function t(n,i){var o=i?e(n.buffer):n.buffer;return new n.constructor(o,n.byteOffset,n.length)}return q_=t,q_}var V_,Mm;function T7(){if(Mm)return V_;Mm=1;var e=id(),t=A7(),n=$7(),i=C7(),o=j7(),s="[object Boolean]",r="[object Date]",a="[object Map]",c="[object Number]",l="[object RegExp]",d="[object Set]",p="[object String]",f="[object Symbol]",m="[object ArrayBuffer]",v="[object DataView]",h="[object Float32Array]",w="[object Float64Array]",b="[object Int8Array]",g="[object Int16Array]",k="[object Int32Array]",y="[object Uint8Array]",$="[object Uint8ClampedArray]",j="[object Uint16Array]",C="[object Uint32Array]";function N(A,R,M){var T=A.constructor;switch(R){case m:return e(A);case s:case r:return new T(+A);case v:return t(A,M);case h:case w:case b:case g:case k:case y:case $:case j:case C:return o(A,M);case a:return new T;case c:case p:return new T(A);case l:return n(A);case d:return new T;case f:return i(A)}}return V_=N,V_}var F_,qm;function Jb(){if(qm)return F_;qm=1;var e=qn(),t=Object.create,n=function(){function i(){}return function(o){if(!e(o))return{};if(t)return t(o);i.prototype=o;var s=new i;return i.prototype=void 0,s}}();return F_=n,F_}var z_,Vm;function P7(){if(Vm)return z_;Vm=1;var e=Jb(),t=nd(),n=Ts();function i(o){return typeof o.constructor=="function"&&!n(o)?e(t(o)):{}}return z_=i,z_}var L_,Fm;function N7(){if(Fm)return L_;Fm=1;var e=$i(),t=Ht(),n="[object Map]";function i(o){return t(o)&&e(o)==n}return L_=i,L_}var B_,zm;function E7(){if(zm)return B_;zm=1;var e=N7(),t=Jl(),n=Xl(),i=n&&n.isMap,o=i?t(i):e;return B_=o,B_}var U_,Lm;function I7(){if(Lm)return U_;Lm=1;var e=$i(),t=Ht(),n="[object Set]";function i(o){return t(o)&&e(o)==n}return U_=i,U_}var W_,Bm;function D7(){if(Bm)return W_;Bm=1;var e=I7(),t=Jl(),n=Xl(),i=n&&n.isSet,o=i?t(i):e;return W_=o,W_}var H_,Um;function R7(){if(Um)return H_;Um=1;var e=Gl(),t=Kl(),n=Vb(),i=u7(),o=f7(),s=v7(),r=h7(),a=g7(),c=w7(),l=Gb(),d=b7(),p=$i(),f=S7(),m=T7(),v=P7(),h=je(),w=po(),b=E7(),g=qn(),k=D7(),y=zn(),$=Ql(),j=1,C=2,N=4,A="[object Arguments]",R="[object Array]",M="[object Boolean]",T="[object Date]",B="[object Error]",ne="[object Function]",Ye="[object GeneratorFunction]",_t="[object Map]",Ln="[object Number]",Gt="[object Object]",wt="[object RegExp]",yo="[object Set]",ko="[object String]",Bn="[object Symbol]",Vs="[object WeakMap]",Fs="[object ArrayBuffer]",zs="[object DataView]",Ls="[object Float32Array]",xo="[object Float64Array]",Bs="[object Int8Array]",tt="[object Int16Array]",Un="[object Int32Array]",Ti="[object Uint8Array]",j1="[object Uint8ClampedArray]",T1="[object Uint16Array]",P1="[object Uint32Array]",ce={};ce[A]=ce[R]=ce[Fs]=ce[zs]=ce[M]=ce[T]=ce[Ls]=ce[xo]=ce[Bs]=ce[tt]=ce[Un]=ce[_t]=ce[Ln]=ce[Gt]=ce[wt]=ce[yo]=ce[ko]=ce[Bn]=ce[Ti]=ce[j1]=ce[T1]=ce[P1]=!0,ce[B]=ce[ne]=ce[Vs]=!1;function So(ie,Wn,Hn,N1,Ao,Kt){var Je,$o=Wn&j,Co=Wn&C,E1=Wn&N;if(Hn&&(Je=Ao?Hn(ie,N1,Ao,Kt):Hn(ie)),Je!==void 0)return Je;if(!g(ie))return ie;var pu=h(ie);if(pu){if(Je=f(ie),!$o)return r(ie,Je)}else{var Gn=p(ie),mu=Gn==ne||Gn==Ye;if(w(ie))return s(ie,$o);if(Gn==Gt||Gn==A||mu&&!Ao){if(Je=Co||mu?{}:v(ie),!$o)return Co?c(ie,o(Je,ie)):a(ie,i(Je,ie))}else{if(!ce[Gn])return Ao?ie:{};Je=m(ie,Gn,$o)}}Kt||(Kt=new e);var fu=Kt.get(ie);if(fu)return fu;Kt.set(ie,Je),k(ie)?ie.forEach(function(Yt){Je.add(So(Yt,Wn,Hn,Yt,ie,Kt))}):b(ie)&&ie.forEach(function(Yt,ln){Je.set(ln,So(Yt,Wn,Hn,ln,ie,Kt))});var I1=E1?Co?d:l:Co?$:y,vu=pu?void 0:I1(ie);return t(vu||ie,function(Yt,ln){vu&&(ln=Yt,Yt=ie[ln]),n(Je,ln,So(Yt,Wn,Hn,ln,ie,Kt))}),Je}return H_=So,H_}var G_,Wm;function O7(){if(Wm)return G_;Wm=1;var e=R7(),t=4;function n(i){return e(i,t)}return G_=n,G_}var K_,Hm;function Xb(){if(Hm)return K_;Hm=1;function e(t){return function(){return t}}return K_=e,K_}var Y_,Gm;function M7(){if(Gm)return Y_;Gm=1;function e(t){return function(n,i,o){for(var s=-1,r=Object(n),a=o(n),c=a.length;c--;){var l=a[t?c:++s];if(i(r[l],l,r)===!1)break}return n}}return Y_=e,Y_}var J_,Km;function q7(){if(Km)return J_;Km=1;var e=M7(),t=e();return J_=t,J_}var X_,Ym;function Zb(){if(Ym)return X_;Ym=1;var e=q7(),t=zn();function n(i,o){return i&&e(i,o,t)}return X_=n,X_}var Z_,Jm;function V7(){if(Jm)return Z_;Jm=1;var e=Fn();function t(n,i){return function(o,s){if(o==null)return o;if(!e(o))return n(o,s);for(var r=o.length,a=i?r:-1,c=Object(o);(i?a--:++a<r)&&s(c[a],a,c)!==!1;);return o}}return Z_=t,Z_}var Q_,Xm;function Ps(){if(Xm)return Q_;Xm=1;var e=Zb(),t=V7(),n=t(e);return Q_=n,Q_}var ea,Zm;function Ns(){if(Zm)return ea;Zm=1;function e(t){return t}return ea=e,ea}var ta,Qm;function F7(){if(Qm)return ta;Qm=1;var e=Ns();function t(n){return typeof n=="function"?n:e}return ta=t,ta}var na,ef;function z7(){if(ef)return na;ef=1;var e=Kl(),t=Ps(),n=F7(),i=je();function o(s,r){var a=i(s)?e:t;return a(s,n(r))}return na=o,na}var ia,tf;function L7(){return tf||(tf=1,ia=z7()),ia}var oa,nf;function B7(){if(nf)return oa;nf=1;var e=Ps();function t(n,i){var o=[];return e(n,function(s,r,a){i(s,r,a)&&o.push(s)}),o}return oa=t,oa}var sa,of;function U7(){if(of)return sa;of=1;var e="__lodash_hash_undefined__";function t(n){return this.__data__.set(n,e),this}return sa=t,sa}var ra,sf;function W7(){if(sf)return ra;sf=1;function e(t){return this.__data__.has(t)}return ra=e,ra}var _a,rf;function Qb(){if(rf)return _a;rf=1;var e=Hl(),t=U7(),n=W7();function i(o){var s=-1,r=o==null?0:o.length;for(this.__data__=new e;++s<r;)this.add(o[s])}return i.prototype.add=i.prototype.push=t,i.prototype.has=n,_a=i,_a}var aa,_f;function H7(){if(_f)return aa;_f=1;function e(t,n){for(var i=-1,o=t==null?0:t.length;++i<o;)if(n(t[i],i,t))return!0;return!1}return aa=e,aa}var ca,af;function ey(){if(af)return ca;af=1;function e(t,n){return t.has(n)}return ca=e,ca}var la,cf;function ty(){if(cf)return la;cf=1;var e=Qb(),t=H7(),n=ey(),i=1,o=2;function s(r,a,c,l,d,p){var f=c&i,m=r.length,v=a.length;if(m!=v&&!(f&&v>m))return!1;var h=p.get(r),w=p.get(a);if(h&&w)return h==a&&w==r;var b=-1,g=!0,k=c&o?new e:void 0;for(p.set(r,a),p.set(a,r);++b<m;){var y=r[b],$=a[b];if(l)var j=f?l($,y,b,a,r,p):l(y,$,b,r,a,p);if(j!==void 0){if(j)continue;g=!1;break}if(k){if(!t(a,function(C,N){if(!n(k,N)&&(y===C||d(y,C,c,l,p)))return k.push(N)})){g=!1;break}}else if(!(y===$||d(y,$,c,l,p))){g=!1;break}}return p.delete(r),p.delete(a),g}return la=s,la}var da,lf;function G7(){if(lf)return da;lf=1;function e(t){var n=-1,i=Array(t.size);return t.forEach(function(o,s){i[++n]=[s,o]}),i}return da=e,da}var ua,df;function od(){if(df)return ua;df=1;function e(t){var n=-1,i=Array(t.size);return t.forEach(function(o){i[++n]=o}),i}return ua=e,ua}var pa,uf;function K7(){if(uf)return pa;uf=1;var e=Si(),t=Yb(),n=Ul(),i=ty(),o=G7(),s=od(),r=1,a=2,c="[object Boolean]",l="[object Date]",d="[object Error]",p="[object Map]",f="[object Number]",m="[object RegExp]",v="[object Set]",h="[object String]",w="[object Symbol]",b="[object ArrayBuffer]",g="[object DataView]",k=e?e.prototype:void 0,y=k?k.valueOf:void 0;function $(j,C,N,A,R,M,T){switch(N){case g:if(j.byteLength!=C.byteLength||j.byteOffset!=C.byteOffset)return!1;j=j.buffer,C=C.buffer;case b:return!(j.byteLength!=C.byteLength||!M(new t(j),new t(C)));case c:case l:case f:return n(+j,+C);case d:return j.name==C.name&&j.message==C.message;case m:case h:return j==C+"";case p:var B=o;case v:var ne=A&r;if(B||(B=s),j.size!=C.size&&!ne)return!1;var Ye=T.get(j);if(Ye)return Ye==C;A|=a,T.set(j,C);var _t=i(B(j),B(C),A,R,M,T);return T.delete(j),_t;case w:if(y)return y.call(j)==y.call(C)}return!1}return pa=$,pa}var ma,pf;function Y7(){if(pf)return ma;pf=1;var e=Gb(),t=1,n=Object.prototype,i=n.hasOwnProperty;function o(s,r,a,c,l,d){var p=a&t,f=e(s),m=f.length,v=e(r),h=v.length;if(m!=h&&!p)return!1;for(var w=m;w--;){var b=f[w];if(!(p?b in r:i.call(r,b)))return!1}var g=d.get(s),k=d.get(r);if(g&&k)return g==r&&k==s;var y=!0;d.set(s,r),d.set(r,s);for(var $=p;++w<m;){b=f[w];var j=s[b],C=r[b];if(c)var N=p?c(C,j,b,r,s,d):c(j,C,b,s,r,d);if(!(N===void 0?j===C||l(j,C,a,c,d):N)){y=!1;break}$||($=b=="constructor")}if(y&&!$){var A=s.constructor,R=r.constructor;A!=R&&"constructor"in s&&"constructor"in r&&!(typeof A=="function"&&A instanceof A&&typeof R=="function"&&R instanceof R)&&(y=!1)}return d.delete(s),d.delete(r),y}return ma=o,ma}var fa,mf;function J7(){if(mf)return fa;mf=1;var e=Gl(),t=ty(),n=K7(),i=Y7(),o=$i(),s=je(),r=po(),a=js(),c=1,l="[object Arguments]",d="[object Array]",p="[object Object]",f=Object.prototype,m=f.hasOwnProperty;function v(h,w,b,g,k,y){var $=s(h),j=s(w),C=$?d:o(h),N=j?d:o(w);C=C==l?p:C,N=N==l?p:N;var A=C==p,R=N==p,M=C==N;if(M&&r(h)){if(!r(w))return!1;$=!0,A=!1}if(M&&!A)return y||(y=new e),$||a(h)?t(h,w,b,g,k,y):n(h,w,C,b,g,k,y);if(!(b&c)){var T=A&&m.call(h,"__wrapped__"),B=R&&m.call(w,"__wrapped__");if(T||B){var ne=T?h.value():h,Ye=B?w.value():w;return y||(y=new e),k(ne,Ye,b,g,y)}}return M?(y||(y=new e),i(h,w,b,g,k,y)):!1}return fa=v,fa}var va,ff;function ny(){if(ff)return va;ff=1;var e=J7(),t=Ht();function n(i,o,s,r,a){return i===o?!0:i==null||o==null||!t(i)&&!t(o)?i!==i&&o!==o:e(i,o,s,r,n,a)}return va=n,va}var ha,vf;function X7(){if(vf)return ha;vf=1;var e=Gl(),t=ny(),n=1,i=2;function o(s,r,a,c){var l=a.length,d=l,p=!c;if(s==null)return!d;for(s=Object(s);l--;){var f=a[l];if(p&&f[2]?f[1]!==s[f[0]]:!(f[0]in s))return!1}for(;++l<d;){f=a[l];var m=f[0],v=s[m],h=f[1];if(p&&f[2]){if(v===void 0&&!(m in s))return!1}else{var w=new e;if(c)var b=c(v,h,m,s,r,w);if(!(b===void 0?t(h,v,n|i,c,w):b))return!1}}return!0}return ha=o,ha}var ga,hf;function iy(){if(hf)return ga;hf=1;var e=qn();function t(n){return n===n&&!e(n)}return ga=t,ga}var wa,gf;function Z7(){if(gf)return wa;gf=1;var e=iy(),t=zn();function n(i){for(var o=t(i),s=o.length;s--;){var r=o[s],a=i[r];o[s]=[r,a,e(a)]}return o}return wa=n,wa}var ba,wf;function oy(){if(wf)return ba;wf=1;function e(t,n){return function(i){return i==null?!1:i[t]===n&&(n!==void 0||t in Object(i))}}return ba=e,ba}var ya,bf;function Q7(){if(bf)return ya;bf=1;var e=X7(),t=Z7(),n=oy();function i(o){var s=t(o);return s.length==1&&s[0][2]?n(s[0][0],s[0][1]):function(r){return r===o||e(r,o,s)}}return ya=i,ya}var ka,yf;function sd(){if(yf)return ka;yf=1;var e=Ai(),t=Ht(),n="[object Symbol]";function i(o){return typeof o=="symbol"||t(o)&&e(o)==n}return ka=i,ka}var xa,kf;function rd(){if(kf)return xa;kf=1;var e=je(),t=sd(),n=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,i=/^\w*$/;function o(s,r){if(e(s))return!1;var a=typeof s;return a=="number"||a=="symbol"||a=="boolean"||s==null||t(s)?!0:i.test(s)||!n.test(s)||r!=null&&s in Object(r)}return xa=o,xa}var Sa,xf;function e5(){if(xf)return Sa;xf=1;var e=Hl(),t="Expected a function";function n(i,o){if(typeof i!="function"||o!=null&&typeof o!="function")throw new TypeError(t);var s=function(){var r=arguments,a=o?o.apply(this,r):r[0],c=s.cache;if(c.has(a))return c.get(a);var l=i.apply(this,r);return s.cache=c.set(a,l)||c,l};return s.cache=new(n.Cache||e),s}return n.Cache=e,Sa=n,Sa}var Aa,Sf;function t5(){if(Sf)return Aa;Sf=1;var e=e5(),t=500;function n(i){var o=e(i,function(r){return s.size===t&&s.clear(),r}),s=o.cache;return o}return Aa=n,Aa}var $a,Af;function n5(){if(Af)return $a;Af=1;var e=t5(),t=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,n=/\\(\\)?/g,i=e(function(o){var s=[];return o.charCodeAt(0)===46&&s.push(""),o.replace(t,function(r,a,c,l){s.push(c?l.replace(n,"$1"):a||r)}),s});return $a=i,$a}var Ca,$f;function _d(){if($f)return Ca;$f=1;function e(t,n){for(var i=-1,o=t==null?0:t.length,s=Array(o);++i<o;)s[i]=n(t[i],i,t);return s}return Ca=e,Ca}var ja,Cf;function i5(){if(Cf)return ja;Cf=1;var e=Si(),t=_d(),n=je(),i=sd(),o=1/0,s=e?e.prototype:void 0,r=s?s.toString:void 0;function a(c){if(typeof c=="string")return c;if(n(c))return t(c,a)+"";if(i(c))return r?r.call(c):"";var l=c+"";return l=="0"&&1/c==-o?"-0":l}return ja=a,ja}var Ta,jf;function o5(){if(jf)return Ta;jf=1;var e=i5();function t(n){return n==null?"":e(n)}return Ta=t,Ta}var Pa,Tf;function sy(){if(Tf)return Pa;Tf=1;var e=je(),t=rd(),n=n5(),i=o5();function o(s,r){return e(s)?s:t(s,r)?[s]:n(i(s))}return Pa=o,Pa}var Na,Pf;function Es(){if(Pf)return Na;Pf=1;var e=sd(),t=1/0;function n(i){if(typeof i=="string"||e(i))return i;var o=i+"";return o=="0"&&1/i==-t?"-0":o}return Na=n,Na}var Ea,Nf;function ry(){if(Nf)return Ea;Nf=1;var e=sy(),t=Es();function n(i,o){o=e(o,i);for(var s=0,r=o.length;i!=null&&s<r;)i=i[t(o[s++])];return s&&s==r?i:void 0}return Ea=n,Ea}var Ia,Ef;function s5(){if(Ef)return Ia;Ef=1;var e=ry();function t(n,i,o){var s=n==null?void 0:e(n,i);return s===void 0?o:s}return Ia=t,Ia}var Da,If;function r5(){if(If)return Da;If=1;function e(t,n){return t!=null&&n in Object(t)}return Da=e,Da}var Ra,Df;function _y(){if(Df)return Ra;Df=1;var e=sy(),t=Cs(),n=je(),i=Fb(),o=Yl(),s=Es();function r(a,c,l){c=e(c,a);for(var d=-1,p=c.length,f=!1;++d<p;){var m=s(c[d]);if(!(f=a!=null&&l(a,m)))break;a=a[m]}return f||++d!=p?f:(p=a==null?0:a.length,!!p&&o(p)&&i(m,p)&&(n(a)||t(a)))}return Ra=r,Ra}var Oa,Rf;function _5(){if(Rf)return Oa;Rf=1;var e=r5(),t=_y();function n(i,o){return i!=null&&t(i,o,e)}return Oa=n,Oa}var Ma,Of;function a5(){if(Of)return Ma;Of=1;var e=ny(),t=s5(),n=_5(),i=rd(),o=iy(),s=oy(),r=Es(),a=1,c=2;function l(d,p){return i(d)&&o(p)?s(r(d),p):function(f){var m=t(f,d);return m===void 0&&m===p?n(f,d):e(p,m,a|c)}}return Ma=l,Ma}var qa,Mf;function ay(){if(Mf)return qa;Mf=1;function e(t){return function(n){return n==null?void 0:n[t]}}return qa=e,qa}var Va,qf;function c5(){if(qf)return Va;qf=1;var e=ry();function t(n){return function(i){return e(i,n)}}return Va=t,Va}var Fa,Vf;function l5(){if(Vf)return Fa;Vf=1;var e=ay(),t=c5(),n=rd(),i=Es();function o(s){return n(s)?e(i(s)):t(s)}return Fa=o,Fa}var za,Ff;function Is(){if(Ff)return za;Ff=1;var e=Q7(),t=a5(),n=Ns(),i=je(),o=l5();function s(r){return typeof r=="function"?r:r==null?n:typeof r=="object"?i(r)?t(r[0],r[1]):e(r):o(r)}return za=s,za}var La,zf;function d5(){if(zf)return La;zf=1;var e=Bb(),t=B7(),n=Is(),i=je();function o(s,r){var a=i(s)?e:t;return a(s,n(r,3))}return La=o,La}var Ba,Lf;function u5(){if(Lf)return Ba;Lf=1;var e=Object.prototype,t=e.hasOwnProperty;function n(i,o){return i!=null&&t.call(i,o)}return Ba=n,Ba}var Ua,Bf;function p5(){if(Bf)return Ua;Bf=1;var e=u5(),t=_y();function n(i,o){return i!=null&&t(i,o,e)}return Ua=n,Ua}var Wa,Uf;function m5(){if(Uf)return Wa;Uf=1;var e=Zl(),t=$i(),n=Cs(),i=je(),o=Fn(),s=po(),r=Ts(),a=js(),c="[object Map]",l="[object Set]",d=Object.prototype,p=d.hasOwnProperty;function f(m){if(m==null)return!0;if(o(m)&&(i(m)||typeof m=="string"||typeof m.splice=="function"||s(m)||a(m)||n(m)))return!m.length;var v=t(m);if(v==c||v==l)return!m.size;if(r(m))return!e(m).length;for(var h in m)if(p.call(m,h))return!1;return!0}return Wa=f,Wa}var Ha,Wf;function f5(){if(Wf)return Ha;Wf=1;function e(t){return t===void 0}return Ha=e,Ha}var Ga,Hf;function v5(){if(Hf)return Ga;Hf=1;var e=Ps(),t=Fn();function n(i,o){var s=-1,r=t(i)?Array(i.length):[];return e(i,function(a,c,l){r[++s]=o(a,c,l)}),r}return Ga=n,Ga}var Ka,Gf;function h5(){if(Gf)return Ka;Gf=1;var e=_d(),t=Is(),n=v5(),i=je();function o(s,r){var a=i(s)?e:n;return a(s,t(r,3))}return Ka=o,Ka}var Ya,Kf;function g5(){if(Kf)return Ya;Kf=1;function e(t,n,i,o){var s=-1,r=t==null?0:t.length;for(o&&r&&(i=t[++s]);++s<r;)i=n(i,t[s],s,t);return i}return Ya=e,Ya}var Ja,Yf;function w5(){if(Yf)return Ja;Yf=1;function e(t,n,i,o,s){return s(t,function(r,a,c){i=o?(o=!1,r):n(i,r,a,c)}),i}return Ja=e,Ja}var Xa,Jf;function b5(){if(Jf)return Xa;Jf=1;var e=g5(),t=Ps(),n=Is(),i=w5(),o=je();function s(r,a,c){var l=o(r)?e:i,d=arguments.length<3;return l(r,n(a,4),c,d,t)}return Xa=s,Xa}var Za,Xf;function y5(){if(Xf)return Za;Xf=1;var e=Ai(),t=je(),n=Ht(),i="[object String]";function o(s){return typeof s=="string"||!t(s)&&n(s)&&e(s)==i}return Za=o,Za}var Qa,Zf;function k5(){if(Zf)return Qa;Zf=1;var e=ay(),t=e("length");return Qa=t,Qa}var ec,Qf;function x5(){if(Qf)return ec;Qf=1;var e="\\ud800-\\udfff",t="\\u0300-\\u036f",n="\\ufe20-\\ufe2f",i="\\u20d0-\\u20ff",o=t+n+i,s="\\ufe0e\\ufe0f",r="\\u200d",a=RegExp("["+r+e+o+s+"]");function c(l){return a.test(l)}return ec=c,ec}var tc,ev;function S5(){if(ev)return tc;ev=1;var e="\\ud800-\\udfff",t="\\u0300-\\u036f",n="\\ufe20-\\ufe2f",i="\\u20d0-\\u20ff",o=t+n+i,s="\\ufe0e\\ufe0f",r="["+e+"]",a="["+o+"]",c="\\ud83c[\\udffb-\\udfff]",l="(?:"+a+"|"+c+")",d="[^"+e+"]",p="(?:\\ud83c[\\udde6-\\uddff]){2}",f="[\\ud800-\\udbff][\\udc00-\\udfff]",m="\\u200d",v=l+"?",h="["+s+"]?",w="(?:"+m+"(?:"+[d,p,f].join("|")+")"+h+v+")*",b=h+v+w,g="(?:"+[d+a+"?",a,p,f,r].join("|")+")",k=RegExp(c+"(?="+c+")|"+g+b,"g");function y($){for(var j=k.lastIndex=0;k.test($);)++j;return j}return tc=y,tc}var nc,tv;function A5(){if(tv)return nc;tv=1;var e=k5(),t=x5(),n=S5();function i(o){return t(o)?n(o):e(o)}return nc=i,nc}var ic,nv;function $5(){if(nv)return ic;nv=1;var e=Zl(),t=$i(),n=Fn(),i=y5(),o=A5(),s="[object Map]",r="[object Set]";function a(c){if(c==null)return 0;if(n(c))return i(c)?o(c):c.length;var l=t(c);return l==s||l==r?c.size:e(c).length}return ic=a,ic}var oc,iv;function C5(){if(iv)return oc;iv=1;var e=Kl(),t=Jb(),n=Zb(),i=Is(),o=nd(),s=je(),r=po(),a=xs(),c=qn(),l=js();function d(p,f,m){var v=s(p),h=v||r(p)||l(p);if(f=i(f,4),m==null){var w=p&&p.constructor;h?m=v?new w:[]:c(p)?m=a(w)?t(o(p)):{}:m={}}return(h?e:n)(p,function(b,g,k){return f(m,b,g,k)}),m}return oc=d,oc}var sc,ov;function j5(){if(ov)return sc;ov=1;var e=Si(),t=Cs(),n=je(),i=e?e.isConcatSpreadable:void 0;function o(s){return n(s)||t(s)||!!(i&&s&&s[i])}return sc=o,sc}var rc,sv;function T5(){if(sv)return rc;sv=1;var e=td(),t=j5();function n(i,o,s,r,a){var c=-1,l=i.length;for(s||(s=t),a||(a=[]);++c<l;){var d=i[c];o>0&&s(d)?o>1?n(d,o-1,s,r,a):e(a,d):r||(a[a.length]=d)}return a}return rc=n,rc}var _c,rv;function P5(){if(rv)return _c;rv=1;function e(t,n,i){switch(i.length){case 0:return t.call(n);case 1:return t.call(n,i[0]);case 2:return t.call(n,i[0],i[1]);case 3:return t.call(n,i[0],i[1],i[2])}return t.apply(n,i)}return _c=e,_c}var ac,_v;function N5(){if(_v)return ac;_v=1;var e=P5(),t=Math.max;function n(i,o,s){return o=t(o===void 0?i.length-1:o,0),function(){for(var r=arguments,a=-1,c=t(r.length-o,0),l=Array(c);++a<c;)l[a]=r[o+a];a=-1;for(var d=Array(o+1);++a<o;)d[a]=r[a];return d[o]=s(l),e(i,this,d)}}return ac=n,ac}var cc,av;function E5(){if(av)return cc;av=1;var e=Xb(),t=Mb(),n=Ns(),i=t?function(o,s){return t(o,"toString",{configurable:!0,enumerable:!1,value:e(s),writable:!0})}:n;return cc=i,cc}var lc,cv;function I5(){if(cv)return lc;cv=1;var e=800,t=16,n=Date.now;function i(o){var s=0,r=0;return function(){var a=n(),c=t-(a-r);if(r=a,c>0){if(++s>=e)return arguments[0]}else s=0;return o.apply(void 0,arguments)}}return lc=i,lc}var dc,lv;function D5(){if(lv)return dc;lv=1;var e=E5(),t=I5(),n=t(e);return dc=n,dc}var uc,dv;function R5(){if(dv)return uc;dv=1;var e=Ns(),t=N5(),n=D5();function i(o,s){return n(t(o,s,e),o+"")}return uc=i,uc}var pc,uv;function O5(){if(uv)return pc;uv=1;function e(t,n,i,o){for(var s=t.length,r=i+(o?1:-1);o?r--:++r<s;)if(n(t[r],r,t))return r;return-1}return pc=e,pc}var mc,pv;function M5(){if(pv)return mc;pv=1;function e(t){return t!==t}return mc=e,mc}var fc,mv;function q5(){if(mv)return fc;mv=1;function e(t,n,i){for(var o=i-1,s=t.length;++o<s;)if(t[o]===n)return o;return-1}return fc=e,fc}var vc,fv;function V5(){if(fv)return vc;fv=1;var e=O5(),t=M5(),n=q5();function i(o,s,r){return s===s?n(o,s,r):e(o,t,r)}return vc=i,vc}var hc,vv;function F5(){if(vv)return hc;vv=1;var e=V5();function t(n,i){var o=n==null?0:n.length;return!!o&&e(n,i,0)>-1}return hc=t,hc}var gc,hv;function z5(){if(hv)return gc;hv=1;function e(t,n,i){for(var o=-1,s=t==null?0:t.length;++o<s;)if(i(n,t[o]))return!0;return!1}return gc=e,gc}var wc,gv;function L5(){if(gv)return wc;gv=1;function e(){}return wc=e,wc}var bc,wv;function B5(){if(wv)return bc;wv=1;var e=Kb(),t=L5(),n=od(),i=1/0,o=e&&1/n(new e([,-0]))[1]==i?function(s){return new e(s)}:t;return bc=o,bc}var yc,bv;function U5(){if(bv)return yc;bv=1;var e=Qb(),t=F5(),n=z5(),i=ey(),o=B5(),s=od(),r=200;function a(c,l,d){var p=-1,f=t,m=c.length,v=!0,h=[],w=h;if(d)v=!1,f=n;else if(m>=r){var b=l?null:o(c);if(b)return s(b);v=!1,f=i,w=new e}else w=l?[]:h;e:for(;++p<m;){var g=c[p],k=l?l(g):g;if(g=d||g!==0?g:0,v&&k===k){for(var y=w.length;y--;)if(w[y]===k)continue e;l&&w.push(k),h.push(g)}else f(w,k,d)||(w!==h&&w.push(k),h.push(g))}return h}return yc=a,yc}var kc,yv;function W5(){if(yv)return kc;yv=1;var e=Fn(),t=Ht();function n(i){return t(i)&&e(i)}return kc=n,kc}var xc,kv;function H5(){if(kv)return xc;kv=1;var e=T5(),t=R5(),n=U5(),i=W5(),o=t(function(s){return n(e(s,1,i,!0))});return xc=o,xc}var Sc,xv;function G5(){if(xv)return Sc;xv=1;var e=_d();function t(n,i){return e(i,function(o){return n[o]})}return Sc=t,Sc}var Ac,Sv;function K5(){if(Sv)return Ac;Sv=1;var e=G5(),t=zn();function n(i){return i==null?[]:e(i,t(i))}return Ac=n,Ac}var Qo;if(typeof ok=="function")try{Qo={clone:O7(),constant:Xb(),each:L7(),filter:d5(),has:p5(),isArray:je(),isEmpty:m5(),isFunction:xs(),isUndefined:f5(),keys:zn(),map:h5(),reduce:b5(),size:$5(),transform:C5(),union:H5(),values:K5()}}catch{}Qo||(Qo=window._);var ft=Qo,L=ft,ad=Y,Y5="\0",$n="\0",Av="";function Y(e){this._isDirected=L.has(e,"directed")?e.directed:!0,this._isMultigraph=L.has(e,"multigraph")?e.multigraph:!1,this._isCompound=L.has(e,"compound")?e.compound:!1,this._label=void 0,this._defaultNodeLabelFn=L.constant(void 0),this._defaultEdgeLabelFn=L.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[$n]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}Y.prototype._nodeCount=0;Y.prototype._edgeCount=0;Y.prototype.isDirected=function(){return this._isDirected};Y.prototype.isMultigraph=function(){return this._isMultigraph};Y.prototype.isCompound=function(){return this._isCompound};Y.prototype.setGraph=function(e){return this._label=e,this};Y.prototype.graph=function(){return this._label};Y.prototype.setDefaultNodeLabel=function(e){return L.isFunction(e)||(e=L.constant(e)),this._defaultNodeLabelFn=e,this};Y.prototype.nodeCount=function(){return this._nodeCount};Y.prototype.nodes=function(){return L.keys(this._nodes)};Y.prototype.sources=function(){var e=this;return L.filter(this.nodes(),function(t){return L.isEmpty(e._in[t])})};Y.prototype.sinks=function(){var e=this;return L.filter(this.nodes(),function(t){return L.isEmpty(e._out[t])})};Y.prototype.setNodes=function(e,t){var n=arguments,i=this;return L.each(e,function(o){n.length>1?i.setNode(o,t):i.setNode(o)}),this};Y.prototype.setNode=function(e,t){return L.has(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._isCompound&&(this._parent[e]=$n,this._children[e]={},this._children[$n][e]=!0),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)};Y.prototype.node=function(e){return this._nodes[e]};Y.prototype.hasNode=function(e){return L.has(this._nodes,e)};Y.prototype.removeNode=function(e){var t=this;if(L.has(this._nodes,e)){var n=function(i){t.removeEdge(t._edgeObjs[i])};delete this._nodes[e],this._isCompound&&(this._removeFromParentsChildList(e),delete this._parent[e],L.each(this.children(e),function(i){t.setParent(i)}),delete this._children[e]),L.each(L.keys(this._in[e]),n),delete this._in[e],delete this._preds[e],L.each(L.keys(this._out[e]),n),delete this._out[e],delete this._sucs[e],--this._nodeCount}return this};Y.prototype.setParent=function(e,t){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(L.isUndefined(t))t=$n;else{t+="";for(var n=t;!L.isUndefined(n);n=this.parent(n))if(n===e)throw new Error("Setting "+t+" as parent of "+e+" would create a cycle");this.setNode(t)}return this.setNode(e),this._removeFromParentsChildList(e),this._parent[e]=t,this._children[t][e]=!0,this};Y.prototype._removeFromParentsChildList=function(e){delete this._children[this._parent[e]][e]};Y.prototype.parent=function(e){if(this._isCompound){var t=this._parent[e];if(t!==$n)return t}};Y.prototype.children=function(e){if(L.isUndefined(e)&&(e=$n),this._isCompound){var t=this._children[e];if(t)return L.keys(t)}else{if(e===$n)return this.nodes();if(this.hasNode(e))return[]}};Y.prototype.predecessors=function(e){var t=this._preds[e];if(t)return L.keys(t)};Y.prototype.successors=function(e){var t=this._sucs[e];if(t)return L.keys(t)};Y.prototype.neighbors=function(e){var t=this.predecessors(e);if(t)return L.union(t,this.successors(e))};Y.prototype.isLeaf=function(e){var t;return this.isDirected()?t=this.successors(e):t=this.neighbors(e),t.length===0};Y.prototype.filterNodes=function(e){var t=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});t.setGraph(this.graph());var n=this;L.each(this._nodes,function(s,r){e(r)&&t.setNode(r,s)}),L.each(this._edgeObjs,function(s){t.hasNode(s.v)&&t.hasNode(s.w)&&t.setEdge(s,n.edge(s))});var i={};function o(s){var r=n.parent(s);return r===void 0||t.hasNode(r)?(i[s]=r,r):r in i?i[r]:o(r)}return this._isCompound&&L.each(t.nodes(),function(s){t.setParent(s,o(s))}),t};Y.prototype.setDefaultEdgeLabel=function(e){return L.isFunction(e)||(e=L.constant(e)),this._defaultEdgeLabelFn=e,this};Y.prototype.edgeCount=function(){return this._edgeCount};Y.prototype.edges=function(){return L.values(this._edgeObjs)};Y.prototype.setPath=function(e,t){var n=this,i=arguments;return L.reduce(e,function(o,s){return i.length>1?n.setEdge(o,s,t):n.setEdge(o,s),s}),this};Y.prototype.setEdge=function(){var e,t,n,i,o=!1,s=arguments[0];typeof s=="object"&&s!==null&&"v"in s?(e=s.v,t=s.w,n=s.name,arguments.length===2&&(i=arguments[1],o=!0)):(e=s,t=arguments[1],n=arguments[3],arguments.length>2&&(i=arguments[2],o=!0)),e=""+e,t=""+t,L.isUndefined(n)||(n=""+n);var r=mo(this._isDirected,e,t,n);if(L.has(this._edgeLabels,r))return o&&(this._edgeLabels[r]=i),this;if(!L.isUndefined(n)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(e),this.setNode(t),this._edgeLabels[r]=o?i:this._defaultEdgeLabelFn(e,t,n);var a=J5(this._isDirected,e,t,n);return e=a.v,t=a.w,Object.freeze(a),this._edgeObjs[r]=a,$v(this._preds[t],e),$v(this._sucs[e],t),this._in[t][r]=a,this._out[e][r]=a,this._edgeCount++,this};Y.prototype.edge=function(e,t,n){var i=arguments.length===1?cd(this._isDirected,arguments[0]):mo(this._isDirected,e,t,n);return this._edgeLabels[i]};Y.prototype.hasEdge=function(e,t,n){var i=arguments.length===1?cd(this._isDirected,arguments[0]):mo(this._isDirected,e,t,n);return L.has(this._edgeLabels,i)};Y.prototype.removeEdge=function(e,t,n){var i=arguments.length===1?cd(this._isDirected,arguments[0]):mo(this._isDirected,e,t,n),o=this._edgeObjs[i];return o&&(e=o.v,t=o.w,delete this._edgeLabels[i],delete this._edgeObjs[i],Cv(this._preds[t],e),Cv(this._sucs[e],t),delete this._in[t][i],delete this._out[e][i],this._edgeCount--),this};Y.prototype.inEdges=function(e,t){var n=this._in[e];if(n){var i=L.values(n);return t?L.filter(i,function(o){return o.v===t}):i}};Y.prototype.outEdges=function(e,t){var n=this._out[e];if(n){var i=L.values(n);return t?L.filter(i,function(o){return o.w===t}):i}};Y.prototype.nodeEdges=function(e,t){var n=this.inEdges(e,t);if(n)return n.concat(this.outEdges(e,t))};function $v(e,t){e[t]?e[t]++:e[t]=1}function Cv(e,t){--e[t]||delete e[t]}function mo(e,t,n,i){var o=""+t,s=""+n;if(!e&&o>s){var r=o;o=s,s=r}return o+Av+s+Av+(L.isUndefined(i)?Y5:i)}function J5(e,t,n,i){var o=""+t,s=""+n;if(!e&&o>s){var r=o;o=s,s=r}var a={v:o,w:s};return i&&(a.name=i),a}function cd(e,t){return mo(e,t.v,t.w,t.name)}var X5="2.1.8",Z5={Graph:ad,version:X5},jt=ft,Q5=ad,eT={write:tT,read:oT};function tT(e){var t={options:{directed:e.isDirected(),multigraph:e.isMultigraph(),compound:e.isCompound()},nodes:nT(e),edges:iT(e)};return jt.isUndefined(e.graph())||(t.value=jt.clone(e.graph())),t}function nT(e){return jt.map(e.nodes(),function(t){var n=e.node(t),i=e.parent(t),o={v:t};return jt.isUndefined(n)||(o.value=n),jt.isUndefined(i)||(o.parent=i),o})}function iT(e){return jt.map(e.edges(),function(t){var n=e.edge(t),i={v:t.v,w:t.w};return jt.isUndefined(t.name)||(i.name=t.name),jt.isUndefined(n)||(i.value=n),i})}function oT(e){var t=new Q5(e.options).setGraph(e.value);return jt.each(e.nodes,function(n){t.setNode(n.v,n.value),n.parent&&t.setParent(n.v,n.parent)}),jt.each(e.edges,function(n){t.setEdge({v:n.v,w:n.w,name:n.name},n.value)}),t}var Io=ft,sT=rT;function rT(e){var t={},n=[],i;function o(s){Io.has(t,s)||(t[s]=!0,i.push(s),Io.each(e.successors(s),o),Io.each(e.predecessors(s),o))}return Io.each(e.nodes(),function(s){i=[],o(s),i.length&&n.push(i)}),n}var cy=ft,ly=vt;function vt(){this._arr=[],this._keyIndices={}}vt.prototype.size=function(){return this._arr.length};vt.prototype.keys=function(){return this._arr.map(function(e){return e.key})};vt.prototype.has=function(e){return cy.has(this._keyIndices,e)};vt.prototype.priority=function(e){var t=this._keyIndices[e];if(t!==void 0)return this._arr[t].priority};vt.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key};vt.prototype.add=function(e,t){var n=this._keyIndices;if(e=String(e),!cy.has(n,e)){var i=this._arr,o=i.length;return n[e]=o,i.push({key:e,priority:t}),this._decrease(o),!0}return!1};vt.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var e=this._arr.pop();return delete this._keyIndices[e.key],this._heapify(0),e.key};vt.prototype.decrease=function(e,t){var n=this._keyIndices[e];if(t>this._arr[n].priority)throw new Error("New priority is greater than current priority. Key: "+e+" Old: "+this._arr[n].priority+" New: "+t);this._arr[n].priority=t,this._decrease(n)};vt.prototype._heapify=function(e){var t=this._arr,n=2*e,i=n+1,o=e;n<t.length&&(o=t[n].priority<t[o].priority?n:o,i<t.length&&(o=t[i].priority<t[o].priority?i:o),o!==e&&(this._swap(e,o),this._heapify(o)))};vt.prototype._decrease=function(e){for(var t=this._arr,n=t[e].priority,i;e!==0&&(i=e>>1,!(t[i].priority<n));)this._swap(e,i),e=i};vt.prototype._swap=function(e,t){var n=this._arr,i=this._keyIndices,o=n[e],s=n[t];n[e]=s,n[t]=o,i[s.key]=e,i[o.key]=t};var _T=ft,aT=ly,dy=lT,cT=_T.constant(1);function lT(e,t,n,i){return dT(e,String(t),n||cT,i||function(o){return e.outEdges(o)})}function dT(e,t,n,i){var o={},s=new aT,r,a,c=function(l){var d=l.v!==r?l.v:l.w,p=o[d],f=n(l),m=a.distance+f;if(f<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+l+" Weight: "+f);m<p.distance&&(p.distance=m,p.predecessor=r,s.decrease(d,m))};for(e.nodes().forEach(function(l){var d=l===t?0:Number.POSITIVE_INFINITY;o[l]={distance:d},s.add(l,d)});s.size()>0&&(r=s.removeMin(),a=o[r],a.distance!==Number.POSITIVE_INFINITY);)i(r).forEach(c);return o}var uT=dy,pT=ft,mT=fT;function fT(e,t,n){return pT.transform(e.nodes(),function(i,o){i[o]=uT(e,o,t,n)},{})}var jv=ft,uy=vT;function vT(e){var t=0,n=[],i={},o=[];function s(r){var a=i[r]={onStack:!0,lowlink:t,index:t++};if(n.push(r),e.successors(r).forEach(function(d){jv.has(i,d)?i[d].onStack&&(a.lowlink=Math.min(a.lowlink,i[d].index)):(s(d),a.lowlink=Math.min(a.lowlink,i[d].lowlink))}),a.lowlink===a.index){var c=[],l;do l=n.pop(),i[l].onStack=!1,c.push(l);while(r!==l);o.push(c)}}return e.nodes().forEach(function(r){jv.has(i,r)||s(r)}),o}var hT=ft,gT=uy,wT=bT;function bT(e){return hT.filter(gT(e),function(t){return t.length>1||t.length===1&&e.hasEdge(t[0],t[0])})}var yT=ft,kT=ST,xT=yT.constant(1);function ST(e,t,n){return AT(e,t||xT,n||function(i){return e.outEdges(i)})}function AT(e,t,n){var i={},o=e.nodes();return o.forEach(function(s){i[s]={},i[s][s]={distance:0},o.forEach(function(r){s!==r&&(i[s][r]={distance:Number.POSITIVE_INFINITY})}),n(s).forEach(function(r){var a=r.v===s?r.w:r.v,c=t(r);i[s][a]={distance:c,predecessor:s}})}),o.forEach(function(s){var r=i[s];o.forEach(function(a){var c=i[a];o.forEach(function(l){var d=c[s],p=r[l],f=c[l],m=d.distance+p.distance;m<f.distance&&(f.distance=m,f.predecessor=p.predecessor)})})}),i}var Ii=ft,py=my;my.CycleException=es;function my(e){var t={},n={},i=[];function o(s){if(Ii.has(n,s))throw new es;Ii.has(t,s)||(n[s]=!0,t[s]=!0,Ii.each(e.predecessors(s),o),delete n[s],i.push(s))}if(Ii.each(e.sinks(),o),Ii.size(t)!==e.nodeCount())throw new es;return i}function es(){}es.prototype=new Error;var Tv=py,$T=CT;function CT(e){try{Tv(e)}catch(t){if(t instanceof Tv.CycleException)return!1;throw t}return!0}var ts=ft,fy=jT;function jT(e,t,n){ts.isArray(t)||(t=[t]);var i=(e.isDirected()?e.successors:e.neighbors).bind(e),o=[],s={};return ts.each(t,function(r){if(!e.hasNode(r))throw new Error("Graph does not have node: "+r);vy(e,r,n==="post",s,i,o)}),o}function vy(e,t,n,i,o,s){ts.has(i,t)||(i[t]=!0,n||s.push(t),ts.each(o(t),function(r){vy(e,r,n,i,o,s)}),n&&s.push(t))}var TT=fy,PT=NT;function NT(e,t){return TT(e,t,"post")}var ET=fy,IT=DT;function DT(e,t){return ET(e,t,"pre")}var Pv=ft,RT=ad,OT=ly,MT=qT;function qT(e,t){var n=new RT,i={},o=new OT,s;function r(c){var l=c.v===s?c.w:c.v,d=o.priority(l);if(d!==void 0){var p=t(c);p<d&&(i[l]=s,o.decrease(l,p))}}if(e.nodeCount()===0)return n;Pv.each(e.nodes(),function(c){o.add(c,Number.POSITIVE_INFINITY),n.setNode(c)}),o.decrease(e.nodes()[0],0);for(var a=!1;o.size()>0;){if(s=o.removeMin(),Pv.has(i,s))n.setEdge(s,i[s]);else{if(a)throw new Error("Input graph is not connected: "+e);a=!0}e.nodeEdges(s).forEach(r)}return n}var VT={components:sT,dijkstra:dy,dijkstraAll:mT,findCycles:wT,floydWarshall:kT,isAcyclic:$T,postorder:PT,preorder:IT,prim:MT,tarjan:uy,topsort:py},Nv=Z5,fo={Graph:Nv.Graph,json:eT,alg:VT,version:Nv.version};const hy=sk(fo),FT=ck({__proto__:null,default:hy},[fo]),zT=(hy||FT).alg;function LT(e){const{items:t,get_id:n,get_head_ids:i,get_tail_ids:o}=e,s=new fo.Graph;t.forEach(a=>s.setNode(n(a),a));const r=a=>s.hasNode(a);return t.forEach(a=>{const c=n(a);i(a).filter(r).forEach(l=>s.setEdge(c,l)),o(a).filter(r).forEach(l=>s.setEdge(l,c))}),s}function Ev(e){const{graph:t}=e,n=BT({graph:t}),i=[];return n.forEach(o=>{Xi(o).forEach(r=>{const a=[r,...Dt(t,r)];i.push(a)})}),i}function BT(e){const{graph:t}=e;return zT.components(t).map(i=>{const o=new fo.Graph;return i.forEach(s=>{o.setNode(s,t.node(s)),(t.nodeEdges(s)||[]).forEach(a=>o.setEdge(a))}),o})}function Xi(e){return e.nodes().filter(n=>(e.successors(n)||[]).length===0)}function Dt(e,t,n=!1){const i=e.predecessors(t)||[],o=new Set;let s=i.pop()||"";for(;s;){if(!o.has(s)&&(n||s!==t)){o.add(s);const r=e.predecessors(s)||[];i.push(...r)}s=i.pop()||""}return Array.from(o)}function Do(e,t){const n=Xi(e),i=fo.alg.dijkstra(e,t);return n.filter(o=>i[o].distance<Number.POSITIVE_INFINITY)}const UT=x.delay("graph related functions",()=>{const e=b=>b.id,t=b=>b.head_ids,n=b=>b.tail_ids,i=b=>LT({items:b,get_id:e,get_head_ids:t,get_tail_ids:n});function o(b,g,k){u(b.node(g),k.item);const y=b.outEdges(g)||[];u(y.map(j=>j.w),k.head_ids);const $=b.inEdges(g)||[];u($.map(j=>j.v),k.tail_ids)}function s(){const b=[{id:"1",head_ids:[],tail_ids:[]}],g=i(b);return{items:b,graph:g}}function r(){const b=[{id:"1",head_ids:["2","4"],tail_ids:[]},{id:"2",head_ids:["1","3"],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]}],g=i(b);return{items:b,graph:g}}function a(){const b=[{id:"1",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:[],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:["5"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]}],g=i(b);return{items:b,graph:g}}function c(){const b=[{id:"1",head_ids:[],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["4"],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:["5"],tail_ids:[]},{id:"7",head_ids:["6"],tail_ids:[]},{id:"8",head_ids:["10"],tail_ids:[]},{id:"9",head_ids:["8"],tail_ids:[]},{id:"10",head_ids:["9"],tail_ids:[]},{id:"11",head_ids:["12","13"],tail_ids:["12","13"]},{id:"12",head_ids:["11","13"],tail_ids:["11","13"]},{id:"13",head_ids:["12","11"],tail_ids:["12","11"]},{id:"14",head_ids:["14"],tail_ids:["14"]},{id:"15",head_ids:[],tail_ids:["16"]},{id:"16",head_ids:[],tail_ids:[]},{id:"17",head_ids:["16"],tail_ids:[]},{id:"15b",head_ids:[],tail_ids:[]},{id:"16b",head_ids:["15b"],tail_ids:["17b"]},{id:"17b",head_ids:[],tail_ids:[]}],g=i(b);return{items:b,graph:g}}function l(){const b=[{id:"4",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["2","1","4","7"],tail_ids:[]},{id:"1",head_ids:["5","6","9"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:[],tail_ids:[]},{id:"7",head_ids:["8"],tail_ids:[]},{id:"8",head_ids:["7"],tail_ids:[]},{id:"9",head_ids:["5"],tail_ids:[]}],g=i(b);return{items:b,graph:g}}function d(){const b=[{id:"1",head_ids:["2"],tail_ids:["3"]}],g=i(b);return{items:b,graph:g}}const p=s(),f=c(),m=r(),v=a(),h=l(),w=d();x("graph",()=>{o(p.graph,"0",{item:void 0,head_ids:[],tail_ids:[]}),o(p.graph,"1",{item:p.items[0],head_ids:[],tail_ids:[]}),o(f.graph,"1",{item:f.items[0],head_ids:[],tail_ids:[]}),o(f.graph,"2",{item:f.items[1],head_ids:["3"],tail_ids:[]}),o(f.graph,"3",{item:f.items[2],head_ids:["4"],tail_ids:["2"]}),o(f.graph,"4",{item:f.items[3],head_ids:[],tail_ids:["3"]}),o(f.graph,"5",{item:f.items[4],head_ids:[],tail_ids:["6"]}),o(f.graph,"6",{item:f.items[5],head_ids:["5"],tail_ids:["7"]}),o(f.graph,"7",{item:f.items[6],head_ids:["6"],tail_ids:[]}),o(f.graph,"8",{item:f.items[7],head_ids:["10"],tail_ids:["9"]}),o(f.graph,"9",{item:f.items[8],head_ids:["8"],tail_ids:["10"]}),o(f.graph,"10",{item:f.items[9],head_ids:["9"],tail_ids:["8"]}),o(f.graph,"11",{item:f.items[10],head_ids:["12","13"],tail_ids:["12","13"]}),o(f.graph,"12",{item:f.items[11],head_ids:["11","13"],tail_ids:["11","13"]}),o(f.graph,"13",{item:f.items[12],head_ids:["11","12"],tail_ids:["11","12"]}),o(f.graph,"14",{item:f.items[13],head_ids:["14"],tail_ids:["14"]}),o(f.graph,"15",{item:f.items[14],head_ids:[],tail_ids:["16"]}),o(f.graph,"16",{item:f.items[15],head_ids:["15"],tail_ids:["17"]}),o(f.graph,"17",{item:f.items[16],head_ids:["16"],tail_ids:[]}),o(f.graph,"15b",{item:f.items[17],head_ids:[],tail_ids:["16b"]}),o(f.graph,"16b",{item:f.items[18],head_ids:["15b"],tail_ids:["17b"]}),o(f.graph,"17b",{item:f.items[19],head_ids:["16b"],tail_ids:[]}),o(w.graph,"1",{item:w.items[0],head_ids:[],tail_ids:[]})}),x("find_leaf_ids",()=>{u(Xi(m.graph),["3","4"]),u(Xi(v.graph),["2","3","5"]),u(Xi(h.graph),["5","6"])}),x("find_leaf_ids_for_id",()=>{u(Do(h.graph,"12"),[]),u(Do(h.graph,"1"),["5","6"]),u(Do(h.graph,"2"),["5","6"]),u(Do(h.graph,"7"),[])}),x("find_leaf_group_ids",()=>{u(Ev(p),[["1"]]),u(Ev(m),[["3","2","1"],["4","1","2"]])}),x("find_all_predecessor_ids",()=>{u(Dt(p.graph,"1"),[]),u(Dt(m.graph,"1"),["2"]),u(Dt(m.graph,"2"),["1"]),u(Dt(m.graph,"3"),["2","1"]),u(Dt(m.graph,"4"),["1","2"]),u(Dt(h.graph,"2"),["4","3"]),u(Dt(h.graph,"8"),["7","3","2","4"]),u(Dt(h.graph,"5"),["9","1","3","2","4"])})});function Yn(e,t={}){const n=t.sort_items??!1,i=t.render_undefined??!1,o=typeof t.space=="number"?Array(t.space+1).join(" "):t.space||"",s=typeof t.cycles=="boolean"?t.cycles:!1,r=t.replacer||((l,d)=>WT(d)?d.toISOString():d instanceof Set?Array.from(d).sort():d),a=t.comparison_function&&function(l){return function(d,p){return t.comparison_function({key:d,value:l[d]},{key:p,value:l[p]})}},c=[];return function l(d,p,f,m){const v=o?`
`+new Array(m+1).join(o):"",h=o?": ":":";if(f=r.call(d,p,f),f===void 0)return i?"undefined":void 0;if(typeof f!="object"||f===null)return JSON.stringify(f);if(Array.isArray(f)){const g=[];for(let k=0;k<f.length;k++){const y=l(f,k,f[k],m+1)||JSON.stringify(null);g.push(v+o+y)}return"["+g.join(",")+v+"]"}if(c.indexOf(f)!==-1){if(s)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else c.push(f);let w=Object.keys(f);n&&(w=w.sort(a&&a(f)));const b=[];return w.forEach(g=>{const k=l(f,g,f[g],m+1);if(!k)return;const y=JSON.stringify(g)+h+k;b.push(v+o+y)}),c.splice(c.indexOf(f),1),"{"+b.join(",")+v+"}"}({"":e},"",e,0)}function WT(e){return Object.prototype.toString.call(e)==="[object Date]"}const HT=x.delay("stable_stringify",()=>{let e="";e=Yn({a:1,b:2,c:3}),u(e,'{"a":1,"b":2,"c":3}',"regular object"),e=Yn({c:3,b:2,a:1}),u(e,'{"c":3,"b":2,"a":1}',"regular object with keys in reverse order remains unchanged by default"),e=Yn({c:3,b:2,a:1},{sort_items:!0}),u(e,'{"a":1,"b":2,"c":3}',"regular object with keys in reverse order are sorted if requested"),e=Yn({a:{b:{c:3}}}),u(e,'{"a":{"b":{"c":3}}}',"nested object"),e=Yn({a:void 0}),u(e,"{}","object with undefined not rendered by default"),e=Yn({a:void 0},{render_undefined:!0}),u(e,'{"a":undefined}',"object with undefined rendered when render_undefined is true")}),GT=x.delay("test sync",()=>{u(!0,!0,"should handle sync")}),KT=x.delay("test async",async()=>{await new Promise(e=>setTimeout(e,0)),u(!0,!0,"should handle async"),await x("test nested async",async()=>{await new Promise(e=>setTimeout(e,0)),u(!0,!0,"should handle nested async")}),x("test sync nested in async",()=>{u(!0,!0,"should handle sync nested in async")})});function Pe(e){let t,n;const{conviction:i,probability:o,counterfactual_conviction:s,counterfactual_probability:r}=e,a=r===void 0&&s===void 0;return i!==1&&(n=1),a&&(o===1&&i!==1||o!==1)?t=1:r!==0&&(o===0&&i!==1||o!==0)?t=0:(t=void 0,n=void 0),{new_counterfactual_probability:t,new_counterfactual_conviction:n}}const YT=x.delay("calc_new_counterfactual_state",()=>{let e,t,n,i,o;e=.5,t=1,o=Pe({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=1,t=1,o=Pe({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=0,t=1,o=Pe({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=.5,t=.5,o=Pe({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=1,t=.5,o=Pe({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=0,t=.5,o=Pe({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Pe({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0)}),JT=/^(([ ]{0,3}```)|([ ]{4,})).*/gm,Iv=/^[ \t]*(\*|\d+\.)/gm,Dv=/^[ \t]*[^\s]+/gm;function Qt(e){const t=[];let n=!1;const i=e.split(`
`);return i.forEach((s,r)=>{if(r>0){const a=i[r-1];a.match(JT)&&(n=!n),n||a.match(Dv)&&!a.match(Iv)&&(s.match(Iv)?t[r-1]=a+`
`:s.match(Dv)&&(t[r-1]=a+"<br>"))}t.push(s)}),t.join(`
`)}const XT=x.delay("add_newlines_to_markdown",()=>{u(Qt(`
test 1
test2
`),`
test 1<br>
test2
`);const e=`* Test bullet 1
* Test bullet 2`;u(Qt(e),e);let n=Qt(`Test 1
Test
  Test 3  
	Test 4
* Test bullet 1
* Test bullet 2

Test 5
1. Test number 1
2. Test number 2

`),i=`Test 1<br>
Test<br>
  Test 3  <br>
	Test 4

* Test bullet 1
* Test bullet 2

Test 5

1. Test number 1
2. Test number 2

`;u(n,i),x("Code blocks should not contain <br>",()=>{n=Qt("\n```\nsome text\n```\n"),i="\n```\nsome text\n```\n",u(n,i,"Three ``` should stop <br> insertion"),n=Qt("\n   ```\nsome text\n```\n"),i="\n   ```\nsome text\n```\n",u(n,i,"Three ``` with three prepended spaces should stop <br> insertion"),n=Qt(`
   more text
   some more text
`),i=`
   more text<br>
   some more text
`,u(n,i,"Three prepended spaces for normal text should allow <br> insertion"),n=Qt("\n    ```some text\n    some more text\n"),i="\n    ```some text\n    some more text\n",u(n,i,"Four prepended spaces for ``` and normal text should stop <br> insertion")})}),ZT=x.delay("run_get_rich_text",()=>{let e;x("replace_ids_in_text",()=>{const t=le(1),n=le(2),i=le(3),s=new Date("2021-05-12").getTime(),r={[t]:qt({base_id:-1,id:t,title:`@@${i} was told @@${n} is here`}),[n]:qt({base_id:-1,id:n,title:"Person A"}),[i]:qt({base_id:-1,id:i,title:"Person B"})},a={},c={text_type:fe.rich,wcomponents_by_id:r,knowledge_views_by_id:a,wc_id_to_counterfactuals_map:void 0,created_at_ms:s,sim_ms:s};e=ni({...c,text_type:fe.raw,text:`Yesterday @@${t} today`}),u(e,`Yesterday @@${t} today`,"Should not replace ids when text_type is RichTextType.raw"),e=ni({...c,text_type:fe.plain,text:`Yesterday @@${t} today`}),u(e,"Yesterday Person B was told Person A is here today","Should replace ids with only text and no links when text_type is RichTextType.plain"),e=ni({...c,text_type:fe.rich,text:`Yesterday @@${t} today`}),u(e,`Yesterday [Person B was told Person A is here](#wcomponents/${t}) today`,"Should replace ids with text and links when text_type is RichTextType.rich.  And should not render lower depth links so as not to have nested broken links.")}),x("get_title",()=>{const t=new Date("2021-05-12"),n=t.getTime(),i=A=>{const R={id:"vps"+A.id,created_at:t,base_id:-1,datetime:{},entries:[{id:"VAP"+A.id,explanation:"",probability:1,conviction:1,value:"",description:""}]};return qt({...A,base_id:-1,type:"statev2",subtype:"boolean",values_and_prediction_sets:[R]})},o=le(1),s=le(2),r=le(3),a=le(4),c=le(5),l=le(6),d=le(7),p=le(8),f=le(9),m=i({id:o,title:"aaa"}),v=i({id:s,title:`bbb @@${o}`}),h=i({id:r,title:"ccc ${value}"}),w=i({id:a,title:`ddd @@${r}`}),b=i({id:c,title:`eee \${value} @@${a}`}),g=i({id:l,title:`fff @@${c}`}),k=i({id:d,title:`ggg @@${l}`}),y=i({id:p,title:`Recursive @@${p}`}),$=i({id:f,title:`Recursive @@${f}.title`}),j={[m.id]:m,[v.id]:v,[h.id]:h,[w.id]:w,[b.id]:b,[g.id]:g,[k.id]:k,[y.id]:y,[$.id]:$},C={};function N(A){const{id:R,text_type:M,wc_id_to_counterfactuals_map:T}=A;return mt({text_type:M,wcomponents_by_id:j,knowledge_views_by_id:C,wcomponent:j[R],wc_id_to_counterfactuals_map:T,created_at_ms:n,sim_ms:n})}x("get_title",()=>{const A={[m.id]:"aaa",[v.id]:`bbb @@${o}`,[h.id]:"ccc ${value}",[w.id]:`ddd @@${r}`,[b.id]:`eee \${value} @@${a}`},R={[m.id]:"aaa",[v.id]:"bbb aaa",[h.id]:"ccc True",[w.id]:"ddd ccc True",[b.id]:"eee True ddd ccc True"},M={[m.id]:"aaa",[v.id]:`bbb [aaa](#wcomponents/${o})`,[h.id]:"ccc True",[w.id]:`ddd [ccc True](#wcomponents/${r})`,[b.id]:`eee True [ddd ccc True](#wcomponents/${a})`};Object.entries(A).forEach(([T,B])=>{e=N({id:T,text_type:fe.raw}),u(e,B)}),Object.entries(R).forEach(([T,B])=>{e=N({id:T,text_type:fe.plain}),u(e,B)}),Object.entries(M).forEach(([T,B])=>{e=N({id:T,text_type:fe.rich}),u(e,B)})}),x("depth_limit",()=>{e=N({id:k.id,text_type:fe.rich}),u(e,`ggg [fff eee True ddd @@${r}](#wcomponents/${l})`,"Should stop recursively rendering ids when a depth limit is reached"),e=N({id:y.id,text_type:fe.rich}),u(e,"Recursive [Recursive Recursive Recursive @@80000000-0000-4000-a000-000000000000](#wcomponents/80000000-0000-4000-a000-000000000000)","Should handle recursion for normal recursive titles."),e=N({id:$.id,text_type:fe.rich}),u(!0,!0,"Should handle recursion for '.title' functional ids of recursive titles.")}),x("counterfactuals",()=>{const A={[h.id]:"ccc False",[w.id]:`ddd [ccc False](#wcomponents/${r})`,[b.id]:`eee True [ddd ccc False](#wcomponents/${a})`},R={[h.id]:{VAP_sets:{[`vps${r}`]:[{id:"wc999000",type:"counterfactualv2",created_at:t,base_id:-1,title:"",description:"",target_wcomponent_id:h.id,target_VAP_set_id:`vps${r}`,target_VAP_id:yb}]}}};Object.entries(A).forEach(([M,T])=>{e=N({id:M,text_type:fe.rich,wc_id_to_counterfactuals_map:R}),u(e,T,"Should override values correctly using counterfactualv2 value")})})}),x.skip("replace_ids_in_text -> replace_calculations_with_results",()=>{const t=le(1),i=new Date("2023-08-14").getTime(),o={[t]:qt({base_id:-1,id:t,title:"UK Homes"})},s={},r={text_type:fe.rich,wcomponents_by_id:o,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:void 0,created_at_ms:i,sim_ms:i},c=ni({...r,text:`
    $$!
    value: 123
    $$!
    `});u(c,`
123
`,"Should replace calculation with string value")})}),QT=x.delay("remove_rich_text",()=>{let e,t,n;e="Something [linked](http://example.com).",t=tn(e),n="Something linked.",u(t,n,"Should remove links in middle"),e="[Linked](http://example.com) here.",t=tn(e),n="Linked here.",u(t,n,"Should remove links at start"),e="[Linked](http://example.com) here and [here](https://other.example.com)",t=tn(e),n="Linked here and here",u(t,n,"Should remove multiple links at start"),e="<auto generated>Text with <auto generated> in it <auto generated>",t=tn(e),n="Text with in it",u(t,n,"Should remove <auto generated> tags"),e="Italicised <i>text<i/>",t=tn(e),n="Italicised text",u(t,n,"Should remove tags")}),eP=x.delay("replace_normal_ids",()=>{let e="",t="",n="";const i=le(1),o=le(9),s={[i]:qt({base_id:-1,id:i,title:"Title 1"})};let r;x("render_links: true",()=>{r={wcomponents_by_id:s,depth_limit:2,render_links:!0,root_url:"http://datacurator.org",get_title:a=>a.title},e="",n="",t=Zt(e,1,r),u(t,n,"Should handle replacing ids in empty string"),e=`Some text
    with an @@id in
    it: @@${i}.
    `,n=`Some text
    with an @@id in
    it: [Title 1](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).
    `,t=Zt(e,1,r),u(t,n,"Should replace id with component title"),e=`An @@id to a component that's not found: @@${o}.`,n="An @@id to a component that's not found: ✗[@@90000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/90000000-0000-4000-a000-000000000000) (not found).",t=Zt(e,1,r),u(t,n,"Should handle missing components"),e=`Out of depth @@${i}.`,n="Out of depth [@@10000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).",t=Zt(e,2,r),u(t,n,"Should not replace with component title when depth is exceeded")}),x("render_links: false",()=>{r={wcomponents_by_id:s,depth_limit:2,render_links:!1,root_url:"http://datacurator.org",get_title:a=>a.title},e=`Some @@id: @@${i}.`,n="Some @@id: Title 1.",t=Zt(e,1,r),u(t,n,"Should replace id with component title but no link when render_links is false"),e=`An @@id to a component that's not found: @@${o}.`,n="An @@id to a component that's not found: ✗@@90000000-0000-4000-a000-000000000000 (not found).",t=Zt(e,1,r),u(t,n,"Should handle missing components but not add link when render_links is false"),e=`Out of depth @@${i}.`,n="Out of depth @@10000000-0000-4000-a000-000000000000.",t=Zt(e,2,r),u(t,n,"Should not replace with component title when depth is exceeded and not add link when render_links is false")})}),tP=x.delay("derived_composed_wcomponents_by_id_reducer",()=>{const e=new Date("2023-10-05"),t=new Date("2023-10-06"),n=new Date("2023-10-07"),i=le(1),o=le(2),s=le(3);let r,a,c,l,d,p;function f(h){return q({base_id:-1,type:"statev2",...h})}function m(h){return q({base_id:-1,type:"state_value",...h})}function v(h,w,b){let g=gb();const k=We({base_id:-1,id:s,title:"Test KV",sort_type:"priority"}),y=mb(g);return g=y(g,S.specialised_object.upsert_knowledge_view({knowledge_view:k})),g=y(g,S.routing.change_route({args:{view:"knowledge",subview_id:k.id}})),g=y(g,S.specialised_object.upsert_wcomponent({wcomponent:h,add_to_knowledge_view:{id:k.id,position:{left:0,top:0}}})),g=y(g,S.specialised_object.upsert_wcomponent({wcomponent:w,add_to_knowledge_view:{id:k.id,position:{left:300,top:0}}})),b&&(g=y(g,S.routing.change_route({args:{created_at_datetime:b}}))),g}a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:t,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),x("state_value VAPs should be composed into statev2 wcomponent",()=>{var h;r=v(a,c,n),l=r.derived.composed_wcomponents_by_id,d=l[a.id],p=(d==null?void 0:d.values_and_prediction_sets)||[],u((h=p[0])==null?void 0:h.id,"vps22222","The composed wcomponent should have VAP sets from the state value component that targets it"),u(d==null?void 0:d._derived__using_value_from_wcomponent_id,c.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set to the state_value's ID")}),x("Components created after current created_at datetime are still present in composed_wcomponents_by_id",()=>{r=v(a,c,e),l=r.derived.composed_wcomponents_by_id,u(a.created_at.getTime()>r.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_statev2 wcomponent based on its created_at"),u(c.created_at.getTime()>r.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_state_value wcomponent based on its created_at"),u(new Set(Object.keys(l)),new Set([i,o]),"derived.composed_wcomponents_by_id should still contain the components when the created_at filter is set to before the created_at of the two components")}),x("state_value created after statev2 and filtered out by created_at datetime",()=>{var h;a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:n,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:n,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),r=v(a,c,t),l=r.derived.composed_wcomponents_by_id,d=l[a.id],p=(d==null?void 0:d.values_and_prediction_sets)||[],u((h=p[0])==null?void 0:h.id,"vps1","The composed wcomponent should have VAP sets from the original statev2 component as the state_value that targets it should be filtered out based on created_at time"),u(d==null?void 0:d._derived__using_value_from_wcomponent_id,void 0,"The composed wcomponent should NOT have _derived__using_value_from_wcomponent_id set")}),x("state_value VAPs filtered out by created_at datetime",()=>{a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:n,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),r=v(a,c,t),l=r.derived.composed_wcomponents_by_id,d=l[a.id],p=(d==null?void 0:d.values_and_prediction_sets)||[],u(p.length,0,"The composed wcomponent should have VAP sets from the state_value component that targets it but these VAPs should be filtered out based on created_at time"),u(d==null?void 0:d._derived__using_value_from_wcomponent_id,c.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set")})}),nP=x.delay("get_composed_wcomponents_by_id",()=>{var l;const t=new Date("2024-10-08"),n=Ie(E.number,{1:{id:"1",order:1,value:"10",description:""}},[],-1);n.created_at=t;const i=q({type:"statev2",base_id:-1,values_and_prediction_sets:[n]});i.created_at=t;const o=Ie(E.number,{2:{id:"2",order:1,value:"20",description:""}},[],-1);o.created_at=t;const s=q({type:"state_value",base_id:-1,values_and_prediction_sets:[o],attribute_wcomponent_id:i.id});s.created_at=t;const a=Ww({wcomponents_by_id:{[i.id]:i,[s.id]:s},composed_visible_wc_id_map:{[i.id]:{left:0,top:0},[s.id]:{left:0,top:0}},created_at_ms:t.getTime()})[i.id];if(!Qe(a))throw new Error("Expected composed wcomponent to be statev2");u(a._derived__using_value_from_wcomponent_id,s.id,"should populate the _derived__using_value_from_wcomponent_id field of the statev2 with the id of the state_value component that is targeting it.");const c=(a.values_and_prediction_sets||[])[0];u((l=c==null?void 0:c.entries[0])==null?void 0:l.value,"20","should replace the VAP set of a statev2 with the VAP set of the state_value component that is targeting it.")}),iP=x.delay("calc_if_wcomponent_should_exclude_because_label_or_type",()=>{const e=q({id:"1",base_id:1}),t=q({id:"2",base_id:1,label_ids:[e.id]}),n=q({id:"3",base_id:1,label_ids:[]}),i={exclude_by_label_ids:new Set,include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},o={exclude_by_label_ids:new Set([e.id]),include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},s={exclude_by_label_ids:new Set,include_by_label_ids:new Set([e.id]),exclude_by_component_types:new Set,include_by_component_types:new Set},r={exclude_by_label_ids:new Set([e.id]),include_by_label_ids:new Set([e.id]),exclude_by_component_types:new Set,include_by_component_types:new Set};let{should_exclude:a,lacks_include:c}=Rt(t,i);u(a,!1),u(c,!1),{should_exclude:a,lacks_include:c}=Rt(t,o),u(a,!0),u(c,!1),{should_exclude:a,lacks_include:c}=Rt(t,s),u(a,!1),u(c,!1),{should_exclude:a,lacks_include:c}=Rt(n,s),u(a,!1),u(c,!0),{should_exclude:a,lacks_include:c}=Rt(t,r),u(a,!0),u(c,!1),{should_exclude:a,lacks_include:c}=Rt(e,o),u(a,!0),u(c,!1),{should_exclude:a,lacks_include:c}=Rt(e,s),u(a,!1),u(c,!1)}),fn=le(1);function Ro(e,t,n){const o={id:t,foundation_knowledge_view_ids:n?[n]:void 0,wc_id_map:{},title:"",description:"",sort_type:"normal",created_at:new Date("2023-03-22 15:15:00"),base_id:1,goal_ids:[]};return e&&(o.wc_id_map[fn]=e),o}const oP=x.delay("get_composed_wc_id_maps_object",()=>{const e=new Date("2023-03-22 15:15:00");let t;t=at([],{}),u(t,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}});const i=[{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, defined in foundation, ",test_description_part2:"should return entry in foundation"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"missing in current, blocked in foundation, ",test_description_part2:"should return entry in blocked"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, missing in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, defined in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, passthrough in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, blocked in foundation, ",test_description_part2:"should return entry in current not foundation and NOT show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, defined in foundation, ",test_description_part2:"should return (passthrough) entry from foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"passthrough entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, missing in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, defined in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"}];i.forEach(o=>{const s=Ro(o.kv_wc_entry_in_foundation_kv,"kv1"),r=Ro(o.kv_wc_entry_in_current_kv,"kv2","kv1");t=at([s,r],{}),u(t.composed_wc_id_map[fn],o.expected_result_in_composed_wc_id_map,"composed_wc_id_map "+o.test_description+o.test_description_part2),u(t.composed_blocked_wc_id_map[fn],o.expected_result_in_composed_blocked_wc_id_map,"composed_blocked_wc_id_map "+o.test_description+o.test_description_part2)}),x("deleted wcomponent",()=>{i.forEach(o=>{const s=Ro(o.kv_wc_entry_in_foundation_kv,"kv1"),r=Ro(o.kv_wc_entry_in_current_kv,"kv2","kv1");t=at([s,r],{[fn]:{id:fn,deleted_at:e,type:"statev2",title:"",description:"",created_at:e,base_id:1}}),u(t.composed_wc_id_map[fn],void 0,"composed_wc_id_map "+o.test_description+"should not return any entry"),u(t.composed_blocked_wc_id_map[fn],void 0,"composed_blocked_wc_id_map "+o.test_description+"should not return any entry")})})}),sP=x.delay("knowledge_views_derived_reducer",()=>{x("calculate_wc_ids_to_exclude_based_on_filters",()=>{const e={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""},t=new Set,n=q({id:"node1",base_id:-1,type:"statev2",label_ids:[]}),i=q({id:"node2",base_id:-1,type:"statev2",label_ids:["123"]}),o=[n,i],s=q({id:"link1_no_label",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),r=q({id:"link2_no_label_no_from",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),a=q({id:"link3_no_label_no_to",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),c=q({id:"link4_has_label",base_id:-1,type:"causal_link",label_ids:["123"],from_id:n.id,to_id:i.id}),l=q({id:"link5_has_label_no_from",base_id:-1,type:"causal_link",label_ids:["123"],from_id:void 0,to_id:i.id}),d=q({id:"link6_has_label_no_to",base_id:-1,type:"causal_link",label_ids:["123"],from_id:i.id,to_id:void 0}),p=[s,r,a,c,l,d];let f=Xc(e,t,o,p);u(f,new Set,"no filters"),e.include_by_label_ids=["123"],f=Xc(e,t,o,p),u(f,new Set([n.id,s.id,r.id,a.id,c.id]),"filter out components not labelled")})}),rP=x.delay("specialised_objects accessors tests",()=>{x("get_current_temporal_value_certainty_from_wcomponent",()=>{const e=new Date("2023-10-09"),t=new Date("2023-10-10");let n,i,o,s;function r(a,c){const l=q({base_id:-1,created_at:e,type:"statev2",values_and_prediction_sets:a}),d={[l.id]:l};return xl(l.id,d,c)}i=e.getTime(),o=r(void 0,i),s=void 0,u(o,s,"No VAP sets should result in undefined value"),i=e.getTime(),o=r([],i),s=void 0,u(o,s,"Empty VAP sets should result in undefined value"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,entries:[],datetime:{}}],o=r(n,i),s={certainty:void 0,temporal_uncertainty:{}},u(o,s,"VAP sets with one VAPset should result in that VAP set's empty datetime being returned"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,entries:[],datetime:{value:t}}],o=r(n,i),s={certainty:void 0,temporal_uncertainty:{value:t}},u(o,s,"VAP sets with one VAPset should result in that VAP set's datetime and value being returned"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:t,datetime:{},entries:[]}],o=r(n,i),s=void 0,u.skip(o,s,"VAP sets with one VAPset created after current created_at should return undefined"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,datetime:{value:t},entries:[{id:"",description:"",value:"",explanation:"",probability:1,conviction:1}]}],o=r(n,i),s={certainty:1,temporal_uncertainty:{value:t}},u(o,s,"VAP sets with one VAPset with an 100% probable & confident (conviction) entry should be 100% certain"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,datetime:{value:t},entries:[{id:"",description:"",value:"",explanation:"",probability:.5,conviction:.5},{id:"",description:"",value:"",explanation:"",probability:.9,conviction:.9}]}],o=r(n,i),s={certainty:.81,temporal_uncertainty:{value:t}},u(o,s,"VAP sets with one VAPset with two entries should take highest certainty")})}),_P=x.delay("tidy_wcomponent",()=>{const t=new Date("2021-05-12"),n=new Date("2021-05-13");let i,o,s,r;const a={},c=-1;i=qt({base_id:c,type:"statev2",subtype:"other"}),i.values_and_prediction_sets=[{...Ie(E.undefined,{},[],c),id:"vps2",created_at:n,custom_created_at:void 0},{...Ie(E.undefined,{},[],c),id:"vps1",created_at:t,custom_created_at:void 0}],s=Vt(i,a),u(s.values_and_prediction_sets.map(({id:d})=>d),["vps1","vps2"],"",!1),i=qt({base_id:c,type:"statev2",subtype:"other"}),o=[{...Me(),id:"VAP1",relative_probability:5},{...Me(),id:"VAP2",relative_probability:0}],i.values_and_prediction_sets=[{...Ie(E.undefined,{},[],c),entries:o}],s=Vt(i,a),u(s.values_and_prediction_sets[0].entries.map(({probability:d})=>d),[1,0],"",!1),i={...i,subtype:"boolean"},s=Vt(i,a),r=s.values_and_prediction_sets[0].entries,u(r.map(({relative_probability:d})=>d),[5,0],"",!1),u(r.map(({probability:d})=>d),[1,0],"",!1),o=[{...Me(),id:"VAP1",relative_probability:5,probability:0},{...Me(),id:"VAP2",relative_probability:0,probability:1}];const l=[{...Ie(E.undefined,{},[],c),entries:o}];i={...i,subtype:"boolean",values_and_prediction_sets:l},s=Vt(i,a),r=s.values_and_prediction_sets[0].entries,u(r.map(({relative_probability:d})=>d),[5,0],"",!1),u(r.map(({probability:d})=>d),[0,1],"",!1),x("Ensuring _derived__using_value_from_wcomponent_id is not saved",()=>{const d=console.error;let p="";console.error=f=>{p=f},i={...i,_derived__using_value_from_wcomponent_id:"123"},s=Vt(i,a),console.error=d,u(p.length>0,!0,"Should log an error to the console when wcomponent with _derived__using_value_from_wcomponent_id is tidied before attempting to be saved"),u(s._derived__using_value_from_wcomponent_id,void 0,"Should delete wcomponent._derived__using_value_from_wcomponent_id")})});function Rv(){return{from:()=>({select:()=>({order:()=>({eq:()=>({range:()=>new Promise(e=>{e({data:[{id:"1",base_id:1,name:"Item 1"},{id:"2",base_id:1,name:"Item 2"}]})})})})})})}}const aP=x.delay("supabase_get_items",()=>{const e=t=>({...t,id:parseInt(t.id,10)});x("normal case",async()=>{const t=await ui({supabase:Rv(),table:"test_table",converter:e,offset:0,base_id:1});u(t.value.length,2)}),x("return undefined for some values",async()=>{const t=await ui({supabase:Rv(),table:"test_table",converter:n=>n.id==="1"?void 0:e(n),offset:0,base_id:1});u(t.value.length,2),u(t.value[0],void 0),u(t.value[1].id,2)})}),cP=x.delay("supabase_item_to_app",()=>{const t=$l({id:"123",title:"-some title",base_id:111,modified_at:"2025-06-06T00:00:00",json:{modified_at:new Date("1970-06-06T00:00:00"),id:"-2",base_id:-1,title:"Test Item"}});u(t.id,"123","should use id from supabase field at top level of the table"),u(t.base_id,111,"should use base_id from supabase field at top level of the table"),u(t.modified_at instanceof Date,!0),u(t.modified_at.toISOString(),"2025-06-06T00:00:00.000Z","Should use modified_at from supabase field at top level of the table and convert to Date object"),u(t.title,"Test Item","should use title from json field in supabase item, not the title field.  The canonical value is in the DB's json field not the title field.")}),lP=x.delay("wcomponent_supabase_to_app",()=>{function e(i){let s={...Nl(i),modified_at:"2025-06-06T00:00:00"};return lo(s)}let t=q({type:"statev2",base_id:-1}),n=e(t);u(!!n,!0,"should return a valid wcomponent statev2 object"),t.type="an old unsupported component type",n=e(t),u(n,void 0,"should filter out wcomponent types which are unsupported")}),dP=x.delay("refresh_bases_for_current_user",()=>{const e=new Date,t=new Date,n="123",i="987",o={id:1,inserted_at:e,updated_at:t,owner_user_id:n,public_read:!1,title:"owned by this user",access_level:"owner",can_edit:!0},s={id:2,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!1,title:"editable by this user",access_level:"editor",can_edit:!0},r={id:3,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!1,title:"viewable by this user",access_level:"viewer",can_edit:!1},a={id:3,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!0,title:"public viewable by this user",access_level:"viewer",can_edit:!1},c=[o,s,r,a];function l(p){return fw({user_info:p})}let d={user:{id:n},chosen_base_id:void 0,bases_by_id:void 0};u(l(d),!1),[o,s].forEach(p=>{d=ei({user_info:d},S.user_info.update_bases({bases:[p]})).user_info,u(d.chosen_base_id,p.id),u(l(d),!1)}),d=ei({user_info:d},S.user_info.update_bases({bases:[r,a]})).user_info,u(d.chosen_base_id,void 0),u(l(d),!0),d=ei({user_info:{user:{id:n},chosen_base_id:100,bases_by_id:void 0}},S.user_info.update_bases({bases:[r,a]})).user_info,u(d.chosen_base_id,void 0),u(l(d),!0),[o,s].forEach(p=>{d=ei({user_info:{user:{id:n},chosen_base_id:100,bases_by_id:void 0}},S.user_info.update_bases({bases:[]})).user_info,u(d.chosen_base_id,void 0),u(l(d),!0)}),c.forEach(({id:p})=>{d=ei({user_info:{user:{id:n},chosen_base_id:p,bases_by_id:void 0}},S.user_info.update_bases({bases:c})).user_info,u(d.chosen_base_id,p),u(l(d),!1)})});function Uo(e,t){const n=[];for(let i=0;i<e.length;++i){const o=e[i];if(n.push(o),i>=e.length-1)continue;const s=e[i+1];n.push(t(o,s))}return n}const uP=x.delay("array functions",()=>{let e=Uo([],()=>0);u(e,[],"intersperse with no elements should be empty"),e=Uo(["a"],()=>0),u(e,["a"],"intersperse with 1 element should have no interspersed values"),e=Uo(["a","b","c"],(t,n)=>t.charCodeAt(0)+n.charCodeAt(0)),u(e,["a",195,"b",197,"c"],"intersperse with 3 elements should have interspersed values")});function Ov(e,t,n){let i=0,o=e.length-1;for(;i<=o;){let s=Math.floor((i+o)/2);const r=t(e[s]);if(r===n)return s;r<n?i=s+1:o=s-1}return-1}function vn(e,t,n){let i=0,o=e.length-1;for(;i<=o;){let s=Math.floor((i+o)/2);const r=t(e[s]);if(r===n)return{index:s,exact:!0,bounds:"in"};if(r<n?i=s+1:o=s-1,i>o){const a=o===-1?"lower":i===e.length?"higher":"in";return{index:a==="lower"?-.5:a==="higher"?e.length-.5:r<n?s+.5:s-.5,exact:!1,bounds:a}}}return{index:-1,exact:!1,bounds:"n/a"}}const pP=x.delay("binary search functions",()=>{let e=Ov([1,2,3,4,5,6,7,8,9],n=>n,3);u(e,2),e=Ov([1,2,3,4,5,6,7,8,9],n=>n,3.5),u(e,-1);let t=vn([1,2,3,4,5,6,7,8,9],n=>n,3);u(t,{index:2,exact:!0,bounds:"in"}),t=vn([1,2,3,4,5,6,7,8,9],n=>n,0),u(t,{index:-.5,exact:!1,bounds:"lower"}),t=vn([1,2,3,4,5,6,7,8,9],n=>n,1.5),u(t,{index:.5,exact:!1,bounds:"in"}),t=vn([1,2,3,4,5,6,7,8,9],n=>n,2.5),u(t,{index:1.5,exact:!1,bounds:"in"}),t=vn([1,2,3,4,5,6,7,8,9],n=>n,3.5),u(t,{index:2.5,exact:!1,bounds:"in"}),t=vn([1,2,3,4,5,6,7,8,9],n=>n,9.5),u(t,{index:8.5,exact:!1,bounds:"higher"})}),mP=/(?:^)([^",\n\r]*),?/g,fP=/(?:^)"([^"]+|"")*",?/g,vP=/(?:^)([\n\r]+)/g;function U(e){const t=[];let n,i,o,s,r=[],a=!1,c=!0,l=2;do{if(a=!1,c&&(c=!1,l=2,r=[],t.push(r)),n=e.match(mP),i=e.match(fP),i&&i.length){s=i[0],a=s.endsWith(",");const d=(a?s.slice(1,-2):s.slice(1,-1)).replace(/""/g,'"');r.push(d),e=e.slice(s.length),a||(l-=1)}else if(n.length){s=n[0],a=s.endsWith(",");const d=a?s.slice(0,-1):s;r.push(d),e=e.slice(s.length),a||(l-=1)}o=e.match(vP),!a&&o&&o.length&&(c=!0,l=2,e=e.slice(o[0].length)),e===""&&(l-=1)}while(l>0);return t}const hP=x.delay("csv_to_array",()=>{u(U(""),[[""]]),u(U(","),[["",""]]),u(U("a"),[["a"]]),u(U("a,"),[["a",""]]),u(U(",a"),[["","a"]]),u(U(",a,"),[["","a",""]]),u(U("a,a"),[["a","a"]]),u(U("a,a,"),[["a","a",""]]),u(U(",a,a"),[["","a","a"]]),u(U(",a,a,"),[["","a","a",""]]),u(U(`
`),[[""],[""]]),u(U(`a
a`),[["a"],["a"]]),u(U(`,
,`),[["",""],["",""]]),u(U(`a,
a,`),[["a",""],["a",""]]),u(U(`,a
,a`),[["","a"],["","a"]]),u(U(`,a,
,a,`),[["","a",""],["","a",""]]),u(U('""'),[[""]]),u(U('"",'),[["",""]]),u(U(',""'),[["",""]]),u(U(',"",'),[["","",""]]),u(U('","'),[[","]]),u(U('",",'),[[",",""]]),u(U(',","'),[["",","]]),u(U(',",",'),[["",",",""]]),u(U('"",""'),[["",""]]),u(U('"a"'),[["a"]]),u(U('"a",'),[["a",""]]),u(U(',"a"'),[["","a"]]),u(U(',"a",'),[["","a",""]]),u(U('"a","a"'),[["a","a"]]),u(U('"a","a",'),[["a","a",""]]),u(U(',"a","a"'),[["","a","a"]]),u(U(',"a","a",'),[["","a","a",""]]),u(U('""""'),[['"']]),u(U('"""",'),[['"',""]]),u(U(',""""'),[["",'"']]),u(U(',"""",'),[["",'"',""]]),u(U('"""a"""'),[['"a"']]),u(U('"""a""","""a"""'),[['"a"','"a"']]),u(U('""""""'),[['""']]),u(U('"a""a"'),[['a"a']]),u(U('"a"",""a"'),[['a","a']]),u(U(`""
`),[[""],[""]])});function gy(e,t,n=[]){let i=t(e);const o={next:(...s)=>(n.push(s),i.next(...s)),throw:s=>i.throw(s),return:s=>i.return(s),[Symbol.iterator]:()=>o,clone:()=>{const s=[...n].map(r=>[...r]);return gy(e,t,s)}};return n.forEach(s=>i.next(...s)),o}const gP=x.delay("cloneable_generator_factory",()=>{function*e(i){let o=i.start;for(;;){let s=yield++o;s!==void 0&&(o+=s)}}let t=gy({start:10},e);u(t.next().value,11,"should increment"),u(t.next(3).value,11+1+3,"should use jump");let n=t.clone();u(t.next().value,16,"should increment again"),u(t.next(10).value,16+1+10,"should jump again"),u(n.next().value,16,"should have been reset"),u(n.next().value,17,"should not use previous jump"),u(n.next(-10).value,17+1-10,"should jump on second branch"),u(t.next().value,28,"should jump a third time on first branch")}),wP=x.delay("list functions",()=>{x("index_is_in_bounds",()=>{u(St([],0),!1,"empty list, any number"),u(St(["A"],-1),!1,"list with one element, index -1"),u(St(["A"],0),!0,"list with one element, index 0"),u(St(["A"],1),!1,"list with one element, index 1"),u(St(["A","B"],1),!0,"list with two elements, index 1"),u(St(["A","B"],2),!1,"list with two elements, index 2")}),x("swap_elements",()=>{u(yt([],0,0),[],"empty list, any indices, should be noop"),u(yt(["A","B"],-1,0),["A","B"],"invalid first index of -1, should be noop"),u(yt(["A","B"],2,0),["A","B"],"invalid first index of 2, should be noop"),u(yt(["A","B"],0,-1),["A","B"],"invalid second index of -1, should be noop"),u(yt(["A","B"],0,2),["A","B"],"invalid second index of 2, should be noop"),u(yt(["A","B"],0,1),["B","A"],"should swap"),u(yt(["A","B"],1,0),["B","A"],"should swap"),u(yt(["A","B"],1,1),["A","B"],"should handle noop")}),x("insert_element_at_index",()=>{u(kt([],"A",0),["A"],"insertion works at index 0"),u(kt([],"A",-2),["A"],"insertion works at any negative index"),u(kt([],"A",2),["A"],"insertion works at any positive index"),u(kt(["A","B","C"],"D",0),["D","A","B","C"],"insertion works at index 0"),u(kt(["A","B","C"],"D",-2),["D","A","B","C"],"insertion works at any negative index"),u(kt(["A","B","C"],"D",2),["A","B","D","C"],"insertion works at an positive index that is in the list"),u(kt(["A","B","C"],"D",3),["A","B","C","D"],"insertion works at an positive index that is the length of the list"),u(kt(["A","B","C"],"D",4),["A","B","C","D"],"insertion works at any positive index that is > list length")})});function wy(e,t){const n={};return Object.values(e||{}).forEach(i=>{const o=t?i.value.toLowerCase():i.value;n[o]=i}),n}function ti(e,t){if(e===void 0)return;const n=t||{},i=wy(n,!1);return e.map(o=>({...o,entries:o.entries.map(s=>{let{value_id:r,value:a,description:c}=s,l=n[r||""];return l||(r=void 0,l=i[s.value]),l&&(r=l.id,a=l.value,c=l.description),{...s,value_id:r,value:a,description:c}})}))}const bP=x.delay("update_VAPSets_with_possibilities",()=>{var a,c,l,d,p,f,m,v,h,w,b,g,k,y,$,j,C,N,A,R,M,T,B,ne;const e="val_prob_id_123",t="val_prob_id_456",n="value abc",i="value def456",o={[e]:{id:e,value:n,description:"description abc",order:0},[t]:{id:t,value:i,description:"description def456",order:1}},s=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...Me(),value_id:e,value:"old abc value",description:"old abc description"},{...Me(),value_id:"defunct_id",value:n,description:"old abc description"},{...Me(),value_id:t,value:n,description:""}]}];let r=ti(void 0,void 0);u(r,void 0,"Undefined initial VAPs returns undefined"),r=ti(void 0,o),u(r,void 0,"Undefined initial VAPs returns undefined"),r=ti([],o),u(r,[],"Empty initial VAPs returns empty"),r=ti(s,void 0),u(r==null?void 0:r.length,s.length,"Undefined value_possibilities returns all VAPs"),r&&(u((c=(a=r[0])==null?void 0:a.entries[0])==null?void 0:c.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),u((d=(l=r[0])==null?void 0:l.entries[1])==null?void 0:d.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),u((f=(p=r[0])==null?void 0:p.entries[2])==null?void 0:f.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids")),console.log("Updates VAPs in VAP Set with value_possibilities ..."),r=ti(s,o),u(Array.isArray(r),!0,"Returns an array"),r&&(u((v=(m=r[0])==null?void 0:m.entries[0])==null?void 0:v.value,(h=o[e])==null?void 0:h.value,"Updates value"),u((b=(w=r[0])==null?void 0:w.entries[0])==null?void 0:b.description,(g=o[e])==null?void 0:g.description,"Updates description"),u((y=(k=r[0])==null?void 0:k.entries[1])==null?void 0:y.value_id,e,"Updates id based on matched value"),u((j=($=r[0])==null?void 0:$.entries[1])==null?void 0:j.description,(C=o[e])==null?void 0:C.description,"Updates description based on matched value/id"),u((A=(N=r[0])==null?void 0:N.entries[2])==null?void 0:A.value_id,t,"Does not update id based on matched value if ID valid"),u((M=(R=r[0])==null?void 0:R.entries[2])==null?void 0:M.value,i,"Updates value"),u((B=(T=r[0])==null?void 0:T.entries[2])==null?void 0:B.description,(ne=o[t])==null?void 0:ne.description,"Updates description"))}),yP=x.delay("get_wcomponent_VAPs_represent",()=>{const e=le(1),t=le(2);let n,i,o,s,r,a;n=void 0,o={},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,"Should return undefined for undefined WComponent"),n=q({base_id:-1,type:"statev2",subtype:void 0}),o={},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,'Should return undefined for WComponent.type of "statev2" and subtype of undefined'),n=q({base_id:-1,type:"statev2",subtype:"boolean"}),o={},s=void 0,r=E.boolean,a=oe(n,o,s),u(a,r,'Should return boolean for WComponent.type of "statev2" and subtype of boolean'),n=q({base_id:-1,type:"statev2",subtype:"number"}),o={},s=void 0,r=E.number,a=oe(n,o,s),u(a,r,'Should return number for WComponent.type of "statev2" and subtype of number'),n=q({base_id:-1,type:"statev2",subtype:"other"}),o={},s=void 0,r=E.other,a=oe(n,o,s),u(a,r,'Should return other for WComponent.type of "statev2" and subtype of other'),x("state_value",()=>{i=q({base_id:-1,type:"statev2",subtype:"number"}),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=E.number,a=oe(n,o,s),u(a,r,'Should return number for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of number'),i=q({base_id:-1,type:"statev2",subtype:"boolean"}),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=E.boolean,a=oe(n,o,s),u(a,r,'Should return boolean for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of boolean'),i=q({base_id:-1,type:"statev2",subtype:"other"}),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=E.other,a=oe(n,o,s),u(a,r,'Should return other for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of other'),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:"some unknown uuid"}),o={},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,'Should return undefined for WComponent.type of "state_value" targeting an unknown stateV2 wcomponent'),x("protected from recursion",()=>{n=q({base_id:-1,id:e,type:"state_value",attribute_wcomponent_id:e}),o={[n.id]:n},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,'Should return undefined for WComponent.type of "state_value" targeting itself (accidentally)'),i=q({base_id:-1,id:e,type:"state_value",attribute_wcomponent_id:t}),n=q({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:e}),o={[i.id]:i,[n.id]:n},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,'Should return undefined for two WComponent.type of "state_value" targeting each other with infinite recursion')})}),x("other types",()=>{n=q({base_id:-1,type:"action"}),o={},s=void 0,r=E.action,a=oe(n,o,s),u(a,r,'Should return action for WComponent.type of "action"'),n=q({base_id:-1,type:"process"}),o={},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,'Should return undefined for WComponent.type of "process"'),n=q({base_id:-1,type:"causal_link"}),o={},s=void 0,r=E.undefined,a=oe(n,o,s),u(a,r,'Should return undefined for WComponent.type of "causal_link"')})}),kP=x.delay("parse_value",()=>{x("parse_VAP_value",()=>{let e;x('VAPsType "number"',()=>{const t=n=>bl({value:n,id:"",description:"",explanation:"",probability:1,conviction:1},E.number);e=t(""),u(e,null,"Should parse empty string as valid but null"),e=t("   "),u(e,null,"Should parse string of spaces as valid but null"),e=t("123"),u(e,123,"Should parse valid number"),e=t("  123  "),u(e,123,"Should parse valid number with whitespace"),e=t("123abc"),u(Number.isNaN(e),!0,"Should parse number with appended invalid characters as invalid NaN"),e=t("abc123"),u(Number.isNaN(e),!0,"Should parse number with prepended invalid characters as invalid NaN"),e=t("123%"),u(e,1.23,"Should parse number with appended %"),e=t("123 %"),u(e,1.23,"Should parse number with appended whitespace %"),e=t("123%%"),u(Number.isNaN(e),!0,"Should parse number with appended % and further invalid characters as invalid NaN"),e=t("1e-3%"),u(e,1e-5,"Should parse negative exponent number with appended %"),e=t(".3 e 2 %"),u(e,.3,"Should parse fractional number with exponent with appended % and interspersed whitespace"),e=t("3,000.200"),u(e,3000.2,"Should parse numbers with commas as thousands separators"),e=t("3,000.200%"),u(e,30.002,"Should parse numbers with commas as thousands separators and percentage sign")})}),x("is_string_valid_number",()=>{u(Ne(""),!0,"empty string is valid number"),u(Ne("   "),!0,"string of spaces is valid number"),u(Ne("123"),!0,"valid number"),u(Ne("  123  "),!0,"valid number with whitespace"),u(Ne("123abc"),!1,"number with appended invalid characters"),u(Ne("abc123"),!1,"number with prepended invalid characters"),u(Ne("123%"),!0,"number with appended % (valid)"),u(Ne("a90%"),!1,"number with appended % but prepended character (invalid)"),u(Ne("123 %"),!0,"number with appended whitespace % (valid)"),u(Ne("123%%"),!1,"number with appended % and further invalid characters"),u(Ne("1e-3%"),!0,"negative exponent number with appended % (valid)"),u(Ne(".3 e 2 %"),!0,"fractional number with exponent with appended % and interspersed whitespace (valid)"),u(Ne("3,000.200%"),!0,"numbers with commas as thousands separators are allowed"),u(Ne("3,00.2"),!1,"numbers with commas not at every 1000 are not allowed"),u(Ne("3,00"),!1,"numbers with commas not at every 1000 are not allowed")})});function si(e){const{wcomponent:t,kv_entry:n,sim_ms:i,wc_ids_excluded_by_filters:o}=e;if(!n||n.blocked)return!1;let s="is_selected"in e?e.is_selected:!1;if("selected_wcomponent_ids_set"in e&&(s=e.selected_wcomponent_ids_set.has(t.id)),s)return 1;if(o.has(t.id)||xP(t,e.created_at_ms))return!1;const{certainty:a}=Ol(e)||Rl();if(SP({validity_certain:a,validity_filter:e.validity_filter}))return!1;let l=a;if(hl(t)){const d=AP({event_at:t.event_at,sim_ms:i});d!==void 0&&(l=Math.min(l,d))}return l}function xP(e,t){return ze(e)>t}function SP(e){let t=!1;const{validity_certain:n,validity_filter:i}=e;return i.show_invalid?t=!0:i.maybe_invalid?t=n>0:i.only_maybe_valid?t=n>.5:i.only_certain_valid?t=n===1:console.error("Unsupported validity_filter: "+JSON.stringify(i)),!t}function AP(e){const{event_at:t,sim_ms:n}=e,i=t[0];if(i)return i.probability*i.conviction}function hn(e){const{from_wc:t,from_wc__kv_entry:n,to_wc:i,to_wc__kv_entry:o}=e,s=si(e);if(!s)return!1;if(!t||!i)return{display_certainty:1};if(!n||!o)return!1;const r=si({...e,wcomponent:t,kv_entry:n});return!r||!si({...e,wcomponent:i,kv_entry:o})?!1:{display_certainty:Math.min(s,r)}}function $P(e){const{target_wc:t,target_wc__kv_entry:n}=e;if(!t||!n)return!1;const i=si(e);if(!i)return!1;const o=si({...e,wcomponent:t,kv_entry:n});return o?{display_certainty:Math.min(i,o)}:!1}function by(e){if(e.is_highlighted||e.is_selected||e.is_current_item||e.certainty_formatting.render_100_opacity&&!e.focused_mode||e.connected_neighbour_is_highlighted)return 1;if(e.focused_mode)return .1;if(e.is_editing)return 1;const t=e.certainty_formatting.render_certainty_as_easier_opacity;return e.certainty===1?1:t?Ru(e.certainty,.4,.7):Ru(e.certainty,.1,.5)}const CP=x.delay("calc_connection_wcomponent_should_display",()=>{const e=new Date("2024-08-29T11:00:00.000Z"),t=e.getTime(),n=new Date("2024-08-29T11:00:00.000Z").getTime(),i=()=>{let r=q({type:"causal_link",base_id:-1,created_at:e});if(!an(r))throw new Error(`Need a causal_link component for tests but got "${r.type}"`);const a=q({type:"causal_link",base_id:-1,created_at:e}),c=q({type:"statev2",base_id:-1,created_at:e});return{wcomponent:r,kv_entry:{left:0,top:0},validity_filter:{only_certain_valid:!1,only_maybe_valid:!1,maybe_invalid:!1,show_invalid:!0},from_wc:a,to_wc:c,from_wc__kv_entry:{left:0,top:0},to_wc__kv_entry:{left:0,top:0},created_at_ms:t,sim_ms:n,selected_wcomponent_ids_set:new Set,wc_ids_excluded_by_filters:new Set}};let o=i(),s=hn(o);u(s,{display_certainty:1},"should display"),o=i(),o.wcomponent.created_at=new Date(t+1),s=hn(o),u(s,!1,"should not display if created in future"),o=i(),o.wc_ids_excluded_by_filters.add(o.wcomponent.id),s=hn(o),u(s,!1,"should not display if it list of ids excluded by filters"),o=i(),o.from_wc=void 0,o.from_wc__kv_entry=void 0,s=hn(o),u(s,{display_certainty:1},"should display if from_wc not present"),o=i(),o.to_wc=void 0,o.to_wc__kv_entry=void 0,s=hn(o),u(s,{display_certainty:1},"should display if to_wc not present"),o=i(),o.from_wc=void 0,o.from_wc__kv_entry=void 0,o.wc_ids_excluded_by_filters.add(o.wcomponent.id),s=hn(o),u(s,!1,"should not display if from_wc not present and id is in list of ids excluded by filters")}),jP=x.delay("get_wcomponent_state_UI_value",()=>{const e=new Date("2021-05-01 00:00"),t=new Date("2021-05-01 00:01"),n=new Date("2021-05-01 00:02");function i(f,m){const v={};return f.forEach(h=>{m.forEach(w=>{if(h.VAP_set_id!==w.id)return;const b=v[w.id]||[];b.push({base_id:-1,id:"",created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:w.id,target_VAP_id:h.VAP_id}),v[w.id]=b})}),v}function o(f,m,v){const{counterfactuals_data:h=[],datetime:w={}}=v||{},b=m.map((k,y)=>({base_id:-1,id:`vps${y}`,created_at:t,version:1,datetime:w,entries:k}));f={...f,values_and_prediction_sets:b};const g=i(h,b);return bs({wcomponent:f,VAP_set_id_to_counterfactual_v2_map:g,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const s={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]};let r;const a={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},c={...a,id:"VAP100",value:"A100",probability:1,conviction:1},l={...c,id:"VAP80",value:"A80",probability:.8},d={...c,id:"VAP20",value:"A20",probability:.2},p={...c,id:"VAP0",value:"A0",probability:0};x("Basic tests of get_wcomponent_state_UI_value",()=>{r=o(s,[]),u(r,void 0,"No VAP (value and prediction) sets should return undefined"),r=o(s,[[]]),u(r,void 0,"No value defined in a VAP (value and prediction) set should return undefined"),r=o(s,[[{...c,value:"  "}]]),u(r,{values_string:"not defined",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with whitespace string value should be trimmed to nothing and then shown as 'not defined'"),r=o(s,[[c]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with certainty"),r=o(s,[[d,l]]),u(r,{values_string:"A80, A20",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"Multiple VAPs with both uncertain should result in both being shown, with the most probable first"),r=o(s,[[p,c]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain first, should only show the certain one"),r=o(s,[[c,p]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain last, should only show the certain one"),r=o(s,[[d,d,d,d]]),u(r,{values_string:"A20, A20, A20, (1 more)",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},'Shows "(1 more)" when there are more than 3 values')}),x("number subtype",()=>{const f={...s,subtype:"number"},m={...a,id:"VAP1",value:"33",probability:1,conviction:1};r=o(f,[[m]]),u(r,{values_string:"33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number value string");const v={...a,id:"VAP1",value:"33abc",probability:1,conviction:1};r=o(f,[[v]]),u(r,{values_string:"NaN",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A number with invalid characters in value string");const h={...a,id:"VAP1",value:"33%",probability:1,conviction:1};r=o(f,[[h]]),u(r,{values_string:"0.33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number percentage")}),x("boolean subtype",()=>{const f={...s,subtype:"boolean"};r=o(f,[[c]]),u(r,{values_string:"True",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"100% confident boolean should render as True"),r=o(f,[[{...c,probability:.51}]]),u(r,{values_string:"True",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},">50% confident boolean should render as True"),r=o(f,[[{...c,probability:.5}]]),u(r,{values_string:"False",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"<=50% confident boolean should render as False"),r=o(f,[[p]]),u(r,{values_string:"False",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"0% confident boolean should render as False")}),x("StateValue replacing VAPSets",()=>{const f={...s,_derived__using_value_from_wcomponent_id:"abc123"};r=o(f,[[c]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),x("datetime",()=>{r=o(s,[[c]],{datetime:{min:n}}),u(r,void 0,"When datetime.min is in the future, no value should be shown"),r=o(s,[[c]],{datetime:{min:t}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.min is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{max:t}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{max:e}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is in the past, a value should still be shown because the 'max' represents the lastest time this change to state could have occured, and the state represents the most current value"),r=o(s,[[c]],{datetime:{value:n}}),u(r,void 0,"When datetime.value is the future, no value should be shown"),r=o(s,[[c]],{datetime:{value:t}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{value:e}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the past, a value should still be shown, for the same reason as when datetime.max is in the past")})}),TP=x.delay("get_wcomponent_state_value_and_probabilities",()=>{const e=new Date("2021-05-01 00:00"),t=new Date("2021-05-01 00:01"),n=new Date("2021-05-01 00:02");function i(g,k){if(!g||!k)return;const y={};let $=0;return g.forEach(j=>{k.forEach(C=>{if(j.VAP_set_id!==C.id)return;const N=y[C.id]||[];N.push({base_id:-1,id:`cf${$++}`,created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:C.id,target_VAP_id:j.VAP_id}),y[C.id]=N})}),y}function o(g){return g.map((k,y)=>({base_id:-1,id:`vps${y}`,created_at:t,version:1,datetime:{},entries:[],...k}))}function s(g,k,y){const{apply_counterfactuals_v2:$,datetime:j={}}=y||{};if(k){const N=k.map(R=>({datetime:j,entries:R})),A=o(N);g={...g,values_and_prediction_sets:A}}const C=i($,g.values_and_prediction_sets);return An({wcomponent:g,VAP_set_id_to_counterfactual_v2_map:C,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const r={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]},a={...r,subtype:"boolean"};let c;const l={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},d={...l,id:"VAP100",value:"A100",probability:1,conviction:1},p={...d,id:"VAP80",value:"A80",probability:.8},f={...d,id:"VAP20",value:"A20",probability:.2},m={...d,id:"VAP0",value:"A0",probability:0},v={...d,id:"VAP100c50",value:"A100c50",conviction:.8},h={...d,id:"VAP100c0",value:"A100c0",conviction:0},w=[v],b=[h];x("Basic functionality",()=>{c=s(r,[]),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"No VAP (value and prediction) defined"),c=s(r,[[]]),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"No value defined in VAP (value and prediction)"),c=s(r,[[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Single with certainty"),c=s(r,[[f,p]]),u(c,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:.8,conviction:1,probability:.8,value_id:void 0},{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with both uncertain"),c=s(r,[[d,f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with one certain, one uncertain, should only show certain");let g=o([{datetime:{value:e},id:"vap_set_0",entries:[{...d,value:"A100a"}]},{datetime:{value:t},id:"vap_set_1",entries:[{...d,value:"A100b"}]},{datetime:{value:n},id:"vap_set_2",entries:[{...d,value:"A100c"}]}]),k={...r,values_and_prediction_sets:g};c=An({wcomponent:k,VAP_set_id_to_counterfactual_v2_map:void 0,created_at_ms:t.getTime(),sim_ms:t.getTime()}),u(c,{most_probable_VAP_set_values:[{original_value:"A100b",parsed_value:"A100b",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple VAP sets, each with one single VAP, should pick current VAP set"),c=s(r,[[m]]),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance: Should return no value when no chance")}),x("should use first VAP set when both VAP sets conflict at same datetime",()=>{c=s(r,[[d],[f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"certain first and uncertain last"),c=s(r,[[f],[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"uncertain first and certain last")}),x("handling boolean subtype",()=>{c=s(a,[[m]]),u(c,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:!1,certainty:0,conviction:1,probability:0,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance boolean: Should return a value with probability of 0 when no chance of a boolean value"),c=s(a,[[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:!0,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should handle boolean, probability of 1, by returning true"),x('uncertainty for "boolean" subtype',()=>{c=s(a,[[f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:!1,certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),c=s(a,[w]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:!0,certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),c=s(a,[b]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:!0,certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")})}),x('uncertainty for "other" subtype',()=>{c=s(r,[[f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),c=s(r,[w]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:"A100c50",certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),c=s(r,[b]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:"A100c0",certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")}),x("counterfactuals",()=>{c=s(r,[[d]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:d.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"No op counterfactual is applied to something already with certainty of 1"),c=s(r,[[p]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:p.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP that had certainty of < 1"),c=s(r,[[p,f]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:f.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP set with two VAPs that had certainty of < 1"),c=s(r,[[d,m]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:m.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:"A0",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactuals to force one option possibility over another that was certain"),c=s(r,[[d,m]]),u.skip(c,{most_probable_VAP_set_values:[{certainty:1,conviction:1,original_value:"A100",parsed_value:"A100",probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["123"]},"Skipping because counterfactuals version 2 only works to force things to be true, not to be false.  For forcing something to be true, then you can use a StateValue component instead.")}),x("StateValue replacing VAPSets",()=>{const g={...r,_derived__using_value_from_wcomponent_id:"abc123"};c=s(g,[[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),x('Parsing "number" subtype',()=>{var $;const g={...r,subtype:"number"},k={...l,id:"VAP1",value:"33",probability:1,conviction:1},y={...l,id:"VAP1",value:"44abc",probability:1,conviction:1};c=s(g,[[k]]),u(c,{most_probable_VAP_set_values:[{original_value:"33",parsed_value:33,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Correctly parses valid number"),c=s(g,[[y]]),u(c,{most_probable_VAP_set_values:[{original_value:"44abc",parsed_value:Number.NaN,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Errors when parsing number appended with invalid characters"),u(Number.isNaN(($=c.most_probable_VAP_set_values[0])==null?void 0:$.parsed_value),!0,"Error is Number.NaN")}),x("values before, at, after a datetime.min, datetime.value, datetime.max",()=>{x("in the future",()=>{c=s(r,[[d]],{datetime:{min:n}}),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.min is in future"),c=s(r,[[d]],{datetime:{value:n}}),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.value is in future"),c=s(r,[[d]],{datetime:{max:n}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")}),c=s(r,[[d]],{datetime:{min:t}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.min is at the same time (or earlier)"),c=s(r,[[d]],{datetime:{value:t}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.value is at the same time (or earlier)"),c=s(r,[[d]],{datetime:{max:t}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")})});var ld={},PP=Q;Object.defineProperty(ld,"__esModule",{value:!0});var Ds=ld.default=void 0,NP=PP(Z()),EP=ee(),IP=(0,NP.default)((0,EP.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");Ds=ld.default=IP;function Ci(e){const{warning:t,label:n="",always_display:i=!1}=e;return _(se,{variant:"caption",title:t,"aria-label":t,style:{display:t||i?"inline":"none"},children:[_(Ds,{}),_("span",{style:{position:"relative",top:-7,wordBreak:""},children:n})]})}function yy(e,t={display:"flex"}){const n={...t,color:"lightgrey"};let i="";return e!=null&&e.error&&(i=`Error: ${e.error}`,n.color="black"),e!=null&&e.warning&&(e.error&&(i+=`
----
`),i+=`Warning: ${e.warning}`),{error_or_warning_message:i,css:n}}function ky(e){const{error_or_warning_message:t,css:n}=e;return _("div",{style:{...n,maxHeight:t.length?100:0,maxWidth:t.length?100:0,transition:"max-height 1s ease, max-width 1s ease, color 1s ease"},children:_(Ci,{warning:t,always_display:!0})})}function gn(){return gn=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},gn.apply(this,arguments)}const DP=["children","options"],Mv=["allowFullScreen","allowTransparency","autoComplete","autoFocus","autoPlay","cellPadding","cellSpacing","charSet","className","classId","colSpan","contentEditable","contextMenu","crossOrigin","encType","formAction","formEncType","formMethod","formNoValidate","formTarget","frameBorder","hrefLang","inputMode","keyParams","keyType","marginHeight","marginWidth","maxLength","mediaGroup","minLength","noValidate","radioGroup","readOnly","rowSpan","spellCheck","srcDoc","srcLang","srcSet","tabIndex","useMap"].reduce((e,t)=>(e[t.toLowerCase()]=t,e),{for:"htmlFor"}),qv={amp:"&",apos:"'",gt:">",lt:"<",nbsp:" ",quot:"“"},RP=["style","script"],OP=/([-A-Z0-9_:]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|(?:\{((?:\\.|{[^}]*?}|[^}])*)\})))?/gi,MP=/mailto:/i,qP=/\n{2,}$/,xy=/^( *>[^\n]+(\n[^\n]+)*\n*)+\n{2,}/,VP=/^ *> ?/gm,FP=/^ {2,}\n/,zP=/^(?:( *[-*_])){3,} *(?:\n *)+\n/,Sy=/^\s*(`{3,}|~{3,}) *(\S+)?([^\n]*?)?\n([\s\S]+?)\s*\1 *(?:\n *)*\n?/,Ay=/^(?: {4}[^\n]+\n*)+(?:\n *)+\n?/,LP=/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,BP=/^(?:\n *)*\n/,UP=/\r\n?/g,WP=/^\[\^([^\]]+)](:.*)\n/,HP=/^\[\^([^\]]+)]/,GP=/\f/g,KP=/^\s*?\[(x|\s)\]/,$y=/^ *(#{1,6}) *([^\n]+?)(?: +#*)?(?:\n *)*(?:\n|$)/,Cy=/^([^\n]+)\n *(=|-){3,} *(?:\n *)+\n/,ol=/^ *(?!<[a-z][^ >/]* ?\/>)<([a-z][^ >/]*) ?([^>]*)\/{0}>\n?(\s*(?:<\1[^>]*?>[\s\S]*?<\/\1>|(?!<\1)[\s\S])*?)<\/\1>\n*/i,YP=/&([a-zA-Z]+);/g,jy=/^<!--[\s\S]*?(?:-->)/,JP=/^(data|aria|x)-[a-z_][a-z\d_.-]*$/,sl=/^ *<([a-z][a-z0-9:]*)(?:\s+((?:<.*?>|[^>])*))?\/?>(?!<\/\1>)(\s*\n)?/i,XP=/^\{.*\}$/,ZP=/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,QP=/^<([^ >]+@[^ >]+)>/,eN=/^<([^ >]+:\/[^ >]+)>/,tN=/-([a-z])?/gi,Ty=/^(.*\|?.*)\n *(\|? *[-:]+ *\|[-| :]*)\n((?:.*\|.*\n)*)\n?/,nN=/^\[([^\]]*)\]:\s+<?([^\s>]+)>?\s*("([^"]*)")?/,iN=/^!\[([^\]]*)\] ?\[([^\]]*)\]/,oN=/^\[([^\]]*)\] ?\[([^\]]*)\]/,sN=/(\[|\])/g,rN=/(\n|^[-*]\s|^#|^ {2,}|^-{2,}|^>\s)/,_N=/\t/g,aN=/^ *\| */,cN=/(^ *\||\| *$)/g,lN=/ *$/,dN=/^ *:-+: *$/,uN=/^ *:-+ *$/,pN=/^ *-+: *$/,mN=/^([*_])\1((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1\1(?!\1)/,fN=/^([*_])((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1(?!\1|\w)/,vN=/^==((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)==/,hN=/^~~((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)~~/,gN=/^\\([^0-9A-Za-z\s])/,wN=/^[\s\S]+?(?=[^0-9A-Z\s\u00c0-\uffff&;.()'"]|\d+\.|\n\n| {2,}\n|\w+:\S|$)/i,bN=/^\n+/,yN=/^([ \t]*)/,kN=/\\([^\\])/g,Vv=/ *\n+$/,xN=/(?:^|\n)( *)$/,dd="(?:\\d+\\.)",ud="(?:[*+-])";function Py(e){return"( *)("+(e===1?dd:ud)+") +"}const Ny=Py(1),Ey=Py(2);function Iy(e){return new RegExp("^"+(e===1?Ny:Ey))}const SN=Iy(1),AN=Iy(2);function Dy(e){return new RegExp("^"+(e===1?Ny:Ey)+"[^\\n]*(?:\\n(?!\\1"+(e===1?dd:ud)+" )[^\\n]*)*(\\n|$)","gm")}const Ry=Dy(1),Oy=Dy(2);function My(e){const t=e===1?dd:ud;return new RegExp("^( *)("+t+") [\\s\\S]+?(?:\\n{2,}(?! )(?!\\1"+t+" (?!"+t+" ))\\n*|\\s*\\n*$)")}const qy=My(1),Vy=My(2);function Fv(e,t){const n=t===1,i=n?qy:Vy,o=n?Ry:Oy,s=n?SN:AN;return{t(r,a,c){const l=xN.exec(c);return l&&(a.o||!a._&&!a.u)?i.exec(r=l[1]+r):null},i:X.HIGH,l(r,a,c){const l=n?+r[2]:void 0,d=r[0].replace(qP,`
`).match(o);let p=!1;return{p:d.map(function(f,m){const v=s.exec(f)[0].length,h=new RegExp("^ {1,"+v+"}","gm"),w=f.replace(h,"").replace(s,""),b=m===d.length-1,g=w.indexOf(`

`)!==-1||b&&p;p=g;const k=c._,y=c.o;let $;c.o=!0,g?(c._=!1,$=w.replace(Vv,`

`)):(c._=!0,$=w.replace(Vv,""));const j=a($,c);return c._=k,c.o=y,j}),m:n,g:l}},h:(r,a,c)=>e(r.m?"ol":"ul",{key:c.k,start:r.g},r.p.map(function(l,d){return e("li",{key:d},a(l,c))}))}}const $N=/^\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,CN=/^!\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,Fy=[xy,Sy,Ay,$y,Cy,jy,Ty,Ry,qy,Oy,Vy],jN=[...Fy,/^[^\n]+(?:  \n|\n{2,})/,ol,sl];function TN(e){return e.replace(/[ÀÁÂÃÄÅàáâãäåæÆ]/g,"a").replace(/[çÇ]/g,"c").replace(/[ðÐ]/g,"d").replace(/[ÈÉÊËéèêë]/g,"e").replace(/[ÏïÎîÍíÌì]/g,"i").replace(/[Ññ]/g,"n").replace(/[øØœŒÕõÔôÓóÒò]/g,"o").replace(/[ÜüÛûÚúÙù]/g,"u").replace(/[ŸÿÝý]/g,"y").replace(/[^a-z0-9- ]/gi,"").replace(/ /gi,"-").toLowerCase()}function PN(e){return pN.test(e)?"right":dN.test(e)?"center":uN.test(e)?"left":null}function zv(e,t,n){const i=n.v;n.v=!0;const o=t(e.trim(),n);n.v=i;let s=[[]];return o.forEach(function(r,a){r.type==="tableSeparator"?a!==0&&a!==o.length-1&&s.push([]):(r.type!=="text"||o[a+1]!=null&&o[a+1].type!=="tableSeparator"||(r.$=r.$.replace(lN,"")),s[s.length-1].push(r))}),s}function NN(e,t,n){n._=!0;const i=zv(e[1],t,n),o=e[2].replace(cN,"").split("|").map(PN),s=function(r,a,c){return r.trim().split(`
`).map(function(l){return zv(l,a,c)})}(e[3],t,n);return n._=!1,{S:o,A:s,L:i,type:"table"}}function Lv(e,t){return e.S[t]==null?{}:{textAlign:e.S[t]}}function Jt(e){return function(t,n){return n._?e.exec(t):null}}function Xt(e){return function(t,n){return n._||n.u?e.exec(t):null}}function It(e){return function(t,n){return n._||n.u?null:e.exec(t)}}function Di(e){return function(t){return e.exec(t)}}function EN(e,t,n){if(t._||t.u||n&&!n.endsWith(`
`))return null;let i="";e.split(`
`).every(s=>!Fy.some(r=>r.test(s))&&(i+=s+`
`,s.trim()));const o=i.trimEnd();return o==""?null:[i,o]}function Jn(e){try{if(decodeURIComponent(e).replace(/[^A-Za-z0-9/:]/g,"").match(/^\s*(javascript|vbscript|data(?!:image)):/i))return null}catch{return null}return e}function Bv(e){return e.replace(kN,"$1")}function Wo(e,t,n){const i=n._||!1,o=n.u||!1;n._=!0,n.u=!0;const s=e(t,n);return n._=i,n.u=o,s}function IN(e,t,n){const i=n._||!1,o=n.u||!1;n._=!1,n.u=!0;const s=e(t,n);return n._=i,n.u=o,s}function DN(e,t,n){return n._=!1,e(t+`

`,n)}const $c=(e,t,n)=>({$:Wo(t,e[1],n)});function Cc(){return{}}function jc(){return null}function RN(...e){return e.filter(Boolean).join(" ")}function Tc(e,t,n){let i=e;const o=t.split(".");for(;o.length&&(i=i[o[0]],i!==void 0);)o.shift();return i||n}var X;function ON(e,t={}){t.overrides=t.overrides||{},t.slugify=t.slugify||TN,t.namedCodesToUnicode=t.namedCodesToUnicode?gn({},qv,t.namedCodesToUnicode):qv;const n=t.createElement||wu;function i(m,v,...h){const w=Tc(t.overrides,`${m}.props`,{});return n(function(b,g){const k=Tc(g,b);return k?typeof k=="function"||typeof k=="object"&&"render"in k?k:Tc(g,`${b}.component`,b):b}(m,t.overrides),gn({},v,w,{className:RN(v==null?void 0:v.className,w.className)||void 0}),...h)}function o(m){let v=!1;t.forceInline?v=!0:t.forceBlock||(v=rN.test(m)===!1);const h=d(l(v?m:`${m.trimEnd().replace(bN,"")}

`,{_:v}));for(;typeof h[h.length-1]=="string"&&!h[h.length-1].trim();)h.pop();if(t.wrapper===null)return h;const w=t.wrapper||(v?"span":"div");let b;if(h.length>1||t.forceWrapper)b=h;else{if(h.length===1)return b=h[0],typeof b=="string"?i("span",{key:"outer"},b):b;b=null}return wu(w,{key:"outer"},b)}function s(m){const v=m.match(OP);return v?v.reduce(function(h,w,b){const g=w.indexOf("=");if(g!==-1){const k=function(C){return C.indexOf("-")!==-1&&C.match(JP)===null&&(C=C.replace(tN,function(N,A){return A.toUpperCase()})),C}(w.slice(0,g)).trim(),y=function(C){const N=C[0];return(N==='"'||N==="'")&&C.length>=2&&C[C.length-1]===N?C.slice(1,-1):C}(w.slice(g+1).trim()),$=Mv[k]||k,j=h[$]=function(C,N){return C==="style"?N.split(/;\s?/).reduce(function(A,R){const M=R.slice(0,R.indexOf(":"));return A[M.replace(/(-[a-z])/g,T=>T[1].toUpperCase())]=R.slice(M.length+1).trim(),A},{}):C==="href"?Jn(N):(N.match(XP)&&(N=N.slice(1,N.length-1)),N==="true"||N!=="false"&&N)}(k,y);typeof j=="string"&&(ol.test(j)||sl.test(j))&&(h[$]=$h(o(j.trim()),{key:b}))}else w!=="style"&&(h[Mv[w]||w]=!0);return h},{}):null}const r=[],a={},c={blockQuote:{t:It(xy),i:X.HIGH,l:(m,v,h)=>({$:v(m[0].replace(VP,""),h)}),h:(m,v,h)=>i("blockquote",{key:h.k},v(m.$,h))},breakLine:{t:Di(FP),i:X.HIGH,l:Cc,h:(m,v,h)=>i("br",{key:h.k})},breakThematic:{t:It(zP),i:X.HIGH,l:Cc,h:(m,v,h)=>i("hr",{key:h.k})},codeBlock:{t:It(Ay),i:X.MAX,l:m=>({$:m[0].replace(/^ {4}/gm,"").replace(/\n+$/,""),M:void 0}),h:(m,v,h)=>i("pre",{key:h.k},i("code",gn({},m.I,{className:m.M?`lang-${m.M}`:""}),m.$))},codeFenced:{t:It(Sy),i:X.MAX,l:m=>({I:s(m[3]||""),$:m[4],M:m[2]||void 0,type:"codeBlock"})},codeInline:{t:Xt(LP),i:X.LOW,l:m=>({$:m[2]}),h:(m,v,h)=>i("code",{key:h.k},m.$)},footnote:{t:It(WP),i:X.MAX,l:m=>(r.push({O:m[2],B:m[1]}),{}),h:jc},footnoteReference:{t:Jt(HP),i:X.HIGH,l:m=>({$:m[1],R:`#${t.slugify(m[1])}`}),h:(m,v,h)=>i("a",{key:h.k,href:Jn(m.R)},i("sup",{key:h.k},m.$))},gfmTask:{t:Jt(KP),i:X.HIGH,l:m=>({T:m[1].toLowerCase()==="x"}),h:(m,v,h)=>i("input",{checked:m.T,key:h.k,readOnly:!0,type:"checkbox"})},heading:{t:It($y),i:X.HIGH,l:(m,v,h)=>({$:Wo(v,m[2],h),j:t.slugify(m[2]),C:m[1].length}),h:(m,v,h)=>i(`h${m.C}`,{id:m.j,key:h.k},v(m.$,h))},headingSetext:{t:It(Cy),i:X.MAX,l:(m,v,h)=>({$:Wo(v,m[1],h),C:m[2]==="="?1:2,type:"heading"})},htmlComment:{t:Di(jy),i:X.HIGH,l:()=>({}),h:jc},image:{t:Xt(CN),i:X.HIGH,l:m=>({D:m[1],R:Bv(m[2]),N:m[3]}),h:(m,v,h)=>i("img",{key:h.k,alt:m.D||void 0,title:m.N||void 0,src:Jn(m.R)})},link:{t:Jt($N),i:X.LOW,l:(m,v,h)=>({$:IN(v,m[1],h),R:Bv(m[2]),N:m[3]}),h:(m,v,h)=>i("a",{key:h.k,href:Jn(m.R),title:m.N},v(m.$,h))},linkAngleBraceStyleDetector:{t:Jt(eN),i:X.MAX,l:m=>({$:[{$:m[1],type:"text"}],R:m[1],type:"link"})},linkBareUrlDetector:{t:(m,v)=>v.Z?null:Jt(ZP)(m,v),i:X.MAX,l:m=>({$:[{$:m[1],type:"text"}],R:m[1],N:void 0,type:"link"})},linkMailtoDetector:{t:Jt(QP),i:X.MAX,l(m){let v=m[1],h=m[1];return MP.test(h)||(h="mailto:"+h),{$:[{$:v.replace("mailto:",""),type:"text"}],R:h,type:"link"}}},orderedList:Fv(i,1),unorderedList:Fv(i,2),newlineCoalescer:{t:It(BP),i:X.LOW,l:Cc,h:()=>`
`},paragraph:{t:EN,i:X.LOW,l:$c,h:(m,v,h)=>i("p",{key:h.k},v(m.$,h))},ref:{t:Jt(nN),i:X.MAX,l:m=>(a[m[1]]={R:m[2],N:m[4]},{}),h:jc},refImage:{t:Xt(iN),i:X.MAX,l:m=>({D:m[1]||void 0,F:m[2]}),h:(m,v,h)=>i("img",{key:h.k,alt:m.D,src:Jn(a[m.F].R),title:a[m.F].N})},refLink:{t:Jt(oN),i:X.MAX,l:(m,v,h)=>({$:v(m[1],h),P:v(m[0].replace(sN,"\\$1"),h),F:m[2]}),h:(m,v,h)=>a[m.F]?i("a",{key:h.k,href:Jn(a[m.F].R),title:a[m.F].N},v(m.$,h)):i("span",{key:h.k},v(m.P,h))},table:{t:It(Ty),i:X.HIGH,l:NN,h:(m,v,h)=>i("table",{key:h.k},i("thead",null,i("tr",null,m.L.map(function(w,b){return i("th",{key:b,style:Lv(m,b)},v(w,h))}))),i("tbody",null,m.A.map(function(w,b){return i("tr",{key:b},w.map(function(g,k){return i("td",{key:k,style:Lv(m,k)},v(g,h))}))})))},tableSeparator:{t:function(m,v){return v.v?aN.exec(m):null},i:X.HIGH,l:function(){return{type:"tableSeparator"}},h:()=>" | "},text:{t:Di(wN),i:X.MIN,l:m=>({$:m[0].replace(YP,(v,h)=>t.namedCodesToUnicode[h]?t.namedCodesToUnicode[h]:v)}),h:m=>m.$},textBolded:{t:Xt(mN),i:X.MED,l:(m,v,h)=>({$:v(m[2],h)}),h:(m,v,h)=>i("strong",{key:h.k},v(m.$,h))},textEmphasized:{t:Xt(fN),i:X.LOW,l:(m,v,h)=>({$:v(m[2],h)}),h:(m,v,h)=>i("em",{key:h.k},v(m.$,h))},textEscaped:{t:Xt(gN),i:X.HIGH,l:m=>({$:m[1],type:"text"})},textMarked:{t:Xt(vN),i:X.LOW,l:$c,h:(m,v,h)=>i("mark",{key:h.k},v(m.$,h))},textStrikethroughed:{t:Xt(hN),i:X.LOW,l:$c,h:(m,v,h)=>i("del",{key:h.k},v(m.$,h))}};t.disableParsingRawHTML!==!0&&(c.htmlBlock={t:Di(ol),i:X.HIGH,l(m,v,h){const[,w]=m[3].match(yN),b=new RegExp(`^${w}`,"gm"),g=m[3].replace(b,""),k=(y=g,jN.some(N=>N.test(y))?DN:Wo);var y;const $=m[1].toLowerCase(),j=RP.indexOf($)!==-1;h.Z=h.Z||$==="a";const C=j?m[3]:k(v,g,h);return h.Z=!1,{I:s(m[2]),$:C,G:j,H:j?$:m[1]}},h:(m,v,h)=>i(m.H,gn({key:h.k},m.I),m.G?m.$:v(m.$,h))},c.htmlSelfClosing={t:Di(sl),i:X.HIGH,l:m=>({I:s(m[2]||""),H:m[1]}),h:(m,v,h)=>i(m.H,gn({},m.I,{key:h.k}))});const l=function(m){let v=Object.keys(m);function h(w,b){let g=[],k="";for(;w;){let y=0;for(;y<v.length;){const $=v[y],j=m[$],C=j.t(w,b,k);if(C){const N=C[0];w=w.substring(N.length);const A=j.l(C,h,b);A.type==null&&(A.type=$),g.push(A),k=N;break}y++}}return g}return v.sort(function(w,b){let g=m[w].i,k=m[b].i;return g!==k?g-k:w<b?-1:1}),function(w,b){return h(function(g){return g.replace(UP,`
`).replace(GP,"").replace(_N,"    ")}(w),b)}}(c),d=(p=function(m){return function(v,h,w){return m[v.type].h(v,h,w)}}(c),function m(v,h={}){if(Array.isArray(v)){const w=h.k,b=[];let g=!1;for(let k=0;k<v.length;k++){h.k=k;const y=m(v[k],h),$=typeof y=="string";$&&g?b[b.length-1]+=y:y!==null&&b.push(y),g=$}return h.k=w,b}return p(v,m,h)});var p;const f=o(e);return r.length?i("div",null,f,i("footer",{key:"footer"},r.map(function(m){return i("div",{id:t.slugify(m.B),key:m.B},m.B,d(l(m.O,{_:!0})))}))):f}(function(e){e[e.MAX=0]="MAX",e[e.HIGH=1]="HIGH",e[e.MED=2]="MED",e[e.LOW=3]="LOW",e[e.MIN=4]="MIN"})(X||(X={}));const vo=e=>{let{children:t,options:n}=e,i=function(o,s){if(o==null)return{};var r,a,c={},l=Object.keys(o);for(a=0;a<l.length;a++)s.indexOf(r=l[a])>=0||(c[r]=o[r]);return c}(e,DP);return $h(ON(t,n),i)};function rt(e){var t;return(t=e.derived.current_composed_knowledge_view)==null?void 0:t.wc_id_to_active_counterfactuals_v2_map}function ho(e,t){var i;if(!t)return;const n=rt(e);return n&&((i=n[t])==null?void 0:i.VAP_sets)}function zy(e,t){const{overlapping_wc_ids:n={}}=e.derived.current_composed_knowledge_view||{};return n[t]}function MN(e){return _("a",{href:e.href,onClick:t=>t.stopImmediatePropagation(),onPointerDown:t=>t.stopImmediatePropagation(),children:e.children})}const qN=e=>({rich_text:e.display_options.consumption_formatting,composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:rt(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),VN=P(qN);function FN(e){const{text:t,rich_text:n,composed_wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,placeholder:r="...",created_at_ms:a,sim_ms:c}=e,l=n?fe.rich:fe.raw,d=ni({text:t,text_type:l,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:a,sim_ms:c});return _(vo,{options:md,children:d&&Qt(d)||r})}const pd=VN(FN),md={overrides:{a:MN,script:e=>e.children,auto:e=>"",iframe:e=>{const{src:t}=e;return new URL(t).hostname==="www.youtube.com"?_("iframe",{...e}):null},tweet:e=>{const t=`https://platform.twitter.com/embed/Tweet.html?dnt=false&frame=false&hideCard=false&hideThread=false&id=${e.id}&lang=en-gb&theme=light&widgetsVersion=0a8eea3%3A1643743420422&width=400px"`;return _("iframe",{src:t,scrolling:"no",frameBorder:0,allowTransparency:!0,allowFullScreen:!0,style:{width:401,height:624}})},img:e=>{var t;return(t=e.style)==null||delete t.position,_("img",{src:e.src,style:e.style,alt:e.alt})}}};function Ly(e){const{judgement_wcomponent:t,target_wcomponent:n,VAP_set_id_to_counterfactual_v2_map:i,created_at_ms:o,sim_ms:s}=e;if(t.judgement_manual!==void 0)return t.judgement_manual;if(!n)return;const{most_probable_VAP_set_values:r}=An({wcomponent:n,VAP_set_id_to_counterfactual_v2_map:i,created_at_ms:o,sim_ms:s});if(r.length!==1)return;const c=r[0].parsed_value,d=oe(n,{});return By({judgement_wcomponent:t,target_VAPs_represent:d,value:c})}function By(e){const{judgement_wcomponent:t,target_VAPs_represent:n,value:i}=e,{judgement_operator:o,judgement_comparator_value:s,judgement_manual:r}=t;if(r!==void 0)return r;const a=n===E.number?parseFloat(s||""):n===E.boolean?s==="True"||(s==="False"?!1:void 0):s;let c;return i===null||a===void 0?c=void 0:o==="=="?c=i===a:o==="!="?c=i!==a:o==="<"?c=i<a:o==="<="?c=i<=a:o===">"?c=i>a:o===">="&&(c=i>=a),c}var fd={},zN=Q;Object.defineProperty(fd,"__esModule",{value:!0});var Uy=fd.default=void 0,LN=zN(Z()),BN=ee(),UN=(0,LN.default)((0,BN.jsx)("path",{d:"m16 18 2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"}),"TrendingDown");Uy=fd.default=UN;var vd={},WN=Q;Object.defineProperty(vd,"__esModule",{value:!0});var Wy=vd.default=void 0,HN=WN(Z()),GN=ee(),KN=(0,HN.default)((0,GN.jsx)("path",{d:"m22 12-4-4v3H3v2h15v3z"}),"TrendingFlat");Wy=vd.default=KN;var hd={},YN=Q;Object.defineProperty(hd,"__esModule",{value:!0});var Hy=hd.default=void 0,JN=YN(Z()),XN=ee(),ZN=(0,JN.default)((0,XN.jsx)("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"}),"TrendingUp");Hy=hd.default=ZN;function Et(e){var n,i;let{className:t=""}=e;return t="MuiSvgIcon-root "+t,e.fontSize==="small"&&(t+=" MuiSvgIcon-fontSizeSmall "),_("span",{title:e.title,style:{width:(n=e.style)==null?void 0:n.width,height:(i=e.style)==null?void 0:i.height},children:_("svg",{className:t,viewBox:"0 0 24 24",style:e.style,children:[_("path",{d:e.d}),e.svg_elements]})})}const QN="M11.07 12.85c.77-1.39 2.25-2.21 3.11-3.44.91-1.29.4-3.7-2.18-3.7-1.69 0-2.52 1.28-2.87 2.34L6.54 6.96C7.25 4.83 9.18 3 11.99 3c2.35 0 3.96 1.07 4.78 2.41.7 1.15 1.11 3.3.03 4.9-1.2 1.77-2.35 2.31-2.97 3.45-.25.46-.35.76-.35 2.24h-2.89c-.01-.78-.13-2.05.48-3.15zM14 20c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z";function eE(e){return _(Et,{...e,d:QN})}const tE=(e,t)=>{const n=e.routing,{selected_on:i=new Set}=t;let o=i.size>0;return i.size&&(i.has("route")&&t.route!==void 0&&(o=o&&t.route===n.route),t.args&&(i.has("args.view")&&t.args.view!==void 0&&(o=o&&t.args.view===n.args.view),i.has("args.subview_id")&&t.args.subview_id!==void 0&&(o=o&&t.args.subview_id===n.args.subview_id))),{current_routing_state:n,selected:o}},nE=(e,t)=>({change_route:n=>e(S.routing.change_route({route:t.route,sub_route:t.sub_route,item_id:t.item_id,args:n}))}),Gy=P(tE,nE);function iE(e){const{children:t="Link"}=e,[n,i]=D(!1),o=De(void 0);if(e.disabled)return t;n&&!o.current&&(o.current=setTimeout(()=>{i(!1),o.current=void 0},300));const s=e.args||{},r=d=>{d.stopImmediatePropagation(),d.preventDefault(),!e.selected&&(i(!0),!(e.on_pointer_down&&e.on_pointer_down())&&e.change_route(s))},a=Mt(e.current_routing_state,e),c={...e.current_routing_state.args,...s};a.args=c;const l="link "+(n?" clicked_animate ":"")+(e.selected?" selected ":"")+(e.extra_class_name||"");return _("a",{onPointerDown:r,onClick:d=>{d.stopImmediatePropagation(),d.preventDefault()},href:fi({...a}),className:l,style:e.extra_css_style,children:t})}const Le=Gy(iE);function oE(e){const t=e.args||{},n=s=>{s.stopImmediatePropagation(),s.preventDefault(),!(e.on_pointer_down&&e.on_pointer_down())&&e.change_route(t)},i=Mt(e.current_routing_state,e),o={...e.current_routing_state.args,...t};return i.args=o,_(Se,{size:"small",color:"primary",variant:"contained",onClick:n,href:fi({...i}),children:e.name||"Link"})}const sE=Gy(oE);function gd(e){const{judgement:t,judgement_trend_manual:n,size:i}=e,s=`judgement_badge ${i} ${t?"positive":t===void 0?"inactive":"negative"} ${n??""}`,r=n==="improving"?_(Hy,{}):n==="stable"?_(Wy,{}):n==="worsening"?_(Uy,{}):n==="unknown"?_(eE,{}):_("span",{});if(!e.judgement_or_objective_id)return _("div",{className:s,children:r});let a;return e.position&&(a=vi({...e.position,zoom:100},!0)),_(Le,{route:void 0,sub_route:void 0,item_id:e.judgement_or_objective_id,args:a,extra_class_name:s,on_pointer_down:()=>{const c=Ae(),l=c.getState(),{display_side_panel:d,display_time_sliders:p}=l.controls;return e.position&&(a=vi({...e.position,zoom:100},!0,{display_side_panel:d,display_time_sliders:p})),c.dispatch(S.routing.change_route({item_id:e.judgement_or_objective_id,args:a})),!0},children:r})}const rE=(e,t)=>{let n=pe(e,t.judgement_or_objective_id);ut(n)||(n=void 0);let i,o;if(n){const a=n.judgement_target_wcomponent_id;i=pe(e,a),o=ho(e,a)}const s=_e(e),r=s==null?void 0:s.composed_wc_id_map[t.judgement_or_objective_id];return{judgement_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,position:r}},_E=P(rE);function aE(e){const{judgement_or_objective_id:t,judgement_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r,position:a}=e;if(!n||!i)return null;const c=Ly({judgement_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r});return _(gd,{judgement:c,judgement_trend_manual:e.hide_judgement_trend?void 0:n.judgement_trend_manual,judgement_or_objective_id:t,position:a,size:e.hide_judgement_trend?"small":"medium"})}const Ky=_E(aE);function cn(e){const{wcomponents:t,allowed_wcomponent_ids:n,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a}=e;let c=t||Object.values(i);return n&&(c=c.filter(({id:d})=>n.has(d))),c.filter(so).filter(d=>!e.exclude_ids||!e.exclude_ids.has(d.id)).map(d=>{const p=mt({wcomponent:d,text_type:fe.plain,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a});let f=`@@${d.id} -- ${d.title} -- ${d.description}`;ye(d)&&(f+=` -- @@${d.from_id} -> @@${d.to_id}`);let m;return ut(d)&&(m=_("div",{children:[_(Ky,{judgement_or_objective_id:d.id,hide_judgement_trend:!1}),p]})),{id:d.id,title:p,jsx:m,raw_title:d.title,subtitle:f,color:d.label_color}})}var wd={},cE=Q;Object.defineProperty(wd,"__esModule",{value:!0});var Yy=wd.default=void 0,lE=cE(Z()),dE=ee(),uE=(0,lE.default)((0,dE.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");Yy=wd.default=uE;var bd={},pE=Q;Object.defineProperty(bd,"__esModule",{value:!0});var Jy=bd.default=void 0,mE=pE(Z()),fE=ee(),vE=(0,mE.default)((0,fE.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"}),"Refresh");Jy=bd.default=vE;function hE(e){const{editing_options:t,internal_options_to_display:n,is_option_wrapper_highlighted:i,conditional_on_change:o,set_highlighted_option_index:s,on_mouse_over_option:r,on_mouse_leave_option:a}=e;if(n.length===0||!t)return null;const c=45;return _("div",{className:"options_outer",style:{marginTop:15},children:_("div",{className:"options_inner",ref:l=>{if(!l)return;const d=`${document.body.clientHeight-l.clientTop-c}px`;l.style.setProperty("max-height",d)},children:n.map((l,d)=>_("div",{className:"option_wrapper "+(i(l,d)?" highlighted ":""),onMouseDown:()=>o(l.id),onMouseOver:()=>{s(d),r(l.id)},onMouseLeave:()=>a(l.id),children:_("div",{className:"option",children:[l.jsx||l.title||l.id||"none",_("div",{className:"option_subtitle",children:l.subtitle})]})}))})})}const gE=e=>{var t;return{presenting:(t=e.display_options)==null?void 0:t.consumption_formatting}},wE=P(gE);function bE(e){const t=De([]),n=De(rk.Index()),i=De([]);re(()=>{const T=SE(e.options,200,e.search_fields),B=AE(T);t.current=B,T.forEach(ne=>{n.current=n.current.add(ne.id_num,ne.unlimited_total_text)}),i.current=T},[e.options,e.search_fields]);const o=De({actively_chosen:!1,id:void 0}),s=$(),[r,a]=D("");re(()=>{a(e.initial_search_term||s)},[e.initial_search_term,s]);const{throttled:c,flush:l}=Yc(a,300),[d,p]=D(!1);function f(T){T!==d&&p(T)}re(()=>{f(!!e.start_expanded)},[e.start_expanded]);const{threshold_minimum_score:m=!1}=e,[v,h]=D([]);re(()=>{const T=$E({temp_value_str:r,selected_any_option:e.selected_option_id!==yd,allow_none:!!e.allow_none,internal_options:i.current,prepared_targets:t.current,flexsearch_index:n.current,search_type:e.search_type||"best",threshold_minimum_score:m,retain_options_order:e.retain_options_order||!1});h(T.internal_options),e.set_search_type_used&&e.set_search_type_used(T.search_type_used),l()},[r,e.selected_option_id,e.allow_none,i.current,t.current,n.current,e.search_type,m]);const[w,b]=D(0),g=De(new Set),k=z(()=>T=>{T&&g.current.add(T),e.on_mouse_over_option&&e.on_mouse_over_option(T)},[e.on_mouse_over_option]),y=z(()=>T=>{T&&g.current.delete(T),e.on_mouse_leave_option&&e.on_mouse_leave_option(T)},[e.on_mouse_leave_option]);function $(){const T=kE(e);return(T==null?void 0:T.title)||""}const j=(T,B)=>{T.stopImmediatePropagation();const ne=T.key,Ye=ne==="ArrowDown",_t=ne==="ArrowUp",Ln=ne==="Enter",Gt=ne==="Escape";if(Ln||Gt)if(Ln){const wt=B[w];wt&&N(wt.id)}else Gt&&N(e.selected_option_id);else if(Ye||_t){let wt=w+(Ye?1:-1);wt=wt%B.length,b(wt)}},C=()=>{f(!1),e.retain_invalid_search_term_on_blur||a($()),b(0)},N=T=>{C(),o.current={actively_chosen:!0,id:T}},A=()=>{C();const{on_mouse_leave_option:T}=e;T&&(g.current.forEach(_t=>T(_t)),g.current=new Set);const{actively_chosen:B,id:ne}=o.current;if(!B)return;o.current={actively_chosen:!1,id:void 0},e.selected_option_id===ne?e.on_choose_same&&e.on_choose_same(ne):e.on_change(ne)},R=xE(v,r),M=(R==null?void 0:R.id)===rl.id&&e.allow_none||r.toLowerCase()===(R==null?void 0:R.title.toLowerCase());return _("div",{class:"editable_field autocomplete "+(M?"":"invalid "),style:e.extra_styles,children:[_(In,{variant:"standard",disabled:e.editing_allowed!==void 0?!e.editing_allowed:e.presenting,ref:T=>{if(!T)return;const B=T.getElementsByTagName("input")[0];B&&setTimeout(d?()=>B.focus():()=>B.blur(),0)},placeholder:e.placeholder,value:r||(d?"":"-"),onFocus:T=>{setTimeout(()=>f(!0),0),T.currentTarget.setSelectionRange(0,T.currentTarget.value.length)},onChange:T=>c(T.currentTarget.value),onKeyDown:T=>j(T,v),onBlur:()=>A()}),_(hE,{editing_options:d,internal_options_to_display:v,is_option_wrapper_highlighted:(T,B)=>B===w,conditional_on_change:N,set_highlighted_option_index:b,on_mouse_over_option:k,on_mouse_leave_option:y})]})}const yE=wE(bE);function de(e){return _(yE,{...e})}function kE(e){return e.selected_option_id===void 0?e.allow_none?void 0:e.options[0]:e.options.find(({id:t})=>t===e.selected_option_id)}function xE(e,t){const n=t.toLowerCase();return e.find(i=>i.title.toLowerCase()===n)}const Xy=1;function SE(e,t,n="all"){let i=Xy;const o=n==="all";return e.filter(({is_hidden:r})=>!r).map(r=>{const a=Uv(r,t,o),c=Uv(r,0,o);return{...r,limited_total_text:a,unlimited_total_text:c,id_num:i++}})}function Uv(e,t,n){let i=Pc(e.title,t);return n?i+=e.subtitle?" "+Pc(e.subtitle,t):"":i+=e.raw_title?" "+Pc(e.raw_title,t):"",i}function Pc(e,t){return t?e.slice(0,t)+(e.length>t?"...":""):e}function AE(e){return e.map(({limited_total_text:t})=>Ch.prepare(t))}const yd=void 0,rl={id:yd,id_num:Xy-1,title:"(clear)",limited_total_text:"clear",unlimited_total_text:""};function $E(e){const{temp_value_str:t,selected_any_option:n,allow_none:i,prepared_targets:o,flexsearch_index:s,search_type:r,threshold_minimum_score:a,retain_options_order:c}=e;let{internal_options:l}=e,d;if(!t)return l=i&&n?[rl,...l]:l,{internal_options:l,search_type_used:d};let p=w=>0,f=w=>0,m=0;if(r==="best"||r==="exact"){d="exact";const w=s.search(t);m=w.length;const b={};w.forEach((g,k)=>b[g]=1e4-k),p=g=>b[g.id_num]||-1e4}if(m<10&&(r==="best"||r==="fuzzy")){d="fuzzy";const w={limit:100,allowTypo:!0,threshold:-1e4},b=Ch.go(t,o,w),g={};b.forEach(({target:k,score:y})=>g[k]=y),f=k=>{const y=g[k.limited_total_text];return y===void 0?p(k):y}}else f=p;const v=a===!1?l:l.filter(w=>f(w)>a);let h=v;return c||(h=be(v,f,ve.descending)),i&&n&&(h=[rl,...h]),{internal_options:h,search_type_used:d}}function CE(e,t){const n=e.global_keys.last_key==="Escape",{last_key_time_stamp:i=0}=e.global_keys;return{should_close:n&&i>t.time_stamp_first_rendered}}const jE=P(CE);function TE(e){const{on_close:t}=e;return t&&e.should_close&&setTimeout(()=>t(),0),_("div",{id:"modal_background",className:(e.size||"medium")+"_modal",onClick:n=>{n.stopImmediatePropagation(),t&&t(n)},children:_("div",{id:"modal_container",style:e.scrollable===!1?{overflowY:"hidden"}:void 0,onClick:n=>n.stopPropagation(),children:[_("div",{id:"modal_title",children:e.title}),t&&_("div",{id:"modal_close",onClick:n=>t(n),children:_("span",{children:"X"})}),e.child]})})}const PE=jE(TE);function ji(e){const t=performance.now();return _(PE,{...e,time_stamp_first_rendered:t})}function NE(e){const[t,n]=D("all"),[i,o]=D("best"),[s,r]=D(void 0),[a,c]=D(!1),l=_(Ds,{titleAccess:"You might be getting sub optimal search results!",style:{color:V1[600]}}),d=()=>i=="best"&&t=="all";return _(ji,{on_close:()=>e.on_blur&&e.on_blur(),title:e.search_window_title,child:_(I,{p:5,children:[_(Mi,{onChange:(p,f)=>{c(f)},children:[_(qi,{expandIcon:!d()&&!a?l:_(Yy,{}),children:_(se,{component:"h2",children:[a?"Hide ":"Show ","Advanced Search Options"]})}),_(Vi,{children:_(I,{width:1,children:[_(I,{display:"flex",justifyContent:"flex-start",alignItems:"stretch",children:[_(I,{mr:10,flexGrow:1,flexShrink:0,children:_(ot,{variant:"standard",component:"fieldset",fullWidth:!0,children:[_(ai,{component:"legend",children:"Search Type: "}),_(hu,{name:"search_type",value:i,onChange:p=>o(p.target.value),children:[_(Pi,{value:"exact",control:_(Ni,{}),label:"Exact"}),_(Pi,{value:"fuzzy",control:_(Ni,{}),label:"Fuzzy"}),_(Pi,{value:"best",control:_(Ni,{}),label:"Best"})]})]})}),_(I,{mr:10,flexGrow:1,flexShrink:0,children:_(ot,{variant:"standard",component:"fieldset",fullWidth:!0,children:[_(ai,{component:"legend",children:"Search Over: "}),_(hu,{name:"search_fields",value:t,onChange:p=>n(p.target.value),children:[_(Pi,{value:"all",control:_(Ni,{}),label:"All"}),_(Pi,{value:"title",control:_(Ni,{}),label:"Title Only"})]})]})}),_(I,{flexGrow:1,flexShrink:0,alignSelf:"flex-end",textAlign:"right",children:!d()&&_(Se,{variant:"contained",color:"primary",onClick:()=>{o("best"),n("all")},endIcon:_(Jy,{}),children:"Reset Search Options"})})]}),_(I,{style:{opacity:s?.7:0},children:["Used: ",s]})]})})]}),_(de,{placeholder:e.placeholder,selected_option_id:e.selected_option_id,initial_search_term:e.initial_search_term,options:e.options,allow_none:e.allow_none,on_change:p=>{e.on_change(p),e.on_blur&&e.on_blur()},on_mouse_over_option:e.on_mouse_over_option,on_mouse_leave_option:e.on_mouse_leave_option,extra_styles:e.extra_styles,start_expanded:!0,retain_invalid_search_term_on_blur:!0,search_fields:t,search_type:i,set_search_type_used:r,editing_allowed:!0,threshold_minimum_score:-1e3})]})})}const EE=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:rt(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),IE=P(EE);function DE(e){const t=cn(e);return _(NE,{search_window_title:"Search for a Component",placeholder:"Search for a Component...",selected_option_id:"",initial_search_term:e.initial_search_term,allow_none:!0,options:t,on_change:e.on_change,on_blur:e.on_blur})}const Zy=IE(DE);function RE(e){const{value:t,id_insertion_point:n,conditional_on_change:i,on_close:o}=e,s=OE({value:t,id_insertion_point:n}),r=De(!1);return _(Zy,{initial_search_term:s,on_change:a=>{const c=ME({value:t,id_to_insert:a,id_insertion_point:n}),l=n+((a==null?void 0:a.length)||0),d=l+((s==null?void 0:s.length)||0),p={start:l,end:d};r.current=!0,i({new_value:c,on_focus_set_selection:p})},on_blur:()=>{if(r.current)return;const a=n+((s==null?void 0:s.length)||0);o({start:n,end:a})}})}function OE(e){const n=e.value.slice(e.id_insertion_point).match(/^(\w+)/);return n&&n[1]||""}function ME(e){const{value:t,id_to_insert:n,id_insertion_point:i}=e;return n===void 0?t:t.slice(0,i)+n+t.slice(i)}var K=(e=>(e[e.conditional=0]="conditional",e[e.always=1]="always",e))(K||{});const qE=e=>({presenting:e.display_options.consumption_formatting}),VE=P(qE);function FE(e){const{placeholder:t,disabled:n,presenting:i,editing_allowed:o,select_all_on_focus:s,force_focus_on_first_render:r,on_blur_type:a=0}=e,[c,l]=D(e.value);re(()=>l(e.value),[e.value]);const d=De(void 0),p=De(void 0);if(o===!1||!e.conditional_on_change&&!e.on_blur||n||i&&o===void 0){const A=n?"disabled":"",R=!!e.value;return _("div",{className:A,children:[R&&!e.hide_label&&_("span",{className:"description_label",children:[e.placeholder," "]}),_(pd,{text:c||t})]})}const f=`editable_field ${c?"":"placeholder"}`,m=z(()=>A=>{if(!A)return;const R=!d.current;d.current=A,R&&zE({el:A,force_focus_on_first_render:r})},[]),v=z(()=>A=>{LE({e:A,select_all_on_focus:s})},[s]),h=z(()=>A=>{A!==e.value&&e.conditional_on_change&&e.conditional_on_change(A),l(A)},[e.value,e.conditional_on_change]),w=z(()=>A=>{e.modify_value_pre_on_blur&&(A=e.modify_value_pre_on_blur(A));const R=A!==e.value;(a===1||R)&&e.on_blur&&e.on_blur(A),l(A)},[e.value,a,e.on_blur]),b=z(()=>A=>{if(p.current!==void 0)return;const R=HE(A.currentTarget);R!==void 0&&(p.current=R),h(A.currentTarget.value)},[h]),g=z(()=>A=>{p.current===void 0&&w(A.currentTarget.value)},[e.value,w]),k=z(()=>A=>{BE(A,d.current,h,w)},[h,w]),y=De(w);y.current=w,re(()=>()=>{!d.current||!(document.activeElement===d.current)||y.current(d.current.value)},[]);const[$,j]=D({}),C=z(()=>A=>{var R,M;(R=d.current)==null||R.focus(),p.current=void 0,j({}),(M=d.current)==null||M.setSelectionRange(A.start,A.end)},[]),N=z(()=>e.component({value:c,on_render:m,on_focus:v,on_change:b,on_blur:g,on_key_down:k}),[c,m,v,b,g]);return _("div",{className:f,style:e.style,children:[N,p.current!==void 0&&_("div",{style:{fontSize:"initial",fontWeight:"initial"},children:_(RE,{value:c,id_insertion_point:p.current,conditional_on_change:({new_value:A,on_focus_set_selection:R})=>{h(A),setTimeout(()=>C(R),0)},on_close:A=>{C(A)}})})]})}const Qy=VE(FE);function zE(e){e.force_focus_on_first_render&&setTimeout(()=>e.el.focus(),0)}function LE(e){if(e.select_all_on_focus){const t=e.e.currentTarget;t.setSelectionRange(0,t.value.length)}}function BE(e,t,n,i){document.activeElement===t&&(UE(e,t,n),WE(e,t,i))}function UE(e,t,n){if(!e.ctrlKey||e.key!=="k")return;e.preventDefault();const{value:i,selectionStart:o}=t;let{selectionEnd:s}=t;if(typeof o!="number")return;typeof s!="number"&&(s=o);const r=i.slice(o,s),a=r?r.startsWith("http")?0:1:2,c=a===1?r:"title",l=a===0?r:"url",d=i.slice(0,o)+"["+c+"]("+l+")"+i.slice(s);n(d);let p=o+1,f=p+c.length;a===1&&(p=s+3,f=p+l.length),setTimeout(()=>t.setSelectionRange(p,f),0)}function WE(e,t,n){if(e.ctrlKey&&e.key==="e"){n(t.value);return}e.key!=="Shift"&&e.key!=="Control"&&e.stopImmediatePropagation()}function HE({selectionStart:e,value:t}){if(typeof e=="number"){const n=t[e-2],i=t[e-1];if(n==="@"&&i==="@"&&Ae().getState().global_keys.last_key==="@")return e}}function Cn(e){return _(Qy,{...e,component:({value:t,on_render:n,on_focus:i,on_change:o,on_blur:s,on_key_down:r})=>_(In,{fullWidth:!0,size:"small",variant:"standard",label:e.placeholder,multiline:!0,value:t,onFocus:i,onChange:o,onBlur:s,onKeyDown:r,inputRef:n,spellcheck:e.spellcheck})})}function Ge(e){const t=z(()=>({value:n,on_render:i,on_focus:o,on_change:s,on_blur:r,on_key_down:a})=>_(In,{fullWidth:!0,label:e.placeholder,variant:"outlined",value:n,onFocus:o,onChange:s,onBlur:r,onKeyDown:a,size:e.size,inputRef:i,spellcheck:e.spellcheck,disabled:e.disabled_input,title:e.title}),[e.placeholder,e.size,e.spellcheck,e.disabled_input,e.title]);return _(Qy,{...e,component:t})}function ns(e){const[t,n]=D(e.ready_to_progress??!1),{tooltip_text:i=""}=e;return _("div",{style:{display:"flex",justifyContent:"space-between",margin:"4px 0px"},children:[_(Uc,{injectFirst:!0,children:_(Wc,{theme:M1,children:_(F,{color:"secondary",disabled:e.disabled,is_hidden:!t,onClick:o=>{o.stopImmediatePropagation(),n(!1),e.on_click&&e.on_click()},startIcon:e.button_icon,children:_(He,{title:i,"aria-label":i,children:_(I,{component:"span",children:"CONFIRM"})})})})}),_(Uc,{injectFirst:!0,children:_(Wc,{theme:bh,children:_(F,{color:"primary",disabled:e.disabled,fullWidth:!t,is_hidden:!e.on_click,onClick:o=>{o.stopImmediatePropagation(),n(!t),t&&e.on_cancel&&e.on_cancel()},startIcon:t?"":e.button_icon,children:_(He,{title:t?"":i,"aria-label":t?"":i,children:_(I,{component:"span",children:t?"Cancel":e.button_text})})})})})]})}const GE="M19 5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 14h-14v-5h14z m0 -12v5h-14v-5h1v-2h12v2z m-3 -2h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function KE(e){return _(Et,{...e,d:GE})}const YE="M19 2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 7h-14v-5h14z m0 7h-1v2h-12v-2h-1v-5h14z m-3 0h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function JE(e){return _(Et,{...e,d:YE})}function XE(e){const[t,n]=D(!1);return _(Re,{children:[_(He,{title:"Add above",children:_(ue,{onClick:()=>e.update_calculations("add_above"),size:"large",children:_(KE,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),_(He,{title:"Add below",children:_(ue,{onClick:()=>e.update_calculations("add_below"),size:"large",children:_(JE,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),_(He,{title:"Move up",children:_(ue,{onClick:()=>e.update_calculations("move_up"),size:"large",disabled:e.disallowed_commands.has("move_up"),children:_(F1,{})})}),_(He,{title:"Move down",children:_(ue,{onClick:()=>e.update_calculations("move_down"),size:"large",disabled:e.disallowed_commands.has("move_down"),children:_(z1,{})})}),!t&&_(ue,{onClick:()=>n(!0),size:"large",children:_(gu,{})}),t&&_(ns,{on_click:e.delete_calculation,button_text:"",button_icon:_(gu,{}),ready_to_progress:!0,on_cancel:()=>n(!1)})]})}const ZE=e=>({editing:!e.display_options.consumption_formatting}),QE=P(ZE);function e9(e){const t=e.value!==void 0?e.value.toString():"",{allow_undefined:n,conditional_on_change:i,on_blur:o,on_blur_type:s,disabled:r,editing:a,default_value_when_invalid:c=0,editing_allowed:l}=e;let d="editable_number";if(!a||!i&&!o||r){d=d+(a?"":" not_editable ")+(r?" disabled ":"");const p=e.value!==void 0;return _("div",{className:d,style:e.style,children:[p&&_("span",{className:"description_label",children:e.placeholder})," ",p?e.value:e.placeholder]})}return _("div",{className:d,style:e.style,children:_(Ge,{placeholder:e.placeholder,size:e.size||"small",style:e.style,value:t,editing_allowed:l,select_all_on_focus:!0,conditional_on_change:p=>{if(!i)return;const f=e0(p,c);(t0(i,n)||f!==void 0)&&i(f)},on_blur:p=>{o&&t9({value:p,default_value_when_invalid:c,on_blur:o,allow_undefined:n})},on_blur_type:s||K.conditional})})}const ct=QE(e9);function e0(e,t){if(!e)return;const n=parseFloat(e);return Number.isNaN(n)?t:n}function t0(e,t){return!!t}function t9({value:e,default_value_when_invalid:t,on_blur:n,allow_undefined:i}){let o=e0(e,t);t0(n,i)||o===void 0&&(o=t),n(o)}function n9(e){const{result:t,default_significant_figures:n,temp_result_sig_figs:i,set_temp_result_sig_figs:o,result_display_type:s,update_calculation:r}=e,a=i9(t,i??n);return _("div",{style:{display:"flex"},children:[_("div",{"data-tooltip":"Significant figures","data-tooltip_left_-10":!0,"data-tooltip_bottom_-60":!0,children:_(ct,{size:"small",style:{marginLeft:5,marginTop:5,width:"80px"},placeholder:"Sig. figs",value:i,allow_undefined:!0,conditional_on_change:c=>{c=Wv(c),o(c)},on_blur_type:K.always,on_blur:c=>{c=Wv(c),o(c??n),r({result_sig_figs:c})}})}),_("div",{"data-tooltip":"Display type","data-tooltip_left_0":!0,"data-tooltip_bottom_-60":!0,style:{marginLeft:"10px",width:"120px"},children:[_("div",{className:"description_label",children:"Format"}),_(de,{selected_option_id:s,options:a,retain_options_order:!0,on_change:c=>{const l=a.find(p=>p.id===c),d=l==null?void 0:l.result_display_type;r({result_display_type:d})}})]})]})}function Wv(e){if(e!==void 0)return Math.max(Math.round(e),0)}function i9(e,t){e=e??1000.23;const n={bare:{id:"bare",order:0,result_display_type:"bare",title:W(e,t,V.bare)},simple:{id:"simple",order:1,result_display_type:"simple",title:W(e,t,V.simple)},scaled:{id:"scaled",order:2,result_display_type:"scaled",title:W(e,t,V.scaled)},percentage:{id:"percentage",order:4,result_display_type:"percentage",title:W(e,t,V.percentage)},abbreviated_scaled:{id:"abbreviated_scaled",order:3,result_display_type:"abbreviated_scaled",title:W(e,t,V.abbreviated_scaled)},scientific:{id:"scientific",order:5,result_display_type:"scientific",title:W(e,t,V.scientific)}},i={...n};return n.abbreviated_scaled.title===n.scaled.title&&delete i.abbreviated_scaled,n.scaled.title===n.simple.title&&delete i.scaled,n.simple.title===n.bare.title&&delete i.simple,Object.values(i).sort((s,r)=>s.order-r.order)}const o9=2;function n0(e){const t=parseInt(e,10);return o0(t)?4:o9}function i0(e){const t=parseInt(e,10);return o0(t)?V.bare:e.trim().match(/\d+\.?\d*\s*\%/)?V.percentage:V.simple}function o0(e){return Number.isSafeInteger(e)&&e>=1900&&e<=2200}function wn(e,t=""){const n=t.toUpperCase(),i=s9(e);if(t&&!i.has(n))return t;let o=r9(t||"A"),s=Hv(o);for(;i.has(s);)o=_9(o),s=Hv(o);return t&&(s=a9(s,t)),s}function s9(e){return new Set([...Gc,...e].map(n=>n.toUpperCase().replaceAll(/\s*/g,"")))}function r9(e){return e=e.toUpperCase(),e.split("").map(t=>t.charCodeAt(0)).filter(t=>t>=65&&t<=90)}function Hv(e){return e.map(t=>String.fromCharCode(t)).join("")}function _9(e){let t=!1;for(let n=e.length-1;n>=0;--n)if(e[n]=e[n]+1,e[n]>90)e[n]=65,t=!0;else{t=!1;break}return t&&e.push(65),e}function a9(e,t){return e.split("").map((n,i)=>{const o=t.charCodeAt(i);return o>=97&&o<=122&&(n=n.toLowerCase()),n}).join("")}function s0(e){return e.replaceAll("*","\\*")}function c9(e){const{calculation:t,calculation_result:n,editing:i,existing_calculation_name_ids:o,show_options:s,set_show_options:r}=e,a=n0(t.value),{result_sig_figs:c=a}=t,[l,d]=D(c),p=i0(t.value),{result_display_type:f=p}=t;if(!i&&!t.value&&!t.units)return null;let m=_("div",{});if(n!==void 0&&n.value!==void 0){const g=W(n.value,l??a,f),{source_wcomponent_id:k}=n;m=_("div",{children:[" = ",_(Le,{disabled:k===void 0,route:"wcomponents",sub_route:void 0,item_id:k,args:void 0,extra_class_name:"normal",children:[g,n.units&&_("span",{style:{fontSize:"14px"},children:[" ",n.units]}),t.result_description&&_("span",{style:{fontSize:"14px"},children:[" ",_(pd,{text:t.result_description})]})]})]})}const v=i||r0(t.value),h=!!t.value.match(Pk),w={display:"flex"},b=yy(n,w);return _(I,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",marginBottom:i?"18px":void 0,flexDirection:i?"column":"row",style:{display:"flex"},className:"form_section "+(s?"":"hidden_border"),children:[_(ky,{...b}),_("div",{style:{width:"100%",display:"flex"},children:[_(Ge,{size:"small",placeholder:"",hide_label:!0,value:t.name,on_blur:g=>{const k=o.filter($=>$!==t.name),y=wn(k,g);e.update_calculation({...t,name:y})},on_blur_type:K.conditional}),v&&_(Re,{children:[" = ",_(Cn,{placeholder:"Calculation",hide_label:!0,value:i?t.value:s0(t.value),on_blur:g=>e.update_calculation({...t,value:g}),on_blur_type:K.conditional})," "]}),i&&_("div",{children:[_(Ge,{placeholder:"Units",hide_label:!0,disabled_input:h,title:h?"Editing disabled: edit units of referenced component":void 0,value:(h?n==null?void 0:n.units:t.units)||"",modify_value_pre_on_blur:g=>h?(n==null?void 0:n.units)||"":g,on_blur:g=>e.update_calculation({...t,units:g||void 0}),on_blur_type:K.conditional}),!h&&(n==null?void 0:n.units)&&n.units!==t.units&&_("span",{style:{fontSize:"10px",color:"#9b8465",cursor:"pointer"},onClick:()=>{e.update_calculation({...t,units:n.units})},children:["Suggestion: ",n.units]})]}),!i&&m]}),i&&_("div",{style:{...w,marginTop:void 0},children:[m,_(ue,{onClick:()=>r(!s),size:"small",style:{marginLeft:"auto"},children:_(yh,{})})]}),e.editing&&s&&_(n9,{result:n==null?void 0:n.value,default_significant_figures:a,temp_result_sig_figs:l,set_temp_result_sig_figs:d,result_display_type:f,update_calculation:g=>{e.update_calculation({...t,...g})}}),e.editing&&s&&_("div",{style:{...w,marginLeft:10,marginTop:20},children:_("div",{style:{display:"flex"},children:_(Ge,{size:"small",placeholder:"Description",value:t.result_description||"",on_blur_type:K.conditional,on_blur:g=>{const k=g||void 0;e.update_calculation({...t,result_description:k})}})})}),e.editing&&s&&_("div",{style:{...w,justifyContent:"flex-end"},children:_(XE,{delete_calculation:()=>e.update_calculation(null),disallowed_commands:e.disallowed_commands,update_calculations:e.update_calculations})})]})}const l9=/.*[\^*/+\-()><=].*/g;function r0(e){let t="";for(;t=e.replace(Tk,"$1$3"),t!==e;)e=t;return!!t.match(l9)}const d9=x.delay("EditableCalculationRow support functions",()=>{x("should_show_calc_value",()=>{let e,t;e="(@@02d4a5f4-4abd-41a2-bb50-e68e358a3169/@@e34796cf-ab9e-47b8-9ea5-20cb00fb611d)*@@86635a8b-f4f8-4489-8a02-b4f09c0a22ec",t=r0(e),u(t,!0,"Should return true for calculation with wcomponent ids")})}),u9=x.delay("get default formatting function",()=>{const e=[{calc_value:"  81.2  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when valid number with decimal space",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when only valid number"},{calc_value:"  1899  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (1899) outside of 1900-2200",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when integer number (1899) outside of 1900-2200"},{calc_value:"  1900  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (1900) inside of 1900-2200",expected_result_display_type:V.bare,test_description__result_display_type:"Should assign simple type when integer number (1900) inside of 1900-2200"},{calc_value:"  2200  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (2200) inside of 1900-2200",expected_result_display_type:V.bare,test_description__result_display_type:"Should assign simple type when integer number (2200) inside of 1900-2200"},{calc_value:"  2201  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (2201) outside of 1900-2200",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when integer number (2201) outside of 1900-2200"},{calc_value:"  81.2 %  ",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:V.percentage,test_description__result_display_type:"Should assign percentage type when % included with valid number containing spaces and decimal"},{calc_value:"83%",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:V.percentage,test_description__result_display_type:"Should assign percentage type when % included with simple valid number without spaces or decimal"}];x("get_default_significant_figures",()=>{let t;e.forEach(n=>{t=n0(n.calc_value),u(t,n.expected_sig_figs,n.test_description__sig_figs)})}),x("get_default_result_display_type",()=>{let t;e.forEach(n=>{t=i0(n.calc_value),u(t,n.expected_result_display_type,n.test_description__result_display_type)})})}),p9=x.delay("get_valid_calculation_name_id",()=>{let e,t,n,i;t=[],e=void 0,n="A",i=wn(t,e),u(i,n,"Without any other IDs"),t=["A"],e=void 0,n="B",i=wn(t,e),u(i,n,'With an existing ID of "A"'),t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],e=void 0,n="AA",i=wn(t,e),u(i,n,'With existing IDs of "A" up to "Z"'),t=["A","B"],e="a",n="c",i=wn(t,e),u(i,n,'With existing IDs of "A" and "B", and given a  lower case "a"'),t=["food"],e="Food",n="Fooe",i=wn(t,e),u(i,n,'With an existing ID of "food" and given "Food"')}),m9=x.delay("make_calculation_safe_for_rich_text",()=>{let e,t,n;e="A * B * C",n="A \\* B \\* C",t=s0(e),u(t,n,"Should escape *")});function _l(e){const{editing_allowed:t,wcomponent_id:n,knowledge_view:i,composed_wc_id_maps_object:o,foundation_composed_wc_id_map:s}=e,r={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},a=i.wc_id_map[n],c=o.composed_wc_id_map[n],l=!!(!a||a.blocked||a.passthrough);return r.show_wcomponent_status_in_this_kv_section=!!(i.id&&l),r.show_wcomponent_status_in_this_kv_section&&(r.wcomponent_status_in_this_kv_text=(a!=null&&a.blocked?"Deleted from":"Not present in")+" this knowledge view"+(c&&!c.blocked?" but is present in a foundational knowledge view":"")),r.show_add_button=r.show_wcomponent_status_in_this_kv_section&&t,r.show_add_button&&(r.add_button_text=(a!=null&&a.blocked?"Re-add":"Add")+" to current knowledge view"),r.show_remove_button=!!(t&&a&&!a.passthrough),r.show_remove_button&&(r.remove_button_text="Remove from knowledge view",r.remove_button_tooltip="Remove from current knowledge view ("+i.title+")",a!=null&&a.blocked&&s[n]&&(r.remove_button_text="Remove block (allow to show through from foundational knowledge view)",r.remove_button_tooltip="This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view ("+i.title+")")),r.show_remove_and_block_button=!!(t&&a&&!a.blocked&&!a.passthrough&&s[n]),r.show_remove_and_block_button&&(r.remove_and_block_button_text="Remove and Block from knowledge view",r.remove_and_block_button_tooltip="Remove and Block from showing in current knowledge view ("+i.title+")"),r}function Nc(e,t,n){const i=new Date("2023-03-22 15:15:00");return{id:t,foundation_knowledge_view_ids:n?[n]:void 0,wc_id_map:e,title:"some title of "+t,description:"",sort_type:"normal",created_at:i,base_id:1,goal_ids:[]}}const f9=x.delay("get_UI_data__wcomponent_add_or_for_knowledge_view",()=>{x("simple single knowledge view with no foundation",()=>{const e=Nc({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0}},"kv1"),t={[e.id]:e},n=$t(e,t,!0),i=at(n,{}),o=$t(e,t,!1),s=at(o,{});u(i,{composed_wc_id_map:{wc2:{left:20,top:0}},composed_blocked_wc_id_map:{wc4:{left:40,top:0,blocked:!0}}},"Sanity check (no1) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),u(s,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}},"Sanity check (no2) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function c(p,f){return _l({editing_allowed:p,wcomponent_id:f,knowledge_view:e,composed_wc_id_maps_object:i,foundation_composed_wc_id_map:s.composed_wc_id_map})}let l,d;x("editing_allowed is true",()=>{l=c(!0,"wc1"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent not yet added to knowledge view"),l=c(!0,"wc2"),d={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},u(l,d,"with normal wcomponent entry in knowledge view"),l=c(!0,"wc3"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent removed from this knowledge view"),l=c(!0,"wc4"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},u(l,d,"with wcomponent blocked from this knowledge view")}),x("editing_allowed is false",()=>{l=c(!1,"wc1"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent not yet added to knowledge view"),l=c(!1,"wc2"),d={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with normal wcomponent entry in knowledge view"),l=c(!1,"wc3"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent removed from this knowledge view"),l=c(!1,"wc4"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent blocked from this knowledge view")})}),x("knowledge view with single knowledge view foundation",()=>{const e=Nc({wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222},wc9:{left:90,top:222,passthrough:!0},wc10:{left:100,top:222,passthrough:!0},wc11:{left:110,top:222,passthrough:!0},wc12:{left:120,top:222,passthrough:!0},wc13:{left:130,top:222,blocked:!0},wc14:{left:140,top:222,blocked:!0},wc15:{left:150,top:222,blocked:!0},wc16:{left:160,top:222,blocked:!0}},"kv1"),t=Nc({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0},wc6:{left:60,top:0},wc7:{left:70,top:0,passthrough:!0},wc8:{left:80,top:0,blocked:!0},wc10:{left:100,top:0},wc11:{left:110,top:0,passthrough:!0},wc12:{left:120,top:0,blocked:!0},wc14:{left:140,top:0},wc15:{left:150,top:0,passthrough:!0},wc16:{left:160,top:0,blocked:!0}},"kv2",e.id),n={[e.id]:e,[t.id]:t},i=$t(t,n,!0),o=at(i,{}),s=$t(t,n,!1),r=at(s,{});u(o,{composed_wc_id_map:{wc2:{left:20,top:0},wc5:{left:50,top:222},wc6:{left:60,top:0},wc7:{left:70,top:222},wc10:{left:100,top:0},wc14:{left:140,top:0}},composed_blocked_wc_id_map:{wc4:{blocked:!0,left:40,top:0},wc8:{blocked:!0,left:80,top:0},wc12:{blocked:!0,left:120,top:0},wc13:{blocked:!0,left:130,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:0}}},"Sanity check (no3) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),u(r,{composed_wc_id_map:{wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222}},composed_blocked_wc_id_map:{wc13:{blocked:!0,left:130,top:222},wc14:{blocked:!0,left:140,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:222}}},"Sanity check (no4) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function l(f,m){return _l({editing_allowed:f,wcomponent_id:m,knowledge_view:t,composed_wc_id_maps_object:o,foundation_composed_wc_id_map:r.composed_wc_id_map})}let d,p;x("editing_allowed is true",()=>{x("with wcomponent not yet added to foundational knowledge view",()=>{d=l(!0,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")}),x("with wcomponent added to foundational knowledge view",()=>{d=l(!0,"wc5"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc6"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!0,remove_and_block_button_text:"Remove and Block from knowledge view",remove_and_block_button_tooltip:"Remove and Block from showing in current knowledge view (some title of kv2)"},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc7"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc8"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove block (allow to show through from foundational knowledge view)",remove_button_tooltip:"This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")}),x("with wcomponent removed from foundational knowledge view",()=>{d=l(!0,"wc9"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc10"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc11"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc12"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")}),x("with wcomponent removed and blocked in foundational knowledge view",()=>{d=l(!0,"wc13"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc14"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc15"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc16"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")})}),x("editing_allowed is false",()=>{x("with wcomponent not yet added to foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")}),x("with wcomponent added to foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")}),x("with wcomponent removed from foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")}),x("with wcomponent removed and blocked in foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")})})})});async function v9(){bu.reset(),(await Rk)(),(await GT)(),await(await KT)(),(await e2)(),(await n2)(),(await o2)(),(await r2)(),(await a2)(),(await Lj)(),(await Bj)(),(await Yj)(),(await m4)(),(await RC)(),(await x4)(),(await C4)(),(await j4)(),(await E4)(),(await UT)(),(await HT)(),(await K3)(),(await J3)(),(await X3)(),(await Zx)(),(await YT)(),(await XT)(),(await ZT)(),(await QT)(),(await eP)(),(await tP)(),(await nP)(),(await iP)(),(await oP)(),(await sP)(),(await E$)(),(await H$)(),(await rP)(),(await _P)(),(await SA)(),(await $A)(),(await aP)(),(await cP)(),(await lP)(),(await dP)(),(await uP)(),(await pP)(),(await hP)(),(await gP)(),(await wP)(),(await g2)(),(await bP)(),(await yP)(),(await kP)(),(await u2)(),(await f2)(),(await CP)(),(await jP)(),(await TP)(),(await Q3)(),(await d9)(),(await u9)(),(await p9)(),(await m9)(),(await f9)(),await Uj(),await Wj(),bu.print()}function h9(){window.run_tests=v9}var al=(e=>(e.click="click",e.drag="drag",e))(al||{});const ae={help:{shortcut:["?"],outcome:"Opens this help menu"},fit_view:{shortcut:["space"],outcome:"Fit view to components / cycle between groups of components."},toggle_present_edit:{shortcut:["Ctrl","e"],outcome:"Toggle between presentation and editing modes"},toggle_side:{shortcut:["Ctrl","d","s"],outcome:"Toggle showing side panel"},toggle_time:{shortcut:["Ctrl","d","t"],outcome:"Toggle showing time sliders"},toggle_focused:{shortcut:["Ctrl","d","f"],outcome:'Toggle "focused" mode on and off'},toggle_animating:{shortcut:["Ctrl","d","a"],outcome:"Toggle animating connections"},toggle_circular_connections:{shortcut:["Ctrl","d","c"],outcome:"Toggle showing connections as (more) circular"},select_multiple:{shortcut:["Shift","click","drag"],outcome:"Select multiple nodes"},deselect_multiple:{shortcut:["Shift","Ctrl","click","drag"],outcome:"Deselect multiple nodes"},select_all:{shortcut:["Ctrl","a"],outcome:"Select all nodes on knowledge view"},expand_select_forwards:{shortcut:["Ctrl","s","f"],outcome:"Expand selection towards effects (forwards)"},expand_select_backwards:{shortcut:["Ctrl","s","c"],outcome:"Expand selection towards causes (backwards)"},expand_select:{shortcut:["Ctrl","s","e"],outcome:"Expand selection"},decrease_select:{shortcut:["Ctrl","s","d"],outcome:"Decrease selection (along non circular connections and nodes)"},select_interconnections:{shortcut:["Ctrl","s","i"],outcome:"Select components inbetween (interconnections)"},search:{shortcut:["Ctrl","f"],outcome:"Open the search menu"}},g9=[ae.help,ae.fit_view,ae.toggle_present_edit,ae.toggle_side,ae.toggle_time,ae.toggle_focused,ae.toggle_animating,ae.toggle_circular_connections,ae.select_multiple,ae.deselect_multiple,ae.select_all,ae.expand_select_forwards,ae.expand_select_backwards,ae.expand_select,ae.decrease_select,ae.select_interconnections,ae.search];function At(e){return _("div",{className:"description",style:{display:"inline"},children:Uo(e.shortcut,()=>_("span",{children:" + "}))})}function w9(e){return _(se,{component:"dt",style:{display:"inline"},children:e.shortcut.map((t,n)=>{const i=t===al.click||t===al.drag?"physical_action":"physical_button";return _("div",{style:{display:"inline"},children:[_("div",{className:i,children:t}),n<e.shortcut.length-1&&_("span",{className:"shortcut_plus",children:" + "})]})})})}function b9(e){return _(I,{component:"dl",children:[_(w9,{shortcut:e.shortcut}),_("div",{style:{display:"inline"},children:["   ",e.outcome," "]})]})}const y9=e=>({show:e.display_options.show_help_menu}),k9={set_show_help_menu:S.display.set_show_help_menu},x9=P(y9,k9);function S9(e){const[t,n]=D("kbd-shortcuts"),i=o=>(s,r)=>{n(r?o:!1)};return e.show?_(ji,{size:"medium",title:"",on_close:()=>e.set_show_help_menu({show:!1}),child:_(I,{p:10,children:[_(se,{component:"h1",variant:"h5",children:"Tips for using DataCurator"}),_(Mi,{expanded:t==="kbd-shortcuts",onChange:i("kbd-shortcuts"),children:[_(qi,{children:_(se,{component:"h2",variant:"h6",children:"Commands / shortcuts"})}),_(Vi,{children:_(I,{children:["These shortcuts only work when you are not editing a text field.  Some may only work when you are on the Map (Knowledge) canvas view.",g9.map(o=>_(b9,{...o}))]})})]}),_(Mi,{expanded:t==="linking-tips",onChange:i("linking-tips"),children:[_(qi,{children:_(se,{component:"h2",variant:"h6",children:" Tips on Linking"})}),_(Vi,{children:_(I,{children:$9.map(o=>_(se,{component:"p",paragraph:!0,children:o}))})})]}),_(Mi,{expanded:t==="general-tips",onChange:i("general-tips"),children:[_(qi,{children:_(se,{component:"h2",variant:"h6",children:"General tips"})}),_(Vi,{children:_(I,{children:C9.map(o=>_(se,{component:"p",paragraph:!0,children:o}))})})]}),_(Mi,{expanded:t==="detailed-tips",onChange:i("detailed-tips"),children:[_(qi,{children:_(se,{component:"h2",variant:"h6",children:"Detailed tips"})}),_(Vi,{children:_(I,{children:j9.map(o=>_(se,{component:"p",paragraph:!0,children:o}))})})]})]})}):null}const A9=x9(S9),$9=[`Type "@@" in any text field to access a menu to link to any other component.
    This will insert the id of that component, e.g.  @@12345678-abcd-4123-abcd-1234567890ab.`,`Follow "@@some-id" with .url, .title and .description to get the attributes
    of that component e.g. "@@12345678-abcd-4123-abcd-1234567890ab.title".  Or if it has an
    associated knowledge view then add .map to go to that knowledge view.`,_("span",{children:["Markdown is available so you can use things like ",_("b",{children:"**some text**"}),'to make it bold once it is rendered during presentation mode. Other Markdown syntax like "1. some text" will give you numbered lists. See the full ',_("a",{href:"https: //www.markdownguide.org/basic-syntax/",children:"Markdown guide here"})]})],C9=[_("div",{children:[_(se,{component:"h3",variant:"h6",children:'"Should" word usage'}),'If you find yourself writing states with "should", e.g. "People ',_("b",{children:"should"}),' listen more and be less reductionist" then you might consider separating this out into its 4 separate parts and phrasing as the positive or desired state.  Specifically:',_("ol",{children:[_("li",{children:`the attribute, e.g.: "People listen more and be less reductionist".  Note it is usually easier to express this as the desired state of the attribute instead of the pure attribute itself which is usually longer and less easy to work with: "People's ability to listen and what degree of complexity they can hold in their minds about different subjects".`}),_("li",{children:'the current value, e.g.: "False"'}),_("li",{children:"the other possibilities.  If the value is a boolean i.e. True/False then this can be skipped otherwise if it is a number or other type of value then add the other different possible values."}),_("li",{children:"the judgement or objective about the desired value, e.g.: create a judgement or objective node, target your state node, and choose the desired value via the comparator"})]})]}),_("div",{children:[_(se,{component:"h3",variant:"h6",children:'"Action" node type versus "State"'}),"The action and state node types are very similar.  The former can be used to draw attention to the areas where you or a team member can have an effect on the project.  You can use actions to represent the activity of third party actors but this usually draws unwarranted attention to these components."]})],j9=[_("div",{children:[_(se,{component:"h3",variant:"h6",children:"State subtypes"}),"There are three State subtypes:",_("ol",{children:[_("li",{children:"boolean, e.g. True / False"}),_("li",{children:"number"}),_("li",{children:"other"})]}),"Often you can represent the same attribute in different ways and this will depend on what level of detail is salient to the conversation / the model of the scenario you are interested in.",_("ol",{children:[_("li",{children:'a boolean, with title "The medical response was fast" or "The medical response time was adequate"'}),_("li",{children:'"other" with title "The medical response", with values of "Very slow", "Slow", "Medium", "Fast", "Very fast" etc.'}),_("li",{children:'"number" with title "The medical response speed", where the value perhaps represents the time in minutes until aid was first administered.'})]})]}),_("div",{children:[_(se,{component:"h3",variant:"h6",children:"Multidimensional states"}),'Often there can be attributes / concepts which have two dimensions to them which are salient together, e.g. "The medical response was fast and effective".  These can be modelled using states with titles and subtypes in many ways, for example:',_("ol",{children:[_("li",{children:'a boolean, with title "The medical response was (adequately) fast and effective"'}),_("li",{children:'"number" with title "The medical response speed and effectiveness", where the value is derived from some formula to calculate a single number based of the two attributes of speed and effectiveness.'})]}),'If the concept later needs to be analysed / comprehended / explored in greater detail it can be decomposed.  Either it could be change to a subtype of "other" with title "The medical response speed and effectiveness", with values of "fast and effective", "fast but ineffective", "slow but effective", "slow and ineffective".  Or replaced by two new seperate states, one for "Medical response speed" and one for "Medical response effectiveness".  In the latter case deleting the first node from the knowledge views would be best.  In the former case, ',_("a",{href:"https: //github.com/centerofci/data-curator2/issues/36",children:"versioning the whole component"})," would make this easier from a user's perspective."]}),_("div",{children:[_(se,{component:"h3",variant:"h6",children:"Temporal uncertainty"}),_("p",{children:'Part of making predictions is knowing when some event may occur.  For this we have a very simple "Temporal Uncertainty" form that has three fields: Min, Expected and Max datetime.'}),_("p",{children:"It's important to note that this represents a single event and not a distribution of similar events.  It is also not directly the uncertain temporal range a state might exist over.  i.e. the min is the earliest when the event can occur.  This is easier to understand if you talk about the max value.  The max is the latest the event can occur.  This means the state (associate with state transition events) will occur from the max of an event marking its existence but might occur earlier: up to an including the min datetime of the event."}),_("p",{children:"A concrete example: you will switch on the light in 1 minute (min), likely in 5 minutes (expected) or at most in 10 minutes (max).  But this does not mean the room will be lit from 1 minutes time to 10 minutes time."}),_("p",{children:"The current form is also woefully simplistic for a lot of the uncertain temporal distributions you have inside your head, use almost all the time, use seamlessly, unconsciously, and yet are vital to coordinated effective collaboration, for (complex) interventions."}),_("p",{children:"For example: when are you going to get funding for project X, when will have a hire for position Y, when will your change job, when will you next go shopping (if it's not raining AND someone else not gone yet AND time after 7 am AND time less 10 am then ...)."})]})];var kd={},T9=Q;Object.defineProperty(kd,"__esModule",{value:!0});var xd=kd.default=void 0,P9=T9(Z()),N9=ee(),E9=(0,P9.default)((0,N9.jsx)("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"}),"Menu");xd=kd.default=E9;const I9=e=>({apply_filter:e.filter_context.apply_filter}),D9={set_apply_filter:S.filter_context.set_apply_filter},R9=P(I9,D9);function O9(e){return _("div",{children:["Filter",_("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:e.apply_filter,onClick:t=>{t.stopPropagation(),t.preventDefault()},onPointerDown:t=>{t.stopPropagation(),t.preventDefault(),e.set_apply_filter(!e.apply_filter)}})]})}const M9=R9(O9);function Wt(e){return e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase()}function _0(e){return e==="wcomponents"?"Components":e==="display"?"Display Options":e==="select"?"Selection":Wt(e.replaceAll("_"," "))}function q9(e){return e==="filter"?_(M9,{}):_0(e)}const V9=e=>({current_route:e.routing.route}),F9={change_route:S.routing.change_route},z9=P(V9,F9);function L9(e){const t=()=>{e.on_pointer_down(),e.change_route({route:e.id,sub_route:null,item_id:null})},n=()=>(e.on_pointer_down(),!1),i=q9(e.id);return _(a0,{on_pointer_down:t,children:_(Le,{route:e.id,sub_route:null,item_id:null,args:void 0,on_pointer_down:n,children:i})})}const B9=z9(L9);function a0(e){return _(rs,{style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},onPointerDown:t=>{t.stopImmediatePropagation(),e.on_pointer_down()},children:e.children})}const U9=e=>({route:e.routing.route,editing:!e.display_options.consumption_formatting}),W9={set_show_help_menu:S.display.set_show_help_menu,change_route:S.routing.change_route},H9=P(U9,W9),G9=new Set(["objects","patterns","statements"]),K9=sb.filter(e=>!G9.has(e));function Y9(e){const[t,n]=D(null),i=()=>{n(null)},[o,s]=D(!1);let r=K9;if(!o){const a=new Set(["about"]);r=r.filter(c=>!a.has(c))}return _("div",{children:[_("div",{style:{display:"flex",flexDirection:"row"},children:[_(Se,{style:{display:"flex",flex:1},children:_("b",{style:{width:"100%",display:"flex"},onClick:()=>{e.change_route({route:e.route,item_id:null,sub_route:null})},children:_0(e.route)})}),_(Se,{"aria-controls":"select_tab","aria-haspopup":"true",style:{display:"flex",flex:1,justifyContent:"end"},onClick:a=>n(a.currentTarget),children:_(xd,{})})]}),_(L1,{anchorEl:t,id:"select_tab",onClose:i,open:!!t,keepMounted:!0,children:[r.map(a=>_(B9,{id:a,on_pointer_down:i})),_(a0,{on_pointer_down:()=>{i(),e.set_show_help_menu({show:!0})},children:"Help"}),_(rs,{onClick:()=>s(!o),style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},children:[o?"Hide extra":"Show all"," options"]})]})]})}const J9=H9(Y9);var Sd={},X9=Q;Object.defineProperty(Sd,"__esModule",{value:!0});var c0=Sd.default=void 0,Z9=X9(Z()),Gv=ee(),Q9=(0,Z9.default)([(0,Gv.jsx)("path",{d:"M15.5 5H11l5 7-5 7h4.5l5-7z"},"0"),(0,Gv.jsx)("path",{d:"M8.5 5H4l5 7-5 7h4.5l5-7z"},"1")],"DoubleArrow");c0=Sd.default=Q9;var Ad={},eI=Q;Object.defineProperty(Ad,"__esModule",{value:!0});var l0=Ad.default=void 0,tI=eI(Z()),nI=ee(),iI=(0,tI.default)((0,nI.jsx)("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"}),"Tune");l0=Ad.default=iI;function oI(e){let t;const n=_e(e);if(n){const{composed_visible_wc_id_map:i,wc_ids_by_type:o}=n,{x:s,y:r,zoom:a}=e.routing.args,c=Fe/a,l=s+Fl(e.controls.display_side_panel)*c,d=r-vs*c,p=hs(e),f=d-zl(p)*c;t=!!Array.from(o.any_node).find(m=>{const v=i[m];if(!v)return!1;const{left:h,top:w}=v;return h>=s&&h<=l&&-w<=d&&-w>=f})}return t}var $d={},sI=Q;Object.defineProperty($d,"__esModule",{value:!0});var d0=$d.default=void 0,rI=sI(Z()),_I=ee(),aI=(0,rI.default)((0,_I.jsx)("path",{d:"M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"}),"FilterCenterFocus");d0=$d.default=aI;function cI(e){const{move:t,draw_attention:n,have_finished_drawing_attention:i=()=>{}}=e;return re(()=>{if(e.enable_spacebar_move_to_shortcut)return G.global_keys.sub("key_down",o=>{t&&o.key===" "&&t()})},[e.enable_spacebar_move_to_shortcut,t]),_(I,{children:[_(He,{placement:"top",title:t?"Move to component(s)":"No component(s) present",children:_("span",{children:_(ue,{size:"medium",onClick:t,disabled:!t,children:_(d0,{})})})}),_("div",{className:t&&n?"pulsating_circle":"",ref:o=>setTimeout(()=>{o==null||o.classList.remove("pulsating_circle"),i()},1e4)})]})}const lI=(e,t)=>{const n=t.wcomponent_id||e.routing.item_id||"";let i;return t.allow_drawing_attention&&(i=oI(e)),{initial_wcomponent_id:n,created_at_ms:e.routing.args.created_at_ms,components_on_screen:i,current_composed_knowledge_view:_e(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,selected_wcomponent_ids_set:e.meta_wcomponents.selected_wcomponent_ids_set,display_side_panel:e.controls.display_side_panel,display_time_sliders:hs(e)}},dI={move:(e,t)=>S.routing.change_route({args:{created_at_ms:e,...t}})},uI=P(lI,dI);function pI(e){const{components_on_screen:t,have_finished_drawing_attention:n,current_composed_knowledge_view:i,wcomponents_by_id:o,initial_wcomponent_id:s,selected_wcomponent_ids_set:r,created_at_ms:a,disable_if_not_present:c,display_side_panel:l,display_time_sliders:d}=e,{positions_no_sidepanel_or_timesliders:p,positions_sidepanel_no_timesliders:f,positions_timesliders_no_sidepanel:m,positions_with_sidepanel_or_timesliders:v,go_to_datetime_ms:h}=z(()=>rj({current_composed_knowledge_view:i,wcomponents_by_id:o,initial_wcomponent_id:s,selected_wcomponent_ids_set:r,created_at_ms:a,disable_if_not_present:c}),[i,o,s,r,a,c]),w=l||d?l&&d?v:l?f:m:p;let b=0;const g=w.length===0?void 0:()=>{let y=w[b++];y||(b=0,y=w[b++]),e.move(h,y)},k=e.allow_drawing_attention&&w.length>0&&!t;return _(cI,{move:g,draw_attention:k,have_finished_drawing_attention:n,enable_spacebar_move_to_shortcut:!e.wcomponent_id})}const u0=uI(pI);var Cd={},mI=Q;Object.defineProperty(Cd,"__esModule",{value:!0});var p0=Cd.default=void 0,fI=mI(Z()),vI=ee(),hI=(0,fI.default)((0,vI.jsx)("path",{d:"m15.96 10.29-2.75 3.54-1.96-2.36L8.5 15h11l-3.54-4.71zM3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"Filter");p0=Cd.default=hI;const jd=Pt(e=>({warning_button:{cursor:"help"},warning_icon:{color:e.palette.warning.main}})),gI=e=>{var i;const{wc_ids_excluded_by_created_at_datetime_filter:t,vap_set_number_excluded_by_created_at_datetime_filter:n=0}=((i=_e(e))==null?void 0:i.filters)||{};return{components:(t==null?void 0:t.size)||0,vap_sets:n}},wI={set_display_time_sliders:S.controls.set_display_time_sliders},bI=P(gI,wI);function yI(e){const{components:t,vap_sets:n}=e;if(t+n===0)return null;const i=jd();let o=t?`${t} components are invisible `:"";return t&&n&&(o+="and "),o+=n?`${n} predictions are invisible `:"",o+="due to created at datetime filter",_(He,{placement:"top",title:o,children:_(ue,{className:i.warning_button,component:"span",onClick:()=>e.set_display_time_sliders(!0),size:"small",children:_(p0,{className:i.warning_icon})})})}const Td=bI(yI);var Pd={},kI=Q;Object.defineProperty(Pd,"__esModule",{value:!0});var m0=Pd.default=void 0,xI=kI(Z()),SI=ee(),AI=(0,xI.default)((0,SI.jsx)("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore");m0=Pd.default=AI;var Nd={},$I=Q;Object.defineProperty(Nd,"__esModule",{value:!0});var f0=Nd.default=void 0,CI=$I(Z()),jI=ee(),TI=(0,CI.default)((0,jI.jsx)("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext");f0=Nd.default=TI;function PI(e){return _(F,{title:e.title,value:"Now",onClick:()=>{const t=new Date().getTime()+6e4;e.change_datetime_ms(t)}})}const NI=(e,{get_handle_ms:t})=>({handle_datetime_ms:t(e),time_resolution:e.display_options.time_resolution}),EI=P(NI);function II(e){const t=e.events.map(a=>{let c=a.datetime.getTime();return c=c2(c,e.time_resolution),c}),n=t[0],i=t[t.length-1],o=vn(t,a=>a,e.handle_datetime_ms);function s(a){typeof a=="number"&&e.change_handle_ms(a)}function r(a){return()=>{let c=o.index+a;o.exact||(a===1?c=Math.ceil(o.index):c=Math.floor(o.index));let l=t[c];for(;l===e.handle_datetime_ms;)c+=a,l=t[c];l&&e.change_handle_ms(l)}}return _(I,{className:"time_slider",my:2,px:5,children:[_(I,{className:"slider_container",display:"flex",children:[_(Dn,{size:"small",children:[_(ue,{onClick:r(-1),disabled:o.bounds==="n/a"||o.index<=0,title:"Previous "+e.title+" datetime",size:"large",children:_(m0,{})}),_(ue,{onClick:r(1),disabled:o.bounds==="n/a"||o.index>=t.length-1,title:"Next "+e.title+" datetime",size:"large",children:_(f0,{})})]}),_(I,{flexGrow:1,title:e.title+" datetimes",children:_(kh,{onChange:(a,c)=>s(c),color:"secondary",value:e.handle_datetime_ms,getAriaValueText:DI,valueLabelFormat:RI,step:1,min:n,max:i,valueLabelDisplay:"auto",marks:t.map(a=>({value:a,label:""}))})})]}),_(I,{display:"flex",justifyContent:"flex-end",alignItems:"center",children:[_(Ct,{title:e.title,value:new Date(e.handle_datetime_ms),on_change:a=>a&&e.change_handle_ms(a.getTime()),show_now_shortcut_button:!1,show_today_shortcut_button:!1,editing_allowed:!0}),_(PI,{title:"Set "+e.title+" to now",change_datetime_ms:a=>e.change_handle_ms(a)})]})]})}const Kv=EI(II),DI=e=>`${e}`,RI=e=>{const t=_s({date:new Date(e),time_resolution:"minute"});return _("span",{style:{whiteSpace:"nowrap"},children:t})},Ed=Pt(e=>({inverse_disabled:{color:e.palette.text.disabled,"&.Mui-disabled":{color:e.palette.text.primary,pointerEvents:"auto"}}}));var Id={},OI=Q;Object.defineProperty(Id,"__esModule",{value:!0});var v0=Id.default=void 0,MI=OI(Z()),qI=ee(),VI=(0,MI.default)((0,qI.jsx)("path",{d:"M3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"FilterNone");v0=Id.default=VI;const FI=e=>({apply_filter:e.filter_context.apply_filter}),zI={change_route:S.routing.change_route},LI=P(FI,zI);function BI(e){const{apply_filter:t}=e,n=jd();return t?_(He,{placement:"top",title:"A filter is in place which could result in components being hidden",children:_(ue,{className:n.warning_button,component:"span",size:"small",onClick:()=>e.change_route({route:"filter"}),children:_(v0,{className:n.warning_icon})})}):null}const h0=LI(BI);var Dd={},UI=Q;Object.defineProperty(Dd,"__esModule",{value:!0});var g0=Dd.default=void 0,WI=UI(Z()),HI=ee(),GI=(0,WI.default)((0,HI.jsx)("path",{d:"M11 4.07V2.05c-2.01.2-3.84 1-5.32 2.21L7.1 5.69c1.11-.86 2.44-1.44 3.9-1.62zm7.32.19C16.84 3.05 15.01 2.25 13 2.05v2.02c1.46.18 2.79.76 3.9 1.62l1.42-1.43zM19.93 11h2.02c-.2-2.01-1-3.84-2.21-5.32L18.31 7.1c.86 1.11 1.44 2.44 1.62 3.9zM5.69 7.1 4.26 5.68C3.05 7.16 2.25 8.99 2.05 11h2.02c.18-1.46.76-2.79 1.62-3.9zM4.07 13H2.05c.2 2.01 1 3.84 2.21 5.32l1.43-1.43c-.86-1.1-1.44-2.43-1.62-3.89zM15 12c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3zm3.31 4.9 1.43 1.43c1.21-1.48 2.01-3.32 2.21-5.32h-2.02c-.18 1.45-.76 2.78-1.62 3.89zM13 19.93v2.02c2.01-.2 3.84-1 5.32-2.21l-1.43-1.43c-1.1.86-2.43 1.44-3.89 1.62zm-7.32-.19C7.16 20.95 9 21.75 11 21.95v-2.02c-1.46-.18-2.79-.76-3.9-1.62l-1.42 1.43z"}),"FilterTiltShift");g0=Dd.default=GI;const KI=e=>({focused_mode:e.display_options.focused_mode}),YI={set_or_toggle_focused_mode:S.display.set_or_toggle_focused_mode},JI=P(KI,YI);function XI(e){const{focused_mode:t}=e,n=t?"WARNING: Focused Mode is active, unselected components will be almost invisible":"Activate focused mode",i=t?jd():QI();return _(He,{placement:"top",title:n,children:_("span",{children:_(ue,{component:"span",size:"medium",onClick:()=>e.set_or_toggle_focused_mode(),children:_(g0,{className:i.warning_icon})})})})}const ZI=JI(XI),QI=Pt(e=>({warning_icon:{color:e.palette.primary.main}}));const eD=e=>{const t=_e(e),n=(t&&t.composed_datetime_line_config.time_origin_ms)!==void 0,i=Be(e);return{display_time_marks:e.display_options.display_time_marks,sim_ms:e.routing.args.sim_ms,time_origin_ms_present:n,current_kv:i,presenting:e.display_options.consumption_formatting}},tD={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view,set_display_time_marks:S.display.set_display_time_marks},nD=P(eD,tD);function iD(e){const{display_time_marks:t,time_origin_ms_present:n,current_kv:i,presenting:o}=e;return o&&!n?null:_(I,{component:"label",children:_(Dn,{disableElevation:!0,variant:"contained",children:_(Se,{onClick:()=>{const s=!t;if(s&&!n&&i){const r=Ae(),a=ki(r.getState()).left,c={...i,datetime_line_config:{...i.datetime_line_config,time_origin_ms:e.sim_ms,time_origin_x:a}};e.upsert_knowledge_view({knowledge_view:c})}e.set_display_time_marks(s)},"aria-label":"Toggle displaying time markers",children:[t?"Hide":"Show"+(n?"":" (Set)")," time"]})})})}const oD=nD(iD),sD=e=>({linked_datetime_sliders:e.controls.linked_datetime_sliders,display_by_simulated_time:e.display_options.display_by_simulated_time,display_time_sliders:e.controls.display_time_sliders,actually_display_time_sliders:hs(e),editing:!e.display_options.consumption_formatting,animate_connections:e.display_options.animate_connections,created_at_ms:e.routing.args.created_at_ms}),rD={change_display_at_created_datetime:S.display_at_created_datetime.change_display_at_created_datetime,change_display_at_sim_datetime:S.display_at_sim_datetime.change_display_at_sim_datetime,toggle_linked_datetime_sliders:S.controls.toggle_linked_datetime_sliders,set_display_time_sliders:S.controls.set_display_time_sliders,set_display_by_simulated_time:S.display.set_display_by_simulated_time,set_or_toggle_animate_connections:S.display.set_or_toggle_animate_connections},_D=P(sD,rD);function aD(e){const[t,n]=D(!0);Ed();const{created_events:i,sim_events:o}=e,s=lD();return _(I,{p:2,mb:2,borderTop:1,borderColor:"primary.main",position:"relative",children:[_(B1,{in:e.actually_display_time_sliders,children:_(I,{className:s.drawer_content,children:_(I,{flexGrow:1,children:e.actually_display_time_sliders&&_(Re,{children:[_(Kv,{events:i,get_handle_ms:r=>r.routing.args.created_at_ms,change_handle_ms:r=>e.change_display_at_created_datetime({ms:r}),data_set_name:"content_controls_created_at_datetimes",title:"Created at"}),_(Kv,{events:o,get_handle_ms:r=>r.routing.args.sim_ms,change_handle_ms:r=>e.change_display_at_sim_datetime({ms:r}),data_set_name:"content_controls_sim_datetimes",title:"Simulation"})]})})})}),_(xh,{className:s.toolbar,variant:"dense",children:[_(I,{className:s.move_to_button_and_warnings,children:[_(u0,{allow_drawing_attention:t,have_finished_drawing_attention:()=>n(!1),disable_if_not_present:!1}),_(ZI,{}),_(Td,{}),_(h0,{})]}),_(oD,{}),_("div",{children:[_(He,{placement:"top",title:e.animate_connections?"Stop animating connections":"Animate connections",children:_(ue,{component:"span",size:"medium",onClick:()=>e.set_or_toggle_animate_connections(),children:_(c0,{style:{color:e.animate_connections?"rgb(25, 118, 210)":""}})})}),_(He,{placement:"top",title:e.display_time_sliders?"Hide time sliders":"Show time sliders",children:_(ue,{component:"span",size:"medium",onClick:()=>e.set_display_time_sliders(!e.display_time_sliders),children:_(l0,{})})})]})]})]})}const cD=_D(aD),lD=Pt(e=>({toolbar:{justifyContent:"space-between"},move_to_button_and_warnings:{display:"flex",flexDirection:"row"},drawer_content:{display:"flex",flexDirection:"row",alignItems:"center",alignContent:"center"},warning_icon:{color:e.palette.warning.main}}));function dD(e){const t=[],n=new Set,i=[],o=new Set;let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;function a(f,m){if(!f)return;const v=f.getTime();m!=="sim"&&!n.has(v)&&t.push({datetime:f,type:m}),m!=="created"&&!o.has(v)&&i.push({datetime:f,type:m}),s=Math.min(s,f.getTime()),r=Math.max(r,f.getTime())}function c(f){a(f.min,"sim"),a(f.value,"sim"),a(f.max,"sim")}e.forEach(f=>{a(f.custom_created_at||f.created_at,"created"),wi(f)&&f.validity.forEach(({created_at:m,custom_created_at:v,datetime:h})=>{a(v||m,"created"),c(h)}),On(f)&&f.values_and_prediction_sets.forEach(({created_at:m,custom_created_at:v,datetime:h})=>{a(v||m,"created"),c(h)}),hl(f)&&f.event_at.forEach(({datetime:m})=>{c(m)})});const l=new Date;t.length===0&&a(l,"created");const d=s,p=r;return["created","sim"].forEach(f=>{a(new Date(d),f),a(new Date(p),f),a(new Date(d-864e5),f),a(new Date(p+864e5),f)}),t.sort(Yv),i.sort(Yv),{created_events:t,sim_events:i}}function Yv({datetime:e},{datetime:t}){return e.getTime()<t.getTime()?-1:1}const uD=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,current_composed_knowledge_view:_e(e)}),pD=P(uD);function mD(e){const{wcomponents_by_id:t,current_composed_knowledge_view:n}=e;if(!n)return _("div",{});const{composed_wc_id_map:i}=n,{created_events:o,sim_events:s}=z(()=>{const r=Object.keys(i).map(a=>t[a]).filter(me);return dD(r)},[i,t]);return _(cD,{created_events:o,sim_events:s})}const fD=pD(mD),vD=e=>({view:e.routing.args.view}),hD=P(vD);function gD(e){const{view:t}=e;return _("div",{className:"main_content_controls",children:t==="knowledge"&&_(fD,{})})}const wD=hD(gD);function Rd(e){return _(I,{id:"main_area",display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,zIndex:1,children:[_(I,{id:"main_content",flexGrow:1,flexShrink:1,display:"flex",flexDirection:"column",position:"relative",zIndex:1,children:e.main_content}),_(I,{id:"main_content_controls",bgcolor:"#fafafa",flexGrow:0,flexShrink:1,position:"relative",zIndex:10,children:_(wD,{})}),e.extra_content]})}var Od={},bD=Q;Object.defineProperty(Od,"__esModule",{value:!0});var w0=Od.default=void 0,yD=bD(Z()),kD=ee(),xD=(0,yD.default)((0,kD.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),"Add");w0=Od.default=xD;function SD(e,t,n,i=Sn){const o={left:0,top:0};if(!e||!t)return o;const s=e[t];if(!s)return o;const r=Zw(e,n);let a=s;const c={left:s.left,top:s.top};for(;a;){c.top+=i;const l=Xw(c),p=(r[l]||[])[0];a=p?e[p]:void 0}return c}function b0(e,t){let n=yl(e);return e&&(e={...e}),t.forEach(i=>{i.entries.forEach(o=>{var r;if(!o.value_id)return;e=e||{};const s=((r=e[o.value_id])==null?void 0:r.order)??++n;e[o.value_id]={id:o.value_id,value:o.value,description:o.description,order:s}})}),e}function y0(e,t){return e.entries.map(n=>{const i=n.value_id===t?1:0;return{...n,relative_probability:i,probability:i,conviction:1}})}function cl(e){const{existing_value_possibilities:t,orig_values_and_prediction_sets:n,base_id:i,action_value_possibility_id:o}=e,s=Ie(E.action,t,n,i),r=y0(s,o);return s.entries=r,[...n,s]}function k0(e){const t=b0(e.existing_value_possibilities,e.new_values_and_prediction_sets);e.update_VAPSets_and_value_possibilities({value_possibilities:t,values_and_prediction_sets:e.new_values_and_prediction_sets});const n=Jv(e.orig_values_and_prediction_sets,e.current_created_at_ms),i=Jv(e.new_values_and_prediction_sets,e.current_created_at_ms),o=1*60*1e3,s=10*o;let r;i.latest_created_at_ms>n.latest_created_at_ms&&(r=i.latest_created_at_ms+o);const a=new Date().getTime(),c=i.latest_sim_ms<a+o&&i.latest_sim_ms>a-s;let l;e.sim_ms<i.latest_sim_ms&&c&&(l=i.latest_sim_ms),(r!==void 0||l!==void 0)&&e.change_route({args:{sim_ms:l,created_at_ms:r}})}function Jv(e,t=0){let n=Number.NEGATIVE_INFINITY;return e.forEach(i=>{t=Math.max(ze(i),t);const o=Mn(i.datetime);o&&(n=Math.max(o.getTime(),n))}),{latest_created_at_ms:t,latest_sim_ms:n}}const AD=e=>({composed_knowledge_view:_e(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,base_id:pt(e)}),$D=P(AD);function CD(e){const{most_recent_action_id:t,composed_knowledge_view:n,wcomponents_by_id:i,base_id:o,list_type:s}=e;if(!n)return null;const{id:r,composed_wc_id_map:a}=n,c=z(()=>jD({base_id:o,composed_wc_id_map:a,most_recent_action_id:t,wcomponents_by_id:i,list_type:s,knowledge_view_id:r}),[o,a,t,i,s,r]);return _(F,{className:"add_new_action_button",fullWidth:!1,onClick:c,disabled:o===void 0,title:o===void 0?"No knowledge base selected":"",children:_(w0,{})})}const Oo=$D(CD);function jD(e){const{base_id:t,composed_wc_id_map:n,most_recent_action_id:i,wcomponents_by_id:o,list_type:s,knowledge_view_id:r}=e;return function(){if(t===void 0)throw new Error("No base_id defined in click for AddNewActionButton");const c=SD(n,i,o);let l=[];const d=s==="todo",p=s==="in_progress",f=s==="done";if((p||f)&&(l=cl({existing_value_possibilities:void 0,orig_values_and_prediction_sets:[],base_id:t,action_value_possibility_id:$e.action_in_progress}),f)){let v=new Date;const h=3600*1e3;v=new Date(v.getTime()-h),l[0].datetime.value=v}f&&(l=cl({existing_value_possibilities:void 0,orig_values_and_prediction_sets:l,base_id:t,action_value_possibility_id:$e.action_completed}));const m=b0(void 0,l);xi({wcomponent:{base_id:t,type:"action",values_and_prediction_sets:l,value_possibilities:m,todo_index:d?new Date().getTime():void 0},add_to_knowledge_view:{id:r,position:c}})}}var Md={},TD=Q;Object.defineProperty(Md,"__esModule",{value:!0});var x0=Md.default=void 0,PD=TD(Z()),ND=ee(),ED=(0,PD.default)((0,ND.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack");x0=Md.default=ED;var qd={},ID=Q;Object.defineProperty(qd,"__esModule",{value:!0});var S0=qd.default=void 0,DD=ID(Z()),RD=ee(),OD=(0,DD.default)((0,RD.jsx)("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward");S0=qd.default=OD;var Vd={},MD=Q;Object.defineProperty(Vd,"__esModule",{value:!0});var Rs=Vd.default=void 0,qD=MD(Z()),VD=ee(),FD=(0,qD.default)((0,VD.jsx)("path",{d:"m4 12 1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"}),"ArrowUpward");Rs=Vd.default=FD;var Fd={},zD=Q;Object.defineProperty(Fd,"__esModule",{value:!0});var A0=Fd.default=void 0,LD=zD(Z()),BD=ee(),UD=(0,LD.default)((0,BD.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"}),"Description");A0=Fd.default=UD;function WD(e){const{position:t,extra_styles:n,display:i,extra_css_class:o,title:s,children:r}=e,{on_pointer_enter:a,on_pointer_leave:c,on_pointer_down:l,on_pointer_up:d,on_click:p}=e,f={...t,position:t?"absolute":"relative",display:i===void 0||i?"":"none",...n},v=`node ${l||d||p||a||c?"mouseable":""} ${o||""}`;return _("div",{...e.extra_args,className:v,style:f,title:s,onPointerDown:l||(h=>{h.stopImmediatePropagation(),h.preventDefault()}),onPointerUp:d,onClick:p,onPointerEnter:a,onPointerLeave:c,onContextMenu:h=>{h.preventDefault()},children:r})}function HD(e){let{opacity:t}=e;const n={display:e.hidden?"none":"",opacity:t};e.unlimited_width&&(n.maxWidth="initial");const i={boxShadow:e.glow?`${e.glow} 0px 0px 10px`:"",backgroundColor:e.color,...e.extra_styles_for_node_main_content},{pointerupdown_on_connection_terminal:o=()=>{}}=e,s=" connectable_canvas_node "+(e.extra_css_class||"");return _(WD,{position:e.position,on_pointer_down:e.on_pointer_down,on_pointer_up:e.on_pointer_up,on_click:e.on_click,on_pointer_enter:e.on_pointer_enter,on_pointer_leave:e.on_pointer_leave,extra_css_class:s,extra_styles:n,extra_args:e.extra_args,children:[_(U1,{className:"node_main_content",variant:"outlined",style:i,children:[e.cover_image&&_(W1,{component:"img",image:e.cover_image,className:"node_image_content",onContextMenu:r=>{r.stopImmediatePropagation()}}),_(H1,{style:{padding:16},children:e.node_main_content}),e.terminals.map(({type:r,style:a,label:c})=>_("div",{className:"connection_terminal",style:{...GD,...a},onPointerDown:l=>{l.stopPropagation(),o(r,"down")},onPointerUp:l=>{l.stopPropagation(),o(r,"up")},children:c}))]}),e.other_children]})}const Xv=Jo*2,GD={width:Xv,height:Xv,borderRadius:Jo+1},KD={white:{r:255,g:255,b:255,a:1},white_a75:{r:255,g:255,b:255,a:.75}};function Tt(e){return e?`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`:""}function $0(e){if(!e)return{r:0,g:0,b:0,a:1};const n=e.r+e.g+e.b<383?255:0;return{r:n,g:n,b:n,a:1}}function YD(e){if(e)return{r:e.r/2,g:e.g/2,b:e.b/2,a:e.a}}function JD(e,{wcomponent_id:t}){const{wcomponents_by_id:n,knowledge_views_by_id:i}=e.specialised_objects;return{wcomponent:n[t],wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:rt(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}}const XD=P(JD);function ZD(e){const{wcomponent:t}=e,n=t?mt({wcomponent:t,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}):"&lt;Label not found&gt;";return _("div",{className:"label_v2",style:{backgroundColor:Tt((t==null?void 0:t.label_color)||KD.white_a75),color:Tt($0(t==null?void 0:t.label_color))},children:_(vo,{options:md,children:n})})}const QD=XD(ZD);function eR(e){return _("div",{style:{display:"flex",flexWrap:"wrap"},children:(e.label_ids||[]).map(t=>_(QD,{wcomponent_id:t}))})}function _n(e){const t="⚠";return _("span",{style:{backgroundColor:e.backgroundColor||"yellow",color:"black"},title:e.message,children:t})}function tR(e,t){const n=Ae(),i=n.getState(),{selected_wcomponent_ids_set:o}=i.meta_wcomponents;let s=new Set(o);if(!s.has(e)){s=new Set([e]);const d=S.meta_wcomponents.clicked_wcomponent({id:e});n.dispatch(d)}const r=S.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:s});n.dispatch(r);let a;const c=G.canvas.sub("canvas_move",d=>{a=ms({left:d.x-t.x,top:t.y-d.y}),G.canvas.pub("canvas_node_drag_relative_position",a)}),l=G.canvas.sub("canvas_pointer_up",()=>{if(a){const p=S.specialised_object.bulk_edit_knowledge_view_entries({wcomponent_ids:Array.from(s),change_left:a.left,change_top:a.top});n.dispatch(p)}const d=S.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:new Set});n.dispatch(d),c(),l()})}function no(e){return e==="counterfactualv2"?"counterfactual":e==="statev2"?"state":e.replaceAll("_"," ")}function C0(e){const{wcomponent_id:t,shift_or_control_keys_are_down:n,change_route:i,clicked_wcomponent:o,clear_selected_wcomponents:s,is_current_item:r}=e;return a=>{a.stopImmediatePropagation(),a.preventDefault(),o({id:t}),n?i({route:"wcomponents",sub_route:"wcomponents_edit_multiple",item_id:null}):r?(i({route:"wcomponents",sub_route:null,item_id:null}),s()):i({route:"wcomponents",sub_route:null,item_id:t})}}function zd(e,t){return t*(Fe/e)}function j0(e,t,n){return e+zd(t,n)}function T0(e,t,n){return e-zd(t,n)}var Ld={},nR=Q;Object.defineProperty(Ld,"__esModule",{value:!0});var P0=Ld.default=void 0,iR=nR(Z()),oR=ee(),sR=(0,iR.default)((0,oR.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"}),"Search");P0=Ld.default=sR;const rR="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z";function _R(e){return _(Et,{...e,d:rR,svg_elements:[_("line",{x1:"0",x2:"13",y1:"18",y2:"18",stroke:"white","stroke-width":"6"}),_("line",{x1:"6.5",x2:"6.5",y1:"11.5",y2:"24",stroke:"white","stroke-width":"6"}),_("line",{x1:"1.5",x2:"11.5",y1:"18",y2:"18","stroke-width":"3"}),_("line",{x1:"6.5",x2:"6.5",y1:"13",y2:"23","stroke-width":"3"})]})}const aR=(e,t)=>{const n=pe(e,t.wcomponent_id),o=(zy(e,t.wcomponent_id)||[]).find(s=>e.specialised_objects.knowledge_views_by_id[s]);return{wcomponent:n,kvwc:e.specialised_objects.knowledge_views_by_id[t.wcomponent_id],subview_id:e.routing.args.subview_id,nested_knowledge_view_ids_entry:e.derived.nested_knowledge_view_ids.map[t.wcomponent_id],presenting:e.display_options.consumption_formatting,any_overlapping_wcomponents_have_kvs:o}},cR=P(aR);function lR(e){let{kvwc:t}=e;const{is_highlighted:n,nested_knowledge_view_ids_entry:i,any_overlapping_wcomponents_have_kvs:o}=e,s=!e.presenting,r=!t&&(e.presenting||s&&!n&&!o),a=e.subview_id===e.wcomponent_id,c=i&&i.parent_id,l=s&&!!e.wcomponent,d=a?c?2:-1:t?1:l?3:-2,p=a&&!c,f="node_handle explore "+(r?" hidden ":"")+(t?" has_knowledge_view ":"")+(p?" current_but_no_parent ":"")+(d===3?" will_create_on_click ":"")+(d===-2?" error_disabled ":"");return _("div",{className:f,title:d===2?"Navigate up to parent":d===-1?"No parent to navigate up to":d===1?"Navigate to knowledge view":d===3?"Create then navigate to knowledge view":d===-2?"Error: could not find the component to create a new knowledge view for":"Unknown error",onClick:v=>{v.preventDefault(),v.stopImmediatePropagation();const h=Ae();if(a)c&&$u(c,h);else{if(!t){const w=dR(e,h);if(!w)return;t=w,h.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:t}))}$u(t.id,h)}},children:a?_(Rs,{}):d===3?_(_R,{}):_(P0,{})})}const Bd=cR(lR);function dR(e,t){if(!e.wcomponent)return!1;const n=t.getState(),i=ki(n),o={[e.wcomponent.id]:e.wcomponent_current_kv_entry||i},s=mt({wcomponent:e.wcomponent,wc_id_to_counterfactuals_map:rt(n),text_type:fe.plain,wcomponents_by_id:n.specialised_objects.wcomponents_by_id,knowledge_views_by_id:n.specialised_objects.knowledge_views_by_id,created_at_ms:n.routing.args.created_at_ms,sim_ms:n.routing.args.sim_ms}),a=tn(s)||`Knowledge view for ${e.wcomponent.id} created: ${as()}`,c=_e(n),l=c&&c.id,d={id:e.wcomponent.id,base_id:e.wcomponent.base_id,wc_id_map:o,title:a,sort_type:l?"normal":"hidden",parent_knowledge_view_id:l};return We(d)}const uR="M14 2H4c-1.11 0-2 .9-2 2v10h2V4h10V2zm4 4H8c-1.11 0-2 .9-2 2v10h2V8h10V6zm2 4h-8c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z";function pR(e){return _(Et,{...e,d:uR})}const mR=(e,t)=>({overlapping_wcomponent_ids:zy(e,t.wcomponent_id)}),fR={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,change_route:S.routing.change_route},vR=P(mR,fR);function hR(e){const{overlapping_wcomponent_ids:t,set_highlighted_wcomponent:n,change_route:i}=e,o=(t==null?void 0:t.length)||0,r="node_handle overlapping_nodes"+(o===0?" hidden ":""),a=o?`${o-1} other nodes at this location`:"",c=z(()=>{if(t)return l=>{l.stopImmediatePropagation(),n({id:e.wcomponent_id,highlighted:!1}),i({item_id:t[0]})}},[i,t]);return _("div",{className:r,title:a,onClick:c,children:_(pR,{fontSize:"small"})})}const gR=vR(hR);function wR(e){return _("div",{className:"handles",children:[_(bR,{show_move_handle:e.show_move_handle,user_requested_node_move:e.user_requested_node_move}),_(Bd,{wcomponent_id:e.wcomponent_id,wcomponent_current_kv_entry:e.wcomponent_current_kv_entry,is_highlighted:e.is_highlighted}),_(gR,{wcomponent_id:e.wcomponent_id})]})}function bR(e){const{show_move_handle:t,user_requested_node_move:n}=e,i="node_handle movement highlight_on_hover";return t?_("div",{className:i,onPointerDown:s=>{s.stopPropagation();const r=yR(s);n(r)},children:"✥"}):_("div",{className:i,children:" "})}function yR(e){const t=Ae().getState(),{x:n,y:i,zoom:o}=t.routing.args;return{x:j0(n,o,e.clientX),y:T0(i,o,e.clientY)}}function N0(e){const{VAP_set:t,VAP_set_id_to_counterfactual_v2_map:n,knowledge_views_by_id:i}=e,o=(n==null?void 0:n[t.id])||[],s={};return o.forEach(r=>{const{target_VAP_id:a}=r;if(!a)return;const c=nS(r.id,i),l={counterfactual_v2_id:r.id,counterfactual_has_knowledge_view:c},d=s[a]||[];d.push(l),s[a]=d}),s}function go(e){var a;const t=Aj(e.VAP_set,e.VAPs_represent),n=(a=t.shared_entry_values)==null?void 0:a.conviction;let i=0;const o=Ll(e.wcomponent),s=t.entries.map(c=>{const l=d2(c,e.VAPs_represent),d=kb(l,o),p=n??c.conviction,f=c.probability*p;return i+=f,{VAP_id:c.id,value_id:c.value_id,parsed_value:l,value_text:d,certainty:f}}),r=be(s,c=>c.certainty,ve.descending);return Cj(i,r)}const kR="m9.78 11.16-1.42 1.42c-.68-.69-1.34-1.58-1.79-2.94l1.94-.49c.32.89.77 1.5 1.27 2.01zM11 6 7 2 3 6h3.02c.02.81.08 1.54.19 2.17l1.94-.49C8.08 7.2 8.03 6.63 8.02 6H11zm10 0-4-4-4 4h2.99c-.1 3.68-1.28 4.75-2.54 5.88-.5.44-1.01.92-1.45 1.55-.34-.49-.73-.88-1.13-1.24L9.46 13.6c.93.85 1.54 1.54 1.54 3.4v5h2v-5c0-2.02.71-2.66 1.79-3.63 1.38-1.24 3.08-2.78 3.2-7.37H21z";function E0(e){return _(Et,{...e,d:kR})}const I0="darkorange";const xR=(e,t)=>{let n=pe(e,t.judgement_or_objective_id);ut(n)||(n=void 0);const i=_e(e),o=i?i.composed_wc_id_map[t.judgement_or_objective_id]:void 0;return{judgement_wcomponent:n,position:o}},SR=P(xR);function AR(e){const{judgement_or_objective_id:t,judgement_wcomponent:n,position:i,target_VAPs_represent:o,value:s}=e;if(!n)return null;const r=By({judgement_wcomponent:n,target_VAPs_represent:o,value:s});return _(gd,{judgement:r,judgement_trend_manual:e.hide_judgement_trend?void 0:n.judgement_trend_manual,judgement_or_objective_id:t,position:i,size:e.hide_judgement_trend?"small":"medium"})}const $R=SR(AR);const CR=e=>{const t=_e(e);return{active_judgement_or_objective_ids_by_target_id:t==null?void 0:t.active_judgement_or_objective_ids_by_target_id,active_judgement_or_objective_ids_by_goal_or_action_id:t==null?void 0:t.active_judgement_or_objective_ids_by_goal_or_action_id}},jR=P(CR);function TR(e){const{active_judgement_or_objective_ids_by_target_id:t,active_judgement_or_objective_ids_by_goal_or_action_id:n,target_VAPs_represent:i,value:o}=e,s=z(()=>[...(t||{})[e.wcomponent.id]||[],...(n||{})[e.wcomponent.id]||[]],[t,n]),r="node_judgements_container ";return o===void 0||i===void 0?_("div",{className:r,children:s.map(a=>_(Ky,{judgement_or_objective_id:a,hide_judgement_trend:e.hide_judgement_trend}))}):_("div",{className:r,children:s.map(a=>_($R,{judgement_or_objective_id:a,hide_judgement_trend:e.hide_judgement_trend,target_VAPs_represent:i,value:o}))})}const D0=jR(TR);function R0(e){const{VAP_visual:t,show_judgements:n,counterfactual_VAP_set:i,VAP_id_to_counterfactuals_info_map:o}=e,s={},r=oe(e.wcomponent,s),a=t.certainty*100,c=`${a}%`,l=Math.round(a);let d=100;l<100&&(d=l*1.25);const p=o[t.VAP_id]||[],f=i.has_any_counterfactual_applied?"warning_color":"";return _("div",{className:`value_and_prediction prob-${l} ${f}`,style:{fontSize:`${d}%`,maxHeight:c,minHeight:c},children:[t.value_text,n&&_(D0,{wcomponent:e.wcomponent,target_VAPs_represent:r,value:t.parsed_value,hide_judgement_trend:!0}),p.map(m=>_(PR,{any_active:i.has_any_counterfactual_applied,counterfactual:m,active_counterfactual_v2_id:i.active_counterfactual_v2_id}))]})}function PR(e){const i={fontSize:"25px",color:e.counterfactual.counterfactual_v2_id===e.active_counterfactual_v2_id?I0:e.any_active?"white":"#ffc965",verticalAlign:"middle",fontWeight:"bold",width:"20px"};return _("span",{onPointerDown:o=>o.stopImmediatePropagation(),onClick:o=>o.stopImmediatePropagation(),style:{display:"inline-flex"},children:[" ",_(Le,{route:void 0,sub_route:void 0,item_id:e.counterfactual.counterfactual_v2_id,args:void 0,extra_css_style:i,children:_(E0,{fontSize:"small"})}),e.counterfactual.counterfactual_has_knowledge_view&&_("span",{style:{fontSize:14},children:_(Bd,{wcomponent_id:e.counterfactual.counterfactual_v2_id||"",is_highlighted:!0})})," "]})}function NR(e){const[t,n]=D(!1),{counterfactual_VAP_set:i,VAP_id_to_counterfactuals_info_map:o}=e,s={},r=oe(e.wcomponent,s),a=go({...e,VAP_set:i,VAPs_represent:r}),c=a.filter(l=>l.certainty>0);return _(I,{height:"100%",maxWidth:"100%",minWidth:100,overflow:"hidden",position:"relative",flexDirection:"column",justifyContent:"flex-end",alignItems:"stretch",alignContent:"stretch",className:`value_and_prediction_set_summary items-${a.length} visible-${c.length}`,onPointerOver:()=>n(!0),onPointerLeave:()=>n(!1),children:a.map((l,d)=>{const p=t||d===0;return _(R0,{wcomponent:e.wcomponent,VAP_visual:l,show_judgements:p,counterfactual_VAP_set:i,VAP_id_to_counterfactuals_info_map:o})})})}const ER=(e,t)=>({VAP_set_id_to_counterfactual_v2_map:ho(e,t.wcomponent.id),knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),IR=P(ER);function DR(e){const{wcomponent:t,VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o}=e,s=gs({VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i}),r=N0({VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o});return _(NR,{wcomponent:t,counterfactual_VAP_set:s,VAP_id_to_counterfactuals_info_map:r})}const Ud=IR(DR);function O0(e){const{values_and_prediction_sets:t=[],created_at_ms:n,sim_ms:i}=e,{present_item:o}=xn({items:t,created_at_ms:n,sim_ms:i});return o}function M0(e){if(!On(e.wcomponent))return null;const t=O0({...e,values_and_prediction_sets:e.wcomponent.values_and_prediction_sets});return t?_(Ud,{wcomponent:e.wcomponent,VAP_set:t}):null}function q0(e){const{selector:t,target_wcomponent:n}=e,{target_VAP_set_id:i,target_value_id_type:o,target_value:s}=t||{},r=RR(n,i),c=oe(n,{}),l=[];return r.forEach(p=>{go({VAP_set:p,VAPs_represent:c,wcomponent:n}).forEach(({value_id:f,value_text:m})=>l.push({value_id:f,value:m}))}),Lh(l,n.value_possibilities).map(p=>{const f=V0({target_value_id_type:o,target_value:s,value_text:p.value,value_id:p.id});return{...p,selected:f}})}function RR(e,t){let n=e.values_and_prediction_sets||[];return t&&(n=n.filter(({id:i})=>i===t)),n}function V0(e){const{target_value_id_type:t,target_value:n,value_text:i,value_id:o}=e;let s;return t==="value_string"?s=n===i:t==="id"&&(s=n===o),s}function hi(e){if(e===void 0)return"";const t=qe(e,0,1)*100;return t.toPrecision(t<98?2:3).replace(/\.0$/,"")}const OR=(e,t)=>{const{target_wcomponent_id:n}=t.wcomponent,{wcomponents_by_id:i}=e.specialised_objects,o=i[n||""],s=Ke(o)&&o,r=ho(e,n);return{target_wcomponent:s,wcomponents_by_id:i,VAP_set_id_to_counterfactual_v2_map:r,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}},MR=P(OR);function qR(e){const{target_wcomponent:t,wcomponents_by_id:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o}=e;if(!t)return null;const{selector:s}=e.wcomponent,{target_VAP_set_id:r,target_value_id_type:a,target_value:c}=s||{},l=a!==void 0&&c!==void 0;let d=t.values_and_prediction_sets||[];const p=oe(t,n);if(r===void 0)return l?null:_(M0,{wcomponent:t,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});d=d.filter(({id:g})=>g===r),d=Uw(d,e.created_at_ms);const f=d[0];if(!f)return _("div",{children:"Invalid configuration"});if(!l)return _(Ud,{wcomponent:t,VAP_set:f});const m=gs({VAP_set:f,VAP_set_id_to_counterfactual_v2_map:i}),v=N0({VAP_set:f,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o});let w=go({...e,VAP_set:m,VAPs_represent:p}).find(({value_id:g,value_text:k})=>V0({target_value_id_type:a,target_value:c,value_id:g,value_text:k}));if(!w)return _("div",{children:"Invalid configuration"});let{value_text:b}=w;return b=` ${hi(w.certainty)}%`,w={...w,value_text:b,certainty:1},_(R0,{wcomponent:t,VAP_visual:w,show_judgements:!0,counterfactual_VAP_set:m,VAP_id_to_counterfactuals_info_map:v})}const VR=MR(qR),FR="m14.5 14.2 2.9 1.7-.8 1.3L13 15v-5h1.5v4.2zM22 14c0 4.41-3.59 8-8 8-2.02 0-3.86-.76-5.27-2H4c-1.15 0-2-.85-2-2V9c0-1.12.89-1.96 2-2v-.5C4 4.01 6.01 2 8.5 2c2.34 0 4.24 1.79 4.46 4.08.34-.05.69-.08 1.04-.08 4.41 0 8 3.59 8 8zM6 7h5v-.74C10.88 4.99 9.8 4 8.5 4 7.12 4 6 5.12 6 6.5V7zm14 7c0-3.31-2.69-6-6-6s-6 2.69-6 6 2.69 6 6 6 6-2.69 6-6z";function zR(e){return _(Et,{...e,d:FR})}const LR="M8 18h3v3h2v-3h3l-4-4-4 4zm8-12h-3v-3h-2v3h-3l4 4 4-4zm-12 5v2h16v-2z";function BR(e){return _(Et,{...e,d:LR})}const UR=(e,t)=>{const{target_wcomponent_id:n}=t.wcomponent,i=e.specialised_objects.wcomponents_by_id[n||""];return{target_wcomponent:Ke(i)&&i,presenting:e.display_options.consumption_formatting}},WR=P(UR);function HR(e){const{target_wcomponent:t,presenting:n}=e;if(!t||n)return null;const{selector:i}=e.wcomponent,{target_VAP_set_id:o,target_value_id_type:s,target_value:r}=i||{},a=t.values_and_prediction_sets||[],c=o===void 0?0:a.find(({id:m})=>m===o)?1:2,l=q0({selector:i,target_wcomponent:t}),d=s===void 0||r===void 0?0:l.find(({selected:m})=>m)?1:2,p=Zv(c),f=Zv(d);return _("div",{className:"sub_state_type_indicators",children:[_(zR,{className:p,title:"Specific Time "+Qv(c),style:{height:"30px"}}),_(BR,{className:f,title:"Specific Possibility "+Qv(d),style:{height:"30px"}})]})}const GR=WR(HR);function Zv(e){return e===1?" sub_state_type_status__set ":e===0?" sub_state_type_status__not_set ":" sub_state_type_status__invalid "}function Qv(e){return e===1?"Set":e===0?"Not set":"Invalid"}const ll={r:175,g:175,b:175,a:.11};const eh=st,th=st,KR=e=>{var t;return{is_editing:!e.display_options.consumption_formatting,frame_is_resizing:e.meta_wcomponents.frame_is_resizing,knowledge_view_id:(t=Be(e))==null?void 0:t.id}},YR={set_frame_is_resizing:S.meta_wcomponents.set_frame_is_resizing,upsert_knowledge_view_entry:S.specialised_object.upsert_knowledge_view_entry},JR=P(KR,YR);function XR(e){const{wcomponent_id:t,kv_entry:n,is_editing:i,frame_is_resizing:o,knowledge_view_id:s,set_frame_is_resizing:r}=e;if((n==null?void 0:n.frame_width)===void 0||(n==null?void 0:n.frame_height)===void 0)return null;const[a,c]=D(void 0),[l,d]=D(void 0),p=h=>w=>{w.stopImmediatePropagation(),w.preventDefault(),r({frame_is_resizing:!0}),c(h)},f=z(()=>p(!0),[]),m=z(()=>p(!1),[]);re(()=>G.canvas.sub("canvas_move",h=>{if(a===void 0)return;const w=a?n.frame_width:zt(h.x-n.left+th),b=a?zt(-h.y-n.top+eh):n.frame_height;d({...n,frame_width:w,frame_height:b})})),re(()=>G.canvas.sub("canvas_pointer_up",()=>{!o||!s||l&&(e.upsert_knowledge_view_entry({wcomponent_id:t,knowledge_view_id:s,entry:l}),d(void 0),r({frame_is_resizing:!1}),c(void 0))}));const v=l||n;return _("div",{className:"wcomponent_background_frame",style:{top:v.top-eh,left:v.left-th,width:v.frame_width,height:v.frame_height,backgroundColor:Tt(v.frame_color||ll),borderColor:Tt(YD(v.frame_color||ll))},children:[i&&_("div",{className:"editable_edge editable_edge_bottom",onPointerDown:f}),i&&_("div",{className:"editable_edge editable_edge_right",onPointerDown:m})]})}const ZR=JR(XR);function QR(e){const{wcomponent:t,created_at_ms:n,sim_ms:i}=e,{is_valid:o}=Ol({wcomponent:t,created_at_ms:n,sim_ms:i})||Rl();return{values_string:o?"Valid":"Invalid",counterfactual_applied:void 0,uncertain:void 0,derived__using_values_from_wcomponent_ids:void 0}}function F0(e){const{UI_value:t}=e,{values_string:n,counterfactual_applied:i,uncertain:o,derived__using_values_from_wcomponent_ids:s}=t,r=i||!!(s!=null&&s.length),a=`value ${r?"assumption":""} ${o?"uncertain":""}`;let c="Current value";return r&&(c+=" is an assumption"),r&&o&&(c+=" and"),o&&(c+=" has uncertainty"),_(Re,{children:[_(He,{className:a,title:c,"aria-label":c,children:_("span",{children:n})}),(s||[]).map(l=>_(i6,{uuid:l}))]})}const e6=(e,t)=>{const{composed_wcomponents_by_id:n}=e.derived,i=n[t.uuid],o=rt(e),s=e.specialised_objects.knowledge_views_by_id;return{title:i&&mt({wcomponent:i,text_type:fe.plain,wcomponents_by_id:n,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms})}},t6=P(e6);function n6(e){const{uuid:t,title:n}=e;let i="a different component";n!=null&&n.trim()&&(i=`'${tn(n.trim())}'`);const o="Value derived from "+i;return _(Le,{route:void 0,sub_route:void 0,item_id:t,args:void 0,children:_(E0,{className:"material-icons",title:o,style:{fill:I0,height:"16px"}})},t)}const i6=t6(n6),o6=e=>{const{created_at_ms:t,sim_ms:n}=e.routing.args;return{created_at_ms:t,sim_ms:n}},s6=P(o6);function r6(e){const t=QR(e);return _("div",{className:"node_validity_value_container",children:_(F0,{UI_value:t})})}const _6=s6(r6),z0=!1,a6=(e,t)=>{const{id:n,always_show:i=z0}=t,o=e.global_keys.derived.shift_or_control_down,s=Qx(e,n),{current_composed_knowledge_view:r}=e.derived,a=e.derived.composed_wcomponents_by_id[n],c=a&&r&&a.base_id!==r.base_id;let l=!1,d,p=new Set;r&&(l=!!(r.active_judgement_or_objective_ids_by_target_id[n]||r.active_judgement_or_objective_ids_by_goal_or_action_id[n]),d=r.composed_wc_id_map[n],p=r.filters.wc_ids_excluded_by_filters);const f=e.meta_wcomponents.selected_wcomponent_ids_set.has(n),{created_at_ms:m,sim_ms:v}=e.routing.args,h=e.display_options.derived_validity_filter,w=i||!a?1:si({wcomponent:a,kv_entry:d,created_at_ms:m,sim_ms:v,validity_filter:h,is_selected:f,wc_ids_excluded_by_filters:p});return{on_current_knowledge_view:s,kv_entry:d,derived_composed_wcomponent:a,kv_from_different_base:c,wc_id_to_counterfactuals_map:rt(e),composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,is_current_item:e.routing.item_id===n,is_selected:f,is_highlighted:e.meta_wcomponents.highlighted_wcomponent_ids.has(n),shift_or_control_keys_are_down:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,is_editing:!e.display_options.consumption_formatting,validity_value:w,certainty_formatting:e.display_options.derived_certainty_formatting,focused_mode:e.display_options.focused_mode,have_judgements:l,node_is_moving:e.meta_wcomponents.wcomponent_ids_to_move_set.has(n),display_time_marks:e.display_options.display_time_marks,connected_neighbour_is_highlighted:e.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(n)}},c6={clicked_wcomponent:S.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:S.meta_wcomponents.clear_selected_wcomponents,change_route:S.routing.change_route,set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,pointerupdown_on_component:S.meta_wcomponents.pointerupdown_on_component,pointerupdown_on_connection_terminal:S.meta_wcomponents.pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move:S.meta_wcomponents.set_wcomponent_ids_to_move,request_searching_for_wcomponents_by_id_in_any_base:S.sync.request_searching_for_wcomponents_by_id_in_any_base},l6=P(a6,c6);function d6(e){const{id:t,is_on_canvas:n=!0,always_show:i=z0,is_editing:o,derived_composed_wcomponent:s,kv_entry:r,kv_from_different_base:a,wc_id_to_counterfactuals_map:c,knowledge_views_by_id:l,is_current_item:d,is_selected:p,is_highlighted:f,shift_or_control_keys_are_down:m,validity_value:v,created_at_ms:h,sim_ms:w,certainty_formatting:b,clicked_wcomponent:g,clear_selected_wcomponents:k,composed_wcomponents_by_id:y}=e,{change_route:$,set_highlighted_wcomponent:j}=e;if(re(()=>{s||e.request_searching_for_wcomponents_by_id_in_any_base({ids:[t]})},[!!s]),!r&&!i)return _("div",{children:["Could not find knowledge view entry for id ",t]});const C=r||{left:0,top:0},[N,A]=D(void 0);if(re(()=>{if(!e.node_is_moving)return;const tt=G.canvas.sub("throttled_canvas_node_drag_relative_position",Un=>{const Ti={...C};Ti.left+=Un.left,Ti.top+=Un.top,A(Ti)});return()=>{A(void 0),tt()}},[e.node_is_moving]),!v)return null;const R=by({is_editing:o,certainty:v,is_highlighted:f,connected_neighbour_is_highlighted:e.connected_neighbour_is_highlighted,is_selected:p,is_current_item:d,certainty_formatting:b,focused_mode:e.focused_mode}),M=e.node_is_moving?.3:R,T=C0({wcomponent_id:t,clicked_wcomponent:g,clear_selected_wcomponents:k,shift_or_control_keys_are_down:m,change_route:$,is_current_item:d}),B=e.node_is_moving?[]:[_(wR,{show_move_handle:n&&o&&f,user_requested_node_move:tt=>{tR(t,tt)},wcomponent_id:t,wcomponent_current_kv_entry:C,is_highlighted:f})],ne=s?mt({wcomponent:s,wcomponents_by_id:y,knowledge_views_by_id:l,wc_id_to_counterfactuals_map:c,created_at_ms:h,sim_ms:w}):"&lt;Not found&gt;",Ye=o,_t={transform:`scale(${C.s&&n?C.s:1})`},Ln=f?"orange":(p||d)&&"blue",Gt=p6({wcomponent:s,wcomponents_by_id:y,sim_ms:w,created_at_ms:h,display_time_marks:e.display_time_marks}),wt=` wcomponent_canvas_node  wcomponent_${t} `+(o?e.on_current_knowledge_view?" node_on_kv ":" node_on_foundational_kv ":"")+(e.node_is_moving?" node_is_moving ":"")+(f?" node_is_highlighted ":"")+(d?" node_is_current_item ":"")+(p?" node_is_selected ":"")+(s?` node_is_type_${s.type} `:"")+(Ye?" compact_title ":"")+Gt.font+Gt.background;let yo=!1,ko=!1;s&&(yo=qh(s)&&o||wi(s)&&d,ko=o&&Ke(s)||!s.hide_state&&(bi(s)||ut(s)||Mh(s)&&(s.objective_ids||[]).length>0||e.have_judgements));const Bn=s?(o||!s.hide_state)&&oo(s)&&s:!1,Vs=u6({is_on_canvas:n,is_editing:o,is_highlighted:f}),Fs=tt=>{tt.stopImmediatePropagation(),tt.preventDefault(),e.pointerupdown_on_component({up_down:"down",wcomponent_id:t})},zs=tt=>{tt.stopImmediatePropagation(),tt.preventDefault(),e.pointerupdown_on_component({up_down:"up",wcomponent_id:t})},Ls=(tt,Un)=>e.pointerupdown_on_connection_terminal({terminal_type:tt,up_down:Un,wcomponent_id:t}),xo=n?N||C:void 0,Bs=z(()=>m6(s),[s]);return _("div",{children:[_(ZR,{wcomponent_id:t,kv_entry:xo}),_(HD,{position:xo,cover_image:s==null?void 0:s.summary_image,node_main_content:_("div",{children:[!(s!=null&&s.summary_image)&&_("div",{className:"background_image"}),_("div",{className:"node_title",children:[r===void 0&&o&&_("span",{children:[_(_n,{message:"Missing from this knowledge view"})," "]}),a&&o&&_("span",{children:[_(_n,{message:"Is from a different base to this knowledge view"})," "]}),(o||!(s!=null&&s.hide_title))&&_(vo,{options:{...md,forceInline:!0},children:ne})]}),s&&yo&&_("div",{className:"node_validity_container",children:[o&&_("div",{className:"description_label",children:"validity"}),_(_6,{wcomponent:s})]}),s&&ko&&_("div",{className:"node_state_container",children:[o&&_("div",{className:"description_label",children:"state  "}),_(D0,{wcomponent:s,hide_judgement_trend:!1}),_("div",{className:"value_and_prediction_summary",children:_(M0,{wcomponent:s,created_at_ms:h,sim_ms:w})})]}),Bn&&_("div",{className:"node_sub_state_container",children:_("div",{className:"value_and_prediction_summary",children:_(VR,{wcomponent:Bn,created_at_ms:h,sim_ms:w})})}),Bn&&_(GR,{wcomponent:Bn}),s&&o&&_("div",{className:"description_label",children:no(s.type)}),_("div",{style:{display:"flex"},title:s!=null&&s.description.trim()?"Further details are included":void 0,children:[(s==null?void 0:s.description.trim())&&_(A0,{className:"description_icon",fontSize:"small",color:"disabled"}),s&&_(eR,{label_ids:Bs})]})]}),extra_css_class:wt,extra_styles_for_node_main_content:_t,opacity:M,unlimited_width:!1,glow:Ln,on_click:T,on_pointer_enter:()=>j({id:t,highlighted:!0}),on_pointer_leave:()=>j({id:t,highlighted:!1}),terminals:Vs,on_pointer_down:Fs,on_pointer_up:zs,pointerupdown_on_connection_terminal:Ls,other_children:B})]})}const is=l6(d6),Ec=[],L0=[];Uk.forEach(e=>{Wk.forEach(t=>{const n={attribute:e,side:t},i=Nb(n),o=n.attribute.slice(0,1).toUpperCase();L0.push({type:n,style:i,label:o})})});function u6(e){return!e.is_on_canvas||!e.is_editing||!e.is_highlighted?Ec:L0}function p6(e){let t="",n="";const{wcomponent:i,created_at_ms:o,sim_ms:s}=e;if(!i)return{background:" node_missing ",font:n};if(et(i)){const r=An({wcomponent:i,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:o,sim_ms:s}),a=r.most_probable_VAP_set_values[0];r.any_uncertainty?t=" past_uncertain ":a&&(a.value_id===$e.action_completed||a.value_id===$e.action_failed||a.value_id===$e.action_rejected)&&(t=" past_certain ",n=" color_light ")}else{const r=xl(i.id,e.wcomponents_by_id,o);if(r){const{temporal_uncertainty:a,certainty:c}=r,l=Mn(a);l&&l.getTime()<s?c===1||c===void 0?(t=" past_certain ",n=" color_light "):t=" past_uncertain ":l||(c===1||c===void 0)&&(t=" past_certain ",n=" color_light ")}}return{background:t,font:n}}function m6(e){if(!e)return[];const t=[...e.label_ids||[]],n=new Set(t);return et(e)&&e.parent_goal_or_action_ids&&e.parent_goal_or_action_ids.forEach(i=>{n.has(i)||(t.push(i),n.add(i))}),t}const f6=e=>({editing:!e.display_options.consumption_formatting}),v6={upsert_wcomponent:S.specialised_object.upsert_wcomponent},h6=P(f6,v6);function g6(e){const{action:t,upsert_wcomponent:n}=e;return _("div",{className:"prioritisable_action",children:[_(is,{id:t.id,is_on_canvas:!1,always_show:!0}),e.show_icebox_actions&&_("div",{className:"controls",children:_(ue,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:new Date().getTime()}}),children:_(S0,{})})}),e.show_todo_actions&&_("div",{className:"controls",children:[_(ue,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:new Date().getTime()}}),children:_(Rs,{})}),_(ue,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:void 0}}),children:_(x0,{})})]})]})}const Mo=h6(g6);function w6(){return _(Rd,{main_content:_(S6,{})})}const b6=e=>{const{wcomponents_by_id:t}=e.specialised_objects;return{action_ids:C$(e),wcomponents_by_id:t,display_side_panel:e.controls.display_side_panel}},y6={upsert_wcomponent:S.specialised_object.upsert_wcomponent},k6=P(b6,y6);function x6(e){const{action_ids:t,wcomponents_by_id:n}=e,[i,o]=D(5),[s,r]=D(void 0),a=De(void 0),c=De(void 0),l=z(()=>{const g=Pg(n,t).filter(et);return be(g,A6,ve.descending)},[t,n]),d=[],p=[],f=[],m=[],v=new Date().getTime();l.forEach(g=>{const y=An({wcomponent:g,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:v,sim_ms:v}).most_probable_VAP_set_values[0];(y==null?void 0:y.value_id)===$e.action_in_progress?f.push(g):(y==null?void 0:y.value_id)===$e.action_completed||(y==null?void 0:y.value_id)===$e.action_rejected||(y==null?void 0:y.value_id)===$e.action_failed?m.push(g):g.todo_index?p.push(g):d.push(g)});const h=m.length-i,w=be(p,g=>g.todo_index||0,ve.descending),b=z(()=>{var y;return((y=be(l,ze,ve.descending)[0])==null?void 0:y.id)||""},[l]);return _("div",{className:`action_list_view_content ${s===void 0?"":"moving"}`,ref:g=>c.current=g||void 0,onPointerDown:g=>{const k=c.current;k&&(r({x:g.clientX,y:g.clientY}),a.current={left:k.scrollLeft,top:k.scrollTop})},onPointerMove:g=>{if(s===void 0||a.current===void 0||!c.current)return;const k=a.current.left-(g.clientX-s.x),y=a.current.top-(g.clientY-s.y);c.current.scroll(k,y)},onPointerUp:()=>r(void 0),onPointerLeave:()=>r(void 0),onPointerOut:g=>{let k=g.relatedTarget;k=v4(k,["action_list","action_list_view_content"]),!k&&r(void 0)},children:[_("div",{className:"action_list icebox",children:[_("h1",{children:["Icebox",_(Oo,{list_type:"icebox",most_recent_action_id:b})]}),d.map(g=>_(Mo,{action:g,show_icebox_actions:!0},g.id))]}),_("div",{className:"action_list todo",children:[_("h1",{children:["Todo",_(Oo,{list_type:"todo",most_recent_action_id:b})]}),w.map(g=>_(Mo,{action:g,show_todo_actions:!0},g.id))]}),_("div",{className:"action_list in_progress",children:[_("h1",{children:["In progress",_(Oo,{list_type:"in_progress",most_recent_action_id:b})]}),f.map(g=>_(Mo,{action:g},g.id))]}),_("div",{className:"action_list done_or_rejected",children:[_("h1",{children:["Done",_(Oo,{list_type:"done",most_recent_action_id:b})]}),m.slice(0,i).map(g=>_(Mo,{action:g},g.id)),h>0&&_("div",{style:{textAlign:"center",margin:40,cursor:"pointer"},onClick:()=>o(i+50),children:["... ",h," hidden ..."]})]}),_("div",{className:"side_panel_padding",style:{minWidth:e.display_side_panel?Ji:0}})]})}const S6=k6(x6);function A6(e){return e.modified_at?e.modified_at.getTime():ze(e)}function $6(e){const{canvas_start_x:t,canvas_start_y:n,canvas_end_x:i,canvas_end_y:o}=e,s={left:t,top:-o,width:i-t,height:o-n};return _("div",{className:`selection_box color_${e.color}`,style:s})}const B0="graph_container",U0="graph_visuals_container",C6=900,j6=10,T6=e=>{const{x:t,y:n,zoom:i}=e.routing.args,o=e.global_keys.keys_down.has("Shift"),s=e.global_keys.keys_down.has("Control");return{zoom:i,x:t,y:n,shift_key_down:o,control_key_down:s}},P6=e=>({change_routing_args:t=>{let n={};t.zoom!==void 0&&(n.zoom=Math.round(Vl(t.zoom))),t.x!==void 0&&(n.x=Math.round(t.x)),t.y!==void 0&&(n.y=Math.round(t.y)),e(S.routing.change_route({args:n}))}}),N6=P(T6,P6);class E6 extends jh{constructor(n){super(n);ke(this,"manual_zoom_target");ke(this,"client_to_canvas",n=>zd(this.props.zoom,n));ke(this,"client_to_canvas_x",n=>j0(this.props.x,this.props.zoom,n));ke(this,"client_to_canvas_y",n=>T0(this.props.y,this.props.zoom,n));ke(this,"on_pointer_down",n=>{if(G.canvas.pub("canvas_pointer_down",!0),n.button===2)return;const o=n.offsetX,s=n.offsetY,r={down:!0,area_select:this.props.shift_key_down,last_pointer_down_ms:new Date().getTime(),canvas_start_x:this.client_to_canvas_x(o),canvas_start_y:this.client_to_canvas_y(s),x_when_pointer_down:this.props.x,y_when_pointer_down:this.props.y,client_start_x:o,client_start_y:s};D6({zoom:this.props.zoom,current_pointer_state:this.state.pointer_state,new_pointer_state:r}),this.setState({pointer_state:r,canvas_current_x:r.canvas_start_x,canvas_current_y:r.canvas_start_y})});ke(this,"on_pointer_up",n=>{if(n==null||n.preventDefault(),G.canvas.pub("canvas_pointer_up",!0),this.state.pointer_state.area_select){const o=ih(this.state),s={start_x:o.canvas_start_x,start_y:o.canvas_start_y,end_x:o.canvas_end_x,end_y:o.canvas_end_y};G.canvas.pub("canvas_area_select",s)}const i={...this.state.pointer_state,down:!1,area_select:!1};this.setState({pointer_state:i,canvas_current_x:void 0,canvas_current_y:void 0})});ke(this,"on_pointer_leave",()=>{this.state.pointer_state.area_select||this.on_pointer_up()});ke(this,"on_pointer_move",n=>{if(G.canvas.pub("canvas_move",{x:this.client_to_canvas_x(n.offsetX),y:this.client_to_canvas_y(n.offsetY)}),!this.state.pointer_state.down)return;const i=n.offsetX,o=n.offsetY;if(this.state.pointer_state.area_select){const s=this.client_to_canvas_x(i),r=this.client_to_canvas_y(o);this.setState({canvas_current_x:s,canvas_current_y:r})}else{const s=this.state.pointer_state.client_start_x-i,r=this.state.pointer_state.client_start_y-o,a=this.state.pointer_state.x_when_pointer_down+this.client_to_canvas(s),c=this.state.pointer_state.y_when_pointer_down-this.client_to_canvas(r);this.props.change_routing_args({x:a,y:c})}});ke(this,"on_wheel",n=>{n.stopPropagation(),n.preventDefault();const i=n.deltaY,o=DC({zoom:this.props.zoom,wheel_change:i});if(o===this.props.zoom)return;const s=this.props.zoom/Fe,{pointer_x:r,pointer_y:a}=R6(n,this.props,s),{offsetHeight:c,offsetWidth:l}=n.currentTarget,d=fb({old:this.props,new_zoom:o,pointer_x:r,pointer_y:a,client_height:c,client_width:l});this.props.change_routing_args({zoom:o,x:d.x,y:d.y}),this.manual_zoom_target=o});ke(this,"on_context_menu",n=>{n.stopPropagation(),n.preventDefault();const i=this.client_to_canvas_x(n.offsetX),o=this.client_to_canvas_y(n.offsetY);n.button===2&&G.canvas.pub("canvas_right_click",{x:i,y:o})});this.state={pointer_state:{down:!1,area_select:!1,last_pointer_down_ms:void 0,canvas_start_x:void 0,canvas_start_y:void 0,x_when_pointer_down:void 0,y_when_pointer_down:void 0,client_start_x:void 0,client_start_y:void 0},canvas_current_x:void 0,canvas_current_y:void 0}}render(){const{zoom:n}=this.props,i=n/Fe,o=-1*this.props.x*i,s=this.props.y*i,r=st*i,a=this.state.pointer_state.down,c=this.manual_zoom_target===n;this.manual_zoom_target=void 0;const l=a?0:c?.1:1,d={transition:`background-position ${l}s, background-size ${l}s`,backgroundPosition:`${o}px ${s}px`,backgroundSize:`${r}px ${r}px`},p={transition:`background-position ${l}s, background-size ${l}s`,backgroundPosition:`${o}px ${s}px`,backgroundSize:`${pi*i}px ${Sn*i}px`},f={transition:`transform ${l}s`,transform:`translate(${o}px,${s}px)`},m={transition:`transform ${l}s`,transformOrigin:"left top",transform:`scale(${i})`},v=(this.props.plain_background?"":"squared_background ")+(this.state.pointer_state.down?"graph_background_pointer_down ":"");return _("div",{style:{flexGrow:1},className:this.props.extra_class_names,children:_("div",{id:B0,className:v,style:d,onPointerDown:this.on_pointer_down,onPointerMove:this.on_pointer_move,onPointerUp:this.on_pointer_up,onPointerLeave:this.on_pointer_leave,onWheel:this.on_wheel,onDragOver:h=>{h.preventDefault(),h.dataTransfer.dropEffect="move"},onContextMenu:this.on_context_menu,children:[!this.props.plain_background&&this.props.show_large_grid&&_("div",{className:"big_squared_background",style:p}),_("div",{id:U0,style:f,children:_("div",{style:m,children:[_("div",{id:"graph_lowest_elements_container",children:[_("svg",{style:{zIndex:0,position:"absolute",top:0,left:0},children:[nh,this.props.svg_children]}),this.props.children,_("svg",{style:{zIndex:2,position:"absolute",top:0,left:0},children:[nh,this.props.svg_upper_children]})]}),this.state.pointer_state.area_select&&_($6,{...ih(this.state),color:this.props.control_key_down?"red":"blue"})]})}),_("div",{children:this.props.overlay})]})})}}const I6=N6(E6),nh=_("defs",{children:Array.from(Array(101)).map((e,t)=>_("filter",{id:"blur_filter_"+t,x:"0",y:"0",children:_("feGaussianBlur",{in:"SourceGraphic",stdDeviation:t/20})}))});function D6(e){const{zoom:t,current_pointer_state:n,new_pointer_state:i}=e;if(!n.last_pointer_down_ms||!i.last_pointer_down_ms||i.last_pointer_down_ms-n.last_pointer_down_ms>C6)return;const{canvas_start_x:s,canvas_start_y:r}=n,{canvas_start_x:a,canvas_start_y:c}=i;if(s===void 0||r===void 0||a===void 0||c===void 0)return;const l=Math.abs(s-a),d=Math.abs(r-c),p=j6/t;l>p||d>p||G.canvas.pub("canvas_double_tap",{x:s,y:r})}function ih(e){const t=e.pointer_state.canvas_start_x||0,n=e.pointer_state.canvas_start_y||0,i=e.canvas_current_x||0,o=e.canvas_current_y||0;return{canvas_start_x:Math.min(t,i),canvas_start_y:Math.min(n,o),canvas_end_x:Math.max(t,i),canvas_end_y:Math.max(n,o)}}function R6(e,t,n){let i=e.offsetX,o=e.offsetY,s=e.target;if(s.id!==B0){for(;s.id!==U0;)i+=s.offsetLeft||0,o+=s.offsetTop||0,s=s.parentElement;i-=t.x,o+=t.y,i*=n,o*=n,i=Math.round(i),o=Math.round(o)}return{pointer_x:i,pointer_y:o}}function O6(e){const[t,n]=D(!1),{connection_from_component:i,connection_to_component:o,line_behaviour:s,circular_links:r,on_pointer_over_out:a=()=>{},connection_end_type:c=Bt.positive,is_highlighted:l=!1}=e,d=t?2:e.thickness??2,p=qe(d*2.5,10,35),f=z(()=>Oe({connection_from_component:i,connection_to_component:o,line_behaviour:s,circular_links:r,end_size:p,connection_end_type:c}),[i,o,s,r,p,c]);if(!f)return null;const m=e.intensity??1,v=e.blur??0,h={strokeWidth:d+10},w={strokeOpacity:m,strokeWidth:d,filter:v?`url(#blur_filter_${Math.round(v)})`:""},b=t?" hovered ":e.focused_mode?"":l?" highlighted ":"",g=(e.on_click?" mouseable ":"")+b,k=()=>{n(!0),a(!0)},y=()=>{n(!1),a(!1)};return _("g",{className:"connection_container "+(e.extra_css_classes||""),onPointerDown:e.on_click,style:{display:e.hidden?"none":""},children:_(M6,{target_connection_coords:f,extra_background_classes:g,on_pointer_over:k,on_pointer_out:y,style_line_background:h,extra_line_classes:b,style_line:w,connection_end_type:c,opacity:m,blur:v,end_size:p,hovered:t,is_highlighted:l,line_behaviour:s})})}function M6(e){const[t,n]=D(e.target_connection_coords);re(()=>F6(t,e.target_connection_coords,n),[e.target_connection_coords]);const i=q6(t,e.line_behaviour);return _(Re,{children:[_("path",{className:"connection_line_background "+e.extra_background_classes,d:i,onPointerOver:e.on_pointer_over,onPointerOut:e.on_pointer_out,style:e.style_line_background}),_("path",{className:"connection_line "+e.extra_line_classes,d:i,style:e.style_line}),_(Jj,{type:e.connection_end_type,x:t.connection_end_x,y:t.connection_end_y,end_angle:t.end_angle,opacity:e.opacity,blur:e.blur,size:e.end_size,is_hovered:e.hovered,is_highlighted:e.is_highlighted})]})}function q6({line_start_x:e,line_start_y:t,relative_control_point1:n,relative_control_point2:i,line_end_x:o,line_end_y:s},r){if(r===ci.angular){const p=(s-t)/2;return`
            M ${e} ${-t}
            L ${e} ${-t-p}
            L ${o} ${-t-p}
            L ${o} ${-s}
        `}const a=e+n.x,c=-t-n.y,l=o+i.x,d=-s-i.y;return`
        M ${e} ${-t}
        C ${a},${c}, ${l},${d}, ${o},${-s}
    `}const V6=1*1e3;function F6(e,t,n){if(e===t)return;let i=performance.now();function o(s){if(i<0)return;let r=(s-i)/V6;r=Math.min(r,1);const a={line_start_x:Ot(e.line_start_x,t.line_start_x,r),line_start_y:Ot(e.line_start_y,t.line_start_y,r),relative_control_point1:oh(e.relative_control_point1,t.relative_control_point1,r),relative_control_point2:oh(e.relative_control_point2,t.relative_control_point2,r),line_end_x:Ot(e.line_end_x,t.line_end_x,r),line_end_y:Ot(e.line_end_y,t.line_end_y,r),connection_end_x:Ot(e.connection_end_x,t.connection_end_x,r),connection_end_y:Ot(e.connection_end_y,t.connection_end_y,r),end_angle:Ot(e.end_angle,t.end_angle,r)};r>=1?(i=-1,n(t)):(n(a),requestAnimationFrame(o))}return requestAnimationFrame(o),()=>i=-1}function Ot(e,t,n){return e+(t-e)*n}function oh(e,t,n){return{x:Ot(e.x,t.x,n),y:Ot(e.y,t.y,n)}}function W0(e){const{wcomponent:t,current_composed_knowledge_view:n,from_wc:i,to_wc:o}=e,{kv_entry_from_wc:s,kv_entry_to_wc:r,from_attribute:a,to_attribute:c}=z6({wcomponent:t,wc_id_map:n.composed_wc_id_map}),l={side:"right",attribute:a},d={side:"left",attribute:c},p=i==null?void 0:i.type,f=o==null?void 0:o.type;return{connection_from_component:s&&p&&{kv_wc_entry:s,wcomponent_type:p,connection_terminal_type:l},connection_to_component:r&&f&&{kv_wc_entry:r,wcomponent_type:f,connection_terminal_type:d}}}function z6({wcomponent:e,wc_id_map:t}){let n,i,o,s;return ye(e)?(n=t[e.from_id],i=t[e.to_id],o=e.from_type,s=e.to_type):(n=t[e.id],i=t[e.judgement_target_wcomponent_id],o="meta",s="meta"),{kv_entry_from_wc:n,kv_entry_to_wc:i,from_attribute:o,to_attribute:s}}const L6=(e,t)=>{const{id:n}=t,i=pe(e,n),{selected_wcomponent_ids_set:o}=e.meta_wcomponents,{current_composed_knowledge_view:s}=e.derived,{created_at_ms:r,sim_ms:a}=e.routing.args,{derived_validity_filter:c}=e.display_options,l=!e.display_options.consumption_formatting;let d=!1,p,f,m;if(!(!i||!s)){const{wc_ids_excluded_by_filters:w}=s.filters,b=s.composed_wc_id_map[i.id];if(ye(i)){p=pe(e,i.from_id),f=pe(e,i.to_id);const g=s.composed_wc_id_map[i.from_id],k=s.composed_wc_id_map[i.to_id];d=hn({wcomponent:i,kv_entry:b,validity_filter:c,from_wc:p,to_wc:f,from_wc__kv_entry:g,to_wc__kv_entry:k,created_at_ms:r,sim_ms:a,selected_wcomponent_ids_set:o,wc_ids_excluded_by_filters:w}),m=G6(i,p,e)}else if(ut(i)){const g=i.judgement_target_wcomponent_id,k=pe(e,g),y=s.composed_wc_id_map[g];d=$P({wcomponent:i,kv_entry:b,validity_filter:c,target_wc:k,target_wc__kv_entry:y,created_at_ms:r,sim_ms:a,selected_wcomponent_ids_set:o,wc_ids_excluded_by_filters:w})}}const v=d===!1?!1:d.display_certainty,h=e.global_keys.derived.shift_or_control_down;return{current_composed_knowledge_view:s,wcomponent:i,from_wc:p,to_wc:f,connection_effect:m,validity_value:v,is_current_item:e.routing.item_id===n,is_selected:e.meta_wcomponents.selected_wcomponent_ids_set.has(n),is_highlighted:e.meta_wcomponents.highlighted_wcomponent_ids.has(n),is_editing:l,certainty_formatting:e.display_options.derived_certainty_formatting,shift_or_control_keys_are_down:h,focused_mode:e.display_options.focused_mode,connected_neighbour_is_highlighted:e.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(n),circular_links:e.display_options.circular_links}},B6={clicked_wcomponent:S.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:S.meta_wcomponents.clear_selected_wcomponents,set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,change_route:S.routing.change_route},U6=P(L6,B6);function W6(e){const{id:t,current_composed_knowledge_view:n,wcomponent:i,from_wc:o,to_wc:s,is_current_item:r,is_highlighted:a,is_selected:c,validity_value:l,connection_effect:d,shift_or_control_keys_are_down:p,change_route:f,clicked_wcomponent:m,clear_selected_wcomponents:v}=e;if(!i)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but could not find it`),null;if(!Yk(i))return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but was not a causal link`),null;if(l===!1)return null;if(!n)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but no current_composed_knowledge_view`),null;const h=C0({wcomponent_id:t,clicked_wcomponent:m,clear_selected_wcomponents:v,shift_or_control_keys_are_down:p,change_route:f,is_current_item:r}),w=W0({wcomponent:i,from_wc:o,to_wc:s,current_composed_knowledge_view:n}),{connection_from_component:b,connection_to_component:g}=z(()=>w,[JSON.stringify(w)]),k=by({is_editing:e.is_editing,certainty:l,is_current_item:r,is_selected:c,connected_neighbour_is_highlighted:e.connected_neighbour_is_highlighted,certainty_formatting:e.certainty_formatting,focused_mode:e.focused_mode});let y=2,$=Bt.positive,j="";d!==void 0&&(y=qe(Math.abs(d),2,15),d<0?($=Bt.negative,j="negative_connection_effect"):d===0&&($=Bt.noop,j="no_connection_effect"));let C;return ye(i)&&(C=i.line_behaviour),_(O6,{connection_from_component:b,connection_to_component:g,on_click:h,on_pointer_over_out:N=>e.set_highlighted_wcomponent({id:t,highlighted:N}),line_behaviour:C,circular_links:e.circular_links,thickness:y,connection_end_type:$,intensity:k,is_highlighted:r||a||c,focused_mode:e.focused_mode,extra_css_classes:"connection_type_"+i.type+" "+j})}const H6=U6(W6);function G6(e,t,n){var o;let i;if(an(e)&&(i=e.effect_when_true,Qe(t))){const s=O0({values_and_prediction_sets:t.values_and_prediction_sets,created_at_ms:n.routing.args.created_at_ms,sim_ms:n.routing.args.sim_ms});if(s){const r=ho(n,t.id),a=gs({VAP_set:s,VAP_set_id_to_counterfactual_v2_map:r}),l=oe(t,{}),p=(o=go({wcomponent:t,VAP_set:a,VAPs_represent:l})[0])==null?void 0:o.parsed_value;p!=null&&(l===E.boolean?i=p===!0?e.effect_when_true:e.effect_when_false??e.effect_when_true:i=typeof p=="number"?e.effect_when_true!==void 0?p*e.effect_when_true:void 0:e.effect_when_true)}}return i!==void 0?qe(i,-100,100):void 0}var Wd={},K6=Q;Object.defineProperty(Wd,"__esModule",{value:!0});var H0=Wd.default=void 0,Y6=K6(Z()),J6=ee(),X6=(0,Y6.default)((0,J6.jsx)("path",{d:"m20 12-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"}),"ArrowDownward");H0=Wd.default=X6;const Z6=e=>{const t=_e(e),n=t==null?void 0:t.composed_datetime_line_config;return{display_time_marks:e.display_options.display_time_marks,time_origin_ms:n==null?void 0:n.time_origin_ms,time_origin_x:n==null?void 0:n.time_origin_x,time_scale:n==null?void 0:n.time_scale,time_line_number:n==null?void 0:n.time_line_number,time_line_spacing_days:n==null?void 0:n.time_line_spacing_days,x:e.routing.args.x,zoom:e.routing.args.zoom,sim_ms:e.routing.args.sim_ms}},Q6=P(Z6);function eO(e){if(!(e.force_display??e.display_time_marks))return null;let{time_origin_ms:t,time_origin_x:n,time_scale:i}=e;if(e.force_display&&({time_origin_ms:t,time_origin_x:n,time_scale:i}=a$({time_origin_ms:t,time_origin_x:n,time_scale:i})),t===void 0||n===void 0||i===void 0)return null;const{sim_ms:o,time_line_number:s,time_line_spacing_days:r}=e,a=z(()=>oO({time_line_number:s&&s-1,time_line_spacing_days:r}),[s,r]),{x:c,zoom:l}=e,d=l/Fe,p=(c-n)*d,f=i/wh*d,m=new Date().getTime();return _("div",{className:"datetime_lines_container",children:[a.map(v=>_(Ic,{date_ms:(e.show_by_now?m:o)+v.offset,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:p,xd:d,color:"black",opacity:v.opacity},v.key)),!!s&&_(Ic,{date_ms:m,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:p,xd:d,color:"red",left_label_when_off_screen:!0}),!!s&&!e.show_by_now&&_(Ic,{date_ms:o,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:p,xd:d,color:"blue",left_label_when_off_screen:!0})]})}const tO=Q6(eO),nO="yyyy-MM-dd";function Ic(e){const{color:t,opacity:n}=e;let i=(e.date_ms-e.time_origin_ms)*e.time_scale_ms_to_pixels_fudge-e.xm;const o=document.body.clientWidth-20,s=i<0,r=i>o,a=!s&&!r;return!a&&!e.left_label_when_off_screen?null:(i=qe(i,0,o),_("div",{className:"datetime_container",style:{color:t,borderColor:t,left:i,opacity:n},children:[_("div",{className:"rotater",children:[s&&_(Rs,{fontSize:"small"}),r&&_(H0,{fontSize:"small"}),_("div",{className:"date_label",children:nn(new Date(e.date_ms),nO)})]}),a&&_("div",{className:"datetime_line"})]}))}const iO=1e3*3600*24;function oO(e){const t=[],{time_line_number:n,time_line_spacing_days:i}=e;if(n===void 0||i===void 0)return[];const o=i*iO;for(let s=n;s>0;--s){const r=s/n,a=n-s+1;t.push({offset:o*a,opacity:r,key:`plus${s}`}),t.push({offset:-o*a,opacity:r,key:`minus${s}`})}return t}const sO=e=>{const{ready_for_reading:t}=e.sync,{current_composed_knowledge_view:n}=e.derived;t&&!n&&console.log("No current_composed_knowledge_view");const{wc_ids_by_type:i,wcomponent_unfound_ids:o}=n||{},s=e.meta_wcomponents.wcomponent_ids_to_move_set.size>0,r=e.meta_wcomponents.frame_is_resizing,a=s||r;return{ready:t,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,wc_ids_by_type:i,wcomponent_unfound_ids:o,presenting:e.display_options.consumption_formatting,show_large_grid:e.display_options.show_large_grid,canvas_drag_event:a}},rO=P(sO);function _O(e){const t=cO(e),[n,i]=D(!1);re(()=>G.canvas.sub("canvas_pointer_down",()=>{i(!0)})),re(()=>G.canvas.sub("canvas_pointer_up",()=>{i(!1)}));const o=e.canvas_drag_event||n?" canvas_drag_event ":"";return _(Rd,{main_content:_(I6,{svg_children:[],svg_upper_children:lO(e),overlay:dO(),plain_background:e.presenting,show_large_grid:e.show_large_grid,extra_class_names:o,children:t})})}const aO=rO(_O),Dc=[],cO=e=>{const{ready:t,wc_ids_by_type:n,wcomponents_by_id:i,wcomponent_unfound_ids:o=[]}=e;if(!t||!n)return Dc;const s=[];return n.any_node.forEach(a=>{const c=i[a];c&&s.push(c)}),s.length===0&&o.length===0?Dc:[...s.map(({id:a})=>_(is,{id:a},a)),...o.map(a=>_(is,{id:a},a))]},lO=({wc_ids_by_type:e})=>{const t=Ae().getState();return kn(t,e==null?void 0:e.any_link).filter(ye).map(({id:i})=>_(H6,{id:i},i))},dO=()=>_(tO,{});const uO=e=>{const{ready_for_reading:t}=e.sync,{current_composed_knowledge_view:n}=e.derived;t&&!n&&console.log("No current_composed_knowledge_view");const{selected_wcomponent_ids_to_ordinal_position_map:i}=e.meta_wcomponents,{created_at_ms:o,sim_ms:s}=e.routing.args,r=[],a=[];return n&&(n.wc_ids_by_type.any_node.forEach(c=>{const l=e.specialised_objects.wcomponents_by_id[c];l&&r.push(l)}),n.wc_ids_by_type.any_link.forEach(c=>{const l=e.specialised_objects.wcomponents_by_id[c];ye(l)&&a.push(l)})),{ready:t,wcomponent_nodes:r,wcomponent_connections:a,presenting:e.display_options.consumption_formatting,selected_wcomponent_ids_to_ordinal_position_map:i,created_at_ms:o,sim_ms:s}},pO=P(uO);class mO{constructor(t,n){ke(this,"scale","months");ke(this,"single_time_units",this._ms(1,!1));ke(this,"scales",Object.keys(this.single_time_units));ke(this,"dates",[]);ke(this,"cdate",new Date);ke(this,"sdate",new Date);ke(this,"time_resolution","hour");ke(this,"timeline_spacing",!0);t.length!==0&&(this.time_resolution="day",this.scale=this.time_resolution+"s",this.cdate=new Date(n.created_at_ms),this.sdate=new Date(n.sim_ms),this.dates=t.sort((i,o)=>i.getTime()-o.getTime()))}_ms(t,n=!0){const i=n?(o,s)=>o/s:(o,s)=>o*s;return{milliseconds:t,get seconds(){return i(t,1e3)},get minutes(){return i(this.seconds,60)},get hours(){return i(this.minutes,60)},get days(){return i(this.hours,24)},get months(){return i(this.days,365/12)},get years(){return i(this.days,365)}}}get scale_index(){return this.scales.indexOf(this.scale)}increment(t,n=1,i=this.scale){const o=new Date(t.getTime()),s=this.get_date_prop_func_names(i);return Object(o)[s.set](Object(o)[s.get]()+n),o}get range_dates(){const t=[],n=this.round_date(this.increment(this.end_date,1),!0,this.scale),i=this.round_date(this.increment(this.start_date,-1),!1,this.scale);return t.push(i),t.push(n),t}get start_date(){const t=this.dates.first();return qo(t)}get end_date(){const t=this.dates.last();return qo(t)}get range_start_date(){const t=this.range_dates.first();return qo(t)}get range_end_date(){const t=this.range_dates.last();return qo(t)}get_date_offset_percent(t){let n=0;const i=t.getTime(),o=this.range_start_date.getTime(),s=this.range_end_date.getTime();return n=(i-o)/(s-o)*100,n}get_date_prop_func_names(t){let n,i=null;const o=t.charAt(0).toUpperCase()+t.slice(1),s=new Date,r=`get${o}`;switch(t){case"days":n="getDate";break;default:Object(s)[r]?n=r:Object(s)[r.replace(/s$/,"")]&&(n=r.replace(/s$/,""))}return n&&(i=n.replace(/^get/,"set")),{get:n,set:i}}round_date(t,n=!1,i=this.scale){const o=new Date(t.getTime());return this.scales.forEach((s,r)=>{const a=this.get_date_prop_func_names(s),c=s==="days"?1:0;n?r===this.scale_index?Object(o)[a.set](Object(o)[a.get]()+1):r<this.scale_index&&Object(o)[a.set](c):r<this.scale_index&&a.set&&Object(o)[a.set]&&Object(o)[a.set](c)}),n&&o.setTime(o.getTime()-1),o}render(t){if(t.length===0)return null;const n=new Date(this.range_start_date.getTime()),i=[];for(i.push(new Date(n.getTime()));n.getTime()<=this.range_end_date.getTime();){let s=this.get_date_prop_func_names(this.scale),r=Object(n)[s.get]();Object(n)[s.set](r+1),i.push(new Date(n.getTime()))}const o=this.timeline_spacing?`${100+i.length*1.42}%`:"100%";return _(I,{id:"knowledge_time_view",className:`time_view scroll_area_x ${this.scale} ${this.timeline_spacing?"timeline_spacing":"event_spacing"}`,flexGrow:1,flexShrink:1,position:"relative",onScroll:s=>{let a=s.target.scrollLeft,c=document.getElementsByClassName("wc");for(let l=0;l<c.length;l++){const d=c[l];d&&(d.style.marginLeft=`${a}px`)}},children:[_(I,{className:"timeline",display:this.timeline_spacing?"block":"none",height:1,maxHeight:1,position:"absolute",minWidth:o,width:o,maxWidth:o,top:0,right:"auto",bottom:0,left:0,zIndex:1,children:_(I,{width:1,maxWidth:1,height:1,maxHeight:1,display:"flex",flexDirection:"row",flexWrap:"wrap",children:i.map((s,r)=>_(I,{className:"unit",flexGrow:1,flexShrink:1,flexBasis:"auto",position:"relative",overflow:"visible",children:_(I,{position:"absolute",className:"tick",width:0,height:1,top:0,right:0,bottom:0,left:0,children:_(I,{className:"rotater",whiteSpace:"nowrap",children:[_(I,{component:"small",className:"days weeks months years",children:s.toLocaleDateString()}),_(I,{component:"small",className:"hours",children:s.toLocaleTimeString()})]})})}))})}),_(I,{minWidth:o,width:o,maxWidth:o,minHeight:1,height:1,maxHeight:1,overflow:"hidden",children:_(I,{className:"scroll_area_y",minWidth:"100%",maxWidth:"100%",position:"relative",zIndex:10,height:1,maxHeight:1,children:_(I,{className:"contents",mt:this.timeline_spacing?50:0,children:t.map(s=>{const r=On(s)?s.values_and_prediction_sets:[];return _(I,{width:1,maxWidth:1,overflow:"hidden",position:"relative",children:[_(I,{id:`WC-${s.id}`,className:"wc",display:"inline-block",position:"relative",top:0,children:_(is,{id:s.id,is_on_canvas:!1})}),_(I,{className:"vaps",width:1,maxWidth:1,overflow:"hidden",minHeight:"7em",height:"7em",maxHeight:"7em",p:this.timeline_spacing?0:3,position:"relative",display:`${this.timeline_spacing?"block":"flex"}`,flexDirection:"row",justifyContent:"start",children:r.map(a=>{const c=Tg(a);if(!c)return null;const l=this.get_date_offset_percent(c);return _(I,{className:"vap",flexGrow:0,flexShrink:1,flexBasis:"auto",display:"inline-block",border:1,minHeight:"100%",height:"100%",maxHeight:"100%",position:`${this.timeline_spacing?"absolute":"static"}`,zIndex:1,left:`${l}%`,children:_(Ud,{wcomponent:s,VAP_set:a})})})})]})})})})})]})}}function fO(e){let{wcomponent_nodes:t}=e;const{selected_wcomponent_ids_to_ordinal_position_map:n}=e,i=[];t=be(t,a=>{const c=n[a.id];return c!==void 0?c:ze(a)},ve.ascending),t.forEach(a=>{(On(a)?a.values_and_prediction_sets:[]).forEach(l=>{const d=Tg(l);d&&i.push(d)})});const r=new mO(i,e).render(t);return _(Rd,{main_content:r||_(I,{})})}const vO=pO(fO);function qo(e){return e instanceof Date?e:new Date}const hO=e=>{const{view:t}=e.routing.args,{display_by_simulated_time:n}=e.display_options;return{view:t,display_by_simulated_time:n}},gO=P(hO);function wO(e){let t=_("div",{children:["Unsupported view: ",e.view]});return e.view==="knowledge"?e.display_by_simulated_time?t=_(vO,{}):t=_(aO,{}):e.view==="actions_list"&&(t=_(w6,{})),t}const bO=gO(wO);function yO(){return kO(),D(!1),null}const kO=Pt(e=>({button:{display:"inline-block",marginRight:"1em",border:`1px ${e.palette.divider} solid`},icon:{position:"relative",zIndex:10}})),xO="2025-06-09";function SO(){return _("div",{children:[_("span",{className:"description_label",children:"Version"})," ",_("b",{children:xO})]})}function it(e){e.value;const{on_change:t}=e,n=e.disabled||!t;return _("input",{type:"checkbox",checked:e.value,disabled:n,style:{cursor:n?"not-allowed":""},onChange:i=>{if(!t)return;const o=i.currentTarget.checked;t(o)}})}function AO(){const e=Ki.get_state();return _(Re,{children:[_("b",{children:_(Rc,{show_label:!0})}),_("p",{className:"section",children:[_(Rc,{})," ",_("b",{children:["Enable Angular Connections ",_("span",{style:{position:"relative",top:"-0.5em"},children:["⌞",_("span",{style:{position:"relative",top:"0.8em",left:"-2px"},children:"⌝"})]})]}),_(it,{value:e.enable_angular_connections,on_change:t=>{Ki.set_state_and_reload_page({enable_angular_connections:t})}})]}),_("p",{className:"section",children:[_(Rc,{})," ",_("b",{children:"Enable actions kanban view"}),_(it,{value:e.enable_action_kanban_view,on_change:t=>{Ki.set_state_and_reload_page({enable_action_kanban_view:t})}})]})]})}function Rc(e){const t="Experimental feature.  May be changed or removed in the future.  Toggling an experimental feature on or off will reload the page.";return _(Ci,{warning:t,label:e.show_label?t:""})}const $O={second:!0,minute:!0,hour:!0,day:!0},CO=Object.keys($O),jO=e=>({time_resolution:e.display_options.time_resolution,display_by_simulated_time:e.display_options.display_by_simulated_time}),TO={set_time_resolution:S.display.set_time_resolution},PO=P(jO,TO);function NO(e){const t=Ed();return e.display_by_simulated_time?null:_(Dn,{disableElevation:!0,variant:"contained",children:IO.map(n=>_(Se,{value:n,onClick:()=>e.set_time_resolution({time_resolution:n}),className:t.inverse_disabled,disabled:e.time_resolution===n,children:n}))})}const EO=PO(NO),IO=CO.filter(e=>e!=="second"),DO=e=>({validity_filter:e.display_options.validity_filter,certainty_formatting:e.display_options.certainty_formatting,display_by_simulated_time:e.display_options.display_by_simulated_time,focused_mode:e.display_options.focused_mode,circular_links:e.display_options.circular_links,display_time_marks:e.display_options.display_time_marks,animate_connections:e.display_options.animate_connections,show_large_grid:e.display_options.show_large_grid,display_time_sliders:e.controls.display_time_sliders}),RO={set_validity_filter:S.display.set_validity_filter,set_certainty_formatting:S.display.set_certainty_formatting,set_display_by_simulated_time:S.display.set_display_by_simulated_time,set_or_toggle_focused_mode:S.display.set_or_toggle_focused_mode,set_or_toggle_circular_links:S.display.set_or_toggle_circular_links,set_display_time_marks:S.display.set_display_time_marks,set_or_toggle_animate_connections:S.display.set_or_toggle_animate_connections,set_or_toggle_show_large_grid:S.display.set_or_toggle_show_large_grid,set_display_time_sliders:S.controls.set_display_time_sliders},OO=P(DO,RO);function MO(e){const t=FO[e.validity_filter];return _("div",{className:"side_panel",children:[_("p",{className:"section",children:[_("b",{children:"Validity filter"}),_("br",{}),_("div",{style:{display:"inline-flex"},children:["Show:   ",_(de,{placeholder:"",options:VO,selected_option_id:e.validity_filter,allow_none:!1,on_change:n=>{n&&e.set_validity_filter({validity_filter:n})},editing_allowed:!0})]}),_("br",{}),_("div",{className:"description",children:[t.pre,_("br",{}),_("i",{children:["certainty ",t.condition]})," ",sh,"."]})]}),_("p",{className:"section",children:[_("b",{children:"Validity formatting"}),_("br",{}),_("div",{style:{display:"inline-flex"},children:["Opacity:   ",_(de,{placeholder:"",options:zO,selected_option_id:e.certainty_formatting,allow_none:!1,on_change:n=>{n&&e.set_certainty_formatting({certainty_formatting:n})},editing_allowed:!0})]}),_("br",{}),_("div",{className:"description",children:["Show nodes and connection opacity as ",_("i",{children:LO[e.certainty_formatting]})," ",sh,"."]})]}),_("p",{className:"section",children:[_("b",{children:"Time resolution"}),"  ",_(EO,{})]}),_("p",{className:"section",children:[_("b",{children:'Use "Focused" Mode'}),"  ",_(At,{...ae.toggle_focused}),_(it,{value:e.focused_mode,on_change:e.set_or_toggle_focused_mode})]}),_("p",{className:"section",children:[_("b",{children:"Show connections as more circular"}),"  ",_(At,{...ae.toggle_circular_connections}),_(it,{value:e.circular_links,on_change:e.set_or_toggle_circular_links})]}),_("p",{className:"section",children:[_("b",{children:"Animate connections"}),"  ",_(At,{...ae.toggle_animating}),_(it,{value:e.animate_connections,on_change:e.set_or_toggle_animate_connections})]}),_("p",{className:"section",children:[_("b",{children:"Show time markers"}),_(it,{value:e.display_time_marks,on_change:e.set_display_time_marks})]}),_("p",{className:"section",children:[_("b",{children:"Show large grid (whilst editing)"}),_(it,{value:e.show_large_grid,on_change:e.set_or_toggle_show_large_grid})]}),_("hr",{}),_(AO,{}),_("hr",{}),_("h3",{children:"Controls"}),_("p",{className:"section",children:[_("b",{children:'Display time sliders for "created at" and "simulated" time'}),"  ",_(At,{...ae.toggle_time}),_(it,{value:e.display_time_sliders,on_change:n=>{e.set_display_time_sliders(n)}})]})]})}const qO=OO(MO),sh="(certainty is the minimum of probability or confidence, e.g. something with 70% probability and 20% confidence is 20% certain)",VO=[{id:"only_certain_valid",title:"Only valid"},{id:"only_maybe_valid",title:"Only maybe Valid"},{id:"maybe_invalid",title:"Maybe Invalid"},{id:"show_invalid",title:"Invalid"}],Oc="Only show nodes and connections with validity",FO={only_certain_valid:{pre:Oc,condition:"100%"},only_maybe_valid:{pre:Oc,condition:"> 50%"},maybe_invalid:{pre:Oc,condition:"> 0%"},show_invalid:{pre:"Show all nodes and connections i.e. with validity",condition:">= 0%"}},zO=[{id:"render_certainty_as_opacity",title:"Use certainty"},{id:"render_certainty_as_easier_opacity",title:"Use certainty (opacity >= 50%)"},{id:"render_100_opacity",title:"Always 100%"}],LO={render_certainty_as_opacity:"proportional to certainty",render_certainty_as_easier_opacity:"proportional to certainty but no lower than 50% (easier to see)",render_100_opacity:"always 100% (no transparency)"};var Hd={},BO=Q;Object.defineProperty(Hd,"__esModule",{value:!0});var G0=Hd.default=void 0,UO=BO(Z()),WO=ee(),HO=(0,UO.default)((0,WO.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear");G0=Hd.default=HO;function GO(e){const{editing:t,option:n,on_remove_option:i,on_pointer_down_selected_option:o,on_mouse_over_option:s,on_mouse_leave_option:r}=e;return n?_(Dn,{size:"small",color:"primary",variant:"contained",fullWidth:!0,disableElevation:!0,style:{margin:5},children:[_(F,{onClick:()=>o&&o(n.id),disabled:!o,style:{cursor:o?"":"not-allowed",backgroundColor:n.color&&Tt(n.color),color:n.color&&Tt($0(n.color))},children:_(He,{title:n.jsx||n.title,children:_(se,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:n.jsx||n.title})})}),t&&_(ue,{onClick:()=>i(n.id),size:"small",children:_(G0,{})})]}):null}const KO=(e,t)=>({editable:t.editing_allowed!==void 0?t.editing_allowed:!e.display_options.consumption_formatting}),YO={change_route:S.routing.change_route},JO=P(KO,YO);function XO(e){const{editable:t,options:n,selected_option_ids:i}=e,{filtered_options:o,missing_options_by_id:s}=z(()=>{const a=n.filter(({id:l})=>!i.includes(l)),c={};if(a.length!==i.length){const l=new Set(a.map(({id:p})=>p));i.filter(p=>!l.has(p)).forEach(p=>{const f={id:p,title:"<Label Not found>"};c[p]=f,a.push(f)})}return{filtered_options:a,missing_options_by_id:c}},[n,i]),r=z(()=>{const a={...s};return n.forEach(c=>a[c.id]=c),a},[n,s]);return _(I,{width:"100%",children:[t&&_(de,{...e,selected_option_id:void 0,options:o,on_change:a=>{a!==void 0&&e.on_change([...i,a])},editing_allowed:t}),_("div",{style:{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden"},children:i.map(a=>_("div",{style:{flexGrow:1,flexShrink:1,flexBasis:"30%",maxWidth:"100%"},children:_(GO,{editing:t,option:r[a],on_remove_option:c=>{e.on_change(i.filter(l=>l!==c))},on_mouse_over_option:e.on_mouse_over_option,on_mouse_leave_option:e.on_mouse_leave_option,on_pointer_down_selected_option:c=>{e.change_route({item_id:c})}})}))})]})}const ZO=JO(XO);function gi(e){return _(ZO,{...e})}const QO=e=>({ready:e.sync.ready_for_reading,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:rt(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),eM={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent},tM=P(QO,eM);function nM(e){const{ready:t,label_ids:n=[]}=e;if(!t)return _("div",{children:"Loading labels..."});let i;e.allowed_label_ids&&(i=new Set(e.allowed_label_ids),n.forEach(s=>i==null?void 0:i.add(s)));const o=cn({allowed_wcomponent_ids:i,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _(gi,{placeholder:"Add Label",selected_option_ids:n,options:o,allow_none:!0,on_change:s=>{e.on_change(s.filter(r=>!!r))},on_mouse_over_option:s=>e.set_highlighted_wcomponent({id:s,highlighted:!0}),on_mouse_leave_option:s=>e.set_highlighted_wcomponent({id:s,highlighted:!1}),editing_allowed:e.editing_allowed})}const os=tM(nM),iM=e=>{var i;const{wc_label_ids:t,wc_types:n}=((i=e.derived.current_composed_knowledge_view)==null?void 0:i.available_filter_options)||{};return{wc_label_ids:t,wc_types:n,apply_filter:e.filter_context.apply_filter,filters:e.filter_context.filters,is_on_actions_list_view:ib(e)}},oM={set_apply_filter:S.filter_context.set_apply_filter,set_filters:S.filter_context.set_filters},sM=P(iM,oM);function rM(e){const{wc_label_ids:t,wc_types:n,filters:i}=e,o=z(()=>[...n||[]].concat(i.exclude_by_component_types).map(a=>({id:a,title:no(a)})),[n,i]),s=z(()=>[...n||[]].concat(i.include_by_component_types).map(a=>({id:a,title:no(a)})),[n,i]);return _("div",{children:[_("p",{children:["Enabled: ",_(it,{value:e.apply_filter,on_change:()=>e.set_apply_filter(!e.apply_filter)})]}),_("p",{children:["Filter by label:",_(os,{allowed_label_ids:t,label_ids:e.filters.include_by_label_ids,on_change:r=>{e.set_filters({filters:{...e.filters,include_by_label_ids:r}})},editing_allowed:!0})]}),_("p",{children:["Exclude by label:",_(os,{allowed_label_ids:t,label_ids:e.filters.exclude_by_label_ids,on_change:r=>{e.set_filters({filters:{...e.filters,exclude_by_label_ids:r}})},editing_allowed:!0})]}),_("p",{children:["Filter by component type:",_(gi,{placeholder:"",selected_option_ids:e.filters.include_by_component_types,options:s,allow_none:!0,on_change:r=>{e.set_filters({filters:{...e.filters,include_by_component_types:r}})},editing_allowed:!0})]}),_("p",{children:["Exclude by component type:",_(gi,{placeholder:"",selected_option_ids:e.filters.exclude_by_component_types,options:o,allow_none:!0,on_change:r=>{e.set_filters({filters:{...e.filters,exclude_by_component_types:r}})},editing_allowed:!0})]}),e.is_on_actions_list_view&&_(Re,{children:[_("br",{}),_("hr",{}),_("h3",{children:"Actions list filters"}),_("p",{children:["Filter by current knowledge view: ",_(it,{value:e.filters.filter_by_current_knowledge_view,on_change:()=>{const r={...e.filters,filter_by_current_knowledge_view:!e.filters.filter_by_current_knowledge_view};e.set_filters({filters:r})}})]}),_("p",{children:["Filter by text: ",_(Ge,{size:"small",placeholder:"",editing_allowed:!0,value:e.filters.filter_by_text,on_blur:r=>{const a={...e.filters,filter_by_text:r.trim()};e.set_filters({filters:a})},on_blur_type:K.conditional})]})]})]})}const _M=sM(rM),aM=["priority","normal","hidden","archived"];function jn(){return _("div",{className:"external_link_icon"})}const cM=e=>({bases_by_id:e.user_info.bases_by_id,chosen_base_id:e.user_info.chosen_base_id}),lM=P(cM);function dM(e){const t=e.base_id_to_move_to===void 0?void 0:`${e.base_id_to_move_to}`,n=Object.values(e.bases_by_id||{}).filter(i=>i.id!==e.chosen_base_id&&i.can_edit).map(i=>({id:`${i.id}`,title:i.title}));return _("div",{children:_(de,{selected_option_id:t,allow_none:!0,options:n,on_change:i=>{const o=i===void 0?void 0:parseInt(i);e.on_change(o)}})})}const uM=lM(dM),pM=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),mM=P(pM);function fM(e){const{wcomponents_move_conflicts:t,wcomponents_by_id:n,knowledge_views_by_id:i}=e,o=new Date().getTime(),s=o;return _("div",{children:Object.entries(t||{}).map(([r,a],c)=>{const l=n[r],d=l&&mt({wcomponent:l,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:void 0,created_at_ms:o,sim_ms:s})||r;return _("div",{children:[_(Le,{route:"wcomponents",sub_route:void 0,item_id:r,args:void 0,children:['Component "',_(vo,{children:d}),'" in:']}),_("ul",{children:a.map(p=>{const f=i[p.kv_id],m=(f==null?void 0:f.title)||p.kv_id,v=vi(p,!0);return _("li",{children:_(Le,{route:"wcomponents",sub_route:void 0,item_id:r,args:{subview_id:p.kv_id,...v},children:["    ",m]})})})})]},r)})})}const vM=mM(fM),hM=e=>({nested_knowledge_view_ids_map:e.derived.nested_knowledge_view_ids.map,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,chosen_base_id:e.user_info.chosen_base_id}),gM=P(hM);function wM(e){const{knowledge_view:t,nested_knowledge_view_ids_map:n,knowledge_views_by_id:i,wcomponents_by_id:o,chosen_base_id:s}=e,[r,a]=D(new Set),[c,l]=D(void 0),[d,p]=D(void 0),[f,m]=D(void 0);if(s===void 0)return _("div",{children:[_("h4",{children:"Change base of knowledge view"}),"Need to select a base first"]});if(!c)return _("div",{children:[_("h4",{children:"Change base of knowledge view"}),_(F,{value:"Check if safe to move",onClick:()=>{const{kv_ids_to_move:w,wc_ids_to_move:b,wcomponents_move_conflicts:g}=Db({root_knowledge_view_id_to_move:t.id,nested_knowledge_view_ids_map:n,knowledge_views_by_id:i,wcomponents_by_id:o});a(xt(w,b)),l(g)}})]});const v=Object.keys(c).length,h=r.size+v;return _("div",{children:[_("h4",{children:"Change base of knowledge view"}),v>0&&_("p",{children:["There are other knowledge views which are not nested under this knowledge view and that contain ",_("span",{style:{color:"darkred"},children:[v," components"]})," that are also in this knowledge view.  These entries can be moved to the new base or left assigned to this base.  All the nested knowledge views and their components will be moved regardless."]}),v>0&&_("p",{children:[_("i",{children:_("b",{children:[v," component(s) also present in other knowledge views:"]})}),_(vM,{wcomponents_move_conflicts:c})]}),v===0&&_("p",{children:[_("i",{children:_("b",{children:"Safe to move!"})}),"   All of the knowledge views and components in and nested under this knowledge view are contained in this knowledge view.  None of them are present in any other knowledge views that are not nested under this knowledge view."]}),_("p",{children:[_("i",{children:_("b",{children:"Step 2 of 3: Select base to move to"})}),_(uM,{base_id_to_move_to:d,on_change:w=>p(w)})]}),d!==void 0&&_("div",{children:[r.size!==h&&_(ns,{disabled:h===0,button_text:`Move all ${h} components to new base (including conflicted)`,on_click:()=>{const w=Array.from(r).concat(Object.keys(c));rh(w,s,d,m)}}),_(ns,{disabled:r.size===0,button_text:`Move ${r.size} components (no conflicts) to new base`,on_click:()=>{const w=Array.from(r);rh(w,s,d,m)}})]}),f&&_("p",{children:[f.error&&_("div",{style:{backgroundColor:"pink"},children:["Got error whilst trying to change base id of components ",_("br",{}),_("pre",{children:JSON.stringify(f.error,null,2)})]}),f.data&&_("div",{style:{backgroundColor:"lightgreen"},children:["Successfully changed base id of ",f.data," components & knowledge views.  Reloading page in ",K0," seconds"]})]})]})}const bM=gM(wM),K0=2;async function rh(e,t,n,i){const s=await Ce().rpc("move_ids_to_new_base",{ids:e,from_base_id:t,to_base_id:n});i(s),s.error||(on.debug("Reloading page after moving ids to new base"),setTimeout(()=>document.location.reload(),K0*1e3))}const yM=e=>({knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids_map:e.derived.nested_knowledge_view_ids.map}),kM=P(yM);function xM(e){const{placeholder:t,selected_option_id:n=void 0,allowed_ids:i,exclude_ids:o=new Set,on_change:s,knowledge_views:r,nested_knowledge_view_ids_map:a}=e,c=z(()=>SM(r,i,o).map(({id:d,title:p})=>{let f="",m=a[d];for(;m;)f=" / "+m.title+f,m=a[m.parent_id||""];return{id:d,title:p,subtitle:f}}).sort((d,p)=>d.title<p.title?-1:1),[r,i,o,a]);return _(de,{placeholder:t||"Select knowledge view...",allow_none:!0,selected_option_id:n,options:c,on_change:s,editing_allowed:e.editing_allowed})}const wo=kM(xM);function SM(e,t,n){let i=e;return t&&(i=i.filter(({id:o})=>t.has(o))),n.size&&(i=i.filter(({id:o})=>!n.has(o))),i}const AM=e=>({knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,editing:!e.display_options.consumption_formatting}),$M={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},CM=P(AM,$M);function jM(e){const{owner_knowledge_view:t,knowledge_views_by_id:n,on_change:i,editing:o}=e,s=t.foundation_knowledge_view_ids||[],r=new Set(s),a=[],c=[];s.forEach(m=>{const v=n[m];v?a.push(v):c.push(m)}),c.length&&console.warn(`Did not find foundational knowledge view ids: ${c.join(", ")}`);const l=new Set(r);l.add(t.id);const d=a.length,{parent_knowledge_view_id:p}=t,f=!!a.find(m=>m.id===p);return _("div",{children:[(o||a.length>0)&&"Foundational Views",o&&_("span",{children:["(",d,")"]}),o&&_(wo,{placeholder:"Search for knowledge view to add...",exclude_ids:l,on_change:m=>{m&&i([m,...s])}}),o&&p&&!f&&_(F,{value:"Use parent view as foundation",onClick:()=>i([p,...s])}),a.map((m,v)=>_("div",{style:{display:"flex",flexDirection:"row"},children:[_("div",{style:{flex:"1"},children:d-v}),_("div",{style:{flex:"9"},children:m.title}),_("div",{style:{flex:"3"},children:o&&_(F,{value:"remove",onClick:()=>{i(fs(s,h=>h===m.id))}})})]},m.id)),c.length>0&&_("div",{children:["Could not find ",c.length," knowledge views"]})]})}const TM=CM(jM),PM=(e,t)=>{const n=di(e,t.knowledge_view_id),{wcomponents_by_id:i,knowledge_views_by_id:o}=e.specialised_objects;return{knowledge_view:n,wcomponents_by_id:i,knowledge_views_by_id:o,editing:!e.display_options.consumption_formatting,is_current_kv:e.routing.args.subview_id===t.knowledge_view_id}},NM=P(PM);function EM(e){const{editing:t,knowledge_view:n,wcomponents_by_id:i,knowledge_views_by_id:o,on_change:s}=e,[r,a]=D(e.is_current_kv||e.show_automatically||!1);if(!n)return _("div",{});if(!r)return _(F,{value:"Calculate active assumptions",onClick:()=>a(!0)});const c=n.active_counterfactual_v2_ids||[],l=$t(n,o,!0),d=z(()=>{const p=at(l,i).composed_wc_id_map;return Object.keys(p).map(m=>i[m]).filter(me).filter(({type:m})=>m==="counterfactualv2").map(m=>({id:m.id,title:mt({wcomponent:m,text_type:fe.plain,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:void 0,created_at_ms:_h,sim_ms:_h})}))},[i,...l]);if(t){if(d.length===0)return _("div",{children:"No counterfactuals in composed knowledge view (includes foundational knowledge views)"})}else if(c.length===0)return _("div",{children:"No assumptions set"});return _("div",{children:_(gi,{placeholder:"...",allow_none:!0,selected_option_ids:c,options:d,on_change:s})})}const IM=NM(EM),_h=new Date().getTime()+1e11,DM=e=>{const{editing:t,knowledge_view:n}=e,i=$t(n,e.knowledge_views_by_id,!1),o=eb(i,!1),{datetime_line_config:s={}}=n,r=s.time_origin_ms??o.time_origin_ms,a=f=>{const m={...s,...f};e.update_item({...n,datetime_line_config:m})};if(r===void 0)return t?_("div",{children:[_("h4",{children:"Configure X Axis Datetime"}),_("p",{children:_(Ct,{title:"Time origin",value:void 0,on_change:f=>{const m=f?f.getTime():void 0;a({time_origin_ms:m})}})})]}):null;const c=Vo(s,o,"time_origin_x"),l=Vo(s,o,"time_scale"),d=Vo(s,o,"time_line_number"),p=Vo(s,o,"time_line_spacing_days");return _("div",{children:[_("h4",{children:"Configure X Axis Datetime"}),_("p",{children:_(Ct,{title:"Time origin",value:new Date(r),on_change:f=>{const m=f?f.getTime():void 0;a({time_origin_ms:m})}})}),_("p",{children:[_(ct,{placeholder:"Time origin position",value:c.value,allow_undefined:!0,on_blur:f=>{a({time_origin_x:f})},on_blur_type:K.conditional,style:{width:"70%"}}),t&&_(Fo,{source:c.source})]}),_("p",{children:[_(ct,{placeholder:"Time scale",value:l.value,allow_undefined:!0,on_blur:f=>{a({time_scale:f})},on_blur_type:K.conditional,style:{width:"70%"}}),t&&_(Fo,{source:l.source})]}),_("p",{children:[_(ct,{placeholder:"Time line number",value:d.value,allow_undefined:!0,on_blur:f=>{a({time_line_number:f})},on_blur_type:K.conditional,style:{width:"70%"}}),t&&_(Fo,{source:d.source})]}),_("p",{children:[_(ct,{placeholder:"Days between time line",value:p.value,allow_undefined:!0,on_blur:f=>{a({time_line_spacing_days:f})},on_blur_type:K.conditional,style:{width:"70%"}}),t&&_(Fo,{source:p.source})]}),t&&_("p",{children:_(F,{value:"Clear (to inherited or default to month)",fullWidth:!0,onClick:()=>{a({time_scale:void 0,time_line_number:void 0,time_line_spacing_days:void 0})}})}),t&&_("p",{style:{display:"flex",flexDirection:"row",justifyContent:"space-evenly",alignItems:"center"},children:[_("div",{children:"Defaults:"}),"  ",_(F,{value:"Week",fullWidth:!1,onClick:()=>{a({time_scale:3,time_line_number:8,time_line_spacing_days:7})}})," ",_(F,{value:"Month",fullWidth:!1,onClick:()=>{a({time_scale:Yi.time_scale,time_line_number:Yi.time_line_number,time_line_spacing_days:Yi.time_line_spacing_days})}})," ",_(F,{value:"Year",fullWidth:!1,onClick:()=>{a({time_scale:.3,time_line_number:2,time_line_spacing_days:365})}})]})]})};function Vo(e,t,n){const i=e[n]??t[n]??Yi[n],o=i===e[n]?0:i===t[n]?1:2;return{value:i,source:o}}function Fo(e){if(e.source===0)return null;const t=e.source===1?"Inherited from foundation":"Default";return _("div",{style:{color:"grey",fontSize:11},title:t,children:e.source===1?"(Inherited)":"(Default)"})}function Y0(e){const{items_descriptor:t,on_click_header:n,other_content:i=()=>null}=e;return _("div",{onClick:o=>{o.stopImmediatePropagation(),n&&n()},style:{cursor:n?"pointer":"default"},title:e.items_descriptor_title,children:[i(),_("div",{className:"item_descriptors",children:t}),_("div",{style:{clear:"both"}})]})}var J0=(e=>(e[e.collapsed=0]="collapsed",e[e.partial_expansion=1]="partial_expansion",e[e.expanded=2]="expanded",e))(J0||{});const RM=e=>({editing:!e.display_options.consumption_formatting}),OM=P(RM);function MM(e){const t=e.expanded_initial_state||(e.disable_collapsed?e.disable_partial_collapsed?2:1:0),[n,i]=D(t),o=n===2,{header_content:s=()=>null,content:r,items_count:a,item_descriptor:c,items_descriptor:l=ri(c,a,e.editing),items_descriptor_title:d,disable_partial_collapsed:p=!1}=e;function f(){let m=(n+1)%3;e.disable_collapsed&&m===0&&++m,p&&m===1&&++m,i(m)}return _("div",{children:[_(Y0,{items_descriptor:l,items_descriptor_title:d,on_click_header:f,other_content:s}),r({disable_partial_collapsed:p,expanded_items:n>0,expanded_item_rows:o})]})}const sn=OM(MM);function ri(e,t,n=!0){return(n||t!==void 0&&t!==0)&&(e+=` (${t})`),e}function Os(e){const{new_item_descriptor:t,on_pointer_down_new_list_entry:n}=e;return _("div",{children:_(F,{fullWidth:!0,onClick:i=>{i.stopImmediatePropagation(),n()},children:`New ${t}`})})}const qM=e=>({consumption_formatting:e.display_options.consumption_formatting}),VM=P(qM);function FM(e){const{items_count:t,item_descriptor:n,new_item_descriptor:i=n,consumption_formatting:o}=e;return _(sn,{header_content:()=>o?null:_(Os,{new_item_descriptor:i,on_pointer_down_new_list_entry:e.on_click_new_item}),content:e.content,items_count:t,items_descriptor:e.items_descriptor,item_descriptor:n,disable_collapsed:e.disable_collapsed,disable_partial_collapsed:e.disable_partial_collapsed,expanded_initial_state:e.expanded_initial_state})}const X0=VM(FM);var Gd={},zM=Q;Object.defineProperty(Gd,"__esModule",{value:!0});var Kd=Gd.default=void 0,LM=zM(Z()),BM=ee(),UM=(0,LM.default)((0,BM.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}),"Delete");Kd=Gd.default=UM;const WM=e=>({consumption_formatting:e.display_options.consumption_formatting}),HM=P(WM);function GM(e){return e.consumption_formatting?null:_(ns,{disabled:e.disabled,on_click:e.on_delete,button_text:e.button_text??"Delete",button_icon:_(Kd,{}),tooltip_text:e.tooltip_text})}const Tn=HM(GM);class Yd extends jh{constructor(t){super(t);const{calc_initial_custom_expansion_state:n}=t,i=n&&n(t.item),o=i!==void 0?i:!!t.expanded;this.state={internal__expanded:o}}componentDidUpdate(t,n){this.props.expanded!==t.expanded&&this.setState({internal__expanded:!!this.props.expanded})}render(){const{item:t,get_created_at:n,get_custom_created_at:i,set_custom_created_at:o=($,j)=>({...$,custom_created_at:j}),get_summary:s,get_details:r,get_details2:a,get_details3:c,crud:l,delete_button_text:d,hide_expansion_button:p}=this.props,{update_item:f,delete_item:m}=l,v=i?i(t):void 0,{internal__expanded:h}=this.state,w=h?"expanded":"",b=this.props.extra_class_names||"",g=`editable_list_entry ${w} ${b}`,k=z(()=>m&&(()=>m(t)),[m,t]),y=$=>{f(o(t,$))};return _("div",{className:g,children:[_("div",{className:"summary_header",children:[_("div",{className:"summary",children:s(t,l,h)}),!(p&&p(t))&&_("div",{className:"expansion_button",title:h?"Collapse":"Expand",onClick:()=>this.setState({internal__expanded:!h})})]}),h&&_(Re,{children:[r(t,l),_("div",{className:"details2",children:a&&a(t,l)}),_("div",{children:[k&&_(Tn,{on_delete:k,button_text:d}),_("br",{}),(n||i)&&_(ot,{children:_(Ct,{title:"Created at",invariant_value:n&&n(t),value:v,on_change:y})})]}),_("div",{className:"details3",children:c&&c(t,l)})]})]})}}function _i(e){const{items:t,get_id:n,item_props:i,debug_item_descriptor:o=""}=e;return r=>{const{expanded_items:a,expanded_item_rows:c}=r;return _("div",{style:{display:a?"":"none",cursor:"initial"},onClick:l=>l.stopPropagation(),children:t.map((l,d)=>_("div",{children:[_("hr",{className:"entries_horizontal_dividers"}),_(Yd,{item:l,...i,expanded:c})]},n(l)))})}}function Ri(e){const{parent_knowledge_view_id:t,knowledge_views:n,sort_type:i}=e;if(!e.editing&&n.length===0)return null;const o=_i({items:n,get_id:a=>a.id,item_props:{get_summary:KM(),get_details:t1(e),get_details3:YM,calc_initial_custom_expansion_state:XM(e),crud:{update_item:a=>{e.upsert_knowledge_view({knowledge_view:a})}}},debug_item_descriptor:"View"}),s=JM(e);if(i==="hidden"||i==="archived"||i==="errored")return _(sn,{items_count:n.length,content:o,item_descriptor:Wt(i)+" "+(e.item_descriptor||"View"),disable_collapsed:!1,expanded_initial_state:s});const r=(i==="priority"?"Priority ":"")+(e.item_descriptor||"View");return _(X0,{items_count:n.length,on_click_new_item:()=>{bA({knowledge_view:{title:e1(),parent_knowledge_view_id:t,sort_type:i}})},content:o,item_descriptor:r,disable_collapsed:!0,expanded_initial_state:s})}function KM(){const e="knowledge";return(t,n)=>_(Le,{route:void 0,sub_route:void 0,item_id:void 0,args:{view:e,subview_id:t.id},selected_on:new Set(["route","args.subview_id"]),children:t.title})}function YM(){return _("div",{children:[_("br",{}),_("br",{})]})}function JM(e){const{current_kv_parent_ids:t,knowledge_views:n,current_subview_id:i}=e;return!!n.find(({id:s})=>s===i||t.has(s))?J0.partial_expansion:void 0}function XM(e){return t=>e.current_kv_parent_ids.has(t.id)?!0:void 0}function Z0(e){const{priority:t,normal:n,hidden:i,archived:o,errored:s}=z(()=>{const r=[],a=[],c=[],l=[],d=[];return e.knowledge_views.forEach(p=>{const f=e.nested_knowledge_view_ids.map[p.id];(f==null?void 0:f.sort_type)==="errored"?d.push(p):p.sort_type==="hidden"?c.push(p):p.sort_type==="archived"?l.push(p):p.sort_type==="priority"?r.push(p):a.push(p)}),{priority:r,normal:a,hidden:c,archived:l,errored:d}},[e.knowledge_views]);return _("div",{children:[_("br",{}),_(Ri,{...e,knowledge_views:t,sort_type:"priority"}),_("br",{}),_(Ri,{...e,knowledge_views:n,sort_type:"normal"}),_("br",{}),_(Ri,{...e,knowledge_views:i,sort_type:"hidden"}),_("br",{}),_(Ri,{...e,knowledge_views:o,sort_type:"archived"}),_("br",{}),_(Ri,{...e,knowledge_views:s,sort_type:"errored"})]})}function Q0(e,t){const n=new Set;let i=e[t];for(;i&&i.parent_id;)n.add(i.parent_id),i=e[i.parent_id];return n}const e1=()=>as(!1),t1=e=>(t,n)=>{const{editing:i,nested_knowledge_view_ids:o}=e,s=o.map[t.id],r=((s==null?void 0:s.child_ids)||[]).map(v=>e.knowledge_views_by_id[v]).filter(me),a=!!e.wcomponents_by_id[t.id||""],c=t.base_id!==e.chosen_base_id,l=(e.bases_by_id||{})[t.base_id],d=e.current_subview_id===t.id,p=z(()=>new Set(e.possible_parent_knowledge_view_ids),[e.possible_parent_knowledge_view_ids]);let f="";s!=null&&s.ERROR_is_circular&&(f="Is circularly nested"),s!=null&&s.ERROR_parent_kv_missing&&(f="Parent knowledge view is missing (may be present in a different knowledge base)");let m="";return s!=null&&s.ERROR_parent_from_diff_base&&(m="Parent knowledge view from a different base"),_("div",{style:{backgroundColor:"white",border:"thin solid #aaa",borderRadius:3,padding:5,margin:5},children:[c&&_("div",{style:{cursor:"pointer"},onClick:()=>e.update_chosen_base_id({base_id:t.base_id}),title:`Click to change to base ${t.base_id}`,children:[_(_n,{message:""}),'  Is part of base "',l==null?void 0:l.title,'"']}),_("p",{style:{display:"inline-flex"},children:[_(Ge,{placeholder:"Title",value:t.title,on_blur:v=>{const h=e1();n.update_item({...t,title:v||h})},on_blur_type:K.conditional}),a&&_(Le,{route:"wcomponents",sub_route:void 0,item_id:t.id,args:void 0,children:[_(jn,{}),"Component"]}),!a&&i&&_("span",{style:{cursor:"pointer"},onClick:()=>{xi({wcomponent:{base_id:t.base_id,id:t.id,title:t.title,type:"statev2"}})},children:[_(jn,{}),"Create Component"]})]}),(i||t.description)&&_("p",{children:[i&&_("span",{className:"description_label",children:"Description"}),"  ",_(Cn,{placeholder:"...",value:t.description,on_blur:v=>{n.update_item({...t,description:v})},on_blur_type:K.conditional})]}),_("div",{children:[_("span",{className:"description_label",children:"Active assumptions (counterfactuals)"}),_(IM,{knowledge_view_id:t.id,on_change:v=>n.update_item({...t,active_counterfactual_v2_ids:v})})]}),_("p",{children:_(TM,{owner_knowledge_view:t,on_change:v=>{n.update_item({...t,foundation_knowledge_view_ids:v})}})}),(i||f||m)&&_("p",{children:[_("span",{className:"description_label",children:"Nest under"}),f&&_("div",{style:{backgroundColor:"pink"},children:[" ",f," "]}),m&&_("div",{children:[_(_n,{message:m})," ",m]}),_(wo,{selected_option_id:t.parent_knowledge_view_id,allowed_ids:p,on_change:v=>{n.update_item({...t,parent_knowledge_view_id:v})}})]}),i&&_("p",{children:[_("span",{className:"description_label",children:"Sort status"}),_(de,{selected_option_id:t.sort_type,options:aM.map(v=>({id:v,title:v})),allow_none:!1,on_change:v=>v&&n.update_item({...t,sort_type:v})})]}),_("hr",{}),i&&!d&&_("div",{children:[_(Le,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:t.id},children:"Change to this knowledge view"})," to edit datetime lines config and change the base."]}),i&&d&&_("div",{children:[_(DM,{editing:i,knowledge_view:t,knowledge_views_by_id:e.knowledge_views_by_id,update_item:n.update_item}),_("hr",{}),_(bM,{knowledge_view:t}),_("hr",{}),_("br",{})]}),(i||r.length>0)&&_("p",{children:_(Z0,{...e,parent_knowledge_view_id:t.id,knowledge_views:r,item_descriptor:"Nested"})}),_("br",{})]})},ZM=e=>{const t=Be(e);return{ready_for_reading:e.sync.ready_for_reading,knowledge_view:t,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids:e.derived.nested_knowledge_view_ids,editing:!e.display_options.consumption_formatting,current_view:e.routing.args.view,current_subview_id:e.routing.args.subview_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}},QM={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view,update_chosen_base_id:S.user_info.update_chosen_base_id},e8=P(ZM,QM);function t8(e){const{knowledge_view:t,upsert_knowledge_view:n}=e;if(!e.ready_for_reading)return _("div",{children:"Loading..."});if(!t)return _("div",{children:"No knowledge view selected"});const i=z(()=>e.knowledge_views.filter(a=>a.base_id===e.chosen_base_id).map(a=>a.id),[e.knowledge_views]),o=Q0(e.nested_knowledge_view_ids.map,e.current_subview_id),r={create_item:()=>{throw new Error("Not implemented create knowledge view")},update_item:a=>n({knowledge_view:a}),delete_item:()=>{throw new Error("Not implemented delete knowledge view")}};return t1({...e,possible_parent_knowledge_view_ids:i,current_kv_parent_ids:o,chosen_base_id:e.chosen_base_id,bases_by_id:e.bases_by_id,update_chosen_base_id:e.update_chosen_base_id})(t,r)}const n8=e8(t8),i8=e=>({ready:e.sync.ready_for_reading,knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids:e.derived.nested_knowledge_view_ids,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,current_view:e.routing.args.view,current_subview_id:e.routing.args.subview_id,editing:!e.display_options.consumption_formatting,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}),o8={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view,update_chosen_base_id:S.user_info.update_chosen_base_id},s8=P(i8,o8);function r8(e){if(e.knowledge_views.length===0)return _("div",{style:{cursor:"progress"},children:e.ready?"Automatically creating a knowledge view...":"Loading..."});const t=z(()=>e.knowledge_views.filter(o=>o.base_id===e.chosen_base_id).map(o=>o.id),[e.knowledge_views]),n=e.nested_knowledge_view_ids.top_ids.map(o=>e.knowledge_views_by_id[o]).filter(me),i=Q0(e.nested_knowledge_view_ids.map,e.current_subview_id);return _(Z0,{...e,parent_knowledge_view_id:void 0,knowledge_views:n,possible_parent_knowledge_view_ids:t,upsert_knowledge_view:e.upsert_knowledge_view,current_kv_parent_ids:i,chosen_base_id:e.chosen_base_id,bases_by_id:e.bases_by_id,update_chosen_base_id:e.update_chosen_base_id})}const _8=s8(r8);function a8(e){return _(I,{p:1,pt:5,class:"views_side_panel",children:["Current View:",_(n8,{}),_("br",{}),_("br",{}),_("br",{}),_("br",{}),_("br",{}),_(_8,{})]})}const c8={change_route:S.routing.change_route},l8=P(null,c8);function d8(e){return _(Zy,{on_change:t=>{t&&e.change_route({route:"wcomponents",item_id:t})},on_blur:()=>{e.change_route({route:"wcomponents"})}})}const u8=l8(d8);function p8(){const e=Ae();return _("div",{className:"side_panel",children:[_("p",{className:"section",children:[_(F,{value:"Expand towards causes (backwards)",fullWidth:!0,onClick:()=>Mw(e)}),_(At,{...ae.expand_select_backwards})]}),_("p",{className:"section",children:[_(F,{value:"Expand towards effects (forwards)",fullWidth:!0,onClick:()=>Ow(e)}),_(At,{...ae.expand_select_forwards})]}),_("p",{className:"section",children:[_(F,{value:"Select all components",fullWidth:!0,onClick:()=>Dl(e)}),_(At,{...ae.select_all})]}),_("p",{className:"section",children:[_(F,{value:"Expand selection (in all directions)",fullWidth:!0,onClick:()=>Dw(e)}),_(At,{...ae.expand_select})]}),_("p",{className:"section",children:[_(F,{value:"Contract selection (in all directions)",fullWidth:!0,onClick:()=>Rw(e)}),_(At,{...ae.decrease_select})]}),_("p",{className:"section",children:[_(F,{value:"Select components inbetween",fullWidth:!0,onClick:()=>Vw(e)}),_(At,{...ae.select_interconnections}),_("div",{className:"description",children:"Only selects the immediate components inbetween.  e.g. if A ---B--> C ---D--> E, then selecting nodes A and C followed by this command will also select connection B.  But if only node A and node E are selected, then this command will not do anything."})]})]})}const ah=()=>({r:255,g:255,b:255,a:1});function n1(e){const[t,n]=D(e.color||ah());re(()=>{n(e.color||ah())},[Tt(e.color)]);const i=s=>{const r=ch(t,s);n(r)},o=s=>{const r=ch(t,s);lh(t,r)&&n(r),lh(e.color,r)&&e.conditional_on_blur(r)};return _("div",{className:"color_picker",children:[_(ct,{placeholder:"r",value:t.r,allow_undefined:!1,conditional_on_change:s=>i({r:s}),on_blur:s=>o({r:s}),on_blur_type:K.always,style:{width:65}}),"  ",_(ct,{placeholder:"g",value:t.g,allow_undefined:!1,conditional_on_change:s=>i({g:s}),on_blur:s=>o({g:s}),on_blur_type:K.always,style:{width:65}}),"  ",_(ct,{placeholder:"b",value:t.b,allow_undefined:!1,conditional_on_change:s=>i({b:s}),on_blur:s=>o({b:s}),on_blur_type:K.always,style:{width:65}}),"  ",_(ct,{placeholder:"a",value:t.a,allow_undefined:!1,conditional_on_change:s=>i({a:s}),on_blur:s=>o({a:s}),on_blur_type:K.always,style:{width:65}}),"  ",_("div",{className:"color_swatch",style:{backgroundColor:Tt(t)}})]})}function ch(e,t){const n={...e,...t};return m8(n)}function m8(e){let{r:t,g:n,b:i,a:o}=e;return t=qe(t,0,255),n=qe(n,0,255),i=qe(i,0,255),o=qe(o,0,1),{r:t,g:n,b:i,a:o}}function lh(e,t){return e?Tt(e)!==Tt(t):!0}const f8=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),v8={change_route:S.routing.change_route},h8=P(f8,v8);function g8(e){const{wcomponent_id:t,wcomponents_by_id:n,knowledge_views_by_id:i}=e,[o,s]=D(!1),[r,a]=D([]);if(re(()=>{let d=[];o&&(d=Object.values(n).filter(p=>so(p)).filter(p=>p.title.includes(t)||p.description.includes(t)||(p.label_ids||[]).includes(t)||(Rn(p)||et(p))&&(p.parent_goal_or_action_ids||[]).includes(t)||ut(p)&&p.judgement_target_wcomponent_id===t||bi(p)&&p.values_and_prediction_sets.find(f=>f.entries.find(m=>(m.explanation||"").includes(t)))||wi(p)&&p.validity.find(f=>(f.explanation||"").includes(t))||ye(p)&&(p.from_id===t||p.to_id===t)||gt(p)&&p.attribute_wcomponent_id===t).filter(p=>p.id!==t)),a(d)},[t,n,o]),!o)return _("div",{children:_(F,{value:"Show back references",onClick:()=>s(!0)})});if(r.length===0)return _("div",{children:"No back references"});const c=new Date().getTime(),l=c;return _("div",{children:["Back references:",r.map(d=>_("div",{children:_(Le,{route:void 0,sub_route:void 0,item_id:d.id,args:void 0,children:_(vo,{children:mt({wcomponent:d,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:void 0,created_at_ms:c,sim_ms:l})||`No title for component ${d.id}`})})}))]})}const w8=h8(g8),b8=e=>{const t=_e(e),n=Be(e),i=t==null?void 0:t.composed_datetime_line_config;return{kv:n,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,created_at_ms:e.routing.args.created_at_ms,time_origin_ms:i==null?void 0:i.time_origin_ms,time_origin_x:i==null?void 0:i.time_origin_x,time_scale:i==null?void 0:i.time_scale}},y8={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},k8=P(b8,y8);function x8(e){const[t,n]=D(void 0),{kv:i,wcomponent_id:o,wcomponents_by_id:s,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l,upsert_knowledge_view:d}=e,p=(o?[o]:e.wcomponent_ids)||[],{id:f,wc_id_map:m}=i||{},v=!i||!f||m===void 0||a===void 0||c===void 0||l===void 0||!!o&&Ml({wcomponent_id:o,wcomponents_by_id:s,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l})===void 0,h=v?a===void 0?"Disabled as time origin not set":c===void 0?"Disabled as time origin X position is not set":"Diabled":"";let w="";return t!==void 0&&(t?p.length>1&&(w=`Changed ${t}`):w="No changes"),_("div",{style:{display:"inline-block"},children:[_(F,{disabled:v,value:"X by time",title:h,onClick:()=>{if(v)return;const{number_changed:b,knowledge_view:g}=A8({wcomponent_ids:p,wcomponents_by_id:s,kv:i,wc_id_map:m,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l});b&&g&&d({knowledge_view:g}),n(b),setTimeout(()=>n(void 0),1e3)}}),w]})}const S8=k8(x8);function A8(e){const{wcomponent_ids:t,wcomponents_by_id:n,kv:i,wc_id_map:o,created_at_ms:s,time_origin_ms:r,time_origin_x:a,time_scale:c}=e;let l=0;if(!i||!o||r===void 0||a===void 0||c===void 0)return{number_changed:l,knowledge_view:void 0};const d={...o};t.forEach(f=>{const m=o[f];if(!m)return;const v=Ml({wcomponent_id:f,wcomponents_by_id:n,created_at_ms:s,time_origin_ms:r,time_origin_x:a,time_scale:c});if(v===void 0)return;const h={...m,left:v};d[f]=h,l+=1});const p=l?{...i,wc_id_map:d}:void 0;return{number_changed:l,knowledge_view:p}}const $8=(e,t)=>{const n=Be(e),i=n==null?void 0:n.id,o=t.wcomponent_ids||[t.wcomponent_id],s=!!o.find(a=>e.derived.wcomponent_ids_by_type.any_node.has(a)),r=!!o.find(a=>e.derived.wcomponent_ids_by_type.any_link.has(a));return{knowledge_view_id:i,kv:n,wcomponent_node_present:s,wcomponent_link_present:r}},C8={snap_to_grid_knowledge_view_entries:S.specialised_object.snap_to_grid_knowledge_view_entries,bulk_add_to_knowledge_view:S.specialised_object.bulk_add_to_knowledge_view,bulk_update_knowledge_view_entries:S.specialised_object.bulk_update_knowledge_view_entries,change_current_knowledge_view_entries_order:S.specialised_object.change_current_knowledge_view_entries_order},j8=P($8,C8);function T8(e){const{wcomponent_id:t,knowledge_view_id:n,kv:i}=e,o=e.wcomponent_ids||[e.wcomponent_id],s=i&&t?Object.keys(i.wc_id_map).findIndex(l=>l===t):void 0,r=i?Object.keys(i.wc_id_map).length:void 0,a=s!==void 0&&s+1===r,c=s===0;return _("div",{children:[_("h3",{children:"Align"}),e.wcomponent_node_present&&_(Re,{children:[_(F,{disabled:!n,value:"Snap to grid",onClick:()=>{n&&e.snap_to_grid_knowledge_view_entries({wcomponent_ids:o,knowledge_view_id:n})}})," ",_(S8,{...e})," ",_(F,{disabled:!n,value:"Bring here",onClick:()=>{if(!n)return;const l=Ae().getState(),d=ki(l);e.bulk_add_to_knowledge_view({knowledge_view_id:n,wcomponent_ids:o,override_entry:d})}})]}),e.wcomponent_node_present&&e.wcomponent_link_present&&_("br",{}),e.wcomponent_link_present&&_(Re,{children:_(F,{disabled:!n,value:"Manually update link location",onClick:()=>{if(!n)return;const l=Ae().getState(),d=P8(o,l);d&&e.bulk_update_knowledge_view_entries({knowledge_view_id:n,changes:d})}})}),_("br",{}),_("span",{title:a?"Already at front":"Move to front",children:_(F,{value:"Move to front",disabled:a,onClick:()=>{e.change_current_knowledge_view_entries_order({wcomponent_ids:o,order:"front"})}})})," ",_("span",{title:c?"Already at back":"Move to back",children:_(F,{value:"Move to back",disabled:c,onClick:()=>{e.change_current_knowledge_view_entries_order({wcomponent_ids:o,order:"back"})}})})]})}const i1=j8(T8);function P8(e,t){const n=t.derived.current_composed_knowledge_view;if(n)return e.map(i=>pe(t,i)).filter(ye).map(i=>{const o=pe(t,i.from_id),s=pe(t,i.to_id),r=W0({wcomponent:i,from_wc:o,to_wc:s,current_composed_knowledge_view:n}),a=Oe({...r,end_size:1,line_behaviour:i.line_behaviour,circular_links:!0,connection_end_type:Bt.positive});if(!a)return;const c=p4({point1:{x:a.line_start_x,y:a.line_start_y},relative_control_point1:a.relative_control_point1,relative_control_point2:a.relative_control_point2,point2:{x:a.line_end_x,y:a.line_end_y}});return{wcomponent_id:i.id,left:c.x,top:-c.y}}).filter(i=>!!i)}const N8=(e,t)=>{const{wcomponent_id:n}=t,i=Be(e),o=i&&i.wc_id_map[n],s=e.derived.knowledge_views;return{knowledge_view_id:i&&i.id,knowledge_view_entry:o,all_knowledge_views:s}},E8=P(N8);function I8(e){const{knowledge_view_id:t,wcomponent_id:n,knowledge_view_entry:i}=e,o=e.all_knowledge_views.filter(({id:r})=>r!==t).filter(({wc_id_map:r})=>{const a=r[n];return a&&!a.blocked&&!a.passthrough});if(o.length===0)return null;const s=!i||i.blocked||i.passthrough;return _("div",{children:[s?"Present":"Also"," in:",o.map(r=>{const a=r.wc_id_map[e.wcomponent_id],c=vi(a,!0);return _("div",{children:_(Le,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:r.id,...c},children:r.title})})})]})}const o1=E8(I8),D8=(e,t)=>{const{wcomponent_id:n}=t,i=Be(e),o=i&&i.wc_id_map[n],s=_e(e),r=s&&s.composed_wc_id_map[n],a=ki(e);return{knowledge_view:i,composed_knowledge_view_entry:r,knowledge_view_entry:o,middle_position_left:a.left,middle_position_top:a.top,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id}},R8={upsert_knowledge_view_entry:S.specialised_object.upsert_knowledge_view_entry,bulk_remove_from_knowledge_view:S.specialised_object.bulk_remove_from_knowledge_view},O8=P(D8,R8);function M8(e){const{wcomponent_id:t,knowledge_view:n,composed_knowledge_view_entry:i,knowledge_view_entry:o,editing_allowed:s,knowledge_views_by_id:r,wcomponents_by_id:a}=e;if(!n)return null;const c=$t(n,r,!0),l=at(c,a),d=$t(n,r,!1),p=at(d,a),f=_l({editing_allowed:s,wcomponent_id:t,knowledge_view:n,composed_wc_id_maps_object:l,foundation_composed_wc_id_map:p.composed_wc_id_map}),{show_wcomponent_status_in_this_kv_section:m,wcomponent_status_in_this_kv_text:v,show_add_button:h,add_button_text:w,show_remove_button:b,remove_button_text:g,remove_button_tooltip:k,show_remove_and_block_button:y,remove_and_block_button_text:$,remove_and_block_button_tooltip:j}=f;function C(A,R={}){const M={...i||{left:e.middle_position_left,top:e.middle_position_top},...R};e.upsert_knowledge_view_entry({wcomponent_id:t,knowledge_view_id:A,entry:M})}const N=(o==null?void 0:o.frame_width)!==void 0&&o.frame_height!==void 0;return _("div",{children:[s&&o&&!o.blocked&&_(ot,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ai,{component:"legend",children:"Size"}),_(kh,{color:"secondary",defaultValue:1,marks:!0,min:.25,max:2,onChange:(A,R)=>{const M=Array.isArray(R)?R[0]:R;C(n.id,{s:M})},step:.25,value:o.s?o.s:1,valueLabelDisplay:"on"})]}),s&&o&&!o.blocked&&_(ot,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ai,{component:"legend",children:"Frame"}),_("p",{children:_(F,{value:N?"Remove Frame":"Add Frame",onClick:()=>{const A={};N?(A.frame_color=void 0,A.frame_width=void 0,A.frame_height=void 0):(A.frame_color=A.frame_color??ll,A.frame_width=A.frame_width??(pi+st)*2,A.frame_height=A.frame_height??(Sn+st)*2),C(n.id,A)}})}),_("span",{className:"description_label",children:"Frame Color"}),_(n1,{color:o.frame_color,conditional_on_blur:A=>{C(n.id,{frame_color:A})}})]}),s&&_("p",{children:[_(i1,{wcomponent_id:t}),_("br",{})]}),_("div",{style:{display:"inline-flex"},children:[_(u0,{wcomponent_id:t,disable_if_not_present:!0}),_(I,{zIndex:10,m:4,class:"node_handle",children:_(Bd,{wcomponent_id:t,wcomponent_current_kv_entry:i,is_highlighted:!0})})]}),m&&_("div",{children:[v,_("br",{}),h&&_(F,{value:w,onClick:()=>C(n.id,{blocked:void 0,passthrough:void 0})})]}),b&&_("p",{children:_(Tn,{button_text:g,tooltip_text:k,on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"passthrough"})}})}),y&&_("div",{children:_(Tn,{button_text:$,tooltip_text:j,on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"block"})}})}),s&&_("p",{children:["Add to knowledge view",_(wo,{on_change:A=>{A&&C(A,{blocked:void 0,passthrough:void 0})}})]}),_("p",{children:_(o1,{wcomponent_id:t})}),_("p",{children:_(w8,{wcomponent_id:t})})]})}const s1=O8(M8),q8=(e,t)=>{const n=Be(e),i=n&&n.wc_id_map[t.wcomponent_id];return{knowledge_view_title:n&&n.title,knowledge_view_entry:i,editing:!e.display_options.consumption_formatting}},V8={bulk_remove_from_knowledge_view:S.specialised_object.bulk_remove_from_knowledge_view},F8=P(q8,V8);function z8(e){const{wcomponent_id:t,knowledge_view_title:n,knowledge_view_entry:i,editing:o}=e;return _("div",{children:[_(s1,{wcomponent_id:t,editing_allowed:o}),o&&i&&!i.passthrough&&_("p",{children:_(Tn,{button_text:"Delete from knowledge view",tooltip_text:"Delete from current knowledge view ("+n+")",on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"passthrough"})}})}),_("p",{children:_(o1,{wcomponent_id:t})})]})}const L8=F8(z8);function B8(e,t){const n=t.type!==void 0&&t.type!==e.type;return e={...e,...t},{wcomponent:e,different_type:n}}const U8=(e,{wcomponent:t})=>{const n=_e(e),i=[];if(n){const{judgement:s,objective:r}=n.wc_ids_by_type,a=Array.from(xt(s,r));kn(e,a).forEach((c,l)=>{ut(c,a[l])&&i.push(c)})}const o=rt(e);return{consumption_formatting:e.display_options.consumption_formatting,filtered_wcomponents:i,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},W8={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent},H8=P(U8,W8);function G8(e){const{objective_ids:t=[]}=e.wcomponent;if(e.consumption_formatting&&t.length===0)return null;const n=cn({wcomponents:e.filtered_wcomponents,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _("div",{children:[_("p",{children:["Objectives",_(gi,{editing_allowed:e.editing_allowed,placeholder:"Objectives...",selected_option_ids:t,options:n,allow_none:!0,on_change:i=>e.upsert_wcomponent({objective_ids:i}),on_mouse_over_option:i=>e.set_highlighted_wcomponent({id:i,highlighted:!0}),on_mouse_leave_option:i=>e.set_highlighted_wcomponent({id:i,highlighted:!1})})]}),_("hr",{}),_("br",{})]})}const K8=H8(G8),Y8={"==":!0,"!=":!0,"<":!0,"<=":!0,">":!0,">=":!0},J8=Object.keys(Y8),X8={improving:!0,worsening:!0,stable:!0,unknown:!0,not_assessed:!0},Z8=Object.keys(X8);const Q8=e=>{var t;return{allowed_wcomponent_ids:(t=e.derived.current_composed_knowledge_view)==null?void 0:t.wc_ids_by_type.any_node,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:rt(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},eq={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent},tq=P(Q8,eq);function nq(e){const{connection_terminal_description:t,wcomponent_id:n,connection_terminal_type:i,allowed_wcomponent_ids:o,wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:a,on_update_id:c,on_update_type:l,set_highlighted_wcomponent:d}=e,p=n?s[n]:void 0,f=cn({wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:a,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms,exclude_ids:e.exclude_ids}),m=[{id:"validity",title:"Validity"},{id:"state",title:"State"},{id:"meta",title:"Meta"}];return _("div",{title:p&&p.title,className:"wcomponent_from_to",children:[_("span",{className:"description_label",children:[t,"  "]}),_(de,{placeholder:t+"...",selected_option_id:n,options:f,allow_none:!0,on_change:v=>c(v),on_mouse_over_option:v=>d({id:v,highlighted:!0}),on_mouse_leave_option:v=>d({id:v,highlighted:!1})}),n&&_(Le,{route:void 0,sub_route:void 0,item_id:n,args:void 0,children:_(jn,{})}),l&&_(de,{placeholder:"attribute...",selected_option_id:i,options:m,allow_none:!1,on_change:v=>l(v),on_mouse_over_option:v=>d({id:n,highlighted:!0}),on_mouse_leave_option:v=>d({id:n,highlighted:!1})})]})}const dl=tq(nq),iq=(e,{wcomponent:t})=>{const n=t.judgement_target_wcomponent_id,i=pe(e,n),o=ho(e,n);return{target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,is_editing:!e.display_options.consumption_formatting}},oq=P(iq);function sq(e){const{wcomponent:t,upsert_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r}=e,{judgement_manual:a,judgement_trend_manual:c}=t,l=a===void 0?void 0:a.toString(),d=Ly({judgement_wcomponent:t,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r}),f=oe(i,{});let m=[];if(f===E.boolean){const v=Ll(i,!0);m=[{id:"True",title:v.true},{id:"False",title:v.false}]}return _("p",{children:[_(dl,{connection_terminal_description:"Target",wcomponent_id:i&&i.id,connection_terminal_type:"meta",on_update_id:v=>{const h={judgement_target_wcomponent_id:v};!t.title&&v&&(h.title=Wt(t.type)+`: @@${v}`),n(h)}}),(e.is_editing||l!==void 0)&&_("p",{children:_("div",{style:{display:"inline-flex"},children:["Manual:   ",_(de,{placeholder:"Manual override...",allow_none:!0,selected_option_id:l,options:aq,on_change:v=>{n({judgement_manual:v===void 0?void 0:v==="true"})}})]})}),l===void 0&&_("p",{children:_("div",{style:{display:"inline-flex"},children:["Comparator:   ",_(de,{extra_styles:{width:30},placeholder:"Operator...",selected_option_id:t.judgement_operator,options:_q,on_change:v=>n({judgement_operator:v})})," ",f!==E.boolean&&_(Ge,{placeholder:"Value...",value:t.judgement_comparator_value||"",on_blur_type:K.conditional,on_blur:v=>{const h=v.trim();h!==t.judgement_comparator_value&&n({judgement_comparator_value:h})}}),f===E.boolean&&_(de,{placeholder:"Value...",selected_option_id:t.judgement_comparator_value,options:m,on_change:v=>{v&&v!==t.judgement_comparator_value&&n({judgement_comparator_value:v})}})]})}),(e.is_editing||c!==void 0&&c!=="not_assessed")&&_("p",{children:_("div",{style:{display:"inline-flex"},children:["Manual trend:   ",_(de,{placeholder:"Manual trend...",allow_none:!0,selected_option_id:c||"Not assessed",options:cq,on_change:v=>{n({judgement_trend_manual:v==="not_assessed"?void 0:v})}})]})}),_("p",{children:_("div",{style:{display:"inline-flex"},children:["Current value:   ",_(gd,{judgement:d,judgement_trend_manual:c,size:"medium"})]})})]})}const rq=oq(sq),_q=J8.map(e=>({id:e,title:e})),aq=[{id:"true",title:"Good"},{id:"false",title:"Bad"}],cq=Z8.map(e=>({id:e,title:Wt(e).replaceAll("_"," ")})),lq={boolean:!0,number:!0,other:!0},dq=Object.keys(lq),r1=jl.map(e=>({id:e,title:no(e)})),uq=dq.map(e=>({id:e,title:e}));function pq(e){const{wcomponent:t}=e;return _(_1,{effect_string:t.effect_string,effect_when_true:t.effect_when_true,effect_when_false:t.effect_when_false,editing:e.editing,wcomponents_by_id:e.wcomponents_by_id,upsert_wcomponent:e.upsert_wcomponent})}function _1(e){const{effect_string:t,effect_when_true:n,effect_when_false:i,editing:o,wcomponents_by_id:s,upsert_wcomponent:r}=e,a=z(()=>{if(!t)return;const m=H([{id:-1,name:"",value:t}],s)[0],v=m==null?void 0:m.value;return v!==void 0&&r({effect_when_true:v}),yy(m)},[t]),c=o||t!==void 0,l=n!==void 0,d=i!==void 0;return _("p",{style:{display:"flex",flexDirection:"column"},children:[c&&_("div",{children:[_("span",{className:"description_label",children:"Effect"}),"  ",_("div",{style:{display:"flex"},children:[a&&_(ky,{...a}),_(Ge,{placeholder:"",value:t||"",editing_allowed:o,on_blur:p=>r({effect_string:p}),on_blur_type:K.conditional})]})]}),l&&_("div",{children:[_("span",{className:"description_label",children:"Effect value"}),"  ",_("span",{children:n})]}),d&&_("div",{children:[_("span",{className:"description_label",children:"Effect value when false"}),"  ",_("span",{children:i}),o&&_(Re,{children:[" ",_("span",{className:"description_label",style:{cursor:"pointer",color:"#F99"},onClick:()=>r({effect_when_false:void 0}),children:"Field deprecated (click to remove)"})]})]})]})}function mq(e){const{wcomponent:t,editing:n,upsert_wcomponent:i}=e,{line_behaviour:o}=t;return _("div",{children:n&&_("p",{children:[_("span",{className:"description_label",children:"Line style behaviour"}),"  ",_(de,{selected_option_id:o,allow_none:!0,options:vq,on_change:s=>{i({line_behaviour:s})}})]})})}const fq=Ki.get_state(),vq=Hk.map(e=>({id:e,title:Wt(e)})).filter(e=>e.id!==ci.angular||fq.enable_angular_connections),hq=e=>{const t=Be(e),n=_e(e);return{knowledge_view:t,editing:!e.display_options.consumption_formatting,composed_wc_id_map:n&&n.composed_wc_id_map,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},gq={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},wq=P(hq,gq);function bq(e){const{wcomponent:t,upsert_wcomponent:n,wcomponents_by_id:i,knowledge_views_by_id:o,composed_wc_id_map:s,knowledge_view:r}=e;if(!s)return _("div",{children:"Counterfactual form can not render: No current knowledge view"});const a=Object.keys(s).map(h=>i[h]).filter(me).filter(Ke),c=cn({wcomponents:a,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:void 0,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}),l=i[t.target_wcomponent_id||""];let d=[],p=[];Ke(l)&&(d=l.values_and_prediction_sets||[],p=d.map(({id:h,datetime:w})=>{const b=ul(w,"minute");return{id:h,title:b}}));const f=oe(l,i),m=d.find(({id:h})=>h===t.target_VAP_set_id);let v=!1;return r&&(v=(r.active_counterfactual_v2_ids||[]).includes(t.id)),_("div",{children:[_("p",{children:[_("span",{className:"description_label",children:"Target component"}),"  ",t.target_wcomponent_id&&_(Le,{route:void 0,sub_route:void 0,item_id:t.target_wcomponent_id,args:void 0,children:[_(jn,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:t.target_wcomponent_id,options:c,on_change:h=>n({target_wcomponent_id:h,target_VAP_set_id:void 0,target_VAP_id:void 0}),on_mouse_over_option:h=>e.set_highlighted_wcomponent({id:h,highlighted:!0}),on_mouse_leave_option:h=>e.set_highlighted_wcomponent({id:h,highlighted:!1})})})]}),t.target_wcomponent_id&&_("p",{children:[_("span",{className:"description_label",children:"Target value and prediction set to override"}),"  ",_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:t.target_VAP_set_id,options:p,on_change:h=>{n({target_VAP_set_id:h,target_VAP_id:void 0})}})})]}),l&&m&&_("p",{children:[_("span",{className:"description_label",children:"Counterfactual value"}),"  ",go({VAP_set:m,VAPs_represent:f,wcomponent:l}).map(h=>{const{VAP_id:w,value_text:b}=h,g=w===t.target_VAP_id;return _("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:w,value:b,checked:g,onChange:()=>n({target_VAP_id:w})}),_("label",{for:w,children:b})]})})]}),r&&_("p",{children:[_("span",{className:"description_label",children:"Apply counterfactual in this knowledge view"}),"  ",_(it,{value:v,on_change:()=>{const{id:h}=t,w=lb(r.active_counterfactual_v2_ids||[],h),b={...r,active_counterfactual_v2_ids:w};e.upsert_knowledge_view({knowledge_view:b})}}),!m&&v&&_("span",{title:"Will not be applied yet, you need to target a component and one of its value sets",children:_(Ds,{})})]})]})}const yq=wq(bq);function Pn(e){const t=hi(e.value),{conditional_on_change:n,on_blur:i,on_blur_type:o=K.conditional,disabled:s}=e;if(!n&&!i||s){const r="editable_percentage"+(s?"disabled":""),a=e.value!==void 0;return _("div",{className:r,children:[a&&_("span",{className:"description_label",children:e.placeholder}),t||e.placeholder," %"]})}return _("div",{className:"editable_percentage",children:[_(Ge,{placeholder:e.placeholder,value:t,conditional_on_change:r=>{const a=dh(r);a!==void 0&&n&&n(a)},on_blur:r=>{const a=dh(r);a!==void 0&&i&&i(a)},on_blur_type:o})," %"]})}function dh(e){if(!e)return;const t=parseFloat(e);return Number.isNaN(t)?0:qe(t,0,100)/100}function kq(e){const{size:t,border_width:n,elements_width:i,conviction:o}=e,s=t/i;return _("g",{className:"conviction_mask",onMouseEnter:r=>r.currentTarget.classList.add("hovered"),onMouseLeave:r=>r.currentTarget.classList.remove("hovered"),ref:r=>{if(!r)return;const a=r.getElementsByClassName("parts")[0];Array.from(a.children).forEach(c=>{const l=c.getAttribute("data-group_id");if(!l)return;let p=parseInt(l,10)/100<=o?"display: none;":"";const f=130+Math.random()*45;p+=`fill: rgb(${f},${f},${f})`,c.setAttribute("style",p)})},children:[_("rect",{x:0,y:0,width:t+2,height:t+2,fill:"rgba(0,0,0,0)"}),_("g",{className:"parts",children:xq.map(r=>_("rect",{"data-group_id":r[2],x:n+r[0]*s,y:n+r[1]*s,width:s,height:s}))})]})}const xq=[[0,9,40],[0,8,30],[0,7,40],[0,6,90],[0,5,10],[0,4,95],[0,3,60],[0,2,60],[0,1,90],[0,0,40],[1,9,20],[1,8,50],[1,7,80],[1,6,60],[1,5,80],[1,4,90],[1,3,90],[1,2,30],[1,1,50],[1,0,30],[2,9,20],[2,8,50],[2,7,80],[2,6,40],[2,5,70],[2,4,20],[2,3,20],[2,2,50],[2,1,60],[2,0,40],[3,9,90],[3,8,50],[3,7,20],[3,6,30],[3,5,60],[3,4,50],[3,3,20],[3,2,2],[3,1,95],[3,0,10],[4,9,80],[4,8,30],[4,7,90],[4,6,60],[4,5,50],[4,4,100],[4,3,40],[4,2,70],[4,1,30],[4,0,98],[5,9,20],[5,8,40],[5,7,70],[5,6,50],[5,5,70],[5,4,90],[5,3,50],[5,2,70],[5,1,10],[5,0,80],[6,9,20],[6,8,5],[6,7,30],[6,6,50],[6,5,70],[6,4,100],[6,3,20],[6,2,90],[6,1,60],[6,0,60],[7,9,30],[7,8,70],[7,7,80],[7,6,70],[7,5,20],[7,4,10],[7,3,30],[7,2,98],[7,1,98],[7,0,90],[8,9,5],[8,8,60],[8,7,95],[8,6,70],[8,5,70],[8,4,80],[8,3,95],[8,2,40],[8,1,95],[8,0,2],[9,9,40],[9,8,40],[9,7,80],[9,6,80],[9,5,90],[9,4,10],[9,3,5],[9,2,60],[9,1,80],[9,0,30]];function a1(e){const{size:t,elements_width:n=10}=e,i=n*n,o=t/n,{counterfactual_probability:s,counterfactual_conviction:r,set_counterfactual:a}=e,c=zo(s)||zo(r),{probability:l,conviction:d}=Sq(e),p=zo(s)?s:l,f=zo(r)?r:d;function m(){if(!a)return;const g=Pe({probability:l,conviction:d,counterfactual_probability:s,counterfactual_conviction:r});a({probability:g.new_counterfactual_probability,conviction:g.new_counterfactual_conviction})}const v=3,w=`prediction_badge ${`counterfactual_${c?"":"in"}active`}`,b="Visual display of probability and confidence";return _("div",{style:{cursor:e.disabled?"not-allowed":"pointer"},title:b,children:_("svg",{width:t+v*2,height:t+v*2,onClick:()=>!e.disabled&&m(),className:w,children:[_("rect",{x:0,y:0,width:t+v*2,height:t+v*2,className:"outline"}),_("g",{children:Array.from(Array(i)).map((g,k)=>{const y=k/i,$=k%n,j=Math.floor(k/n);return{i:k,i_frac:y,x:$,y:j,ys:v+(n-1-$)*o,xs:v+j*o}}).map(g=>{const $=(g.i_frac<p?0:1)*255;return{...g,fill:`rgb(${$},${$},${$})`}}).map(g=>_("rect",{x:g.xs,y:g.ys,width:o,height:o,fill:g.fill}))}),_(kq,{size:t,border_width:v,elements_width:n,conviction:f})]})})}function Sq({probability:e,conviction:t}){const n=qe(e,0,1),i=qe(t,0,1);return n!==e&&console.error(`probability: ${e} not in range 0 to 1`),i!==t&&console.error(`conviction: ${t} not in range 0 to 1`),{probability:n,conviction:i}}function zo(e){return Number.isFinite(e)}const Aq=e=>({show_unused_fields:!e.display_options.consumption_formatting}),$q=P(Aq);function Cq(e){const{datetime:t,on_change:n,show_unused_fields:i}=e;return _("div",{className:"datetimes",children:[t.min&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(Ct,{title:"Minimum datetime",value:t.min,on_change:o=>n({...t,min:o})})})}),(i||t.value)&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(Ct,{title:"Expected datetime",value:t.value,on_change:o=>n({...t,value:o})})})}),t.max&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(Ct,{title:"Maximum datetime",value:t.max,on_change:o=>n({...t,max:o})})})})]})}const Jd=$q(Cq),jq=e=>({editing:!e.display_options.consumption_formatting,base_id:pt(e)}),Tq=P(jq);function Pq(e){const{wcomponent:t,upsert_wcomponent:n,base_id:i}=e,o=t.event_at&&t.event_at[0],s=r=>{const a={event_at:[{probability:1,conviction:1,datetime:{},id:"",base_id:i||-1,explanation:"",...o||{...ro()},...r}]};n(a)};return _("p",{children:[_(Jd,{datetime:o?o.datetime:{},on_change:r=>s({datetime:r})}),_("br",{}),_("div",{style:{display:"inline-flex"},children:[_(Pn,{placeholder:"Probability",value:o==null?void 0:o.probability,on_blur:r=>s({probability:r}),on_blur_type:K.conditional}),_(Pn,{placeholder:"Confidence",value:o==null?void 0:o.conviction,on_blur:r=>s({conviction:r}),on_blur_type:K.conditional}),"  ",o&&_(a1,{disabled:!0,size:20,probability:o.probability,conviction:o.conviction})]}),_("br",{}),_("br",{}),e.editing&&_(F,{fullWidth:!0,value:o?"Clear Event":"Create Default Event",onClick:()=>{o?n({event_at:[]}):s({conviction:1,probability:1})}})]})}const Nq=Tq(Pq);function Eq(e){const{wcomponent:t,upsert_wcomponent:n}=e,i=t.summary_image||void 0;return _(In,{fullWidth:!0,label:"Summary Image URL",onChange:o=>{const s=o.currentTarget.value;n({summary_image:s})},value:i,variant:"outlined"})}const Iq=e=>{var t;return{current_kv_id:(t=Be(e))==null?void 0:t.id,goal_or_action_wcomponent_ids:e.derived.wcomponent_ids_by_type.goal_or_action,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,is_editing:!e.display_options.consumption_formatting,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},Dq=P(Iq);function Rq(e){const{wcomponent:t,wcomponents_by_id:n,upsert_wcomponent:i}=e,o=z(()=>{const r=Array.from(e.goal_or_action_wcomponent_ids).map(c=>n[c]).filter(me);function a(c){return c.id===e.current_kv_id?new Date().getTime():c.created_at.getTime()}return be(r,a,ve.descending)},[e.goal_or_action_wcomponent_ids,n,e.current_kv_id]),s=cn({wcomponents:o,wcomponents_by_id:n,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:{},created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _(ot,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ai,{component:"legend",children:"Parent Goal (or Action)"}),_(gi,{placeholder:"Add Label",selected_option_ids:t.parent_goal_or_action_ids||[],options:s,allow_none:!0,on_change:r=>{const a=r.filter(c=>!!c);i({parent_goal_or_action_ids:a})}})]})}const Oq=Dq(Rq),Mq=e=>({editing:!e.display_options.consumption_formatting,wcomponents_by_id:e.derived.composed_wcomponents_by_id}),qq={},Vq=P(Mq,qq);function Fq(e){const{wcomponent:t,wcomponents_by_id:n}=e,{calculations:i=[]}=t;i.forEach((p,f)=>p.id=p.id??f);const[o,s]=D(i.length>0),r={};i.forEach(p=>r[p.id]=!1);const[a,c]=D(r),l=H(i,n),d=i.map(({name:p})=>p);return _("div",{className:"editable_list_entry padded "+(o?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>s(!o),children:[_("div",{className:"summary",children:[_("h4",{style:{display:"inline-block"},children:["Calculations ",!o&&i.length?`(${i.length})`:""]}),_("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:_(Ci,{warning:"",label:""})})]}),_("div",{className:"expansion_button"})]}),o&&_("div",{children:[_(I,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map((p,f)=>_(c9,{editing:e.editing,show_options:a[p.id]||!1,set_show_options:m=>{const v={...a,[p.id]:m};c(v)},calculation:p,calculation_result:l[f],existing_calculation_name_ids:d,update_calculation:m=>{const h=[...i.slice(0,f),m,...i.slice(f+1)].filter(b=>!!b),w=h.length?h:void 0;e.upsert_wcomponent({calculations:w})},disallowed_commands:(()=>{const m=new Set;return f===0&&m.add("move_up"),f===i.length-1&&m.add("move_down"),m})(),update_calculations:m=>{if(m==="move_up"){const v=f-1;if(!St(i,v))return;const h=yt(i,f,v);e.upsert_wcomponent({calculations:h})}else if(m==="move_down"){const v=f+1;if(!St(i,v))return;const h=yt(i,f,v);e.upsert_wcomponent({calculations:h})}else if(m==="add_above"){const v=Mc(i),h=kt(i,v,f);e.upsert_wcomponent({calculations:h})}else if(m==="add_below"){const v=Mc(i),h=kt(i,v,f+1);e.upsert_wcomponent({calculations:h})}}},p.id))}),e.editing&&_(F,{value:"Add calculation",fullWidth:!0,onClick:()=>{const p=Mc(i),f=[...i,p];e.upsert_wcomponent({calculations:f})}})]})]})}const zq=Vq(Fq);function Mc(e){let t=-1;e.forEach(o=>t=Math.max(t,o.id)),++t;const n=wn(e.map(({name:o})=>o));return{id:t,name:n,value:""}}function Lq(e){const t=yl(e);return{id:ml(),value:"",description:"",order:t+1}}function Bq(e){const{editing:t,value_possibility:n,count_of_value_possibilities:i,update_value_possibility:o}=e,[s,r]=D(n.value);re(()=>r(n.value),[n.value]);const c=(i[s.toLowerCase()]||0)>1?`Current value "${s}" is already present in other possible values.`:"";return _(I,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",style:{display:"flex"},children:[_(I,{style:{width:"100%"},children:[_(Ci,{warning:c,label:"Duplicate"}),_(se,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:_(Ge,{placeholder:"Possible value",hide_label:!0,value:n.value,conditional_on_change:l=>r(l),on_blur:l=>{o({...n,value:l})},on_blur_type:K.conditional})})]}),Kc[n.id]&&_(I,{style:{width:100,color:"#cb4",cursor:"pointer"},title:"Using interoperable ID",children:Kc[n.id]}),t&&_(ue,{onClick:()=>o(void 0),size:"large",children:_(Kd,{})})]},e.value_possibility.id)}function Uq(e){const[t,n]=D(!1);if(e.VAPs_represent===E.undefined)return null;const i=Hq(e.value_possibilities),{count_of_value_possibilities:o,max_count:s}=Wq(i),r=s>1?"Duplicate value possibilities present":"",a=`editable_list_entry padded ${t?"expanded":""}`,{attribute_wcomponent:c}=e;return _("div",{className:a,children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>n(!t),children:[_("div",{className:"summary",children:[_("h4",{style:{display:"inline-block"},children:["Possible Values ",!t&&i.length?`(${i.length})`:""]}),_("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:_(Ci,{warning:r,label:""})})]}),_("div",{className:"expansion_button"})]}),t&&_("div",{children:[_(I,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map(l=>_(Bq,{editing:e.editing,value_possibility:l,count_of_value_possibilities:o,update_value_possibility:d=>{const p={...e.value_possibilities};d?p[d.id]=d:delete p[l.id];const f=Object.keys(p).length>0;e.update_value_possibilities(f?p:void 0)}}))}),e.editing&&_(F,{value:"New possibility",fullWidth:!0,onClick:()=>{const l=Lq(e.value_possibilities),d={...e.value_possibilities,[l.id]:l};e.update_value_possibilities(d)}}),e.editing&&_(F,{value:"Use defaults",fullWidth:!0,onClick:()=>{const l=yn(e.VAPs_represent,void 0,e.values_and_prediction_sets),d=rn(l,"default_possible_values");e.update_value_possibilities(d)}}),e.editing&&c&&Qe(c)&&_(F,{value:"Use attribute's possibilities",fullWidth:!0,onClick:()=>{const l=yn(e.VAPs_represent,c.value_possibilities,c.values_and_prediction_sets||[]),d=rn(l,"attribute's possible_values");e.update_value_possibilities(d)}})]})]})}function Wq(e){const t={};let n=0;return e.forEach(({value:i})=>{i=i.toLowerCase();const o=(t[i]||0)+1;t[i]=o,n=Math.max(n,o)}),{count_of_value_possibilities:t,max_count:n}}function Hq(e){return Object.values(e||{}).sort((t,n)=>t.order<n.order?-1:1)}const Gq=(e,t)=>({created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:t.editing_allowed??!e.display_options.consumption_formatting,current_created_at_ms:e.routing.args.created_at_ms}),Kq={change_route:S.routing.change_route},Yq=P(Gq,Kq);function Jq(e){var C;const{existing_value_possibilities:t,values_and_prediction_sets:n,VAPs_represent:i,base_id:o,editing:s,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l}=e;if(!s||i!==E.action)return null;const{latest:d}=ls(n),f=ps(d)[0],m=(C=f==null?void 0:f.entries.find(N=>N.probability===1))==null?void 0:C.value_id,v=m===$e.action_potential,h=m===$e.action_paused,w=m===$e.action_in_progress,b=m===$e.action_completed,g=!f||v||h,k=b,y=w,$=!f||w;function j(N){const A=cl({existing_value_possibilities:t,orig_values_and_prediction_sets:n,base_id:o,action_value_possibility_id:N});k0({existing_value_possibilities:t,new_values_and_prediction_sets:A,orig_values_and_prediction_sets:n,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l})}return _("div",{children:[(g||k)&&_(F,{value:k?"Restart (In Progress)":"In Progress",fullWidth:!0,color:"secondary",onClick:()=>j($e.action_in_progress)}),y&&_(F,{value:"Pause",fullWidth:!0,color:"secondary",onClick:()=>j($e.action_paused)}),$&&_(F,{value:"Completed",fullWidth:!0,color:"secondary",onClick:()=>j($e.action_completed)})]})}const Xq=Yq(Jq);function c1(e){const{new_item:t,set_new_item:n,item_descriptor:i,item_props:o}=e,{crud:s}=o,r=z(()=>({...s,update_item:n}),[s,n]);return t?_(I,{children:_(G1,{"aria-labelledby":"new_item_title",open:!0,onClose:()=>n(void 0),fullWidth:!0,maxWidth:"sm",children:[_(K1,{id:"new_item_title",children:["New ",i]}),_(Y1,{children:_(Yd,{item:t,...o,expanded:!0,crud:r})}),_(J1,{children:[_(F,{onClick:()=>{setTimeout(()=>s.create_item(t),0)},children:["Add ",i]}),_(F,{onClick:()=>n(void 0),children:"Cancel"})]})]})}):null}function Zq(e,t){const n=ws(e.entries,t),i=n[0];if(t===E.boolean&&i)return _(Re,{children:i.probability>.5?"True":"False"});const o=t===E.number,s=n.filter(({probability:r})=>r>0);return _(Re,{children:[s.map((r,a)=>_("span",{children:[o?_(Qq,{value:r.value}):r.value,a<s.length-1&&", "]},a)),s.length===0&&"-"]})}function Qq(e){return Ne(e.value)?_(Re,{children:e.value}):_("span",{style:{borderRadius:5,border:"thin solid #999",padding:"2px 3px 0px 3px"},children:[_(_n,{message:"Number is invalid",backgroundColor:"white"}),e.value]})}function eV(e,t){const n=ws(e.entries,t),i=n[0];return t===E.boolean&&i?hi(i.probability):n.filter(({probability:s})=>s>0).map(s=>hi(s.probability)).join(", ")}function tV(e,t){const n=ws(e.entries,t),i=n[0];if(t===E.boolean&&i)return hi(i.conviction);const o=n.filter(({probability:a})=>a>0),s=new Set;o.forEach(({conviction:a})=>s.add(a));const r=s.size<=1;return o.slice(0,r?1:void 0).map(a=>hi(a.conviction)).join(", ")}var Xd={},nV=Q;Object.defineProperty(Xd,"__esModule",{value:!0});var Ho=Xd.default=void 0,iV=nV(Z()),oV=ee(),sV=(0,iV.default)((0,oV.jsx)("path",{d:"M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5zm-1 4h-2.19l2 2H16zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3 2 4.27z"}),"LinkOff");Ho=Xd.default=sV;const rV="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM19 12h-2v3h-3v2h3v3h2v-3h3v-2h-3z";function _V(e){return _(Et,{...e,d:rV})}const aV="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1z M16 18.17 14.33 16.5l-1.42 1.41L16 21 21.0 15.8l-1.41-1.41z";function cV(e){return _(Et,{...e,d:aV})}function lV(e){const{editing:t,VAP:n,value_possibilities:i,update_VAP:o}=e,s=z(()=>wy(e.value_possibilities,!0),[e.value_possibilities]);if(i===void 0)return _("span",{title:"Need to first add value possibilities to link to.",className:"possible_value_link disabled",children:_(Ho,{})});if(!!i[n.value_id||""])return _("span",{title:"Linked to possible value.  Click to unlink.",className:"possible_value_link "+(t?"clickable":"disabled"),onClick:()=>{const c={...n};delete c.value_id,o(c)},children:[_(cV,{className:"hide_on_hover"}),_(Ho,{className:"show_on_hover"})]});const a=s[n.value.toLowerCase()];return a?_("span",{title:"Linkable to value possibility.  Click to link.",className:"possible_value_link "+(t?"clickable":"disabled"),onClick:()=>{const l=i[a.id].description||n.description,d={...n,value_id:a.id,description:l};o(d)},children:_(_V,{})}):_("span",{title:"No matching value possibility to link to.",className:"possible_value_link disabled",children:_(Ho,{})})}const dV=e=>({editing:!e.display_options.consumption_formatting}),uV=P(dV);function pV(e){const{editing:t,value_possibilities:n,VAPs_represent:i}=e,o=e.values_and_predictions,s=i===E.boolean&&o.length>=1?"only_one_VAP":"",r=i===E.number,a={get_summary:fV({value_possibilities:n,VAPs_represent:i,editing:t}),get_details:vV(i,t),extra_class_names:"value_and_prediction",crud:{update_item:l=>{const d=Oi(l),p=ql(o,l,f=>Oi(f)===d);e.update_values_and_predictions(p)},delete_item:l=>{const d=Oi(l),p=fs(o,f=>Oi(f)===d);e.update_values_and_predictions(p)}},delete_button_text:"Delete Value & Prediction",hide_expansion_button:l=>!t&&!l.description&&!l.source&&(!r||!l.min&&!l.max),calc_initial_custom_expansion_state:l=>!!(l.description||l.source||r&&(l.min||l.max))},c="Value and prediction";return _("div",{className:`value_and_predictions ${s}`,children:[_(Y0,{items_descriptor:ri(c,o.length),other_content:()=>!t||i===E.boolean?null:_(Os,{new_item_descriptor:c,on_pointer_down_new_list_entry:()=>{const l=[...o,Me()];e.update_values_and_predictions(l)}})}),_i({items:o,get_id:Oi,item_props:a,debug_item_descriptor:c})({expanded_item_rows:!1,expanded_items:!0,disable_partial_collapsed:!1})]})}const mV=uV(pV),Oi=e=>e.id,fV=e=>(t,n,i)=>{const{value_possibilities:o,VAPs_represent:s,editing:r}=e,{probability:a,relative_probability:c,conviction:l,min:d,value:p,max:f}=t,m=s===E.boolean,v=s===E.number,h=c!==void 0,w=h&&!m,b=!h||m;return _("div",{className:"value_and_prediction_summary",children:[_("br",{}),_("div",{className:"temporal_uncertainty",children:[v&&(r&&i||d)&&_("div",{children:[_(qc,{value:d}),_(Ge,{placeholder:"Min",value:d||"",modify_value_pre_on_blur:g=>g.trim(),on_blur:g=>n.update_item({...t,min:g}),on_blur_type:K.conditional}),_("br",{})]},"min"),(r||p)&&_("div",{style:{position:"relative"},children:[v&&_(qc,{value:p}),_(Ge,{disabled:m,placeholder:"Value",value:m?a>.5?"True":"False":p,modify_value_pre_on_blur:g=>g.trim(),on_blur:g=>n.update_item({...t,value:g}),on_blur_type:K.conditional}),!v&&!m&&_("div",{style:{position:"absolute",right:"-25px",top:"15px"},children:_(lV,{editing:r,VAP:t,value_possibilities:o,update_VAP:g=>n.update_item(g)})}),_("br",{})]},"value"),v&&(r&&i||f)&&_("div",{children:[_(qc,{value:f}),_(Ge,{placeholder:"Max",value:f||"",modify_value_pre_on_blur:g=>g.trim(),on_blur:g=>n.update_item({...t,max:g}),on_blur_type:K.conditional}),_("br",{})]},"max")]}),_("div",{className:"predictions",children:[m&&_("div",{className:w?"disabled":"",children:_(Pn,{disabled:w,placeholder:"Probability",value:a,on_blur:g=>{n.update_item({...t,probability:g})},on_blur_type:K.conditional})}),m&&_("div",{children:_(Pn,{placeholder:"Confidence",value:l,on_blur:g=>n.update_item({...t,conviction:g}),on_blur_type:K.conditional})}),!m&&c!==void 0&&_("div",{className:b?"disabled":"",children:_(ct,{disabled:b,placeholder:"Relative probability",size:"medium",value:c,allow_undefined:!0,on_blur:g=>{g=g||0,n.update_item({...t,relative_probability:g})},on_blur_type:K.conditional})}),"  ",_(a1,{disabled:!0,size:20,probability:a,conviction:l})]})]})},vV=(e,t)=>(n,i)=>e===E.boolean?_("div",{children:[_("div",{className:"description_label",children:"Description"}),"Boolean value of this state, i.e. either true (100%), false (0%) or somewhere in between."]}):!t&&!n.description&&!n.source?_(Re,{}):_("div",{children:[(t||n.description)&&_(Cn,{placeholder:"Description",value:n.description,on_blur:o=>i.update_item({...n,description:o.trim()}),on_blur_type:K.conditional}),t&&_("br",{}),(t||n.source)&&_(Ge,{placeholder:"Source",size:"small",value:n.source||"",on_blur:o=>i.update_item({...n,source:o?o.trim():void 0}),on_blur_type:K.conditional}),t&&_("br",{})]});function qc(e){const t=Ne(e.value||"");return _("div",{style:{maxHeight:t?0:100,overflow:"hidden",transition:"max-height 1s ease 0s"},children:_(Ci,{warning:"Number is invalid"})})}const hV=e=>({time_resolution:e.display_options.time_resolution}),gV=P(hV);function wV(e){const{value:t,created_at:n,datetime:i,probability:o,conviction:s,time_resolution:r}=e;return _("div",{children:[n&&_("div",{style:{display:"inline-flex"},children:["Created:  ",_(Ct,{invariant_value:n,value:void 0})]}),_("div",{className:"summary_container",children:[_("div",{className:"summary_row",children:[_("div",{className:"datetimes",children:ul(i,r)}),t&&_("div",{children:["      ",t]})]}),_("div",{className:"summary_row",children:[_("div",{children:[_("span",{className:"description_label",children:"Prob"})," ",o]}),"   ",_("div",{children:[_("span",{className:"description_label",children:"Confidence"})," ",s]})]})]})]})}const l1=gV(wV),Zd=(e,t)=>(n,i)=>{let o=d1(n,e);n={...n,entries:o};const s=Zq(n,e),r=eV(n,e)+"%",a=tV(n,e)+"%";return _(l1,{created_at:t?n.custom_created_at||n.created_at:void 0,value:s,datetime:n.datetime,probability:r,conviction:a})},Qd=(e,t)=>(n,i)=>{const o=d1(n,t);return _("div",{className:"VAP_set_details",children:[_("br",{}),_(Jd,{datetime:n.datetime,on_change:s=>i.update_item({...n,datetime:s})}),_("div",{children:[_("br",{}),_(mV,{value_possibilities:e,VAPs_represent:t,values_and_predictions:o,update_values_and_predictions:s=>{const r=bV(s,n,t),a=wl(r,t),c={...n,entries:a};i.update_item(c)}}),_("br",{})]}),_("br",{})]})},eu=(e,t)=>(n,i)=>{const o=n.shared_entry_values||{},s=n.entries.map(({explanation:d})=>d.trim()).filter(d=>d).join(`

`),r=o.explanation||s||"",a=o.conviction||1,c=e!==E.boolean,l=!!(t||r);return _("div",{className:"shared_VAP_set_details",children:[c&&_("div",{children:_(Pn,{disabled:!1,placeholder:"Confidence",value:a,on_blur:d=>{const p={...n.shared_entry_values,conviction:d},f=n.entries.map(m=>({...m,conviction:d}));i.update_item({...n,entries:f,shared_entry_values:p})},on_blur_type:K.conditional})}),l&&_(Cn,{placeholder:"Explanation",value:r,on_blur:d=>{const p={...n.shared_entry_values,explanation:d};i.update_item({...n,shared_entry_values:p})},on_blur_type:K.conditional}),_("br",{})]})};function d1(e,t){let n=e.entries;return t===E.boolean&&n.length!==1&&(n=n.slice(0,1)),n}function bV(e,t,n){return n===E.boolean&&(e=e.concat(t.entries.slice(1))),e}function yV(e){const{VAP_set:t,on_change:n}=e;if(!t.entries[0])return null;const o=Mn(t.datetime),s=o===void 0;return _("div",{children:[o?_s({date:o,time_resolution:void 0}):"Is Eternal",_("br",{}),s&&_(F,{value:"Set to 'From today'",onClick:()=>n({...t,datetime:{value:uk()}})}),!s&&_(F,{value:"Set to Eternal",onClick:()=>n({...t,datetime:{}})}),_("br",{}),_("br",{})]})}const kV=(e,t)=>{const n=Object.keys(t||{}).length>0,i=e===E.other&&n,o=e===E.boolean||e===E.action||i,[s,r]=D(!o);return(a,c)=>{const{update_item:l}=c;return _("div",{children:[!s&&e===E.boolean&&_(xV,{VAP_set:a,on_change:l}),!s&&e===E.action&&_(SV,{possible_value_possibilities:t,VAP_set:a,on_change:l}),!s&&i&&_(AV,{possible_value_possibilities:t,VAP_set:a,on_change:l}),!s&&_("div",{children:[_("span",{className:"description_label",children:"Datetime"}),_(yV,{VAP_set:a,on_change:l})]}),_(F,{value:(s?"Hide":"Show")+" advanced options",onClick:()=>r(!s)}),s&&_("div",{children:[_("br",{}),_("br",{}),_("hr",{}),Zd(e,!1)(a,c),Qd(t,e)(a,c),eu(e,!0)(a,c)]})]})}};function xV(e){const{VAP_set:t,on_change:n}=e,i=t.entries[0];if(!i)return null;const o=i.probability===1&&i.conviction===1,s=i.probability===0&&i.conviction===1;return _("div",{children:[o&&"True",s&&"False",_("br",{}),!o&&_(F,{value:"Set to True",onClick:()=>{n({...t,entries:[{...i,probability:1,conviction:1}]})}}),!s&&_(F,{value:"Set to False",onClick:()=>{n({...t,entries:[{...i,probability:0,conviction:1}]})}}),_("br",{}),_("br",{})]})}function SV(e){return _(u1,{...e,title:"Set action status to:"})}function AV(e){return _(u1,{...e,title:"Set value to:"})}function u1(e){const{title:t,possible_value_possibilities:n,VAP_set:i,on_change:o}=e,s=CV(i),r=$V(n);return _("div",{children:[t,_(de,{selected_option_id:s,options:r,allow_none:!0,on_change:a=>{if(!a)return;const c=y0(i,a);o({...i,entries:c})}}),_("br",{}),_("br",{})]})}function $V(e){return e===void 0?[]:Object.values(e).map(({id:t,value:n})=>({id:t,title:Wt(n)}))}function CV(e){var o,s;let t;const n=((o=e.shared_entry_values)==null?void 0:o.conviction)||0,i=((s=e.shared_entry_values)==null?void 0:s.probability)||0;return e.entries.forEach(r=>{Math.max(n,r.conviction)===1&&Math.max(i,r.probability)===1&&(t=r.value_id)}),t}const jV=e=>({editing:!e.display_options.consumption_formatting}),TV=P(jV);function PV(e){const{editing:t,value_possibilities:n,VAPs_represent:i,older_VAP_sets:o,create_item:s,update_item:r,delete_item:a}=e,c="Older version",l=z(()=>()=>{const p=h2(e.current_VAP_set);s(p)},[e.current_VAP_set,s]),d=z(()=>_i({items:o,get_id:EV,debug_item_descriptor:c,item_props:{get_created_at:IV,get_custom_created_at:DV,get_summary:Zd(i,!0),get_details:Qd(n,i),get_details2:eu(i,t),extra_class_names:"value_and_prediction_set",crud:{create_item:s,update_item:r,delete_item:a},delete_button_text:"Delete Older Set of Value & Predictions"}}),[o,c,i,t,s,r,a]);return _(X0,{items_count:o.length,item_descriptor:c,new_item_descriptor:"Version",content:d,on_click_new_item:l})}const NV=TV(PV),EV=e=>e.id,IV=e=>e.created_at,DV=e=>e.custom_created_at;function RV(e){const[t,n]=D(void 0),{wcomponent_id:i,VAPs_represent:o,update_values_and_predictions:s,existing_value_possibilities:r,values_and_prediction_sets:a,invalid_future_items:c,future_items:l,present_item:d,past_items:p,previous_versions_by_id:f,editing:m}=e,v=d?[d]:[],h=zc({existing_value_possibilities:r,subset_VAP_sets:l,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:J.future,editing:m}),w=zc({existing_value_possibilities:r,subset_VAP_sets:v,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:J.present,editing:m}),b=zc({existing_value_possibilities:r,subset_VAP_sets:p,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:J.past,editing:m}),k={get_created_at:p1,get_custom_created_at:m1,get_summary:kV(o,r),get_details:()=>_("div",{}),get_details2:()=>_("div",{}),extra_class_names:"value_and_prediction_set new",crud:{create_item:N=>{const A=[...a,N];s(A),n(void 0)},update_item:n}},y="Value Prediction",$=m||l.length>0,j=m||v.length>0,C=m||p.length>0;return _("div",{className:"value_and_prediction_sets",children:[m&&_(Os,{new_item_descriptor:y,on_pointer_down_new_list_entry:()=>{const N=Ie(o,r,a,e.base_id);n(N)}}),_(c1,{new_item:t,set_new_item:n,item_props:k,item_descriptor:y}),c.length>0&&_("div",{children:["Hidden (",c.length,") ",_(Td,{})]}),$&&_(sn,{content:h,item_descriptor:"",items_descriptor:Vc("Future",l,f,m),items_descriptor_title:Fc("Future",l,f),disable_collapsed:!0}),($||j)&&_("hr",{}),j&&_(sn,{content:w,item_descriptor:"",items_descriptor:Vc("Present",v,f,m),items_descriptor_title:Fc("Present",v,f),disable_collapsed:!0}),j&&C&&_("hr",{}),C&&_(sn,{content:b,item_descriptor:"",items_descriptor:Vc("Past",p,f,m),items_descriptor_title:Fc("Past",p,f),disable_collapsed:!0})]})}function Vc(e,t,n,i){if(!i)return e;let o=0;return t.forEach(({id:s})=>o+=(n[s]||[]).length),o===0?ri(e,t.length,i):`${e} (${t.length}+)`}function Fc(e,t,n){let i=0;return t.forEach(({id:o})=>i+=(n[o]||[]).length),i===0?`${t.length} ${e} items`:`${t.length} ${e} items with ${i} older versions`}function zc(e){const{existing_value_possibilities:t,subset_VAP_sets:n,all_VAP_sets:i,previous_versions_by_id:o,update_values_and_predictions:s,VAPs_represent:r,tense:a,editing:c}=e;return d=>{const{disable_partial_collapsed:p,expanded_items:f,expanded_item_rows:m}=d,v={create_item:h=>{const w=[...i,h];s(w)},update_item:h=>{const w=uh(h),b=ql(i,h,w);s(b)},delete_item:h=>{const w=uh(h),b=fs(i,w);s(b)}};return _("div",{style:{display:f?"":"none",cursor:"initial"},onClick:h=>h.stopPropagation(),children:n.map(h=>_("div",{children:[_("hr",{className:"entries_horizontal_dividers"}),_(Yd,{item:h,get_created_at:p1,get_custom_created_at:m1,get_summary:Zd(r,!1),get_details:Qd(t,r),get_details2:eu(r,c),get_details3:OV(t,r,o),extra_class_names:`value_and_prediction_set ${a===J.future?"future":a===J.present?"present":"past"}`,expanded:m,crud:v,delete_button_text:"Delete Set of Value & Predictions"})]},h.id))})}}const p1=e=>e.created_at,m1=e=>e.custom_created_at,uh=e=>t=>e.id===t.id&&e.created_at.getTime()===t.created_at.getTime(),OV=(e,t,n)=>(i,o)=>_(I,{className:"VAP_set_details",children:[_("br",{}),_(NV,{value_possibilities:e,VAPs_represent:t,current_VAP_set:i,older_VAP_sets:n[i.id]||[],create_item:o.create_item,update_item:o.update_item,delete_item:o.delete_item}),_("br",{}),_("br",{})]}),MV=(e,t)=>({current_created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:t.editing_allowed??!e.display_options.consumption_formatting,base_id:pt(e)||-1}),qV={change_route:S.routing.change_route},VV=P(MV,qV);function FV(e){const{wcomponent_id:t,existing_value_possibilities:n,values_and_prediction_sets:i,VAPs_represent:o,base_id:s,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l}=e,{invalid_future_items:d,past_items:p,present_item:f,future_items:m,previous_versions_by_id:v}=xn({items:i,created_at_ms:e.current_created_at_ms,sim_ms:a});return _(RV,{wcomponent_id:t,VAPs_represent:o,update_values_and_predictions:h=>{k0({existing_value_possibilities:n,new_values_and_prediction_sets:h,orig_values_and_prediction_sets:i,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l})},existing_value_possibilities:e.existing_value_possibilities,values_and_prediction_sets:i,invalid_future_items:d,past_items:p,present_item:f,future_items:m,previous_versions_by_id:v,base_id:s,editing:e.editing})}const zV=VV(FV),LV=e=>({wcomponents_by_id:e.derived.composed_wcomponents_by_id,presenting:e.display_options.consumption_formatting}),BV={},UV=P(LV,BV);function WV(e){const{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,VAPs_represent:o,orig_values_and_prediction_sets:s,orig_value_possibilities:r}=e,a=s.length>0||t&&o===E.action,[c,l]=D(a),d=Qe(n)&&n.units,[p,f]=D(!!d),m=p&&(o===E.number||!!d)||e.presenting&&o===E.number&&!!d;return _("div",{className:"editable_list_entry padded "+(c?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>l(!c),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Value Predictions ",!c&&s.length?`(${s.length})`:""]})}),_("div",{className:"expansion_button"})]}),Qe(n)&&_("div",{children:[e.editing_allowed&&_(ue,{onClick:()=>f(!p),size:"small",style:{marginLeft:"auto",display:"flex"},children:_(yh,{})}),m&&_(Ge,{style:{padding:"10px 0px"},size:"small",placeholder:"Units",hide_label:!1,disabled:!e.editing_allowed,value:n.units||"",on_blur:v=>e.upsert_wcomponent({units:v||void 0}),on_blur_type:K.conditional})]}),c&&_("div",{children:[o===E.undefined&&_("div",{children:n.type==="state_value"?"Set subtype of target 'state' component to show Value Predictions on this 'state value' component":"Set subtype to show Value Predictions"}),o===E.action&&_(Xq,{VAPs_represent:o,base_id:n.base_id,existing_value_possibilities:r,values_and_prediction_sets:s,update_VAPSets_and_value_possibilities:({value_possibilities:v,values_and_prediction_sets:h})=>{i({value_possibilities:v,values_and_prediction_sets:h})},editing_allowed:t}),o!==E.undefined&&_(zV,{wcomponent_id:n.id,VAPs_represent:o,existing_value_possibilities:r,values_and_prediction_sets:s,update_VAPSets_and_value_possibilities:({value_possibilities:v,values_and_prediction_sets:h})=>{i({value_possibilities:v,values_and_prediction_sets:h})},editing_allowed:t})]})]})}const HV=UV(WV),GV=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id}),KV={},YV=P(GV,KV);function JV(e){const{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,wcomponents_by_id:o}=e,s=oe(n,o),r=n.values_and_prediction_sets,a=n.value_possibilities;return _(Re,{children:[(t&&Qk(n)||Zk(n)&&n.calculations.length>0)&&_(zq,{wcomponent:n,upsert_wcomponent:i}),r!==void 0&&(t||r.length>0)&&_(HV,{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,VAPs_represent:s,orig_values_and_prediction_sets:r,orig_value_possibilities:a}),s!==E.undefined&&r!==void 0&&(t||Object.keys(a||{}).length>0)&&_(Uq,{editing:t,attribute_wcomponent:o[gt(n)&&n.attribute_wcomponent_id||""],VAPs_represent:s,value_possibilities:a,values_and_prediction_sets:r,update_value_possibilities:c=>{const l=ti(r,c);i({value_possibilities:c,values_and_prediction_sets:l})}})]})}const XV=YV(JV),ZV=e=>({current_knowledge_view:_e(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:e.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:!e.display_options.consumption_formatting,wc_id_to_counterfactuals_map:rt(e)}),QV={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},eF=P(ZV,QV);function tF(e){const{current_knowledge_view:t,wcomponents_by_id:n,knowledge_views_by_id:i,wcomponent:o,upsert_wcomponent:s,wc_id_to_counterfactuals_map:r}=e,a=Array.from(e.wcomponent_ids_with_state_VAPs).map(f=>n[f]).filter(me).filter(Ke),c=t==null?void 0:t.composed_wc_id_map[o.id];function l(f){const m=t==null?void 0:t.composed_wc_id_map[f.id];return _$(c,m)}const d=be(a,l,ve.ascending),p=cn({wcomponents:d,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:r,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _("div",{children:_("p",{children:[_("span",{className:"description_label",children:"Attribute (target) component"}),"  ",o.attribute_wcomponent_id&&_(Le,{route:void 0,sub_route:void 0,item_id:o.attribute_wcomponent_id,args:void 0,children:[_(jn,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:o.attribute_wcomponent_id,options:p,on_change:f=>{const m=n[f||""];let{value_possibilities:v}=o;if((!v||!Object.keys(v))&&Qe(m)){const h=oe(m,n),w=yn(h,m.value_possibilities,m.values_and_prediction_sets||[]);v=rn(w,"attribute's possible_values")}s({attribute_wcomponent_id:f,value_possibilities:v})},on_mouse_over_option:f=>e.set_highlighted_wcomponent({id:f,highlighted:!0}),on_mouse_leave_option:f=>e.set_highlighted_wcomponent({id:f,highlighted:!1})})})]})})}const nF=eF(tF);function Lc(e){let t;if(!e)return;const{target_VAP_set_id:n,target_value:i,target_value_id_type:o}=e;return n?i&&o?t={target_VAP_set_id:n,target_value:i,target_value_id_type:o}:t={target_VAP_set_id:n}:i&&o?t={target_value:i,target_value_id_type:o}:t=void 0,t}const iF=(e,t)=>{const{target_wcomponent_id:n}=t.wcomponent,i=e.specialised_objects.wcomponents_by_id[n||""],o=Ke(i)&&i;return{wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:e.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:!e.display_options.consumption_formatting,target_wcomponent:o,wc_id_to_counterfactuals_map:rt(e)}},oF={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},sF=P(iF,oF);function rF(e){const{wcomponents_by_id:t,knowledge_views_by_id:n,wcomponent:i,upsert_wcomponent:o,target_wcomponent:s,wc_id_to_counterfactuals_map:r}=e,a=Array.from(e.wcomponent_ids_with_state_VAPs).map(m=>t[m]).filter(me).filter(Ke),c=cn({wcomponents:a,wcomponents_by_id:t,knowledge_views_by_id:n,wc_id_to_counterfactuals_map:r,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}),l=i.selector||{};let d=[],p=[],f=[];return s&&(d=s.values_and_prediction_sets||[],d=Z3(d,e.created_at_ms),p=d.map(({id:m,datetime:v})=>{const h=ul(v,"minute");return{id:m,title:h}}),f=q0({selector:i.selector,target_wcomponent:s})),_("div",{children:[_("p",{children:[_("span",{className:"description_label",children:"Target component"}),"  ",i.target_wcomponent_id&&_(Le,{route:void 0,sub_route:void 0,item_id:i.target_wcomponent_id,args:void 0,children:[_(jn,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:i.target_wcomponent_id,options:c,on_change:m=>o({target_wcomponent_id:m,selector:void 0}),on_mouse_over_option:m=>e.set_highlighted_wcomponent({id:m,highlighted:!0}),on_mouse_leave_option:m=>e.set_highlighted_wcomponent({id:m,highlighted:!1})})})]}),s&&_("p",{children:[_("span",{className:"description_label",children:"Select value and prediction set timepoint of interest to display"}),"  ",_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:l.target_VAP_set_id,options:p,on_change:m=>{const v=Lc({...l,target_VAP_set_id:m});o({selector:v})},retain_options_order:!0})})]}),s&&_("p",{children:[_("span",{className:"description_label",children:"Select value possibility of interest to limit display by"}),"  ",_("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:"not_set_target_value",checked:l.target_value===void 0||l.target_value_id_type===void 0,onChange:()=>{const m=Lc({...l,target_value:void 0,target_value_id_type:void 0});o({selector:m})}}),_("label",{for:"not_set_target_value",children:"Not set"})]}),f.map(m=>{const{value:v,id:h,selected:w}=m;return _("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:h,checked:w||!1,onChange:()=>{const b=Lc({...l,target_value:h||v,target_value_id_type:h?"id":"value_string"});o({selector:b})}}),_("label",{for:h,children:v})]})})]})]})}const _F=sF(rF);function aF(e){const{prediction:t,on_change:n}=e,{datetime:i,probability:o,conviction:s}=t;return _(l1,{datetime:i,probability:_(Pn,{placeholder:"...",value:o,conditional_on_change:n&&(r=>n({...t,probability:r}))}),conviction:_(Pn,{placeholder:"...",value:s,conditional_on_change:n&&(r=>n({...t,conviction:r}))})})}function cF(e){const{on_change:t,prediction:n}=e,{explanation:i=""}=n,o=t?r=>{const a={...n,...r};t(a)}:void 0,s=o?{on_blur:r=>o({explanation:r}),on_blur_type:K.conditional}:{};return _("div",{children:[_("br",{}),_(Jd,{datetime:n.datetime,on_change:r=>o&&o({datetime:r})}),_("br",{}),(e.editing||i)&&_("div",{children:_(Cn,{placeholder:"Explanation",value:i,...s})})]})}const lF=e=>({created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:!e.display_options.consumption_formatting,base_id:pt(e)}),dF=P(lF);function uF(e){const[t,n]=D(void 0),{item_descriptor:i,predictions:o,update_predictions:s,created_at_ms:r,sim_ms:a,editing:c,base_id:l=-1}=e,d=z(()=>({get_created_at:ph,get_custom_created_at:mh,get_summary:fh,get_details:vh(c),crud:{create_item:C=>{s([...o,C]),n(void 0)}}}),[c,o,s]),p=z(()=>({get_created_at:ph,get_custom_created_at:mh,get_summary:fh,get_details:vh(c),crud:{update_item:C=>{const A=ql(o,C,R=>un(R)===un(C));s(A)},delete_item:C=>{const A=fs(o,R=>un(R)===un(C));s(A)}},delete_button_text:"Delete "+i}),[c,o,s,i]),{invalid_future_items:f,future_items:m,present_item:v,past_items:h}=xn({items:o,created_at_ms:r,sim_ms:a}),w=v?[v]:[],b=_i({items:m,get_id:un,item_props:p}),g=_i({items:w,get_id:un,item_props:p}),k=_i({items:h,get_id:un,item_props:p}),y=c||m.length>0,$=c||w.length>0,j=c||h.length>0;return _("div",{children:[c&&_(Os,{new_item_descriptor:i,on_pointer_down_new_list_entry:()=>n(mF(l))}),_(c1,{new_item:t,set_new_item:n,item_props:d,item_descriptor:i}),f.length>0&&_("div",{children:["Hidden (",f.length,")"]}),o.length>0&&_("div",{children:[y&&_(sn,{content:b,item_descriptor:"",items_descriptor:ri("Future",m.length,c),disable_collapsed:!0}),(y||$)&&_("hr",{}),$&&_(sn,{content:g,item_descriptor:"",items_descriptor:ri("Present",w.length,c),disable_collapsed:!0}),$&&j&&_("hr",{}),j&&_(sn,{content:k,item_descriptor:"",items_descriptor:ri("Past",h.length,c),disable_collapsed:!0})]})]})}const pF=dF(uF),un=e=>e.id,ph=e=>e.created_at,mh=e=>e.custom_created_at;function fh(e,t){return _(aF,{prediction:e,on_change:t.update_item})}function vh(e){return(t,n)=>_(cF,{prediction:t,on_change:n.update_item,editing:e})}function mF(e){const t=ro(),n=Vh(t.created_at,"day");return{id:zk(),...t,base_id:e,datetime:{value:n},explanation:"",probability:1,conviction:1}}const fF=e=>({consumption_formatting:e.display_options.consumption_formatting}),vF={change_route:S.routing.change_route},hF=P(fF,vF);function gF(e){const{wcomponent:t}=e,{validity:n=[]}=t,[i,o]=D(n.length>0);return e.consumption_formatting&&n.length===0?null:_("div",{className:"editable_list_entry padded "+(i?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>o(!i),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Validity Predictions ",!i&&n.length?`(${n.length})`:""]})}),_("div",{className:"expansion_button"})]}),i&&_(pF,{item_descriptor:(ye(t)?"Existence ":"Validity ")+" prediction",predictions:n,update_predictions:s=>{const r=new Date().getTime()+1;e.change_route({args:{created_at_ms:r,sim_ms:r}}),e.upsert_wcomponent({validity:s})}})]})}const wF=hF(gF),bF=(e,{wcomponent:t})=>{let n,i;ye(t)&&(n=pe(e,t.from_id),i=pe(e,t.to_id));const o=rt(e),s=!e.display_options.consumption_formatting,r=(e.user_info.bases_by_id||{})[t.base_id],a=!!(r!=null&&r.can_edit);return{ready:e.sync.ready_for_reading,base_id:pt(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:o,from_wcomponent:n,to_wcomponent:i,derived_composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,derived_composed_wcomponent:e.derived.composed_wcomponents_by_id[t.id],is_in_editing_mode:s,allowed_to_edit:a,editing_allowed:s&&a,base_for_wcomponent:r,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},yF={upsert_wcomponent:S.specialised_object.upsert_wcomponent,delete_wcomponent:S.specialised_object.delete_wcomponent,update_chosen_base_id:S.user_info.update_chosen_base_id},kF=P(bF,yF);function xF(e){var A,R,M;const{wcomponent:t,ready:n,base_id:i,wcomponents_by_id:o,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:r,from_wcomponent:a,to_wcomponent:c,derived_composed_wcomponents_by_id:l,derived_composed_wcomponent:d,editing_allowed:p,created_at_ms:f,sim_ms:m}=e,v=t.id,[h,w]=D(v);if(!n)return _("div",{children:"Loading..."});if(!d)return _("div",{children:"Loading..."});if(i===void 0)return _("div",{children:"Choose a base first."});const b=r&&((A=r[v])==null?void 0:A.VAP_sets),g=De(!0);if(re(()=>w(v),[v]),h!==v)return g.current=!0,null;const k=g.current;g.current=!1;const y=T=>{const B=B8(t,T).wcomponent;e.upsert_wcomponent({wcomponent:B})};let $,j=!1;Ke(t)&&($=bs({wcomponent:d,VAP_set_id_to_counterfactual_v2_map:b,created_at_ms:f,sim_ms:m}),j=(((R=t.values_and_prediction_sets)==null?void 0:R.length)||0)>0);const C=mt({text_type:p?fe.raw:fe.rich,wcomponent:d,wcomponents_by_id:l,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:r,created_at_ms:f,sim_ms:m}),N=T=>y({title:T});return _(I,{children:[e.is_in_editing_mode&&!e.allowed_to_edit&&_("div",{children:[_(_n,{message:""}),"  Not allow to edit.  Ask base owner to give you edit permissions."]}),e.wcomponent_from_different_base&&_("div",{style:{cursor:"pointer"},onClick:()=>e.update_chosen_base_id({base_id:t.base_id}),title:`Click to change to base ${t.base_id}`,children:[_(_n,{}),'  Is part of base "',(M=e.base_for_wcomponent)==null?void 0:M.title,'"']}),_(ot,{variant:"standard",fullWidth:!0,margin:"normal",style:{fontWeight:600,fontSize:22},children:_(Cn,{editing_allowed:p,placeholder:t.type==="action"?"Passive imperative title...":t.type==="relation_link"?"Verb...":"Title...",value:C,on_blur:N,on_blur_type:K.conditional,force_focus_on_first_render:k,hide_label:!0,spellcheck:!0})}),$&&_("span",{children:[_("span",{className:"description_label",children:"Value "}),_(F0,{UI_value:$})]}),(p||t.type!=="statev2"||j)&&_(ot,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:_(de,{editing_allowed:p,placeholder:"Type: ",selected_option_id:t.type,options:r1,on_change:T=>{if(!T)return;const ne={...q({type:T,base_id:t.base_id}),...t};ne.type=T,y(ne)}})}),Qe(t)&&(p||t.subtype)&&_("p",{children:[_("span",{className:"description_label",children:"Subtype"})," ",_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{editing_allowed:p,placeholder:"Subtype...",selected_option_id:t.subtype,options:uq,allow_none:!0,on_change:T=>y({subtype:T})})})]}),(p||t.description)&&_(ot,{variant:"standard",fullWidth:!0,margin:"normal",children:_(Cn,{editing_allowed:p,placeholder:"Description...",value:t.description,on_blur:T=>y({description:T}),on_blur_type:K.conditional,hide_label:!0})}),gt(t)&&_(nF,{wcomponent:t,upsert_wcomponent:y}),oo(t)&&_(_F,{wcomponent:t,upsert_wcomponent:y}),vl(t)&&_(yq,{wcomponent:t,upsert_wcomponent:y}),ye(t)&&_("div",{children:[_("p",{children:_(dl,{connection_terminal_description:"From",wcomponent_id:a&&a.id,connection_terminal_type:t.from_type,on_update_id:T=>y({from_id:T}),on_update_type:T=>y({from_type:T}),exclude_ids:new Set([t.id])})}),_("p",{children:_(dl,{connection_terminal_description:"To",wcomponent_id:c&&c.id,connection_terminal_type:t.to_type,on_update_id:T=>y({to_id:T}),on_update_type:T=>y({to_type:T}),exclude_ids:new Set([t.id])})}),p&&_("p",{style:{display:"flex",alignItems:"center",flexDirection:"column"},children:_(F,{value:"Reverse Direction",onClick:()=>{y({to_id:t.from_id,from_id:t.to_id})}})})]}),an(t)&&_(pq,{wcomponent:t,from_wcomponent:a,editing:p,wcomponents_by_id:o,upsert_wcomponent:y}),ye(t)&&_(mq,{wcomponent:t,editing:p,upsert_wcomponent:y}),ut(t)&&_(rq,{wcomponent:t,upsert_wcomponent:y}),(Rn(t)||et(t))&&_(Oq,{wcomponent:t,upsert_wcomponent:y}),(p||t.label_ids&&t.label_ids.length>0)&&_(ot,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ai,{component:"legend",children:"Labels"}),_(os,{label_ids:t.label_ids,on_change:T=>y({label_ids:T})})]}),fl(t)&&_(Nq,{wcomponent:t,upsert_wcomponent:y}),Ke(t)&&_(XV,{editing_allowed:p,wcomponent:t,upsert_wcomponent:y}),Mh(t)&&_(K8,{editing_allowed:p,wcomponent:t,upsert_wcomponent:y}),qh(t)&&_(wF,{editing_allowed:p,wcomponent:t,upsert_wcomponent:y}),_("br",{}),_("br",{}),_(ot,{variant:"standard",fullWidth:!0,children:[_(Ct,{editing_allowed:p,title:"Created at",invariant_value:t.created_at,value:t.custom_created_at,on_change:T=>{y({custom_created_at:T})}}),_("br",{})]}),p&&_("p",{children:[_("span",{className:"description_label",children:"Label color"}),_(n1,{color:t.label_color,conditional_on_blur:T=>y({label_color:T})})]}),p&&_(Eq,{wcomponent:t,upsert_wcomponent:y}),!p&&t.summary_image&&_("p",{children:_("a",{href:t.summary_image,target:"_blank",children:[_(jn,{}),"Open image"]})}),p&&_("p",{children:[_("span",{className:"description_label",children:"Hide node title"}),_(it,{value:t.hide_title,on_change:T=>y({hide_title:T})}),_("span",{className:"description_label",children:"Hide node state"}),_(it,{value:t.hide_state,on_change:T=>y({hide_state:T})}),_("hr",{})]}),_(s1,{wcomponent_id:t.id,editing_allowed:p}),_("br",{}),_("br",{}),p&&so(t)&&_("div",{children:_(Tn,{button_text:"Soft Delete (can undo)",tooltip_text:"Remove from all knowledge views",on_delete:()=>e.delete_wcomponent({wcomponent_id:v})})}),p&&gl(t)&&_("div",{children:_(F,{title:"Undo delete",onClick:()=>y({deleted_at:void 0}),children:"Restore"})}),_("br",{})]})}const SF=kF(xF);const AF=e=>({current_knowledge_view:_e(e),editing:!e.display_options.consumption_formatting,base_id:pt(e)}),$F={toggle_consumption_formatting:S.display.toggle_consumption_formatting},CF=P(AF,$F);function jF(e){const{current_knowledge_view:t,editing:n,base_id:i}=e;return n?i===void 0?_("div",{class:"create_new_wcomponent",children:"Select a base first."}):t?_("div",{class:"create_new_wcomponent",children:[_("h3",{children:"Create new component"}),_(Dn,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:jl.map(o=>_(Se,{onClick:()=>PF(i,o),children:no(o)}))})]}):_("div",{class:"create_new_wcomponent",children:[_("h3",{children:"Create new component"}),_("p",{children:"Please select a knowledge view first"})]}):_("div",{class:"create_new_wcomponent",children:_(F,{onClick:()=>e.toggle_consumption_formatting(),children:"Swap to editing"})})}const TF=CF(jF);function PF(e,t){xi({wcomponent:{base_id:e,type:t}})}const NF=e=>({}),EF={change_route:S.routing.change_route},IF=P(NF,EF);function DF(e){const[t,n]=D(void 0),i=z(()=>()=>{const s=Ae().getState(),{wcomponents_by_id:r,knowledge_views_by_id:a}=s.specialised_objects,c=new Set;Object.values(a).forEach(p=>{Object.entries(p.wc_id_map).filter(([f,m])=>!m.blocked&&!m.passthrough).forEach(([f,m])=>c.add(f))});const l=Object.values(r).filter(p=>so(p)&&!c.has(p.id)),d=be(l,p=>(p.modified_at||p.created_at).getTime(),ve.descending);n(d)},[]);return _("div",{children:[_("h3",{style:{marginTop:30,marginBottom:0},children:"Orphaned Components"}),_("span",{className:"description_label",children:"Show all components in this knowledge base which are not in one or more knowledge views in this base."}),_(Dn,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:_(Se,{onClick:()=>i(),children:"Find orphan components"})}),t&&t.length>0&&_("table",{children:_("tbody",{style:{cursor:"pointer"},children:t.map(o=>_("tr",{onClick:()=>e.change_route({item_id:o.id}),children:[_("td",{children:o.type}),_("td",{children:_(pd,{text:o.title})})]}))})}),t&&t.length===0&&_("p",{children:"No orphaned components found."})]})}const RF=IF(DF);function OF(e){const[t,n]=D(0),[i,o]=D(0),s=r=>{e.on_update({change_left:r.change_left?zt(r.change_left):0,change_top:r.change_top?zt(r.change_top):0})};return _("div",{children:[_("p",{style:{fontSize:10,color:"#888"},children:["Increments of ",st," pixels"]}),"Move right: ",_(ct,{placeholder:"Right",value:t,allow_undefined:!1,on_blur:r=>n(zt(r)),on_blur_type:K.conditional}),_("input",{type:"button",value:"Move",disabled:t===0,onClick:()=>s({change_left:t})}),"  ",_("input",{type:"button",value:"←",onClick:()=>s({change_left:-st})}),_("input",{type:"button",value:"←←",onClick:()=>s({change_left:-pi})}),_("input",{type:"button",value:"→→",onClick:()=>s({change_left:pi})}),_("input",{type:"button",value:"→",onClick:()=>s({change_left:st})}),_("br",{}),_("br",{}),"Move up: ",_(ct,{placeholder:"Up",value:-i,allow_undefined:!1,on_blur:r=>o(zt(-r)),on_blur_type:K.conditional}),_("input",{type:"button",value:"Move",disabled:i===0,onClick:()=>s({change_top:i})}),"  ",_("input",{type:"button",value:"↑",onClick:()=>s({change_top:-st})}),_("input",{type:"button",value:"↑↑",onClick:()=>s({change_top:-Sn})}),_("input",{type:"button",value:"↓↓",onClick:()=>s({change_top:Sn})}),_("input",{type:"button",value:"↓",onClick:()=>s({change_top:st})})]})}const MF=e=>{const t=_e(e),{selected_wcomponent_ids_set:n}=e.meta_wcomponents,{wcomponents_by_id:i}=e.specialised_objects;return{ready:e.sync.ready_for_reading,selected_wcomponent_ids_set:n,wcomponents_by_id:i,knowledge_view_id:t==null?void 0:t.id,composed_wc_id_map:t==null?void 0:t.composed_wc_id_map,editing:!e.display_options.consumption_formatting}},qF={bulk_edit_knowledge_view_entries:S.specialised_object.bulk_edit_knowledge_view_entries,bulk_add_to_knowledge_view:S.specialised_object.bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view:S.specialised_object.bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries:S.specialised_object.snap_to_grid_knowledge_view_entries,bulk_edit_wcomponents:S.specialised_object.bulk_edit_wcomponents,upsert_wcomponent:S.specialised_object.upsert_wcomponent},VF=P(MF,qF);function FF(e){if(!e.ready)return _("div",{children:"Loading..."});const{selected_wcomponent_ids_set:t,composed_wc_id_map:n,knowledge_view_id:i,wcomponents_by_id:o,editing:s,bulk_edit_knowledge_view_entries:r,bulk_add_to_knowledge_view:a,bulk_remove_from_knowledge_view:c,snap_to_grid_knowledge_view_entries:l,bulk_edit_wcomponents:d,upsert_wcomponent:p}=e,f=Pg(o,t).filter(me),m=Array.from(t),v=LF(m,n),h=new Set,w=[];let b;f.forEach(k=>{(k.label_ids||[]).forEach(y=>h.add(y)),an(k)&&(w.push(k.id),b=b||k.effect_string)});const g=Array.from(h).sort();return m.length===0?_("div",{children:_("h2",{children:"No selected components"})}):_("div",{children:[_("h2",{children:[s?"Bulk editing":"Viewing"," ",m.length," components"]}),s&&_("p",{children:[_("h3",{children:"Position"}),_(OF,{on_update:k=>{r({wcomponent_ids:m,...k})}})]}),s&&_("p",{children:_(i1,{wcomponent_ids:m})}),(s||g.length>0)&&_("p",{children:[_("h3",{children:"Labels"}),_(os,{label_ids:g,on_change:k=>{const y=new Set(k),$=new Set(g.filter(C=>!y.has(C))),j=new Set(k.filter(C=>!h.has(C)));d({wcomponent_ids:m,change:{},remove_label_ids:$,add_label_ids:j})}})]}),s&&w.length>0&&_("p",{children:["Causal Connection Values",_(_1,{effect_string:b,effect_when_true:void 0,effect_when_false:void 0,editing:s,wcomponents_by_id:o,upsert_wcomponent:k=>d({wcomponent_ids:w,change:k})})]}),s&&_("p",{children:["Component types",_(de,{placeholder:"Type: ",selected_option_id:void 0,allow_none:!0,options:r1,on_change:k=>{k&&f.forEach(y=>{const j={...q({base_id:y.base_id,type:k}),...y};j.type=k,p({wcomponent:j})})}})]}),s&&_("p",{children:[_("h3",{children:"Created at"}),_(Ct,{value:void 0,on_change:k=>d({wcomponent_ids:m,change:{custom_created_at:k}})})]}),s&&_("p",{children:[_("h3",{children:"Add to knowledge view"}),v?"":_("span",{children:[_(_n,{message:"Not all components present in current view so will be added to center of view."}),"Not all components present in current view so will be added to center of view."]}),_(wo,{on_change:k=>{if(!k)return;const y=Ae().getState(),$=ki(y);a({wcomponent_ids:m,knowledge_view_id:k,default_entry:$})}})]}),s&&_("p",{children:_(Tn,{button_text:"Delete from knowledge view",tooltip_text:"Delete from knowledge view",on_delete:()=>{c({wcomponent_ids:m,remove_type:"passthrough"})}})}),s&&_("p",{children:_(Tn,{button_text:"Delete and Block from knowledge view",tooltip_text:"Delete and Block from showing in current knowledge view",on_delete:()=>{c({wcomponent_ids:m,remove_type:"block"})}})})]})}const zF=VF(FF);function LF(e,t){return t?e.find(n=>!t[n])===void 0:!1}const BF=e=>{const{ready_for_reading:t}=e.sync,{bases_by_id:n,chosen_base_id:i}=e.user_info,{sub_route:o,item_id:s}=e.routing,r=pe(e,s),a=e.meta_wcomponents.selected_wcomponent_ids_list;return{bases_by_id:n,chosen_base_id:i,ready_for_reading:t,sub_route:o,item_id:s,wcomponent:r,selected_ids:a,editing:!e.display_options.consumption_formatting,wcomponent_ids_searched_for_in_any_base:e.sync.wcomponent_ids_searched_for_in_any_base}},UF={clear_selected_wcomponents:S.meta_wcomponents.clear_selected_wcomponents,set_or_toggle_display_select_storage:S.controls.set_or_toggle_display_select_storage,request_searching_for_wcomponents_by_id_in_any_base:S.sync.request_searching_for_wcomponents_by_id_in_any_base},WF=P(BF,UF);function HF(e){const{ready_for_reading:t,item_id:n}=e,i=n?!e.wcomponent_ids_searched_for_in_any_base.has(n):!1,o=e.wcomponent,s=e.bases_by_id&&!e.chosen_base_id?0:t?e.sub_route==="wcomponents_edit_multiple"?2:n===null?3:4:1;if(re(()=>{o||s===4&&n&&e.request_searching_for_wcomponents_by_id_in_any_base({ids:[n]})},[t,s,n,o,i]),s===0)return _("div",{children:_(F,{value:"Choose a base to view",onClick:()=>e.set_or_toggle_display_select_storage(!0)})});if(s===1)return _("div",{children:"Loading..."});if(s===2)return _("div",{children:_(zF,{})});if(s===3)return _("div",{children:[e.selected_ids.length>0&&_("p",{children:[_("div",{style:{display:"inline-flex"},children:[_(sE,{name:`View ${e.selected_ids.length} component(s) already selected`,route:"wcomponents",sub_route:e.selected_ids.length>1?"wcomponents_edit_multiple":void 0,item_id:e.selected_ids.length===1?e.selected_ids[0]:void 0,args:void 0})," ",_(F,{value:"Clear selection",onClick:()=>e.clear_selected_wcomponents()})]}),_("br",{}),_("br",{}),_("hr",{})]}),_(TF,{}),_(RF,{})]});if(o){const r=!!e.wcomponent&&e.wcomponent.base_id!==e.chosen_base_id;return _(SF,{wcomponent:o,wcomponent_from_different_base:r})}return _("div",{children:["Component not found for id: ",n,_("br",{}),_("br",{}),i&&_("div",{children:"Searching in other bases..."}),!i&&_("div",{children:["Not found in other bases (that you have access to).",e.editing&&n&&_(L8,{wcomponent_id:n})]})]})}const GF=WF(HF),KF=e=>({route:e.routing.route}),YF=P(KF);function JF(e){return _("div",{children:[e.route==="filter"&&_(_M,{}),e.route==="select"&&_(p8,{}),e.route==="display"&&_(qO,{}),e.route==="views"&&_(a8,{}),e.route==="wcomponents"&&_(GF,{}),e.route==="about"&&_(SO,{}),e.route==="search"&&_(u8,{})]})}const XF=YF(JF);var tu={},ZF=Q;Object.defineProperty(tu,"__esModule",{value:!0});var f1=tu.default=void 0,QF=ZF(Z()),ez=ee(),tz=(0,QF.default)((0,ez.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");f1=tu.default=tz;const nz=e=>({display_side_panel:e.controls.display_side_panel}),iz={set_or_toggle_display_side_panel:S.controls.set_or_toggle_display_side_panel},oz=P(nz,iz);function sz(e){return _(ue,{"aria-label":"open side panel",color:"inherit",edge:"end",onClick:()=>e.set_or_toggle_display_side_panel(),size:"small",children:e.display_side_panel?_(f1,{}):_(xd,{})})}const rz=oz(sz);var nu={},_z=Q;Object.defineProperty(nu,"__esModule",{value:!0});var v1=nu.default=void 0,az=_z(Z()),cz=ee(),lz=(0,az.default)((0,cz.jsx)("path",{d:"M18.99 11.5c.34 0 .67.03 1 .07L20 0 0 20h11.56c-.04-.33-.07-.66-.07-1 0-4.14 3.36-7.5 7.5-7.5zm3.71 7.99c.02-.16.04-.32.04-.49 0-.17-.01-.33-.04-.49l1.06-.83c.09-.08.12-.21.06-.32l-1-1.73c-.06-.11-.19-.15-.31-.11l-1.24.5c-.26-.2-.54-.37-.85-.49l-.19-1.32c-.01-.12-.12-.21-.24-.21h-2c-.12 0-.23.09-.25.21l-.19 1.32c-.3.13-.59.29-.85.49l-1.24-.5c-.11-.04-.24 0-.31.11l-1 1.73c-.06.11-.04.24.06.32l1.06.83c-.02.16-.03.32-.03.49 0 .17.01.33.03.49l-1.06.83c-.09.08-.12.21-.06.32l1 1.73c.06.11.19.15.31.11l1.24-.5c.26.2.54.37.85.49l.19 1.32c.02.12.12.21.25.21h2c.12 0 .23-.09.25-.21l.19-1.32c.3-.13.59-.29.84-.49l1.25.5c.11.04.24 0 .31-.11l1-1.73c.06-.11.03-.24-.06-.32l-1.07-.83zm-3.71 1.01c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"}),"PermDataSetting");v1=nu.default=lz;var iu={},dz=Q;Object.defineProperty(iu,"__esModule",{value:!0});var h1=iu.default=void 0,uz=dz(Z()),pz=ee(),mz=(0,uz.default)((0,pz.jsx)("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"}),"Sync");h1=iu.default=mz;var ou={},fz=Q;Object.defineProperty(ou,"__esModule",{value:!0});var su=ou.default=void 0,vz=fz(Z()),hz=ee(),gz=(0,vz.default)((0,hz.jsx)("path",{d:"M3 12c0 2.21.91 4.2 2.36 5.64L3 20h6v-6l-2.24 2.24C5.68 15.15 5 13.66 5 12c0-2.61 1.67-4.83 4-5.65V4.26C5.55 5.15 3 8.27 3 12zm8 5h2v-2h-2v2zM21 4h-6v6l2.24-2.24C18.32 8.85 19 10.34 19 12c0 2.61-1.67 4.83-4 5.65v2.09c3.45-.89 6-4.01 6-7.74 0-2.21-.91-4.2-2.36-5.64L21 4zm-10 9h2V7h-2v6z"}),"SyncProblem");su=ou.default=gz;function g1(e){const{state:t,text:n="Refresh",title:i="Refresh",on_click:o,style:s}=e,r=t==="error";return _("span",{title:i,onClick:o,style:s,children:[n,!r&&_(h1,{className:t==="in_progress"?"animate spinning":""}),r&&_(su,{})]})}function ss(e){const{error:t}=e;return t===null?null:t.message.includes("Thanks for registering")&&t.status===400?_("div",{children:"Please check your email"}):_("div",{children:["Error : ",t.message||t]})}function bo(e){const{error:t}=e;if(!t)return null;const n=t.message||t;let i=`${n}`;return i==="[object Object]"&&(i=JSON.stringify(n)),_("div",{children:["Error: ",i]})}var ru={},wz=Q;Object.defineProperty(ru,"__esModule",{value:!0});var _u=ru.default=void 0,bz=wz(Z()),yz=ee(),kz=(0,bz.default)((0,yz.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"}),"Edit");_u=ru.default=kz;function w1(e){var s;const{users_by_id:t,current_user_id:n,other_user_id:i}=e;let o=((s=t[i])==null?void 0:s.name)||"";return n?o=n===i?"me":o||"(someone else)":o=o||"Someone",_("span",{title:i,children:o})}function xz(e){const{user:t,users_by_id:n,base:i,selected:o,on_click:s,on_click_edit:r}=e,{title:a,public_read:c,access_level:l}=i,d=l==="owner"?"Editor (Owner)":l==="editor"?"Editor":l==="viewer"?"Viewer":i.public_read?"Viewer (public access)":"?";return _("tr",{className:"base_option "+(o?"selected":""),onClick:s,children:[_("td",{className:"narrow",children:_("input",{type:"radio",checked:o,style:{cursor:"pointer"}})}),_("td",{children:a||"(No title)"}),_("td",{children:c&&"(Public)"}),_("td",{children:w1({users_by_id:n,current_user_id:t==null?void 0:t.id,other_user_id:i.owner_user_id})}),_("td",{children:d}),_("td",{className:"narrow edit_title",onClick:i.can_edit?p=>{p.stopImmediatePropagation(),r()}:void 0,children:i.can_edit&&_(_u,{})})]})}const Sz=e=>({user:e.user_info.user,users_by_id:e.user_info.users_by_id,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}),Az={update_chosen_base_id:S.user_info.update_chosen_base_id},$z=P(Sz,Az);function Cz(e){const{on_choose:t,on_click_edit:n,user:i,users_by_id:o,chosen_base_id:s,bases_by_id:r,update_chosen_base_id:a}=e,[c,l]=D("initial"),[d,p]=D(void 0);if(!o)return"Loading users...";if(!r)return"Loading bases...";const f=be(Object.values(r),m=>m.inserted_at.getTime(),ve.descending);return f.length===0?null:_("div",{style:{margin:10},children:[_(g1,{state:c,title:"Refresh sharing options",on_click:async()=>{l("in_progress");const m=await el();l(m.error?"error":"success"),p(m.error)},style:{float:"right"}}),_("h4",{children:"Select a base"}),_(bo,{error:d}),_("table",{children:[_("thead",{children:_("tr",{children:[_("th",{}),_("th",{children:"Knowledge Base Title"}),_("th",{}),_("th",{children:"Owner"}),_("th",{children:"Access"}),_("th",{})]})}),_("tbody",{children:f.map(m=>_(xz,{user:i,users_by_id:o,base:m,selected:m.id===s,on_click:()=>{a({base_id:m.id}),t&&t()},on_click_edit:()=>n(m.id)}))})]})]})}const jz=$z(Cz);async function Tz(e){const t=Ce(),{data:n,error:i}=await t.from("access_controls").select().eq("base_id",e);return{access_controls:n?n.map(s=>({...s,inserted_at:new Date(s.inserted_at),updated_at:new Date(s.updated_at)})):void 0,error:i}}async function Pz(e){const t={base_id:e.base_id,user_id:e.other_user_id,access_level:e.grant};return await Ce().from("access_controls").upsert(t).select()}function b1(e){const t=["editor","viewer","none"];return _(Sh,{variant:"standard",disabled:e.disabled,value:e.current_level,title:e.title||"Select access level",onChange:n=>{const i=n.target.value;e.on_change(i)},children:t.map(n=>_(rs,{value:n,children:Wt(n)}))})}function Nz(e){const{access_control:t,base_id:n,users_by_id:i,current_user_id:o,is_owner:s,on_update:r}=e,{user_id:a,access_level:c}=t;if(c==="owner")return null;const l=d=>Pz({base_id:n,other_user_id:a,grant:d}).then(r);return _("tr",{children:[_("td",{children:w1({users_by_id:i,current_user_id:o,other_user_id:a})}),_("td",{children:_(b1,{disabled:!s,current_level:c,title:s?"Select access level":"Only owners can edit access levels",on_change:l})}),_("br",{})]})}function Ez(e){const[t,n]=D(""),[i,o]=D("editor"),[s,r]=D("initial"),a=s==="in_progress",c=s==="success",[l,d]=D(null),{base_id:p}=e;return _("div",{children:["Share with new user: ",_("br",{}),_("input",{type:"text",placeholder:"User's ID or email",value:t,disabled:a,style:{minWidth:200},onKeyUp:f=>n(f.currentTarget.value),onChange:f=>n(f.currentTarget.value),onBlur:f=>n(f.currentTarget.value)}),"  ",_(b1,{current_level:i,on_change:o}),_("br",{}),a&&_("span",{children:"Adding..."}),c&&_("span",{children:"Added."}),_(bo,{error:l}),_("br",{}),t&&_("input",{type:"button",onClick:async()=>{r("in_progress");const m=await Ce().rpc("invite_user_to_base",{base_id:p,email_or_uid:t,access_level:i}),{status:v,error:h}=m;d(h),r(h?"error":"success"),h||(n(""),e.on_add_or_exit(!0))},value:"Add user",disabled:!t}),"  ",_("input",{type:"button",onClick:()=>e.on_add_or_exit(!1),value:"Back"})]})}const Iz=e=>({users_by_id:e.user_info.users_by_id}),Dz=P(Iz);function Rz(e){const{user:t,base:n,on_save_or_exit:i,users_by_id:o}=e,[s,r]=D("initial"),[a,c]=D(void 0),[l,d]=D(void 0),p=n.owner_user_id===t.id;function f(){r("in_progress"),Tz(n.id).then(m=>{r(m.error?"error":"success"),c(m.access_controls),d(m.error||void 0),!m.error&&G.user.pub("stale_users_by_id",!1)})}return re(()=>f(),[]),o?_("div",{children:[_(g1,{state:s,title:"Refresh sharing options",on_click:()=>f(),style:{float:"right"}}),_("h4",{children:"Sharing options"}),_(bo,{error:l}),a&&_("div",{children:[a.length===0&&"Not shared with anyone yet",a.length>0&&_("table",{className:"access_controls_table",children:_("tbody",{children:a.map(m=>_(Nz,{access_control:m,base_id:n.id,users_by_id:o,current_user_id:t.id,is_owner:p,on_update:v=>{d(v.error||void 0),v.error||f()}}))})}),_("br",{})]}),!p&&_("div",{children:"Sharing with new users (Only owners can do this for now)"}),p&&_(Ez,{base_id:n.id,on_add_or_exit:m=>{m?f():i()}})]}):_("div",{children:"Fetching users..."})}const Oz=Dz(Rz);function Mz(e){const{base:t,on_save_or_exit:n,user:i}=e,[o,s]=D(t);re(()=>s(t),[t]);const[r,a]=D(void 0),c=t.owner_user_id===i.id,l=JSON.stringify(t)!==JSON.stringify(o),d=!!o.title;function p(f,m){let v=f.currentTarget.value;m&&(v=v.trim()),s({...o,title:v})}return c?_("div",{children:[_("h4",{children:"Edit base"}),"Title   ",_("input",{type:"text",placeholder:"title",value:o.title,onChange:f=>p(f,!1),onBlur:f=>p(f,!0)}),_("br",{}),_("br",{}),"Visibility   ",_("input",{type:"button",onClick:()=>{s({...o,public_read:!o.public_read})},value:o.public_read?"Make private":"Publish (make public)"}),_("br",{}),_("br",{}),"Default view   ",_(wo,{selected_option_id:o.default_knowledge_view_id??void 0,on_change:f=>{s({...o,default_knowledge_view_id:f})},editing_allowed:!0}),_("br",{}),_("br",{}),_("div",{children:[l&&d&&_("input",{type:"button",disabled:!d,onClick:async()=>{const f=await xj(o);if(f.error)return a(f.error);a(void 0),G.user.pub("stale_bases",!1)},value:"Save changes"}),"  ",_("input",{type:"button",onClick:n,value:l?"Cancel":"Back"}),_("br",{}),_(bo,{error:r})]}),_("br",{}),_("hr",{})]}):null}const qz=e=>({user:e.user_info.user}),Vz=P(qz);function Fz(e){const{base:t,on_save_or_exit:n,user:i}=e;return i?_("div",{style:{margin:10},children:[_(Mz,{user:i,base:t,on_save_or_exit:n}),_(Oz,{user:i,base:t,on_save_or_exit:n})]}):"Please sign in"}const zz=Vz(Fz),Lz=e=>({user:e.user_info.user,users_by_id:e.user_info.users_by_id,bases_by_id:e.user_info.bases_by_id}),Bz={update_chosen_base_id:S.user_info.update_chosen_base_id},Uz=P(Lz,Bz);function Wz(e){const{on_close:t,user:n,users_by_id:i,bases_by_id:o,update_chosen_base_id:s}=e,[r,a]=D(""),[c,l]=D("initial"),[d,p]=D(void 0),[f,m]=D(void 0);if(!i)return"Loading users...";if(!o)return"Loading bases...";const v=n==null?void 0:n.id,h=Object.keys(o).length,w=v===void 0?void 0:async function(){l("in_progress");const b=await yj({owner_user_id:v,title:r.trim()});l(b.error?"error":"success"),m(b.base),b.error||(G.user.pub("stale_bases",!1),a(""))};return d!==void 0?_("div",{style:{margin:10},children:_(zz,{base:o[d],on_save_or_exit:()=>p(void 0)})}):_("div",{style:{margin:10},children:[_(jz,{on_choose:t,on_click_edit:b=>p(b)}),h>0&&w&&_("hr",{}),w&&_("div",{children:[_("h4",{children:["Create ",h?"a new":"your first"," base"]}),_("input",{type:"text",value:r,onKeyUp:b=>a(b.currentTarget.value),onChange:b=>a(b.currentTarget.value),onBlur:b=>a(b.currentTarget.value)}),_("br",{}),_("input",{type:"button",disabled:!r.trim()||c==="in_progress",onClick:w,value:"Create new base"}),"  ",Gz(c),"  ",f&&_("input",{type:"button",onClick:()=>{s({base_id:f.id}),t&&t()},value:"Select new base"})]})]})}const Hz=Uz(Wz);function Gz(e){return e==="initial"?"":e==="in_progress"?"Creating...":e==="success"?"Created.":"Error"}function Kz(e){const{on_close:t}=e;return _(ji,{title:_("div",{style:{margin:10},children:_("h2",{style:{display:"inline"},children:"Knowledge Bases"})}),size:"medium",on_close:t&&(n=>{n==null||n.stopImmediatePropagation(),t()}),child:_(Hz,{on_close:t})})}const Yz=e=>({base_name:hA(e),needs_to_create_a_base:fw(e),display_select_storage:e.controls.display_select_storage}),Jz={set_or_toggle_display_select_storage:S.controls.set_or_toggle_display_select_storage},Xz=P(Yz,Jz);function Zz(e){const{needs_to_create_a_base:t,display_select_storage:n,set_or_toggle_display_select_storage:i}=e;return re(()=>{t&&i(!0)},[t]),_(se,{component:"span",children:[_(Se,{id:"storage_info_button",color:"primary",disableElevation:!0,onClick:()=>i(!0),size:"small",endIcon:_(v1,{titleAccess:"Create and Select Knowledge Bases"}),style:{textTransform:"none"},variant:"contained",children:_("span",{class:"storage_name",children:e.base_name||"Choose store"})}),n&&_(Kz,{on_close:t?void 0:()=>i(!1)})]})}const Qz=Xz(Zz);var au={},eL=Q;Object.defineProperty(au,"__esModule",{value:!0});var y1=au.default=void 0,tL=eL(Z()),nL=ee(),iL=(0,tL.default)((0,nL.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"}),"Save");y1=au.default=iL;const oL=e=>({sync_state_specialised_objects:e.sync.specialised_objects,sync_state_bases:e.sync.bases,ready_for_writing:e.sync.ready_for_writing}),sL={update_sync_status:S.sync.update_sync_status},rL=P(oL,sL);function _L(e){const{sync_state_specialised_objects:t,sync_state_bases:n,ready_for_writing:i}=e,o=t.status==="FAILED"||n.status==="FAILED",s=t.status==="LOADING"||n.status==="LOADING",r=t.status==="SAVING"||n.status==="SAVING",a=[t.error_message,n.error_message].filter(me).join(", "),c=s||r,l=cL();let d=Wt(t.status||"");return n.status&&n.status!=="LOADED"&&n.status!=="SAVED"&&(d+=n.status!==t.status&&", "+Wt(n.status)||""),d?_(se,{component:"span",children:_(Se,{className:l.button,size:"small",disabled:!i,onClick:async p=>{p.currentTarget.blur();const f=Ae();await Aw(f,!0)},startIcon:o?_(su,{color:"error"}):_(y1,{className:c?"animate spinning":""}),title:o?a:d,children:[_(se,{className:`${l.animate} ${l.initially_shown} show`,color:o?"error":"initial",component:"span",noWrap:!0,children:o?"Failed!":d}),_(se,{className:`${l.animate} ${l.initially_hidden} hide`,color:"initial",component:"span",noWrap:!0,children:o?"Retry Now":"Save Now"}),_(se,{component:"span",children:" "})]})}):null}const aL=rL(_L),cL=Pt(e=>({button:{textTransform:"none","&:hover .show":{fontSize:0},"&:focus .show":{fontSize:0},"&:hover .hide":{fontSize:"initial"},"&:focus .hide":{fontSize:"initial"}},animate:{transitionProperty:"all",transitionDuration:"0.23s"},initially_hidden:{fontSize:0},initially_shown:{fontSize:"initial"}}));var cu={},lL=Q;Object.defineProperty(cu,"__esModule",{value:!0});var k1=cu.default=void 0,dL=lL(Z()),uL=ee(),pL=(0,dL.default)((0,uL.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"}),"AccountCircle");k1=cu.default=pL;const mL="(No user name)";var lu={},fL=Q;Object.defineProperty(lu,"__esModule",{value:!0});var x1=lu.default=void 0,vL=fL(Z()),hL=ee(),gL=(0,vL.default)((0,hL.jsx)("path",{d:"M10.09 15.59 11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"ExitToApp");x1=lu.default=gL;const wL=e=>{const{need_to_handle_password_recovery:t}=e.user_info;return{user:e.user_info.user,need_to_handle_password_recovery:t}},bL={set_user:S.user_info.set_user,set_need_to_handle_password_recovery:S.user_info.set_need_to_handle_password_recovery},yL=P(wL,bL);function kL(e){const{on_close:t,user:n,set_user:i,need_to_handle_password_recovery:o,set_need_to_handle_password_recovery:s}=e,[r,a]=D(""),[c,l]=D(null);if(!n)return null;async function d(){const f=Ce(),m=n==null?void 0:n.email,v=await f.auth.updateUser({email:m,password:r});l(v.error),v.error||(i({user:v.data.user}),s(!1),t())}const p=xL();return _(Ah,{className:"section",children:[o&&_("p",{children:"Please set a new password."}),_(I,{className:p.root,children:[_(ot,{variant:"standard",children:_(In,{inputProps:{type:"password"},onBlur:f=>a(f.currentTarget.value),onChange:f=>a(f.currentTarget.value),onKeyUp:f=>a(f.currentTarget.value),label:"password",size:"small",value:r,variant:"outlined"})}),_(I,{className:p.update_button_container,children:_(Se,{className:p.update_button,disabled:!n.email||!r,onClick:d,variant:"contained",children:"Update password"})}),_(I,{children:!o&&_(Se,{variant:"contained",onClick:()=>{t(),l(null)},children:"Cancel"})})]}),_(ss,{error:c})]})}const xL=Pt(()=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),SL=yL(kL),AL=e=>{const{user:t,users_by_id:n}=e.user_info;return{user:t,users_by_id:n,need_to_set_user_name:Sl(e)}},$L={},CL=P(AL,$L);function jL(e){const{on_close:t,user:n,need_to_set_user_name:i}=e,[o,s]=D(""),r=(e.users_by_id||{})[(n==null?void 0:n.id)||""],a=(r==null?void 0:r.name)||"";re(()=>s(a),[a]);const[c,l]=D("initial"),d=c==="in_progress",[p,f]=D(null);if(!n)return null;const{id:m}=n;async function v(){var y;const w=Ce();l("in_progress");const{data:b,error:g}=await w.from("users").upsert({id:m,name:o}).eq("id",m).select();f(g),((b&&((y=b[0])==null?void 0:y.name))??void 0)&&G.user.pub("stale_users_by_id",!0),l(g?"error":"success")}const h=TL();return _(Ah,{className:"section",children:[_(I,{className:h.root,children:[_(ot,{variant:"standard",children:_(In,{disabled:d,onChange:w=>{s(w.currentTarget.value)},onBlur:w=>{s(w.currentTarget.value)},placeholder:"Username",size:"small",value:o,variant:"outlined"})}),_(I,{className:h.update_button_container,children:_(Se,{className:h.update_button,disabled:!o||d,onClick:v,variant:"contained",children:[i?"Set":"Change"," username"]})}),_(I,{children:!i&&_(Se,{variant:"contained",onClick:()=>{t(),f(null)},children:"Close"})})]}),d&&"Saving...",c==="success"&&"Saved.",_(bo,{error:p})]})}const TL=Pt(e=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},username_input:{borderTopRightRadius:0,borderBottomRightRadius:0},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),PL=CL(jL),NL=e=>{const{need_to_handle_password_recovery:t}=e.user_info;return{user:e.user_info.user,user_name:us(e),need_to_set_user_name:Sl(e),need_to_handle_password_recovery:t}},EL={set_user:S.user_info.set_user},IL=P(NL,EL),DL=Pt(e=>({root:{margin:5},section:{display:"flex",justifyContent:"space-between",alignItems:"center"},logout_section:{flexBasis:"100%"},button:{marginBottom:5},label:{marginBottom:10}}));function RL(e){const{user:t,user_name:n,need_to_set_user_name:i,need_to_handle_password_recovery:o,set_user:s}=e,[r,a]=D("initial"),[c,l]=D(null);if(console.log("user account info form need_to_set_user_name",i,"form_state",r),re(()=>{i&&a("updating_username")},[i,r]),!t)return null;if(r==="updating_password"||o)return _(SL,{on_close:()=>a("initial")});if(r==="updating_username")return _(PL,{on_close:()=>a("initial")});const d=DL();return _(I,{className:d.root,children:[_(I,{className:`${d.section} ${d.logout_section} section`,children:[_("p",{children:["Logged in with",_("strong",{children:[" ",t.email," "]})]}),_(I,{children:_(Se,{onClick:()=>Pw(!0),variant:"contained",endIcon:_(x1,{}),children:"Log out"})})]}),_(I,{className:`${d.section} section`,display:"flex",justifyContent:"space-between",children:[_(se,{component:"p",children:["User name ",_("strong",{children:n?`: ${n}`:""}),_("br",{}),_("small",{children:["user id:   ",t.id]})]}),_(I,{children:[_(Se,{className:d.button,variant:"contained",onClick:()=>a("updating_username"),children:[i?"Set":"Change"," username"]}),_("br",{}),_(Se,{variant:"contained",onClick:()=>a("updating_password"),children:"Change password"})]})]}),_(ss,{error:c})]})}const OL=IL(RL);function ML(e){const{on_close:t}=e;return _(ji,{title:_("div",{style:{margin:10,textAlign:"center"},children:_("h2",{children:"User Account"})}),size:"medium",on_close:t?n=>{n==null||n.stopImmediatePropagation(),t()}:void 0,child:_("div",{style:{textAlign:"center"},children:_(OL,{on_close:t})})})}const qL={set_user:S.user_info.set_user},VL=P(null,qL);function FL(e){const{set_user:t}=e,n=Ce(),[i,o]=D("initial"),[s,r]=D(""),[a,c]=D(""),[l,d]=D(null),[p,f]=D(!1),[m,v]=D(!1);function h(y){r(y),f(!1)}function w(y){c(y),v(!1)}async function b(){if(!s||!a){s||f(!0),a||v(!0);return}const{error:y}=await n.auth.signUp({email:s,password:a,options:{emailRedirectTo:"https://datacurator.org/app/"}});d(y),y||o("registered")}async function g(){if(!s||!a){s||f(!0),a||v(!0);return}const{data:{user:y},error:$}=await n.auth.signInWithPassword({email:s,password:a});d($),t({user:y||void 0})}async function k(){if(!s){f(!0),v(!1);return}const{error:y}=await n.auth.resetPasswordForEmail(s);d(y),y||o("reset_password")}return i==="initial"?_("div",{className:"section",children:[_("form",{children:[_("br",{}),_("br",{}),_("input",{type:"email",placeholder:"email",value:s,onKeyUp:y=>h(y.currentTarget.value),onChange:y=>h(y.currentTarget.value),onBlur:y=>h(y.currentTarget.value)}),_("div",{className:"error_form_input_empty "+(p?"":"inactive"),children:"Email required"}),_("br",{}),_("input",{type:"password",placeholder:"password",value:a,onKeyUp:y=>w(y.currentTarget.value),onChange:y=>w(y.currentTarget.value),onBlur:y=>w(y.currentTarget.value)}),_("div",{className:"error_form_input_empty "+(m?"":"inactive"),children:"Password required"})]}),_("div",{children:[_("br",{}),_("input",{type:"button",onClick:g,value:"Signin"}),"  ",_("input",{type:"button",onClick:b,value:"Register"}),_("br",{}),_("br",{}),_("input",{type:"button",onClick:k,value:"Forgot password?"}),_("br",{}),_("br",{})]}),_(ss,{error:l}),_("br",{})]}):i==="reset_password"?_("div",{className:"section",children:[_("h3",{children:"Password reset"}),_("br",{}),!l&&"Please check your email",_(ss,{error:l})]}):_("div",{className:"section",children:[_("h3",{children:"Registered"}),_("br",{}),"Please check your email"]})}const zL=VL(FL);function LL(e){return _(ji,{title:_("div",{style:{margin:10,textAlign:"center"},children:_("h2",{children:"Signin / Register"})}),size:"medium",on_close:e.on_close,child:_("div",{style:{textAlign:"center"},children:_(zL,{})})})}const BL=e=>({user:e.user_info.user,bases_by_id:e.user_info.bases_by_id,users_by_id:e.user_info.users_by_id,chosen_base_id:e.user_info.chosen_base_id,user_name:us(e),need_to_set_user_name:Sl(e)}),UL={},WL=P(BL,UL);function HL(e){const{user:t,bases_by_id:n,users_by_id:i,chosen_base_id:o,user_name:s,need_to_set_user_name:r}=e,a=!i,[c,l]=D("hidden"),d=De(t),p=s||mL;return re(()=>{const f=!d.current&&t;d.current=t;const m=n&&o?!n[o]:!1;l(!t&&m?"signin":a?"loading":r?"account_info":f?"hidden":c)},[t,n,o,a,r]),_("div",{children:[_(Se,{color:"primary",endIcon:_(k1,{}),fullWidth:!0,disableElevation:!0,onClick:()=>l(t?"account_info":"signin"),size:"small",style:{textTransform:"none"},variant:"contained",children:_(se,{noWrap:!0,children:t?p:a?"Loading":"Sign in"})}),c==="signin"&&_(LL,{on_close:()=>l("hidden")}),c==="account_info"&&_(ML,{on_close:r?void 0:()=>l("hidden")})]})}const GL=WL(HL);var du={},KL=Q;Object.defineProperty(du,"__esModule",{value:!0});var S1=du.default=void 0,YL=KL(Z()),JL=ee(),XL=(0,YL.default)((0,JL.jsx)("path",{d:"M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16.02H3V4.98h18v14.04zM10 12H8l4-4 4 4h-2v4h-4v-4z"}),"PresentToAll");S1=du.default=XL;const ZL=e=>{const t=wA(e);return{presenting:e.display_options.consumption_formatting,access_level:t}},QL={toggle_consumption_formatting:S.display.toggle_consumption_formatting,change_route:S.routing.change_route},eB=P(ZL,QL);function tB(e){const{access_level:t}=e,n=t==="viewer"||t==="none",i=!e.presenting,[o,s]=D(void 0),r=De(!1);re(()=>{t!==void 0&&(r.current||(r.current=!0,s(n)))},[t]);const a=n?"No editing rights":"",c=n?e.presenting?"rgba(183, 28, 26, 0.5)":"rgba(183, 28, 26)":"",l=Ed();return _(Dn,{size:"small",children:[_(He,{title:a,"aria-label":a,children:_(ue,{className:l.inverse_disabled,disabled:i,onClick:i?void 0:e.toggle_consumption_formatting,value:"editing",size:"large",children:_(_u,{style:{color:c}})})}),_(ue,{className:l.inverse_disabled,disabled:e.presenting,onClick:e.toggle_consumption_formatting,value:"presenting",size:"large",children:_(S1,{})})]})}const nB=eB(tB),iB=e=>{const t=e.routing.args.subview_id;return{ready_for_reading:e.sync.ready_for_reading,presenting:e.display_options.consumption_formatting,view:e.routing.args.view,kv_id:t,nested_kv_ids_map:e.derived.nested_knowledge_view_ids}},oB={toggle_consumption_formatting:S.display.toggle_consumption_formatting,change_route:S.routing.change_route},sB=P(iB,oB);function rB(e){if(!e.ready_for_reading)return null;const{kv_id:t,nested_kv_ids_map:n}=e;let i=n.map[t];const o=[];let s=yd;for(;i;){const c=i.child_ids.map(l=>n.map[l]).filter(me);if(c.length){const l=c.map(hh);o.unshift({options:l,selected_id:s,parent_id:i.id})}s=i.id,i=i.parent_id!==void 0?n.map[i.parent_id]:void 0}const r=n.top_ids.map(c=>n.map[c]).filter(me).map(hh);o.unshift({options:r,selected_id:s,parent_id:void 0});const a=e.view!=="knowledge"||cB.length>1;return _(X1,{style:{marginTop:"8px"},children:[a&&_(I,{children:_(Sh,{variant:"standard",label:_(se,{noWrap:!0,children:"View Type:"}),name:"select_view",value:e.view,children:A1.map(c=>_(rs,{value:c.id,selected:c.id===e.view,disabled:!c.selectable,onPointerDown:l=>{l.stopImmediatePropagation(),e.change_route({args:{view:c.id}})},children:c.title}))})}),o.map(c=>_(I,{children:_(de,{allow_none:c.parent_id!==void 0,selected_option_id:c.selected_id,options:c.options,on_change:l=>e.change_route({args:{subview_id:l||c.parent_id}}),on_choose_same:l=>e.change_route({args:{subview_id:l||c.parent_id}}),editing_allowed:!0,threshold_minimum_score:!1,retain_options_order:!0})}))]})}const _B=sB(rB),aB=Ki.get_state(),A1=[{id:"knowledge",title:"Knowledge",selectable:!0},{id:"actions_list",title:"Actions list",selectable:aB.enable_action_kanban_view}],cB=A1.filter(e=>e.selectable);function hh(e){const t=e.sort_type==="hidden"||e.sort_type==="archived"||e.sort_type==="errored",n=e.sort_type==="errored"?lB:void 0;return{id:e.id,title:e.title,is_hidden:t,color:n}}const lB={r:231,g:190,b:201,a:1},dB=e=>({display_side_panel:e.controls.display_side_panel,animate_connections:e.display_options.animate_connections,network_functional:e.sync.network_functional,network_function_last_checked:e.sync.network_function_last_checked}),uB=P(dB);function pB(e){return re(()=>{e.network_functional||setTimeout(()=>{Ew(Ae())},1e3)},[e.network_functional,e.network_function_last_checked]),_(Uc,{injectFirst:!0,children:_(Wc,{theme:bh,children:[_(Z1,{}),_(fB,{...e})]})})}const mB=uB(pB);function fB(e){const t=vB();return _(Re,{children:[!e.network_functional&&_(ji,{title:"",size:"small",child:_(I,{children:[_(se,{id:"modal-modal-title",variant:"h6",component:"h2",children:"Reconnecting..."}),_(se,{id:"modal-modal-description",sx:{mt:2},children:["Last attempt: ",ii({date:e.network_function_last_checked,time_resolution:"second"})]})]})}),_(I,{id:"app",className:t.root,children:[_(Q1,{elevation:1,id:"header",position:"fixed",className:"app_header "+t.app_bar,children:_(xh,{variant:"dense",className:t.toolbar,children:[_(I,{className:`${t.toolbar_section} ${t.grow} ${t.small_full_width}`,children:[_(I,{className:`${t.toolbar_item}`,children:_(nB,{})}),_(I,{className:`${t.toolbar_item} ${t.grow}`,children:_(_B,{})})]}),_(I,{className:`${t.toolbar_section} ${t.small_full_width}`,justifyContent:"flex-end",children:[_(I,{className:`${t.toolbar_item}`,children:[_(Td,{}),_(h0,{})]}),_(I,{className:`${t.toolbar_item}`,children:_(yO,{})}),_(I,{className:`${t.toolbar_item}`,children:_(aL,{})}),_(I,{className:`${t.toolbar_item}`,children:_(Qz,{})}),_(I,{className:`${t.toolbar_item}`,children:_(GL,{})}),_(I,{className:`${t.toolbar_item}`,children:_(rz,{})})]})]})}),_(I,{id:"app_content",component:"div",className:ek(t.content,{[t.content_with_open_side_panel]:e.display_side_panel,animate_connections:e.animate_connections}),children:_(bO,{})}),_(tk,{anchor:"right",className:t.drawer,open:e.display_side_panel,variant:"persistent",children:_(I,{component:"aside",className:t.side_panel,id:"side_panel",children:_(I,{id:"side_panel_content",className:t.side_panel_content,children:[_(J9,{}),_(XF,{})]})})}),_(I,{className:t.help_popup,children:_(A9,{})})]})]})}const vB=Pt(e=>({root:{width:"100%",height:"100%",overflow:"hidden",display:"flex"},app_bar:{transition:e.transitions.create(["all"],{easing:e.transitions.easing.sharp,duration:e.transitions.duration.leavingScreen}),zIndex:e.zIndex.drawer+1},app_bar_with_open_side_panel:{},content:{width:"100%",flexGrow:1,display:"flex",marginRight:-Ji,transition:e.transitions.create(["margin"],{easing:e.transitions.easing.sharp,duration:e.transitions.duration.leavingScreen})},content_with_open_side_panel:{marginRight:0,transition:e.transitions.create(["margin"],{easing:e.transitions.easing.easeOut,duration:e.transitions.duration.enteringScreen})},drawer:{width:Ji,flexShrink:0},side_panel:{backgroundColor:e.palette.background.paper,width:Ji,position:"relative",paddingTop:50},side_panel_content:{marginTop:10,padding:10},sidebar_toolbar:{flexGrow:1,justifyContent:"flex-end"},toolbar:{flexGrow:1,justifyContent:"space-between",flexWrap:"wrap",[e.breakpoints.up("md")]:{flexWrap:"nowrap"}},toolbar_section:{display:"inherit",flexGrow:0,flexShrink:1,flexBasis:"auto",marginRight:5,"&:last-child":{marginRight:0},"&:empty":{display:"none"}},toolbar_item:{marginRight:5,"&:last-child":{marginRight:0}},help_popup:{position:"relative",zIndex:e.zIndex.drawer+1},small_full_width:{[e.breakpoints.down("md")]:{flexGrow:0,flexShrink:1,flexBasis:"100%",margin:0}},grow:{flexGrow:1},hide:{display:"none"},warning_icon:{color:e.palette.warning.main}}));h9();function uu(e=!1){const n=qs().derived.current_composed_knowledge_view;if(e&&!n)throw new Error("Lacking current_composed_knowledge_view");return n}function Ms(){return qs().specialised_objects.wcomponents_by_id}function $1(e={}){const t=uu(!0),n=Ms(),{causal_only:i=!0}=e,o=new Set(Object.keys(t.composed_visible_wc_id_map)),a=Array.from(i?t.wc_ids_by_type.causal_link:t.wc_ids_by_type.any_link).filter(d=>o.has(d)).map(d=>n[d]).filter(ye).filter(d=>d.from_id&&d.to_id).filter(d=>n[d.from_id]&&n[d.to_id]),c=new Set,l={};return a.forEach(d=>{c.add(d.from_id),c.add(d.to_id);const p=l[d.from_id]||{};l[d.from_id]=p;const f=p[d.to_id]||[];p[d.to_id]=f;let m=1;an(d)&&(m=d.effect_when_true??1),f.push(m)}),{node_ids_connections_map:l,node_ids:c}}function hB(e={}){const{node_ids_connections_map:t,node_ids:n}=$1(e),i=[],o=[""];return i.push(o),Array.from(n).forEach(s=>o.push(s)),Array.from(n).forEach(s=>{const r=[s];Array.from(n).forEach(a=>{const c=(t[a]||{})[s]||[];r.push(c)}),i.push(r)}),i}function gB(){const e=uu(!0),t=Ms(),i=Object.keys(e.composed_visible_wc_id_map).map(s=>t[s]).filter(me),o={};return i.forEach(s=>{!s.label_ids||s.label_ids.length===0||(o[s.id]=s.label_ids)}),o}function wB(){const e=Ms(),t=gB(),n={},i={};return Object.entries(t).forEach(([o,s])=>{const r=s.map(a=>{const c=e[a];if(!c)return"";const l=n[a]||c.title;return n[a]=l,l});i[o]=r}),i}function C1(e,t){return e.map(i=>i.map(o=>typeof o!="string"?o:o?t(o):""))}function bB(e,t){const n={},i={};return C1(t,s=>{let r=n[s]||"";if(!r){r=(e[s]||[]).join(",");const c=(i[r]||0)+1;i[r]=c,r+=`_${c}`,n[s]=r}return r})}function yB(e,t){return C1(t,i=>{var o;return((o=e[i])==null?void 0:o.title)||""})}function kB(e){const t=[];return e.forEach(n=>{const i=[];n.forEach(o=>{typeof o=="string"?i.push(o):o.length===0?i.push(""):o.length===1?i.push((o[0]||0).toString()):i.push(JSON.stringify(o))}),t.push(i.join(",")+`
`)}),t.join("")}function xB(){return{get_connection_map:$1,get_connection_matrix:hB,get_component_id_to_label_names_map:wB}}function SB(){const e=qs(),t=e.routing.item_id||"";return e.specialised_objects.wcomponents_by_id[t]}function AB(){const e=qs();return e.meta_wcomponents.selected_wcomponent_ids_list.map(t=>pe(e,t)).filter(Rh)}function $B(){const e={get_current_visible_graph:xB,matrix_component_ids_to_labels:bB,matrix_component_ids_to_titles:yB,matrix_to_csv:kB,get_current_kv:uu,get_wcomponents_by_id:Ms,create_wcomponent:xi,get_current_wcomponent:SB,get_selected_wcomponents:AB};window.console_api=e}function qs(){return window.debug_state}const Bc=document.getElementById("root");if(Bc){Bc.innerText="";const e=Ae({load_state_from_storage:!0});_k(_(ak,{store:e,children:_(mB,{})}),Bc)}gh();e3();$B();
