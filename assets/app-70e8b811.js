var z0=Object.defineProperty;var L0=(e,t,n)=>t in e?z0(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var dt=(e,t,n)=>(L0(e,typeof t!="symbol"?t+"":t,n),n);import{g as ke,s as Fh,A as B0,p as yn,f as zh,t as Lh,r as Q,W as U0,D as Bh}from"./set_window_title-9308b340.js";import{u as _,b as je,H as W0,c as kn,i as ee,r as te,a as ae,y as H0,B as R,A as bi,d as yi,e as ki,F as et,f as Wn,R as Kd,g as pi,h as mi,S as Ac,T as $c,j as ze,I as ce,k as G0,l as K0,D as Po,n as Uh,M as Kc,o as Y0,m as Ct,p as Gi,q as Wh,s as J0,t as Hh,v as X0,w as Z0,x as Q0,z as e1,E as t1,G as n1,J as i1,K as Gh,L as Kh,N as o1,O as s1,P as r1,Q as _1,U as a1}from"./common_style_libraries-98c71f0d.js";import{j as c1,n as l1,o as j,d as I,A as Ee,y as oe,p as uo,r as d1,s as u1,e as Yh,b as Yd,t as p1,T as G,u as Jh,k as ue,v as Xh,i as m1,P as f1}from"./common_libraries-f830e8e5.js";function h1(e,t){for(var n=0;n<t.length;n++){const i=t[n];if(typeof i!="string"&&!Array.isArray(i)){for(const o in i)if(o!=="default"&&!(o in e)){const s=Object.getOwnPropertyDescriptor(i,o);s&&Object.defineProperty(e,o,s.get?s:{enumerable:!0,get:()=>i[o]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}function v1(e){return e&&(e.min||e.value||e.max)}function Zh(e){return v1(e)===void 0}const g1={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function Zt(e,t){const n={M:e.getMonth()+1,d:e.getDate(),h:e.getHours(),m:e.getMinutes(),s:e.getSeconds()};return t=t.replace(/MMM/g,function(i){return g1[e.getMonth()]||""}),t=t.replace(/(M+|d+|h+|m+|s+)/g,function(i){const o=i.slice(-1);return((i.length>1?"0":"")+n[o]).slice(-2)}),t.replace(/(y+)/g,function(i){return e.getFullYear().toString().slice(-i.length)})}function Go(e){const{date:t,time_resolution:n="minute",trim_midnight:i=!0}=e,s=Zt(t,n==="day"?"yyyy-MM-dd":n==="hour"?"yyyy-MM-dd hh:00":n==="minute"?"yyyy-MM-dd hh:mm":"yyyy-MM-dd hh:mm:ss");return i?s.replace(" 00:00",""):s}function Ko(e=!0){return Zt(new Date,"yyyy-MM-dd")+(e?" 00:00":"")}function w1(){return new Date(Ko())}new Date().getTimezoneOffset()*6e4;function Ln(e){const{date:t}=e;return t&&Yc(t)?Go({...e,date:t}):""}function Qh(e,t){let n="Eternal";if(!Zh(e)){const i=Ln({date:e.min,time_resolution:t}),o=Ln({date:e.value,time_resolution:t}),s=Ln({date:e.max,time_resolution:t});if(o&&!i&&!s)return o;n=[i,i?" ":"","<",o?" ":"",o,o?" ":"","<",s?" ":"",s].filter(a=>a).join("")}return n}function Yc(e){return!Number.isNaN(e.getTime())}function ji(e){const t=new Date(e);return Yc(t)?t:void 0}function Io(e,t={}){const n=t.sort_items??!1,i=t.render_undefined??!1,o=typeof t.space=="number"?Array(t.space+1).join(" "):t.space||"",s=typeof t.cycles=="boolean"?t.cycles:!1,r=t.replacer||((l,d)=>b1(d)?d.toISOString():d instanceof Set?Array.from(d).sort():d),a=t.comparison_function&&function(l){return function(d,p){return t.comparison_function({key:d,value:l[d]},{key:p,value:l[p]})}},c=[];return function l(d,p,f,m){const h=o?`
`+new Array(m+1).join(o):"",v=o?": ":":";if(f=r.call(d,p,f),f===void 0)return i?"undefined":void 0;if(typeof f!="object"||f===null)return JSON.stringify(f);if(Array.isArray(f)){const w=[];for(let x=0;x<f.length;x++){const y=l(f,x,f[x],m+1)||JSON.stringify(null);w.push(h+o+y)}return"["+w.join(",")+h+"]"}if(c.indexOf(f)!==-1){if(s)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else c.push(f);let g=Object.keys(f);n&&(g=g.sort(a&&a(f)));const b=[];return g.forEach(w=>{const x=l(f,w,f[w],m+1);if(!x)return;const y=JSON.stringify(w)+v+x;b.push(h+o+y)}),c.splice(c.indexOf(f),1),"{"+b.join(",")+h+"}"}({"":e},"",e,0)}function b1(e){return Object.prototype.toString.call(e)==="[object Date]"}let _t={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0};const Jd={get:()=>_t,reset:()=>{_t={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0}},print:()=>{const e=_t;console.log(`
describe: ${e.describe_run+e.describe_skipped}
tests: ${e.test_run+e.test_skipped}`);const t=e.describe_skipped+e.test_skipped;console.log(`%cskipped: ${t}`,`color:${t?"tan":"LightGrey"};font-weight:bold;`),e.test_failed.length&&console.error("failed: "+e.test_failed.join(`
failed: `)),console.log(`%cpassed: ${e.test_passed}${e.test_failed.length?`
failed: ${e.test_failed.length}`:""}
    `,`color:${e.test_failed.length?"red":"green"};font-weight:bold;`)}},ev=!0,y1=(e,t,n="",i=ev)=>{_t.test_run+=1;const o={render_undefined:!0,sort_items:i},s=Io(e,o),r=Io(t,o);if(s===r){_t.test_passed+=1;const c=n.split(`
`).filter(l=>l.trim())[0];console.log(`pass:  ${c}`)}else{const c=`${n} "${s}" !== "${r}"`;Oi(c,e,t,i)}};function Oi(e,t,n,i=ev){_t.test_failed.push(e),console.error(`fail:  ${e}`);const o={render_undefined:!0,sort_items:i};try{if((t==null?void 0:t.constructor)===Object&&(n==null?void 0:n.constructor)===Object){const s=[...new Set([...Object.keys(t),...Object.keys(n)])];s.sort(),s.forEach(r=>{const[a,c]=[t,n],l=a[r],d=c[r],p=Io(l,o),f=Io(d,o);if(!(p===f))console.debug(`Test failure: different values for key "${r}", got: '${p}', but expected: '${f}'`);else if(p==="undefined"){const h=r in a,v=r in c;h!==v&&console.debug(`Test failure: key "${r}", got: ${h?"present":"not present"}, but expected: ${v?"present":"not present"}`)}})}}catch(s){console.debug("error in providing debugging for test failure",s)}}const u=y1;u.skip=(e,t,n="")=>{_t.test_skipped+=1,console.warn("skipping  "+n)};const k1=async(e,t)=>{let n;if(tv(t))n=async()=>{_t.describe_run+=1,console.group(e);try{await t()}catch(i){Oi(`error in test: ${i}`,null,null)}console.groupEnd()},await n();else{const i=t;n=()=>{_t.describe_run+=1,console.group(e);try{i()}catch(o){Oi(`error in test: ${o}`,null,null)}console.groupEnd()},n()}return n},k=k1;k.skip=e=>{function t(){_t.describe_skipped+=1,console.warn("skipping  "+e)}return t};k.delay=(e,t)=>{let n;if(tv(t))n=async()=>{_t.describe_run+=1,console.group(e);try{await t()}catch(i){Oi(`error in test: ${i}`,null,null)}console.groupEnd()};else{const i=t;n=()=>{_t.describe_run+=1,console.group(e);try{i()}catch(o){Oi(`error in test: ${o}`,null,null)}console.groupEnd()}}return n};function tv(e){return e.constructor.name==="AsyncFunction"}var Z=(e=>(e[e.past=0]="past",e[e.present=1]="present",e[e.future=2]="future",e[e.eternal=3]="eternal",e))(Z||{});function me(e,t){const{min:n,value:i,max:o}=e.datetime||{},[s,r]=n===void 0?[!1,0]:[!0,n.getTime()],[a,c]=i===void 0?[!1,0]:[!0,i.getTime()],[l,d]=o===void 0?[!1,0]:[!0,o.getTime()];if(s){if(r>t)return Z.future;if(r===t||!l&&r<t)return Z.present}if(l)return d<=t?Z.past:Z.present;if(a){if(c<t)return Z.past;if(c===t)return Z.present;if(c>t)return Z.future}return Z.eternal}const x1=k.delay("get_tense_of_uncertain_datetime",()=>{let e;const n=new Date("2021-04-01 00:01").getTime(),i=new Date("2021-04-01 00:02"),o=i.getTime(),s=new Date("2021-04-01 00:03"),r=s.getTime(),a=new Date("2021-04-01 00:04"),c=a.getTime(),d=new Date("2021-04-01 00:05").getTime();e=me({datetime:{}},n),u(e,Z.eternal),e=me({datetime:{min:i}},n),u(e,Z.future),e=me({datetime:{min:i}},o),u(e,Z.present),e=me({datetime:{min:i}},r),u(e,Z.present),e=me({datetime:{value:i}},n),u(e,Z.future),e=me({datetime:{value:i}},o),u(e,Z.present),e=me({datetime:{value:i}},r),u(e,Z.past),e=me({datetime:{max:i}},n),u(e,Z.present),e=me({datetime:{max:i}},o),u(e,Z.past),e=me({datetime:{max:i}},r),u(e,Z.past),e=me({datetime:{min:i,max:s}},n),u(e,Z.future),e=me({datetime:{min:i,max:s}},o),u(e,Z.present),e=me({datetime:{min:i,max:s}},r),u(e,Z.past),e=me({datetime:{min:i,max:s}},c),u(e,Z.past),e=me({datetime:{min:i,value:s,max:a}},n),u(e,Z.future),e=me({datetime:{min:i,value:s,max:a}},o),u(e,Z.present),e=me({datetime:{min:i,value:s,max:a}},r),u(e,Z.present),e=me({datetime:{min:i,value:s,max:a}},c),u(e,Z.past),e=me({datetime:{min:i,value:s,max:a}},d),u(e,Z.past)});function S1(e){return e.custom_created_at||e.created_at}function A1(e){return S1(e).getTime()}function $1(e){const{items:t,created_at_ms:n}=e,i=[],o=[];return t.forEach(s=>{A1(s)>n?i.push(s):o.push(s)}),{invalid_future_items:i,current_items:o}}const C1=k.delay("partition_items_by_created_at_datetime",()=>{function e(m){const h=$1(m);return{invalid_future_items:h.invalid_future_items.map(({id:v})=>v),current_items:h.current_items.map(({id:v})=>v)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime(),p={base_id:-1,id:"1",created_at:s},f={base_id:-1,id:"2",created_at:a};t=[],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[]}),t=[p,f],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:c}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:r}),u(n,{invalid_future_items:[f.id],current_items:[p.id]}),n=e({items:t,created_at_ms:o}),u(n,{invalid_future_items:[p.id,f.id],current_items:[]})});var nv=(e=>(e[e.ascending=0]="ascending",e[e.descending=1]="descending",e))(nv||{});function T1(e,t,n){const i=E1(n);return e.map((o,s)=>({item:o,key_value:t(o,s)})).sort(i).map(({item:o})=>o)}function E1(e){const t=e===0,n=t?-1:1,i=t?1:-1;return(o,s)=>o.key_value<s.key_value?n:o.key_value>s.key_value?i:0}function j1(e,t=nv.descending){return T1(e,({datetime:i})=>{if(Zh(i))return Number.NEGATIVE_INFINITY;const{max:o,value:s,min:r}=i;return r?r.getTime()*10+2:s?s.getTime()*10+1:o?o.getTime()*10:1},t)}function N1(e){const{sorted_items:t,sim_ms:n}=e;let i=[],o=[],s=[];const r=[];t.forEach(c=>{const l=me(c,n);l===Z.past?i.push(c):l===Z.future?r.push(c):l===Z.present?o.push(c):s.push(c)}),o.length!==1&&(o.length>1?(i=o.slice(1).concat(i),o=o.slice(0,1)):i.length&&(o=i.slice(0,1),i=i.slice(1))),s.length&&(o.length!==1&&(o=s.slice(0,1),s=s.slice(1)),i=i.concat(s));const a=o[0];return{past_items:i,present_item:a,future_items:r}}const P1=k.delay("partition_sorted_items_by_datetimes",()=>{function e(p){var m;const f=N1(p);return{past_items:f.past_items.map(({id:h})=>h),present_item:(m=f.present_item)==null?void 0:m.id,future_items:f.future_items.map(({id:h})=>h)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime();t=[],n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:[],present_item:void 0,future_items:[]}),t=[{id:"10",datetime:{}},{id:"11",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:["11"],present_item:"10",future_items:[]},"Can handle multiple eternal elements"),t=[{id:"30",datetime:{value:a}},{id:"20",datetime:{value:s}},{id:"10",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:"10",future_items:["30","20"]},"Should partition eternal item as present if other items are in the future"),n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:["10"],present_item:"20",future_items:["30"]},"Should partition eternal item as past if other items are in the present"),n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]},"Should partition eternal item and other past items as past if other items are in the present"),n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]}),t=[{id:"40",datetime:{min:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"40",future_items:[]},"Should find min datetime as present when sim_ms is equal to min datetime"),n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:void 0,future_items:["40"]},"Should find min datetime as future when sim_ms is before min datetime"),t=[{id:"50",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"50",future_items:[]},"Should find max datetime as present when sim_ms is equal to max datetime"),t=[{id:"50",datetime:{max:s}},{id:"60",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["60"],present_item:"50",future_items:[]},"Should find max datetime as past when sim_ms is later than max datetime but when no other item is present, will use one as present item")}),I1=k.delay("sort_by_uncertain_event_datetimes",()=>{function e(E){return j1(E).map(({id:A})=>A)}function t(E,N){const A=[...E].reverse(),M=N.map(({id:T})=>T);i=e(E);const D=e(A);u(i,D,"",!1),u(i,M,"",!1)}let n=[],i,o;const s=new Date("2021-04-01 00:00"),r=new Date("2021-04-01 00:01"),a=new Date("2021-04-01 00:02"),c=new Date("2021-04-01 00:03");let l=0;const d=()=>`${l++}`,p={id:d(),datetime:{}},f={id:d(),datetime:{}},m={id:d(),datetime:{value:r}},h={id:d(),datetime:{value:a}},v={id:d(),datetime:{max:r}},g={id:d(),datetime:{max:a}},b={id:d(),datetime:{min:r}},w={id:d(),datetime:{min:a}},x={id:d(),datetime:{min:s,max:c}},y={id:d(),datetime:{min:r,max:a}};n=[],i=e(n),u(i,[],"",!1),n=[p,f];const $=[...n].reverse();i=e(n);const C=e($);u(JSON.stringify(i)!==JSON.stringify(C),!0,"Should be different (indeterminant sort)"),n=[p,m,h],o=[h,m,p],t(n,o),n=[p,b,w],o=[w,b,p],t(n,o),n=[p,v,g],o=[g,v,p],t(n,o),n=[p,m,h,b,w,v,g],o=[w,h,g,b,m,v,p],t(n,o),n=[p,x,y],o=[y,x,p],t(n,o)}),R1=k.delay("correct_datetime_for_local_time_zone",()=>{let e;e=ji("2021-04-16 15:00"),u(e&&e.toISOString(),"2021-04-16T14:00:00.000Z","Subtracts one hour (as datetime is during summer time BST; and also passes when test is performed during GMT)"),e=ji("2021-04-16 00:00"),u(e&&e.toISOString(),"2021-04-15T23:00:00.000Z","Subtracts one hour, goes back one day (as datetime is during summer time BST; and also passes when test is performed during GMT)"),e=ji("2021-04-16"),u.skip(e&&e.toISOString(),"2021-04-15T23:00:00.000Z","")}),xi=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})$/gi,D1=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,iv=/([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,ov=/@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}/gi,M1=/(.*)(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})(.*)/gi,O1=/^\s*(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\s*$/gi;function Jt(e,t=!1){return t?!!e.match(D1):!!e.match(xi)}const q1=/.*?(@@\w*\d+)\.([\w]+)/g,V1=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\.([\w]+)/gi;function fn(e){return(e.match(ov)||[]).map(n=>n.slice(2))}function Xd(e){return e.match(iv)||[]}function po(e){if(!Number.isInteger(e))throw new Error("uuid_v4_for_tests id must be an integer");if(e<0)throw new Error("uuid_v4_for_tests id must be >=0");return`${e}0000000-0000-4000-a000-000000000000`}const F1=k.delay("id_regexs",()=>{k("uuids_regex",()=>{let e="77777777-7777-4777-8777-777777777777".match(xi);u(e!==null,!0,"should match a valid uuid"),u(e==null?void 0:e[0],"77777777-7777-4777-8777-777777777777","should match a valid uuid"),e="77777777-7777-0777-0777-777777777777".match(xi),u(e===null,!0,"should fail to match a invalid uuid"),e=" 77777777-7777-4777-8777-777777777777".match(xi),u(e===null,!0,"should fail to match a valid uuid with leading space"),e="77777777-7777-4777-8777-777777777777 ".match(xi),u(e===null,!0,"should fail to match a valid uuid with trailing space"),k("is_valid_uuid",()=>{u(Jt("77777777-7777-4777-8777-777777777777"),!0,"should match a valid uuid"),u(Jt("77777777-7777-0777-0777-777777777777"),!1,"should fail to match a invalid uuid"),u(Jt(" 77777777-7777-4777-8777-777777777777"),!1,"should fail to match a valid uuid with leading space"),u(Jt("77777777-7777-4777-8777-777777777777 "),!1,"should fail to match a valid uuid with trailing space"),u(Jt("77777777-7777-4777-8777-777777777777 ",!0),!0,"should match a valid uuid with trailing space if starts_with is true")})}),k("uuids_regexes",()=>{const e=`  77777777-7777-4777-8777-777777777777
        77777777-7777-0777-0777-777777777777
        11111111-1111-4111-8111-111111111111
        `.match(iv);u(e!==null,!0,"should match a string with valid uuids"),u(e==null?void 0:e.length,2,"should match 2 valid uuids"),u(e==null?void 0:e[0],"77777777-7777-4777-8777-777777777777","should match first valid uuid"),u(e==null?void 0:e[1],"11111111-1111-4111-8111-111111111111","should match second valid uuid")})}),z1=k.delay("get_ids_from_text",()=>{let e=[];k("get_double_at_mentioned_uuids_from_text",()=>{e=fn(""),u(e,[],"Should find no IDs in empty string"),e=fn("asd @@wc123 asd name@example.com #label dfg @@345 sf"),u(e,[],'Should not find old ids of "wc123", "345"');const t=po(1),n=po(2);e=fn(`asd @@${t} asd name@example.com #label dfg @@${n} sf`),u(e,[t,n],"Should find uuid ids")}),k("get_uuids_from_text",()=>{e=Xd(""),u(e,[],"Should find no IDs in empty string");const t=po(1),n=po(2);e=Xd(`1 + [${t}] + (2 + [${n}]) * 3`),u(e,[t,n],"Should find uuid ids")})});async function L1(){(await x1)(),(await C1)(),(await P1)(),(await I1)(),(await F1)(),(await z1)(),(await R1)()}function _e(e){if(!Number.isInteger(e))throw new Error("uuid_v4_for_tests id must be an integer");if(e<0)throw new Error("uuid_v4_for_tests id must be >=0");return`${e}0000000-0000-4000-a000-000000000000`}var mo,B1=new Uint8Array(16);function U1(){if(!mo&&(mo=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!mo))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return mo(B1)}const W1=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function H1(e){return typeof e=="string"&&W1.test(e)}var Se=[];for(var Ts=0;Ts<256;++Ts)Se.push((Ts+256).toString(16).substr(1));function G1(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(Se[e[t+0]]+Se[e[t+1]]+Se[e[t+2]]+Se[e[t+3]]+"-"+Se[e[t+4]]+Se[e[t+5]]+"-"+Se[e[t+6]]+Se[e[t+7]]+"-"+Se[e[t+8]]+Se[e[t+9]]+"-"+Se[e[t+10]]+Se[e[t+11]]+Se[e[t+12]]+Se[e[t+13]]+Se[e[t+14]]+Se[e[t+15]]).toLowerCase();if(!H1(n))throw TypeError("Stringified UUID is invalid");return n}function Jc(e,t,n){e=e||{};var i=e.random||(e.rng||U1)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,t){n=n||0;for(var o=0;o<16;++o)t[n+o]=i[o];return t}return G1(i)}function Yo(){return Jc()}const K1=()=>"vps"+Yo(),Y1=()=>"VAP"+Yo(),J1=["meta","validity","state"],X1=["right","left"];var Hn=(e=>(e.curve="curve",e.straight="straight",e.angular="angular",e))(Hn||{});const Z1=["curve","straight","angular"];function sv(e){return!!e}function Xc(e){return on("event",e)}function Ye(e){return on("statev2",e)}function pt(e,t=""){return on("state_value",e,t)}function rv(e){return on("process",e)}function on(e,t,n=""){let i=!1;return n=typeof n=="string"?n:"",t?t.type!==e?n&&console.error(`wcomponent with id "${n}" is not a ${e}`):i=!0:n&&console.error(`wcomponent with id "${n}" does not exist`),i}function ot(e,t=""){return on("action",e,t)}function sn(e){return on("causal_link",e)}function Q1(e){return on("relation_link",e)}function Ne(e){return sn(e)||Q1(e)}function Gn(e){return e==="causal_link"||e==="relation_link"}function ek(e){return Xc(e)||Ye(e)||rv(e)||ot(e)||pt(e)||Zc(e)}function Zc(e,t=""){return on("counterfactualv2",e,t)}function tk(e){return Ne(e)}function _v(e){return e.event_at!==void 0}function Qc(e){return e?e.deleted_at!==void 0:void 0}function Jo(e){return e?e.deleted_at===void 0:void 0}function Ki(e){return e.values_and_prediction_sets!==void 0}function At(e){return Ye(e)||pt(e)||ot(e)}function ni(e){return Ki(e)&&e.values_and_prediction_sets.length>0&&At(e)}function nk(e){return e.calculations!==void 0}function ik(e){return Ye(e)||ot(e)}function O(e){const t={id:Yo(),created_at:new Date,base_id:e.base_id,title:"",description:"",type:"process"};let n;if(e.type==="causal_link"||e.type==="relation_link"){let i={...t,from_id:"",to_id:"",from_type:"state",to_type:"state",...e,type:e.type};sn(i)&&(i={effect_string:"1",effect_when_true:1,effect_when_false:void 0,values_and_prediction_sets:[],...i}),n=i}else e.type==="statev2"?n={...t,subtype:void 0,values_and_prediction_sets:[],...e,type:e.type}:e.type==="action"?n={...t,values_and_prediction_sets:[],reason_for_status:"",depends_on_action_ids:[],...e,type:e.type}:n={...t,...e,type:e.type||"process"};return n}function Rt(e){return O(e)}function Mn(e,t,n){e=e.trim();const i=e.match(ov);if(i&&i[0]===e){const o=i[0].slice(2),s=n[o];t=s==null?void 0:s.units}return t}const ok=k.delay("apply_units_from_component",()=>{let e,t,n={},i,o;const s=_e(1),r=_e(2),c=O({base_id:0,id:s,title:"Some state component",type:"statev2",units:"seconds"});n={[s]:c},t=`@@${s}`,e="",o="seconds",i=Mn(t,e,n),u(i,o,"Can access a wcomponent's value and uses its units when no units given by calculation"),t=`  @@${s}  `,e="",o="seconds",i=Mn(t,e,n),u(i,o,"Uses a wcomponent's units, even with surrounding whitespace"),t=`@@${s}`,e="Unitless",o="seconds",i=Mn(t,e,n),u(i,o,"Silently uses a wcomponent's units even when units given by calculation"),t=`@@${s} + 1`,e="meters",o="meters",i=Mn(t,e,n),u(i,o,"Ignores component units if calculation value is not just a @@uuid"),t=`@@${r}`,e="meters",o=void 0,i=Mn(t,e,n),u(i,o,"Defaults units to undefined when component can not be found, even if calculation has units given")}),sk=/.*?(\d*(?:\.\d+)?(?:e(?:-|\+)\d+)?\s*\%)/g;function an(e){let t=e;return[...t.matchAll(sk)].forEach(i=>{const o=i[1];o&&(t=t.replace(o,"("+o.replace(/\s*\%/," * 0.01")+")"))}),t}const rk=k.delay("convert_percentages",()=>{let e="",t="",n="";e="90 %",t="(90 * 0.01)",n=an(e),u(n,t,"Convert percentage symbol to numbers"),e="90 % / 10%",t="(90 * 0.01) / (10 * 0.01)",n=an(e),u(n,t,"Convert percentage symbols without spaces to numbers"),e="90.123 %",t="(90.123 * 0.01)",n=an(e),u(n,t,"Convert percentage symbols with decimal places"),e=".123 %",t="(.123 * 0.01)",n=an(e),u(n,t,"Convert percentage symbols with decimal point and no leading digit"),e="90.123 % - -90.123 %",t="(90.123 * 0.01) - -(90.123 * 0.01)",n=an(e),u(n,t,"Convert negative or positive percentage symbols"),e="9.1e+1 % - 9.1e-1 %",t="(9.1e+1 * 0.01) - (9.1e-1 * 0.01)",n=an(e),u(n,t,"Convert scientific notation percentage symbols")}),qi={"£":"CURRENCY_POUND",$:"CURRENCY_DOLLAR","€":"CURRENCY_EURO","¥":"CURRENCY_YUAN_TWO",Ұ:"CURRENCY_YUAN_ONE","₹":"CURRENCY_RUPEE_RX","₨":"CURRENCY_RUPEE_RS","¢":"CURRENCY_GHANA_CEDI","؋":"CURRENCY_AFGHANISTAN_AFGHANI","฿":"CURRENCY_THAILAND_BAHT","៛":"CURRENCY_CAMBODIA_RIEL","₡":"CURRENCY_COSTA_RICA_COLON","₦":"CURRENCY_NIGERIA_NAIRA","₩":"CURRENCY_KOREA_WON","₪":"CURRENCY_ISRAEL_SHEKEL","₫":"CURRENCY_VIET_NAM_DONG","₭":"CURRENCY_LAOS_KIP","₮":"CURRENCY_MONGOLIA_TUGHRIK","₱":"CURRENCY_PESO","₴":"CURRENCY_UKRAINE_HRYVNIA","₼":"CURRENCY_AZERBAIJAN_MANAT","₽":"CURRENCY_RUSSIA_RUBLE","﷼":"CURRENCY_RIAL",ƒ:"CURRENCY_GUILDER",Kč:"CURRENCY_CZECH_REPUBLIC_KORUNA",zł:"CURRENCY_POLAND_ZLOTY",ден:"CURRENCY_MACEDONIA_DENAR",Дин:"CURRENCY_SERBIA_DINAR",лв:"CURRENCY_LEV_TENGE_SOM","₺":"CURRENCY_TURKEY_LIRA"},_k=new Set(Object.values(qi).map(e=>e.toLowerCase()));function Cc(e){let t=e;return Object.entries(qi).forEach(([n,i])=>{t=t.replaceAll(n,i)}),t}function Ro(e){let t=e;return Object.entries(qi).forEach(([n,i])=>{t=t.replaceAll(new RegExp(i,"ig"),n)}),t}const ak=k.delay("currency symbols",()=>{const e=Object.keys(qi).join(""),t=Object.values(qi).join("");k("hide_currency_symbols",()=>{let n="",i="",o="";n=`${e}90 ${e} / year`,i=`${t}90 ${t} / year`,o=Cc(n),u(o,i,"Convert currency symbols to ascii strings")}),k("unhide_currency_symbols",()=>{let n="",i="",o="";n=`${t}90 ${t} / year`,i=`${e}90 ${e} / year`,o=Ro(n),u(o,i,"Converts currency ascii strings back to symbols"),n="Currency_pound90 Currency_pound / year",i="£90 £ / year",o=Ro(n),u(o,i,"Copes with Simulation.JS changing capitalisation of unit words")})}),Tc=new Set(["-parent","e","pi","phi","mod","expt","abs","sin","asin","cos","acos","tan","atan","sqrt","log","exp","round","floor","ceiling","RandBeta","RandDist","RandBoolean","Rand","RandNormal","RandExp","RandLognormal","RandBinomial","RandNegativeBinomial","RandGamma","RandPoisson","RandTriangular","Magnitude","Abs","sin","cos","tan","asin","acos","atan","arcsin","arccos","arctan","Sign","Sqrt","Ln","Log","Logit","Expit","Round","Ceiling","Floor","Exp","Sample","IndexOf","Contains","Collapse","Select","Reverse","Reverse","Sort","Sort","Unique","Unique","Union","Intersection","Difference","Factorial","Max","Max","Lookup","Fill","Min","Min","Mean","Mean","Sum","Sum","Product","Product","Median","Median","StdDev","StdDev","Correlation","Keys","Values","Length","Count","Flatten","CDFNormal","PDFNormal","InvNormal","CDFLogNormal","PDFLogNormal","InvLogNormal","CDFt","PDFt","Invt","CDFF","PDFF","InvF","CDFChiSquared","PDFChiSquared","InvChiSquared","CDFExponential","PDFExponential","InvExponential","CDFPoisson","PMFPoisson","SetRandSeed","Alert","Console","Prompt","Confirm","Parse","Split","Join","Trim","Range","Length","IndexOf","Contains","Lowercase","Uppercase","sqrt","sum","ifthenelse","ifthenelse","assert","assert","map","map","map","indexof","filter","map","select","filter","filter","join","repeat","repeat","join","reverse","join","sort","join","unique","unique","join","unique","unique","max","flatten","flatten","min","mean","sum","product","sort","median","mean","stddev","mean","mean","stddev","stddev","sum","count","count","join","flatten","join","flatten","stringbase","vectorbase","Stop","Pause","Time","TimeStep","TimeLength","TimeStart","TimeEnd","Seconds","Minutes","Hours","Days","Weeks","Months","Years","Seasonal","Unitless","RemoveUnits","PastMean","PastMedian","PastValues","PastStdDev","PastCorrelation","PastMax","PastMin","Pulse","Ramp","Step","Delay","Smooth","Delay1","Delay3","Remove","Add","FindAll","ResetTimer","Transition","Value","SetValue","FindIndex","FindState","FindNotState","FindNearby","FindNearest","FindFurthest","Index","Connect","Unconnect","Connected","ConnectionWeight","SetConnectionWeight","Width","Height","Distance","Location","SetLocation","Move","MoveTowards"]);[...Tc].forEach(e=>Tc.add(e.toLowerCase()));function Ve(e,t){let n=e;return n=ck(t,n),n}function ck(e,t){return e.forEach(n=>{const i=new RegExp(`@@${n}`,"g"),o=`[${n}]`;t=t.replace(i,o)}),t}const lk=k.delay("normalise_calculation_ids",()=>{const e=_e(1);let t="",n="",i="";t="[A] + 3",n="[A] + 3",i=Ve(t,[]),u(i,n,"Original square bracket IDs ignored"),t="[A] + B",n="[A] + [B]",i=Ve(t,[]);const o="Skipping for now as auto wrapping in square brackets is error prone and invalidates a lot of the SimulationJS keywords, syntax, language constructs.";u.skip(i,n,`${o} Non square bracket id put into square brackets`),t="A + [B]",n="[A] + [B]",i=Ve(t,[]),u.skip(i,n,`${o} Beginning with non square bracket id put into square brackets`),t="A-B",n="[A]-[B]",i=Ve(t,[]),u.skip(i,n,`${o} Non square bracket ids with no spaces and a negation sign between are put into square brackets`),t=`[A] + @@${e}`,n=`[A] + [${e}]`,i=Ve(t,[e]),u(i,n,"@@ uuid id put into square brackets"),t="B + B",n="[B] + [B]",i=Ve(t,[]),u.skip(i,n,`${o} Repeated non square bracket id dealt with correctly`),t="sin(1) + B",n="sin(1) + [B]",i=Ve(t,[]),u.skip(i,n,`${o} Simulation.js functions not processed into square brackets`),t="A>B",n="[A]>[B]",i=Ve(t,[]),u.skip(i,n,`${o} Simulation.js equality signs not processed into square brackets`),t="[Some agent].FindAll([Some state]) + B",n="[Some agent].FindAll([Some state]) + [B]",i=Ve(t,[]),u.skip(i,n,`${o} Simulation.js agent functions not processed into square brackets`),t="[ Some variable ] + [ another variable ]",n="[ Some variable ] + [ another variable ]",i=Ve(t,[]),u(i,n,"Existing square bracket id with spaces is not altered"),t="{4 miles} / {6.4e3 meters}",n="{4 miles} / {6.4e3 meters}",i=Ve(t,[]),u(i,n,"Units inside curly braces are left unaltered"),t="{7 Widgets/Years^2}",n="{7 Widgets/Years^2}",i=Ve(t,[]),u(i,n,"Compound units and those raised to power inside curly braces are left unaltered"),t=`{@@${e} meters}`,n=`{[${e}] meters}`,i=Ve(t,[e]),u.skip(i,n,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Double @ reference uuids and their units are preserved in curly braces~~"),t=`x <- 2
    If x > 10 Then
      'Big'
    Else
      'Small'
    End If`,n=t,i=Ve(t,[]),u(i,n,"Should not wrap variables, key words, or literal strings in square brackets")}),dk=/.*?\d{1,3}((?:,\d{3})+)/g;function On(e){let t=e;return[...t.matchAll(dk)].forEach(i=>{const o=i[0];o&&(t=t.replaceAll(o,o.replaceAll(",","")))}),t}const uk=k.delay("normalise_calculation_numbers",()=>{const e=_e(1);let t="",n="",i="";t=`B + [A] @@${e} + 3.1 + {4.2 km}`,n=`B + [A] @@${e} + 3.1 + {4.2 km}`,i=On(t),u(i,n,"Non and square bracket IDs, @@uuids, decimal numbers, and curly bracket numbers with units are left unchanged"),t="3,200 + 1,800.0",n="3200 + 1800.0",i=On(t),u(i,n,"Thousands commas are removed from numbers"),t="3,20 + 1,80.0",n="3,20 + 1,80.0",i=On(t),u(i,n,"Non-thousands commas are ignored"),t="1,200,300 10,300,400 100,200,300",n="1200300 10300400 100200300",i=On(t),u(i,n,"Thousands commas are removed from millions"),t="1,200,300,400 10,200,300,400 100,200,300,400",n="1200300400 10200300400 100200300400",i=On(t),u(i,n,"Thousands commas are removed from billions")});function pk(e){const t=Go({date:new Date(e),time_resolution:"minute"});return new Date(t).getTime()}function Xo(){return{created_at:new Date,custom_created_at:void 0}}var P=(e=>(e[e.boolean=0]="boolean",e[e.number=1]="number",e[e.other=2]="other",e[e.action=3]="action",e[e.undefined=4]="undefined",e))(P||{});function Re(){return{id:Y1(),explanation:"",probability:0,conviction:1,value:"",description:""}}function el(e,t){const n=e.length>1;let i=0;return e=e.map(o=>{const s=n?o.relative_probability===void 0?o.probability:o.relative_probability:void 0;return s!==void 0&&(i+=s),{...o,relative_probability:s}}),t!==P.boolean&&(i=i||1,e=e.map(o=>{const r=(o.relative_probability===void 0?1:o.relative_probability)/i;return{...o,probability:r}})),e}const av=["potential","in progress","paused","completed","failed","rejected"];new Set(av);var we=(e=>(e.action_potential="action__value_possibility__potential_id",e.action_in_progress="action__value_possibility__in_progress_id",e.action_paused="action__value_possibility__paused_id",e.action_completed="action__value_possibility__completed_id",e.action_failed="action__value_possibility__failed_id",e.action_rejected="action__value_possibility__rejected_id",e))(we||{});const he={uncertainty:"value_possibility_uncertainty_id__undefined__",boolean_true:"value_possibility_true_id",boolean_false:"value_possibility_false_id",...we},mk=["action__value_possibility__potential_id","action__value_possibility__in_progress_id","action__value_possibility__paused_id","action__value_possibility__completed_id","action__value_possibility__failed_id","action__value_possibility__rejected_id"],Ec={[he.uncertainty]:"Uncertainty",[he.boolean_true]:"True",[he.boolean_false]:"False",[he.action_potential]:"Potential",[he.action_in_progress]:"In Progress",[he.action_paused]:"Paused",[he.action_completed]:"Completed",[he.action_failed]:"Failed",[he.action_rejected]:"Rejected"};function tl(e,t){return t===P.boolean?e.probability>.5:t===P.number?cv(e.value):e.value}function $e(e){return!Number.isNaN(cv(e))}function cv(e){if(e=e.trim(),e==="")return null;const t=e.split(",");for(let s=1;s<t.length;++s){let r=t[s]||"";if(r=r.split(/[^\d]/)[0]||"",r.length!==3)return Number.NaN}e=t.join("");const n=e.match(/^(-?[0-9]*\.?[0-9]*)\s*(?:(e)\s*(-?[0-9]+))?\s*(%)?$/);let i=NaN,o=!0;for(;o&&n;){const[,s,r,a,c]=n;if(!s||(i=parseFloat(s),Number.isNaN(i)))break;r&&a&&(i=i*10**parseInt(a)),c&&(i=i/100),o=!1}return i}function fk(e,t){let n=tl(e,t);return t===P.boolean&&(n=e.value_id===he.boolean_true),n}function qn(e,t){return e===P.boolean?t=[{value:"True",id:he.boolean_true,order:0},{value:"False",id:he.boolean_false,order:1}]:e===P.action?t=mk.map((n,i)=>({id:n,value:Ec[n]||"?",order:i})):t.length===0&&(e===P.number?["1"]:[""]).forEach((n,i)=>{t.push({value:n,order:i})}),t}const hk=k.delay("default_possible_values",()=>{const e=[{id:"730a7cb4-7523-45f7-bfde-a00d0acb9f65",value:"",description:"",order:0},{id:"724c4da6-f4ee-4680-a493-556ee241f29d",value:"",description:"",order:1}];let t=qn(P.boolean,e);u.skip(t.length,1,"If boolean and given more than one value possibility, it should be reduced back to 1"),t=qn(P.boolean,[]),u(t.length,2,"If boolean and no value possibilities, it should create 2"),t=qn(P.action,[]),u(t.length,av.length,"If action and no value possibilities, it should create the set"),t=qn(P.other,[]),u(t.length,1,"If other and no value possibilities, it should create an empty value"),t=qn(P.number,[]),u(t.length,1,"If other and no value possibilities, it should create an empty value")});function nl(e){let t=-1;if(e){let n;Array.isArray(e)?n=e:n=Object.values(e),n.forEach(({order:i=-1})=>t=Math.max(t,i))}return t}function vk(e){let t=nl(e);return e.map(i=>{const o=i.id||Jc(),s=i.order??++t;return{description:"",...i,id:o,order:s}})}function hn(e,t,n){const i=gk(e,t,n);return vk(i)}function gk(e,t,n){const i=Object.values(t||{}).map(s=>({...s,id:void 0,value_id:s.id}));n.forEach(s=>{s.entries.forEach(({value_id:r,value:a})=>{i.push({value_id:r,value:a})})});const o=wk(i,t);return qn(e,o)}function wk(e,t={}){let n=[];const i=new Set;let o=0;return e.forEach(({value_id:s})=>{const r=t[s||""];!r||i.has(r.value)||(n.push(r),o=Math.max(o,r.order),i.add(r.value))}),e.forEach(({value:s,value_id:r})=>{i.has(s)||(n.push({value:s,id:r,order:++o}),i.add(s))}),e.length===0&&(n=Object.values(t)),n.sort((s,r)=>(s.order??0)<(r.order??0)?-1:1)}const bk=k.delay("get_possibilities_from_VAP_sets",()=>{var s,r,a,c,l,d,p;const e=P.number,t="val_prob_id_123",n=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...Re(),value_id:t,value:"abc",description:""},{...Re(),value_id:void 0,value:"duplicated",description:""},{...Re(),value_id:void 0,value:"duplicated",description:""}]}];let i=hn(e,void 0,n);u(i.length,2,"Should get possibilities for all unique values and remove duplicates"),u((s=i[0])==null?void 0:s.value,"abc"),u.skip(((r=i[0])==null?void 0:r.id)!==t,!0,"Should set a new ID"),u((a=i[1])==null?void 0:a.value,"duplicated"),u(((c=i[1])==null?void 0:c.id)!==void 0,!0,"Should set a new ID if original is undefined");let o={[t]:{id:t,value:"new abc",description:"",order:1}};i=hn(e,o,n),u((l=i[0])==null?void 0:l.value,"new abc"),u((d=i[0])==null?void 0:d.id,t,"Should reuse existing ID"),u((p=i[1])==null?void 0:p.order,2,"Should increment off maximum order")});function Te(e,t,n,i){const o=Xo(),s=yk(e,t,n),r=e===P.action?{value:new Date}:n.length>0?{value:new Date}:{};return{id:K1(),...o,base_id:i,datetime:r,entries:s}}function yk(e,t,n){const o=hn(e,t,n).map(r=>({...Re(),value:r.value,value_id:r.id,description:r.description||""}));return el(o,e)}function kk(e){return{...e,...Xo(),entries:e.entries.map(n=>({...n,explanation:""})),shared_entry_values:{...e.shared_entry_values,explanation:void 0}}}const xk=k.delay("prepare_new_VAP_set",()=>{const e=[{...Te(P.other,void 0,[],1),entries:[{...Re(),value_id:"1",value:"a"},{...Re(),value_id:"2",value:"b"}]},{...Te(P.other,void 0,[],1),entries:[{...Re(),value_id:"1",value:"a"},{...Re(),value_id:"2",value:"b"}]}],t={1:{id:"1",value:"a",description:"",order:0},2:{id:"2",value:"b",description:"",order:1}},n=Te(P.other,t,e,1);u(n.entries.length,2,"If there are only two unique possibilities, only return 2 VAPs")}),lv="toggle_linked_datetime_sliders",Sk=()=>({type:lv}),Ak=e=>e.type===lv,dv="set_display_time_sliders",$k=e=>({type:dv,display_time_sliders:e}),Ck=e=>e.type===dv,uv="toggle_display_time_sliders",Tk=()=>({type:uv}),Ek=e=>e.type===uv,pv="set_or_toggle_display_side_panel",jk=e=>(typeof e!="boolean"&&(e=void 0),{type:pv,display_side_panel:e}),Nk=e=>e.type===pv,mv="set_or_toggle_display_select_storage",Pk=e=>(typeof e!="boolean"&&(e=void 0),{type:mv,display_select_storage:e}),Ik=e=>e.type===mv,Rk={toggle_linked_datetime_sliders:Sk,set_display_time_sliders:$k,toggle_display_time_sliders:Tk,set_or_toggle_display_side_panel:jk,set_or_toggle_display_select_storage:Pk},fv="toggle_consumption_formatting",Dk=()=>({type:fv}),Mk=e=>e.type===fv,hv="set_or_toggle_focused_mode",Ok=e=>({type:hv,focused_mode:e}),qk=e=>e.type===hv,vv="set_display_time_marks",Vk=e=>({type:vv,display_time_marks:e}),Fk=e=>e.type===vv,gv="set_or_toggle_animate_connections",zk=e=>({type:gv,animate_connections:e}),Lk=e=>e.type===gv,wv="set_or_toggle_circular_links",Bk=e=>({type:wv,circular_links:e}),Uk=e=>e.type===wv,bv="set_show_help_menu",Wk=e=>({type:bv,...e}),Hk=e=>e.type===bv,yv="set_or_toggle_show_large_grid",Gk=e=>({type:yv,show_large_grid:e}),Kk=e=>e.type===yv,Yk={toggle_consumption_formatting:Dk,set_or_toggle_focused_mode:Ok,set_display_time_marks:Vk,set_or_toggle_animate_connections:zk,set_or_toggle_circular_links:Bk,set_show_help_menu:Wk,set_or_toggle_show_large_grid:Gk},kv="set_apply_filter",Jk=e=>({type:kv,apply_filter:e}),Xk=e=>e.type===kv,xv="set_filters",Zk=e=>({type:xv,...e}),Qk=e=>e.type===xv,e2={set_apply_filter:Jk,set_filters:Zk},Sv="key_down",t2=e=>({type:Sv,...e}),n2=e=>e.type===Sv,Av="key_up",i2=e=>({type:Av,...e}),o2=e=>e.type===Av,$v="clear_all_keys",s2=()=>({type:$v}),r2=e=>e.type===$v,_2={key_down:t2,key_up:i2,clear_all_keys:s2},Cv="set_action_ids_to_show",a2=e=>({type:Cv,...e}),c2=e=>e.type===Cv,l2={set_action_ids_to_show:a2},Tv="change_route",d2=e=>{const t=e.args;return t&&(t.x=Es(t.x),t.y=Es(t.y),t.zoom=Es(t.zoom)),{type:Tv,...e}};function Es(e){return e===void 0?e:Math.round(e)}const Ev=e=>e.type===Tv,u2={change_route:d2};function Mt(e,t,n){return e[t]===n?e:{...e,[t]:n}}function q(e,t,n,i){const o=Mt(e[t],n,i);return Mt(e,t,o)}function Zo(e,t,n,i,o){const s=Mt(e[t][n],i,o),r=Mt(e[t],n,s);return Mt(e,t,r)}function jv(e,t,n,i,o,s){const r=Mt(e[t][n][i],o,s),a=Mt(e[t][n],i,r),c=Mt(e[t],n,a);return Mt(e,t,c)}function Zd(e,t){return e?p2(e,t||""):new Date}function p2(e,t){const n=new Date(e+" "+t);return Number.isNaN(n.getTime())?new Date:n}function Nv(e){return e.ms===void 0?{ms:e.datetime.getTime(),datetime:e.datetime}:{ms:e.ms,datetime:new Date(e.ms)}}function Qd(e,t,n=console.warn){return t===void 0?e?e.getTime():void 0:(e!==void 0&&n("do not set both new_ms and new_datetime"),t)}const m2=(e,t)=>{if(f2(t)){const{ms:n,datetime:i}=Nv(t),o={...e.routing.args,created_at_datetime:i,created_at_ms:n};e.controls.linked_datetime_sliders&&(o.sim_datetime=i,o.sim_ms=n),e=q(e,"routing","args",o)}return e},Pv="change_display_at_created_datetime",Iv=e=>({type:Pv,...e}),f2=e=>e.type===Pv,h2={change_display_at_created_datetime:Iv},v2=3600*1e3;function g2(e){setTimeout(()=>{e.dispatch(Iv({datetime:new Date}))},v2)}const w2=(e,t)=>{if(y2(t)){const{ms:n,datetime:i}=Nv(t),o={...e.routing.args,sim_datetime:i,sim_ms:n};e.controls.linked_datetime_sliders&&(o.created_at_datetime=i,o.created_at_ms=n),e=q(e,"routing","args",o)}return e},Rv="change_display_at_sim_datetime",b2=e=>({type:Rv,...e}),y2=e=>e.type===Rv,k2={change_display_at_sim_datetime:b2},x2=(e,t)=>($2(t)&&(e=q(e,"search","search_fields",t.search_fields)),T2(t)&&(e=q(e,"search","search_type",t.search_type)),e),il="update_search_fields",S2="update_search_type",A2=e=>({type:il,...e}),$2=e=>e.type===il,C2=e=>({type:il,...e}),T2=e=>e.type===S2,E2={update_search_fields:A2,update_search_type:C2};function Dv(e,t={},n={},i={},o={},s={},r={},a={},c={}){return{...e,...t,...n,...i,...o,...s,...r,...a,...c}}const Mv="bulk_edit_knowledge_view_entries",j2=e=>({type:Mv,...e}),N2=e=>e.type===Mv,Ov="bulk_update_knowledge_view_entries",P2=e=>({type:Ov,...e}),I2=e=>e.type===Ov,qv="snap_to_grid_knowledge_view_entries",R2=e=>({type:qv,...e}),D2=e=>e.type===qv,Vv="change_current_knowledge_view_entries_order",M2=e=>({type:Vv,...e}),O2=e=>e.type===Vv,Fv="bulk_add_to_knowledge_view",q2=e=>({type:Fv,...e}),V2=e=>e.type===Fv,zv="bulk_remove_from_knowledge_view",F2=e=>({type:zv,...e}),z2=e=>e.type===zv,L2={bulk_edit_knowledge_view_entries:j2,bulk_update_knowledge_view_entries:P2,bulk_add_to_knowledge_view:q2,bulk_remove_from_knowledge_view:F2,snap_to_grid_knowledge_view_entries:R2,change_current_knowledge_view_entries_order:M2},Lv="upsert_knowledge_view_entry",B2=e=>({type:Lv,...e}),U2=e=>e.type===Lv,Bv="upsert_knowledge_view",W2=e=>({type:Bv,...e}),Uv=e=>e.type===Bv,H2={upsert_knowledge_view_entry:B2,upsert_knowledge_view:W2,...L2};function ii(e){return e&&(e.min||e.value||e.max)}function Wv(e){return ii(e)===void 0}var Be=(e=>(e[e.ascending=0]="ascending",e[e.descending=1]="descending",e))(Be||{});function Ke(e,t,n){const i=G2(n);return e.map((o,s)=>({item:o,key_value:t(o,s)})).sort(i).map(({item:o})=>o)}function G2(e){const t=e===0,n=t?-1:1,i=t?1:-1;return(o,s)=>o.key_value<s.key_value?n:o.key_value>s.key_value?i:0}function K2(e){return e.custom_created_at||e.created_at}function it(e){return K2(e).getTime()}function ol(e){const{items:t,created_at_ms:n}=e,i=[],o=[];return t.forEach(s=>{it(s)>n?i.push(s):o.push(s)}),{invalid_future_items:i,current_items:o}}const Y2=k.delay("partition_items_by_created_at_datetime",()=>{function e(m){const h=ol(m);return{invalid_future_items:h.invalid_future_items.map(({id:v})=>v),current_items:h.current_items.map(({id:v})=>v)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime(),p={base_id:-1,id:"1",created_at:s},f={base_id:-1,id:"2",created_at:a};t=[],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[]}),t=[p,f],n=e({items:t,created_at_ms:d}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:c}),u(n,{invalid_future_items:[],current_items:[p.id,f.id]}),n=e({items:t,created_at_ms:r}),u(n,{invalid_future_items:[f.id],current_items:[p.id]}),n=e({items:t,created_at_ms:o}),u(n,{invalid_future_items:[p.id,f.id],current_items:[]})});function sl(e){const t={};e.forEach(o=>{const s=t[o.id]||[];s.push(o),t[o.id]=s});const n={};return{latest:Object.values(t).map(o=>{const s=Ke(o,it,Be.descending),r=s[0];return n[r.id]=s.slice(1),r}),previous_versions_by_id:n}}function Me(e,t){return t?e.specialised_objects.wcomponents_by_id[t]:void 0}function Hv(e,t){return t=t||[],t=t instanceof Set?Array.from(t):t,t.map(n=>e[n])}function Do(e,t){return t=t||[],t=t instanceof Set?Array.from(t):t,t.map(n=>Me(e,n))}function le(e){return e.derived.current_composed_knowledge_view}function qe(e){return e.specialised_objects.knowledge_views_by_id[e.routing.args.subview_id]}function J2(e,t){const n=qe(e);if(!n)return!1;const i=n.wc_id_map[t];return!!i&&!i.passthrough}function Kn(e,t){return e.specialised_objects.knowledge_views_by_id[t]}function Gv(e,t){const n=new Set(e.map(r=>r.id));e=e.filter(r=>r.base_id===t);const i=new Set(e.map(r=>r.id)),o={top_ids:[],map:{}},s=[];return e.forEach(r=>{const{parent_knowledge_view_id:a,title:c,sort_type:l="normal"}=r;a?s.push({...r,parent_knowledge_view_id:a}):(o.top_ids.push(r.id),o.map[r.id]={id:r.id,title:c,sort_type:l,parent_id:void 0,child_ids:[]})}),Kv(n,i,s,o,t),o}function Kv(e,t,n,i,o){if(n.length===0)return;const s=[];if(n.forEach(r=>{const a=i.map[r.parent_knowledge_view_id];if(a){const{id:c,title:l,sort_type:d="normal"}=r;a.child_ids.push(c),i.map[c]={id:c,title:l,sort_type:d,parent_id:a.id,child_ids:[]}}else s.push(r)}),n.length===s.length){const r=s.filter(a=>a.base_id===o);r.length&&console.warn(`Maybe broken knowledge view tree.  Look in "Views" for:
 * ${r.map(a=>`${a.title} ${a.id}`).join(`
 * `)}`),s.forEach(({id:a,title:c,parent_knowledge_view_id:l})=>{i.top_ids.push(a);const d=t.has(l),p=!e.has(l),f=!d&&!p;i.map[a]={id:a,title:c,sort_type:"errored",parent_id:void 0,child_ids:[],ERROR_is_circular:d,ERROR_parent_kv_missing:p,ERROR_parent_from_diff_base:f}})}else Kv(e,t,s,i,o)}function X2(e){e.top_ids=eu(e.top_ids,e.map),Object.values(e.map).forEach(t=>{t.child_ids=eu(t.child_ids,e.map)})}const Z2={priority:"0",normal:"1",hidden:"2",archived:"3",errored:"4"};function eu(e,t){return Ke(e,n=>{const i=t[n];return Z2[i.sort_type]+i.title.toLowerCase()},Be.ascending)}function Q2(e,t){return!!t[e]}function ex(e,t,n){const i=rl(e,t);return ii(i==null?void 0:i.temporal_uncertainty)}function rl(e,t,n){const i=t[e];if(Xc(i)){const{event_at:o=[]}=i,s=o[0];if(!s)return;const r=s.datetime,a=s.probability*s.conviction;return{temporal_uncertainty:r,certainty:a}}else if(i&&ni(i)){const o=Yv(i);if(o)return tx(o)}}function Yv(e){let t=e.values_and_prediction_sets||[];t=sl(t).latest;const n=t[0];if(n&&t.length===1)return n;const i=t.filter(s=>!Wv(s.datetime)),o=i[0];return o&&i.length===1?o:!1}function tx(e){var i;if(!e)return;let t;const n=(i=e.shared_entry_values)==null?void 0:i.conviction;return e.entries.forEach(o=>{const s=o.probability*(n!==void 0?n:o.conviction);t=Math.max(t||0,s)}),{temporal_uncertainty:e.datetime,certainty:t}}const nx=(e,t)=>{if(ox(t)){const{id:n,highlighted:i}=t;let o=new Set(e.meta_wcomponents.highlighted_wcomponent_ids);n===void 0?o=new Set:i?o.add(n):o.delete(n),e=q(e,"meta_wcomponents","highlighted_wcomponent_ids",o);let{neighbour_ids_of_highlighted_wcomponent:s}=e.meta_wcomponents;if(e.display_options.focused_mode){const a=le(e);if(a&&(s=new Set,n!==void 0&&t.highlighted)){const c=a.wc_id_connections_map[n];c&&(s=new Set(c),e.derived.wcomponent_ids_by_type.any_node.has(n)&&c.forEach(l=>{const d=a.wc_id_connections_map[l];d&&d.forEach(p=>s.add(p))}))}}else s.size&&(s=new Set);e=q(e,"meta_wcomponents","neighbour_ids_of_highlighted_wcomponent",s)}return e},Jv="set_highlighted_wcomponent",ix=e=>({type:Jv,id:e.id,highlighted:e.highlighted}),ox=e=>e.type===Jv,sx={set_highlighted_wcomponent:ix},Xv="replace_all_specialised_objects",rx=e=>({type:Xv,...e}),Zv=e=>e.type===Xv,Qv="clear_from_mem_all_specialised_objects",_x=()=>({type:Qv}),eg=e=>e.type===Qv,ax={replace_all_specialised_objects:rx,clear_from_mem_all_specialised_objects:_x},tg="bulk_edit_wcomponents",cx=e=>({type:tg,...e}),lx=e=>e.type===tg,dx={bulk_edit_wcomponents:cx},ng="upsert_wcomponent",ux=e=>({type:ng,...e}),Qo=e=>e.type===ng,ig="delete_wcomponent",px=e=>({type:ig,...e}),mx=e=>e.type===ig,og="add_wcomponents_to_store",fx=e=>({type:og,...e}),hx=e=>e.type===og,vx={upsert_wcomponent:ux,delete_wcomponent:px,add_wcomponents_to_store:fx,...dx},gx=Dv(sx,ax,vx,H2),sg="set_find_all_causal_paths_wcomponent_ids",wx=e=>({type:sg,...e}),bx=e=>e.type===sg,yx={set_find_all_causal_paths_wcomponent_ids:wx},rg="clicked_wcomponent",kx=e=>({type:rg,...e}),xx=e=>e.type===rg,_g="clear_selected_wcomponents",Sx=()=>({type:_g}),Ax=e=>e.type===_g,ag="set_selected_wcomponents",$x=e=>({type:ag,...e}),Cx=e=>e.type===ag,cg="pointerupdown_on_connection_terminal",Tx=e=>({type:cg,...e}),lg=e=>e.type===cg,Ex=e=>lg(e)&&e.up_down==="up",jx=e=>lg(e)&&e.up_down==="down",dg="pointerupdown_on_component",Nx=e=>({type:dg,...e}),ug=e=>e.type===dg,Px=e=>ug(e)&&e.up_down==="up",Ix=e=>ug(e)&&e.up_down==="down",pg="clear_pointerupdown_on_connection_terminal",Rx=()=>({type:pg}),Dx=e=>e.type===pg,mg="set_wcomponent_ids_to_move",Mx=e=>({type:mg,...e}),Ox=e=>e.type===mg,qx={clicked_wcomponent:kx,clear_selected_wcomponents:Sx,set_selected_wcomponents:$x,pointerupdown_on_connection_terminal:Tx,pointerupdown_on_component:Nx,clear_pointerupdown_on_connection_terminal:Rx,set_wcomponent_ids_to_move:Mx},fg="set_frame_is_resizing",Vx=e=>({type:fg,...e}),Fx=e=>e.type===fg,zx=Dv({set_frame_is_resizing:Vx},qx,yx),hg="update_sync_status",Lx=e=>({type:hg,...e}),Bx=e=>e.type===hg,vg="debug_refresh_all_specialised_object_ids_pending_save",Ux=()=>({type:vg}),Wx=e=>e.type===vg,gg="update_specialised_object_sync_info",Hx=e=>({type:gg,...e}),wg=e=>e.type===gg,bg="update_network_status",Gx=e=>({type:bg,...e}),Kx=e=>e.type===bg,yg="request_searching_for_wcomponents_by_id_in_any_base",Yx=e=>({type:yg,...e}),Jx=e=>e.type===yg,kg="searching_for_wcomponents_by_id_in_any_base",Xx=()=>({type:kg}),Zx=e=>e.type===kg,xg="searched_for_wcomponents_by_id_in_any_base",Qx=e=>({type:xg,...e}),eS=e=>e.type===xg,tS={update_sync_status:Lx,debug_refresh_all_specialised_object_ids_pending_save:Ux,update_specialised_object_sync_info:Hx,update_network_status:Gx,request_searching_for_wcomponents_by_id_in_any_base:Yx,searching_for_wcomponents_by_id_in_any_base:Xx,searched_for_wcomponents_by_id_in_any_base:Qx},Sg="set_user",nS=e=>({type:Sg,...e}),iS=e=>e.type===Sg,Ag="set_need_to_handle_password_recovery",oS=e=>({type:Ag,need_to_handle_password_recovery:e}),sS=e=>e.type===Ag,$g="set_users",rS=e=>({type:$g,...e}),_S=e=>e.type===$g,Cg="update_chosen_base_id",aS=e=>({type:Cg,...e}),cS=e=>e.type===Cg,Tg="update_bases",lS=e=>({type:Tg,...e}),dS=e=>e.type===Tg,uS={set_user:nS,set_need_to_handle_password_recovery:oS,set_users:rS,update_chosen_base_id:aS,update_bases:lS},S={controls:Rk,filter_context:e2,display:Yk,sync:tS,routing:u2,global_keys:_2,display_at_created_datetime:h2,display_at_sim_datetime:k2,search:E2,specialised_object:gx,meta_wcomponents:zx,user_info:uS,view_priorities:l2},en={debug:e=>{console.debug(e)},log:e=>{console.log(e)},info:e=>{console.info(e)},warn:e=>{console.warn(e)},error:e=>{console.error(e)}};function Eg(e){const{wcomponent_ids:t,knowledge_view_ids:n}=e.sync.specialised_object_ids_pending_save;return t.size+n.size>0}function pS(e){const{wcomponent_ids:t,knowledge_view_ids:n}=e.sync.specialised_object_ids_pending_save,o=t.values().next();if(!o.done)return{id:o.value,object_type:"wcomponent"};const r=n.values().next();if(!r.done)return{id:r.value,object_type:"knowledge_view"}}function mS(e){const{user:t,users_by_id:n}=e.user_info;return t&&n?n[t.id]:void 0}function es(e){const t=mS(e);return t==null?void 0:t.name}function _l(e){const{user:t,users_by_id:n}=e.user_info;return t&&n&&!es(e)}function Yi(e,t=""){const{bases_by_id:n,chosen_base_id:i}=e.user_info,o=n&&n[i||""];function s(r){t&&console.error(r+t)}return n||s("No state.user_info.bases_by_id present"),i===void 0&&s("No state.user_info.chosen_base_id present"),o===void 0&&s("No chosen_base present"),o}function fS(e){const t=Yi(e),n=mt(e);return t?t.title:n===void 0?"Not set":`Unknown Store: ${n}`}function jg(e){const{user:t,bases_by_id:n}=e.user_info;if(t&&n)return Object.values(n).filter(i=>i.can_edit)}function hS(e){const t=jg(e);return t===void 0?void 0:t.length>0}function mt(e){return e.user_info.chosen_base_id}function Ng(e){const{bases_by_id:t}=e.user_info;return t===void 0?!1:hS(e)===!1&&Yi(e)===void 0}function al(e){const t=Yi(e);return t==null?void 0:t.access_level}function Vi(e){const t=al(e);return t===void 0||t==="viewer"||t==="none"}function Fe(e){return{id:Yo(),...Xo(),title:"",description:"",wc_id_map:{},sort_type:"normal",...e}}function vS(e){const t=e.store||ye(),n=mt(t.getState()),i={...e.knowledge_view,base_id:n},o=Fe(i);t.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:o}))}function tu(e,t){t.dispatch(S.routing.change_route({route:"wcomponents",args:{subview_id:e}}))}function Pg(e){const{last_source_of_truth_value:t,current_value:n,source_of_truth_value:i,get_custom_field_merger:o}=e;let s={...i},r=!1,a=[];return gS(n,t,i).forEach(l=>{const p=(o(l)||wS(l))(e);r=r||p.needs_save,p.unresolvable_conflict&&a.push(l),s[l]=p.value}),{value:s,needs_save:r,unresolvable_conflicted_fields:a}}function gS(...e){const t=new Set;return e.forEach(n=>{Object.keys(n).forEach(i=>{t.add(i)})}),Array.from(t)}function wS(e){const t=new Set(["needs_save","saving"]),n=new Set(["id","created_at","modified_at"]);function i(o){const s=o.source_of_truth_value[e],r=o.current_value[e];let a=!1,c=!1;return t.has(e)?{needs_save:a,unresolvable_conflict:c,value:r}:n.has(e)?{needs_save:a,unresolvable_conflict:c,value:s}:Ig(e)(o)}return i}function Ig(e){function t(i,o){return JSON.stringify(i)===JSON.stringify(o)}function n(i){const o=i.source_of_truth_value[e],s=i.current_value[e],r=i.last_source_of_truth_value[e];let a=!1,c=!1,l;return i.update_successful||t(o,r)?(l=s,a=!t(s,o)):(l=o,t(s,r)||(c=!t(s,o),c&&console.debug("unresolvable_conflict with field: ",e,"last_source_of_truth_field_value",r,"source_of_truth_field_value",o,"current_field_value",s))),{needs_save:a,unresolvable_conflict:c,value:l}}return n}function cn(e){return Pg({...e,get_custom_field_merger:bS})}function bS(e){if(e!=="wc_id_map")return;function t(n,i){return JSON.stringify(n)===JSON.stringify(i)}return n=>{const i=n.source_of_truth_value.wc_id_map,o=n.current_value.wc_id_map,s=n.last_source_of_truth_value.wc_id_map;let r=!1,a=!1,c;return n.update_successful||t(i,s)?(c=o,r=!t(o,i)):(c=i,t(o,s)||Array.from(new Set(Object.keys(o).concat(Object.keys(i)))).forEach(d=>{const p=Ig(d)({source_of_truth_value:i,current_value:o,last_source_of_truth_value:s,update_successful:n.update_successful});c[d]=p.value,p.unresolvable_conflict&&console.debug("unresolvable_conflict in wc_id_map with wc_id: ",d,"last_source_of_truth_value",s[d],"source_of_truth_value",i[d],"current_value",o[d]),r=r||p.needs_save,a=a||p.unresolvable_conflict})),{needs_save:r,unresolvable_conflict:a,value:c}}}const yS=k.delay("merge knowledge view functions",()=>{const e=new Date("2021-01-01"),t=new Date("2021-02-02");function n(o,s=!0){if(!o&&s)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return o?o.getTime():void 0}const i=o=>({left:o,top:o});k("should handle adding entry on client",()=>{const o=Fe({wc_id_map:{},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(1)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(1)},modified_at:t},a=cn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(1)}),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])}),k("should handle adding entries on client and remote",()=>{const o=Fe({wc_id_map:{},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(1)},needs_save:!0,saving:!0},r={...o,wc_id_map:{2:i(3)},modified_at:t},a=cn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(1),2:i(3)}),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),k("should handle nonconflicting changing different entries on client and remote",()=>{const o=Fe({wc_id_map:{0:i(1),2:i(3)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(4),2:i(3)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(1),2:i(5)},modified_at:t},a=cn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(4),2:i(5)}),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),k("should handle conflict changing same entries on client and remote",()=>{const o=Fe({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(3)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=cn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(2)}),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,["wc_id_map"])}),k("should handle resolveable conflict changing same entries on client and remote",()=>{const o=Fe({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(2)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=cn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(2)}),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])}),k("should handle non and conflict changes and second client change",()=>{const o=Fe({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(4),1:i(10)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=cn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.wc_id_map,{0:i(2),1:i(10)}),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,["wc_id_map"])})});function vt(e){return Pg({...e,get_custom_field_merger:kS})}function kS(e){}const xS=k.delay("merge_wcomponent",()=>{const e=new Date("2021-01-01"),t=new Date("2021-02-02");function n(i,o=!0){if(!i&&o)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return i?i.getTime():void 0}k("should handle update on client",()=>{const i=O({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TB",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(a.value.title,"TB"),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])}),k("should handle nonconflicting updates",()=>{const i=O({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TA",description:"DX",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TB"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),k("should handle conflicting updates",()=>{const i=O({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TX",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TX"),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,["title"])}),k("should handle multiple updates on client",()=>{const i=O({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TB",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(a.value.title,"TC"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),k("should handle nonconflicting updates with multiple client updates",()=>{const i=O({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TA",description:"DX",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TC"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,[])}),k("should handle conflicting updates with multiple client updates",()=>{const i=O({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TX",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TX"),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,["title"])}),k("should handle non and conflicting updates",()=>{const i=O({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TB",description:"DB",needs_save:!0,saving:!0},s={...i,title:"TB",description:"DB"},r={...i,title:"TA",description:"DX",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TB"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,["description"])}),k("should handle non and conflicting updates with multiple client updates",()=>{const i=O({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TC",description:"DC",needs_save:!0,saving:!0},s={...i,title:"TB",description:"DB"},r={...i,title:"TA",description:"DX",modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});u(n(a.value.modified_at),n(t)),u(a.value.title,"TC"),u(a.value.description,"DX"),u(a.needs_save,!0),u(a.unresolvable_conflicted_fields,["description"])}),k("should handle different custom created at",()=>{const i=O({base_id:-1,custom_created_at:new Date("2021"),modified_at:e}),o={...i,custom_created_at:new Date("2015"),needs_save:!0,saving:!0},s={...i,custom_created_at:new Date("2015")},r={...i,custom_created_at:new Date("2015"),modified_at:t},a=vt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});u(n(a.value.modified_at),n(t)),u(new Date("2021"),new Date("2021")),u(a.value.custom_created_at,new Date("2015")),u(a.needs_save,!1),u(a.unresolvable_conflicted_fields,[])})});function SS(e,t){return e.sync.last_source_of_truth_specialised_objects_by_id.wcomponents[t||""]}function AS(e,t){return e.sync.last_source_of_truth_specialised_objects_by_id.knowledge_views[t||""]}const ge=e=>e!==void 0;function Ji(e){return e={...e},delete e.needs_save,delete e.saving,e}function Mo(e){return{...e,created_at:new Date(e.created_at),custom_created_at:Ni(e.custom_created_at),modified_at:Ni(e.modified_at),datetime:$S(e.datetime)}}const Ni=e=>e===void 0?void 0:new Date(e);function $S(e){if(e)return{...e,value:Ni(e.value),min:Ni(e.min),max:Ni(e.max)}}function cl(e,t,n=!1){e=Ji(e);let i=e.wc_id_map;return n&&(i=CS(i)),e={...e,...Mo(e),wc_id_map:i,sort_type:e.sort_type||"normal"},e=TS(e),e}function CS(e){const t={...e};return Object.entries(t).forEach(([n,i])=>{i.passthrough&&delete t[n]}),t}function TS(e){const{wc_id_map:t}=e,n={...t};return Object.values(n).forEach(i=>{i.deleted&&(delete i.deleted,i.blocked=!0)}),{...e,wc_id_map:n}}async function Rg(e){const t=e.converter_app_to_supabase(e.item),n=await e.supabase.from(e.table).insert(t).eq("id",t.id).select(),o=(n.data||[]).map(e.converter_supabase_to_app).filter(ge)[0];return{status:n.status,item:o,error:n.error||void 0}}const ES=1e3;async function Yn(e){const t=e.offset||0,n=e.specific_ids?100:ES,i=t+n-1;let o=e.supabase.from(e.table).select().order("id",{ascending:!0});if(e.base_id!==void 0&&(o=o.eq("base_id",e.base_id)),e.specific_ids===void 0)o=o.range(t,i);else{const l=e.specific_ids.slice(t,i+1);o=o.in("id",l)}const s=await o;let r=s.error||void 0,a=(s.data||[]).map(l=>e.converter(l));const c=e.specific_ids&&t+n<e.specific_ids.length;if(!r&&(a.length===n||c)){const l=await Yn({...e,offset:t+n});l.error?r=l.error:a=a.concat(l.value)}return{error:r,value:a}}function Dg(e,t){if(t=e.base_id??t,t===void 0)throw new Error("Must provide base_id for app_item_to_supabase");const n=Ji(e);return delete n.base_id,{id:e.id,modified_at:e.modified_at?e.modified_at.toISOString():void 0,base_id:t,json:n,title:e.title}}function ll(e){let{json:t}=e;const{id:n,base_id:i,modified_at:o}=e,s=o?new Date(o+"Z"):void 0;return delete t.base_id,t={...t,id:n,base_id:i,modified_at:s},t}const Mg="knowledge_views";function Og(e){return Yn({...e,table:Mg,converter:dl,specific_ids:e.ids})}async function jS(e){const t=e.wcomponents_from_other_bases.filter(r=>Jo(r)),n=Array.from(new Set(t.map(r=>r.id))),i=new Set(e.knowledge_views.map(r=>r.id)),o=e.knowledge_views.map(r=>r.parent_knowledge_view_id).filter(ge).filter(r=>!i.has(r));let s=n.concat(o);return e.knowledge_views.map(r=>r.foundation_knowledge_view_ids).forEach(r=>{r==null||r.filter(a=>!i.has(a)).forEach(a=>s.push(a))}),s=Array.from(new Set(s)),await Og({supabase:e.supabase,ids:s,all_bases:!0})}async function NS(e){return e.knowledge_view.modified_at?IS(e):PS(e)}async function PS(e){return Rg({supabase:e.supabase,table:Mg,item:e.knowledge_view,converter_app_to_supabase:qg,converter_supabase_to_app:dl})}async function IS(e){const t=qg(e.knowledge_view),n=await e.supabase.rpc("update_knowledge_view",{item:t});if(n.status===401)return{status:n.status,error:{message:"JWT expired"},item:void 0};let i,o=n.error||void 0;try{let s=n.data;n.status===409&&(s=JSON.parse(n.error.details)),i=dl(s)}catch(s){console.error("Exception whilst handling rpc update_knowledge_view response",s),o=s}return{status:n.status,error:o,item:i}}function qg(e,t){return Dg(e,t)}function dl(e){let t=ll(e);return t=cl(t),t}const RS={event:!0,statev2:!0,state_value:!0,multidimensional_state:!0,process:!0,action:!0,actor:!0,causal_link:!0,relation_link:!0,counterfactualv2:!0},ul=Object.keys(RS).sort().filter(e=>e!=="multidimensional_state"),DS=new Set(ul);function pl(e){if(e=Ji(e),e=MS(e),e=OS(e),e={...Mo(e)},Ki(e)){const t=e.values_and_prediction_sets;e.values_and_prediction_sets=t&&t.map(qS)}return _v(e)&&(e.event_at=e.event_at.map(Mo)),Ne(e)&&(e.from_type=nu(e.from_type),e.to_type=nu(e.to_type),e.from_type=iu(e.from_type),e.to_type=iu(e.to_type)),e}function nu(e){return e==="meta-effector"||e==="meta-effected"?"meta":e==="effector"||e==="effected"?"state":e||"state"}function iu(e){return e==="value"?"state":e||"state"}function MS(e){return!rv(e)||!e.is_action?e:{...e,is_action:void 0,type:"action"}}function OS(e){if(ot(e)){const t=e.depends_on_action_ids||[];e={...e,depends_on_action_ids:t}}return e}const qS=e=>Mo(e),ml="wcomponents";async function VS(e){const t=await Yn({...e,table:ml,converter:Xi,specific_ids:e.ids}),n=t.value.filter(ge);return{error:t.error,wcomponents:n}}async function Vg(e){const t=await Yn({supabase:e.supabase,all_bases:!0,base_id:void 0,specific_ids:e.ids,table:ml,converter:Xi}),n=t.value.filter(ge);return{error:t.error,wcomponents:n}}async function FS(e){const t=new Set(e.wcomponents.map(s=>s.id)),n=new Set;function i(s,r){s.forEach(a=>{if(!Jt(a)){console.trace(`Found invalid UUID "${a}".  Source of ids: "${r}"`);return}t.has(a)||n.add(a)})}e.knowledge_views.forEach(s=>{i(Object.keys(s.wc_id_map),`wc_id_map of knowledge view "${s.id}"`)}),e.wcomponents.forEach(s=>{const r=`wcomponent "${s.id}"`;i(s.label_ids||[],r);let a=fn(s.title);i(a,r),a=fn(s.description),i(a,r),ot(s)&&i(s.parent_goal_or_action_ids||[],r)});const o=Array.from(n);return await Vg({supabase:e.supabase,ids:o})}async function zS(e){return e.wcomponent.modified_at?BS(e):LS(e)}async function LS(e){return await Rg({supabase:e.supabase,table:ml,item:e.wcomponent,converter_app_to_supabase:fl,converter_supabase_to_app:Xi})}async function BS(e){const t=fl(e.wcomponent),n=await e.supabase.rpc("update_wcomponent",{item:t});if(n.status===401)return{status:n.status,error:{message:"JWT expired"},item:void 0};let i,o=n.error||void 0;try{let s=n.data;n.status===409&&(s=JSON.parse(n.error.details)),i=Xi(s)}catch(s){console.error("Exception whilst handling rpc update_wcomponent response",s),o=s}return{status:n.status,error:o,item:i}}function fl(e,t){return{...Dg(e,t),type:e.type,attribute_id:pt(e)?e.attribute_wcomponent_id:void 0}}function Xi(e){let t=ll(e);if(US(t))return t=pl(t),t}function US(e){if(DS.has(e.type))return e;console.warn(`Unsupported wcomponent type "${e.type}", id "${e.id}", title: "${e.title}".  This wcomponent will not be used.`)}function Fg(e){if(e){if("type"in e&&typeof e.type=="string")return e.type+": "+(e.message||"<no message>");if(`${e}`.includes("[object"))return JSON.stringify(e)}return`${e}`}let fi=0;async function zg(e,t=!1){const n=e.getState();if(!n.sync.ready_for_writing){const s=new Error(`Inconsistent state violation.  Save state called whilst state.sync.status: "${n.sync.specialised_objects.status}", ready_for_writing: ${n.sync.ready_for_writing}`);return en.error(s),Promise.reject(s)}const i=pS(n);if(!i){const{wcomponent_ids:s,knowledge_view_ids:r}=n.sync.specialised_object_ids_pending_save,a=JSON.stringify(Array.from(s)),c=JSON.stringify(Array.from(r));if(e.dispatch(S.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})),t)return console.log(`No ids need to be saved: "${a}", "${c}"`),Promise.resolve();const l=new Error(`Inconsistent state violation.  No ids need to be saved: "${a}", "${c}"`);return en.error(l),Promise.reject(l)}e.dispatch(S.sync.update_sync_status({status:"SAVING",data_type:"specialised_objects"}));let o;i.object_type==="knowledge_view"?o=WS(i.id,e):o=HS(i.id,e);try{fi+=1,await o&&(fi=0),fi<10?e.dispatch(S.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})):e.dispatch(S.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:"Try manually saving or refresh the page.  Failing that contact the team.",attempt:fi}))}catch(s){en.error(`Got error saving ${i.object_type} ${i.id}.  Error: ${s instanceof Error?s.message:s}`),e.dispatch(S.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:`${s}`,attempt:fi}))}return Promise.resolve()}async function WS(e,t){const n="knowledge_view",i=Kn(t.getState(),e),o=Lg(e,t,n,i);if(o.error)return o.error;const s=o.initial_item,r=ke(),a=await NS({supabase:r,knowledge_view:s}),c=Bg(e,t,n,a);if(c.error)return c.error;const{create_successful:l,update_successful:d,latest_source_of_truth_value:p}=c,f=AS(t.getState(),e),m=Kn(t.getState(),e);t.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:p,is_source_of_truth:!0}));const h=Ug({object_type:n,initial_item:s,last_source_of_truth_value:f,current_value:m});if(h.error)return h.error;if(h.merge_args){const v=cn({...h.merge_args,source_of_truth_value:p,update_successful:d});v.needs_save&&t.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:{...v.value},is_source_of_truth:!1})),v.unresolvable_conflicted_fields.length}return Promise.resolve(l||d)}async function HS(e,t){const n="wcomponent",i=Me(t.getState(),e),o=Lg(e,t,n,i);if(o.error)return o.error;const s=o.initial_item,r=ke(),a=await zS({supabase:r,wcomponent:s}),c=Bg(e,t,n,a);if(c.error)return c.error;const{create_successful:l,update_successful:d,latest_source_of_truth_value:p}=c,f=SS(t.getState(),e),m=Me(t.getState(),e);t.dispatch(S.specialised_object.upsert_wcomponent({wcomponent:p,is_source_of_truth:!0}));const h=Ug({object_type:n,initial_item:s,last_source_of_truth_value:f,current_value:m});if(h.error)return h.error;if(h.merge_args){const v=vt({...h.merge_args,source_of_truth_value:p,update_successful:d});v.needs_save&&t.dispatch(S.specialised_object.upsert_wcomponent({wcomponent:{...v.value},is_source_of_truth:!1})),v.unresolvable_conflicted_fields.length}return Promise.resolve(l||d)}function Lg(e,t,n,i){return i?(t.dispatch(S.sync.update_specialised_object_sync_info({id:i.id,object_type:n,saving:!0})),{error:void 0,initial_item:i}):(t.dispatch(S.sync.debug_refresh_all_specialised_object_ids_pending_save()),{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${n}" but no item for id: "${e}".  Updating all specialised_object_ids_pending_save.`)),initial_item:void 0})}function Bg(e,t,n,i){const o=i.status===201,s=i.status===200;if(!o&&!s&&i.status!==409){const a=Fg(i.error);return{error:Promise.reject(new Error(`save_"${n}" got "${i.status}" error: "${a}"`)),create_successful:o,update_successful:s,latest_source_of_truth_value:void 0}}const r=i.item;return r?{error:void 0,create_successful:o,update_successful:s,latest_source_of_truth_value:r}:{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${n}" got "${i.status}" but no latest_source_of_truth_value item.  Error: "${JSON.stringify(i.error)}".`)),create_successful:o,update_successful:s,latest_source_of_truth_value:r}}function Ug(e){const{object_type:t,initial_item:n,last_source_of_truth_value:i,current_value:o}=e;return i?o?{error:void 0,merge_args:{last_source_of_truth_value:i,current_value:o}}:{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${t}" found "${t}" last_source_of_truth_value but no current_value for id "${n.id}".`)),merge_args:void 0}:n.modified_at?{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${t}" found no last_source_of_truth_value "${t}" for id: "${n.id}" but "${t}" had a modified_at already set`)),merge_args:void 0}:{error:void 0,merge_args:void 0}}async function Wg(e){if(!GS(e,!0))return Promise.resolve();await zg(e)}function GS(e,t){if(!e.load_state_from_storage)return!1;const n=e.getState(),{ready_for_writing:i,specialised_objects:o}=n.sync;return!(!i||t&&o.status==="FAILED"||t&&!Eg(n))}async function Hg(e){const t=ye(),n=ke();try{await Wg(t)}catch(i){en.debug(`Error saving state before signout ${i}`)}try{if(e){en.debug("Signing out with supabase.auth.signOut()");const{error:i}=await n.auth.signOut();localStorage.clear()}}catch(i){en.debug(`Error signing out ${i}`)}window.location.reload()}const Gg=[];function KS(){window.addEventListener("focus",function(){Gg.forEach(e=>e())},!1)}function YS(e){Gg.push(e)}let ou=!1;function JS(e){if(ou){console.error("Already run register_window_focus_session_check");return}ou=!0,YS(()=>{Kg(e)})}async function Kg(e){if(!e.load_state_from_storage)return;const t=ke(),n=await XS(e,t);ZS(n,e)}async function XS(e,t){var n,i,o;if(!e.getState().user_info.user)return console.log("User not signed in once yet."),0;try{console.log("On window focus event, checking connection and session with supabase.auth.getSession()");const s=await t.auth.getSession();if(((n=s.error)==null?void 0:n.message)==="Not logged in."||((i=s.error)==null?void 0:i.status)===401)return 1;if(((o=s.error)==null?void 0:o.message)==="Network request failed")return console.log("Network error"),2;if(s.error){debugger;return console.log("Unexpected error whilst check_connection_and_session",s.error),3}else return 4}catch(s){return console.error("Unexpected exception whilst check_connection_and_session",s),3}}function ZS(e,t){if(e===0)return;if(e===1){en.info("User not logged in.  Reloading page."),window.location.reload();return}else if(e===3){Hg(!1);return}let n=!0;switch(e){case 2:n=!1;break}t.dispatch(S.sync.update_network_status({network_functional:n,last_checked:new Date}))}function QS(e){let t="";e.subscribe(()=>{const n=e.getState(),i=qe(n);if(i&&i.title!==t){t=i.title;const o=(t?t+" | ":"")+B0.NAME;Fh(o)}})}function eA(e){tA(e)}function tA(e){e.subscribe(()=>{const t=e.getState();t.routing.route,nA(t)&&e.dispatch(S.controls.set_or_toggle_display_side_panel(!0))})}function nA(e){return e.last_action?!e.controls.display_side_panel&&Ev(e.last_action)&&e.last_action.route!==void 0&&(e.last_action.route==="search"||e.last_action.route==="filter"):!1}function jc(e,t){let n;const i=()=>{n&&(clearTimeout(n),n=void 0)};let o;return{throttled:(...a)=>{i(),o=a,n=setTimeout(()=>{e(...a),o=void 0},t)},cancel:i,flush:()=>{i(),o&&(e(...o),o=void 0)}}}function Yg(e,t){let n;const i=()=>{n&&(clearTimeout(n),n=void 0)};let o={args:void 0},s;const r=(...l)=>(o.args=l,n||(n=setTimeout(()=>{e(...o.args),o.args=void 0,n=void 0},t),s=performance.now()+t),s);let a;return{throttled:r,cancel:i,flush:()=>(a||(a=new Promise(l=>{setTimeout(()=>{if(i(),a=void 0,o.args){const d=o.args;o.args=void 0,l(e(...d))}l(void 0)},0)})),a)}}function ts(e={}){const t={};function n(s,r){const a=e[s];if(a){const d=a(r);if(!d.continue)return;r=d.message}const c=t[s];(c===void 0?[]:c).forEach(d=>{setTimeout(()=>d(r),0)})}function i(s,r){const a=t[s],c=a===void 0?[]:a;return c.push(r),t[s]=c,o(s,r)}function o(s,r){return()=>{const a=t[s],l=(a===void 0?[]:a).filter(d=>d!==r);t[s]=l}}return{pub:n,sub:i}}const hl=ts({canvas_node_drag_relative_position:iA});let _n;function iA(e){const t=(_n==null?void 0:_n.left)!==e.left||(_n==null?void 0:_n.top)!==e.top;return _n=e,{continue:t,message:e}}function oA(e){hl.pub("throttled_canvas_node_drag_relative_position",e)}const sA=Yg(oA,30);hl.sub("canvas_node_drag_relative_position",sA.throttled);const rA=ts();let _A=0;const Jg=ts({send_toast_message:e=>{const t={...e,duration:e.duration??3e3,type:e.type??"info",id:e.id??`${_A++}`};return setTimeout(()=>Jg.pub("accepted_toast_message",t),0),{continue:!1,message:e}}}),aA=ts(),U={canvas:hl,global_keys:rA,user:aA,toast:Jg};function cA(e,t){t.ctrl_key&&t.key==="f"&&(t.event.preventDefault(),e.dispatch(S.routing.change_route({route:"search"})))}const vl=Zi(e=>Object.keys(e.composed_visible_wc_id_map)),Xg=Zi((e,t)=>{const n=[...t],i=new Set(n),{wc_id_connections_map:o,composed_visible_wc_id_map:s}=e;return t.forEach(r=>{const a=o[r];a&&a.forEach(c=>{i.has(c)||s[r]&&(n.push(c),i.add(c))})}),n}),Zg=Zi((e,t,n)=>{const i=new Set(t),o=new Set,{wc_id_connections_map:s,composed_visible_wc_id_map:r,wc_ids_by_type:a}=e;return t.forEach(c=>{const l=s[c];if(!l)o.add(c);else{const d=Array.from(l).filter(p=>r[p]).filter(p=>i.has(p));if(d.length<=1)o.add(c);else if(a.any_node.has(c)){let p;Array.from(d).map(m=>n[m]).filter(Ne).find(m=>{const h=m.from_id===c;if(p===void 0)p=h;else if(p!==h)return!0;return!1})||o.add(c)}}}),t.filter(c=>!o.has(c))}),Qg=tw("forward"),ew=tw("source");function tw(e){const t=e==="forward";return Zi((n,i,o)=>{const s=[...i],r=new Set(s);function a(d){r.has(d)||(r.add(d),s.push(d))}const{wc_id_connections_map:c,composed_visible_wc_id_map:l}=n;return i.forEach(d=>{const p=c[d];if(!p)return;Array.from(p).concat([d]).filter(m=>l[m]).map(m=>o[m]).filter(sn).filter(m=>(t?m.from_id:m.to_id)===d||m.id===d).forEach(({id:m,from_id:h,to_id:v})=>{a(m),a(t?v:h)})}),s})}const nw=Zi((e,t)=>{const n=new Set(t),i=[...t],o=new Set(i),{wc_id_connections_map:s,composed_visible_wc_id_map:r}=e;function a(c){return!r[c]}return t.forEach(c=>{if(a(c))return;const l=s[c];l&&l.forEach(d=>{if(a(d))return;const p=s[d];p&&p.forEach(f=>{f!==c&&n.has(f)&&(a(f)||o.has(d)||(i.push(d),o.add(d)))})})}),i});function Zi(e){return t=>{const n=t.getState(),i=le(n);if(!i||!(n.routing.args.view==="knowledge"))return;const s=n.meta_wcomponents.selected_wcomponent_ids_list,{wcomponents_by_id:r}=n.specialised_objects,a=e(i,s,r);t.dispatch(S.meta_wcomponents.set_selected_wcomponents({ids:a})),t.dispatch(S.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))}}function lA(e){uA(e)}function dA(e,t){t.key==="a"&&t.ctrl_key&&(t.event.preventDefault(),vl(e))}function uA(e){U.canvas.sub("canvas_area_select",t=>{const n=e.getState(),i=le(n);if(!i||!(n.routing.args.view==="knowledge"))return;const{start_x:s,start_y:r,end_x:a,end_y:c}=t,l=-r,d=-c,p=Object.entries(i.composed_visible_wc_id_map).filter(([h,v])=>v.left>=s&&v.left<=a&&v.top<=l&&v.top>=d).map(([h])=>h).filter(h=>!i.wc_ids_by_type.any_link.has(h)),f=n.global_keys.keys_down.has("Control"),m=pA(f,n,p);e.dispatch(S.meta_wcomponents.set_selected_wcomponents({ids:m})),e.dispatch(S.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))})}function pA(e,t,n){let i=[];if(e){const o=new Set(t.meta_wcomponents.selected_wcomponent_ids_set);n.forEach(s=>o.delete(s)),i=Array.from(o)}else{const o=t.meta_wcomponents.selected_wcomponent_ids_list,s=new Set(o),r=n.filter(a=>!s.has(a));i=o.concat(r)}return i}function mA(e){fA(e)}function fA(e){let t="";U.global_keys.sub("key_down",n=>{if(t){hA(t,n,e);return}const i=n.ctrl_key&&vA.has(n.key);if(t=i?t=n.key:"",i){n.event.preventDefault();return}n.ctrl_key&&n.key==="e"?(n.event.preventDefault(),e.dispatch(S.display.toggle_consumption_formatting())):n.shift_key&&n.key==="?"?(n.event.preventDefault(),e.getState().display_options.show_help_menu||e.dispatch(S.display.set_show_help_menu({show:!0}))):(dA(e,n),cA(e,n))}),U.global_keys.sub("key_up",n=>{n.key==="Control"&&(t="")})}function hA(e,t,n){let i=!1;e==="d"?i=gA(t.key,n):e==="s"&&(i=wA(t.key,n)),i&&t.event.preventDefault()}const vA=new Set(["d","s"]);function gA(e,t){let n=!0;return e==="f"?t.dispatch(S.display.set_or_toggle_focused_mode()):e==="t"?t.dispatch(S.controls.toggle_display_time_sliders()):e==="s"?t.dispatch(S.controls.set_or_toggle_display_side_panel()):e==="a"?t.dispatch(S.display.set_or_toggle_animate_connections()):e==="c"?t.dispatch(S.display.set_or_toggle_circular_links()):n=!1,n}function wA(e,t){let n=!0;return e==="a"?vl(t):e==="e"?Xg(t):e==="d"?Zg(t):e==="f"?Qg(t):e==="c"?ew(t):e==="i"?nw(t):n=!1,n}function bA(e){document.onkeydown=t=>{const n={event:t,time_stamp:t.timeStamp,alt_key:t.altKey,code:t.code,ctrl_key:t.ctrlKey,key:t.key,meta_key:t.metaKey,shift_key:t.shiftKey};e.dispatch(S.global_keys.key_down(n)),U.global_keys.pub("key_down",n)},document.onkeyup=t=>{const n={event:t,time_stamp:t.timeStamp,alt_key:t.altKey,code:t.code,ctrl_key:t.ctrlKey,key:t.key,meta_key:t.metaKey,shift_key:t.shiftKey};e.dispatch(S.global_keys.key_up(n)),U.global_keys.pub("key_up",n)},window.onfocus=()=>{e.getState().global_keys.keys_down.size!==0&&e.dispatch(S.global_keys.clear_all_keys())}}function oi(e,t){const n={};return e.forEach(i=>{n[i]=t[i]}),n}function yA(e){const t=oi(["display_time_sliders","display_side_panel"],e.controls);yn("controls",t)}function kA(e,t){const n=t.get_persisted_state_object("controls");return{linked_datetime_sliders:!1,display_time_sliders:!1,display_side_panel:!0,display_select_storage:e.storage_location===void 0,...n}}function xA(e){const t=oi(["consumption_formatting","display_time_marks","animate_connections","circular_links","show_large_grid"],e.display_options);yn("display_options",t)}function SA(e){const n={consumption_formatting:!0,focused_mode:!1,display_time_marks:!1,animate_connections:!1,circular_links:!0,show_help_menu:!1,show_large_grid:!1,...e.get_persisted_state_object("display_options")};return Nc().enable_align_components_on_x_by_time||(n.display_time_marks=!1),n}const Nc=()=>{const t=zh()("experimental_features");return{enable_angular_connections:t.enable_angular_connections??!1,enable_action_kanban_view:t.enable_action_kanban_view??!1,enable_align_components_on_x_by_time:t.enable_align_components_on_x_by_time??!1}},Ot={get_state:Nc,set_state_and_reload_page:e=>{const n={...Nc(),...e};yn("experimental_features",n),document.location.reload()}};function AA(e){const t=oi(["apply_filter","filters"],e.filter_context);yn("filter_context",t)}function $A(e){const t=e.get_persisted_state_object("filter_context");t.filters instanceof Array&&delete t.filters;const{apply_filter:n=!1,filters:i={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""}}=t;return{apply_filter:n,filters:i}}function CA(e){const t=oi(["search_fields","search_type"],e.search);yn("search",t)}function TA(e){return{search_fields:"all",search_type:"best",...e.get_persisted_state_object("search")}}function EA(e){const t=oi([],e.sync);yn("sync",t)}function jA(e){const t=e.get_persisted_state_object("sync"),n={status:void 0,error_message:"",retry_attempt:void 0,loading_base_id:void 0};return{last_source_of_truth_specialised_objects_by_id:{wcomponents:{},knowledge_views:{}},specialised_object_ids_pending_save:{wcomponent_ids:new Set,knowledge_view_ids:new Set},specialised_objects_save_conflicts:{wcomponent_conflicts_by_id:{},knowledge_view_conflicts_by_id:{}},ready_for_reading:!1,ready_for_writing:!1,network_functional:!0,network_function_last_checked:void 0,wcomponent_ids_to_search_for_in_any_base:new Set,wcomponent_ids_searching_for_in_any_base:new Set,wcomponent_ids_searched_for_in_any_base:new Set,bases:{...n},specialised_objects:{...n},...t}}const NA={wcomponents_by_id:{},knowledge_views_by_id:{}},PA=void 0,{wcomponents_by_id:IA,knowledge_views_by_id:RA}=NA,DA=Object.values(IA).map(pl),MA=Object.values(RA).map(e=>cl(e)),OA={wcomponents:DA,knowledge_views:MA};function qA(e){const t=oi(["has_signed_in_at_least_once","chosen_base_id"],e.user_info);yn("user_info",t)}function VA(e,t){const n=t.get_persisted_state_object("user_info"),o=(c=>t.get_url_hash().includes(c))("type=recovery"),s=e.storage_location!==void 0?e.storage_location:n.chosen_base_id;return{has_signed_in_at_least_once:!1,user:PA,need_to_handle_password_recovery:o,users_by_id:void 0,bases_by_id:void 0,...n,chosen_base_id:s}}function FA(e){yA(e),xA(e),AA(e),CA(e),EA(e),qA(e)}const zA=(e,t)=>{if(Ak(t)){const n=!e.controls.linked_datetime_sliders;e=q(e,"controls","linked_datetime_sliders",n)}if(Ck(t)){const{display_time_sliders:n}=t;e=q(e,"controls","display_time_sliders",n)}if(Ek(t)){const{display_time_sliders:n}=e.controls;e=q(e,"controls","display_time_sliders",!n)}if(Nk(t)){const{display_side_panel:n}=e.controls,i=t.display_side_panel??!n;e=q(e,"controls","display_side_panel",i)}if(Ik(t)){const{display_select_storage:n}=e.controls,i=t.display_select_storage??!n;e=q(e,"controls","display_select_storage",i)}return e};function iw(e){const{wcomponents_by_id:t,created_at_ms:n}=e,i={...t};return Object.keys(e.composed_visible_wc_id_map||{}).forEach(o=>{const s=t[o];if(s&&pt(s)){const r=t[s.attribute_wcomponent_id||""];if(!Ye(r))return;let a;s.values_and_prediction_sets&&(a=ol({items:s.values_and_prediction_sets,created_at_ms:n}).current_items,a=Ke(a,it,Be.descending));const c={...r,values_and_prediction_sets:a,value_possibilities:s.value_possibilities,_derived__using_value_from_wcomponent_id:s.id};i[c.id]=c}}),i}function LA(e,t){var c,l;const n=e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id,i=(c=e.derived.current_composed_knowledge_view)==null?void 0:c.composed_visible_wc_id_map,o=(l=t.derived.current_composed_knowledge_view)==null?void 0:l.composed_visible_wc_id_map;if(!(n||i!==o))return t;const a=BA(t);return t=q(t,"derived","composed_wcomponents_by_id",a),t}function BA(e){const{wcomponents_by_id:t}=e.specialised_objects,{composed_visible_wc_id_map:n}=e.derived.current_composed_knowledge_view||{},{created_at_ms:i}=e.routing.args;return iw({composed_visible_wc_id_map:n,wcomponents_by_id:t,created_at_ms:i})}function UA(e,t){return e.has(t)||(e=new Set(e),e.add(t)),e}function WA(e,t){return e.has(t)&&(e=new Set(e),e.delete(t)),e}function Bn(...e){let t=[];return e.forEach(n=>t=t.concat(Array.from(n))),new Set(t)}function HA(e,t){const n=new Set(e);return t.forEach(i=>n.delete(i)),n.size===e.size?e:n}function ow(){return{event:new Set,statev2:new Set,state_value:new Set,multidimensional_state:new Set,process:new Set,action:new Set,actor:new Set,causal_link:new Set,relation_link:new Set,counterfactualv2:new Set,has_objectives:new Set,any_link:new Set,any_node:new Set,any_state_VAPs:new Set,has_single_datetime:new Set}}function sw(e,t){const n=ow(),i=new Set;return t.forEach(o=>{const s=e[o];if(!s){console.warn(`Could not find wcomponent by id: ${o}.  Wrong ID or in another project?`);return}Qc(s)||(n[s.type].add(o),ni(s)&&Yv(s)&&i.add(s.id))}),n.any_link=Bn(n.causal_link,n.relation_link),n.any_node=HA(new Set(t),n.any_link),n.any_state_VAPs=Bn(n.statev2,n.causal_link,n.action),n.has_single_datetime=Bn(n.event,i),n}const tt=20,Jn=tt*18,vn=tt*8;function Fi(e,t){return Math.round(e/t)*t}function qt(e){return Fi(e,tt)}function rw(e){return{left:e.x,top:-e.y}}function ns(e,t="small"){return t==="small"?{left:qt(e.left),top:qt(e.top)}:{left:Fi(e.left,Jn),top:Fi(e.top,vn)}}const Ce=250,_w=(e=!1)=>e?120:59,Xn=Ce/2,aw=e=>_w(e)/2;function GA(e){return{left:e.left-Xn,top:e.top-aw(!1)}}function KA(e,t){const n=e.s??1,i=e.left+n*Xn,o=e.top+n*aw(t);return{left:i,top:o}}function YA(e,t){return!e||!t?Number.POSITIVE_INFINITY:(e.left-t.left)**2+(e.top-t.top)**2}const Pi={time_origin_x:0,time_scale:1,time_line_number:4,time_line_spacing_days:30};function JA(e){const t=e.time_origin_ms??new Date().getTime(),n=e.time_origin_x??0,i=e.time_scale??1;return{time_origin_ms:t,time_origin_x:n,time_scale:i}}function gl(e){const t=ex(e.wcomponent_id,e.wcomponents_by_id,e.created_at_ms);if(!t)return;const n=XA({datetime:t,...e});return qt(n)}function XA(e){const t=e.datetime.getTime()-e.time_origin_ms,n=e.time_scale/Lh;return t*n+e.time_origin_x}function cw(e){return`${e.left},${e.top}`}function lw(e,t){const n={};return Object.entries(e).forEach(([i,o])=>{if(Ne(t[i]))return;const s=ns(o,"large"),r=cw(s),a=n[r]||[];a.push(i),n[r]=a}),n}const ZA=/(.*?)(?:\[([^\]]*)\]\([^\)]*\))/g,QA=/(.*?)(\<[^\>]*\>)/g;function Xt(e){return e=e.replaceAll(" <auto generated>",""),e=e.replaceAll(ZA,"$1$2"),e=e.replaceAll(QA,"$1"),e}function e3(e){const t=new Set,n=new Set;e.forEach(o=>{o.label_ids&&o.label_ids.forEach(s=>t.add(s)),n.add(o.type)});const i=Array.from(n).sort();return{wc_label_ids:t,wc_types:i}}function Nt(e,t){const{id:n,label_ids:i=[],type:o}=e,{exclude_by_label_ids:s,include_by_label_ids:r,exclude_by_component_types:a,include_by_component_types:c}=t,l=s.has(n)||!!i.find(v=>s.has(v)),d=r.size>0&&!r.has(n)&&!i.find(v=>r.has(v)),p=a.has(o),f=c.size>0&&!c.has(o);return{should_exclude:l||p,lacks_include:d||f}}function st(e,t){let n={};e.forEach(s=>{Object.entries(s.wc_id_map).forEach(([r,a])=>{a.passthrough||(delete n[r],n[r]=a)})}),t3(n,t);const i=n3(n);n=i.composed_wc_id_map;const o=i.composed_blocked_wc_id_map;return{composed_wc_id_map:n,composed_blocked_wc_id_map:o}}function t3(e,t){Object.keys(e).forEach(n=>{const i=t[n];Qc(i)&&delete e[n]})}function n3(e){const t={};return Object.entries(e).forEach(([n,i])=>{i.blocked&&(t[n]=i,delete e[n])}),{composed_wc_id_map:e,composed_blocked_wc_id_map:t}}function su(e){let t=e.routing.args.subview_id;return t=Jt(t)?t:"",Kn(e,t)}const i3=(e,t)=>{e.specialised_objects.knowledge_views_by_id!==t.specialised_objects.knowledge_views_by_id&&(t=o3(t));const i=su(e),o=su(t);(i==null?void 0:i.id)!==(o==null?void 0:o.id)&&(t=q(t,"derived","current_composed_knowledge_view",void 0));const r=i!==o,a=e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id,c=e.meta_wcomponents.selected_wcomponent_ids_set!==t.meta_wcomponents.selected_wcomponent_ids_set,l=r||a||c,d=e.routing.args.created_at_ms!==t.routing.args.created_at_ms,p=d||e.filter_context!==t.filter_context||a,f=e.display_options.display_time_marks!==t.display_options.display_time_marks,m=d||f;if(o){if(l){let h=dw(t,o);h=Pc(t,h),h=pw(t,h),t=q(t,"derived","current_composed_knowledge_view",h)}else if(p){const h=Pc(t,t.derived.current_composed_knowledge_view);t=q(t,"derived","current_composed_knowledge_view",h)}else if(m){let{current_composed_knowledge_view:h}=t.derived;h=c3(h,f,t,o),t=q(t,"derived","current_composed_knowledge_view",h)}}return t};function o3(e){const{knowledge_views_by_id:t}=e.specialised_objects,n=mt(e),o=Object.values(t).map(a=>({...a,title:Xt(a.title)})),s=Ke(o,({title:a})=>a,Be.ascending),r=Gv(s,n);return X2(r),e={...e,derived:{...e.derived,knowledge_views:s,nested_knowledge_view_ids:r}},e}function dw(e,t){const{knowledge_views_by_id:n,wcomponents_by_id:i}=e.specialised_objects,{current_composed_knowledge_view:o}=e.derived;return s3({knowledge_view:t,current_composed_knowledge_view:o,knowledge_views_by_id:n,wcomponents_by_id:i})}function s3(e){const{knowledge_view:t,knowledge_views_by_id:n,wcomponents_by_id:i}=e,o=e.current_composed_knowledge_view||{composed_visible_wc_id_map:{},filters:{wc_ids_excluded_by_any_filter:new Set,wc_ids_excluded_by_filters:new Set,wc_ids_excluded_by_created_at_datetime_filter:new Set,vap_set_number_excluded_by_created_at_datetime_filter:0},wc_id_to_active_counterfactuals_v2_map:{}},s=kt(t,n,!0),{composed_wc_id_map:r,composed_blocked_wc_id_map:a}=st(s,i),c=a3(r,i),l=Object.keys(r),d=sw(i,l),p=[],f=[];l.forEach(x=>{const y=i[x];y?p.push(y):f.push(x)});const m=o.wc_id_to_active_counterfactuals_v2_map,h=r3({current_wc_id_to_active_counterfactuals_v2_map:m,wc_ids_by_type:d,wcomponents_by_id:i,active_counterfactual_ids:t.active_counterfactual_v2_ids||[]}),v=_3(d.any_link,i),g=e3(p),b=uw(s,!0),w={...t,...o,composed_wc_id_map:r,composed_blocked_wc_id_map:a,overlapping_wc_ids:c,wcomponent_unfound_ids:f,wc_id_to_active_counterfactuals_v2_map:h,wc_ids_by_type:d,wc_id_connections_map:v,available_filter_options:g,composed_datetime_line_config:b};return delete w.wc_id_map,delete w.datetime_line_config,w}function kt(e,t,n){const{foundation_knowledge_view_ids:i=[]}=e,o=i.map(s=>t[s]).filter(ge);return n&&o.push(e),o}function r3(e){return e.current_wc_id_to_active_counterfactuals_v2_map}function _3(e,t){const n={};function i(s,r){const a=n[s]||new Set;a.add(r),n[s]=a}function o(s,r){i(s,r),i(r,s)}return e.forEach(s=>{const r=t[s];Ne(r)&&(r.from_id&&o(r.from_id,r.id),r.to_id&&o(r.to_id,r.id))}),n}function uw(e,t){let n={};return t&&(n={...Pi}),e.forEach(i=>{const{datetime_line_config:o}=i;o&&(n.time_origin_ms=o.time_origin_ms??n.time_origin_ms,n.time_origin_x=o.time_origin_x??n.time_origin_x,n.time_scale=o.time_scale??n.time_scale,n.time_line_number=o.time_line_number??n.time_line_number,n.time_line_spacing_days=o.time_line_spacing_days??n.time_line_spacing_days)}),n}function Pc(e,t){if(!t)return;const{wc_ids_by_type:n,composed_wc_id_map:i}=t,o=Do(e,n.any_node).filter(ek),s=Do(e,n.any_link).filter(Ne),r=o.concat(s);let a=new Set;e.filter_context.apply_filter&&(a=Ic(e.filter_context.filters,e.meta_wcomponents.selected_wcomponent_ids_set,o,s));const{created_at_ms:c}=e.routing.args;let l=0;const d=r.filter(h=>(ni(h)&&h.values_and_prediction_sets.forEach(v=>{it(v)>c&&++l}),it(h)>c)).map(({id:h})=>h),p=new Set(d),f=Bn(a,p),m={...i};return f.forEach(h=>{delete m[h]}),{...t,composed_visible_wc_id_map:m,filters:{wc_ids_excluded_by_any_filter:f,wc_ids_excluded_by_filters:a,wc_ids_excluded_by_created_at_datetime_filter:p,vap_set_number_excluded_by_created_at_datetime_filter:l}}}function Ic(e,t,n,i){const o=new Set,{exclude_by_label_ids:s,include_by_label_ids:r,exclude_by_component_types:a,include_by_component_types:c}=e,l=new Set(s),d=new Set(r),p=new Set(a),f=new Set(c),m={exclude_by_label_ids:l,include_by_label_ids:d,include_by_label_ids_list:r,exclude_by_component_types:p,include_by_component_types:f};return n.forEach(h=>{const{should_exclude:v,lacks_include:g}=Nt(h,m);(v||g)&&o.add(h.id)}),i.forEach(h=>{const{from_id:v,to_id:g}=h;let b=!1;//!from_id || !to_id
b=b||!!v&&!t.has(v)&&o.has(v)||!!g&&!t.has(g)&&o.has(g);const w=Nt(h,m);b=b||w.should_exclude,b&&o.add(h.id)}),o}function a3(e,t){const n=lw(e,t),i={};return Object.values(n).forEach(o=>{o.length<=1||o.forEach((s,r)=>{const a=r+1;i[s]=[...o.slice(a),...o.slice(0,a)]})}),i}function c3(e,t,n,i){if(e){if(t&&!n.display_options.display_time_marks){const{knowledge_views_by_id:o,wcomponents_by_id:s}=n.specialised_objects,r=kt(i,o,!0),a=st(r,s);e={...e,...a}}else e=pw(n,e);return e}}function pw(e,t){if(!t)return;const{display_time_marks:n}=e.display_options,{wc_ids_by_type:i,composed_wc_id_map:o,composed_datetime_line_config:s}=t,{time_origin_ms:r,time_origin_x:a,time_scale:c}=s,{wcomponents_by_id:l}=e.specialised_objects,{created_at_ms:d}=e.routing.args;if(!n||r===void 0)return t;const p={...o};let f=!1;return Array.from(i.has_single_datetime).forEach(m=>{const h=o[m];if(!h)return;const v=gl({wcomponent_id:m,wcomponents_by_id:l,created_at_ms:d,time_origin_ms:r,time_origin_x:a,time_scale:c});v===void 0||h.left===v||(f=!0,p[m]={...h,left:v})}),f?{...t,composed_wc_id_map:p}:t}function l3(e,t){if(e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id){const n=Object.keys(t.specialised_objects.wcomponents_by_id),i=sw(t.specialised_objects.wcomponents_by_id,n);t=q(t,"derived","wcomponent_ids_by_type",i)}return t=i3(e,t),t=LA(e,t),t}const d3=(e,t)=>{if(Mk(t)&&(Vi(e)&&e.display_options.consumption_formatting?e=q(e,"toast_message","warn_can_not_edit_ms",new Date().getTime()):e=q(e,"display_options","consumption_formatting",!e.display_options.consumption_formatting)),qk(t)){const n=fo(t.focused_mode,e.display_options.focused_mode);e=q(e,"display_options","focused_mode",n)}if(Fk(t)&&(e=q(e,"display_options","display_time_marks",t.display_time_marks)),Lk(t)){const n=fo(t.animate_connections,e.display_options.animate_connections);e=q(e,"display_options","animate_connections",n)}if(Uk(t)){const n=fo(t.circular_links,e.display_options.circular_links);e=q(e,"display_options","circular_links",n)}if(Hk(t)&&(e=q(e,"display_options","show_help_menu",t.show)),Kk(t)){const n=fo(t.show_large_grid,e.display_options.show_large_grid);e=q(e,"display_options","show_large_grid",n)}return e};function fo(e,t){return e===void 0&&(e=!t),e}function mw(e){return e.routing.args.view==="actions_list"}function u3(e){let t=e.derived.wcomponent_ids_by_type.action;const{apply_filter:n,filters:i}=e.filter_context;if(!n)return t;const{filter_by_current_knowledge_view:o,filter_by_text:s}=i;if(o){const r=le(e);r&&(t=r.wc_ids_by_type.action)}if(s){const r=Array.from(t).map(a=>e.specialised_objects.wcomponents_by_id[a]).filter(sv).filter(a=>a.title.includes(s)||a.description.includes(s)).map(a=>a.id);t=new Set(r)}return t}const p3=(e,t)=>{if(Xk(t)&&(e=q(e,"filter_context","apply_filter",t.apply_filter)),Qk(t)){e=q(e,"filter_context","filters",t.filters);const n=mw(e),{exclude_by_label_ids:i,include_by_label_ids:o,exclude_by_component_types:s,include_by_component_types:r,filter_by_current_knowledge_view:a,filter_by_text:c}=t.filters,l=i.length+o.length+s.length+r.length>0||n&&(a||c.length>0);e=q(e,"filter_context","apply_filter",l)}return e},m3=(e,t)=>{let n=!1;if(n2(t)){n=!0;const i=new Set([...e.global_keys.keys_down]);i.add(t.key),e={...e,global_keys:{...e.global_keys,last_key:t.key,last_key_time_stamp:t.time_stamp,keys_down:i}}}if(o2(t)){n=!0;let i=new Set([...e.global_keys.keys_down]);i.delete(t.key),e={...e,global_keys:{...e.global_keys,last_key:t.key,last_key_time_stamp:t.time_stamp,keys_down:i}}}return r2(t)&&(n=!0,e=q(e,"global_keys","keys_down",new Set)),n&&(e=f3(e)),e};function f3(e){const{keys_down:t}=e.global_keys,n=t.has("Control"),i=t.has("Shift"),o={...e.global_keys,derived:{shift_down:i,control_down:n,shift_or_control_down:n||i}};return{...e,global_keys:o}}const h3=(e,t)=>(c2(t)&&(e=q(e,"view_priorities","action_ids_to_show",t.action_ids),e=q(e,"view_priorities","date_shown",t.date_shown)),e);function It(e,t,n){const{route:i,sub_route:o,item_id:s,args:r}=e,a=t.args||{};a.created_at_ms=Qd(a.created_at_datetime,a.created_at_ms,n),a.created_at_datetime=a.created_at_ms?new Date(a.created_at_ms):void 0,a.sim_ms=Qd(a.sim_datetime,a.sim_ms,n),a.sim_datetime=a.sim_ms?new Date(a.sim_ms):void 0,Object.keys(a).forEach(l=>{if(l==="storage_location")return;const d=a[l];(d===void 0||d==="")&&delete a[l]});const c={...r,...a};return{route:t.route||i,sub_route:t.sub_route===null?null:t.sub_route||o,item_id:t.item_id===null?null:t.item_id||s,args:c}}const v3=k.delay("merge_routing_state",()=>{const e=new Date("2021-04-09 23:25:26"),t=new Date("2022-01-01 01:01:01"),n=new Date("2023-01-01 01:01:01"),i={route:"wcomponents",sub_route:null,item_id:"wc53611570523449304",args:{created_at_datetime:e,created_at_ms:e.getTime(),sim_datetime:e,sim_ms:e.getTime(),view:"knowledge",subview_id:"kv7207606403961189",zoom:100,x:0,y:0,storage_location:1}};let o,s,r;const a=c=>r=c;o={args:{x:0}},s=It(i,o),u(s,i),o={args:{zoom:void 0}},s=It(i,o),u(s,i),o={args:{created_at_datetime:t,created_at_ms:n.getTime()}},r="",s=It(i,o,a),u(s.args.created_at_datetime,n),u(s.args.created_at_ms,n.getTime()),u(r,"do not set both new_ms and new_datetime"),o={args:{sim_datetime:t,sim_ms:n.getTime()}},r="",s=It(i,o,a),u(s.args.sim_datetime,n),u(s.args.sim_ms,n.getTime()),u(r,"do not set both new_ms and new_datetime"),o={args:{sim_ms:void 0,created_at_ms:void 0}},s=It(i,o),u(s.args.sim_ms,e.getTime(),"should leave sim_ms unchanged when called with `{ args: { sim_ms: undefined }}`"),u(s.args.created_at_ms,e.getTime(),"should leave created_at_ms unchanged when called with `{ args: { created_at_ms: undefined }}`"),o={args:{storage_location:void 0}},s=It(i,o),u(s.args.storage_location,void 0)}),fw={views:[],wcomponents:["wcomponents_edit_multiple"],search:[],filter:[],select:[],display:[],about:[]},hw=Object.keys(fw),g3={actions_list:!0,knowledge:!0},w3=Object.keys(g3),b3=e=>w3.includes(e),vw={view:!0,subview_id:!0,zoom:!0,x:!0,y:!0,storage_location:!0,cdate:!0,ctime:!0,sdate:!0,stime:!0},y3=Object.keys(vw).length;function Zn(e){const t=e.sub_route?`${e.sub_route}/`:"",n=e.item_id?`${e.item_id}/`:"",i=e.args,o=Rc(i);return"#"+e.route+"/"+t+n+o}const k3=new Set(["order","rotation","created_at_datetime","created_at_ms","sim_datetime","sim_ms"]);function Rc(e){const t={...e,cdate:Zt(e.created_at_datetime,"yyyy-MM-dd"),ctime:Zt(e.created_at_datetime,"hh:mm:ss"),sdate:Zt(e.sim_datetime,"yyyy-MM-dd"),stime:Zt(e.sim_datetime,"hh:mm:ss")};return Object.keys(e).filter(i=>!k3.has(i)).sort().concat(["sdate","stime","cdate","ctime"]).map(i=>`&${i}=${t[i]??""}`).join("")}function x3(e){const t=gw(e);return!t.route||t.args_from_url.length!==y3}function gw(e){const n=(e.split("#")[1]||"").split("&"),o=n[0].split("/").filter(l=>!!l),{route:s,sub_route:r,item_id:a}=S3(o),c=n.slice(1).map(l=>l.split("=")).filter(l=>vw[l[0]]);return{route:s,sub_route:r,item_id:a,args_from_url:c}}function ww(e,t){const{route:n,sub_route:i,item_id:o,args_from_url:s}=gw(e),r=A3(t.args,s);return{route:n,sub_route:i,item_id:o,args:r}}function S3(e){let t=e[0],n=null,i=null;if(!hw.includes(t))t="wcomponents";else{const o=e.slice(1).join("/")||null;fw[t].includes(o)?n=o:i=o}return{route:t,sub_route:n,item_id:i}}function A3(e,t){e={...e};let n=null,i=null,o=null,s=null;return t.forEach(r=>{const[a,c]=r;a==="cdate"?n=c:a==="ctime"?i=c:a==="sdate"?o=c:a==="stime"?s=c:$3(e,a,c)}),e.created_at_datetime=Zd(n,i),e.sim_datetime=o?Zd(o,s):e.created_at_datetime,e.created_at_ms=e.created_at_datetime.getTime(),e.sim_ms=e.sim_datetime.getTime(),e}function $3(e,t,n){t==="view"?b3(n)&&(e.view=n):T3(t)?e[t]=E3(n):t==="subview_id"?e.subview_id=n:t==="storage_location"&&(e.storage_location=j3(n))}const C3=new Set(["x","y","zoom"]);function T3(e){return C3.has(e)}function E3(e){const t=parseInt(e);return Number.isNaN(t)?0:t}function j3(e){const t=parseInt(e);return Number.isNaN(t)?void 0:t}const N3=k.delay("routing_state_to_string",()=>{let e,t;e={route:"wcomponents",sub_route:null,item_id:"wc88",args:{view:"knowledge",subview_id:"kv77",zoom:100,x:101,y:158,storage_location:void 0,created_at_datetime:new Date("2020-10-21T17:04:24.000Z"),created_at_ms:1603299864e3,sim_datetime:new Date("2021-04-26T09:23:13.000Z"),sim_ms:1619428993e3}},t=Zn(e),u(t,"#wcomponents/wc88/&storage_location=&subview_id=kv77&view=knowledge&x=101&y=158&zoom=100&sdate=2021-04-26&stime=10:23:13&cdate=2020-10-21&ctime=18:04:24")}),P3=60*1e3;function bw(e,t){let n=Number.NEGATIVE_INFINITY;return ni(e)&&e.type==="action"&&e.values_and_prediction_sets.forEach(i=>{var s;const o=((s=ii(i.datetime))==null?void 0:s.getTime())||Number.NEGATIVE_INFINITY;n=Math.max(n,o)}),n=Math.max(n+P3,t.routing.args.sim_ms),n}const I3=(e,t)=>{if(Ev(t)){const{route:n,sub_route:i,item_id:o,args:s}=e.routing,r=It(e.routing,t);(n!==r.route||i!==r.sub_route||o!==r.item_id||Rc(s)!==Rc(r.args))&&(e={...e,routing:r})}if(Qo(t)){const n=bw(t.wcomponent,e);n!==e.routing.args.sim_ms&&(e=Zo(e,"routing","args","sim_ms",n))}return e},R3=(e,t)=>{if(bx(t)){const n=t.side==="right"?"find_all_causal_paths_from_wcomponent_ids":"find_all_causal_paths_to_wcomponent_ids";e=q(e,"meta_wcomponents",n,t.ids)}return e};function yw(e,t,n){const i=e.findIndex(n);return i<0?(console.error(`Can not find element by predicate: ${n.toString()}`),e):[...e.slice(0,i),t,...e.slice(i+1)]}function wl(e,t){const n=e.filter(i=>!t(i));return n.length===e.length?e:n}function kw(e,t,n){const i=n||(s=>s===t),o=e.filter(s=>!i(s));return o.length===e.length&&o.push(t),o}function bt(e,t){return e.length>0&&t>=0&&t<e.length}function gt(e,t,n){if(!bt(e,t)||!bt(e,n))return e;const i=Math.min(t,n),o=Math.max(t,n),s=[...e],r=s[i];return s[i]=s[o],s[o]=r,s}function wt(e,t,n){return n<=0?e=[t,...e]:n>=e.length?e=[...e,t]:e=[...e.slice(0,n),t,...e.slice(n)],e}const D3=(e,t)=>{const n=e.meta_wcomponents.selected_wcomponent_ids_list;if(xx(t)){const{id:i}=t;let o=[...e.meta_wcomponents.selected_wcomponent_ids_list];const{shift_or_control_down:s}=e.global_keys.derived;s?o=kw(o,i):o=[i];const r={...e.meta_wcomponents,selected_wcomponent_ids_list:o,last_clicked_wcomponent_id:i};e={...e,meta_wcomponents:r}}if(Ax(t)&&(e=M3(e)),Cx(t)&&(e=O3(e,t)),Ix(t)){const i={wcomponent_id:t.wcomponent_id,terminal_type:void 0};e=q(e,"meta_wcomponents","last_pointer_down_connection_terminal",i)}if(jx(t)){const{wcomponent_id:i,terminal_type:o}=t;e=q(e,"meta_wcomponents","last_pointer_down_connection_terminal",{wcomponent_id:i,terminal_type:o})}return Dx(t)&&(e=q(e,"meta_wcomponents","last_pointer_down_connection_terminal",void 0)),Ox(t)&&(e=q(e,"meta_wcomponents","wcomponent_ids_to_move_set",t.wcomponent_ids_to_move)),n!==e.meta_wcomponents.selected_wcomponent_ids_list&&(e=xw(e)),e};function M3(e){return e=q(e,"meta_wcomponents","selected_wcomponent_ids_list",[]),e}function O3(e,t){return e=q(e,"meta_wcomponents","selected_wcomponent_ids_list",[...t.ids]),e}function xw(e){const t=new Set(e.meta_wcomponents.selected_wcomponent_ids_list),n={};e.meta_wcomponents.selected_wcomponent_ids_list.forEach((o,s)=>n[o]=s);const i={...e.meta_wcomponents,selected_wcomponent_ids_set:t,selected_wcomponent_ids_to_ordinal_position_map:n};return{...e,meta_wcomponents:i}}const q3=(e,t)=>(e=R3(e,t),e=D3(e,t),Fx(t)&&(e=q(e,"meta_wcomponents","frame_is_resizing",t.frame_is_resizing)),e);function V3(e,t){return t=F3(e,t),t}function F3(e,t){const n=e.sync.ready_for_reading!==t.sync.ready_for_reading;if((e.routing.item_id!==t.routing.item_id||n)&&t.routing.item_id&&Jt(t.routing.item_id)){const i=[t.routing.item_id];t=q(t,"meta_wcomponents","selected_wcomponent_ids_list",i),t=xw(t)}return t}function de(e,t,n=new Set){let i=P.undefined;do{if(n.has((e==null?void 0:e.id)||"")){console.log(`Recursion prevented in "get_wcomponent_VAPs_represent" for wcomponent id: "${e==null?void 0:e.id}" type: "${e==null?void 0:e.type}"`);break}if(e&&n.add(e.id),!At(e))break;if(Ye(e))i=z3(e.subtype);else if(ot(e))i=P.action;else if(pt(e)){const o=t[e.attribute_wcomponent_id||""];o&&(i=de(o,t,n))}else console.error(`Unimplemented "get_wcomponent_VAPs_represent" for wcomponent id: "${e.id}" type: "${e.type}"`)}while(!1);return i}function z3(e){return e==="boolean"?P.boolean:e==="number"?P.number:e==="other"?P.other:P.undefined}function Dt(e,t){if(Ki(e)){const n=Ke(e.values_and_prediction_sets||[],it,Be.ascending),i=de(e,t),o=n.map(s=>({...s,entries:el(s.entries,i)}));e.values_and_prediction_sets=o}return At(e)&&(e._derived__using_value_from_wcomponent_id&&console.error(`WComponent "${e.id}" had _derived__using_value_from_wcomponent_id set ("${e._derived__using_value_from_wcomponent_id}") but this should never happen and only be used on wcomponents from state.derived.composed_wcomponents_by_id`),delete e._derived__using_value_from_wcomponent_id),e}function Sw(e,t,n,i){let{wcomponent_ids:o,knowledge_view_ids:s}=e.sync.specialised_object_ids_pending_save;const r=t==="wcomponent";let a=r?o:s;return a=i?UA(a,n):WA(a,n),e=Zo(e,"sync","specialised_object_ids_pending_save",r?"wcomponent_ids":"knowledge_view_ids",a),e}function L3(e,t){return t=Dt(t,e.specialised_objects.wcomponents_by_id),t=Ji(t),e=jv(e,"sync","last_source_of_truth_specialised_objects_by_id","wcomponents",t.id,t),e}function B3(e,t){return t=Ji(t),e=jv(e,"sync","last_source_of_truth_specialised_objects_by_id","knowledge_views",t.id,t),e}function U3(e,t){return Aw(e,t,!1)}function Aw(e,t,n){return e={...e,needs_save:!0,modified_by_username:es(t)},n&&(e.deleted_at=new Date),e}function zt(e,t,n){const i={...e.specialised_objects.knowledge_views_by_id};return t=n?t:U3(t,e),i[t.id]=t,e=q(e,"specialised_objects","knowledge_views_by_id",i),e=Sw(e,"knowledge_view",t.id,!!t.needs_save),e}const W3=(e,t)=>(N2(t)&&(e=J3(e,t)),I2(t)&&(e=X3(e,t)),D2(t)&&(e=K3(e,t)),O2(t)&&(e=Y3(e,t)),V2(t)&&(e=H3(e,t)),z2(t)&&(e=G3(e,t)),e);function H3(e,t){const{knowledge_view_id:n,wcomponent_ids:i,override_entry:o,default_entry:s}=t,r=e.specialised_objects.knowledge_views_by_id[n],a=le(e);if(!r)console.error(`Could not find knowledge view for bulk_add_to_knowledge_view by id: "${n}"`);else if(!a)console.error("There should always be a current knowledge view if bulk editing position of world components");else{let c={};i.forEach(d=>{let p={...s,...a.composed_wc_id_map[d],...o,blocked:void 0,passthrough:void 0};if(p.left===void 0||p.top===void 0){console.error(`we should always have an entry but no bulk_entry provided and wcomponent "${d}" lacking entry in composed_kv composed_wc_id_map for "${n}"`);return}c[d]=p}),c={...r.wc_id_map,...c};const l={...r,wc_id_map:c};e=zt(e,l)}return e}function G3(e,t){const{wcomponent_ids:n,remove_type:i}=t,o=i==="block",s=qe(e),r=le(e);if(!s||!r)console.error("There should always be a current and current composed knowledge view if bulk editing (removing) positions of world components");else{const a={...s.wc_id_map};n.forEach(l=>{const d=o?r.composed_wc_id_map[l]:s.wc_id_map[l];if(!d)return;const p=o?{...d,blocked:!0,passthrough:void 0}:{...d,blocked:void 0,passthrough:!0};a[l]=p});const c={...s,wc_id_map:a};e=zt(e,c)}return e}function K3(e,t){const{wcomponent_ids:n,knowledge_view_id:i}=t,o=e.specialised_objects.knowledge_views_by_id[i];if(o){const s={...o.wc_id_map};n.forEach(a=>{const c=o.wc_id_map[a];if(!c)return;const l=ns(c,"large");s[a]=l});const r={...o,wc_id_map:s};e=zt(e,r)}return e}function Y3(e,t){const{wcomponent_ids:n,order:i}=t,o=qe(e),s=le(e);if(!o||!s)return console.error("There should always be a current knowledge view and current composed knowledge view if bulk editing (moving to top) world components"),e;let r={};i==="front"?(r={...o.wc_id_map},n.forEach(c=>{const l=s.composed_wc_id_map[c];l&&(delete r[c],r[c]=l)})):i==="back"&&(n.forEach(c=>{const l=s.composed_wc_id_map[c];l&&(r[c]=l)}),r={...r,...o.wc_id_map});const a={...o,wc_id_map:r};return e=zt(e,a),e}function J3(e,t){const{wcomponent_ids:n,change_left:i,change_top:o}=t,s=qe(e),r=le(e);if(s&&r){const a={...s.wc_id_map};n.forEach(l=>{const d=r.composed_wc_id_map[l];if(!d||d.blocked||d.passthrough)return;const p={...d};p.left+=i,p.top+=o,a[l]=p});const c={...s,wc_id_map:a};e=zt(e,c)}else console.error("There should always be a current knowledge view if bulk editing position of world components");return e}function X3(e,t){const{knowledge_view_id:n,changes:i}=t,o=e.specialised_objects.knowledge_views_by_id[n];if(o){const s={...o.wc_id_map};i.forEach(a=>{const c=o.wc_id_map[a.wcomponent_id];if(!c)return;const l={...c,left:a.left,top:a.top};s[a.wcomponent_id]=l});const r={...o,wc_id_map:s};e=zt(e,r)}return e}const Z3=(e,t)=>{if(Uv(t)&&(e=zt(e,t.knowledge_view,t.is_source_of_truth)),Qo(t)){const{wcomponent:n,add_to_knowledge_view:i}=t;if(i){const s={...i.position};e=ru(e,i.id,n.id,s)}const o=e.specialised_objects.knowledge_views_by_id[n.id];if(o&&o.title!==n.title){const s={...o,title:n.title};e=zt(e,s,t.is_source_of_truth)}}if(U2(t)&&(e=ru(e,t.knowledge_view_id,t.wcomponent_id,t.entry)),wg(t)&&t.object_type==="knowledge_view"){let n=Kn(e,t.id);n?(n={...n,saving:t.saving},e=Zo(e,"specialised_objects","knowledge_views_by_id",t.id,n)):console.error(`Could not find knowledge_view by id: "${t.id}" whilst handling is_update_specialised_object_sync_info`)}return e=W3(e,t),e};function ru(e,t,n,i){const o=Kn(e,t);return o?Q3(e,o,n,i):(console.error(`Could not find knowledge_view for id: "${t}"`),e)}function Q3(e,t,n,i){let o={...t.wc_id_map};const s=o[n];s&&(s.blocked&&!i.blocked||s.passthrough&&!i.passthrough)&&delete o[n],o[n]=i;const r={...t,wc_id_map:o};return zt(e,r)}function tn(e,t){const n={};return e.forEach(i=>{if(n[i.id])throw new Error(`Duplicate "${t}".id: "${n[i.id]}".  "${n[i.id].title}" and "${i.title}"`);n[i.id]=i}),n}const e$=(e,t)=>{if(Zv(t)){const{wcomponents:n,knowledge_views:i}=t.specialised_objects,o=tn(n,"wcomponents"),s=tn(i,"knowledge_views");e={...e,specialised_objects:{wcomponents_by_id:o,knowledge_views_by_id:s}}}return eg(t)&&(e={...e,specialised_objects:{wcomponents_by_id:{},knowledge_views_by_id:{}}}),e};function Dc(e,t,n,i=!1){const o={...e.specialised_objects.wcomponents_by_id};return t=n?t:Aw(t,e,i),o[t.id]=t,e=q(e,"specialised_objects","wcomponents_by_id",o),e=Sw(e,"wcomponent",t.id,!!t.needs_save),e}function t$(e,t){const n={...e.specialised_objects.wcomponents_by_id};return t.forEach(i=>n[i.id]=i),e=q(e,"specialised_objects","wcomponents_by_id",n),e}const n$=(e,t)=>(lx(t)&&(e=i$(e,t)),e);function i$(e,t){const{wcomponent_ids:n,change:i,remove_label_ids:o,add_label_ids:s}=t,r=Do(e,n).filter(ge);return r.length&&r.forEach(a=>{const c={...a,...i},l=o$(c,o,s),d=Dt(l,e.specialised_objects.wcomponents_by_id);e=Dc(e,d,!1)}),e}function o$(e,t,n){let{label_ids:i}=e;if(i&&t&&(i=i.filter(o=>!t.has(o))),n){const o=i||[],s=new Set(o);Array.from(n).forEach(r=>{s.has(r)||o.push(r)}),i=o}return{...e,label_ids:i}}const s$=(e,t)=>{if(Qo(t)){const n=Dt(t.wcomponent,e.specialised_objects.wcomponents_by_id);e=Dc(e,n,t.is_source_of_truth)}if(mx(t)){const{wcomponent_id:n}=t;let{wcomponents_by_id:i}=e.specialised_objects;const o=i[n];o&&(e=Dc(e,o,!1,!0))}if(hx(t)){const n=t.wcomponents.map(i=>Dt(i,e.specialised_objects.wcomponents_by_id));e=t$(e,n)}if(wg(t)&&t.object_type==="wcomponent"){let n=Me(e,t.id);n?(n={...n,saving:t.saving},e=Zo(e,"specialised_objects","wcomponents_by_id",t.id,n)):console.error(`Could not find wcomponent by id: "${t.id}" whilst handling is_update_specialised_object_sync_info`)}return e=n$(e,t),e},r$=(e,t)=>(e=nx(e,t),e=e$(e,t),e=s$(e,t),e=Z3(e,t),e),_$=(e,t)=>{if(Bx(t)){const{status:n,loading_base_id:i,error_message:o="",attempt:s}=t,r={...e.sync[t.data_type],status:n,error_message:o,retry_attempt:s};i!==void 0&&(r.loading_base_id=i),e=q(e,"sync",t.data_type,r),e=_u(e)}if(Wx(t)){const n=Object.values(e.specialised_objects.wcomponents_by_id),i=Object.values(e.specialised_objects.knowledge_views_by_id),o=au({wcomponents:n,knowledge_views:i});e=js(e,o)}if(eg(t)&&(e=js(e,{knowledge_view_ids:new Set,wcomponent_ids:new Set}),e=q(e,"sync","last_source_of_truth_specialised_objects_by_id",{wcomponents:{},knowledge_views:{}}),e=q(e,"sync","specialised_objects",{status:void 0,loading_base_id:void 0,error_message:"",retry_attempt:0}),e=_u(e)),Zv(t)){const{wcomponents:n,knowledge_views:i}=t.specialised_objects,o=au({wcomponents:n,knowledge_views:i});e=js(e,o);const s={wcomponents:tn(n,"wcomponents"),knowledge_views:tn(i,"knowledge_views")};e=q(e,"sync","last_source_of_truth_specialised_objects_by_id",s)}if(Qo(t)&&t.is_source_of_truth&&(e=L3(e,t.wcomponent)),Uv(t)&&t.is_source_of_truth&&(e=B3(e,t.knowledge_view)),Kx(t)&&(e=q(e,"sync","network_functional",t.network_functional),e=q(e,"sync","network_function_last_checked",t.last_checked)),Jx(t)){const n=new Set(e.sync.wcomponent_ids_to_search_for_in_any_base),{wcomponent_ids_searching_for_in_any_base:i,wcomponent_ids_searched_for_in_any_base:o}=e.sync;t.ids.filter(s=>!n.has(s)&&!i.has(s)&&!o.has(s)&&!e.specialised_objects.wcomponents_by_id[s]).forEach(s=>n.add(s)),e=q(e,"sync","wcomponent_ids_to_search_for_in_any_base",n)}if(Zx(t)){const n=Bn(e.sync.wcomponent_ids_to_search_for_in_any_base,e.sync.wcomponent_ids_searching_for_in_any_base);e=q(e,"sync","wcomponent_ids_to_search_for_in_any_base",new Set),e=q(e,"sync","wcomponent_ids_searching_for_in_any_base",n)}if(eS(t)){const n=new Set(e.sync.wcomponent_ids_searching_for_in_any_base),i=new Set(e.sync.wcomponent_ids_searched_for_in_any_base);t.ids.forEach(o=>{n.delete(o),i.add(o)}),e=q(e,"sync","wcomponent_ids_searching_for_in_any_base",n),e=q(e,"sync","wcomponent_ids_searched_for_in_any_base",i)}return e};function _u(e){const{bases:t,specialised_objects:n}=e.sync,i=a$(n);return e=q(e,"sync","ready_for_reading",i.ready_for_reading),e=q(e,"sync","ready_for_writing",i.ready_for_writing),e}function a$(e){const{status:t}=e;return{ready_for_reading:t!==void 0&&t!=="LOADING",ready_for_writing:t==="SAVED"||t==="LOADED"||t==="FAILED"}}function au(e){const t=new Set(e.wcomponents.filter(i=>i.needs_save).map(({id:i})=>i)),n=new Set(e.knowledge_views.filter(i=>i.needs_save).map(({id:i})=>i));return{wcomponent_ids:t,knowledge_view_ids:n}}function js(e,t){return q(e,"sync","specialised_object_ids_pending_save",t)}const Vn=(e,t)=>{var n,i;if(iS(t)){const o=((n=e.user_info.user)==null?void 0:n.id)!==((i=t.user)==null?void 0:i.id);e=q(e,"user_info","user",t.user);const s=e.user_info.has_signed_in_at_least_once||!!t.user;e=q(e,"user_info","has_signed_in_at_least_once",s),o&&U.user.pub("changed_user",!0)}if(_S(t)){let o;t.users&&(o={},t.users.forEach(s=>o[s.id]=s)),e=q(e,"user_info","users_by_id",o)}if(sS(t)&&(e=q(e,"user_info","need_to_handle_password_recovery",t.need_to_handle_password_recovery)),dS(t)){const{bases:o}=t,s=c$(o);e=q(e,"user_info","bases_by_id",s);let r=!1;if(e.user_info.user){const a=e.user_info.chosen_base_id;e=l$(e),r=a!==e.user_info.chosen_base_id}U.user.pub("changed_bases",!0),r&&U.user.pub("changed_chosen_base_id",!0)}if(cS(t)){const o=e.user_info.chosen_base_id;e=q(e,"user_info","chosen_base_id",t.base_id),o!==e.user_info.chosen_base_id&&U.user.pub("changed_chosen_base_id",!0)}return e};function c$(e){let t;return e&&(t={},e.forEach(n=>t[n.id]=n)),t}function l$(e){var i;const{bases_by_id:t,chosen_base_id:n}=e.user_info;if(t&&(n===void 0||!t[n])){const o=jg(e),s=o&&((i=o[0])==null?void 0:i.id);e=q(e,"user_info","chosen_base_id",s)}return e}const Ii=e=>(t,n)=>{t=t||e;const i=t;return t=d3(t,n),t=_$(t,n),t=I3(t,n),t=m3(t,n),t=m2(t,n),t=w2(t,n),t=r$(t,n),t=q3(t,n),t=zA(t,n),t=p3(t,n),t=Vn(t,n),t=h3(t,n),t=x2(t,n),t={...t,last_action:n},t=l3(i,t),t=V3(i,t),window.debug_state=t,t},d$=e=>{let t;const n=u$();m$(e);function i(){const o=e.getState();if(o.routing===t)return;const s=p$(t,o.routing);t=o.routing,n(s,o.routing)}return i(),i};let $o=!1;function u$(){const e=jc(n=>{const i=Zn(n);window.DEBUG_ROUTING&&console.log("DELAYED changing route from ",window.location.hash.toString(),"   to:   ",i),window.location.hash=i,$o=!1},1e3),t=jc(n=>{const i=Zn(n),o=x3(window.location.toString());window.DEBUG_ROUTING&&console.log(`Debounced changing route from "${o?"incomplete":"complete"}"`,window.location.hash.toString(),"   to:   ",i),o?history.replaceState(null,"",i):window.location.hash=i,$o=!1},0);return(n,i)=>{$o=!0,n?e.throttled(i):(e.cancel(),t.cancel(),t.throttled(i))}}function p$(e,t){return!e||!e.args?!1:e.args.x!==t.args.x||e.args.y!==t.args.y}function m$(e){window.onhashchange=t=>{var o,s,r,a;if($o)return;const n=t,i=e.getState();if(i.sync.ready_for_reading){const c="#"+(n.newURL.split("#")[1]||""),l=Zn(i.routing);if(l===c){window.DEBUG_ROUTING&&console.log("on hash change but no difference to current hash route_from_state",l);return}window.DEBUG_ROUTING&&console.log("on hash change difference.  new url is: ",c,"   state is:   ",l),e.dispatch(S.meta_wcomponents.clear_selected_wcomponents());const p=ww(n.newURL,i.routing);((o=p==null?void 0:p.args)==null?void 0:o.created_at_ms)!==void 0&&((s=p==null?void 0:p.args)==null||delete s.created_at_datetime),((r=p==null?void 0:p.args)==null?void 0:r.sim_ms)!==void 0&&((a=p==null?void 0:p.args)==null||delete a.sim_datetime),e.dispatch(S.routing.change_route(p))}}}function f$(e){const t=e.getState();let{chosen_base_id:n}=t.user_info;e.subscribe(()=>{const i=e.getState(),{chosen_base_id:o}=i.user_info,{storage_location:s}=i.routing.args;s===void 0?s!==o&&(console.log(`Change storage_location in route to "${o}" as nothing was set`),e.dispatch(S.routing.change_route({args:{storage_location:o}}))):s!==o&&(n!==o?e.dispatch(S.routing.change_route({args:{storage_location:o}})):e.dispatch(S.user_info.update_chosen_base_id({base_id:s}))),n=o})}const h$={sync_storage_location_subscriber:f$};function v$(e){U.canvas.sub("canvas_right_click",t=>{e.dispatch(S.meta_wcomponents.clear_selected_wcomponents());const{route:n,item_id:i,sub_route:o}=e.getState().routing;(n==="wcomponents"&&i||o==="wcomponents_edit_multiple")&&e.dispatch(S.routing.change_route({route:"wcomponents",sub_route:null,item_id:null}))})}function Le(e,t,n){return Math.max(Math.min(e,n),t)}const bl=e=>Le(e,10,400),Oe=100,g$=.01;function w$(e){const{zoom:t,wheel_change:n}=e,i=t-n*g$*t;return bl(Math.round(i))}function $w(e){const{old:t,new_zoom:n,pointer_x:i,pointer_y:o,client_width:s,client_height:r}=e,a=i/s,c=o/r,l=Oe/n-Oe/t.zoom,d=a*s*l,p=c*r*l,f=t.x-d,m=t.y+p;return{x:f,y:m}}const b$=k.skip("calculate_new_zoom_xy (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{let e,s,r,a;const c={pointer_x:5,pointer_y:15},l={pointer_x:5+900,pointer_y:15+600};function d(p){const f=p.pointer==="top_left"?c:l;return $w({old:{x:p.x,y:p.y,zoom:p.zoom},new_zoom:p.new_zoom,...f,client_width:900,client_height:600})}a="top_left",e=d({x:0,y:0,zoom:10,new_zoom:200,pointer:a}),u(e,{x:0,y:0}),e=d({x:100,y:100,zoom:200,new_zoom:200,pointer:a}),u(e,{x:100,y:100}),e=d({x:100,y:100,zoom:200,new_zoom:10,pointer:a}),u(e,{x:100,y:100}),a="bottom_right",s=100,r=50,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900,y:600}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900+100,y:600+100}),s=200,r=100,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900/2,y:600/2}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:-900/2+100,y:600/2+100}),s=100,r=200,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900/2,y:-600/2}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900/2+100,y:-600/2+100}),s=50,r=100,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900,y:-600}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:900+100,y:-600+100}),s=50,r=50,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),u(e,{x:0,y:0}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),u(e,{x:100,y:100})}),Ri=440,y$=100;function k$(e){const t=e.get_date(),n=t.getTime(),o={route:"wcomponents",sub_route:null,item_id:null,args:{view:"knowledge",subview_id:"",zoom:100,x:0,y:0,storage_location:void 0,created_at_datetime:t,created_at_ms:n,sim_datetime:t,sim_ms:n}};return ww(e.get_url(),o)}const is=48,x$=e=>e?300:120,S$=e=>e?Ri:0,yl=e=>document.body.clientWidth-S$(e),kl=e=>document.body.clientHeight-is-x$(e),Cw=e=>yl(e)/2,Tw=e=>kl(e)/2;function A$(e,t,n){const i=Fi(e.x+Cw(t)*(Oe/e.zoom),Jn),o=Fi(e.y-Tw(n)*(Oe/e.zoom)+is,vn);return{x:i,y:o}}function $$(e,t){const n=e.x-Cw(t.display_side_panel)*(Oe/e.zoom),i=e.y+(Tw(t.display_time_sliders)+is)*(Oe/e.zoom);return{x:n,y:i}}function si(e){const t=A$(e.routing.args,e.controls.display_side_panel,e.controls.display_time_sliders);return rw(t)}const C$={display_side_panel:!1,display_time_sliders:!1};function Oo(e,t,n){if(!e)return;const{left:i,top:o,zoom:s=y$}=e,r=o!==void 0?-1*o:void 0;return t&&i!==void 0&&r!==void 0?{...$$({x:i,y:r,zoom:s},n||C$),zoom:s}:{x:i,y:r,zoom:s}}function T$(e,t,n){let i=e?t[e]:void 0;for(;i;){const o=n[i.id];if(ot(o))return[o.id];i=i.parent_knowledge_view_id?t[i.parent_knowledge_view_id]:void 0}return[]}const E$=60*1e3;function ri(e){const t=e.store||ye(),n=t.getState();let i=Rt(e.wcomponent);i=j$(i,n),i=P$(i,n);const o=N$(e.add_to_knowledge_view,i,n);let s=it(i);s=Math.max(s+E$,n.routing.args.created_at_ms);const r=bw(i,n);return t.dispatch(S.specialised_object.upsert_wcomponent({wcomponent:i,add_to_knowledge_view:o})),t.dispatch(S.meta_wcomponents.clear_selected_wcomponents()),t.dispatch(S.routing.change_route({route:"wcomponents",item_id:i.id,args:{created_at_ms:s,sim_ms:r}})),!0}function j$(e,t){if(!ot(e)||e.parent_goal_or_action_ids)return e;const n=le(t),{wcomponents_by_id:i,knowledge_views_by_id:o}=t.specialised_objects,s=n==null?void 0:n.id,r=T$(s,o,i);return{...e,parent_goal_or_action_ids:r}}function N$(e,t,n){const i=le(n);if(!e&&i){let o;pt(t)&&(o=t.attribute_wcomponent_id);let s=i.composed_wc_id_map[o||""];s||(s=si(n)),e={id:i.id,position:s}}return e}function P$(e,t){if(pt(e)){const{wcomponents_by_id:n}=t.specialised_objects;let{attribute_wcomponent_id:i,value_possibilities:o}=e;const s=t.meta_wcomponents.selected_wcomponent_ids_list,r=s[0];if(s.length===1&&r){const a=Me(t,r);if(a&&Ye(a)){const c=a;if(i=a.id,!o||!Object.keys(o).length){const l=de(c,n),d=hn(l,c.value_possibilities,c.values_and_prediction_sets||[]);o=tn(d,"attribute's possible_values")}}}e={...e,attribute_wcomponent_id:i,value_possibilities:o}}return e}function I$(e){return()=>{const t=e.getState(),{last_pointer_down_connection_terminal:n}=t.meta_wcomponents;if(!n)return;const i=mt(t);if(i===void 0)return;if(t.global_keys.last_key==="Escape"||t.display_options.consumption_formatting){e.dispatch(S.meta_wcomponents.clear_pointerupdown_on_connection_terminal());return}if(!t.last_action)return;let o=!1;const{terminal_type:s,wcomponent_id:r}=n,a=(s==null?void 0:s.attribute)||"state";let c=s==null?void 0:s.side,l,d="state",p=((s==null?void 0:s.side)||"right")==="right"?"left":"right";if(Px(t.last_action))l=t.last_action.wcomponent_id,o=r===l&&(s==null?void 0:s.side)===void 0;else if(Ex(t.last_action))l=t.last_action.wcomponent_id,d=t.last_action.terminal_type.attribute,p=t.last_action.terminal_type.side;else return;if(o=o||r===l&&c===p,e.dispatch(S.meta_wcomponents.clear_pointerupdown_on_connection_terminal()),o)return;c=p==="right"?"left":"right";const f=c==="right";ri({wcomponent:{base_id:i,type:a==="meta"||d==="meta"?"relation_link":"causal_link",from_id:f?r:l,to_id:f?l:r,from_type:f?a:d,to_type:f?d:a}})}}function R$(e){function t(){const n=e.getState(),{last_pointer_down_connection_terminal:i}=n.meta_wcomponents;i&&e.dispatch(S.meta_wcomponents.clear_pointerupdown_on_connection_terminal())}U.canvas.sub("canvas_right_click",()=>{t()}),U.canvas.sub("canvas_pointer_down",()=>{t()}),U.canvas.sub("canvas_pointer_up",()=>{t()})}function D$(e){U.canvas.sub("canvas_double_tap",t=>{const n=e.getState(),i=qe(n);if(!i){console.error("No current_knowledge_view despite canvas double_tap");return}const o=mt(n);if(o===void 0){console.error("No base_id despite canvas double_tap");return}if(n.display_options.consumption_formatting||n.routing.args.view!=="knowledge")return;const s=M$(t),r={id:i.id,position:s};ri({wcomponent:{base_id:o,type:"statev2"},add_to_knowledge_view:r,store:e})})}function M$(e){const t=GA(rw(e));return ns(t,"large")}function O$(e){q$(e);const t=I$(e);return()=>{t()}}function q$(e){v$(e),D$(e),R$(e)}function V$(){return{composed_wcomponents_by_id:{},wcomponent_ids_by_type:ow(),knowledge_views:[],nested_knowledge_view_ids:{top_ids:[],map:{}},current_composed_knowledge_view:void 0}}function F$(){return{last_key:void 0,last_key_time_stamp:void 0,keys_down:new Set,derived:{shift_down:!1,control_down:!1,shift_or_control_down:!1}}}function z$(){return{action_ids_to_show:[],date_shown:void 0}}function L$(){return{selected_wcomponent_ids_list:[],selected_wcomponent_ids_set:new Set,selected_wcomponent_ids_to_ordinal_position_map:{},highlighted_wcomponent_ids:new Set,neighbour_ids_of_highlighted_wcomponent:new Set,last_clicked_wcomponent_id:void 0,last_pointer_down_connection_terminal:void 0,wcomponent_ids_to_move_set:new Set,frame_is_resizing:!1,find_all_causal_paths_from_wcomponent_ids:[],find_all_causal_paths_to_wcomponent_ids:[]}}function B$(){return{wcomponents_by_id:{},knowledge_views_by_id:{}}}const U$={get_date:()=>new Date,get_url:()=>window.location.toString(),get_url_hash:()=>window.location.hash,get_persisted_state_object:zh()};function Qt(e=U$){const t=k$(e),{storage_location:n}=t.args,i=VA({storage_location:n},e);return{controls:kA({storage_location:n},e),filter_context:$A(e),specialised_objects:B$(),last_action:void 0,display_options:SA(e),sync:jA(e),routing:t,global_keys:F$(),meta_wcomponents:L$(),search:TA(e),toast_message:{},user_info:i,view_priorities:z$(),derived:V$()}}function Si(e){const{current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,disable_if_not_present:o,display_side_panel:s,display_time_sliders:r}=e;let{created_at_ms:a,selected_wcomponent_ids_set:c}=e,l,d=[];if(t){const{composed_wc_id_map:p,composed_visible_wc_id_map:f,wc_ids_by_type:m}=t,h=n[i];l=h&&it(h);const{any_node:v}=m;c=new Set(c),c.delete(i);const g=H$({initial_wcomponent:h,disable_if_not_present:o,composed_visible_wc_id_map:f,selected_wcomponent_ids_set:c,wcomponents_by_id:n,composed_wc_id_map:p,display_side_panel:s,display_time_sliders:r,any_node:v});d=g.positions,g.wcomponent_created_at_ms&&(l=Math.max(g.wcomponent_created_at_ms,l||0)),l&&(a=Math.max(a,l))}return{positions:d,go_to_datetime_ms:a}}function W$(e){const{current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,selected_wcomponent_ids_set:o,created_at_ms:s,disable_if_not_present:r}=e,a={current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,selected_wcomponent_ids_set:o,created_at_ms:s,disable_if_not_present:r},{positions:c,go_to_datetime_ms:l}=Si({...a,display_side_panel:!1,display_time_sliders:!1}),d=Si({...a,display_side_panel:!0,display_time_sliders:!1}).positions,p=Si({...a,display_side_panel:!1,display_time_sliders:!0}).positions,f=Si({...a,display_side_panel:!0,display_time_sliders:!0}).positions;return{positions_no_sidepanel_or_timesliders:c,positions_sidepanel_no_timesliders:d,positions_timesliders_no_sidepanel:p,positions_with_sidepanel_or_timesliders:f,go_to_datetime_ms:l}}function H$(e){const{initial_wcomponent:t,disable_if_not_present:n,composed_visible_wc_id_map:i,selected_wcomponent_ids_set:o,wcomponents_by_id:s,composed_wc_id_map:r,display_side_panel:a,display_time_sliders:c,any_node:l}=e;let d=[],p;const f={display_side_panel:a,display_time_sliders:c},m=r[(t==null?void 0:t.id)||""];if(t&&m){const{left:h,top:v}=KA(m,!!t.summary_image),g=Oo({left:h,top:v,zoom:Oe},!0,f);d.push(g)}else if(!n&&i){let h=lu(o,i),v=cu(h,s,r,f);v.position_groups.length===0&&(h=lu(l,i),v=cu(h,s,r,f)),p=v.wcomponent_created_at_ms,d=v.position_groups.map(g=>Oo({left:(g.min_left+g.max_left)/2,top:(g.min_top+g.max_top)/2,zoom:g.zoom},!0,f))}return{positions:d,wcomponent_created_at_ms:p}}function cu(e,t,n,i){const o=[];let s;const r=Array.from(e);for(let a=0;a<r.length;++a){const c=r[a];if(!c)continue;const l=t[c],d=n[c];if(!l||!d)continue;const p=d.s??1,f=_w(!!l.summary_image),m=d.left-Ce,h=d.left+Ce*p+Ce,v=d.top-f,g=d.top+f*p;if(!o.find(w=>{const x={min_left:Math.min(w.min_left,m),max_left:Math.max(w.max_left,h),min_top:Math.min(w.min_top,v),max_top:Math.max(w.max_top,g)},{zoom:y,fits:$}=G$(x,i);return $?(w.min_left=x.min_left,w.max_left=x.max_left,w.min_top=x.min_top,w.max_top=x.max_top,w.zoom=y,!0):!1})){if(o.length>10)break;const w={min_left:m,max_left:h,min_top:v,max_top:g,zoom:Oe};o.push(w)}s=it(l)}return{position_groups:o,wcomponent_created_at_ms:s}}function G$(e,t){const n=e.max_left-e.min_left,i=e.max_top-e.min_top,o=yl(t.display_side_panel)/n*Oe,s=kl(t.display_time_sliders)/i*Oe,r=Math.min(o,s),a=bl(Math.min(Oe,r));return{zoom:a,fits:r>=a}}function lu(e,t){const n=new Set(e);return e.forEach(i=>{t[i]||n.delete(i)}),n}function os(e){return e.controls.display_time_sliders}function K$(e){const t=e.getState();if(!Y$(t)){const n=Yi(t),i=t.specialised_objects.knowledge_views_by_id[(n==null?void 0:n.default_knowledge_view_id)||""],o=t.derived.knowledge_views[0],s=i||o,r=t.controls.display_side_panel,a=os(t);if(!s)return;const c=J$(t,s,r,a),l={subview_id:s.id,...c};e.dispatch(S.routing.change_route({args:l}))}}function Y$(e){const{subview_id:t}=e.routing.args;return!!e.specialised_objects.knowledge_views_by_id[t]}function J$(e,t,n,i){let o=dw(e,t);o=Pc(e,o);const{wcomponents_by_id:s}=e.specialised_objects,r=e.routing.item_id||"",{created_at_ms:a}=e.routing.args,{selected_wcomponent_ids_set:c}=e.meta_wcomponents,l=Si({current_composed_knowledge_view:o,wcomponents_by_id:s,initial_wcomponent_id:r,selected_wcomponent_ids_set:c,created_at_ms:a,disable_if_not_present:!1,display_side_panel:n,display_time_sliders:i});return{x:0,y:0,z:0,...l.positions[0],created_at_ms:l.go_to_datetime_ms}}function X$(e){const t=e.getState();if(!t.sync.ready_for_reading||t.derived.knowledge_views.length)return;const n=mt(t);if(n===void 0){console.error("Can not create knowledge view without chosen_base_id");return}const i=Fe({title:"All",base_id:n});e.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:i}))}function Z$(e){const t=new Set(["wcomponents","knowledge_views"]);let n=[],i=[];if(e){const r=Object.keys(e).filter(l=>!t.has(l));if(r.length)throw new Error(`Unexpected keys "${r.join(", ")}" in specialised objects state`);const a=Array.from(t).filter(l=>!Object.hasOwnProperty.call(e,l));if(a.length)throw new Error(`Expected keys "${a.join(", ")}" missing in specialised objects state`);n=e.wcomponents.map(pl);const c=new Set(n.map(({id:l})=>l));i=e.knowledge_views.map(l=>cl(l,c,!0))}return{wcomponents:n,knowledge_views:i}}function Q$(e){try{return Z$(e)}catch(t){throw console.error("Error parsing specialised objects state from server"),t}}async function eC(e,t){if(!e)return Promise.resolve(OA);const n=ke(),i=await Og({supabase:n,base_id:t});if(i.error)return Promise.reject(i.error);const o=await VS({supabase:n,base_id:t});if(o.error)return Promise.reject(o.error);const s=await FS({supabase:n,base_id:t,knowledge_views:i.value,wcomponents:o.wcomponents});if(s.error)return Promise.reject(s.error);const r=await jS({supabase:n,knowledge_views:i.value,wcomponents_from_other_bases:s.wcomponents});if(r.error)return Promise.reject(r.error);const a=[...o.wcomponents,...s.wcomponents],c=[...i.value,...r.value];return Promise.resolve({knowledge_views:c,wcomponents:a})}function Ns(e){let t=e.getState();const{dispatch:n}=e,{chosen_base_id:i}=t.user_info;i!==t.sync.specialised_objects.loading_base_id&&(e.dispatch(S.specialised_object.clear_from_mem_all_specialised_objects()),i!==void 0&&(n(S.sync.update_sync_status({status:"LOADING",data_type:"specialised_objects",loading_base_id:i})),eC(e.load_state_from_storage,i).then(o=>Q$(o)).then(o=>{n(S.specialised_object.replace_all_specialised_objects({specialised_objects:o})),n(S.sync.update_sync_status({status:"LOADED",data_type:"specialised_objects"})),X$(e),K$(e)}).catch(o=>{const s=Fg(o);console.error(o),n(S.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:s}))})))}function tC(e){U.user.sub("changed_bases",()=>{const{ready_for_reading:o}=e.getState().sync;o||Ns(e)}),U.user.sub("changed_chosen_base_id",()=>Ns(e));const t=e.getState(),{user:n,chosen_base_id:i}=t.user_info;n&&i!==void 0&&Ns(e),nC(e)}function nC(e){const t=ke(),n=Yg(async()=>{const i=e.getState();if(!i.sync.wcomponent_ids_to_search_for_in_any_base.size)return;const o=Array.from(i.sync.wcomponent_ids_to_search_for_in_any_base);e.dispatch(S.sync.searching_for_wcomponents_by_id_in_any_base());const s=await Vg({supabase:t,ids:o});e.dispatch(S.sync.searched_for_wcomponents_by_id_in_any_base({ids:o})),e.dispatch(S.specialised_object.add_wcomponents_to_store({wcomponents:s.wcomponents}))},50);e.subscribe(()=>{const i=e.getState();i.sync.ready_for_reading&&i.sync.wcomponent_ids_to_search_for_in_any_base.size&&n.throttled()}),U.user.sub("changed_chosen_base_id",()=>{n.cancel()})}function iC(e,t){if(e&&Eg(t))return!0}function oC(e,t){let n=performance.now();const i=30*1e3;window.onbeforeunload=()=>{const o=t.getState();let s=iC(e,o);return s&&(s=performance.now()-n>i),s&&(n=performance.now()),s}}async function sC(e){const n=await ke().from("bases").select("*, access_controls(access_level,user_id)").order("inserted_at",{ascending:!0}),i=n.data?n.data.map(o=>_C(o,o.access_controls,e)):void 0;return{error:n.error,data:i}}async function rC(e){const{owner_user_id:t,title:n="Primary"}=e,o=await ke().from("bases").insert({owner_user_id:t,title:n}).select();return{base:o.data&&o.data[0]||void 0,error:o.error}}function Ew(e){return{id:e.id,inserted_at:e.inserted_at,updated_at:e.updated_at,owner_user_id:e.owner_user_id,public_read:e.public_read,title:e.title,default_knowledge_view_id:e.default_knowledge_view_id}}function _C(e,t,n){let{inserted_at:i,updated_at:o}=e;const{owner_user_id:s,public_read:r}=e;i=new Date(i),o=new Date(o);const a=t==null?void 0:t.find(d=>d.user_id===n),c=(a==null?void 0:a.access_level)||(n===s?"owner":r?"viewer":"none"),l=c==="owner"||c==="editor";return{...Ew(e),inserted_at:i,updated_at:o,access_level:c,can_edit:l}}async function aC(e){const t=Ew(e);return await ke().from("bases").update(t).eq("id",t.id)}async function Mc(e,t=!1){e||(e=ye()),t&&e.dispatch(S.user_info.update_bases({bases:void 0}));const{user:n}=e.getState().user_info;e.dispatch(S.sync.update_sync_status({status:"LOADING",data_type:"bases"}));const{data:i,error:o}=await sC(n==null?void 0:n.id);e.dispatch(S.user_info.update_bases({bases:i}));const s=o?"FAILED":"LOADED";return e.dispatch(S.sync.update_sync_status({status:s,data_type:"bases"})),{error:o||void 0}}function cC(e){if(!e.load_state_from_storage)return;const t=e.getState(),{users_by_id:n}=t.user_info;n||du(e),U.user.sub("changed_user",()=>{var s;(s=Yi(e.getState()))!=null&&s.public_read||e.dispatch(S.specialised_object.clear_from_mem_all_specialised_objects()),U.user.pub("stale_users_by_id",!0),U.user.pub("stale_bases",!0)}),U.user.sub("stale_users_by_id",s=>{s&&e.dispatch(S.user_info.set_users({users:void 0})),du(e)}),U.user.sub("stale_bases",s=>{Mc(e,s)});let i=!0;const o=ke();o.auth.onAuthStateChange(()=>{setTimeout(async()=>{const s=e.getState().user_info.user,a=(await o.auth.getUser()).data.user||void 0;(s==null?void 0:s.id)!==(a==null?void 0:a.id)?e.dispatch(S.user_info.set_user({user:a})):i&&Mc(e),i=!1},0)})}async function du(e){const t=ke(),{data:n,error:i}=await t.from("users").select();i&&console.error("Error getting users",i),n&&e.dispatch(S.user_info.set_users({users:n}))}let Ps;function ye(e={}){const{use_cache:t=!0,override_preloaded_state:n={},load_state_from_storage:i=!1}=e;if(Ps&&t)return Ps;const o={...Qt(),...n},s=Ii(o),r=c1(s,o);r.load_state_from_storage=i,Ps=r;const a=()=>{const c=r.getState();FA(c),Wg(r)};return r.subscribe(a),oC(i,r),r.subscribe(d$(r)),r.subscribe(O$(r)),eA(r),mA(r),lA(r),g2(r),bA(r),h$.sync_storage_location_subscriber(r),cC(r),tC(r),JS(r),QS(r),r}function lC({probability:e,conviction:t}){return e>0&&e<1||t!==1}function dC({probability:e,conviction:t}){return Math.min(e,t)}const jw="VAP_uncertainty_id__undefined__",Nw="VAP_false_id__undefined__";function uC(e,t){let n=t===P.boolean?e.entries.slice(0,1):e.entries;return n=pC(n,t),{...e,entries:n}}function pC(e,t){if(t===P.boolean){const n=e[0];if(!n)return e;const i={...n,probability:1-n.probability,id:Nw,value_id:he.boolean_false,description:""};e=[{...n,value_id:he.boolean_true},i]}return e}function mC(e,t){const n=1-e,i={VAP_id:jw,value_id:he.uncertainty,value_text:"?",certainty:n,parsed_value:null};return[...t,i]}function xl(e){const{VAP_set_id_to_counterfactual_v2_map:t}=e;let{VAP_set:n}=e;const i=(t==null?void 0:t[n.id])||[];let o=!1,s;return i.forEach(r=>{const{target_VAP_id:a}=r;a&&(n=fC(n,a),o=!0,s=r.id)}),{...n,has_any_counterfactual_applied:o,active_counterfactual_v2_id:s}}function fC(e,t){const n=t===jw?0:1,i={...e.shared_entry_values,conviction:n},o=e.entries.map(s=>{const r=s.id===t?1:0;return{...s,probability:r,relative_probability:0,conviction:n}});return{...e,shared_entry_values:i,entries:o,target_VAP_id:t}}var J=(e=>(e[e.past=0]="past",e[e.present=1]="present",e[e.future=2]="future",e[e.eternal=3]="eternal",e))(J||{});function fe(e,t){const{min:n,value:i,max:o}=e.datetime||{},[s,r]=n===void 0?[!1,0]:[!0,n.getTime()],[a,c]=i===void 0?[!1,0]:[!0,i.getTime()],[l,d]=o===void 0?[!1,0]:[!0,o.getTime()];if(s){if(r>t)return J.future;if(r===t||!l&&r<t)return J.present}if(l)return d<=t?J.past:J.present;if(a){if(c<t)return J.past;if(c===t)return J.present;if(c>t)return J.future}return J.eternal}const hC=k.delay("get_tense_of_uncertain_datetime",()=>{let e;const n=new Date("2021-04-01 00:01").getTime(),i=new Date("2021-04-01 00:02"),o=i.getTime(),s=new Date("2021-04-01 00:03"),r=s.getTime(),a=new Date("2021-04-01 00:04"),c=a.getTime(),d=new Date("2021-04-01 00:05").getTime();e=fe({datetime:{}},n),u(e,J.eternal),e=fe({datetime:{min:i}},n),u(e,J.future),e=fe({datetime:{min:i}},o),u(e,J.present),e=fe({datetime:{min:i}},r),u(e,J.present),e=fe({datetime:{value:i}},n),u(e,J.future),e=fe({datetime:{value:i}},o),u(e,J.present),e=fe({datetime:{value:i}},r),u(e,J.past),e=fe({datetime:{max:i}},n),u(e,J.present),e=fe({datetime:{max:i}},o),u(e,J.past),e=fe({datetime:{max:i}},r),u(e,J.past),e=fe({datetime:{min:i,max:s}},n),u(e,J.future),e=fe({datetime:{min:i,max:s}},o),u(e,J.present),e=fe({datetime:{min:i,max:s}},r),u(e,J.past),e=fe({datetime:{min:i,max:s}},c),u(e,J.past),e=fe({datetime:{min:i,value:s,max:a}},n),u(e,J.future),e=fe({datetime:{min:i,value:s,max:a}},o),u(e,J.present),e=fe({datetime:{min:i,value:s,max:a}},r),u(e,J.present),e=fe({datetime:{min:i,value:s,max:a}},c),u(e,J.past),e=fe({datetime:{min:i,value:s,max:a}},d),u(e,J.past)});function vC(e){const{items:t,sim_ms:n}=e,i=Sl(t);return Pw({sorted_items:i,sim_ms:n})}function Sl(e,t=Be.descending){return Ke(e,({datetime:i})=>{if(Wv(i))return Number.NEGATIVE_INFINITY;const{max:o,value:s,min:r}=i;return r?r.getTime()*10+2:s?s.getTime()*10+1:o?o.getTime()*10:1},t)}function Pw(e){const{sorted_items:t,sim_ms:n}=e;let i=[],o=[],s=[];const r=[];t.forEach(c=>{const l=fe(c,n);l===J.past?i.push(c):l===J.future?r.push(c):l===J.present?o.push(c):s.push(c)}),o.length!==1&&(o.length>1?(i=o.slice(1).concat(i),o=o.slice(0,1)):i.length&&(o=i.slice(0,1),i=i.slice(1))),s.length&&(o.length!==1&&(o=s.slice(0,1),s=s.slice(1)),i=i.concat(s));const a=o[0];return{past_items:i,present_item:a,future_items:r}}const gC=k.delay("partition_sorted_items_by_datetimes",()=>{function e(p){var m;const f=Pw(p);return{past_items:f.past_items.map(({id:h})=>h),present_item:(m=f.present_item)==null?void 0:m.id,future_items:f.future_items.map(({id:h})=>h)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime();t=[],n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:[],present_item:void 0,future_items:[]}),t=[{id:"10",datetime:{}},{id:"11",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:["11"],present_item:"10",future_items:[]},"Can handle multiple eternal elements"),t=[{id:"30",datetime:{value:a}},{id:"20",datetime:{value:s}},{id:"10",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:"10",future_items:["30","20"]},"Should partition eternal item as present if other items are in the future"),n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:["10"],present_item:"20",future_items:["30"]},"Should partition eternal item as past if other items are in the present"),n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]},"Should partition eternal item and other past items as past if other items are in the present"),n=e({sorted_items:t,sim_ms:d}),u(n,{past_items:["20","10"],present_item:"30",future_items:[]}),t=[{id:"40",datetime:{min:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"40",future_items:[]},"Should find min datetime as present when sim_ms is equal to min datetime"),n=e({sorted_items:t,sim_ms:o}),u(n,{past_items:[],present_item:void 0,future_items:["40"]},"Should find min datetime as future when sim_ms is before min datetime"),t=[{id:"50",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:r}),u(n,{past_items:[],present_item:"50",future_items:[]},"Should find max datetime as present when sim_ms is equal to max datetime"),t=[{id:"50",datetime:{max:s}},{id:"60",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:c}),u(n,{past_items:["60"],present_item:"50",future_items:[]},"Should find max datetime as past when sim_ms is later than max datetime but when no other item is present, will use one as present item")}),wC=k.delay("sort_by_uncertain_event_datetimes",()=>{function e(E){return Sl(E).map(({id:A})=>A)}function t(E,N){const A=[...E].reverse(),M=N.map(({id:T})=>T);i=e(E);const D=e(A);u(i,D,"",!1),u(i,M,"",!1)}let n=[],i,o;const s=new Date("2021-04-01 00:00"),r=new Date("2021-04-01 00:01"),a=new Date("2021-04-01 00:02"),c=new Date("2021-04-01 00:03");let l=0;const d=()=>`${l++}`,p={id:d(),datetime:{}},f={id:d(),datetime:{}},m={id:d(),datetime:{value:r}},h={id:d(),datetime:{value:a}},v={id:d(),datetime:{max:r}},g={id:d(),datetime:{max:a}},b={id:d(),datetime:{min:r}},w={id:d(),datetime:{min:a}},x={id:d(),datetime:{min:s,max:c}},y={id:d(),datetime:{min:r,max:a}};n=[],i=e(n),u(i,[],"",!1),n=[p,f];const $=[...n].reverse();i=e(n);const C=e($);u(JSON.stringify(i)!==JSON.stringify(C),!0,"Should be different (indeterminant sort)"),n=[p,m,h],o=[h,m,p],t(n,o),n=[p,b,w],o=[w,b,p],t(n,o),n=[p,v,g],o=[g,v,p],t(n,o),n=[p,m,h,b,w,v,g],o=[w,h,g,b,m,v,p],t(n,o),n=[p,x,y],o=[y,x,p],t(n,o)});function zi(e){const{invalid_future_items:t,current_items:n}=ol(e),{latest:i,previous_versions_by_id:o}=sl(n),s=vC({items:i,sim_ms:e.sim_ms});return{invalid_future_items:t,...s,previous_versions_by_id:o}}const bC=k.delay("partition_and_prune_items_by_datetimes_and_versions",()=>{const e=new Date("2021-04-01 00:00"),t=new Date("2021-04-01 00:01"),n=new Date("2021-04-01 00:02");function i(s){return s.map((r,a)=>({base_id:-1,id:`vps${a}`,created_at:t,version:1,datetime:{},entries:[],...r}))}let o=i([{datetime:{value:e},id:"vap_set_0"},{datetime:{value:t},id:"vap_set_1"},{datetime:{value:n},id:"vap_set_2"}]);k("all items created in future",()=>{const s=zi({items:o,created_at_ms:e.getTime(),sim_ms:t.getTime()});u(s.invalid_future_items,o,"should have all invalid future items"),u(s.past_items,[],"should have no past items"),u(s.present_item,void 0,"should have no present item"),u(s.future_items,[],"should have no future items"),u(s.previous_versions_by_id,{},"should have empty map of previous versions")}),k("all items created in past, sim_ms in middle",()=>{const s=zi({items:o,created_at_ms:t.getTime(),sim_ms:t.getTime()});u(s.invalid_future_items,[],"should have no invalid future items"),u(s.past_items,[o[0]],"vap_set_0 should be the one past item"),u(s.present_item,o[1],"vap_set_1 should be the one present item"),u(s.future_items,[o[2]],"vap_set_2 should be the one future item"),u(s.previous_versions_by_id,{vap_set_0:[],vap_set_1:[],vap_set_2:[]},"vap sets should have no previous versions")})});function ss(e,t){const n=e[0];return t===P.boolean&&n?[n]:e.sort((i,o)=>i.probability>o.probability?-1:i.probability<o.probability?1:0)}function Qn(e){const{wcomponent:t,VAP_set_id_to_counterfactual_v2_map:n,created_at_ms:i,sim_ms:o}=e;if(!At(t))return{most_probable_VAP_set_values:[],not_allowed_VAP_set_values:!0};const r=de(t,{}),{values_and_prediction_sets:a=[]}=t,{present_item:c}=zi({items:a,created_at_ms:i,sim_ms:o}),l=c===void 0?void 0:xl({VAP_set:c,VAP_set_id_to_counterfactual_v2_map:n}),{most_probable_VAP_set_values:d,any_uncertainty:p}=yC(l,r);let f=[l==null?void 0:l.active_counterfactual_v2_id,t._derived__using_value_from_wcomponent_id].filter(ge);return f=f.length?f:void 0,{most_probable_VAP_set_values:d,any_uncertainty:p,counterfactual_applied:l==null?void 0:l.has_any_counterfactual_applied,derived__using_value_from_wcomponent_ids:f}}function yC(e,t){if(!e||e.entries.length===0)return{most_probable_VAP_set_values:[],any_uncertainty:!1};const n=ss(e.entries,t);let i=!1,o=[];for(const s of n){const r=tl(s,t),a=dC(s),c=lC(s);if(i=i||c,t===P.boolean||c||s.probability!==0){const d={probability:s.probability,conviction:s.conviction,certainty:a,original_value:s.value,parsed_value:r,value_id:s.value_id};if(s.probability===1&&s.conviction===1){i=!1,o=[d];break}o.push(d)}}return{most_probable_VAP_set_values:o,any_uncertainty:i}}function Iw(e,t){let n="",i="";if(Ye(e)){const{value_possibilities:o={}}=e,s=o[he.boolean_true],r=o[he.boolean_false];n=(s==null?void 0:s.value)||n,i=(r==null?void 0:r.value)||i}return n=n?t?n+" (True)":n:"True",i=i?t?i+" (False)":i:"False",{true:n,false:i}}function Rw(e,t){let n;return typeof e=="boolean"?n=e?t.true:t.false:n=`${e}`,n}function rs(e){const{most_probable_VAP_set_values:t,any_uncertainty:n,counterfactual_applied:i,derived__using_value_from_wcomponent_ids:o}=Qn(e),s=Iw(e.wcomponent),r=[];t.forEach(l=>{const d=Rw(l.parsed_value,s);r.push(d)});const a=t.length>0,c=kC(r);return a?{values_string:c,counterfactual_applied:i,uncertain:n,derived__using_values_from_wcomponent_ids:o}:void 0}const Is=3;function kC(e){let t=e.slice(0,Is).join(", ").trim()||"not defined";return e.length>Is&&(t+=`, (${e.length-Is} more)`),t}function xC(e){let t="";if(Ne(e.wcomponent)){const n=e.wcomponents_by_id[e.wcomponent.from_id],i=e.wcomponents_by_id[e.wcomponent.to_id];(n||i)&&(t=`${n?"@@"+n.id:"_"} -> ${i?"@@"+i.id:"_"} <auto generated>`)}else if(Zc(e.wcomponent)){t="Counterfactual (no target set) <auto generated>";const n=e.wcomponent.target_wcomponent_id;n&&(t=`Counterfactual of: @@${n} <auto generated>`)}else if(pt(e.wcomponent)){t="State value (no target attribute set) <auto generated>";const{attribute_wcomponent_id:n}=e.wcomponent;n&&(t=n?`Alternative state value for @@${n} `:"No target attribute ",t+="<auto generated>")}return t}const SC=(e,t)=>`✗${e} (${t})`,Dw=(e,t,n="")=>`${e}#wcomponents/${t}`+(n?`&subview_id=${n}`:""),qo=(e,t,n="□",i="")=>`[${n}](${Dw(e,t,i)})`;function Mw(e,t,n){const{get_title:i,root_url:o,render_links:s,depth_limit:r}=n;if(t>=r)return e;const a=AC(e);return a.length===0||(a.forEach(({id:c,funktion:l})=>{const d=n.wcomponents_by_id[c];if(!TC(l))return;let p="";if(l==="map"){const m=n.knowledge_views_by_id[c],h=(m==null?void 0:m.title)||c;p=qo(o,d?c:"",h,c)}else if(d)if(l==="url")p=Dw(o,c);else if(l==="value"){const m=new Date().getTime(),h=rs({wcomponent:d,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:m,sim_ms:m});p=(h==null?void 0:h.values_string)||""}else p=s?qo(o,c):"",l==="title"?p=i(d):l==="description"&&(p+=d.description);else return;const f=new RegExp(`@@${c}.${l}`,"g");e=e.replace(f,p)}),t<r&&(e=Mw(e,t+1,n))),e}function AC(e){return[...e.matchAll(V1),...e.matchAll(q1)].map(n=>({id:n[1].slice(2),funktion:n[2]}))}const $C={url:!0,title:!0,description:!0,map:!0,value:!0},CC=new Set(Object.keys($C));function TC(e){return CC.has(e)}function Kt(e,t,n){const{root_url:i,depth_limit:o,get_title:s,render_links:r}=n;return fn(e).forEach(c=>{const l=new RegExp(`@@${c}`,"g"),d=n.wcomponents_by_id[c];if(!d){const m=r?qo(i,c,`@@${c}`):`@@${c}`;e=e.replace(l,SC(m,"not found"));return}const p=t<o?s(d):`@@${c}`,f=r?qo(i,c,p):p;e=e.replace(l,f)}),e}const EC=3;var pe=(e=>(e[e.raw=0]="raw",e[e.plain=1]="plain",e[e.rich=2]="rich",e))(pe||{});function at(e){const{wcomponent:t,wc_id_to_counterfactuals_map:n,created_at_ms:i,sim_ms:o}=e,s=e.text_type??2;let r=t.title;if(r||(r=xC(e)),s===0)return r;const a=jC({text:r,wcomponent:t,wc_id_to_counterfactuals_map:n,created_at_ms:i,sim_ms:o});return zn({...e,text:a,text_type:s})}function jC(e){var r;let{text:t}=e;const{wcomponent:n,wc_id_to_counterfactuals_map:i={}}=e;if(!t.includes("${value}"))return t;const o=(r=i[n.id])==null?void 0:r.VAP_sets,s=rs({wcomponent:n,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return s&&(t=t.replace(/\$\{value\}/g,`${s.values_string}`)),t}function zn(e){const{text:t,text_type:n,wcomponents_by_id:i,knowledge_views_by_id:o,depth_limit:s=EC,current_depth:r=0,root_url:a="",wc_id_to_counterfactuals_map:c,created_at_ms:l,sim_ms:d}=e;return n===0?t:NC(t,n,i,o,s,r,a,c,l,d)}function NC(e,t,n,i,o,s,r,a,c,l){t=t===2?s===0?2:1:t;function d(f){return at({text_type:t,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:a,created_at_ms:c,sim_ms:l,depth_limit:o,current_depth:s+1,root_url:r,wcomponent:f})}const p={wcomponents_by_id:n,knowledge_views_by_id:i,depth_limit:o,render_links:t===2,root_url:r,get_title:d};return e=Mw(e,s,p),e=Kt(e,s,p),e}const Ow=[{source:/^Degree$/i,targetString:"Degrees"},{source:/^Radians?$/i,targetString:"Degrees"},{source:/^Ampere$/i,targetString:"Amperes"},{source:/^Gram$/i,targetString:"Grams"},{source:/^Second$/i,targetString:"Seconds"},{source:/^Meter$/i,targetString:"Meters"},{source:/^(Meters? ?Squared?|Squared? ?Meters?)$/i,targetString:"Meters^2"},{source:/^(Centimeters? ?Squared?|Squared? ?Centimeters?)$/i,targetString:"Centimeters^2"},{source:/^(Centimeters? ?Cubed?|Cubic ?Centimeters?)$/i,targetString:"Centimeters^3"},{source:/^(Meters? Cubed?|Cubic ?Meters?)$/i,targetString:"Meters^3"},{source:/^(Kilometers? ?Cubed?|Cubic ?Kilometers?)$/i,targetString:"Kilometers^3"},{source:/^(Inches? Squared?|Squared? ?Inches?)$/i,targetString:"Inches^2"},{source:/^(Miles? ?Squared?|Squared? ?Miles?)$/i,targetString:"Miles^2"},{source:/^(Kilometers? Squared?|Squared? ?Kilometers?)$/i,targetString:"Kilometers^2"},{source:/^Acre? ?(Feet|Foot)$/i,targetString:"Acres,Feet"},{source:/^Meters? ?per ?Seconds?$/i,targetString:"Meters,Seconds^-1"},{source:/^Meters? ?per ?Seconds? ?Squared?$/i,targetString:"Meters,Seconds^-2"},{source:/^(Foot|Feet) ?per ?Seconds?$/i,targetString:"Feet,Seconds^-1"},{source:/^(Foot|Feet) ?per ?Seconds? ?Squared?$/i,targetString:"Feet,Seconds^-2"},{source:/^Miles? ?per ?Hours?$/i,targetString:"Miles,Hours^-1"},{source:/^Miles? ?per ?Hours? ?Squared?$/i,targetString:"Miles,Hours^-2"},{source:/^Kilometers? ?per ?Hours?$/i,targetString:"Kilometers,Hours^-1"},{source:/^Kilometers? ?per ?Hours? ?Squared?$/i,targetString:"Kilometers,Hours^-2"},{source:/^Liters? ?per ?Seconds?$/i,targetString:"Liters,Seconds^-1"},{source:/^(Cubic ?Meters?|Meters? ?Cubed?) ?per ?Seconds?$/i,targetString:"Meters^3,Seconds^-1"},{source:/^(Squared? ?Yards?|Yards? ?Squared?)$/i,targetString:"Yards^2"},{source:/^(Squared? ?(Feet|Foot)|(Feet|Foot) ?Squared?)$/i,targetString:"Feet^2"},{source:/^(Squared? Millimeters?|Millimeters? ?Squared?)$/i,targetString:"Millimeters^2"},{source:/^(Millimeters? ?Cubed?|Cubic ?Millimeters?)$/i,targetString:"Millimeters^3"},{source:/^Gallons? ?per ?Seconds?$/i,targetString:"Gallons,Seconds^-1"},{source:/^Gallons? ?per ?Minutes?$/i,targetString:"Gallons,Minutes^-1"},{source:/^Pounds? ?per ?Seconds?$/i,targetString:"Pounds,Seconds^-1"},{source:/^Kilograms? ?per ?Seconds?$/i,targetString:"Kilograms,Seconds^-1"},{source:/^Dollars? ?per ?Seconds?$/i,targetString:"Dollars,Seconds^-1"},{source:/^Dollars? ?per ?Hours?$/i,targetString:"Dollars,Hours^-1"},{source:/^Dollars? ?per ?Days?$/i,targetString:"Dollars,Days^-1"},{source:/^Dollars? ?per ?Weeks?$/i,targetString:"Dollars,Weeks^-1"},{source:/^Dollars? ?per ?Months?$/i,targetString:"Dollars,Months^-1"},{source:/^Dollars? ?per ?Quarters?$/i,targetString:"Dollars,Quarters^-1"},{source:/^Dollars? ?per ?Years?$/i,targetString:"Dollars,Years^-1"},{source:/^Euros? ?per ?Seconds?$/i,targetString:"Euros,Seconds^-1"},{source:/^Euros? ?per ?Hours?$/i,targetString:"Euros,Hours^-1"},{source:/^Euros? ?per ?Days?$/i,targetString:"Euros,Days^-1"},{source:/^Euros? ?per ?Weeks?$/i,targetString:"Euros,Weeks^-1"},{source:/^Euros? ?per ?Months?$/i,targetString:"Euros,Months^-1"},{source:/^Euros? ?per ?Quarters?$/i,targetString:"Euros,Quarters^-1"},{source:/^Euros? ?per ?Years?$/i,targetString:"Euros,Years^-1"},{source:/^Centimeters?$/i,targetString:"Meters"},{source:/^Millimeters?$/i,targetString:"Meters"},{source:/^Kilometers?$/i,targetString:"Meters"},{source:/^Inch(es)?$/i,targetString:"Meters"},{source:/^(Foot|Feet)$/i,targetString:"Meters"},{source:/^Yards?$/i,targetString:"Meters"},{source:/^Miles?$/i,targetString:"Meters"},{source:/^Acres?$/i,targetString:"Meters^2"},{source:/^Hectares?$/i,targetString:"Meters^2"},{source:/^Liters?$/i,targetString:"Meters^3"},{source:/^Gallons?$/i,targetString:"Meters^3"},{source:/^Quarts?$/i,targetString:"Meters^3"},{source:/^Fluid ?Ounces?$/i,targetString:"Meters^3"},{source:/^Years?$/i,targetString:"Seconds"},{source:/^Quarters?$/i,targetString:"Seconds"},{source:/^Months?$/i,targetString:"Seconds"},{source:/^Weeks?$/i,targetString:"Seconds"},{source:/^Days?$/i,targetString:"Seconds"},{source:/^Hours?$/i,targetString:"Seconds"},{source:/^Minutes?$/i,targetString:"Seconds"},{source:/^Kilograms?$/i,targetString:"Grams"},{source:/^Milligrams?$/i,targetString:"Grams"},{source:/^Ounces?$/i,targetString:"Grams"},{source:/^Pounds?$/i,targetString:"Grams"},{source:/^Tonnes?$/i,targetString:"Grams"},{source:/^Tons?$/i,targetString:"Grams"},{source:/^Watts?$/i,targetString:"Joules,Seconds^-1"},{source:/^Kilowatts?$/i,targetString:"Watts"},{source:/^Megawatts?$/i,targetString:"Watts"},{source:/^Gigawatts?$/i,targetString:"Watts"},{source:/^Calories?$/i,targetString:"Joules"},{source:/^Kilocalories?$/i,targetString:"Joules"},{source:/^(BTUs?|British ?Thermal ?units?)$/i,targetString:"Joules"},{source:/^Kilojoules?$/i,targetString:"Joules"},{source:/^Joules?$/i,targetString:"Newtons,Meters"},{source:/^Coulombs?$/i,targetString:"Amperes,Seconds"},{source:/^Volts?$/i,targetString:"Watts,Amperes^-1"},{source:/^Millivolts?$/i,targetString:"Volts"},{source:/^Kilovolts?$/i,targetString:"Volts"},{source:/^Newtons?$/i,targetString:"Kilograms,Meters,Seconds^-2"},{source:/^Pounds? ?Force$/i,targetString:"Pounds,Feet per Second Squared"},{source:/^Atoms?$/i,targetString:"Moles"},{source:/^Molecules?$/i,targetString:"Moles"},{source:/^Farads?$/i,targetString:"Joules,Volts^-2"},{source:/^Pascals?$/i,targetString:"Newton,Meters^-2"},{source:/^Kilopascals?$/i,targetString:"Pascals"},{source:/^Bars?$/i,targetString:"Pascals"},{source:/^Atmospheres?$/i,targetString:"Pascals"},{source:/^Pounds? ?per ?Squared? ?Inch(es)?$/i,targetString:"Pascals"}],PC=new Set(Ow.map(e=>e.targetString.toLowerCase()));function Oc(e,t){const{expected_units:n,actual_units:i}=e,o=ut(n,!0,t),s=ut(i,!0,t),r=[],a=new Set;function c(f){const m=f.replace(/s$/g,""),h=m+"s";return a.has(m)||a.has(h)?!1:s.has(m)||s.has(h)?(a.add(m),a.add(h),r.push({name:m,scale:1,target:h}),!1):!0}const l=Array.from(o).filter(f=>c(f)),d=Array.from(s).filter(f=>c(f)),p=new Set(l.concat(d));return{suggested_custom_units:r,unhandled_units:p}}function ut(e,t,n){const i=e.toLowerCase().replace(/[()]/g," ").split(/[*/]/g).map(o=>{if(o=o.trim(),o===""||o==="unitless")return;if(_k.has(o)||PC.has(o))return t?void 0:o;const s=Ow.find(a=>a.source.test(o));if(s)return t?void 0:s.targetString.toLowerCase();const r=n.find(a=>a.name.toLowerCase()===o||a.target.toLowerCase()===o);return r?t?void 0:r.target.toLowerCase():o}).filter(o=>o!==void 0);return new Set(i)}function H(e,t,n){const i={};return e.map(s=>{const r=new l1({timeStart:2020,timeLength:1,timeUnits:"Years"});n&&(r.customUnits=n);const a=fn(s.value);let c=On(s.value);c=an(c),c=Cc(c);let l=s.units;l=Mn(c,l,t),l=Cc(l||""),c=Ve(c,a);const d={name:s.name,value:c,units:l},p=r.Variable(d),{warnings:f,errors:m}=IC({model:r,model_component:p,values:i,uuids:a,wcomponents_by_id:t}),h=qw(r,s.units,p);return a.length===1&&(h.source_wcomponent_id=a[0]),f.length&&(h.warning=f.join(" ")),m.length&&(h.error&&m.unshift(h.error),h.error=m.join(`
`)),i[s.name]=h,h}).map(s=>(s.units=Ro(s.units),s.error&&(s.error=Ro(s.error)),s))}function IC(e){const{model:t,model_component:n,values:i,uuids:o,wcomponents_by_id:s}=e,r={};Object.entries(i).forEach(([p,f])=>{if(f.value!==void 0){const m=t.Variable({name:p,value:f.value,units:f.units});r[p]=m}});const a=new Date().getTime(),c=[],l=[];return o.map(p=>{const f=s[p];if(!f)return l.push(`Could not find wcomponent with id: @@${p}.  Defaulting to value of 1.`),p;const{most_probable_VAP_set_values:m,not_allowed_VAP_set_values:h}=Qn({wcomponent:f,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:a,sim_ms:a}),v=at({wcomponent:f,wcomponents_by_id:s,knowledge_views_by_id:{},wc_id_to_counterfactuals_map:void 0,created_at_ms:a,sim_ms:a})||"no title";if(f.type==="action"||h)return c.push(`The wcomponent "${v}" (@@${p}) is of type "${f.type}".  Defaulting to value of 1.`),p;if(m.length===0)return c.push(`The wcomponent "${v}" (@@${p}) is missing any value and prediction sets.  Defaulting to value of 1.`),p;let g=m[0].parsed_value;if(g===null)return c.push(`The wcomponent "${v}" (@@${p}) has an invalid number "${m[0].original_value}".  Defaulting to value of 1.`),p;if(Number.isNaN(g))return c.push(`The wcomponent "${v}" (@@${p}) has an invalid number "${m[0].original_value}".  Defaulting to value of 1.`),p;typeof g=="boolean"&&(g=g?1:0);const b=t.Variable({name:p,value:g,units:""});return r[p]=b,""}).filter(p=>p.length>0).forEach(p=>{const f=t.Variable({name:p,value:1,units:""});r[p]=f}),Object.values(r).forEach(p=>{t.Link(p,n)}),{warnings:c,errors:l}}function qw(e,t,n,i=!1){let o,s=!1,r="",a=n._node.getAttribute("Units");try{o=e.simulate()._data.data[0][n._node.id]}catch(l){const d=l;if(s=qc(d),!t&&s&&!i){a=s.actual_units,n.units=a;const p=qw(e,t,n,!0);({value:o,units:a}=p),p.error&&(r=p.error)}else r=`${d.message||"Unknown calculation error"}`}const c={value:o,error:r,units:a};if(c.error||delete c.error,s){const{suggested_custom_units:l}=Oc(s,[]);l.length>0&&(c.suggested_custom_units=l)}return c.units==="Unitless"&&(c.units=""),c}function qc(e){const t=typeof e.message=="string"&&e.message.startsWith("Wrong units generated for")&&(e.message.match(/Expected (.+?),? and got (.+?)\.(?:$| Either)/)||!1);if(!t)return!1;let n=t[1];return n==="no units"&&(n=""),{expected_units:n,actual_units:t[2]}}const RC=k.delay("perform_calculations",()=>{let e=[],t=[],n=[],i,o;k("basic functionality",()=>{e=[];const c={};n=[],t=H(e,c),u(t,n,"No calculations should return no results"),e=[{id:0,name:"A",value:"3"},{id:1,name:"B",value:"4"},{id:2,name:"C",value:"[A] + [B]"}],t=H(e,c),n=[{value:3,units:""},{value:4,units:""},{value:7,units:""}],u(t,n,"3 simple calculations should return 3 results"),e=[{id:0,name:"A",value:"3 + 1"},{id:1,name:"C",value:"[A] + [some_undeclared_variable]"},{id:2,name:"D",value:"5 + 1"}],t=H(e,c),n=[{value:3+1,units:""},{value:void 0,error:"The primitive [some_undeclared_variable] could not be found.",units:""},{value:5+1,units:""}],u(t,n,"Failure to find a value should still perform other valid calculations"),e=[{id:0,name:"A",value:"1 + 1"},{id:1,name:"A",value:"[A] * 2"},{id:2,name:"A",value:"[A] * 2"}],t=H(e,c),n=[{value:1+1,units:""},{value:4,units:""},{value:8,units:""}],u(t,n,"Can cope with self reference"),e=[{id:0,name:" A ",value:"1 + 1"},{id:1,name:"B",value:"[ A ] * 2"}],t=H(e,c),n=[{value:1+1,units:""},{value:4,units:""}],u(t,n,"Can cope with references with spaces")}),k("formatting functionality",()=>{const c={};n=[],t=H(e,c),e=[{id:0,name:"A",value:"3,000,100.200"}],t=H(e,c),n=[{value:30001002e-1,units:""}],u(t,n,"Should be able to ignore commas")});const s=_e(1),r=0;let a;k("Can use wcomponent values",()=>{a=Te(P.number,void 0,[],r),a.entries[0].value="12.3";const c=O({base_id:r,id:s,title:"Some state component",type:"statev2",values_and_prediction_sets:[a],units:"seconds"}),l={[s]:c};e=[{id:0,name:"A",value:`@@${s}`,units:"meters"}],t=H(e,l),n=[{value:12.3,units:"seconds",source_wcomponent_id:s}],u(t,n,"Can access a wcomponent's value and overrides any units given in calculation with wcomponent's units"),e=[{id:0,name:"A",value:`@@${s} * 10`,units:"meters"}],t=H(e,l),n=[{value:123,units:"meters",source_wcomponent_id:s}],u(t,n,"Can reference wcomponent values in a calculation and uses units given, overriding components units"),e=[{id:0,name:"A",value:`@@${s} * @@${s}`,units:"meters"}],t=H(e,l),n=[{value:151.29,units:"meters"}],u(t,n,"Can reference same wcomponent values in a calculation but then will not give a reference to the original wcomponent i.e. wcomponent_id will be undefined"),e=[{id:0,name:"A",value:`{@@${s} meters}`}],t=H(e,l),n=[{value:12.3,units:"meters",source_wcomponent_id:s}],u.skip(t,n,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Calculations can reference wcomponent values and assign units~~"),e=[{id:0,name:"A",value:`@@${s}.value`,units:"meters"}],t=H(e,l),n=[{value:void 0,units:"meters",source_wcomponent_id:s,error:"Object function not used on object"}],u(t,n,'Can not currently access the ".value" of a component in an equation')}),k("Can use wcomponent boolean values",()=>{a=Te(P.boolean,void 0,[],r),u(a.entries[1].value_id,he.boolean_false,"Test is setting the correct VAP set entry"),a.entries[1].probability=1;const c={[s]:O({base_id:r,id:s,type:"statev2",subtype:"boolean",values_and_prediction_sets:[a]})};e=[{id:0,name:"A",value:`IfThenElse(@@${s}, 15, 10)`}],t=H(e,c),n=[{value:10,units:"",source_wcomponent_id:s}],u(t,n,"Can use wcomponent boolean values")}),k("Can use values with units",()=>{e=[{id:0,name:"A",value:"{2 Meters} + {10 Centimeters}",units:"Meters"}],t=H(e,{}),n=[{value:2.1,units:"Meters"}],u(t,n,"Computes correct value and includes units in result")}),k("Can use values without units being initially defined",()=>{e=[{id:0,name:"A",value:"{2 Meters}"}],t=H(e,{}),n=[{value:2,units:"Meters"}],u(t,n,"Computes correct units")}),k("Can use values with units initially being undefined",()=>{e=[{id:0,name:"A",value:"{2 Meters}",units:void 0}],t=H(e,{}),n=[{value:2,units:"Meters"}],u(t,n,"Computes correct units")}),k("Does not compute units if some are already specified",()=>{e=[{id:0,name:"A",value:"{2 Meters}",units:"kg"}],t=H(e,{}),n=[{value:void 0,units:"kg",error:"Wrong units generated for [A]. Expected Kg, and got Meters."}],u(t,n,"Computes correct units")}),k("Handling custom and missing puralisation of units",()=>{e=[{id:0,name:"number of days per person",value:"1",units:"days / person"},{id:1,name:"number of seconds per person",value:"[number of days per person]",units:"seconds / person"}],t=H(e,{}),n=[{value:1,units:"days / person"},{value:86400,units:"seconds / person"}],u(t,n,"Forces conversion of units"),e=[{id:0,name:"trades people",value:"180,000",units:"people"},{id:1,name:"people days per home",value:"30",units:"people * days / home"},{id:2,name:"days per year",value:"250",units:"days / year"},{id:3,name:"",value:"([trades people] * [days per year]) / [people days per home]",units:"Home / Year"}],t=H(e,{}).slice(-1),n=[{value:15e5,units:"Home / Year"}],u(t,n,"Computes correct units"),e=[{id:0,name:"trades people",value:"180,000",units:"people"},{id:1,name:"people days per home",value:"30",units:"people * days / home"},{id:2,name:"days per year",value:"250",units:"days / year"},{id:3,name:"",value:"([trades people] * [days per year]) / [people days per home]",units:"Homes / Year"}];let c=[];i=H(e,{},c).pop(),o={error:"Wrong units generated for [New Variable]. Expected Homes/(Year), and got Home/(Seconds).",units:"Homes / Year",suggested_custom_units:[{name:"home",scale:1,target:"homes"}],value:void 0},u(i,o,"Will fail to handle custom units when not given"),c=[{name:"Homes",scale:1,target:"Home"}],i=H(e,{},c).pop(),o={value:15e5,units:"Homes / Year"},u(i,o,"Can set custom units in either order, test 1"),c=[{name:"Home",scale:1,target:"Homes"}],i=H(e,{},c).pop(),o={value:15e5,units:"Homes / Year"},u(i,o,"Can set custom units in either order, test 2"),c=[{name:"HoMe",scale:1,target:"hOmEs"}],i=H(e,{},c).pop(),o={value:15e5,units:"Homes / Year"},u(i,o,"Can set custom units with mixed case"),e=[{id:0,name:"trades people",value:"180,000",units:"people"},{id:1,name:"people days per home",value:"30",units:"people * days / home"},{id:2,name:"days per year",value:"250",units:"days / year"},{id:3,name:"",value:"([trades people] * [days per year]) / [people days per home]",units:"UK Dwellings / Year"}],c=[{name:"home",scale:1,target:"homes"},{name:"UK Dwellings",scale:1,target:"homes"}],i=H(e,{},c).pop(),o={value:15e5,units:"UK Dwellings / Year"},u(i,o,"Can handle custom units with spaces in them")}),k(`Sets units to "" if 'Unitless' is specified`,()=>{e=[{id:0,name:"A",value:"2",units:"Unitless"}],t=H(e,{}),n=[{value:2,units:""}],u(t,n,'Computes correct units of "" when "Unitless" is specified'),e=[{id:0,name:"A",value:"{2 Meters}",units:"Unitless"}],t=H(e,{}),n=[{value:void 0,units:"",error:"Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."}],u(t,n,'Computes correct units of "" when "Unitless" is specified as the units even though it conflicts with units given in calculation')}),k("Can process numbers with thousands comma seperators",()=>{e=[{id:0,name:"A",value:"1,200,300e4 / {4,001,000e3 km}",units:"1/km"}],t=H(e,{}),n=[{value:3,units:"1/km"}],u(t,n,"Can compute numbers with thousands commas")}),k("Can process numbers with compound units",()=>{e=[{id:0,name:"A",value:"{7 Widgets/Years^2}*{10 Years}",units:"Widgets/Years"}],t=H(e,{}),n=[{value:70,units:"Widgets/Years"}],u(t,n,"Widgets/Years^2  *  Years")}),k("hide_currency_symbols",()=>{e=[{id:0,name:"A",value:"{90 £ / year}",units:""},{id:1,name:"B",value:"{10 £ / year}",units:""},{id:2,name:"C",value:"[A]+[B]",units:""}],t=H(e,{}),n=[{value:90,units:"£/(Year)"},{value:10,units:"£/(Year)"},{value:100,units:"£/(Year)"}],u(t,n,"Handles currency symbols specified inside curly braces"),e=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"£ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],t=H(e,{}),n=[{value:90,units:"£ / year"},{value:10,units:"£ / year"},{value:100,units:"£ / year"}],u(t,n,"Handles currency symbols specified inside units field, and preserves them precisely"),e=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"$ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],t=H(e,{}),n=[{value:90,units:"£ / year"},{value:10,units:"$ / year"},{value:void 0,units:"£ / year",error:"Incompatible units for the addition of £/(Year) and $/(Year)."}],u(t,n,"Correctly formats currency symbols in error messages")}),k("Handles reserved words correctly",()=>{e=[{id:0,name:"A",value:"0.5 * (180 / Pi)"}],t=H(e,{}),n=[{value:28.6478897565412,units:""}],u(t,n,'Can run calculations using reserved word "Pi"')}),k("Defaults to 1 for missing or invalid or incomplete components",()=>{e=[{id:0,name:"A",value:`1 + @@${s}`}],k("Missing component",()=>{n=[{value:2,units:"",source_wcomponent_id:s,error:`Could not find wcomponent with id: @@${s}.  Defaulting to value of 1.`}],t=H(e,{}),u(t,n,"Can run calculations using missing uuids.  Will default to 1 and provide a warning.")}),k("Invalid component: action type",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) is of type "action".  Defaulting to value of 1.`}];const c={[s]:O({base_id:r,id:s,type:"action",values_and_prediction_sets:[]})};t=H(e,c),u(t,n,"Can run calculations using actions.  Will default to 1 and provide a warning.")}),k("Invalid component: statev2 with subtype number but invalid number parsed to null",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) has an invalid number "".  Defaulting to value of 1.`}],a=Te(P.number,void 0,[],r),a.entries[0].value="";const c={[s]:O({base_id:r,id:s,type:"statev2",subtype:"number",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 with invalid number of null.  Will default to 1 and provide a warning.")}),k("Invalid component: statev2 with subtype number but invalid number parsed to NaN",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) has an invalid number "some invalid number".  Defaulting to value of 1.`}],a=Te(P.number,void 0,[],r),a.entries[0].value="some invalid number";const c={[s]:O({base_id:r,id:s,type:"statev2",subtype:"number",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 with invalid number of NaN.  Will default to 1 and provide a warning.")}),k("Incomplete component: statev2 type with no VAP sets",()=>{n=[{value:2,units:"",source_wcomponent_id:s,warning:`The wcomponent "no title" (@@${s}) is missing any value and prediction sets.  Defaulting to value of 1.`}];const c={[s]:O({base_id:r,id:s,type:"statev2",values_and_prediction_sets:[]})};t=H(e,c),u(t,n,"Can run calculations using statev2 with no VAPsets.  Will default to 1 and provide a warning.")})}),k("Coerces statev2 wcomponents with boolean subtype into 0 or 1",()=>{e=[{id:0,name:"A",value:`1 + @@${s}`}],k("coerces true to 1",()=>{n=[{value:2,units:"",source_wcomponent_id:s}],a=Te(P.boolean,void 0,[],r),u(a.entries[0].value_id,he.boolean_true,"Test is setting the correct VAP set entry"),a.entries[0].probability=1;const c={[s]:O({base_id:r,id:s,type:"statev2",subtype:"boolean",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 boolean subtypes.  Will coerce true to 1 and not provide a warning.")}),k("coerces false to 0",()=>{n=[{value:1,units:"",source_wcomponent_id:s}],a=Te(P.boolean,void 0,[],r),u(a.entries[1].value_id,he.boolean_false,"Test is setting the correct VAP set entry"),a.entries[1].probability=1;const c={[s]:O({base_id:r,id:s,type:"statev2",subtype:"boolean",values_and_prediction_sets:[a]})};t=H(e,c),u(t,n,"Can run calculations using statev2 boolean subtypes.  Will coerce false to 0 and not provide a warning.")})})}),DC=k.delay("error_is_units_error",()=>{let e=new Error("Wrong units generated for [New Variable]. Expected Homes/(Year), and got Home/(Seconds)."),t=qc(e),n={expected_units:"Homes/(Year)",actual_units:"Home/(Seconds)"};u(t,n,"Handles units error correctly"),e=new Error("Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."),t=qc(e),n={expected_units:"",actual_units:"Meters"},u(t,n,"Handles unitless error correctly")}),MC=k.delay("extract_units",()=>{const e="thing * kg * kg * meters / (second)";let t=ut(e,!1,[]),n=new Set(["thing","kg","meters","seconds"]);u(t,n,"Extracts units from a string"),t=ut(e,!0,[]),n=new Set(["thing","kg"]),u(t,n,"Ignores known units"),t=ut(e,!1,[{name:"kg",scale:1,target:"kilograms"}]),n=new Set(["thing","kilograms","meters","seconds"]),u(t,n,"Converts known custom units"),t=ut(e,!0,[{name:"kg",scale:1,target:"kilograms"}]),n=new Set(["thing"]),u(t,n,"Ignores known units and known custom units"),t=ut(e,!1,[{name:"KG",scale:1,target:"KILOGRAMS"}]),n=new Set(["thing","kilograms","meters","seconds"]),u(t,n,"Custom units with uppercase names are handled correctly"),t=ut(e.toUpperCase(),!1,[{name:"kg",scale:1,target:"kilograms"}]),n=new Set(["thing","kilograms","meters","seconds"]),u(t,n,"Units string units with uppercase names are handled correctly"),t=ut(e,!0,[{name:"kg",scale:1,target:"thing"}]),n=new Set([]),u(t,n,"Units that are custom unit targets are ignored"),t=ut("unitless",!1,[]),n=new Set([]),u(t,n,"unitless is ignored"),t=ut("",!1,[]),n=new Set([]),u(t,n,"no units are ignored")}),OC=k.delay("suggest_missing_units",()=>{const e={expected_units:"niedźwiedz * Bear * Homes/Day",actual_units:"home * bears/(seconds)"};let t=[],n=Oc(e,t),i={suggested_custom_units:[{name:"bear",scale:1,target:"bears"},{name:"home",scale:1,target:"homes"}],unhandled_units:new Set(["niedźwiedz"])};u(n,i,"Suggests custom units"),t=[{name:"bear",scale:1,target:"bears"},{name:"niedźwiedz",scale:1,target:"bears"}],n=Oc(e,t),i={suggested_custom_units:[{name:"home",scale:1,target:"homes"}],unhandled_units:new Set},u(n,i,"Suggests custom units whilst ignoring known custom units")}),De={_0:0,_5:.08726646259971647,_10:.17453292519943295,_15:.2617993877991494,_20:.3490658503988659,_25:.4363323129985824,_30:.5235987755982988,_35:.6108652381980153,_40:.6981317007977318,_45:.7853981633974483,_50:.8726646259971648,_55:.9599310885968813,_60:1.0471975511965976,_65:1.1344640137963142,_70:1.2217304763960306,_75:1.3089969389957472,_80:1.3962634015954636,_85:1.48352986419518,_90:1.5707963267948966,_95:1.6580627893946132,_100:1.7453292519943295,_105:1.8325957145940461,_110:1.9198621771937625,_115:2.007128639793479,_120:2.0943951023931953,_125:2.1816615649929116,_130:2.2689280275926285,_135:2.356194490192345,_140:2.443460952792061,_145:2.530727415391778,_150:2.6179938779914944,_155:2.705260340591211,_160:2.792526803190927,_165:2.8797932657906435,_170:2.96705972839036,_175:3.0543261909900767,_180:3.141592653589793,_185:3.2288591161895095,_190:3.3161255787892263,_195:3.4033920413889422,_200:3.490658503988659,_205:3.5779249665883754,_210:3.6651914291880923,_215:3.752457891787808,_220:3.839724354387525,_225:3.9269908169872414,_230:4.014257279586958,_235:4.101523742186674,_240:4.1887902047863905,_245:4.276056667386108,_250:4.363323129985823,_255:4.4505895925855405,_260:4.537856055185257,_265:4.625122517784973,_270:4.71238898038469,_275:4.799655442984406,_280:4.886921905584122,_285:4.974188368183839,_290:5.061454830783556,_295:5.148721293383272,_300:5.235987755982989,_305:5.323254218582705,_310:5.410520681182422,_315:5.497787143782138,_320:5.585053606381854,_325:5.672320068981571,_330:5.759586531581287,_335:5.846852994181004,_340:5.93411945678072,_345:6.021385919380437,_350:6.1086523819801535,_355:6.19591884457987};function Co(e,t,n,i){const o=i-t,s=n-e;return Math.atan2(o,s)}const uu=Math.PI*2;function qC(e){return e+uu*Math.floor((Math.PI-e)/uu)}function VC(e,t){const n=Vw[t];return e+=1e-4,Fw({connection_angle:e,angle_of_normal_to_connector_surface:n,offset_direction:-1})}function FC(e,t){const n=Vw[t];return e+=Math.PI,Fw({connection_angle:e,angle_of_normal_to_connector_surface:n,offset_direction:1})}const pu={left:De._180,top:De._90,right:0,bottom:-De._90},Vw={right:pu.right,left:pu.left},ho=De._50;function Fw(e){const t=qC(e.connection_angle-e.angle_of_normal_to_connector_surface),i=Le(t,-ho,ho);return Le(i,-ho,ho)+e.angle_of_normal_to_connector_surface}const zC=k.skip("get_angle (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{const n=[{ex:10,ey:0},{ex:10,ey:-10},{ex:0,ey:-10},{ex:-10,ey:-10},{ex:-10,ey:0},{ex:-10,ey:10},{ex:0,ey:10},{ex:10,ey:10}],i=["0.00","-0.79","-1.57","-2.36","3.14","2.36","1.57","0.79"];n.forEach(({ex:r,ey:a},c)=>{const l=Co(0,0,r,a).toFixed(2);u(l,i[c])});const o=["-0.79","-0.87","-0.87","-0.87","0.09","0.09","0.09","0.00"];n.forEach(({ex:r,ey:a},c)=>{const l=Co(0,0,r,a),d=VC(l,"right").toFixed(2);u(d,o[c])});const s=["3.93","3.14","3.05","3.05","4.01","4.01","4.01","4.01"];n.forEach(({ex:r,ey:a},c)=>{const l=Co(0,0,r,a),d=FC(l,"left").toFixed(2);u(d,s[c])})});function Ge(e,t){if(e===0)return 0;const n=Math.pow(10,t-Math.floor(Math.log10(Math.abs(e)))-1);return Math.round(e*n)/n}function Vt(e,t){const n=t*Math.cos(e),i=t*Math.sin(e);return{x:n,y:i}}function Un(e,t){return{x:e.x+t.x,y:e.y+t.y}}var Ft=(e=>(e[e.positive=0]="positive",e[e.negative=1]="negative",e[e.noop=2]="noop",e))(Ft||{});function LC(e){const{type:t,x:n,y:i,end_angle:o,opacity:s,blur:r,size:a,is_hovered:c,is_highlighted:l}=e;let d=`${l?"highlighted":""} ${c?"hovered":""}`;const p=s*(1-r/100),f={fillOpacity:p};let m;t===0?m=UC(o,a):t===1?m=GC(o,a):(f.fillOpacity=0,f.strokeOpacity=p,m=YC(o),d+=" noop_end ");const h=BC({x:n,y:i},m);return _("polygon",{className:"connection_end "+d,points:h,style:f})}function BC(e,t){const{x:n,y:i}=e;let o=`${n}, ${-i} `;return t.forEach(s=>o+=`${n+s.x}, ${-i-s.y} `),o}function UC(e,t){const n=mu(e,1,t),i=mu(e,-1,t);return[n,i]}const WC=De._25;function mu(e,t,n){return Vt(e+t*WC,n)}const zw=12,HC=zw/2,Vc=4;function GC(e,t){t=t/10;const n=Vt(e+De._90,HC*t),i=Un(Vt(e,Vc*t),n),o=Un(Vt(e-De._90,zw*t),i),s=Un(Vt(e-De._180,Vc*t),o);return[n,i,o,s]}const Ai=9,KC=Math.sin(De._45)*Ai*2;function YC(e){const t=Vt(e+De._315,Ai),n=Un(Vt(e+De._45,Ai),t),i=Un(Vt(e+De._135,Ai),n),o=Un(Vt(e+De._225,Ai),i);return[t,n,i,o]}const JC=12,Vo=JC/2,XC=-6,ZC=27;let Lw=22;try{navigator.platform.indexOf("Win")>-1&&(Lw=17)}catch{}const QC={meta:0,validity:1,state:2};function Bw(e,t=1){const n=QC[e.attribute],i=t**1.14,o=(ZC+n*Lw)*i;return{left:XC+(e.side==="right"?Ce:0)*t,top:o}}function Fo(e){const{kv_wc_entry:t,wcomponent_type:n,connection_terminal_type:i}=e;if(Gn(n))return t;const s=t.s||1;let{left:r,top:a}=Bw(i,s);return r+=t.left+Vo,a+=t.top+Vo,{left:r,top:a}}const e7=45,fu=e=>{let t=0;if(Gn(e.wcomponent_type))t=0;else{const{s:n=1}=e.kv_wc_entry;t=Ce*n}return t+e7},t7=30,Rs=30,hu=150;function Ie(e){e.end_size===0&&((e.console_warn||console.warn)(`Invalid connection end_size "${e.end_size}", defaulting to 1`),e.end_size=1);const{connection_from_component:t,connection_to_component:n,line_behaviour:i,circular_links:o,end_size:s,connection_end_type:r}=e;if(!t||!n)return i7(e);if(i===Hn.angular)return o7({connection_from_component:t,connection_to_component:n,end_size:s,connection_end_type:r});const{offset_line_start_y:a,offset_connection_start_y:c,invert_end_angle:l,circular_link_from_below_to:d}=n7({circular_links:o,connection_from_component:t,connection_to_component:n}),p=Fo(t),f=p.left,m=-p.top+a,h=Fo(n),v=h.left,g=-h.top+c;let b=1,w=1;d!==void 0&&(f<v?d?b=-1:w=-1:d?w=-1:b=-1);let x={x:0,y:0},y=x,C=Co(f,m,v,g)+De._180;if(i===void 0||i===Hn.curve){const A=(v-f)/2,M=Math.max(Math.abs(A),Rs)*(Math.sign(A)||-1);let D=M*b,T=-M*w,L=0,ne=0;const Ue=v<=f;if(!o&&Ue){const Xe=g-m;D=Math.min(-D,300),T=Math.max(-T,-300),L=Xe||-Rs,ne=-Xe||-Rs}C=l?0:De._180,x={x:D,y:L},y={x:T,y:ne}}const{line_end_x:E,line_end_y:N}=Uw({connection_end_type:r,end_size:s,end_angle:C,connection_end_x:v,connection_end_y:g});return{line_start_x:f,line_start_y:m,relative_control_point1:x,relative_control_point2:y,line_end_x:E,line_end_y:N,connection_end_x:v,connection_end_y:g,end_angle:C}}function n7(e){const t={offset_line_start_y:0,offset_connection_start_y:0,invert_end_angle:!1,circular_link_from_below_to:void 0};if(!e.circular_links)return t;const{connection_from_component:n,connection_to_component:i}=e,o=Gn(n.wcomponent_type),s=Gn(i.wcomponent_type);let r=o||s?0:t7;return n.kv_wc_entry.left<i.kv_wc_entry.left-fu(n)||(i.kv_wc_entry.left<n.kv_wc_entry.left-fu(i)?(t.offset_line_start_y=r,t.offset_connection_start_y=r,i.connection_terminal_type={...i.connection_terminal_type,side:"right"},n.connection_terminal_type={...n.connection_terminal_type,side:"left"},t.invert_end_angle=!0):(t.circular_link_from_below_to=i.kv_wc_entry.top<n.kv_wc_entry.top,t.circular_link_from_below_to?(n.connection_terminal_type={...n.connection_terminal_type,side:"left"},t.offset_line_start_y=r):(i.connection_terminal_type={...i.connection_terminal_type,side:"right"},t.offset_connection_start_y=r,t.invert_end_angle=!0))),t}function i7(e){const{connection_from_component:t,connection_to_component:n,end_size:i,connection_end_type:o}=e;let s=0;const r={x:0,y:0},a=r;let c;if(t)s=t.kv_wc_entry.left+Ce,c=Fo(t);else{if(!n)return null;s=n.kv_wc_entry.left-hu,c=Fo(n)}const l=-c.top,d=s+hu,p=l,f=De._180,{line_end_x:m,line_end_y:h}=Uw({connection_end_type:o,end_size:i,end_angle:f,connection_end_x:d,connection_end_y:p});return{line_start_x:s,line_start_y:l,relative_control_point1:r,relative_control_point2:a,line_end_x:m,line_end_y:h,connection_end_x:d,connection_end_y:p,end_angle:f}}function Uw(e){const{connection_end_type:t,end_angle:n,connection_end_x:i,connection_end_y:o}=e,s=e.end_size/10,r=t===Ft.negative?Vc*s:t===Ft.noop?KC:9*s,a=i+Math.cos(n)*r,c=o+Math.sin(n)*r;return{line_end_x:a,line_end_y:c}}function o7(e){const{connection_from_component:t,connection_to_component:n}=e,i=80,o=0,s=t.kv_wc_entry,r=n.kv_wc_entry;let a=s.left,c=-s.top,l=r.left,d=-r.top;Gn(t.wcomponent_type)||(a+=Xn*(s.s||1),c-=i*(s.s||1)),Gn(n.wcomponent_type)||(l+=Xn*(r.s||1),d+=o);const p=3.142/2;return{line_start_x:a,line_start_y:c,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:l,line_end_y:d,connection_end_x:l,connection_end_y:d,end_angle:p}}function s7(e){const t=vu(e.point1,e.relative_control_point1),n=vu(e.point2,e.relative_control_point2),i=In(e.point1,t),o=In(t,n),s=In(n,e.point2),r=In(i,o),a=In(o,s);return In(r,a)}function vu(e,t){return{x:e.x+t.x,y:e.y+t.y}}function In(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}const r7=k.delay("derive_connection_coords",()=>{let e,t;k("connection between two nodes",()=>{e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ce+100},t=Ie(e),u(Qe(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:349,line_end_y:-77,connection_end_x:350,connection_end_y:-77,end_angle:3.142},`two nodes not overlapping horizontally
                    [from]----->[to]`),e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ce+10},t=Ie(e),u(Qe(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:130,y:0},relative_control_point2:{x:130,y:0},line_end_x:511,line_end_y:-47,connection_end_x:510,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other:
                    [from] [to]`),e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ce-10},t=Ie(e),u(Qe(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:120,y:0},relative_control_point2:{x:120,y:0},line_end_x:491,line_end_y:-47,connection_end_x:490,connection_end_y:-47,end_angle:0},`two nodes overlapping horizontally
                    [fr.[to]`),e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:-10},t=Ie(e),u(Qe(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:241,line_end_y:-47,connection_end_x:240,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other in the other direction
                    [to] [from]`),e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:-50},t=Ie(e),u(Qe(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:201,line_end_y:-47,connection_end_x:200,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally and far from each other in the other direction
                    [to]<-----[from]`),k("of different sizes",()=>{e=He();const i=2,o=Ce*i,s=Ce+110,a=Ce*1;e.connection_from_component.kv_wc_entry={top:0,left:0,s:i},e.connection_to_component.kv_wc_entry={top:0,left:s},t=Ie(e),u(Qe(t),{line_start_x:o,line_start_y:-160,relative_control_point1:{x:55,y:0},relative_control_point2:{x:55,y:0},line_end_x:s+a+1,line_end_y:-47,connection_end_x:s+a,connection_end_y:-47,end_angle:0},`two nodes that if of same size would not overlap horizontally,
                        [from]----->[to]
                but one is bigger so they do overlap
                        [F R O M]
                             [to ]
            `)})}),e=He(),e.connection_to_component=e.connection_from_component,t=Ie(e),u(Qe(t),{line_start_x:Ce,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:Ce+1,line_end_y:-47,connection_end_x:Ce,connection_end_y:-47,end_angle:0},"connection from a node back to itself"),e=He(),e.end_size=0;let n=[];e.console_warn=(...i)=>n=i,Ie(e),u(n,['Invalid connection end_size "0", defaulting to 1'],"Should log a warning message about invalid end_size: 0,"),k("connection between nothing and a node",()=>{e=He(),e.connection_from_component=void 0,e.connection_to_component.kv_wc_entry={top:0,left:0},t=Ie(e),u(Qe(t),{line_start_x:-150,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"straight line from nothing to one node"),e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component=void 0,t=Ie(e),u(Qe(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:399,line_end_y:-77,connection_end_x:400,connection_end_y:-77,end_angle:3.142},"straight line from one node to nothing")}),k("connection between a node and a connection",()=>{e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component={kv_wc_entry:{top:0,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},t=Ie(e),u(Qe(t),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:0,connection_end_x:-100,connection_end_y:0,end_angle:0},"connect from one node to a second connection"),e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},t=Ie(e),u(Qe(t),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:200,connection_end_x:-100,connection_end_y:200,end_angle:0},"connect from one node to a second connection above and left"),e=He(),e.connection_from_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"right",attribute:"state"}},e.connection_to_component.kv_wc_entry={top:0,left:0},t=Ie(e),u(Qe(t),{line_start_x:-100,line_start_y:200,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"connect from a second connection above and left to a node")}),k("angular connections",()=>{e=He(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_from_component.wcomponent_type="causal_link",e.connection_to_component.kv_wc_entry={top:200,left:100},e.line_behaviour=Hn.angular,t=Ie(e),u(Qe(t),{line_start_x:0,line_start_y:0,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:100+Xn,line_end_y:-200,connection_end_x:100+Xn,connection_end_y:-200,end_angle:3.142/2},"connect from a connection above to a node below")})});function He(){return{connection_from_component:{kv_wc_entry:{top:0,left:0},wcomponent_type:"statev2",connection_terminal_type:{side:"right",attribute:"state"}},connection_to_component:{kv_wc_entry:{top:0,left:Ce+100},wcomponent_type:"statev2",connection_terminal_type:{side:"left",attribute:"state"}},line_behaviour:void 0,circular_links:!0,end_size:1,connection_end_type:Ft.positive}}function Qe(e){return e?{line_start_x:Ge(e.line_start_x,2),line_start_y:Ge(e.line_start_y,2),relative_control_point1:{x:Ge(e.relative_control_point1.x,2),y:Ge(e.relative_control_point1.y,2)},relative_control_point2:{x:Ge(e.relative_control_point2.x,2),y:Ge(e.relative_control_point2.y,2)},line_end_x:Ge(e.line_end_x,3),line_end_y:Ge(e.line_end_y,3),connection_end_x:Ge(e.connection_end_x,3),connection_end_y:Ge(e.connection_end_y,3),end_angle:Ge(e.end_angle,4)}:null}function F(e){return _(W0,{xsUp:e.is_hidden,children:_(je,{className:e.className,title:e.title,color:e.color||"primary",style:{...e.style,pointerEvents:"initial"},disabled:e.disabled||!1,disableElevation:e.disableElevation||!0,disableFocusRipple:e.disableFocusRipple||!1,endIcon:e.endIcon,fullWidth:e.fullWidth||!1,href:e.href,size:e.size||"small",startIcon:e.startIcon,variant:e.variant||"contained",onPointerDown:t=>{t.currentTarget.focus(),t.stopImmediatePropagation(),t.preventDefault(),e.onPointerDown&&e.onPointerDown(t)},onClick:t=>{t.currentTarget.focus(),t.stopImmediatePropagation(),t.preventDefault(),e.onClick&&e.onClick(t)},children:e.children||e.value})})}function _7(e,t){for(;e;){const{classList:n}=e;if(n&&n.contains(t))break;e=e.parentElement}return e}function a7(e,t){for(;e;){const{classList:n}=e;if(n&&t.find(i=>n.contains(i)))break;e=e.parentElement}return e}const c7=e=>({presenting:e.display_options.consumption_formatting}),l7=j(c7);function d7(e){const t=m7(e),[n,i]=I(!1),o=t?"":"no_entry",{on_change:s}=e;if(!s)return _("div",{className:o,children:t});const{invariant_value:r,show_now_shortcut_button:a=!1,show_today_shortcut_button:c=!0}=e,l=gu(t),d=e.editing_allowed!==void 0?!e.editing_allowed:e.presenting,p=`editable_field ${l?"":"invalid"} ${o} ${d?"not_editable":""}`,f=(e.title||"DateTime")+(e.invariant_value&&e.value?" (custom)":"");function m(g){s&&p7(e.value,g)&&s(g)}const h=Ee(void 0),v=Ee(m);return v.current=m,oe(()=>()=>{if(!h.current||!(document.activeElement===h.current))return;const b=zo({working_value:h.current.value,invariant_value:r});v.current(b)},[]),_("div",{className:p,title:f,children:[_(kn,{disabled:d,type:"text",label:f,value:t,onFocus:()=>i(!0),inputRef:g=>{if(!g||(h.current=g,!n))return;const b=Ww(e),w=Ln({date:b,trim_midnight:!1});g.value=w,g.setSelectionRange(0,g.value.length)},onKeyDown:g=>{const b=g.key==="Enter",w=g.key==="Escape";(b||w)&&g.currentTarget.blur()},onChange:g=>{const b=gu(g.currentTarget.value),w=_7(g.currentTarget,"editable_field");w&&(b?w.classList.remove("invalid"):w.classList.add("invalid"))},onBlur:g=>{const b=g.currentTarget.value,w=zo({working_value:b,invariant_value:r});m(w),i(!1)},size:"small",variant:"outlined",fullWidth:!0}),n&&a&&_(u7,{on_change:m}),n&&c&&_(F,{value:"Today",onPointerDown:()=>{const g=Ko();m(new Date(g))}})]})}const xt=l7(d7);function gu(e){if(!e.trim())return!0;const t=ji(e);return!!t&&Yc(t)}function u7(e){return _(F,{value:"Now",onClick:()=>{const t=new Date(new Date().getTime()+3e4),n=Zt(t,"yyyy-MM-dd hh:mm");e.on_change(new Date(n))}})}function Ww(e){return e.value||e.invariant_value}function p7(e,t){const n=e==null?void 0:e.getTime(),i=t==null?void 0:t.getTime();return n!==i}function m7(e){const t=Ww(e);return Ln({date:t})}function zo(e){const{working_value:t,invariant_value:n}=e;let i=ji(t);return i&&i.getTime()===(n&&n.getTime())&&(i=void 0),i}const f7=k.delay("handle_on_blur",()=>{let e,t,n;e=void 0,t="2020-01-01",n=zo({invariant_value:e,working_value:t}),u(n==null?void 0:n.getTime(),new Date("2020-01-01T00:00:00.000Z").getTime()),e=void 0,t="2021-04-25 08:37",n=zo({invariant_value:e,working_value:t}),u(n==null?void 0:n.getTime(),new Date("2021-04-25T07:37:00.000Z").getTime())});function Hw(e){const{knowledge_views_by_id:t,wcomponents_by_id:n}=e,i=h7(e),o=new Set(i.map(c=>c.id)),s=v7({kv_ids_to_move:o,knowledge_views_by_id:t}),{wc_ids_to_move:r,wcomponents_move_conflicts:a}=g7({knowledge_views_to_move:i,knowledge_views_to_keep:s,wcomponents_by_id:n});return{kv_ids_to_move:o,wc_ids_to_move:r,wcomponents_move_conflicts:a}}function h7(e){const t=[],n=new Set,i=[e.root_knowledge_view_id_to_move];for(;i.length;){const o=i.pop();if(!o)break;if(n.has(o))continue;const s=e.knowledge_views_by_id[o],r=e.nested_knowledge_view_ids_map[o];if(!r||!s){console.error(`kv of id: "${o}" kv is "${s?"present":"absent"}" but nested kv map entry is "${r?"present":"absent"}"`);continue}t.push(s),n.add(o),r.child_ids.forEach(a=>i.push(a))}return t}function v7(e){return Object.values(e.knowledge_views_by_id).filter(t=>!e.kv_ids_to_move.has(t.id))}function g7(e){const t={};e.knowledge_views_to_keep.forEach(r=>{Object.entries(r.wc_id_map).forEach(([a,c])=>{if(c.blocked||c.passthrough)return;const l=t[a]||[];l.push({kv_id:r.id,left:c.left,top:c.top}),t[a]=l})});const n=new Set(e.knowledge_views_to_keep.map(r=>r.id)),i=new Set(e.knowledge_views_to_move.map(r=>r.id)),o=new Set,s={};return e.knowledge_views_to_move.forEach(r=>Object.entries(r.wc_id_map).forEach(([a,c])=>{if(c.blocked||c.passthrough||!e.wcomponents_by_id[a]||n.has(a))return;const l=t[a],d=i.has(a);l&&!d?s[a]=l:o.add(a)})),{wc_ids_to_move:o,wcomponents_move_conflicts:s}}const w7=k.delay("calc_ids_to_move_and_conflicts",()=>{const t=Fe({id:"uuid A",base_id:1,title:"A"}),n=Fe({id:"uuid B",base_id:1,title:"B",parent_knowledge_view_id:t.id}),i=Fe({id:"uuid C",base_id:1,title:"C",parent_knowledge_view_id:n.id}),o=Fe({id:"uuid I",base_id:1,title:"I",parent_knowledge_view_id:n.id}),s=Fe({id:"uuid J",base_id:1,title:"J",parent_knowledge_view_id:t.id}),r=[t,n,i,o,s],a={};r.forEach($=>a[$.id]=$);const c={},l=$=>(c[$.id]=$,$),d=l(O({base_id:1,title:t.title,id:t.id})),p=l(O({base_id:1,title:n.title,id:n.id})),f=l(O({base_id:1,title:i.title,id:i.id})),m=l(O({base_id:1,title:o.title,id:o.id})),h=l(O({base_id:1,title:s.title,id:s.id})),v=l(O({id:"uuid E",base_id:1,title:"E"})),g=l(O({id:"uuid F",base_id:1,title:"F"})),b=l(O({id:"uuid G",base_id:1,title:"G"})),w=l(O({id:"uuid H",base_id:1,title:"H"}));t.wc_id_map[d.id]={left:0,top:0},t.wc_id_map[p.id]={left:0,top:0},t.wc_id_map[v.id]={left:0,top:0},t.wc_id_map[g.id]={left:0,top:0},t.wc_id_map[m.id]={left:0,top:0},t.wc_id_map[h.id]={left:0,top:0},n.wc_id_map[p.id]={left:0,top:0},n.wc_id_map[f.id]={left:0,top:0},n.wc_id_map[v.id]={left:0,top:0},n.wc_id_map[b.id]={left:0,top:0},n.wc_id_map[m.id]={left:0,top:0},i.wc_id_map[f.id]={left:0,top:0},i.wc_id_map[g.id]={left:0,top:0},i.wc_id_map[w.id]={left:0,top:0},i.wc_id_map[h.id]={left:0,top:0},o.wc_id_map[m.id]={left:0,top:0},s.wc_id_map[h.id]={left:0,top:0};const x=Gv(r,1).map,y=Hw({root_knowledge_view_id_to_move:n.id,nested_knowledge_view_ids_map:x,knowledge_views_by_id:a,wcomponents_by_id:c});u(y.kv_ids_to_move,new Set([n.id,i.id,o.id])),u(y.wc_ids_to_move,new Set([p.id,f.id,m.id,b.id,w.id])),u(Object.keys(y.wcomponents_move_conflicts),[v.id,g.id])});function ve(e,t){if(e===0)return"0";const n=Math.floor(Math.log10(Math.abs(e))),i=n+1-t,s=(Math.round(e/Math.pow(10,i))*Math.pow(10,i)).toString();if(i>=0)return s;{const a=s.indexOf(".")!==-1;let c=s+(a?"":".");const l=(Math.abs(e)>=1?c.length:c.length+n)-1-(e<0?1:0);let d=t-l;d=Math.max(0,d),c+="0".repeat(d);const p=t+(n<0?-n:0)+1+(e<0?1:0);return c=c.slice(0,p),c}}const b7=k.delay("run_number_to_significant_figures",()=>{let e="";e=ve(0,2),u(e,"0","Zero"),k("Positive numbers",()=>{e=ve(27e5,2),u(e,"2700000","2.7 million to 2 sf"),e=ve(27e6,2),u(e,"27000000","27 million to 2 sf"),e=ve(27e7,2),u(e,"270000000","270 million to 2 sf"),e=ve(2700000002e-1,2),u(e,"270000000","270.2 million to 2 sf")}),k("Positive with decimals numbers",()=>{e=ve(27,5),u(e,"27.000","27 to 5 sf"),e=ve(2700000002e-1,10),u(e,"270000000.2","270.2 million to 10 sf"),e=ve(2700000002e-1,11),u(e,"270000000.20","270.2 million to 11 sf")}),k("Negative numbers",()=>{e=ve(-27,5),u(e,"-27.000","-27 to 5 sf"),e=ve(-2700000002e-1,11),u(e,"-270000000.20","-270.0000002 million to 11 sf"),e=ve(-2700000002e-1,2),u(e,"-270000000","-270.0000002 million to 2 sf")}),k("Small numbers",()=>{e=ve(1236e-7,3),u(e,"0.000124","0.0001236 to 3 sf"),e=ve(1236e-7,5),u(e,"0.00012360","0.0001236 to 5 sf"),e=ve(-1236e-7,3),u(e,"-0.000124","-0.0001236 to 3 sf"),e=ve(-1236e-7,5),u(e,"-0.00012360","-0.0001236 to 5 sf")}),k("Floating point precision numbers",()=>{e=ve(.01264,2),u(e,"0.013","0.01264 to 2 sf, tests when floating point precision results in 0.013000000000000001"),e=ve(17.955*100,7),u(e,"1795.500","17.955*100 to 7 sf, tests when floating point precision results in 1795.4999999999998")})});function y7(e){return e.reduce((t,n)=>(t[n]=n,t),Object.create(null))}const V=y7(["bare","simple","scaled","percentage","abbreviated_scaled","scientific"]);function W(e,t,n){let i;if(t=Math.round(t),t=t<1?1:t,n===V.bare)i=Ge(e,t).toString();else if(n===V.simple){const o=Ge(e,t);i=Math.abs(o)<1?o.toString():o.toLocaleString()}else if(n===V.scaled)i=k7(e,t);else if(n===V.percentage)i=Ge(e*100,t).toString()+"%";else if(n===V.abbreviated_scaled)i=x7(e,t);else if(n===V.scientific){const o=Al(e,t);i=e.toExponential(o-1)}else throw new Error(`Unimplemented display type ${n}`);return i=i.replace("e+","e").trim(),i}function k7(e,t){const n=["","thousand","million","billion","trillion"];let i=0;for(;Math.abs(e)>=1e3&&i<n.length-1;)e/=1e3,i++;const o=Al(e,t);return ve(e,o)+" "+n[i]}function x7(e,t){const n=["","k","m","bn","tn"];let i=0;for(;Math.abs(e)>=1e3&&i<n.length-1;)e/=1e3,i++;const o=Al(e,t);return ve(e,o)+" "+n[i]}function Al(e,t){let n=t;for(;n>1&&Number.parseFloat(e.toPrecision(n-1))===e;)--n;return n}const S7=k.delay("run_number_to_string",()=>{let e="";e=W(1264,2,V.bare),u(e,"1300","bare number"),e=W(1264,2,V.simple),u(e,"1,300","simple number"),e=W(1264,2,V.scaled),u(e,"1.3 thousand","scaled number"),e=W(.1264,2,V.percentage),u(e,"13%","number as percentage"),e=W(1264,2,V.abbreviated_scaled),u(e,"1.3 k","abbreviated scaled number"),e=W(1264,2,V.scientific),u(e,"1.3e3","scientific number"),e=W(.1264,-.2,V.scientific),u(e,"1e-1","Copes with significant_figures that are fractional and or < 1"),e=W(27e6,2,V.scaled),u(e,"27 million","27 million"),e=W(27e7,2,V.scaled),u(e,"270 million","270 million"),e=W(27e8,2,V.scaled),u(e,"2.7 billion","2.7 billion"),k("negative numbers",()=>{e=W(-1264,2,V.bare),u(e,"-1300","bare number"),e=W(-1264,2,V.simple),u(e,"-1,300","simple number"),e=W(-1264,2,V.scaled),u(e,"-1.3 thousand","scaled number"),e=W(-.1264,2,V.percentage),u(e,"-13%","percentage number"),e=W(-1264,2,V.abbreviated_scaled),u(e,"-1.3 k","abbreviated scaled number"),e=W(-1264,2,V.scientific),u(e,"-1.3e3","scientific number")}),k("less than 1 numbers",()=>{e=W(.001264,2,V.bare),u(e,"0.0013","bare number"),e=W(.001264,2,V.simple),u(e,"0.0013","simple number"),e=W(.001264,2,V.scaled),u(e,"0.0013","scaled number"),e=W(.001264,2,V.percentage),u(e,"0.13%","percentage number"),e=W(.001264,2,V.abbreviated_scaled),u(e,"0.0013","abbreviated scaled number"),e=W(.001264,2,V.scientific),u(e,"1.3e-3","scientific number"),e=W(-.001264,2,V.scientific),u(e,"-1.3e-3","0> num >-1 scientific number")}),k("no unnecessary significant figures",()=>{e=W(1,2,V.bare),u(e,"1","bare number"),e=W(1,2,V.simple),u(e,"1","simple number"),e=W(1e3,2,V.scaled),u(e,"1 thousand","scaled number"),e=W(10,2,V.percentage),u(e,"1000%","percentage number"),e=W(1e3,2,V.abbreviated_scaled),u(e,"1 k","abbreviated scaled number"),e=W(1e3,2,V.scientific),u(e,"1e3","scientific number")}),k("handles 0",()=>{e=W(0,2,V.bare),u(e,"0","bare number"),e=W(0,2,V.simple),u(e,"0","simple number"),e=W(0,2,V.scaled),u(e,"0","scaled number"),e=W(0,2,V.percentage),u(e,"0%","percentage number"),e=W(0,2,V.abbreviated_scaled),u(e,"0","abbreviated scaled number"),e=W(0,2,V.scientific),u(e,"0e0","scientific number")})});var Ds,wu;function A7(){if(wu)return Ds;wu=1;function e(){this.__data__=[],this.size=0}return Ds=e,Ds}var Ms,bu;function $l(){if(bu)return Ms;bu=1;function e(t,n){return t===n||t!==t&&n!==n}return Ms=e,Ms}var Os,yu;function _s(){if(yu)return Os;yu=1;var e=$l();function t(n,i){for(var o=n.length;o--;)if(e(n[o][0],i))return o;return-1}return Os=t,Os}var qs,ku;function $7(){if(ku)return qs;ku=1;var e=_s(),t=Array.prototype,n=t.splice;function i(o){var s=this.__data__,r=e(s,o);if(r<0)return!1;var a=s.length-1;return r==a?s.pop():n.call(s,r,1),--this.size,!0}return qs=i,qs}var Vs,xu;function C7(){if(xu)return Vs;xu=1;var e=_s();function t(n){var i=this.__data__,o=e(i,n);return o<0?void 0:i[o][1]}return Vs=t,Vs}var Fs,Su;function T7(){if(Su)return Fs;Su=1;var e=_s();function t(n){return e(this.__data__,n)>-1}return Fs=t,Fs}var zs,Au;function E7(){if(Au)return zs;Au=1;var e=_s();function t(n,i){var o=this.__data__,s=e(o,n);return s<0?(++this.size,o.push([n,i])):o[s][1]=i,this}return zs=t,zs}var Ls,$u;function as(){if($u)return Ls;$u=1;var e=A7(),t=$7(),n=C7(),i=T7(),o=E7();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,Ls=s,Ls}var Bs,Cu;function j7(){if(Cu)return Bs;Cu=1;var e=as();function t(){this.__data__=new e,this.size=0}return Bs=t,Bs}var Us,Tu;function N7(){if(Tu)return Us;Tu=1;function e(t){var n=this.__data__,i=n.delete(t);return this.size=n.size,i}return Us=e,Us}var Ws,Eu;function P7(){if(Eu)return Ws;Eu=1;function e(t){return this.__data__.get(t)}return Ws=e,Ws}var Hs,ju;function I7(){if(ju)return Hs;ju=1;function e(t){return this.__data__.has(t)}return Hs=e,Hs}var Gs,Nu;function Gw(){if(Nu)return Gs;Nu=1;var e=typeof uo=="object"&&uo&&uo.Object===Object&&uo;return Gs=e,Gs}var Ks,Pu;function Tt(){if(Pu)return Ks;Pu=1;var e=Gw(),t=typeof self=="object"&&self&&self.Object===Object&&self,n=e||t||Function("return this")();return Ks=n,Ks}var Ys,Iu;function _i(){if(Iu)return Ys;Iu=1;var e=Tt(),t=e.Symbol;return Ys=t,Ys}var Js,Ru;function R7(){if(Ru)return Js;Ru=1;var e=_i(),t=Object.prototype,n=t.hasOwnProperty,i=t.toString,o=e?e.toStringTag:void 0;function s(r){var a=n.call(r,o),c=r[o];try{r[o]=void 0;var l=!0}catch{}var d=i.call(r);return l&&(a?r[o]=c:delete r[o]),d}return Js=s,Js}var Xs,Du;function D7(){if(Du)return Xs;Du=1;var e=Object.prototype,t=e.toString;function n(i){return t.call(i)}return Xs=n,Xs}var Zs,Mu;function ai(){if(Mu)return Zs;Mu=1;var e=_i(),t=R7(),n=D7(),i="[object Null]",o="[object Undefined]",s=e?e.toStringTag:void 0;function r(a){return a==null?a===void 0?o:i:s&&s in Object(a)?t(a):n(a)}return Zs=r,Zs}var Qs,Ou;function xn(){if(Ou)return Qs;Ou=1;function e(t){var n=typeof t;return t!=null&&(n=="object"||n=="function")}return Qs=e,Qs}var er,qu;function cs(){if(qu)return er;qu=1;var e=ai(),t=xn(),n="[object AsyncFunction]",i="[object Function]",o="[object GeneratorFunction]",s="[object Proxy]";function r(a){if(!t(a))return!1;var c=e(a);return c==i||c==o||c==n||c==s}return er=r,er}var tr,Vu;function M7(){if(Vu)return tr;Vu=1;var e=Tt(),t=e["__core-js_shared__"];return tr=t,tr}var nr,Fu;function O7(){if(Fu)return nr;Fu=1;var e=M7(),t=function(){var i=/[^.]+$/.exec(e&&e.keys&&e.keys.IE_PROTO||"");return i?"Symbol(src)_1."+i:""}();function n(i){return!!t&&t in i}return nr=n,nr}var ir,zu;function Kw(){if(zu)return ir;zu=1;var e=Function.prototype,t=e.toString;function n(i){if(i!=null){try{return t.call(i)}catch{}try{return i+""}catch{}}return""}return ir=n,ir}var or,Lu;function q7(){if(Lu)return or;Lu=1;var e=cs(),t=O7(),n=xn(),i=Kw(),o=/[\\^$.*+?()[\]{}|]/g,s=/^\[object .+?Constructor\]$/,r=Function.prototype,a=Object.prototype,c=r.toString,l=a.hasOwnProperty,d=RegExp("^"+c.call(l).replace(o,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function p(f){if(!n(f)||t(f))return!1;var m=e(f)?d:s;return m.test(i(f))}return or=p,or}var sr,Bu;function V7(){if(Bu)return sr;Bu=1;function e(t,n){return t==null?void 0:t[n]}return sr=e,sr}var rr,Uu;function Sn(){if(Uu)return rr;Uu=1;var e=q7(),t=V7();function n(i,o){var s=t(i,o);return e(s)?s:void 0}return rr=n,rr}var _r,Wu;function Cl(){if(Wu)return _r;Wu=1;var e=Sn(),t=Tt(),n=e(t,"Map");return _r=n,_r}var ar,Hu;function ls(){if(Hu)return ar;Hu=1;var e=Sn(),t=e(Object,"create");return ar=t,ar}var cr,Gu;function F7(){if(Gu)return cr;Gu=1;var e=ls();function t(){this.__data__=e?e(null):{},this.size=0}return cr=t,cr}var lr,Ku;function z7(){if(Ku)return lr;Ku=1;function e(t){var n=this.has(t)&&delete this.__data__[t];return this.size-=n?1:0,n}return lr=e,lr}var dr,Yu;function L7(){if(Yu)return dr;Yu=1;var e=ls(),t="__lodash_hash_undefined__",n=Object.prototype,i=n.hasOwnProperty;function o(s){var r=this.__data__;if(e){var a=r[s];return a===t?void 0:a}return i.call(r,s)?r[s]:void 0}return dr=o,dr}var ur,Ju;function B7(){if(Ju)return ur;Ju=1;var e=ls(),t=Object.prototype,n=t.hasOwnProperty;function i(o){var s=this.__data__;return e?s[o]!==void 0:n.call(s,o)}return ur=i,ur}var pr,Xu;function U7(){if(Xu)return pr;Xu=1;var e=ls(),t="__lodash_hash_undefined__";function n(i,o){var s=this.__data__;return this.size+=this.has(i)?0:1,s[i]=e&&o===void 0?t:o,this}return pr=n,pr}var mr,Zu;function W7(){if(Zu)return mr;Zu=1;var e=F7(),t=z7(),n=L7(),i=B7(),o=U7();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,mr=s,mr}var fr,Qu;function H7(){if(Qu)return fr;Qu=1;var e=W7(),t=as(),n=Cl();function i(){this.size=0,this.__data__={hash:new e,map:new(n||t),string:new e}}return fr=i,fr}var hr,ep;function G7(){if(ep)return hr;ep=1;function e(t){var n=typeof t;return n=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null}return hr=e,hr}var vr,tp;function ds(){if(tp)return vr;tp=1;var e=G7();function t(n,i){var o=n.__data__;return e(i)?o[typeof i=="string"?"string":"hash"]:o.map}return vr=t,vr}var gr,np;function K7(){if(np)return gr;np=1;var e=ds();function t(n){var i=e(this,n).delete(n);return this.size-=i?1:0,i}return gr=t,gr}var wr,ip;function Y7(){if(ip)return wr;ip=1;var e=ds();function t(n){return e(this,n).get(n)}return wr=t,wr}var br,op;function J7(){if(op)return br;op=1;var e=ds();function t(n){return e(this,n).has(n)}return br=t,br}var yr,sp;function X7(){if(sp)return yr;sp=1;var e=ds();function t(n,i){var o=e(this,n),s=o.size;return o.set(n,i),this.size+=o.size==s?0:1,this}return yr=t,yr}var kr,rp;function Tl(){if(rp)return kr;rp=1;var e=H7(),t=K7(),n=Y7(),i=J7(),o=X7();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,kr=s,kr}var xr,_p;function Z7(){if(_p)return xr;_p=1;var e=as(),t=Cl(),n=Tl(),i=200;function o(s,r){var a=this.__data__;if(a instanceof e){var c=a.__data__;if(!t||c.length<i-1)return c.push([s,r]),this.size=++a.size,this;a=this.__data__=new n(c)}return a.set(s,r),this.size=a.size,this}return xr=o,xr}var Sr,ap;function El(){if(ap)return Sr;ap=1;var e=as(),t=j7(),n=N7(),i=P7(),o=I7(),s=Z7();function r(a){var c=this.__data__=new e(a);this.size=c.size}return r.prototype.clear=t,r.prototype.delete=n,r.prototype.get=i,r.prototype.has=o,r.prototype.set=s,Sr=r,Sr}var Ar,cp;function jl(){if(cp)return Ar;cp=1;function e(t,n){for(var i=-1,o=t==null?0:t.length;++i<o&&n(t[i],i,t)!==!1;);return t}return Ar=e,Ar}var $r,lp;function Yw(){if(lp)return $r;lp=1;var e=Sn(),t=function(){try{var n=e(Object,"defineProperty");return n({},"",{}),n}catch{}}();return $r=t,$r}var Cr,dp;function Jw(){if(dp)return Cr;dp=1;var e=Yw();function t(n,i,o){i=="__proto__"&&e?e(n,i,{configurable:!0,enumerable:!0,value:o,writable:!0}):n[i]=o}return Cr=t,Cr}var Tr,up;function Xw(){if(up)return Tr;up=1;var e=Jw(),t=$l(),n=Object.prototype,i=n.hasOwnProperty;function o(s,r,a){var c=s[r];(!(i.call(s,r)&&t(c,a))||a===void 0&&!(r in s))&&e(s,r,a)}return Tr=o,Tr}var Er,pp;function us(){if(pp)return Er;pp=1;var e=Xw(),t=Jw();function n(i,o,s,r){var a=!s;s||(s={});for(var c=-1,l=o.length;++c<l;){var d=o[c],p=r?r(s[d],i[d],d,s,i):void 0;p===void 0&&(p=i[d]),a?t(s,d,p):e(s,d,p)}return s}return Er=n,Er}var jr,mp;function Q7(){if(mp)return jr;mp=1;function e(t,n){for(var i=-1,o=Array(t);++i<t;)o[i]=n(i);return o}return jr=e,jr}var Nr,fp;function Lt(){if(fp)return Nr;fp=1;function e(t){return t!=null&&typeof t=="object"}return Nr=e,Nr}var Pr,hp;function e4(){if(hp)return Pr;hp=1;var e=ai(),t=Lt(),n="[object Arguments]";function i(o){return t(o)&&e(o)==n}return Pr=i,Pr}var Ir,vp;function ps(){if(vp)return Ir;vp=1;var e=e4(),t=Lt(),n=Object.prototype,i=n.hasOwnProperty,o=n.propertyIsEnumerable,s=e(function(){return arguments}())?e:function(r){return t(r)&&i.call(r,"callee")&&!o.call(r,"callee")};return Ir=s,Ir}var Rr,gp;function xe(){if(gp)return Rr;gp=1;var e=Array.isArray;return Rr=e,Rr}var $i={exports:{}},Dr,wp;function t4(){if(wp)return Dr;wp=1;function e(){return!1}return Dr=e,Dr}$i.exports;var bp;function Qi(){return bp||(bp=1,function(e,t){var n=Tt(),i=t4(),o=t&&!t.nodeType&&t,s=o&&!0&&e&&!e.nodeType&&e,r=s&&s.exports===o,a=r?n.Buffer:void 0,c=a?a.isBuffer:void 0,l=c||i;e.exports=l}($i,$i.exports)),$i.exports}var Mr,yp;function Zw(){if(yp)return Mr;yp=1;var e=9007199254740991,t=/^(?:0|[1-9]\d*)$/;function n(i,o){var s=typeof i;return o=o??e,!!o&&(s=="number"||s!="symbol"&&t.test(i))&&i>-1&&i%1==0&&i<o}return Mr=n,Mr}var Or,kp;function Nl(){if(kp)return Or;kp=1;var e=9007199254740991;function t(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=e}return Or=t,Or}var qr,xp;function n4(){if(xp)return qr;xp=1;var e=ai(),t=Nl(),n=Lt(),i="[object Arguments]",o="[object Array]",s="[object Boolean]",r="[object Date]",a="[object Error]",c="[object Function]",l="[object Map]",d="[object Number]",p="[object Object]",f="[object RegExp]",m="[object Set]",h="[object String]",v="[object WeakMap]",g="[object ArrayBuffer]",b="[object DataView]",w="[object Float32Array]",x="[object Float64Array]",y="[object Int8Array]",$="[object Int16Array]",C="[object Int32Array]",E="[object Uint8Array]",N="[object Uint8ClampedArray]",A="[object Uint16Array]",M="[object Uint32Array]",D={};D[w]=D[x]=D[y]=D[$]=D[C]=D[E]=D[N]=D[A]=D[M]=!0,D[i]=D[o]=D[g]=D[s]=D[b]=D[r]=D[a]=D[c]=D[l]=D[d]=D[p]=D[f]=D[m]=D[h]=D[v]=!1;function T(L){return n(L)&&t(L.length)&&!!D[e(L)]}return qr=T,qr}var Vr,Sp;function Pl(){if(Sp)return Vr;Sp=1;function e(t){return function(n){return t(n)}}return Vr=e,Vr}var Ci={exports:{}};Ci.exports;var Ap;function Il(){return Ap||(Ap=1,function(e,t){var n=Gw(),i=t&&!t.nodeType&&t,o=i&&!0&&e&&!e.nodeType&&e,s=o&&o.exports===i,r=s&&n.process,a=function(){try{var c=o&&o.require&&o.require("util").types;return c||r&&r.binding&&r.binding("util")}catch{}}();e.exports=a}(Ci,Ci.exports)),Ci.exports}var Fr,$p;function ms(){if($p)return Fr;$p=1;var e=n4(),t=Pl(),n=Il(),i=n&&n.isTypedArray,o=i?t(i):e;return Fr=o,Fr}var zr,Cp;function Qw(){if(Cp)return zr;Cp=1;var e=Q7(),t=ps(),n=xe(),i=Qi(),o=Zw(),s=ms(),r=Object.prototype,a=r.hasOwnProperty;function c(l,d){var p=n(l),f=!p&&t(l),m=!p&&!f&&i(l),h=!p&&!f&&!m&&s(l),v=p||f||m||h,g=v?e(l.length,String):[],b=g.length;for(var w in l)(d||a.call(l,w))&&!(v&&(w=="length"||m&&(w=="offset"||w=="parent")||h&&(w=="buffer"||w=="byteLength"||w=="byteOffset")||o(w,b)))&&g.push(w);return g}return zr=c,zr}var Lr,Tp;function fs(){if(Tp)return Lr;Tp=1;var e=Object.prototype;function t(n){var i=n&&n.constructor,o=typeof i=="function"&&i.prototype||e;return n===o}return Lr=t,Lr}var Br,Ep;function eb(){if(Ep)return Br;Ep=1;function e(t,n){return function(i){return t(n(i))}}return Br=e,Br}var Ur,jp;function i4(){if(jp)return Ur;jp=1;var e=eb(),t=e(Object.keys,Object);return Ur=t,Ur}var Wr,Np;function Rl(){if(Np)return Wr;Np=1;var e=fs(),t=i4(),n=Object.prototype,i=n.hasOwnProperty;function o(s){if(!e(s))return t(s);var r=[];for(var a in Object(s))i.call(s,a)&&a!="constructor"&&r.push(a);return r}return Wr=o,Wr}var Hr,Pp;function An(){if(Pp)return Hr;Pp=1;var e=cs(),t=Nl();function n(i){return i!=null&&t(i.length)&&!e(i)}return Hr=n,Hr}var Gr,Ip;function $n(){if(Ip)return Gr;Ip=1;var e=Qw(),t=Rl(),n=An();function i(o){return n(o)?e(o):t(o)}return Gr=i,Gr}var Kr,Rp;function o4(){if(Rp)return Kr;Rp=1;var e=us(),t=$n();function n(i,o){return i&&e(o,t(o),i)}return Kr=n,Kr}var Yr,Dp;function s4(){if(Dp)return Yr;Dp=1;function e(t){var n=[];if(t!=null)for(var i in Object(t))n.push(i);return n}return Yr=e,Yr}var Jr,Mp;function r4(){if(Mp)return Jr;Mp=1;var e=xn(),t=fs(),n=s4(),i=Object.prototype,o=i.hasOwnProperty;function s(r){if(!e(r))return n(r);var a=t(r),c=[];for(var l in r)l=="constructor"&&(a||!o.call(r,l))||c.push(l);return c}return Jr=s,Jr}var Xr,Op;function Dl(){if(Op)return Xr;Op=1;var e=Qw(),t=r4(),n=An();function i(o){return n(o)?e(o,!0):t(o)}return Xr=i,Xr}var Zr,qp;function _4(){if(qp)return Zr;qp=1;var e=us(),t=Dl();function n(i,o){return i&&e(o,t(o),i)}return Zr=n,Zr}var Ti={exports:{}};Ti.exports;var Vp;function a4(){return Vp||(Vp=1,function(e,t){var n=Tt(),i=t&&!t.nodeType&&t,o=i&&!0&&e&&!e.nodeType&&e,s=o&&o.exports===i,r=s?n.Buffer:void 0,a=r?r.allocUnsafe:void 0;function c(l,d){if(d)return l.slice();var p=l.length,f=a?a(p):new l.constructor(p);return l.copy(f),f}e.exports=c}(Ti,Ti.exports)),Ti.exports}var Qr,Fp;function c4(){if(Fp)return Qr;Fp=1;function e(t,n){var i=-1,o=t.length;for(n||(n=Array(o));++i<o;)n[i]=t[i];return n}return Qr=e,Qr}var e_,zp;function tb(){if(zp)return e_;zp=1;function e(t,n){for(var i=-1,o=t==null?0:t.length,s=0,r=[];++i<o;){var a=t[i];n(a,i,t)&&(r[s++]=a)}return r}return e_=e,e_}var t_,Lp;function nb(){if(Lp)return t_;Lp=1;function e(){return[]}return t_=e,t_}var n_,Bp;function Ml(){if(Bp)return n_;Bp=1;var e=tb(),t=nb(),n=Object.prototype,i=n.propertyIsEnumerable,o=Object.getOwnPropertySymbols,s=o?function(r){return r==null?[]:(r=Object(r),e(o(r),function(a){return i.call(r,a)}))}:t;return n_=s,n_}var i_,Up;function l4(){if(Up)return i_;Up=1;var e=us(),t=Ml();function n(i,o){return e(i,t(i),o)}return i_=n,i_}var o_,Wp;function Ol(){if(Wp)return o_;Wp=1;function e(t,n){for(var i=-1,o=n.length,s=t.length;++i<o;)t[s+i]=n[i];return t}return o_=e,o_}var s_,Hp;function ql(){if(Hp)return s_;Hp=1;var e=eb(),t=e(Object.getPrototypeOf,Object);return s_=t,s_}var r_,Gp;function ib(){if(Gp)return r_;Gp=1;var e=Ol(),t=ql(),n=Ml(),i=nb(),o=Object.getOwnPropertySymbols,s=o?function(r){for(var a=[];r;)e(a,n(r)),r=t(r);return a}:i;return r_=s,r_}var __,Kp;function d4(){if(Kp)return __;Kp=1;var e=us(),t=ib();function n(i,o){return e(i,t(i),o)}return __=n,__}var a_,Yp;function ob(){if(Yp)return a_;Yp=1;var e=Ol(),t=xe();function n(i,o,s){var r=o(i);return t(i)?r:e(r,s(i))}return a_=n,a_}var c_,Jp;function sb(){if(Jp)return c_;Jp=1;var e=ob(),t=Ml(),n=$n();function i(o){return e(o,n,t)}return c_=i,c_}var l_,Xp;function u4(){if(Xp)return l_;Xp=1;var e=ob(),t=ib(),n=Dl();function i(o){return e(o,n,t)}return l_=i,l_}var d_,Zp;function p4(){if(Zp)return d_;Zp=1;var e=Sn(),t=Tt(),n=e(t,"DataView");return d_=n,d_}var u_,Qp;function m4(){if(Qp)return u_;Qp=1;var e=Sn(),t=Tt(),n=e(t,"Promise");return u_=n,u_}var p_,em;function rb(){if(em)return p_;em=1;var e=Sn(),t=Tt(),n=e(t,"Set");return p_=n,p_}var m_,tm;function f4(){if(tm)return m_;tm=1;var e=Sn(),t=Tt(),n=e(t,"WeakMap");return m_=n,m_}var f_,nm;function ci(){if(nm)return f_;nm=1;var e=p4(),t=Cl(),n=m4(),i=rb(),o=f4(),s=ai(),r=Kw(),a="[object Map]",c="[object Object]",l="[object Promise]",d="[object Set]",p="[object WeakMap]",f="[object DataView]",m=r(e),h=r(t),v=r(n),g=r(i),b=r(o),w=s;return(e&&w(new e(new ArrayBuffer(1)))!=f||t&&w(new t)!=a||n&&w(n.resolve())!=l||i&&w(new i)!=d||o&&w(new o)!=p)&&(w=function(x){var y=s(x),$=y==c?x.constructor:void 0,C=$?r($):"";if(C)switch(C){case m:return f;case h:return a;case v:return l;case g:return d;case b:return p}return y}),f_=w,f_}var h_,im;function h4(){if(im)return h_;im=1;var e=Object.prototype,t=e.hasOwnProperty;function n(i){var o=i.length,s=new i.constructor(o);return o&&typeof i[0]=="string"&&t.call(i,"index")&&(s.index=i.index,s.input=i.input),s}return h_=n,h_}var v_,om;function _b(){if(om)return v_;om=1;var e=Tt(),t=e.Uint8Array;return v_=t,v_}var g_,sm;function Vl(){if(sm)return g_;sm=1;var e=_b();function t(n){var i=new n.constructor(n.byteLength);return new e(i).set(new e(n)),i}return g_=t,g_}var w_,rm;function v4(){if(rm)return w_;rm=1;var e=Vl();function t(n,i){var o=i?e(n.buffer):n.buffer;return new n.constructor(o,n.byteOffset,n.byteLength)}return w_=t,w_}var b_,_m;function g4(){if(_m)return b_;_m=1;var e=/\w*$/;function t(n){var i=new n.constructor(n.source,e.exec(n));return i.lastIndex=n.lastIndex,i}return b_=t,b_}var y_,am;function w4(){if(am)return y_;am=1;var e=_i(),t=e?e.prototype:void 0,n=t?t.valueOf:void 0;function i(o){return n?Object(n.call(o)):{}}return y_=i,y_}var k_,cm;function b4(){if(cm)return k_;cm=1;var e=Vl();function t(n,i){var o=i?e(n.buffer):n.buffer;return new n.constructor(o,n.byteOffset,n.length)}return k_=t,k_}var x_,lm;function y4(){if(lm)return x_;lm=1;var e=Vl(),t=v4(),n=g4(),i=w4(),o=b4(),s="[object Boolean]",r="[object Date]",a="[object Map]",c="[object Number]",l="[object RegExp]",d="[object Set]",p="[object String]",f="[object Symbol]",m="[object ArrayBuffer]",h="[object DataView]",v="[object Float32Array]",g="[object Float64Array]",b="[object Int8Array]",w="[object Int16Array]",x="[object Int32Array]",y="[object Uint8Array]",$="[object Uint8ClampedArray]",C="[object Uint16Array]",E="[object Uint32Array]";function N(A,M,D){var T=A.constructor;switch(M){case m:return e(A);case s:case r:return new T(+A);case h:return t(A,D);case v:case g:case b:case w:case x:case y:case $:case C:case E:return o(A,D);case a:return new T;case c:case p:return new T(A);case l:return n(A);case d:return new T;case f:return i(A)}}return x_=N,x_}var S_,dm;function ab(){if(dm)return S_;dm=1;var e=xn(),t=Object.create,n=function(){function i(){}return function(o){if(!e(o))return{};if(t)return t(o);i.prototype=o;var s=new i;return i.prototype=void 0,s}}();return S_=n,S_}var A_,um;function k4(){if(um)return A_;um=1;var e=ab(),t=ql(),n=fs();function i(o){return typeof o.constructor=="function"&&!n(o)?e(t(o)):{}}return A_=i,A_}var $_,pm;function x4(){if(pm)return $_;pm=1;var e=ci(),t=Lt(),n="[object Map]";function i(o){return t(o)&&e(o)==n}return $_=i,$_}var C_,mm;function S4(){if(mm)return C_;mm=1;var e=x4(),t=Pl(),n=Il(),i=n&&n.isMap,o=i?t(i):e;return C_=o,C_}var T_,fm;function A4(){if(fm)return T_;fm=1;var e=ci(),t=Lt(),n="[object Set]";function i(o){return t(o)&&e(o)==n}return T_=i,T_}var E_,hm;function $4(){if(hm)return E_;hm=1;var e=A4(),t=Pl(),n=Il(),i=n&&n.isSet,o=i?t(i):e;return E_=o,E_}var j_,vm;function C4(){if(vm)return j_;vm=1;var e=El(),t=jl(),n=Xw(),i=o4(),o=_4(),s=a4(),r=c4(),a=l4(),c=d4(),l=sb(),d=u4(),p=ci(),f=h4(),m=y4(),h=k4(),v=xe(),g=Qi(),b=S4(),w=xn(),x=$4(),y=$n(),$=Dl(),C=1,E=2,N=4,A="[object Arguments]",M="[object Array]",D="[object Boolean]",T="[object Date]",L="[object Error]",ne="[object Function]",Ue="[object GeneratorFunction]",Xe="[object Map]",Tn="[object Number]",Bt="[object Object]",ht="[object RegExp]",Ss="[object Set]",As="[object String]",$s="[object Symbol]",ro="[object WeakMap]",Cs="[object ArrayBuffer]",Ze="[object DataView]",En="[object Float32Array]",ui="[object Float64Array]",N0="[object Int8Array]",P0="[object Int16Array]",I0="[object Int32Array]",R0="[object Uint8Array]",D0="[object Uint8ClampedArray]",M0="[object Uint16Array]",O0="[object Uint32Array]",re={};re[A]=re[M]=re[Cs]=re[Ze]=re[D]=re[T]=re[En]=re[ui]=re[N0]=re[P0]=re[I0]=re[Xe]=re[Tn]=re[Bt]=re[ht]=re[Ss]=re[As]=re[$s]=re[R0]=re[D0]=re[M0]=re[O0]=!0,re[L]=re[ne]=re[ro]=!1;function _o(ie,jn,Nn,q0,ao,Ut){var We,co=jn&C,lo=jn&E,V0=jn&N;if(Nn&&(We=ao?Nn(ie,q0,ao,Ut):Nn(ie)),We!==void 0)return We;if(!w(ie))return ie;var Ud=v(ie);if(Ud){if(We=f(ie),!co)return r(ie,We)}else{var Pn=p(ie),Wd=Pn==ne||Pn==Ue;if(g(ie))return s(ie,co);if(Pn==Bt||Pn==A||Wd&&!ao){if(We=lo||Wd?{}:h(ie),!co)return lo?c(ie,o(We,ie)):a(ie,i(We,ie))}else{if(!re[Pn])return ao?ie:{};We=m(ie,Pn,co)}}Ut||(Ut=new e);var Hd=Ut.get(ie);if(Hd)return Hd;Ut.set(ie,We),x(ie)?ie.forEach(function(Wt){We.add(_o(Wt,jn,Nn,Wt,ie,Ut))}):b(ie)&&ie.forEach(function(Wt,rn){We.set(rn,_o(Wt,jn,Nn,rn,ie,Ut))});var F0=V0?lo?d:l:lo?$:y,Gd=Ud?void 0:F0(ie);return t(Gd||ie,function(Wt,rn){Gd&&(rn=Wt,Wt=ie[rn]),n(We,rn,_o(Wt,jn,Nn,rn,ie,Ut))}),We}return j_=_o,j_}var N_,gm;function T4(){if(gm)return N_;gm=1;var e=C4(),t=4;function n(i){return e(i,t)}return N_=n,N_}var P_,wm;function cb(){if(wm)return P_;wm=1;function e(t){return function(){return t}}return P_=e,P_}var I_,bm;function E4(){if(bm)return I_;bm=1;function e(t){return function(n,i,o){for(var s=-1,r=Object(n),a=o(n),c=a.length;c--;){var l=a[t?c:++s];if(i(r[l],l,r)===!1)break}return n}}return I_=e,I_}var R_,ym;function j4(){if(ym)return R_;ym=1;var e=E4(),t=e();return R_=t,R_}var D_,km;function lb(){if(km)return D_;km=1;var e=j4(),t=$n();function n(i,o){return i&&e(i,o,t)}return D_=n,D_}var M_,xm;function N4(){if(xm)return M_;xm=1;var e=An();function t(n,i){return function(o,s){if(o==null)return o;if(!e(o))return n(o,s);for(var r=o.length,a=i?r:-1,c=Object(o);(i?a--:++a<r)&&s(c[a],a,c)!==!1;);return o}}return M_=t,M_}var O_,Sm;function hs(){if(Sm)return O_;Sm=1;var e=lb(),t=N4(),n=t(e);return O_=n,O_}var q_,Am;function vs(){if(Am)return q_;Am=1;function e(t){return t}return q_=e,q_}var V_,$m;function P4(){if($m)return V_;$m=1;var e=vs();function t(n){return typeof n=="function"?n:e}return V_=t,V_}var F_,Cm;function I4(){if(Cm)return F_;Cm=1;var e=jl(),t=hs(),n=P4(),i=xe();function o(s,r){var a=i(s)?e:t;return a(s,n(r))}return F_=o,F_}var z_,Tm;function R4(){return Tm||(Tm=1,z_=I4()),z_}var L_,Em;function D4(){if(Em)return L_;Em=1;var e=hs();function t(n,i){var o=[];return e(n,function(s,r,a){i(s,r,a)&&o.push(s)}),o}return L_=t,L_}var B_,jm;function M4(){if(jm)return B_;jm=1;var e="__lodash_hash_undefined__";function t(n){return this.__data__.set(n,e),this}return B_=t,B_}var U_,Nm;function O4(){if(Nm)return U_;Nm=1;function e(t){return this.__data__.has(t)}return U_=e,U_}var W_,Pm;function db(){if(Pm)return W_;Pm=1;var e=Tl(),t=M4(),n=O4();function i(o){var s=-1,r=o==null?0:o.length;for(this.__data__=new e;++s<r;)this.add(o[s])}return i.prototype.add=i.prototype.push=t,i.prototype.has=n,W_=i,W_}var H_,Im;function q4(){if(Im)return H_;Im=1;function e(t,n){for(var i=-1,o=t==null?0:t.length;++i<o;)if(n(t[i],i,t))return!0;return!1}return H_=e,H_}var G_,Rm;function ub(){if(Rm)return G_;Rm=1;function e(t,n){return t.has(n)}return G_=e,G_}var K_,Dm;function pb(){if(Dm)return K_;Dm=1;var e=db(),t=q4(),n=ub(),i=1,o=2;function s(r,a,c,l,d,p){var f=c&i,m=r.length,h=a.length;if(m!=h&&!(f&&h>m))return!1;var v=p.get(r),g=p.get(a);if(v&&g)return v==a&&g==r;var b=-1,w=!0,x=c&o?new e:void 0;for(p.set(r,a),p.set(a,r);++b<m;){var y=r[b],$=a[b];if(l)var C=f?l($,y,b,a,r,p):l(y,$,b,r,a,p);if(C!==void 0){if(C)continue;w=!1;break}if(x){if(!t(a,function(E,N){if(!n(x,N)&&(y===E||d(y,E,c,l,p)))return x.push(N)})){w=!1;break}}else if(!(y===$||d(y,$,c,l,p))){w=!1;break}}return p.delete(r),p.delete(a),w}return K_=s,K_}var Y_,Mm;function V4(){if(Mm)return Y_;Mm=1;function e(t){var n=-1,i=Array(t.size);return t.forEach(function(o,s){i[++n]=[s,o]}),i}return Y_=e,Y_}var J_,Om;function Fl(){if(Om)return J_;Om=1;function e(t){var n=-1,i=Array(t.size);return t.forEach(function(o){i[++n]=o}),i}return J_=e,J_}var X_,qm;function F4(){if(qm)return X_;qm=1;var e=_i(),t=_b(),n=$l(),i=pb(),o=V4(),s=Fl(),r=1,a=2,c="[object Boolean]",l="[object Date]",d="[object Error]",p="[object Map]",f="[object Number]",m="[object RegExp]",h="[object Set]",v="[object String]",g="[object Symbol]",b="[object ArrayBuffer]",w="[object DataView]",x=e?e.prototype:void 0,y=x?x.valueOf:void 0;function $(C,E,N,A,M,D,T){switch(N){case w:if(C.byteLength!=E.byteLength||C.byteOffset!=E.byteOffset)return!1;C=C.buffer,E=E.buffer;case b:return!(C.byteLength!=E.byteLength||!D(new t(C),new t(E)));case c:case l:case f:return n(+C,+E);case d:return C.name==E.name&&C.message==E.message;case m:case v:return C==E+"";case p:var L=o;case h:var ne=A&r;if(L||(L=s),C.size!=E.size&&!ne)return!1;var Ue=T.get(C);if(Ue)return Ue==E;A|=a,T.set(C,E);var Xe=i(L(C),L(E),A,M,D,T);return T.delete(C),Xe;case g:if(y)return y.call(C)==y.call(E)}return!1}return X_=$,X_}var Z_,Vm;function z4(){if(Vm)return Z_;Vm=1;var e=sb(),t=1,n=Object.prototype,i=n.hasOwnProperty;function o(s,r,a,c,l,d){var p=a&t,f=e(s),m=f.length,h=e(r),v=h.length;if(m!=v&&!p)return!1;for(var g=m;g--;){var b=f[g];if(!(p?b in r:i.call(r,b)))return!1}var w=d.get(s),x=d.get(r);if(w&&x)return w==r&&x==s;var y=!0;d.set(s,r),d.set(r,s);for(var $=p;++g<m;){b=f[g];var C=s[b],E=r[b];if(c)var N=p?c(E,C,b,r,s,d):c(C,E,b,s,r,d);if(!(N===void 0?C===E||l(C,E,a,c,d):N)){y=!1;break}$||($=b=="constructor")}if(y&&!$){var A=s.constructor,M=r.constructor;A!=M&&"constructor"in s&&"constructor"in r&&!(typeof A=="function"&&A instanceof A&&typeof M=="function"&&M instanceof M)&&(y=!1)}return d.delete(s),d.delete(r),y}return Z_=o,Z_}var Q_,Fm;function L4(){if(Fm)return Q_;Fm=1;var e=El(),t=pb(),n=F4(),i=z4(),o=ci(),s=xe(),r=Qi(),a=ms(),c=1,l="[object Arguments]",d="[object Array]",p="[object Object]",f=Object.prototype,m=f.hasOwnProperty;function h(v,g,b,w,x,y){var $=s(v),C=s(g),E=$?d:o(v),N=C?d:o(g);E=E==l?p:E,N=N==l?p:N;var A=E==p,M=N==p,D=E==N;if(D&&r(v)){if(!r(g))return!1;$=!0,A=!1}if(D&&!A)return y||(y=new e),$||a(v)?t(v,g,b,w,x,y):n(v,g,E,b,w,x,y);if(!(b&c)){var T=A&&m.call(v,"__wrapped__"),L=M&&m.call(g,"__wrapped__");if(T||L){var ne=T?v.value():v,Ue=L?g.value():g;return y||(y=new e),x(ne,Ue,b,w,y)}}return D?(y||(y=new e),i(v,g,b,w,x,y)):!1}return Q_=h,Q_}var ea,zm;function mb(){if(zm)return ea;zm=1;var e=L4(),t=Lt();function n(i,o,s,r,a){return i===o?!0:i==null||o==null||!t(i)&&!t(o)?i!==i&&o!==o:e(i,o,s,r,n,a)}return ea=n,ea}var ta,Lm;function B4(){if(Lm)return ta;Lm=1;var e=El(),t=mb(),n=1,i=2;function o(s,r,a,c){var l=a.length,d=l,p=!c;if(s==null)return!d;for(s=Object(s);l--;){var f=a[l];if(p&&f[2]?f[1]!==s[f[0]]:!(f[0]in s))return!1}for(;++l<d;){f=a[l];var m=f[0],h=s[m],v=f[1];if(p&&f[2]){if(h===void 0&&!(m in s))return!1}else{var g=new e;if(c)var b=c(h,v,m,s,r,g);if(!(b===void 0?t(v,h,n|i,c,g):b))return!1}}return!0}return ta=o,ta}var na,Bm;function fb(){if(Bm)return na;Bm=1;var e=xn();function t(n){return n===n&&!e(n)}return na=t,na}var ia,Um;function U4(){if(Um)return ia;Um=1;var e=fb(),t=$n();function n(i){for(var o=t(i),s=o.length;s--;){var r=o[s],a=i[r];o[s]=[r,a,e(a)]}return o}return ia=n,ia}var oa,Wm;function hb(){if(Wm)return oa;Wm=1;function e(t,n){return function(i){return i==null?!1:i[t]===n&&(n!==void 0||t in Object(i))}}return oa=e,oa}var sa,Hm;function W4(){if(Hm)return sa;Hm=1;var e=B4(),t=U4(),n=hb();function i(o){var s=t(o);return s.length==1&&s[0][2]?n(s[0][0],s[0][1]):function(r){return r===o||e(r,o,s)}}return sa=i,sa}var ra,Gm;function zl(){if(Gm)return ra;Gm=1;var e=ai(),t=Lt(),n="[object Symbol]";function i(o){return typeof o=="symbol"||t(o)&&e(o)==n}return ra=i,ra}var _a,Km;function Ll(){if(Km)return _a;Km=1;var e=xe(),t=zl(),n=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,i=/^\w*$/;function o(s,r){if(e(s))return!1;var a=typeof s;return a=="number"||a=="symbol"||a=="boolean"||s==null||t(s)?!0:i.test(s)||!n.test(s)||r!=null&&s in Object(r)}return _a=o,_a}var aa,Ym;function H4(){if(Ym)return aa;Ym=1;var e=Tl(),t="Expected a function";function n(i,o){if(typeof i!="function"||o!=null&&typeof o!="function")throw new TypeError(t);var s=function(){var r=arguments,a=o?o.apply(this,r):r[0],c=s.cache;if(c.has(a))return c.get(a);var l=i.apply(this,r);return s.cache=c.set(a,l)||c,l};return s.cache=new(n.Cache||e),s}return n.Cache=e,aa=n,aa}var ca,Jm;function G4(){if(Jm)return ca;Jm=1;var e=H4(),t=500;function n(i){var o=e(i,function(r){return s.size===t&&s.clear(),r}),s=o.cache;return o}return ca=n,ca}var la,Xm;function K4(){if(Xm)return la;Xm=1;var e=G4(),t=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,n=/\\(\\)?/g,i=e(function(o){var s=[];return o.charCodeAt(0)===46&&s.push(""),o.replace(t,function(r,a,c,l){s.push(c?l.replace(n,"$1"):a||r)}),s});return la=i,la}var da,Zm;function Bl(){if(Zm)return da;Zm=1;function e(t,n){for(var i=-1,o=t==null?0:t.length,s=Array(o);++i<o;)s[i]=n(t[i],i,t);return s}return da=e,da}var ua,Qm;function Y4(){if(Qm)return ua;Qm=1;var e=_i(),t=Bl(),n=xe(),i=zl(),o=1/0,s=e?e.prototype:void 0,r=s?s.toString:void 0;function a(c){if(typeof c=="string")return c;if(n(c))return t(c,a)+"";if(i(c))return r?r.call(c):"";var l=c+"";return l=="0"&&1/c==-o?"-0":l}return ua=a,ua}var pa,ef;function J4(){if(ef)return pa;ef=1;var e=Y4();function t(n){return n==null?"":e(n)}return pa=t,pa}var ma,tf;function vb(){if(tf)return ma;tf=1;var e=xe(),t=Ll(),n=K4(),i=J4();function o(s,r){return e(s)?s:t(s,r)?[s]:n(i(s))}return ma=o,ma}var fa,nf;function gs(){if(nf)return fa;nf=1;var e=zl(),t=1/0;function n(i){if(typeof i=="string"||e(i))return i;var o=i+"";return o=="0"&&1/i==-t?"-0":o}return fa=n,fa}var ha,of;function gb(){if(of)return ha;of=1;var e=vb(),t=gs();function n(i,o){o=e(o,i);for(var s=0,r=o.length;i!=null&&s<r;)i=i[t(o[s++])];return s&&s==r?i:void 0}return ha=n,ha}var va,sf;function X4(){if(sf)return va;sf=1;var e=gb();function t(n,i,o){var s=n==null?void 0:e(n,i);return s===void 0?o:s}return va=t,va}var ga,rf;function Z4(){if(rf)return ga;rf=1;function e(t,n){return t!=null&&n in Object(t)}return ga=e,ga}var wa,_f;function wb(){if(_f)return wa;_f=1;var e=vb(),t=ps(),n=xe(),i=Zw(),o=Nl(),s=gs();function r(a,c,l){c=e(c,a);for(var d=-1,p=c.length,f=!1;++d<p;){var m=s(c[d]);if(!(f=a!=null&&l(a,m)))break;a=a[m]}return f||++d!=p?f:(p=a==null?0:a.length,!!p&&o(p)&&i(m,p)&&(n(a)||t(a)))}return wa=r,wa}var ba,af;function Q4(){if(af)return ba;af=1;var e=Z4(),t=wb();function n(i,o){return i!=null&&t(i,o,e)}return ba=n,ba}var ya,cf;function e5(){if(cf)return ya;cf=1;var e=mb(),t=X4(),n=Q4(),i=Ll(),o=fb(),s=hb(),r=gs(),a=1,c=2;function l(d,p){return i(d)&&o(p)?s(r(d),p):function(f){var m=t(f,d);return m===void 0&&m===p?n(f,d):e(p,m,a|c)}}return ya=l,ya}var ka,lf;function bb(){if(lf)return ka;lf=1;function e(t){return function(n){return n==null?void 0:n[t]}}return ka=e,ka}var xa,df;function t5(){if(df)return xa;df=1;var e=gb();function t(n){return function(i){return e(i,n)}}return xa=t,xa}var Sa,uf;function n5(){if(uf)return Sa;uf=1;var e=bb(),t=t5(),n=Ll(),i=gs();function o(s){return n(s)?e(i(s)):t(s)}return Sa=o,Sa}var Aa,pf;function ws(){if(pf)return Aa;pf=1;var e=W4(),t=e5(),n=vs(),i=xe(),o=n5();function s(r){return typeof r=="function"?r:r==null?n:typeof r=="object"?i(r)?t(r[0],r[1]):e(r):o(r)}return Aa=s,Aa}var $a,mf;function i5(){if(mf)return $a;mf=1;var e=tb(),t=D4(),n=ws(),i=xe();function o(s,r){var a=i(s)?e:t;return a(s,n(r,3))}return $a=o,$a}var Ca,ff;function o5(){if(ff)return Ca;ff=1;var e=Object.prototype,t=e.hasOwnProperty;function n(i,o){return i!=null&&t.call(i,o)}return Ca=n,Ca}var Ta,hf;function s5(){if(hf)return Ta;hf=1;var e=o5(),t=wb();function n(i,o){return i!=null&&t(i,o,e)}return Ta=n,Ta}var Ea,vf;function r5(){if(vf)return Ea;vf=1;var e=Rl(),t=ci(),n=ps(),i=xe(),o=An(),s=Qi(),r=fs(),a=ms(),c="[object Map]",l="[object Set]",d=Object.prototype,p=d.hasOwnProperty;function f(m){if(m==null)return!0;if(o(m)&&(i(m)||typeof m=="string"||typeof m.splice=="function"||s(m)||a(m)||n(m)))return!m.length;var h=t(m);if(h==c||h==l)return!m.size;if(r(m))return!e(m).length;for(var v in m)if(p.call(m,v))return!1;return!0}return Ea=f,Ea}var ja,gf;function _5(){if(gf)return ja;gf=1;function e(t){return t===void 0}return ja=e,ja}var Na,wf;function a5(){if(wf)return Na;wf=1;var e=hs(),t=An();function n(i,o){var s=-1,r=t(i)?Array(i.length):[];return e(i,function(a,c,l){r[++s]=o(a,c,l)}),r}return Na=n,Na}var Pa,bf;function c5(){if(bf)return Pa;bf=1;var e=Bl(),t=ws(),n=a5(),i=xe();function o(s,r){var a=i(s)?e:n;return a(s,t(r,3))}return Pa=o,Pa}var Ia,yf;function l5(){if(yf)return Ia;yf=1;function e(t,n,i,o){var s=-1,r=t==null?0:t.length;for(o&&r&&(i=t[++s]);++s<r;)i=n(i,t[s],s,t);return i}return Ia=e,Ia}var Ra,kf;function d5(){if(kf)return Ra;kf=1;function e(t,n,i,o,s){return s(t,function(r,a,c){i=o?(o=!1,r):n(i,r,a,c)}),i}return Ra=e,Ra}var Da,xf;function u5(){if(xf)return Da;xf=1;var e=l5(),t=hs(),n=ws(),i=d5(),o=xe();function s(r,a,c){var l=o(r)?e:i,d=arguments.length<3;return l(r,n(a,4),c,d,t)}return Da=s,Da}var Ma,Sf;function p5(){if(Sf)return Ma;Sf=1;var e=ai(),t=xe(),n=Lt(),i="[object String]";function o(s){return typeof s=="string"||!t(s)&&n(s)&&e(s)==i}return Ma=o,Ma}var Oa,Af;function m5(){if(Af)return Oa;Af=1;var e=bb(),t=e("length");return Oa=t,Oa}var qa,$f;function f5(){if($f)return qa;$f=1;var e="\\ud800-\\udfff",t="\\u0300-\\u036f",n="\\ufe20-\\ufe2f",i="\\u20d0-\\u20ff",o=t+n+i,s="\\ufe0e\\ufe0f",r="\\u200d",a=RegExp("["+r+e+o+s+"]");function c(l){return a.test(l)}return qa=c,qa}var Va,Cf;function h5(){if(Cf)return Va;Cf=1;var e="\\ud800-\\udfff",t="\\u0300-\\u036f",n="\\ufe20-\\ufe2f",i="\\u20d0-\\u20ff",o=t+n+i,s="\\ufe0e\\ufe0f",r="["+e+"]",a="["+o+"]",c="\\ud83c[\\udffb-\\udfff]",l="(?:"+a+"|"+c+")",d="[^"+e+"]",p="(?:\\ud83c[\\udde6-\\uddff]){2}",f="[\\ud800-\\udbff][\\udc00-\\udfff]",m="\\u200d",h=l+"?",v="["+s+"]?",g="(?:"+m+"(?:"+[d,p,f].join("|")+")"+v+h+")*",b=v+h+g,w="(?:"+[d+a+"?",a,p,f,r].join("|")+")",x=RegExp(c+"(?="+c+")|"+w+b,"g");function y($){for(var C=x.lastIndex=0;x.test($);)++C;return C}return Va=y,Va}var Fa,Tf;function v5(){if(Tf)return Fa;Tf=1;var e=m5(),t=f5(),n=h5();function i(o){return t(o)?n(o):e(o)}return Fa=i,Fa}var za,Ef;function g5(){if(Ef)return za;Ef=1;var e=Rl(),t=ci(),n=An(),i=p5(),o=v5(),s="[object Map]",r="[object Set]";function a(c){if(c==null)return 0;if(n(c))return i(c)?o(c):c.length;var l=t(c);return l==s||l==r?c.size:e(c).length}return za=a,za}var La,jf;function w5(){if(jf)return La;jf=1;var e=jl(),t=ab(),n=lb(),i=ws(),o=ql(),s=xe(),r=Qi(),a=cs(),c=xn(),l=ms();function d(p,f,m){var h=s(p),v=h||r(p)||l(p);if(f=i(f,4),m==null){var g=p&&p.constructor;v?m=h?new g:[]:c(p)?m=a(g)?t(o(p)):{}:m={}}return(v?e:n)(p,function(b,w,x){return f(m,b,w,x)}),m}return La=d,La}var Ba,Nf;function b5(){if(Nf)return Ba;Nf=1;var e=_i(),t=ps(),n=xe(),i=e?e.isConcatSpreadable:void 0;function o(s){return n(s)||t(s)||!!(i&&s&&s[i])}return Ba=o,Ba}var Ua,Pf;function y5(){if(Pf)return Ua;Pf=1;var e=Ol(),t=b5();function n(i,o,s,r,a){var c=-1,l=i.length;for(s||(s=t),a||(a=[]);++c<l;){var d=i[c];o>0&&s(d)?o>1?n(d,o-1,s,r,a):e(a,d):r||(a[a.length]=d)}return a}return Ua=n,Ua}var Wa,If;function k5(){if(If)return Wa;If=1;function e(t,n,i){switch(i.length){case 0:return t.call(n);case 1:return t.call(n,i[0]);case 2:return t.call(n,i[0],i[1]);case 3:return t.call(n,i[0],i[1],i[2])}return t.apply(n,i)}return Wa=e,Wa}var Ha,Rf;function x5(){if(Rf)return Ha;Rf=1;var e=k5(),t=Math.max;function n(i,o,s){return o=t(o===void 0?i.length-1:o,0),function(){for(var r=arguments,a=-1,c=t(r.length-o,0),l=Array(c);++a<c;)l[a]=r[o+a];a=-1;for(var d=Array(o+1);++a<o;)d[a]=r[a];return d[o]=s(l),e(i,this,d)}}return Ha=n,Ha}var Ga,Df;function S5(){if(Df)return Ga;Df=1;var e=cb(),t=Yw(),n=vs(),i=t?function(o,s){return t(o,"toString",{configurable:!0,enumerable:!1,value:e(s),writable:!0})}:n;return Ga=i,Ga}var Ka,Mf;function A5(){if(Mf)return Ka;Mf=1;var e=800,t=16,n=Date.now;function i(o){var s=0,r=0;return function(){var a=n(),c=t-(a-r);if(r=a,c>0){if(++s>=e)return arguments[0]}else s=0;return o.apply(void 0,arguments)}}return Ka=i,Ka}var Ya,Of;function $5(){if(Of)return Ya;Of=1;var e=S5(),t=A5(),n=t(e);return Ya=n,Ya}var Ja,qf;function C5(){if(qf)return Ja;qf=1;var e=vs(),t=x5(),n=$5();function i(o,s){return n(t(o,s,e),o+"")}return Ja=i,Ja}var Xa,Vf;function T5(){if(Vf)return Xa;Vf=1;function e(t,n,i,o){for(var s=t.length,r=i+(o?1:-1);o?r--:++r<s;)if(n(t[r],r,t))return r;return-1}return Xa=e,Xa}var Za,Ff;function E5(){if(Ff)return Za;Ff=1;function e(t){return t!==t}return Za=e,Za}var Qa,zf;function j5(){if(zf)return Qa;zf=1;function e(t,n,i){for(var o=i-1,s=t.length;++o<s;)if(t[o]===n)return o;return-1}return Qa=e,Qa}var ec,Lf;function N5(){if(Lf)return ec;Lf=1;var e=T5(),t=E5(),n=j5();function i(o,s,r){return s===s?n(o,s,r):e(o,t,r)}return ec=i,ec}var tc,Bf;function P5(){if(Bf)return tc;Bf=1;var e=N5();function t(n,i){var o=n==null?0:n.length;return!!o&&e(n,i,0)>-1}return tc=t,tc}var nc,Uf;function I5(){if(Uf)return nc;Uf=1;function e(t,n,i){for(var o=-1,s=t==null?0:t.length;++o<s;)if(i(n,t[o]))return!0;return!1}return nc=e,nc}var ic,Wf;function R5(){if(Wf)return ic;Wf=1;function e(){}return ic=e,ic}var oc,Hf;function D5(){if(Hf)return oc;Hf=1;var e=rb(),t=R5(),n=Fl(),i=1/0,o=e&&1/n(new e([,-0]))[1]==i?function(s){return new e(s)}:t;return oc=o,oc}var sc,Gf;function M5(){if(Gf)return sc;Gf=1;var e=db(),t=P5(),n=I5(),i=ub(),o=D5(),s=Fl(),r=200;function a(c,l,d){var p=-1,f=t,m=c.length,h=!0,v=[],g=v;if(d)h=!1,f=n;else if(m>=r){var b=l?null:o(c);if(b)return s(b);h=!1,f=i,g=new e}else g=l?[]:v;e:for(;++p<m;){var w=c[p],x=l?l(w):w;if(w=d||w!==0?w:0,h&&x===x){for(var y=g.length;y--;)if(g[y]===x)continue e;l&&g.push(x),v.push(w)}else f(g,x,d)||(g!==v&&g.push(x),v.push(w))}return v}return sc=a,sc}var rc,Kf;function O5(){if(Kf)return rc;Kf=1;var e=An(),t=Lt();function n(i){return t(i)&&e(i)}return rc=n,rc}var _c,Yf;function q5(){if(Yf)return _c;Yf=1;var e=y5(),t=C5(),n=M5(),i=O5(),o=t(function(s){return n(e(s,1,i,!0))});return _c=o,_c}var ac,Jf;function V5(){if(Jf)return ac;Jf=1;var e=Bl();function t(n,i){return e(i,function(o){return n[o]})}return ac=t,ac}var cc,Xf;function F5(){if(Xf)return cc;Xf=1;var e=V5(),t=$n();function n(i){return i==null?[]:e(i,t(i))}return cc=n,cc}var Lo;if(typeof d1=="function")try{Lo={clone:T4(),constant:cb(),each:R4(),filter:i5(),has:s5(),isArray:xe(),isEmpty:r5(),isFunction:cs(),isUndefined:_5(),keys:$n(),map:c5(),reduce:u5(),size:g5(),transform:w5(),union:q5(),values:F5()}}catch{}Lo||(Lo=window._);var ct=Lo,z=ct,Ul=Y,z5="\0",gn="\0",Zf="";function Y(e){this._isDirected=z.has(e,"directed")?e.directed:!0,this._isMultigraph=z.has(e,"multigraph")?e.multigraph:!1,this._isCompound=z.has(e,"compound")?e.compound:!1,this._label=void 0,this._defaultNodeLabelFn=z.constant(void 0),this._defaultEdgeLabelFn=z.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[gn]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}Y.prototype._nodeCount=0;Y.prototype._edgeCount=0;Y.prototype.isDirected=function(){return this._isDirected};Y.prototype.isMultigraph=function(){return this._isMultigraph};Y.prototype.isCompound=function(){return this._isCompound};Y.prototype.setGraph=function(e){return this._label=e,this};Y.prototype.graph=function(){return this._label};Y.prototype.setDefaultNodeLabel=function(e){return z.isFunction(e)||(e=z.constant(e)),this._defaultNodeLabelFn=e,this};Y.prototype.nodeCount=function(){return this._nodeCount};Y.prototype.nodes=function(){return z.keys(this._nodes)};Y.prototype.sources=function(){var e=this;return z.filter(this.nodes(),function(t){return z.isEmpty(e._in[t])})};Y.prototype.sinks=function(){var e=this;return z.filter(this.nodes(),function(t){return z.isEmpty(e._out[t])})};Y.prototype.setNodes=function(e,t){var n=arguments,i=this;return z.each(e,function(o){n.length>1?i.setNode(o,t):i.setNode(o)}),this};Y.prototype.setNode=function(e,t){return z.has(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._isCompound&&(this._parent[e]=gn,this._children[e]={},this._children[gn][e]=!0),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)};Y.prototype.node=function(e){return this._nodes[e]};Y.prototype.hasNode=function(e){return z.has(this._nodes,e)};Y.prototype.removeNode=function(e){var t=this;if(z.has(this._nodes,e)){var n=function(i){t.removeEdge(t._edgeObjs[i])};delete this._nodes[e],this._isCompound&&(this._removeFromParentsChildList(e),delete this._parent[e],z.each(this.children(e),function(i){t.setParent(i)}),delete this._children[e]),z.each(z.keys(this._in[e]),n),delete this._in[e],delete this._preds[e],z.each(z.keys(this._out[e]),n),delete this._out[e],delete this._sucs[e],--this._nodeCount}return this};Y.prototype.setParent=function(e,t){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(z.isUndefined(t))t=gn;else{t+="";for(var n=t;!z.isUndefined(n);n=this.parent(n))if(n===e)throw new Error("Setting "+t+" as parent of "+e+" would create a cycle");this.setNode(t)}return this.setNode(e),this._removeFromParentsChildList(e),this._parent[e]=t,this._children[t][e]=!0,this};Y.prototype._removeFromParentsChildList=function(e){delete this._children[this._parent[e]][e]};Y.prototype.parent=function(e){if(this._isCompound){var t=this._parent[e];if(t!==gn)return t}};Y.prototype.children=function(e){if(z.isUndefined(e)&&(e=gn),this._isCompound){var t=this._children[e];if(t)return z.keys(t)}else{if(e===gn)return this.nodes();if(this.hasNode(e))return[]}};Y.prototype.predecessors=function(e){var t=this._preds[e];if(t)return z.keys(t)};Y.prototype.successors=function(e){var t=this._sucs[e];if(t)return z.keys(t)};Y.prototype.neighbors=function(e){var t=this.predecessors(e);if(t)return z.union(t,this.successors(e))};Y.prototype.isLeaf=function(e){var t;return this.isDirected()?t=this.successors(e):t=this.neighbors(e),t.length===0};Y.prototype.filterNodes=function(e){var t=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});t.setGraph(this.graph());var n=this;z.each(this._nodes,function(s,r){e(r)&&t.setNode(r,s)}),z.each(this._edgeObjs,function(s){t.hasNode(s.v)&&t.hasNode(s.w)&&t.setEdge(s,n.edge(s))});var i={};function o(s){var r=n.parent(s);return r===void 0||t.hasNode(r)?(i[s]=r,r):r in i?i[r]:o(r)}return this._isCompound&&z.each(t.nodes(),function(s){t.setParent(s,o(s))}),t};Y.prototype.setDefaultEdgeLabel=function(e){return z.isFunction(e)||(e=z.constant(e)),this._defaultEdgeLabelFn=e,this};Y.prototype.edgeCount=function(){return this._edgeCount};Y.prototype.edges=function(){return z.values(this._edgeObjs)};Y.prototype.setPath=function(e,t){var n=this,i=arguments;return z.reduce(e,function(o,s){return i.length>1?n.setEdge(o,s,t):n.setEdge(o,s),s}),this};Y.prototype.setEdge=function(){var e,t,n,i,o=!1,s=arguments[0];typeof s=="object"&&s!==null&&"v"in s?(e=s.v,t=s.w,n=s.name,arguments.length===2&&(i=arguments[1],o=!0)):(e=s,t=arguments[1],n=arguments[3],arguments.length>2&&(i=arguments[2],o=!0)),e=""+e,t=""+t,z.isUndefined(n)||(n=""+n);var r=eo(this._isDirected,e,t,n);if(z.has(this._edgeLabels,r))return o&&(this._edgeLabels[r]=i),this;if(!z.isUndefined(n)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(e),this.setNode(t),this._edgeLabels[r]=o?i:this._defaultEdgeLabelFn(e,t,n);var a=L5(this._isDirected,e,t,n);return e=a.v,t=a.w,Object.freeze(a),this._edgeObjs[r]=a,Qf(this._preds[t],e),Qf(this._sucs[e],t),this._in[t][r]=a,this._out[e][r]=a,this._edgeCount++,this};Y.prototype.edge=function(e,t,n){var i=arguments.length===1?Wl(this._isDirected,arguments[0]):eo(this._isDirected,e,t,n);return this._edgeLabels[i]};Y.prototype.hasEdge=function(e,t,n){var i=arguments.length===1?Wl(this._isDirected,arguments[0]):eo(this._isDirected,e,t,n);return z.has(this._edgeLabels,i)};Y.prototype.removeEdge=function(e,t,n){var i=arguments.length===1?Wl(this._isDirected,arguments[0]):eo(this._isDirected,e,t,n),o=this._edgeObjs[i];return o&&(e=o.v,t=o.w,delete this._edgeLabels[i],delete this._edgeObjs[i],eh(this._preds[t],e),eh(this._sucs[e],t),delete this._in[t][i],delete this._out[e][i],this._edgeCount--),this};Y.prototype.inEdges=function(e,t){var n=this._in[e];if(n){var i=z.values(n);return t?z.filter(i,function(o){return o.v===t}):i}};Y.prototype.outEdges=function(e,t){var n=this._out[e];if(n){var i=z.values(n);return t?z.filter(i,function(o){return o.w===t}):i}};Y.prototype.nodeEdges=function(e,t){var n=this.inEdges(e,t);if(n)return n.concat(this.outEdges(e,t))};function Qf(e,t){e[t]?e[t]++:e[t]=1}function eh(e,t){--e[t]||delete e[t]}function eo(e,t,n,i){var o=""+t,s=""+n;if(!e&&o>s){var r=o;o=s,s=r}return o+Zf+s+Zf+(z.isUndefined(i)?z5:i)}function L5(e,t,n,i){var o=""+t,s=""+n;if(!e&&o>s){var r=o;o=s,s=r}var a={v:o,w:s};return i&&(a.name=i),a}function Wl(e,t){return eo(e,t.v,t.w,t.name)}var B5="2.1.8",U5={Graph:Ul,version:B5},St=ct,W5=Ul,H5={write:G5,read:J5};function G5(e){var t={options:{directed:e.isDirected(),multigraph:e.isMultigraph(),compound:e.isCompound()},nodes:K5(e),edges:Y5(e)};return St.isUndefined(e.graph())||(t.value=St.clone(e.graph())),t}function K5(e){return St.map(e.nodes(),function(t){var n=e.node(t),i=e.parent(t),o={v:t};return St.isUndefined(n)||(o.value=n),St.isUndefined(i)||(o.parent=i),o})}function Y5(e){return St.map(e.edges(),function(t){var n=e.edge(t),i={v:t.v,w:t.w};return St.isUndefined(t.name)||(i.name=t.name),St.isUndefined(n)||(i.value=n),i})}function J5(e){var t=new W5(e.options).setGraph(e.value);return St.each(e.nodes,function(n){t.setNode(n.v,n.value),n.parent&&t.setParent(n.v,n.parent)}),St.each(e.edges,function(n){t.setEdge({v:n.v,w:n.w,name:n.name},n.value)}),t}var vo=ct,X5=Z5;function Z5(e){var t={},n=[],i;function o(s){vo.has(t,s)||(t[s]=!0,i.push(s),vo.each(e.successors(s),o),vo.each(e.predecessors(s),o))}return vo.each(e.nodes(),function(s){i=[],o(s),i.length&&n.push(i)}),n}var yb=ct,kb=lt;function lt(){this._arr=[],this._keyIndices={}}lt.prototype.size=function(){return this._arr.length};lt.prototype.keys=function(){return this._arr.map(function(e){return e.key})};lt.prototype.has=function(e){return yb.has(this._keyIndices,e)};lt.prototype.priority=function(e){var t=this._keyIndices[e];if(t!==void 0)return this._arr[t].priority};lt.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key};lt.prototype.add=function(e,t){var n=this._keyIndices;if(e=String(e),!yb.has(n,e)){var i=this._arr,o=i.length;return n[e]=o,i.push({key:e,priority:t}),this._decrease(o),!0}return!1};lt.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var e=this._arr.pop();return delete this._keyIndices[e.key],this._heapify(0),e.key};lt.prototype.decrease=function(e,t){var n=this._keyIndices[e];if(t>this._arr[n].priority)throw new Error("New priority is greater than current priority. Key: "+e+" Old: "+this._arr[n].priority+" New: "+t);this._arr[n].priority=t,this._decrease(n)};lt.prototype._heapify=function(e){var t=this._arr,n=2*e,i=n+1,o=e;n<t.length&&(o=t[n].priority<t[o].priority?n:o,i<t.length&&(o=t[i].priority<t[o].priority?i:o),o!==e&&(this._swap(e,o),this._heapify(o)))};lt.prototype._decrease=function(e){for(var t=this._arr,n=t[e].priority,i;e!==0&&(i=e>>1,!(t[i].priority<n));)this._swap(e,i),e=i};lt.prototype._swap=function(e,t){var n=this._arr,i=this._keyIndices,o=n[e],s=n[t];n[e]=s,n[t]=o,i[s.key]=e,i[o.key]=t};var Q5=ct,eT=kb,xb=nT,tT=Q5.constant(1);function nT(e,t,n,i){return iT(e,String(t),n||tT,i||function(o){return e.outEdges(o)})}function iT(e,t,n,i){var o={},s=new eT,r,a,c=function(l){var d=l.v!==r?l.v:l.w,p=o[d],f=n(l),m=a.distance+f;if(f<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+l+" Weight: "+f);m<p.distance&&(p.distance=m,p.predecessor=r,s.decrease(d,m))};for(e.nodes().forEach(function(l){var d=l===t?0:Number.POSITIVE_INFINITY;o[l]={distance:d},s.add(l,d)});s.size()>0&&(r=s.removeMin(),a=o[r],a.distance!==Number.POSITIVE_INFINITY);)i(r).forEach(c);return o}var oT=xb,sT=ct,rT=_T;function _T(e,t,n){return sT.transform(e.nodes(),function(i,o){i[o]=oT(e,o,t,n)},{})}var th=ct,Sb=aT;function aT(e){var t=0,n=[],i={},o=[];function s(r){var a=i[r]={onStack:!0,lowlink:t,index:t++};if(n.push(r),e.successors(r).forEach(function(d){th.has(i,d)?i[d].onStack&&(a.lowlink=Math.min(a.lowlink,i[d].index)):(s(d),a.lowlink=Math.min(a.lowlink,i[d].lowlink))}),a.lowlink===a.index){var c=[],l;do l=n.pop(),i[l].onStack=!1,c.push(l);while(r!==l);o.push(c)}}return e.nodes().forEach(function(r){th.has(i,r)||s(r)}),o}var cT=ct,lT=Sb,dT=uT;function uT(e){return cT.filter(lT(e),function(t){return t.length>1||t.length===1&&e.hasEdge(t[0],t[0])})}var pT=ct,mT=hT,fT=pT.constant(1);function hT(e,t,n){return vT(e,t||fT,n||function(i){return e.outEdges(i)})}function vT(e,t,n){var i={},o=e.nodes();return o.forEach(function(s){i[s]={},i[s][s]={distance:0},o.forEach(function(r){s!==r&&(i[s][r]={distance:Number.POSITIVE_INFINITY})}),n(s).forEach(function(r){var a=r.v===s?r.w:r.v,c=t(r);i[s][a]={distance:c,predecessor:s}})}),o.forEach(function(s){var r=i[s];o.forEach(function(a){var c=i[a];o.forEach(function(l){var d=c[s],p=r[l],f=c[l],m=d.distance+p.distance;m<f.distance&&(f.distance=m,f.predecessor=p.predecessor)})})}),i}var hi=ct,Ab=$b;$b.CycleException=Bo;function $b(e){var t={},n={},i=[];function o(s){if(hi.has(n,s))throw new Bo;hi.has(t,s)||(n[s]=!0,t[s]=!0,hi.each(e.predecessors(s),o),delete n[s],i.push(s))}if(hi.each(e.sinks(),o),hi.size(t)!==e.nodeCount())throw new Bo;return i}function Bo(){}Bo.prototype=new Error;var nh=Ab,gT=wT;function wT(e){try{nh(e)}catch(t){if(t instanceof nh.CycleException)return!1;throw t}return!0}var Uo=ct,Cb=bT;function bT(e,t,n){Uo.isArray(t)||(t=[t]);var i=(e.isDirected()?e.successors:e.neighbors).bind(e),o=[],s={};return Uo.each(t,function(r){if(!e.hasNode(r))throw new Error("Graph does not have node: "+r);Tb(e,r,n==="post",s,i,o)}),o}function Tb(e,t,n,i,o,s){Uo.has(i,t)||(i[t]=!0,n||s.push(t),Uo.each(o(t),function(r){Tb(e,r,n,i,o,s)}),n&&s.push(t))}var yT=Cb,kT=xT;function xT(e,t){return yT(e,t,"post")}var ST=Cb,AT=$T;function $T(e,t){return ST(e,t,"pre")}var ih=ct,CT=Ul,TT=kb,ET=jT;function jT(e,t){var n=new CT,i={},o=new TT,s;function r(c){var l=c.v===s?c.w:c.v,d=o.priority(l);if(d!==void 0){var p=t(c);p<d&&(i[l]=s,o.decrease(l,p))}}if(e.nodeCount()===0)return n;ih.each(e.nodes(),function(c){o.add(c,Number.POSITIVE_INFINITY),n.setNode(c)}),o.decrease(e.nodes()[0],0);for(var a=!1;o.size()>0;){if(s=o.removeMin(),ih.has(i,s))n.setEdge(s,i[s]);else{if(a)throw new Error("Input graph is not connected: "+e);a=!0}e.nodeEdges(s).forEach(r)}return n}var NT={components:X5,dijkstra:xb,dijkstraAll:rT,findCycles:dT,floydWarshall:mT,isAcyclic:gT,postorder:kT,preorder:AT,prim:ET,tarjan:Sb,topsort:Ab},oh=U5,to={Graph:oh.Graph,json:H5,alg:NT,version:oh.version};const Eb=u1(to),PT=h1({__proto__:null,default:Eb},[to]),IT=(Eb||PT).alg;function RT(e){const{items:t,get_id:n,get_head_ids:i,get_tail_ids:o}=e,s=new to.Graph;t.forEach(a=>s.setNode(n(a),a));const r=a=>s.hasNode(a);return t.forEach(a=>{const c=n(a);i(a).filter(r).forEach(l=>s.setEdge(c,l)),o(a).filter(r).forEach(l=>s.setEdge(l,c))}),s}function sh(e){const{graph:t}=e,n=DT({graph:t}),i=[];return n.forEach(o=>{Di(o).forEach(r=>{const a=[r,...jt(t,r)];i.push(a)})}),i}function DT(e){const{graph:t}=e;return IT.components(t).map(i=>{const o=new to.Graph;return i.forEach(s=>{o.setNode(s,t.node(s)),(t.nodeEdges(s)||[]).forEach(a=>o.setEdge(a))}),o})}function Di(e){return e.nodes().filter(n=>(e.successors(n)||[]).length===0)}function jt(e,t,n=!1){const i=e.predecessors(t)||[],o=new Set;let s=i.pop()||"";for(;s;){if(!o.has(s)&&(n||s!==t)){o.add(s);const r=e.predecessors(s)||[];i.push(...r)}s=i.pop()||""}return Array.from(o)}function go(e,t){const n=Di(e),i=to.alg.dijkstra(e,t);return n.filter(o=>i[o].distance<Number.POSITIVE_INFINITY)}const MT=k.delay("graph related functions",()=>{const e=b=>b.id,t=b=>b.head_ids,n=b=>b.tail_ids,i=b=>RT({items:b,get_id:e,get_head_ids:t,get_tail_ids:n});function o(b,w,x){u(b.node(w),x.item);const y=b.outEdges(w)||[];u(y.map(C=>C.w),x.head_ids);const $=b.inEdges(w)||[];u($.map(C=>C.v),x.tail_ids)}function s(){const b=[{id:"1",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function r(){const b=[{id:"1",head_ids:["2","4"],tail_ids:[]},{id:"2",head_ids:["1","3"],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function a(){const b=[{id:"1",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:[],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:["5"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function c(){const b=[{id:"1",head_ids:[],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["4"],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:["5"],tail_ids:[]},{id:"7",head_ids:["6"],tail_ids:[]},{id:"8",head_ids:["10"],tail_ids:[]},{id:"9",head_ids:["8"],tail_ids:[]},{id:"10",head_ids:["9"],tail_ids:[]},{id:"11",head_ids:["12","13"],tail_ids:["12","13"]},{id:"12",head_ids:["11","13"],tail_ids:["11","13"]},{id:"13",head_ids:["12","11"],tail_ids:["12","11"]},{id:"14",head_ids:["14"],tail_ids:["14"]},{id:"15",head_ids:[],tail_ids:["16"]},{id:"16",head_ids:[],tail_ids:[]},{id:"17",head_ids:["16"],tail_ids:[]},{id:"15b",head_ids:[],tail_ids:[]},{id:"16b",head_ids:["15b"],tail_ids:["17b"]},{id:"17b",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function l(){const b=[{id:"4",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["2","1","4","7"],tail_ids:[]},{id:"1",head_ids:["5","6","9"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:[],tail_ids:[]},{id:"7",head_ids:["8"],tail_ids:[]},{id:"8",head_ids:["7"],tail_ids:[]},{id:"9",head_ids:["5"],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function d(){const b=[{id:"1",head_ids:["2"],tail_ids:["3"]}],w=i(b);return{items:b,graph:w}}const p=s(),f=c(),m=r(),h=a(),v=l(),g=d();k("graph",()=>{o(p.graph,"0",{item:void 0,head_ids:[],tail_ids:[]}),o(p.graph,"1",{item:p.items[0],head_ids:[],tail_ids:[]}),o(f.graph,"1",{item:f.items[0],head_ids:[],tail_ids:[]}),o(f.graph,"2",{item:f.items[1],head_ids:["3"],tail_ids:[]}),o(f.graph,"3",{item:f.items[2],head_ids:["4"],tail_ids:["2"]}),o(f.graph,"4",{item:f.items[3],head_ids:[],tail_ids:["3"]}),o(f.graph,"5",{item:f.items[4],head_ids:[],tail_ids:["6"]}),o(f.graph,"6",{item:f.items[5],head_ids:["5"],tail_ids:["7"]}),o(f.graph,"7",{item:f.items[6],head_ids:["6"],tail_ids:[]}),o(f.graph,"8",{item:f.items[7],head_ids:["10"],tail_ids:["9"]}),o(f.graph,"9",{item:f.items[8],head_ids:["8"],tail_ids:["10"]}),o(f.graph,"10",{item:f.items[9],head_ids:["9"],tail_ids:["8"]}),o(f.graph,"11",{item:f.items[10],head_ids:["12","13"],tail_ids:["12","13"]}),o(f.graph,"12",{item:f.items[11],head_ids:["11","13"],tail_ids:["11","13"]}),o(f.graph,"13",{item:f.items[12],head_ids:["11","12"],tail_ids:["11","12"]}),o(f.graph,"14",{item:f.items[13],head_ids:["14"],tail_ids:["14"]}),o(f.graph,"15",{item:f.items[14],head_ids:[],tail_ids:["16"]}),o(f.graph,"16",{item:f.items[15],head_ids:["15"],tail_ids:["17"]}),o(f.graph,"17",{item:f.items[16],head_ids:["16"],tail_ids:[]}),o(f.graph,"15b",{item:f.items[17],head_ids:[],tail_ids:["16b"]}),o(f.graph,"16b",{item:f.items[18],head_ids:["15b"],tail_ids:["17b"]}),o(f.graph,"17b",{item:f.items[19],head_ids:["16b"],tail_ids:[]}),o(g.graph,"1",{item:g.items[0],head_ids:[],tail_ids:[]})}),k("find_leaf_ids",()=>{u(Di(m.graph),["3","4"]),u(Di(h.graph),["2","3","5"]),u(Di(v.graph),["5","6"])}),k("find_leaf_ids_for_id",()=>{u(go(v.graph,"12"),[]),u(go(v.graph,"1"),["5","6"]),u(go(v.graph,"2"),["5","6"]),u(go(v.graph,"7"),[])}),k("find_leaf_group_ids",()=>{u(sh(p),[["1"]]),u(sh(m),[["3","2","1"],["4","1","2"]])}),k("find_all_predecessor_ids",()=>{u(jt(p.graph,"1"),[]),u(jt(m.graph,"1"),["2"]),u(jt(m.graph,"2"),["1"]),u(jt(m.graph,"3"),["2","1"]),u(jt(m.graph,"4"),["1","2"]),u(jt(v.graph,"2"),["4","3"]),u(jt(v.graph,"8"),["7","3","2","4"]),u(jt(v.graph,"5"),["9","1","3","2","4"])})});function Rn(e,t={}){const n=t.sort_items??!1,i=t.render_undefined??!1,o=typeof t.space=="number"?Array(t.space+1).join(" "):t.space||"",s=typeof t.cycles=="boolean"?t.cycles:!1,r=t.replacer||((l,d)=>OT(d)?d.toISOString():d instanceof Set?Array.from(d).sort():d),a=t.comparison_function&&function(l){return function(d,p){return t.comparison_function({key:d,value:l[d]},{key:p,value:l[p]})}},c=[];return function l(d,p,f,m){const h=o?`
`+new Array(m+1).join(o):"",v=o?": ":":";if(f=r.call(d,p,f),f===void 0)return i?"undefined":void 0;if(typeof f!="object"||f===null)return JSON.stringify(f);if(Array.isArray(f)){const w=[];for(let x=0;x<f.length;x++){const y=l(f,x,f[x],m+1)||JSON.stringify(null);w.push(h+o+y)}return"["+w.join(",")+h+"]"}if(c.indexOf(f)!==-1){if(s)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else c.push(f);let g=Object.keys(f);n&&(g=g.sort(a&&a(f)));const b=[];return g.forEach(w=>{const x=l(f,w,f[w],m+1);if(!x)return;const y=JSON.stringify(w)+v+x;b.push(h+o+y)}),c.splice(c.indexOf(f),1),"{"+b.join(",")+h+"}"}({"":e},"",e,0)}function OT(e){return Object.prototype.toString.call(e)==="[object Date]"}const qT=k.delay("stable_stringify",()=>{let e="";e=Rn({a:1,b:2,c:3}),u(e,'{"a":1,"b":2,"c":3}',"regular object"),e=Rn({c:3,b:2,a:1}),u(e,'{"c":3,"b":2,"a":1}',"regular object with keys in reverse order remains unchanged by default"),e=Rn({c:3,b:2,a:1},{sort_items:!0}),u(e,'{"a":1,"b":2,"c":3}',"regular object with keys in reverse order are sorted if requested"),e=Rn({a:{b:{c:3}}}),u(e,'{"a":{"b":{"c":3}}}',"nested object"),e=Rn({a:void 0}),u(e,"{}","object with undefined not rendered by default"),e=Rn({a:void 0},{render_undefined:!0}),u(e,'{"a":undefined}',"object with undefined rendered when render_undefined is true")}),VT=k.delay("test sync",()=>{u(!0,!0,"should handle sync")}),FT=k.delay("test async",async()=>{await new Promise(e=>setTimeout(e,0)),u(!0,!0,"should handle async"),await k("test nested async",async()=>{await new Promise(e=>setTimeout(e,0)),u(!0,!0,"should handle nested async")}),k("test sync nested in async",()=>{u(!0,!0,"should handle sync nested in async")})});function Ae(e){let t,n;const{conviction:i,probability:o,counterfactual_conviction:s,counterfactual_probability:r}=e,a=r===void 0&&s===void 0;return i!==1&&(n=1),a&&(o===1&&i!==1||o!==1)?t=1:r!==0&&(o===0&&i!==1||o!==0)?t=0:(t=void 0,n=void 0),{new_counterfactual_probability:t,new_counterfactual_conviction:n}}const zT=k.delay("calc_new_counterfactual_state",()=>{let e,t,n,i,o;e=.5,t=1,o=Ae({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=1,t=1,o=Ae({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=0,t=1,o=Ae({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,void 0),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=.5,t=.5,o=Ae({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=1,t=.5,o=Ae({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0),e=0,t=.5,o=Ae({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,u(o.new_counterfactual_probability,n),u(o.new_counterfactual_conviction,i),o=Ae({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),u(o.new_counterfactual_probability,void 0),u(o.new_counterfactual_conviction,void 0)}),LT=/^(([ ]{0,3}```)|([ ]{4,})).*/gm,rh=/^[ \t]*(\*|\d+\.)/gm,_h=/^[ \t]*[^\s]+/gm;function Yt(e){const t=[];let n=!1;const i=e.split(`
`);return i.forEach((s,r)=>{if(r>0){const a=i[r-1];a.match(LT)&&(n=!n),n||a.match(_h)&&!a.match(rh)&&(s.match(rh)?t[r-1]=a+`
`:s.match(_h)&&(t[r-1]=a+"<br>"))}t.push(s)}),t.join(`
`)}const BT=k.delay("add_newlines_to_markdown",()=>{u(Yt(`
test 1
test2
`),`
test 1<br>
test2
`);const e=`* Test bullet 1
* Test bullet 2`;u(Yt(e),e);let n=Yt(`Test 1
Test
  Test 3  
	Test 4
* Test bullet 1
* Test bullet 2

Test 5
1. Test number 1
2. Test number 2

`),i=`Test 1<br>
Test<br>
  Test 3  <br>
	Test 4

* Test bullet 1
* Test bullet 2

Test 5

1. Test number 1
2. Test number 2

`;u(n,i),k("Code blocks should not contain <br>",()=>{n=Yt("\n```\nsome text\n```\n"),i="\n```\nsome text\n```\n",u(n,i,"Three ``` should stop <br> insertion"),n=Yt("\n   ```\nsome text\n```\n"),i="\n   ```\nsome text\n```\n",u(n,i,"Three ``` with three prepended spaces should stop <br> insertion"),n=Yt(`
   more text
   some more text
`),i=`
   more text<br>
   some more text
`,u(n,i,"Three prepended spaces for normal text should allow <br> insertion"),n=Yt("\n    ```some text\n    some more text\n"),i="\n    ```some text\n    some more text\n",u(n,i,"Four prepended spaces for ``` and normal text should stop <br> insertion")})}),UT=k.delay("run_get_rich_text",()=>{let e;k("replace_ids_in_text",()=>{const t=_e(1),n=_e(2),i=_e(3),s=new Date("2021-05-12").getTime(),r={[t]:Rt({base_id:-1,id:t,title:`@@${i} was told @@${n} is here`}),[n]:Rt({base_id:-1,id:n,title:"Person A"}),[i]:Rt({base_id:-1,id:i,title:"Person B"})},a={},c={text_type:pe.rich,wcomponents_by_id:r,knowledge_views_by_id:a,wc_id_to_counterfactuals_map:void 0,created_at_ms:s,sim_ms:s};e=zn({...c,text_type:pe.raw,text:`Yesterday @@${t} today`}),u(e,`Yesterday @@${t} today`,"Should not replace ids when text_type is RichTextType.raw"),e=zn({...c,text_type:pe.plain,text:`Yesterday @@${t} today`}),u(e,"Yesterday Person B was told Person A is here today","Should replace ids with only text and no links when text_type is RichTextType.plain"),e=zn({...c,text_type:pe.rich,text:`Yesterday @@${t} today`}),u(e,`Yesterday [Person B was told Person A is here](#wcomponents/${t}) today`,"Should replace ids with text and links when text_type is RichTextType.rich.  And should not render lower depth links so as not to have nested broken links.")}),k("get_title",()=>{const t=new Date("2021-05-12"),n=t.getTime(),i=A=>{const M={id:"vps"+A.id,created_at:t,base_id:-1,datetime:{},entries:[{id:"VAP"+A.id,explanation:"",probability:1,conviction:1,value:"",description:""}]};return Rt({...A,base_id:-1,type:"statev2",subtype:"boolean",values_and_prediction_sets:[M]})},o=_e(1),s=_e(2),r=_e(3),a=_e(4),c=_e(5),l=_e(6),d=_e(7),p=_e(8),f=_e(9),m=i({id:o,title:"aaa"}),h=i({id:s,title:`bbb @@${o}`}),v=i({id:r,title:"ccc ${value}"}),g=i({id:a,title:`ddd @@${r}`}),b=i({id:c,title:`eee \${value} @@${a}`}),w=i({id:l,title:`fff @@${c}`}),x=i({id:d,title:`ggg @@${l}`}),y=i({id:p,title:`Recursive @@${p}`}),$=i({id:f,title:`Recursive @@${f}.title`}),C={[m.id]:m,[h.id]:h,[v.id]:v,[g.id]:g,[b.id]:b,[w.id]:w,[x.id]:x,[y.id]:y,[$.id]:$},E={};function N(A){const{id:M,text_type:D,wc_id_to_counterfactuals_map:T}=A;return at({text_type:D,wcomponents_by_id:C,knowledge_views_by_id:E,wcomponent:C[M],wc_id_to_counterfactuals_map:T,created_at_ms:n,sim_ms:n})}k("get_title",()=>{const A={[m.id]:"aaa",[h.id]:`bbb @@${o}`,[v.id]:"ccc ${value}",[g.id]:`ddd @@${r}`,[b.id]:`eee \${value} @@${a}`},M={[m.id]:"aaa",[h.id]:"bbb aaa",[v.id]:"ccc True",[g.id]:"ddd ccc True",[b.id]:"eee True ddd ccc True"},D={[m.id]:"aaa",[h.id]:`bbb [aaa](#wcomponents/${o})`,[v.id]:"ccc True",[g.id]:`ddd [ccc True](#wcomponents/${r})`,[b.id]:`eee True [ddd ccc True](#wcomponents/${a})`};Object.entries(A).forEach(([T,L])=>{e=N({id:T,text_type:pe.raw}),u(e,L)}),Object.entries(M).forEach(([T,L])=>{e=N({id:T,text_type:pe.plain}),u(e,L)}),Object.entries(D).forEach(([T,L])=>{e=N({id:T,text_type:pe.rich}),u(e,L)})}),k("depth_limit",()=>{e=N({id:x.id,text_type:pe.rich}),u(e,`ggg [fff eee True ddd @@${r}](#wcomponents/${l})`,"Should stop recursively rendering ids when a depth limit is reached"),e=N({id:y.id,text_type:pe.rich}),u(e,"Recursive [Recursive Recursive Recursive @@80000000-0000-4000-a000-000000000000](#wcomponents/80000000-0000-4000-a000-000000000000)","Should handle recursion for normal recursive titles."),e=N({id:$.id,text_type:pe.rich}),u(!0,!0,"Should handle recursion for '.title' functional ids of recursive titles.")}),k("counterfactuals",()=>{const A={[v.id]:"ccc False",[g.id]:`ddd [ccc False](#wcomponents/${r})`,[b.id]:`eee True [ddd ccc False](#wcomponents/${a})`},M={[v.id]:{VAP_sets:{[`vps${r}`]:[{id:"wc999000",type:"counterfactualv2",created_at:t,base_id:-1,title:"",description:"",target_wcomponent_id:v.id,target_VAP_set_id:`vps${r}`,target_VAP_id:Nw}]}}};Object.entries(A).forEach(([D,T])=>{e=N({id:D,text_type:pe.rich,wc_id_to_counterfactuals_map:M}),u(e,T,"Should override values correctly using counterfactualv2 value")})})}),k.skip("replace_ids_in_text -> replace_calculations_with_results",()=>{const t=_e(1),i=new Date("2023-08-14").getTime(),o={[t]:Rt({base_id:-1,id:t,title:"UK Homes"})},s={},r={text_type:pe.rich,wcomponents_by_id:o,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:void 0,created_at_ms:i,sim_ms:i},c=zn({...r,text:`
    $$!
    value: 123
    $$!
    `});u(c,`
123
`,"Should replace calculation with string value")})}),WT=k.delay("remove_rich_text",()=>{let e,t,n;e="Something [linked](http://example.com).",t=Xt(e),n="Something linked.",u(t,n,"Should remove links in middle"),e="[Linked](http://example.com) here.",t=Xt(e),n="Linked here.",u(t,n,"Should remove links at start"),e="[Linked](http://example.com) here and [here](https://other.example.com)",t=Xt(e),n="Linked here and here",u(t,n,"Should remove multiple links at start"),e="<auto generated>Text with <auto generated> in it <auto generated>",t=Xt(e),n="Text with in it",u(t,n,"Should remove <auto generated> tags"),e="Italicised <i>text<i/>",t=Xt(e),n="Italicised text",u(t,n,"Should remove tags")}),HT=k.delay("replace_normal_ids",()=>{let e="",t="",n="";const i=_e(1),o=_e(9),s={[i]:Rt({base_id:-1,id:i,title:"Title 1"})};let r;k("render_links: true",()=>{r={wcomponents_by_id:s,depth_limit:2,render_links:!0,root_url:"http://datacurator.org",get_title:a=>a.title},e="",n="",t=Kt(e,1,r),u(t,n,"Should handle replacing ids in empty string"),e=`Some text
    with an @@id in
    it: @@${i}.
    `,n=`Some text
    with an @@id in
    it: [Title 1](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).
    `,t=Kt(e,1,r),u(t,n,"Should replace id with component title"),e=`An @@id to a component that's not found: @@${o}.`,n="An @@id to a component that's not found: ✗[@@90000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/90000000-0000-4000-a000-000000000000) (not found).",t=Kt(e,1,r),u(t,n,"Should handle missing components"),e=`Out of depth @@${i}.`,n="Out of depth [@@10000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).",t=Kt(e,2,r),u(t,n,"Should not replace with component title when depth is exceeded")}),k("render_links: false",()=>{r={wcomponents_by_id:s,depth_limit:2,render_links:!1,root_url:"http://datacurator.org",get_title:a=>a.title},e=`Some @@id: @@${i}.`,n="Some @@id: Title 1.",t=Kt(e,1,r),u(t,n,"Should replace id with component title but no link when render_links is false"),e=`An @@id to a component that's not found: @@${o}.`,n="An @@id to a component that's not found: ✗@@90000000-0000-4000-a000-000000000000 (not found).",t=Kt(e,1,r),u(t,n,"Should handle missing components but not add link when render_links is false"),e=`Out of depth @@${i}.`,n="Out of depth @@10000000-0000-4000-a000-000000000000.",t=Kt(e,2,r),u(t,n,"Should not replace with component title when depth is exceeded and not add link when render_links is false")})}),GT=k.delay("derived_composed_wcomponents_by_id_reducer",()=>{const e=new Date("2023-10-05"),t=new Date("2023-10-06"),n=new Date("2023-10-07"),i=_e(1),o=_e(2),s=_e(3);let r,a,c,l,d,p;function f(v){return O({base_id:-1,type:"statev2",...v})}function m(v){return O({base_id:-1,type:"state_value",...v})}function h(v,g,b){let w=Qt();const x=Fe({base_id:-1,id:s,title:"Test KV",sort_type:"priority"}),y=Ii(w);return w=y(w,S.specialised_object.upsert_knowledge_view({knowledge_view:x})),w=y(w,S.routing.change_route({args:{view:"knowledge",subview_id:x.id}})),w=y(w,S.specialised_object.upsert_wcomponent({wcomponent:v,add_to_knowledge_view:{id:x.id,position:{left:0,top:0}}})),w=y(w,S.specialised_object.upsert_wcomponent({wcomponent:g,add_to_knowledge_view:{id:x.id,position:{left:300,top:0}}})),b&&(w=y(w,S.routing.change_route({args:{created_at_datetime:b}}))),w}a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:t,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),k("state_value VAPs should be composed into statev2 wcomponent",()=>{var v;r=h(a,c,n),l=r.derived.composed_wcomponents_by_id,d=l[a.id],p=(d==null?void 0:d.values_and_prediction_sets)||[],u((v=p[0])==null?void 0:v.id,"vps22222","The composed wcomponent should have VAP sets from the state value component that targets it"),u(d==null?void 0:d._derived__using_value_from_wcomponent_id,c.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set to the state_value's ID")}),k("Components created after current created_at datetime are still present in composed_wcomponents_by_id",()=>{r=h(a,c,e),l=r.derived.composed_wcomponents_by_id,u(a.created_at.getTime()>r.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_statev2 wcomponent based on its created_at"),u(c.created_at.getTime()>r.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_state_value wcomponent based on its created_at"),u(new Set(Object.keys(l)),new Set([i,o]),"derived.composed_wcomponents_by_id should still contain the components when the created_at filter is set to before the created_at of the two components")}),k("state_value created after statev2 and filtered out by created_at datetime",()=>{var v;a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:n,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:n,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),r=h(a,c,t),l=r.derived.composed_wcomponents_by_id,d=l[a.id],p=(d==null?void 0:d.values_and_prediction_sets)||[],u((v=p[0])==null?void 0:v.id,"vps1","The composed wcomponent should have VAP sets from the original statev2 component as the state_value that targets it should be filtered out based on created_at time"),u(d==null?void 0:d._derived__using_value_from_wcomponent_id,void 0,"The composed wcomponent should NOT have _derived__using_value_from_wcomponent_id set")}),k("state_value VAPs filtered out by created_at datetime",()=>{a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:n,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),r=h(a,c,t),l=r.derived.composed_wcomponents_by_id,d=l[a.id],p=(d==null?void 0:d.values_and_prediction_sets)||[],u(p.length,0,"The composed wcomponent should have VAP sets from the state_value component that targets it but these VAPs should be filtered out based on created_at time"),u(d==null?void 0:d._derived__using_value_from_wcomponent_id,c.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set")})}),KT=k.delay("get_composed_wcomponents_by_id",()=>{var l;const t=new Date("2024-10-08"),n=Te(P.number,{1:{id:"1",order:1,value:"10",description:""}},[],-1);n.created_at=t;const i=O({type:"statev2",base_id:-1,values_and_prediction_sets:[n]});i.created_at=t;const o=Te(P.number,{2:{id:"2",order:1,value:"20",description:""}},[],-1);o.created_at=t;const s=O({type:"state_value",base_id:-1,values_and_prediction_sets:[o],attribute_wcomponent_id:i.id});s.created_at=t;const a=iw({wcomponents_by_id:{[i.id]:i,[s.id]:s},composed_visible_wc_id_map:{[i.id]:{left:0,top:0},[s.id]:{left:0,top:0}},created_at_ms:t.getTime()})[i.id];if(!Ye(a))throw new Error("Expected composed wcomponent to be statev2");u(a._derived__using_value_from_wcomponent_id,s.id,"should populate the _derived__using_value_from_wcomponent_id field of the statev2 with the id of the state_value component that is targeting it.");const c=(a.values_and_prediction_sets||[])[0];u((l=c==null?void 0:c.entries[0])==null?void 0:l.value,"20","should replace the VAP set of a statev2 with the VAP set of the state_value component that is targeting it.")}),YT=k.delay("calc_if_wcomponent_should_exclude_because_label_or_type",()=>{const e=O({id:"1",base_id:1}),t=O({id:"2",base_id:1,label_ids:[e.id]}),n=O({id:"3",base_id:1,label_ids:[]}),i={exclude_by_label_ids:new Set,include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},o={exclude_by_label_ids:new Set([e.id]),include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},s={exclude_by_label_ids:new Set,include_by_label_ids:new Set([e.id]),exclude_by_component_types:new Set,include_by_component_types:new Set},r={exclude_by_label_ids:new Set([e.id]),include_by_label_ids:new Set([e.id]),exclude_by_component_types:new Set,include_by_component_types:new Set};let{should_exclude:a,lacks_include:c}=Nt(t,i);u(a,!1),u(c,!1),{should_exclude:a,lacks_include:c}=Nt(t,o),u(a,!0),u(c,!1),{should_exclude:a,lacks_include:c}=Nt(t,s),u(a,!1),u(c,!1),{should_exclude:a,lacks_include:c}=Nt(n,s),u(a,!1),u(c,!0),{should_exclude:a,lacks_include:c}=Nt(t,r),u(a,!0),u(c,!1),{should_exclude:a,lacks_include:c}=Nt(e,o),u(a,!0),u(c,!1),{should_exclude:a,lacks_include:c}=Nt(e,s),u(a,!1),u(c,!1)}),ln=_e(1);function wo(e,t,n){const o={id:t,foundation_knowledge_view_ids:n?[n]:void 0,wc_id_map:{},title:"",description:"",sort_type:"normal",created_at:new Date("2023-03-22 15:15:00"),base_id:1};return e&&(o.wc_id_map[ln]=e),o}const JT=k.delay("get_composed_wc_id_maps_object",()=>{const e=new Date("2023-03-22 15:15:00");let t;t=st([],{}),u(t,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}});const i=[{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, defined in foundation, ",test_description_part2:"should return entry in foundation"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"missing in current, blocked in foundation, ",test_description_part2:"should return entry in blocked"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, missing in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, defined in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, passthrough in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, blocked in foundation, ",test_description_part2:"should return entry in current not foundation and NOT show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, defined in foundation, ",test_description_part2:"should return (passthrough) entry from foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"passthrough entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, missing in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, defined in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"}];i.forEach(o=>{const s=wo(o.kv_wc_entry_in_foundation_kv,"kv1"),r=wo(o.kv_wc_entry_in_current_kv,"kv2","kv1");t=st([s,r],{}),u(t.composed_wc_id_map[ln],o.expected_result_in_composed_wc_id_map,"composed_wc_id_map "+o.test_description+o.test_description_part2),u(t.composed_blocked_wc_id_map[ln],o.expected_result_in_composed_blocked_wc_id_map,"composed_blocked_wc_id_map "+o.test_description+o.test_description_part2)}),k("deleted wcomponent",()=>{i.forEach(o=>{const s=wo(o.kv_wc_entry_in_foundation_kv,"kv1"),r=wo(o.kv_wc_entry_in_current_kv,"kv2","kv1");t=st([s,r],{[ln]:{id:ln,deleted_at:e,type:"statev2",title:"",description:"",created_at:e,base_id:1}}),u(t.composed_wc_id_map[ln],void 0,"composed_wc_id_map "+o.test_description+"should not return any entry"),u(t.composed_blocked_wc_id_map[ln],void 0,"composed_blocked_wc_id_map "+o.test_description+"should not return any entry")})})}),XT=k.delay("knowledge_views_derived_reducer",()=>{k("calculate_wc_ids_to_exclude_based_on_filters",()=>{const e={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""},t=new Set,n=O({id:"node1",base_id:-1,type:"statev2",label_ids:[]}),i=O({id:"node2",base_id:-1,type:"statev2",label_ids:["123"]}),o=[n,i],s=O({id:"link1_no_label",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),r=O({id:"link2_no_label_no_from",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),a=O({id:"link3_no_label_no_to",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),c=O({id:"link4_has_label",base_id:-1,type:"causal_link",label_ids:["123"],from_id:n.id,to_id:i.id}),l=O({id:"link5_has_label_no_from",base_id:-1,type:"causal_link",label_ids:["123"],from_id:void 0,to_id:i.id}),d=O({id:"link6_has_label_no_to",base_id:-1,type:"causal_link",label_ids:["123"],from_id:i.id,to_id:void 0}),p=[s,r,a,c,l,d];let f=Ic(e,t,o,p);u(f,new Set,"no filters"),e.include_by_label_ids=["123"],f=Ic(e,t,o,p),u(f,new Set([n.id,s.id,r.id,a.id,c.id]),"filter out components not labelled")})}),ah="#views/&storage_location=32&subview_id=e9b59c81-002f-4262-b6b1-995399a7606f&view=knowledge&x=110&y=32&zoom=90&sdate=2025-06-12&stime=16:19:59&cdate=2025-06-19&ctime=01:14:15",Ei={get_date:()=>new Date("2025-06-19T00:00:00Z"),get_url:()=>`http://localhost:5173/app/${ah}`,get_url_hash:()=>ah,get_persisted_state_object:e=>({})},ZT=k.delay("get_starting_state",()=>{let e=Qt();u(!!e,!0),e=Qt(Ei),u(e.routing.route,"views","should use the fixture route"),u(e.routing.args.storage_location,32,"should use the fixture storage location")});function QT(e){return{...e,user_info:{...e.user_info,bases_by_id:{[32]:{id:32,title:"Test Base",inserted_at:new Date("2024-01-01T00:00:00Z"),updated_at:new Date("2024-01-01T00:00:00Z"),owner_user_id:"user123",public_read:!0,access_level:"editor",can_edit:!0}}}}}const eE=k.delay("display_reducer",()=>{let e=Qt(Ei);k("default initial state",()=>{u(e.display_options.consumption_formatting,!0,"default consumption formatting to true"),u(e.display_options.circular_links,!0,"default circular links to true"),u(e.display_options.show_large_grid,!1,"default show large grid to false"),u(e.display_options.focused_mode,!1,"default focused mode to false"),u(e.display_options.display_time_marks,!1,"default display time marks to false"),u(e.display_options.animate_connections,!1,"default animate connections to false"),u(e.display_options.show_help_menu,!1,"default show help menu to false"),u(e.toast_message.warn_can_not_edit_ms,void 0,"warn_can_not_edit_ms should be undefined")}),k("toggle consumption formatting",()=>{e=Qt(Ei),e=QT(e);const t=Ii(e);e=t(e,{type:"toggle_consumption_formatting"}),u(e.display_options.consumption_formatting,!1,"should toggle consumption formatting to false"),u(e.toast_message.warn_can_not_edit_ms,void 0,"warn_can_not_edit_ms should remain undefined"),e=t(e,{type:"toggle_consumption_formatting"}),u(e.display_options.consumption_formatting,!0,"should toggle consumption formatting to true"),u(e.toast_message.warn_can_not_edit_ms,void 0,"warn_can_not_edit_ms should remain undefined")}),k("consumption formatting toggle is ignored when can not edit",()=>{e=Qt(Ei);const t=Ii(e),n=new Date().getTime();e.display_options.consumption_formatting=!0,u(Vi(e),!0,"assert can not edit is true"),e=t(e,{type:"toggle_consumption_formatting"}),u(e.display_options.consumption_formatting,!0,"toggle consumption formatting should be ignored when can not edit"),u((e.toast_message.warn_can_not_edit_ms||0)>=n,!0,"warn_can_not_edit_ms should be defined and greater than or equal to now")}),k("consumption formatting toggle is forced to true when can not edit",()=>{e=Qt(Ei);const t=Ii(e);e.display_options.consumption_formatting=!1,u(Vi(e),!0,"assert can not edit is true"),e=t(e,{type:"toggle_consumption_formatting"}),u(e.display_options.consumption_formatting,!0,"toggle consumption formatting should be ignored when can not edit"),u(e.toast_message.warn_can_not_edit_ms,void 0,"warn_can_not_edit_ms should remain undefined")}),k.skip("when consumption formatting is true and the base (project) loads and user can not edit then force consumption formatting to false",()=>{})}),tE=k.delay("specialised_objects accessors tests",()=>{k("get_current_temporal_value_certainty_from_wcomponent",()=>{const e=new Date("2023-10-09"),t=new Date("2023-10-10");let n,i,o,s;function r(a,c){const l=O({base_id:-1,created_at:e,type:"statev2",values_and_prediction_sets:a}),d={[l.id]:l};return rl(l.id,d,c)}i=e.getTime(),o=r(void 0,i),s=void 0,u(o,s,"No VAP sets should result in undefined value"),i=e.getTime(),o=r([],i),s=void 0,u(o,s,"Empty VAP sets should result in undefined value"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,entries:[],datetime:{}}],o=r(n,i),s={certainty:void 0,temporal_uncertainty:{}},u(o,s,"VAP sets with one VAPset should result in that VAP set's empty datetime being returned"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,entries:[],datetime:{value:t}}],o=r(n,i),s={certainty:void 0,temporal_uncertainty:{value:t}},u(o,s,"VAP sets with one VAPset should result in that VAP set's datetime and value being returned"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:t,datetime:{},entries:[]}],o=r(n,i),s=void 0,u.skip(o,s,"VAP sets with one VAPset created after current created_at should return undefined"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,datetime:{value:t},entries:[{id:"",description:"",value:"",explanation:"",probability:1,conviction:1}]}],o=r(n,i),s={certainty:1,temporal_uncertainty:{value:t}},u(o,s,"VAP sets with one VAPset with an 100% probable & confident (conviction) entry should be 100% certain"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,datetime:{value:t},entries:[{id:"",description:"",value:"",explanation:"",probability:.5,conviction:.5},{id:"",description:"",value:"",explanation:"",probability:.9,conviction:.9}]}],o=r(n,i),s={certainty:.81,temporal_uncertainty:{value:t}},u(o,s,"VAP sets with one VAPset with two entries should take highest certainty")})}),nE=k.delay("tidy_wcomponent",()=>{const t=new Date("2021-05-12"),n=new Date("2021-05-13");let i,o,s,r;const a={},c=-1;i=Rt({base_id:c,type:"statev2",subtype:"other"}),i.values_and_prediction_sets=[{...Te(P.undefined,{},[],c),id:"vps2",created_at:n,custom_created_at:void 0},{...Te(P.undefined,{},[],c),id:"vps1",created_at:t,custom_created_at:void 0}],s=Dt(i,a),u(s.values_and_prediction_sets.map(({id:d})=>d),["vps1","vps2"],"",!1),i=Rt({base_id:c,type:"statev2",subtype:"other"}),o=[{...Re(),id:"VAP1",relative_probability:5},{...Re(),id:"VAP2",relative_probability:0}],i.values_and_prediction_sets=[{...Te(P.undefined,{},[],c),entries:o}],s=Dt(i,a),u(s.values_and_prediction_sets[0].entries.map(({probability:d})=>d),[1,0],"",!1),i={...i,subtype:"boolean"},s=Dt(i,a),r=s.values_and_prediction_sets[0].entries,u(r.map(({relative_probability:d})=>d),[5,0],"",!1),u(r.map(({probability:d})=>d),[1,0],"",!1),o=[{...Re(),id:"VAP1",relative_probability:5,probability:0},{...Re(),id:"VAP2",relative_probability:0,probability:1}];const l=[{...Te(P.undefined,{},[],c),entries:o}];i={...i,subtype:"boolean",values_and_prediction_sets:l},s=Dt(i,a),r=s.values_and_prediction_sets[0].entries,u(r.map(({relative_probability:d})=>d),[5,0],"",!1),u(r.map(({probability:d})=>d),[0,1],"",!1),k("Ensuring _derived__using_value_from_wcomponent_id is not saved",()=>{const d=console.error;let p="";console.error=f=>{p=f},i={...i,_derived__using_value_from_wcomponent_id:"123"},s=Dt(i,a),console.error=d,u(p.length>0,!0,"Should log an error to the console when wcomponent with _derived__using_value_from_wcomponent_id is tidied before attempting to be saved"),u(s._derived__using_value_from_wcomponent_id,void 0,"Should delete wcomponent._derived__using_value_from_wcomponent_id")})});function ch(){return{from:()=>({select:()=>({order:()=>({eq:()=>({range:()=>new Promise(e=>{e({data:[{id:"1",base_id:1,name:"Item 1"},{id:"2",base_id:1,name:"Item 2"}]})})})})})})}}const iE=k.delay("supabase_get_items",()=>{const e=t=>({...t,id:parseInt(t.id,10)});k("normal case",async()=>{const t=await Yn({supabase:ch(),table:"test_table",converter:e,offset:0,base_id:1});u(t.value.length,2)}),k("return undefined for some values",async()=>{const t=await Yn({supabase:ch(),table:"test_table",converter:n=>n.id==="1"?void 0:e(n),offset:0,base_id:1});u(t.value.length,2),u(t.value[0],void 0),u(t.value[1].id,2)})}),oE=k.delay("supabase_item_to_app",()=>{const t=ll({id:"123",title:"-some title",base_id:111,modified_at:"2025-06-06T00:00:00",json:{modified_at:new Date("1970-06-06T00:00:00"),id:"-2",base_id:-1,title:"Test Item"}});u(t.id,"123","should use id from supabase field at top level of the table"),u(t.base_id,111,"should use base_id from supabase field at top level of the table"),u(t.modified_at instanceof Date,!0),u(t.modified_at.toISOString(),"2025-06-06T00:00:00.000Z","Should use modified_at from supabase field at top level of the table and convert to Date object"),u(t.title,"Test Item","should use title from json field in supabase item, not the title field.  The canonical value is in the DB's json field not the title field.")}),sE=k.delay("wcomponent_supabase_to_app",()=>{function e(i){let s={...fl(i),modified_at:"2025-06-06T00:00:00"};return Xi(s)}let t=O({type:"statev2",base_id:-1}),n=e(t);u(!!n,!0,"should return a valid wcomponent statev2 object"),t.type="an old unsupported component type",n=e(t),u(n,void 0,"should filter out wcomponent types which are unsupported")}),rE=k.delay("refresh_bases_for_current_user",()=>{const e=new Date,t=new Date,n="123",i="987",o={id:1,inserted_at:e,updated_at:t,owner_user_id:n,public_read:!1,title:"owned by this user",access_level:"owner",can_edit:!0},s={id:2,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!1,title:"editable by this user",access_level:"editor",can_edit:!0},r={id:3,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!1,title:"viewable by this user",access_level:"viewer",can_edit:!1},a={id:3,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!0,title:"public viewable by this user",access_level:"viewer",can_edit:!1},c=[o,s,r,a];function l(p){return Ng({user_info:p})}let d={user:{id:n},chosen_base_id:void 0,bases_by_id:void 0};u(l(d),!1),[o,s].forEach(p=>{d=Vn({user_info:d},S.user_info.update_bases({bases:[p]})).user_info,u(d.chosen_base_id,p.id),u(l(d),!1)}),d=Vn({user_info:d},S.user_info.update_bases({bases:[r,a]})).user_info,u(d.chosen_base_id,void 0),u(l(d),!0),d=Vn({user_info:{user:{id:n},chosen_base_id:100,bases_by_id:void 0}},S.user_info.update_bases({bases:[r,a]})).user_info,u(d.chosen_base_id,void 0),u(l(d),!0),[o,s].forEach(p=>{d=Vn({user_info:{user:{id:n},chosen_base_id:100,bases_by_id:void 0}},S.user_info.update_bases({bases:[]})).user_info,u(d.chosen_base_id,void 0),u(l(d),!0)}),c.forEach(({id:p})=>{d=Vn({user_info:{user:{id:n},chosen_base_id:p,bases_by_id:void 0}},S.user_info.update_bases({bases:c})).user_info,u(d.chosen_base_id,p),u(l(d),!1)})});function To(e,t){const n=[];for(let i=0;i<e.length;++i){const o=e[i];if(n.push(o),i>=e.length-1)continue;const s=e[i+1];n.push(t(o,s))}return n}const _E=k.delay("array functions",()=>{let e=To([],()=>0);u(e,[],"intersperse with no elements should be empty"),e=To(["a"],()=>0),u(e,["a"],"intersperse with 1 element should have no interspersed values"),e=To(["a","b","c"],(t,n)=>t.charCodeAt(0)+n.charCodeAt(0)),u(e,["a",195,"b",197,"c"],"intersperse with 3 elements should have interspersed values")});function lh(e,t,n){let i=0,o=e.length-1;for(;i<=o;){let s=Math.floor((i+o)/2);const r=t(e[s]);if(r===n)return s;r<n?i=s+1:o=s-1}return-1}function dn(e,t,n){let i=0,o=e.length-1;for(;i<=o;){let s=Math.floor((i+o)/2);const r=t(e[s]);if(r===n)return{index:s,exact:!0,bounds:"in"};if(r<n?i=s+1:o=s-1,i>o){const a=o===-1?"lower":i===e.length?"higher":"in";return{index:a==="lower"?-.5:a==="higher"?e.length-.5:r<n?s+.5:s-.5,exact:!1,bounds:a}}}return{index:-1,exact:!1,bounds:"n/a"}}const aE=k.delay("binary search functions",()=>{let e=lh([1,2,3,4,5,6,7,8,9],n=>n,3);u(e,2),e=lh([1,2,3,4,5,6,7,8,9],n=>n,3.5),u(e,-1);let t=dn([1,2,3,4,5,6,7,8,9],n=>n,3);u(t,{index:2,exact:!0,bounds:"in"}),t=dn([1,2,3,4,5,6,7,8,9],n=>n,0),u(t,{index:-.5,exact:!1,bounds:"lower"}),t=dn([1,2,3,4,5,6,7,8,9],n=>n,1.5),u(t,{index:.5,exact:!1,bounds:"in"}),t=dn([1,2,3,4,5,6,7,8,9],n=>n,2.5),u(t,{index:1.5,exact:!1,bounds:"in"}),t=dn([1,2,3,4,5,6,7,8,9],n=>n,3.5),u(t,{index:2.5,exact:!1,bounds:"in"}),t=dn([1,2,3,4,5,6,7,8,9],n=>n,9.5),u(t,{index:8.5,exact:!1,bounds:"higher"})}),cE=/(?:^)([^",\n\r]*),?/g,lE=/(?:^)"([^"]+|"")*",?/g,dE=/(?:^)([\n\r]+)/g;function B(e){const t=[];let n,i,o,s,r=[],a=!1,c=!0,l=2;do{if(a=!1,c&&(c=!1,l=2,r=[],t.push(r)),n=e.match(cE),i=e.match(lE),i&&i.length){s=i[0],a=s.endsWith(",");const d=(a?s.slice(1,-2):s.slice(1,-1)).replace(/""/g,'"');r.push(d),e=e.slice(s.length),a||(l-=1)}else if(n.length){s=n[0],a=s.endsWith(",");const d=a?s.slice(0,-1):s;r.push(d),e=e.slice(s.length),a||(l-=1)}o=e.match(dE),!a&&o&&o.length&&(c=!0,l=2,e=e.slice(o[0].length)),e===""&&(l-=1)}while(l>0);return t}const uE=k.delay("csv_to_array",()=>{u(B(""),[[""]]),u(B(","),[["",""]]),u(B("a"),[["a"]]),u(B("a,"),[["a",""]]),u(B(",a"),[["","a"]]),u(B(",a,"),[["","a",""]]),u(B("a,a"),[["a","a"]]),u(B("a,a,"),[["a","a",""]]),u(B(",a,a"),[["","a","a"]]),u(B(",a,a,"),[["","a","a",""]]),u(B(`
`),[[""],[""]]),u(B(`a
a`),[["a"],["a"]]),u(B(`,
,`),[["",""],["",""]]),u(B(`a,
a,`),[["a",""],["a",""]]),u(B(`,a
,a`),[["","a"],["","a"]]),u(B(`,a,
,a,`),[["","a",""],["","a",""]]),u(B('""'),[[""]]),u(B('"",'),[["",""]]),u(B(',""'),[["",""]]),u(B(',"",'),[["","",""]]),u(B('","'),[[","]]),u(B('",",'),[[",",""]]),u(B(',","'),[["",","]]),u(B(',",",'),[["",",",""]]),u(B('"",""'),[["",""]]),u(B('"a"'),[["a"]]),u(B('"a",'),[["a",""]]),u(B(',"a"'),[["","a"]]),u(B(',"a",'),[["","a",""]]),u(B('"a","a"'),[["a","a"]]),u(B('"a","a",'),[["a","a",""]]),u(B(',"a","a"'),[["","a","a"]]),u(B(',"a","a",'),[["","a","a",""]]),u(B('""""'),[['"']]),u(B('"""",'),[['"',""]]),u(B(',""""'),[["",'"']]),u(B(',"""",'),[["",'"',""]]),u(B('"""a"""'),[['"a"']]),u(B('"""a""","""a"""'),[['"a"','"a"']]),u(B('""""""'),[['""']]),u(B('"a""a"'),[['a"a']]),u(B('"a"",""a"'),[['a","a']]),u(B(`""
`),[[""],[""]])});function jb(e,t,n=[]){let i=t(e);const o={next:(...s)=>(n.push(s),i.next(...s)),throw:s=>i.throw(s),return:s=>i.return(s),[Symbol.iterator]:()=>o,clone:()=>{const s=[...n].map(r=>[...r]);return jb(e,t,s)}};return n.forEach(s=>i.next(...s)),o}const pE=k.delay("cloneable_generator_factory",()=>{function*e(i){let o=i.start;for(;;){let s=yield++o;s!==void 0&&(o+=s)}}let t=jb({start:10},e);u(t.next().value,11,"should increment"),u(t.next(3).value,11+1+3,"should use jump");let n=t.clone();u(t.next().value,16,"should increment again"),u(t.next(10).value,16+1+10,"should jump again"),u(n.next().value,16,"should have been reset"),u(n.next().value,17,"should not use previous jump"),u(n.next(-10).value,17+1-10,"should jump on second branch"),u(t.next().value,28,"should jump a third time on first branch")}),mE=k.delay("list functions",()=>{k("index_is_in_bounds",()=>{u(bt([],0),!1,"empty list, any number"),u(bt(["A"],-1),!1,"list with one element, index -1"),u(bt(["A"],0),!0,"list with one element, index 0"),u(bt(["A"],1),!1,"list with one element, index 1"),u(bt(["A","B"],1),!0,"list with two elements, index 1"),u(bt(["A","B"],2),!1,"list with two elements, index 2")}),k("swap_elements",()=>{u(gt([],0,0),[],"empty list, any indices, should be noop"),u(gt(["A","B"],-1,0),["A","B"],"invalid first index of -1, should be noop"),u(gt(["A","B"],2,0),["A","B"],"invalid first index of 2, should be noop"),u(gt(["A","B"],0,-1),["A","B"],"invalid second index of -1, should be noop"),u(gt(["A","B"],0,2),["A","B"],"invalid second index of 2, should be noop"),u(gt(["A","B"],0,1),["B","A"],"should swap"),u(gt(["A","B"],1,0),["B","A"],"should swap"),u(gt(["A","B"],1,1),["A","B"],"should handle noop")}),k("insert_element_at_index",()=>{u(wt([],"A",0),["A"],"insertion works at index 0"),u(wt([],"A",-2),["A"],"insertion works at any negative index"),u(wt([],"A",2),["A"],"insertion works at any positive index"),u(wt(["A","B","C"],"D",0),["D","A","B","C"],"insertion works at index 0"),u(wt(["A","B","C"],"D",-2),["D","A","B","C"],"insertion works at any negative index"),u(wt(["A","B","C"],"D",2),["A","B","D","C"],"insertion works at an positive index that is in the list"),u(wt(["A","B","C"],"D",3),["A","B","C","D"],"insertion works at an positive index that is the length of the list"),u(wt(["A","B","C"],"D",4),["A","B","C","D"],"insertion works at any positive index that is > list length")})});function Nb(e,t){const n={};return Object.values(e||{}).forEach(i=>{const o=t?i.value.toLowerCase():i.value;n[o]=i}),n}function Fn(e,t){if(e===void 0)return;const n=t||{},i=Nb(n,!1);return e.map(o=>({...o,entries:o.entries.map(s=>{let{value_id:r,value:a,description:c}=s,l=n[r||""];return l||(r=void 0,l=i[s.value]),l&&(r=l.id,a=l.value,c=l.description),{...s,value_id:r,value:a,description:c}})}))}const fE=k.delay("update_VAPSets_with_possibilities",()=>{var a,c,l,d,p,f,m,h,v,g,b,w,x,y,$,C,E,N,A,M,D,T,L,ne;const e="val_prob_id_123",t="val_prob_id_456",n="value abc",i="value def456",o={[e]:{id:e,value:n,description:"description abc",order:0},[t]:{id:t,value:i,description:"description def456",order:1}},s=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...Re(),value_id:e,value:"old abc value",description:"old abc description"},{...Re(),value_id:"defunct_id",value:n,description:"old abc description"},{...Re(),value_id:t,value:n,description:""}]}];let r=Fn(void 0,void 0);u(r,void 0,"Undefined initial VAPs returns undefined"),r=Fn(void 0,o),u(r,void 0,"Undefined initial VAPs returns undefined"),r=Fn([],o),u(r,[],"Empty initial VAPs returns empty"),r=Fn(s,void 0),u(r==null?void 0:r.length,s.length,"Undefined value_possibilities returns all VAPs"),r&&(u((c=(a=r[0])==null?void 0:a.entries[0])==null?void 0:c.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),u((d=(l=r[0])==null?void 0:l.entries[1])==null?void 0:d.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),u((f=(p=r[0])==null?void 0:p.entries[2])==null?void 0:f.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids")),console.log("Updates VAPs in VAP Set with value_possibilities ..."),r=Fn(s,o),u(Array.isArray(r),!0,"Returns an array"),r&&(u((h=(m=r[0])==null?void 0:m.entries[0])==null?void 0:h.value,(v=o[e])==null?void 0:v.value,"Updates value"),u((b=(g=r[0])==null?void 0:g.entries[0])==null?void 0:b.description,(w=o[e])==null?void 0:w.description,"Updates description"),u((y=(x=r[0])==null?void 0:x.entries[1])==null?void 0:y.value_id,e,"Updates id based on matched value"),u((C=($=r[0])==null?void 0:$.entries[1])==null?void 0:C.description,(E=o[e])==null?void 0:E.description,"Updates description based on matched value/id"),u((A=(N=r[0])==null?void 0:N.entries[2])==null?void 0:A.value_id,t,"Does not update id based on matched value if ID valid"),u((D=(M=r[0])==null?void 0:M.entries[2])==null?void 0:D.value,i,"Updates value"),u((L=(T=r[0])==null?void 0:T.entries[2])==null?void 0:L.description,(ne=o[t])==null?void 0:ne.description,"Updates description"))}),hE=k.delay("get_wcomponent_VAPs_represent",()=>{const e=_e(1),t=_e(2);let n,i,o,s,r,a;n=void 0,o={},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,"Should return undefined for undefined WComponent"),n=O({base_id:-1,type:"statev2",subtype:void 0}),o={},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,'Should return undefined for WComponent.type of "statev2" and subtype of undefined'),n=O({base_id:-1,type:"statev2",subtype:"boolean"}),o={},s=void 0,r=P.boolean,a=de(n,o,s),u(a,r,'Should return boolean for WComponent.type of "statev2" and subtype of boolean'),n=O({base_id:-1,type:"statev2",subtype:"number"}),o={},s=void 0,r=P.number,a=de(n,o,s),u(a,r,'Should return number for WComponent.type of "statev2" and subtype of number'),n=O({base_id:-1,type:"statev2",subtype:"other"}),o={},s=void 0,r=P.other,a=de(n,o,s),u(a,r,'Should return other for WComponent.type of "statev2" and subtype of other'),k("state_value",()=>{i=O({base_id:-1,type:"statev2",subtype:"number"}),n=O({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=P.number,a=de(n,o,s),u(a,r,'Should return number for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of number'),i=O({base_id:-1,type:"statev2",subtype:"boolean"}),n=O({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=P.boolean,a=de(n,o,s),u(a,r,'Should return boolean for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of boolean'),i=O({base_id:-1,type:"statev2",subtype:"other"}),n=O({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=P.other,a=de(n,o,s),u(a,r,'Should return other for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of other'),n=O({base_id:-1,type:"state_value",attribute_wcomponent_id:"some unknown uuid"}),o={},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,'Should return undefined for WComponent.type of "state_value" targeting an unknown stateV2 wcomponent'),k("protected from recursion",()=>{n=O({base_id:-1,id:e,type:"state_value",attribute_wcomponent_id:e}),o={[n.id]:n},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,'Should return undefined for WComponent.type of "state_value" targeting itself (accidentally)'),i=O({base_id:-1,id:e,type:"state_value",attribute_wcomponent_id:t}),n=O({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:e}),o={[i.id]:i,[n.id]:n},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,'Should return undefined for two WComponent.type of "state_value" targeting each other with infinite recursion')})}),k("other types",()=>{n=O({base_id:-1,type:"action"}),o={},s=void 0,r=P.action,a=de(n,o,s),u(a,r,'Should return action for WComponent.type of "action"'),n=O({base_id:-1,type:"process"}),o={},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,'Should return undefined for WComponent.type of "process"'),n=O({base_id:-1,type:"causal_link"}),o={},s=void 0,r=P.undefined,a=de(n,o,s),u(a,r,'Should return undefined for WComponent.type of "causal_link"')})}),vE=k.delay("parse_value",()=>{k("parse_VAP_value",()=>{let e;k('VAPsType "number"',()=>{const t=n=>tl({value:n,id:"",description:"",explanation:"",probability:1,conviction:1},P.number);e=t(""),u(e,null,"Should parse empty string as valid but null"),e=t("   "),u(e,null,"Should parse string of spaces as valid but null"),e=t("123"),u(e,123,"Should parse valid number"),e=t("  123  "),u(e,123,"Should parse valid number with whitespace"),e=t("123abc"),u(Number.isNaN(e),!0,"Should parse number with appended invalid characters as invalid NaN"),e=t("abc123"),u(Number.isNaN(e),!0,"Should parse number with prepended invalid characters as invalid NaN"),e=t("123%"),u(e,1.23,"Should parse number with appended %"),e=t("123 %"),u(e,1.23,"Should parse number with appended whitespace %"),e=t("123%%"),u(Number.isNaN(e),!0,"Should parse number with appended % and further invalid characters as invalid NaN"),e=t("1e-3%"),u(e,1e-5,"Should parse negative exponent number with appended %"),e=t(".3 e 2 %"),u(e,.3,"Should parse fractional number with exponent with appended % and interspersed whitespace"),e=t("3,000.200"),u(e,3000.2,"Should parse numbers with commas as thousands separators"),e=t("3,000.200%"),u(e,30.002,"Should parse numbers with commas as thousands separators and percentage sign")})}),k("is_string_valid_number",()=>{u($e(""),!0,"empty string is valid number"),u($e("   "),!0,"string of spaces is valid number"),u($e("123"),!0,"valid number"),u($e("  123  "),!0,"valid number with whitespace"),u($e("123abc"),!1,"number with appended invalid characters"),u($e("abc123"),!1,"number with prepended invalid characters"),u($e("123%"),!0,"number with appended % (valid)"),u($e("a90%"),!1,"number with appended % but prepended character (invalid)"),u($e("123 %"),!0,"number with appended whitespace % (valid)"),u($e("123%%"),!1,"number with appended % and further invalid characters"),u($e("1e-3%"),!0,"negative exponent number with appended % (valid)"),u($e(".3 e 2 %"),!0,"fractional number with exponent with appended % and interspersed whitespace (valid)"),u($e("3,000.200%"),!0,"numbers with commas as thousands separators are allowed"),u($e("3,00.2"),!1,"numbers with commas not at every 1000 are not allowed"),u($e("3,00"),!1,"numbers with commas not at every 1000 are not allowed")})});function Eo(e){const{wcomponent:t,kv_entry:n,sim_ms:i,wc_ids_excluded_by_filters:o}=e;if(!n||n.blocked)return!1;let s="is_selected"in e?e.is_selected:!1;return"selected_wcomponent_ids_set"in e&&(s=e.selected_wcomponent_ids_set.has(t.id)),s?!0:!(o.has(t.id)||gE(t,e.created_at_ms))}function gE(e,t){return it(e)>t}function un(e){const{from_wc:t,from_wc__kv_entry:n,to_wc:i,to_wc__kv_entry:o}=e;return Eo(e)?!t||!i?!0:!(!n||!o||!Eo({...e,wcomponent:t,kv_entry:n})||!Eo({...e,wcomponent:i,kv_entry:o})):!1}function Pb(e){return e.is_highlighted||e.is_selected||e.is_current_item||e.connected_neighbour_is_highlighted?1:e.focused_mode?.1:(e.is_editing,1)}const wE=k.delay("calc_connection_wcomponent_should_display",()=>{const e=new Date("2024-08-29T11:00:00.000Z"),t=e.getTime(),n=new Date("2024-08-29T11:00:00.000Z").getTime(),i=()=>{let r=O({type:"causal_link",base_id:-1,created_at:e});if(!sn(r))throw new Error(`Need a causal_link component for tests but got "${r.type}"`);const a=O({type:"causal_link",base_id:-1,created_at:e}),c=O({type:"statev2",base_id:-1,created_at:e});return{wcomponent:r,kv_entry:{left:0,top:0},from_wc:a,to_wc:c,from_wc__kv_entry:{left:0,top:0},to_wc__kv_entry:{left:0,top:0},created_at_ms:t,sim_ms:n,selected_wcomponent_ids_set:new Set,wc_ids_excluded_by_filters:new Set}};let o=i(),s=un(o);u(s,!0,"should display"),o=i(),o.wcomponent.created_at=new Date(t+1),s=un(o),u(s,!1,"should not display if created in future"),o=i(),o.wc_ids_excluded_by_filters.add(o.wcomponent.id),s=un(o),u(s,!1,"should not display if it list of ids excluded by filters"),o=i(),o.from_wc=void 0,o.from_wc__kv_entry=void 0,s=un(o),u(s,!0,"should display if from_wc not present"),o=i(),o.to_wc=void 0,o.to_wc__kv_entry=void 0,s=un(o),u(s,!0,"should display if to_wc not present"),o=i(),o.from_wc=void 0,o.from_wc__kv_entry=void 0,o.wc_ids_excluded_by_filters.add(o.wcomponent.id),s=un(o),u(s,!1,"should not display if from_wc not present and id is in list of ids excluded by filters")}),bE=k.delay("get_wcomponent_state_UI_value",()=>{const e=new Date("2021-05-01 00:00"),t=new Date("2021-05-01 00:01"),n=new Date("2021-05-01 00:02");function i(f,m){const h={};return f.forEach(v=>{m.forEach(g=>{if(v.VAP_set_id!==g.id)return;const b=h[g.id]||[];b.push({base_id:-1,id:"",created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:g.id,target_VAP_id:v.VAP_id}),h[g.id]=b})}),h}function o(f,m,h){const{counterfactuals_data:v=[],datetime:g={}}=h||{},b=m.map((x,y)=>({base_id:-1,id:`vps${y}`,created_at:t,version:1,datetime:g,entries:x}));f={...f,values_and_prediction_sets:b};const w=i(v,b);return rs({wcomponent:f,VAP_set_id_to_counterfactual_v2_map:w,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const s={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]};let r;const a={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},c={...a,id:"VAP100",value:"A100",probability:1,conviction:1},l={...c,id:"VAP80",value:"A80",probability:.8},d={...c,id:"VAP20",value:"A20",probability:.2},p={...c,id:"VAP0",value:"A0",probability:0};k("Basic tests of get_wcomponent_state_UI_value",()=>{r=o(s,[]),u(r,void 0,"No VAP (value and prediction) sets should return undefined"),r=o(s,[[]]),u(r,void 0,"No value defined in a VAP (value and prediction) set should return undefined"),r=o(s,[[{...c,value:"  "}]]),u(r,{values_string:"not defined",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with whitespace string value should be trimmed to nothing and then shown as 'not defined'"),r=o(s,[[c]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with certainty"),r=o(s,[[d,l]]),u(r,{values_string:"A80, A20",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"Multiple VAPs with both uncertain should result in both being shown, with the most probable first"),r=o(s,[[p,c]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain first, should only show the certain one"),r=o(s,[[c,p]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain last, should only show the certain one"),r=o(s,[[d,d,d,d]]),u(r,{values_string:"A20, A20, A20, (1 more)",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},'Shows "(1 more)" when there are more than 3 values')}),k("number subtype",()=>{const f={...s,subtype:"number"},m={...a,id:"VAP1",value:"33",probability:1,conviction:1};r=o(f,[[m]]),u(r,{values_string:"33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number value string");const h={...a,id:"VAP1",value:"33abc",probability:1,conviction:1};r=o(f,[[h]]),u(r,{values_string:"NaN",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A number with invalid characters in value string");const v={...a,id:"VAP1",value:"33%",probability:1,conviction:1};r=o(f,[[v]]),u(r,{values_string:"0.33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number percentage")}),k("boolean subtype",()=>{const f={...s,subtype:"boolean"};r=o(f,[[c]]),u(r,{values_string:"True",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"100% confident boolean should render as True"),r=o(f,[[{...c,probability:.51}]]),u(r,{values_string:"True",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},">50% confident boolean should render as True"),r=o(f,[[{...c,probability:.5}]]),u(r,{values_string:"False",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"<=50% confident boolean should render as False"),r=o(f,[[p]]),u(r,{values_string:"False",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"0% confident boolean should render as False")}),k("StateValue replacing VAPSets",()=>{const f={...s,_derived__using_value_from_wcomponent_id:"abc123"};r=o(f,[[c]]),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),k("datetime",()=>{r=o(s,[[c]],{datetime:{min:n}}),u(r,void 0,"When datetime.min is in the future, no value should be shown"),r=o(s,[[c]],{datetime:{min:t}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.min is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{max:t}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{max:e}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is in the past, a value should still be shown because the 'max' represents the lastest time this change to state could have occured, and the state represents the most current value"),r=o(s,[[c]],{datetime:{value:n}}),u(r,void 0,"When datetime.value is the future, no value should be shown"),r=o(s,[[c]],{datetime:{value:t}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{value:e}}),u(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the past, a value should still be shown, for the same reason as when datetime.max is in the past")})}),yE=k.delay("get_wcomponent_state_value_and_probabilities",()=>{const e=new Date("2021-05-01 00:00"),t=new Date("2021-05-01 00:01"),n=new Date("2021-05-01 00:02");function i(w,x){if(!w||!x)return;const y={};let $=0;return w.forEach(C=>{x.forEach(E=>{if(C.VAP_set_id!==E.id)return;const N=y[E.id]||[];N.push({base_id:-1,id:`cf${$++}`,created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:E.id,target_VAP_id:C.VAP_id}),y[E.id]=N})}),y}function o(w){return w.map((x,y)=>({base_id:-1,id:`vps${y}`,created_at:t,version:1,datetime:{},entries:[],...x}))}function s(w,x,y){const{apply_counterfactuals_v2:$,datetime:C={}}=y||{};if(x){const N=x.map(M=>({datetime:C,entries:M})),A=o(N);w={...w,values_and_prediction_sets:A}}const E=i($,w.values_and_prediction_sets);return Qn({wcomponent:w,VAP_set_id_to_counterfactual_v2_map:E,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const r={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]},a={...r,subtype:"boolean"};let c;const l={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},d={...l,id:"VAP100",value:"A100",probability:1,conviction:1},p={...d,id:"VAP80",value:"A80",probability:.8},f={...d,id:"VAP20",value:"A20",probability:.2},m={...d,id:"VAP0",value:"A0",probability:0},h={...d,id:"VAP100c50",value:"A100c50",conviction:.8},v={...d,id:"VAP100c0",value:"A100c0",conviction:0},g=[h],b=[v];k("Basic functionality",()=>{c=s(r,[]),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"No VAP (value and prediction) defined"),c=s(r,[[]]),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"No value defined in VAP (value and prediction)"),c=s(r,[[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Single with certainty"),c=s(r,[[f,p]]),u(c,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:.8,conviction:1,probability:.8,value_id:void 0},{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with both uncertain"),c=s(r,[[d,f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with one certain, one uncertain, should only show certain");let w=o([{datetime:{value:e},id:"vap_set_0",entries:[{...d,value:"A100a"}]},{datetime:{value:t},id:"vap_set_1",entries:[{...d,value:"A100b"}]},{datetime:{value:n},id:"vap_set_2",entries:[{...d,value:"A100c"}]}]),x={...r,values_and_prediction_sets:w};c=Qn({wcomponent:x,VAP_set_id_to_counterfactual_v2_map:void 0,created_at_ms:t.getTime(),sim_ms:t.getTime()}),u(c,{most_probable_VAP_set_values:[{original_value:"A100b",parsed_value:"A100b",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple VAP sets, each with one single VAP, should pick current VAP set"),c=s(r,[[m]]),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance: Should return no value when no chance")}),k("should use first VAP set when both VAP sets conflict at same datetime",()=>{c=s(r,[[d],[f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"certain first and uncertain last"),c=s(r,[[f],[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"uncertain first and certain last")}),k("handling boolean subtype",()=>{c=s(a,[[m]]),u(c,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:!1,certainty:0,conviction:1,probability:0,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance boolean: Should return a value with probability of 0 when no chance of a boolean value"),c=s(a,[[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:!0,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should handle boolean, probability of 1, by returning true"),k('uncertainty for "boolean" subtype',()=>{c=s(a,[[f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:!1,certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),c=s(a,[g]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:!0,certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),c=s(a,[b]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:!0,certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")})}),k('uncertainty for "other" subtype',()=>{c=s(r,[[f]]),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),c=s(r,[g]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:"A100c50",certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),c=s(r,[b]),u(c,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:"A100c0",certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")}),k("counterfactuals",()=>{c=s(r,[[d]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:d.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"No op counterfactual is applied to something already with certainty of 1"),c=s(r,[[p]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:p.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP that had certainty of < 1"),c=s(r,[[p,f]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:f.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP set with two VAPs that had certainty of < 1"),c=s(r,[[d,m]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:m.id}]}),u(c,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:"A0",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactuals to force one option possibility over another that was certain"),c=s(r,[[d,m]]),u.skip(c,{most_probable_VAP_set_values:[{certainty:1,conviction:1,original_value:"A100",parsed_value:"A100",probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["123"]},"Skipping because counterfactuals version 2 only works to force things to be true, not to be false.  For forcing something to be true, then you can use a StateValue component instead.")}),k("StateValue replacing VAPSets",()=>{const w={...r,_derived__using_value_from_wcomponent_id:"abc123"};c=s(w,[[d]]),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),k('Parsing "number" subtype',()=>{var $;const w={...r,subtype:"number"},x={...l,id:"VAP1",value:"33",probability:1,conviction:1},y={...l,id:"VAP1",value:"44abc",probability:1,conviction:1};c=s(w,[[x]]),u(c,{most_probable_VAP_set_values:[{original_value:"33",parsed_value:33,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Correctly parses valid number"),c=s(w,[[y]]),u(c,{most_probable_VAP_set_values:[{original_value:"44abc",parsed_value:Number.NaN,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Errors when parsing number appended with invalid characters"),u(Number.isNaN(($=c.most_probable_VAP_set_values[0])==null?void 0:$.parsed_value),!0,"Error is Number.NaN")}),k("values before, at, after a datetime.min, datetime.value, datetime.max",()=>{k("in the future",()=>{c=s(r,[[d]],{datetime:{min:n}}),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.min is in future"),c=s(r,[[d]],{datetime:{value:n}}),u(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.value is in future"),c=s(r,[[d]],{datetime:{max:n}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")}),c=s(r,[[d]],{datetime:{min:t}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.min is at the same time (or earlier)"),c=s(r,[[d]],{datetime:{value:t}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.value is at the same time (or earlier)"),c=s(r,[[d]],{datetime:{max:t}}),u(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")})});var Hl={},kE=ee;Object.defineProperty(Hl,"__esModule",{value:!0});var bs=Hl.default=void 0,xE=kE(Q()),SE=te(),AE=(0,xE.default)((0,SE.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");bs=Hl.default=AE;function no(e){const{warning:t,label:n="",always_display:i=!1}=e;return _(ae,{variant:"caption",title:t,"aria-label":t,style:{display:t||i?"inline":"none"},children:[_(bs,{}),_("span",{style:{position:"relative",top:-7,wordBreak:""},children:n})]})}function Ib(e){const{message:t}=e,n={display:"flex",color:e.is_error?"black":"lightgrey"};return _("div",{style:{...n,overflow:"hidden",maxHeight:t.length?100:0,maxWidth:t.length?100:0,transition:"max-height 1s ease, max-width 1s ease, color 1s ease"},children:_(no,{warning:t,always_display:!0})})}function Rb(e){const{message:t,is_error:n}=$E(e.result);return _(Ib,{message:t,is_error:n})}function $E(e){let t="",n=!1;return e!=null&&e.error&&(t=`Error: ${e.error}`,n=!0),e!=null&&e.warning&&(e.error&&(t+=`
----
`),t+=`Warning: ${e.warning}`),{message:t,is_error:n}}function pn(){return pn=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},pn.apply(this,arguments)}const CE=["children","options"],dh=["allowFullScreen","allowTransparency","autoComplete","autoFocus","autoPlay","cellPadding","cellSpacing","charSet","className","classId","colSpan","contentEditable","contextMenu","crossOrigin","encType","formAction","formEncType","formMethod","formNoValidate","formTarget","frameBorder","hrefLang","inputMode","keyParams","keyType","marginHeight","marginWidth","maxLength","mediaGroup","minLength","noValidate","radioGroup","readOnly","rowSpan","spellCheck","srcDoc","srcLang","srcSet","tabIndex","useMap"].reduce((e,t)=>(e[t.toLowerCase()]=t,e),{for:"htmlFor"}),uh={amp:"&",apos:"'",gt:">",lt:"<",nbsp:" ",quot:"“"},TE=["style","script"],EE=/([-A-Z0-9_:]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|(?:\{((?:\\.|{[^}]*?}|[^}])*)\})))?/gi,jE=/mailto:/i,NE=/\n{2,}$/,Db=/^( *>[^\n]+(\n[^\n]+)*\n*)+\n{2,}/,PE=/^ *> ?/gm,IE=/^ {2,}\n/,RE=/^(?:( *[-*_])){3,} *(?:\n *)+\n/,Mb=/^\s*(`{3,}|~{3,}) *(\S+)?([^\n]*?)?\n([\s\S]+?)\s*\1 *(?:\n *)*\n?/,Ob=/^(?: {4}[^\n]+\n*)+(?:\n *)+\n?/,DE=/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,ME=/^(?:\n *)*\n/,OE=/\r\n?/g,qE=/^\[\^([^\]]+)](:.*)\n/,VE=/^\[\^([^\]]+)]/,FE=/\f/g,zE=/^\s*?\[(x|\s)\]/,qb=/^ *(#{1,6}) *([^\n]+?)(?: +#*)?(?:\n *)*(?:\n|$)/,Vb=/^([^\n]+)\n *(=|-){3,} *(?:\n *)+\n/,Fc=/^ *(?!<[a-z][^ >/]* ?\/>)<([a-z][^ >/]*) ?([^>]*)\/{0}>\n?(\s*(?:<\1[^>]*?>[\s\S]*?<\/\1>|(?!<\1)[\s\S])*?)<\/\1>\n*/i,LE=/&([a-zA-Z]+);/g,Fb=/^<!--[\s\S]*?(?:-->)/,BE=/^(data|aria|x)-[a-z_][a-z\d_.-]*$/,zc=/^ *<([a-z][a-z0-9:]*)(?:\s+((?:<.*?>|[^>])*))?\/?>(?!<\/\1>)(\s*\n)?/i,UE=/^\{.*\}$/,WE=/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,HE=/^<([^ >]+@[^ >]+)>/,GE=/^<([^ >]+:\/[^ >]+)>/,KE=/-([a-z])?/gi,zb=/^(.*\|?.*)\n *(\|? *[-:]+ *\|[-| :]*)\n((?:.*\|.*\n)*)\n?/,YE=/^\[([^\]]*)\]:\s+<?([^\s>]+)>?\s*("([^"]*)")?/,JE=/^!\[([^\]]*)\] ?\[([^\]]*)\]/,XE=/^\[([^\]]*)\] ?\[([^\]]*)\]/,ZE=/(\[|\])/g,QE=/(\n|^[-*]\s|^#|^ {2,}|^-{2,}|^>\s)/,ej=/\t/g,tj=/^ *\| */,nj=/(^ *\||\| *$)/g,ij=/ *$/,oj=/^ *:-+: *$/,sj=/^ *:-+ *$/,rj=/^ *-+: *$/,_j=/^([*_])\1((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1\1(?!\1)/,aj=/^([*_])((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1(?!\1|\w)/,cj=/^==((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)==/,lj=/^~~((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)~~/,dj=/^\\([^0-9A-Za-z\s])/,uj=/^[\s\S]+?(?=[^0-9A-Z\s\u00c0-\uffff&;.()'"]|\d+\.|\n\n| {2,}\n|\w+:\S|$)/i,pj=/^\n+/,mj=/^([ \t]*)/,fj=/\\([^\\])/g,ph=/ *\n+$/,hj=/(?:^|\n)( *)$/,Gl="(?:\\d+\\.)",Kl="(?:[*+-])";function Lb(e){return"( *)("+(e===1?Gl:Kl)+") +"}const Bb=Lb(1),Ub=Lb(2);function Wb(e){return new RegExp("^"+(e===1?Bb:Ub))}const vj=Wb(1),gj=Wb(2);function Hb(e){return new RegExp("^"+(e===1?Bb:Ub)+"[^\\n]*(?:\\n(?!\\1"+(e===1?Gl:Kl)+" )[^\\n]*)*(\\n|$)","gm")}const Gb=Hb(1),Kb=Hb(2);function Yb(e){const t=e===1?Gl:Kl;return new RegExp("^( *)("+t+") [\\s\\S]+?(?:\\n{2,}(?! )(?!\\1"+t+" (?!"+t+" ))\\n*|\\s*\\n*$)")}const Jb=Yb(1),Xb=Yb(2);function mh(e,t){const n=t===1,i=n?Jb:Xb,o=n?Gb:Kb,s=n?vj:gj;return{t(r,a,c){const l=hj.exec(c);return l&&(a.o||!a._&&!a.u)?i.exec(r=l[1]+r):null},i:X.HIGH,l(r,a,c){const l=n?+r[2]:void 0,d=r[0].replace(NE,`
`).match(o);let p=!1;return{p:d.map(function(f,m){const h=s.exec(f)[0].length,v=new RegExp("^ {1,"+h+"}","gm"),g=f.replace(v,"").replace(s,""),b=m===d.length-1,w=g.indexOf(`

`)!==-1||b&&p;p=w;const x=c._,y=c.o;let $;c.o=!0,w?(c._=!1,$=g.replace(ph,`

`)):(c._=!0,$=g.replace(ph,""));const C=a($,c);return c._=x,c.o=y,C}),m:n,g:l}},h:(r,a,c)=>e(r.m?"ol":"ul",{key:c.k,start:r.g},r.p.map(function(l,d){return e("li",{key:d},a(l,c))}))}}const wj=/^\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,bj=/^!\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,Zb=[Db,Mb,Ob,qb,Vb,Fb,zb,Gb,Jb,Kb,Xb],yj=[...Zb,/^[^\n]+(?:  \n|\n{2,})/,Fc,zc];function kj(e){return e.replace(/[ÀÁÂÃÄÅàáâãäåæÆ]/g,"a").replace(/[çÇ]/g,"c").replace(/[ðÐ]/g,"d").replace(/[ÈÉÊËéèêë]/g,"e").replace(/[ÏïÎîÍíÌì]/g,"i").replace(/[Ññ]/g,"n").replace(/[øØœŒÕõÔôÓóÒò]/g,"o").replace(/[ÜüÛûÚúÙù]/g,"u").replace(/[ŸÿÝý]/g,"y").replace(/[^a-z0-9- ]/gi,"").replace(/ /gi,"-").toLowerCase()}function xj(e){return rj.test(e)?"right":oj.test(e)?"center":sj.test(e)?"left":null}function fh(e,t,n){const i=n.v;n.v=!0;const o=t(e.trim(),n);n.v=i;let s=[[]];return o.forEach(function(r,a){r.type==="tableSeparator"?a!==0&&a!==o.length-1&&s.push([]):(r.type!=="text"||o[a+1]!=null&&o[a+1].type!=="tableSeparator"||(r.$=r.$.replace(ij,"")),s[s.length-1].push(r))}),s}function Sj(e,t,n){n._=!0;const i=fh(e[1],t,n),o=e[2].replace(nj,"").split("|").map(xj),s=function(r,a,c){return r.trim().split(`
`).map(function(l){return fh(l,a,c)})}(e[3],t,n);return n._=!1,{S:o,A:s,L:i,type:"table"}}function hh(e,t){return e.S[t]==null?{}:{textAlign:e.S[t]}}function Ht(e){return function(t,n){return n._?e.exec(t):null}}function Gt(e){return function(t,n){return n._||n.u?e.exec(t):null}}function Et(e){return function(t,n){return n._||n.u?null:e.exec(t)}}function vi(e){return function(t){return e.exec(t)}}function Aj(e,t,n){if(t._||t.u||n&&!n.endsWith(`
`))return null;let i="";e.split(`
`).every(s=>!Zb.some(r=>r.test(s))&&(i+=s+`
`,s.trim()));const o=i.trimEnd();return o==""?null:[i,o]}function Dn(e){try{if(decodeURIComponent(e).replace(/[^A-Za-z0-9/:]/g,"").match(/^\s*(javascript|vbscript|data(?!:image)):/i))return null}catch{return null}return e}function vh(e){return e.replace(fj,"$1")}function jo(e,t,n){const i=n._||!1,o=n.u||!1;n._=!0,n.u=!0;const s=e(t,n);return n._=i,n.u=o,s}function $j(e,t,n){const i=n._||!1,o=n.u||!1;n._=!1,n.u=!0;const s=e(t,n);return n._=i,n.u=o,s}function Cj(e,t,n){return n._=!1,e(t+`

`,n)}const lc=(e,t,n)=>({$:jo(t,e[1],n)});function dc(){return{}}function uc(){return null}function Tj(...e){return e.filter(Boolean).join(" ")}function pc(e,t,n){let i=e;const o=t.split(".");for(;o.length&&(i=i[o[0]],i!==void 0);)o.shift();return i||n}var X;function Ej(e,t={}){t.overrides=t.overrides||{},t.slugify=t.slugify||kj,t.namedCodesToUnicode=t.namedCodesToUnicode?pn({},uh,t.namedCodesToUnicode):uh;const n=t.createElement||Yd;function i(m,h,...v){const g=pc(t.overrides,`${m}.props`,{});return n(function(b,w){const x=pc(w,b);return x?typeof x=="function"||typeof x=="object"&&"render"in x?x:pc(w,`${b}.component`,b):b}(m,t.overrides),pn({},h,g,{className:Tj(h==null?void 0:h.className,g.className)||void 0}),...v)}function o(m){let h=!1;t.forceInline?h=!0:t.forceBlock||(h=QE.test(m)===!1);const v=d(l(h?m:`${m.trimEnd().replace(pj,"")}

`,{_:h}));for(;typeof v[v.length-1]=="string"&&!v[v.length-1].trim();)v.pop();if(t.wrapper===null)return v;const g=t.wrapper||(h?"span":"div");let b;if(v.length>1||t.forceWrapper)b=v;else{if(v.length===1)return b=v[0],typeof b=="string"?i("span",{key:"outer"},b):b;b=null}return Yd(g,{key:"outer"},b)}function s(m){const h=m.match(EE);return h?h.reduce(function(v,g,b){const w=g.indexOf("=");if(w!==-1){const x=function(E){return E.indexOf("-")!==-1&&E.match(BE)===null&&(E=E.replace(KE,function(N,A){return A.toUpperCase()})),E}(g.slice(0,w)).trim(),y=function(E){const N=E[0];return(N==='"'||N==="'")&&E.length>=2&&E[E.length-1]===N?E.slice(1,-1):E}(g.slice(w+1).trim()),$=dh[x]||x,C=v[$]=function(E,N){return E==="style"?N.split(/;\s?/).reduce(function(A,M){const D=M.slice(0,M.indexOf(":"));return A[D.replace(/(-[a-z])/g,T=>T[1].toUpperCase())]=M.slice(D.length+1).trim(),A},{}):E==="href"?Dn(N):(N.match(UE)&&(N=N.slice(1,N.length-1)),N==="true"||N!=="false"&&N)}(x,y);typeof C=="string"&&(Fc.test(C)||zc.test(C))&&(v[$]=Yh(o(C.trim()),{key:b}))}else g!=="style"&&(v[dh[g]||g]=!0);return v},{}):null}const r=[],a={},c={blockQuote:{t:Et(Db),i:X.HIGH,l:(m,h,v)=>({$:h(m[0].replace(PE,""),v)}),h:(m,h,v)=>i("blockquote",{key:v.k},h(m.$,v))},breakLine:{t:vi(IE),i:X.HIGH,l:dc,h:(m,h,v)=>i("br",{key:v.k})},breakThematic:{t:Et(RE),i:X.HIGH,l:dc,h:(m,h,v)=>i("hr",{key:v.k})},codeBlock:{t:Et(Ob),i:X.MAX,l:m=>({$:m[0].replace(/^ {4}/gm,"").replace(/\n+$/,""),M:void 0}),h:(m,h,v)=>i("pre",{key:v.k},i("code",pn({},m.I,{className:m.M?`lang-${m.M}`:""}),m.$))},codeFenced:{t:Et(Mb),i:X.MAX,l:m=>({I:s(m[3]||""),$:m[4],M:m[2]||void 0,type:"codeBlock"})},codeInline:{t:Gt(DE),i:X.LOW,l:m=>({$:m[2]}),h:(m,h,v)=>i("code",{key:v.k},m.$)},footnote:{t:Et(qE),i:X.MAX,l:m=>(r.push({O:m[2],B:m[1]}),{}),h:uc},footnoteReference:{t:Ht(VE),i:X.HIGH,l:m=>({$:m[1],R:`#${t.slugify(m[1])}`}),h:(m,h,v)=>i("a",{key:v.k,href:Dn(m.R)},i("sup",{key:v.k},m.$))},gfmTask:{t:Ht(zE),i:X.HIGH,l:m=>({T:m[1].toLowerCase()==="x"}),h:(m,h,v)=>i("input",{checked:m.T,key:v.k,readOnly:!0,type:"checkbox"})},heading:{t:Et(qb),i:X.HIGH,l:(m,h,v)=>({$:jo(h,m[2],v),j:t.slugify(m[2]),C:m[1].length}),h:(m,h,v)=>i(`h${m.C}`,{id:m.j,key:v.k},h(m.$,v))},headingSetext:{t:Et(Vb),i:X.MAX,l:(m,h,v)=>({$:jo(h,m[1],v),C:m[2]==="="?1:2,type:"heading"})},htmlComment:{t:vi(Fb),i:X.HIGH,l:()=>({}),h:uc},image:{t:Gt(bj),i:X.HIGH,l:m=>({D:m[1],R:vh(m[2]),N:m[3]}),h:(m,h,v)=>i("img",{key:v.k,alt:m.D||void 0,title:m.N||void 0,src:Dn(m.R)})},link:{t:Ht(wj),i:X.LOW,l:(m,h,v)=>({$:$j(h,m[1],v),R:vh(m[2]),N:m[3]}),h:(m,h,v)=>i("a",{key:v.k,href:Dn(m.R),title:m.N},h(m.$,v))},linkAngleBraceStyleDetector:{t:Ht(GE),i:X.MAX,l:m=>({$:[{$:m[1],type:"text"}],R:m[1],type:"link"})},linkBareUrlDetector:{t:(m,h)=>h.Z?null:Ht(WE)(m,h),i:X.MAX,l:m=>({$:[{$:m[1],type:"text"}],R:m[1],N:void 0,type:"link"})},linkMailtoDetector:{t:Ht(HE),i:X.MAX,l(m){let h=m[1],v=m[1];return jE.test(v)||(v="mailto:"+v),{$:[{$:h.replace("mailto:",""),type:"text"}],R:v,type:"link"}}},orderedList:mh(i,1),unorderedList:mh(i,2),newlineCoalescer:{t:Et(ME),i:X.LOW,l:dc,h:()=>`
`},paragraph:{t:Aj,i:X.LOW,l:lc,h:(m,h,v)=>i("p",{key:v.k},h(m.$,v))},ref:{t:Ht(YE),i:X.MAX,l:m=>(a[m[1]]={R:m[2],N:m[4]},{}),h:uc},refImage:{t:Gt(JE),i:X.MAX,l:m=>({D:m[1]||void 0,F:m[2]}),h:(m,h,v)=>i("img",{key:v.k,alt:m.D,src:Dn(a[m.F].R),title:a[m.F].N})},refLink:{t:Ht(XE),i:X.MAX,l:(m,h,v)=>({$:h(m[1],v),P:h(m[0].replace(ZE,"\\$1"),v),F:m[2]}),h:(m,h,v)=>a[m.F]?i("a",{key:v.k,href:Dn(a[m.F].R),title:a[m.F].N},h(m.$,v)):i("span",{key:v.k},h(m.P,v))},table:{t:Et(zb),i:X.HIGH,l:Sj,h:(m,h,v)=>i("table",{key:v.k},i("thead",null,i("tr",null,m.L.map(function(g,b){return i("th",{key:b,style:hh(m,b)},h(g,v))}))),i("tbody",null,m.A.map(function(g,b){return i("tr",{key:b},g.map(function(w,x){return i("td",{key:x,style:hh(m,x)},h(w,v))}))})))},tableSeparator:{t:function(m,h){return h.v?tj.exec(m):null},i:X.HIGH,l:function(){return{type:"tableSeparator"}},h:()=>" | "},text:{t:vi(uj),i:X.MIN,l:m=>({$:m[0].replace(LE,(h,v)=>t.namedCodesToUnicode[v]?t.namedCodesToUnicode[v]:h)}),h:m=>m.$},textBolded:{t:Gt(_j),i:X.MED,l:(m,h,v)=>({$:h(m[2],v)}),h:(m,h,v)=>i("strong",{key:v.k},h(m.$,v))},textEmphasized:{t:Gt(aj),i:X.LOW,l:(m,h,v)=>({$:h(m[2],v)}),h:(m,h,v)=>i("em",{key:v.k},h(m.$,v))},textEscaped:{t:Gt(dj),i:X.HIGH,l:m=>({$:m[1],type:"text"})},textMarked:{t:Gt(cj),i:X.LOW,l:lc,h:(m,h,v)=>i("mark",{key:v.k},h(m.$,v))},textStrikethroughed:{t:Gt(lj),i:X.LOW,l:lc,h:(m,h,v)=>i("del",{key:v.k},h(m.$,v))}};t.disableParsingRawHTML!==!0&&(c.htmlBlock={t:vi(Fc),i:X.HIGH,l(m,h,v){const[,g]=m[3].match(mj),b=new RegExp(`^${g}`,"gm"),w=m[3].replace(b,""),x=(y=w,yj.some(N=>N.test(y))?Cj:jo);var y;const $=m[1].toLowerCase(),C=TE.indexOf($)!==-1;v.Z=v.Z||$==="a";const E=C?m[3]:x(h,w,v);return v.Z=!1,{I:s(m[2]),$:E,G:C,H:C?$:m[1]}},h:(m,h,v)=>i(m.H,pn({key:v.k},m.I),m.G?m.$:h(m.$,v))},c.htmlSelfClosing={t:vi(zc),i:X.HIGH,l:m=>({I:s(m[2]||""),H:m[1]}),h:(m,h,v)=>i(m.H,pn({},m.I,{key:v.k}))});const l=function(m){let h=Object.keys(m);function v(g,b){let w=[],x="";for(;g;){let y=0;for(;y<h.length;){const $=h[y],C=m[$],E=C.t(g,b,x);if(E){const N=E[0];g=g.substring(N.length);const A=C.l(E,v,b);A.type==null&&(A.type=$),w.push(A),x=N;break}y++}}return w}return h.sort(function(g,b){let w=m[g].i,x=m[b].i;return w!==x?w-x:g<b?-1:1}),function(g,b){return v(function(w){return w.replace(OE,`
`).replace(FE,"").replace(ej,"    ")}(g),b)}}(c),d=(p=function(m){return function(h,v,g){return m[h.type].h(h,v,g)}}(c),function m(h,v={}){if(Array.isArray(h)){const g=v.k,b=[];let w=!1;for(let x=0;x<h.length;x++){v.k=x;const y=m(h[x],v),$=typeof y=="string";$&&w?b[b.length-1]+=y:y!==null&&b.push(y),w=$}return v.k=g,b}return p(h,m,v)});var p;const f=o(e);return r.length?i("div",null,f,i("footer",{key:"footer"},r.map(function(m){return i("div",{id:t.slugify(m.B),key:m.B},m.B,d(l(m.O,{_:!0})))}))):f}(function(e){e[e.MAX=0]="MAX",e[e.HIGH=1]="HIGH",e[e.MED=2]="MED",e[e.LOW=3]="LOW",e[e.MIN=4]="MIN"})(X||(X={}));const io=e=>{let{children:t,options:n}=e,i=function(o,s){if(o==null)return{};var r,a,c={},l=Object.keys(o);for(a=0;a<l.length;a++)s.indexOf(r=l[a])>=0||(c[r]=o[r]);return c}(e,CE);return Yh(Ej(t,n),i)};function ft(e){var t;return(t=e.derived.current_composed_knowledge_view)==null?void 0:t.wc_id_to_active_counterfactuals_v2_map}function Qb(e,t){var i;if(!t)return;const n=ft(e);return n&&((i=n[t])==null?void 0:i.VAP_sets)}function ey(e,t){const{overlapping_wc_ids:n={}}=e.derived.current_composed_knowledge_view||{};return n[t]}function jj(e){return _("a",{href:e.href,onClick:t=>t.stopImmediatePropagation(),onPointerDown:t=>t.stopImmediatePropagation(),children:e.children})}const Nj=e=>({rich_text:e.display_options.consumption_formatting,composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:ft(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),Pj=j(Nj);function Ij(e){const{text:t,rich_text:n,composed_wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,placeholder:r="...",created_at_ms:a,sim_ms:c}=e,l=n?pe.rich:pe.raw,d=zn({text:t,text_type:l,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:a,sim_ms:c});return _(io,{options:Yl,children:d&&Yt(d)||r})}const ty=Pj(Ij),Yl={overrides:{a:jj,script:e=>e.children,auto:e=>"",iframe:e=>{const{src:t}=e;return new URL(t).hostname==="www.youtube.com"?_("iframe",{...e}):null},tweet:e=>{const t=`https://platform.twitter.com/embed/Tweet.html?dnt=false&frame=false&hideCard=false&hideThread=false&id=${e.id}&lang=en-gb&theme=light&widgetsVersion=0a8eea3%3A1643743420422&width=400px"`;return _("iframe",{src:t,scrolling:"no",frameBorder:0,allowTransparency:!0,allowFullScreen:!0,style:{width:401,height:624}})},img:e=>{var t;return(t=e.style)==null||delete t.position,_("img",{src:e.src,style:e.style,alt:e.alt})}}};function li(e){const{wcomponents:t,allowed_wcomponent_ids:n,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a}=e;let c=t||Object.values(i);return n&&(c=c.filter(({id:d})=>n.has(d))),c.filter(Jo).filter(d=>!e.exclude_ids||!e.exclude_ids.has(d.id)).map(d=>{const p=at({wcomponent:d,text_type:pe.plain,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a});let f=`@@${d.id} -- ${d.title} -- ${d.description}`;return Ne(d)&&(f+=` -- @@${d.from_id} -> @@${d.to_id}`),{id:d.id,title:p,raw_title:d.title,subtitle:f,color:d.label_color}})}var Jl={},Rj=ee;Object.defineProperty(Jl,"__esModule",{value:!0});var ny=Jl.default=void 0,Dj=Rj(Q()),Mj=te(),Oj=(0,Dj.default)((0,Mj.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");ny=Jl.default=Oj;var Xl={},qj=ee;Object.defineProperty(Xl,"__esModule",{value:!0});var iy=Xl.default=void 0,Vj=qj(Q()),Fj=te(),zj=(0,Vj.default)((0,Fj.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"}),"Refresh");iy=Xl.default=zj;function Lj(e){const{editing_options:t,internal_options_to_display:n,is_option_wrapper_highlighted:i,conditional_on_change:o,set_highlighted_option_index:s,on_mouse_over_option:r,on_mouse_leave_option:a}=e;if(n.length===0||!t)return null;const c=45;return _("div",{className:"options_outer",style:{marginTop:15},children:_("div",{className:"options_inner",ref:l=>{if(!l)return;const d=`${document.body.clientHeight-l.clientTop-c}px`;l.style.setProperty("max-height",d)},children:n.map((l,d)=>_("div",{className:"option_wrapper "+(i(l,d)?" highlighted ":""),onMouseDown:()=>o(l.id),onMouseOver:()=>{s(d),r(l.id)},onMouseLeave:()=>a(l.id),children:_("div",{className:"option",children:[l.jsx||l.title||l.id||"none",_("div",{className:"option_subtitle",children:l.subtitle})]})}))})})}const Bj=e=>{var t;return{presenting:(t=e.display_options)==null?void 0:t.consumption_formatting}},Uj=j(Bj);function Wj(e){const t=Ee([]),n=Ee(p1.Index()),i=Ee([]);oe(()=>{const T=Yj(e.options,200,e.search_fields),L=Jj(T);t.current=L,T.forEach(ne=>{n.current=n.current.add(ne.id_num,ne.unlimited_total_text)}),i.current=T},[e.options,e.search_fields]);const o=Ee({actively_chosen:!1,id:void 0}),s=$(),[r,a]=I("");oe(()=>{a(e.initial_search_term||s)},[e.initial_search_term,s]);const{throttled:c,flush:l}=jc(a,300),[d,p]=I(!1);function f(T){T!==d&&p(T)}oe(()=>{f(!!e.start_expanded)},[e.start_expanded]);const{threshold_minimum_score:m=!1}=e,[h,v]=I([]);oe(()=>{const T=Xj({temp_value_str:r,selected_any_option:e.selected_option_id!==Zl,allow_none:!!e.allow_none,internal_options:i.current,prepared_targets:t.current,flexsearch_index:n.current,search_type:e.search_type||"best",threshold_minimum_score:m,retain_options_order:e.retain_options_order||!1});v(T.internal_options),e.set_search_type_used&&e.set_search_type_used(T.search_type_used),l()},[r,e.selected_option_id,e.allow_none,i.current,t.current,n.current,e.search_type,m]);const[g,b]=I(0),w=Ee(new Set),x=G(()=>T=>{T&&w.current.add(T),e.on_mouse_over_option&&e.on_mouse_over_option(T)},[e.on_mouse_over_option]),y=G(()=>T=>{T&&w.current.delete(T),e.on_mouse_leave_option&&e.on_mouse_leave_option(T)},[e.on_mouse_leave_option]);function $(){const T=Gj(e);return(T==null?void 0:T.title)||""}const C=(T,L)=>{T.stopImmediatePropagation();const ne=T.key,Ue=ne==="ArrowDown",Xe=ne==="ArrowUp",Tn=ne==="Enter",Bt=ne==="Escape";if(Tn||Bt)if(Tn){const ht=L[g];ht&&N(ht.id)}else Bt&&N(e.selected_option_id);else if(Ue||Xe){let ht=g+(Ue?1:-1);ht=ht%L.length,b(ht)}},E=()=>{f(!1),e.retain_invalid_search_term_on_blur||a($()),b(0)},N=T=>{E(),o.current={actively_chosen:!0,id:T}},A=()=>{E();const{on_mouse_leave_option:T}=e;T&&(w.current.forEach(Xe=>T(Xe)),w.current=new Set);const{actively_chosen:L,id:ne}=o.current;if(!L)return;o.current={actively_chosen:!1,id:void 0},e.selected_option_id===ne?e.on_choose_same&&e.on_choose_same(ne):e.on_change(ne)},M=Kj(h,r),D=(M==null?void 0:M.id)===Lc.id&&e.allow_none||r.toLowerCase()===(M==null?void 0:M.title.toLowerCase());return _("div",{class:"editable_field autocomplete "+(D?"":"invalid "),style:e.extra_styles,children:[_(kn,{variant:"standard",disabled:e.editing_allowed!==void 0?!e.editing_allowed:e.presenting,ref:T=>{if(!T)return;const L=T.getElementsByTagName("input")[0];L&&setTimeout(d?()=>L.focus():()=>L.blur(),0)},placeholder:e.placeholder,value:r||(d?"":"-"),onFocus:T=>{setTimeout(()=>f(!0),0),T.currentTarget.setSelectionRange(0,T.currentTarget.value.length)},onChange:T=>c(T.currentTarget.value),onKeyDown:T=>C(T,h),onBlur:()=>A()}),_(Lj,{editing_options:d,internal_options_to_display:h,is_option_wrapper_highlighted:(T,L)=>L===g,conditional_on_change:N,set_highlighted_option_index:b,on_mouse_over_option:x,on_mouse_leave_option:y})]})}const Hj=Uj(Wj);function Pe(e){return _(Hj,{...e})}function Gj(e){return e.selected_option_id===void 0?e.allow_none?void 0:e.options[0]:e.options.find(({id:t})=>t===e.selected_option_id)}function Kj(e,t){const n=t.toLowerCase();return e.find(i=>i.title.toLowerCase()===n)}const oy=1;function Yj(e,t,n="all"){let i=oy;const o=n==="all";return e.filter(({is_hidden:r})=>!r).map(r=>{const a=gh(r,t,o),c=gh(r,0,o);return{...r,limited_total_text:a,unlimited_total_text:c,id_num:i++}})}function gh(e,t,n){let i=mc(e.title,t);return n?i+=e.subtitle?" "+mc(e.subtitle,t):"":i+=e.raw_title?" "+mc(e.raw_title,t):"",i}function mc(e,t){return t?e.slice(0,t)+(e.length>t?"...":""):e}function Jj(e){return e.map(({limited_total_text:t})=>Jh.prepare(t))}const Zl=void 0,Lc={id:Zl,id_num:oy-1,title:"(clear)",limited_total_text:"clear",unlimited_total_text:""};function Xj(e){const{temp_value_str:t,selected_any_option:n,allow_none:i,prepared_targets:o,flexsearch_index:s,search_type:r,threshold_minimum_score:a,retain_options_order:c}=e;let{internal_options:l}=e,d;if(!t)return l=i&&n?[Lc,...l]:l,{internal_options:l,search_type_used:d};let p=g=>0,f=g=>0,m=0;if(r==="best"||r==="exact"){d="exact";const g=s.search(t);m=g.length;const b={};g.forEach((w,x)=>b[w]=1e4-x),p=w=>b[w.id_num]||-1e4}if(m<10&&(r==="best"||r==="fuzzy")){d="fuzzy";const g={limit:100,allowTypo:!0,threshold:-1e4},b=Jh.go(t,o,g),w={};b.forEach(({target:x,score:y})=>w[x]=y),f=x=>{const y=w[x.limited_total_text];return y===void 0?p(x):y}}else f=p;const h=a===!1?l:l.filter(g=>f(g)>a);let v=h;return c||(v=Ke(h,f,Be.descending)),i&&n&&(v=[Lc,...v]),{internal_options:v,search_type_used:d}}function Zj(e,t){const n=e.global_keys.last_key==="Escape",{last_key_time_stamp:i=0}=e.global_keys;return{should_close:n&&i>t.time_stamp_first_rendered}}const Qj=j(Zj);function eN(e){const{on_close:t}=e;return t&&e.should_close&&setTimeout(()=>t(),0),_("div",{id:"modal_background",className:(e.size||"medium")+"_modal",onClick:n=>{n.stopImmediatePropagation(),t&&t(n)},children:_("div",{id:"modal_container",style:e.scrollable===!1?{overflowY:"hidden"}:void 0,onClick:n=>n.stopPropagation(),children:[_("div",{id:"modal_title",children:e.title}),t&&_("div",{id:"modal_close",onClick:n=>t(n),children:_("span",{children:"X"})}),e.child]})})}const tN=Qj(eN);function di(e){const t=performance.now();return _(tN,{...e,time_stamp_first_rendered:t})}function nN(e){const[t,n]=I("all"),[i,o]=I("best"),[s,r]=I(void 0),[a,c]=I(!1),l=_(bs,{titleAccess:"You might be getting sub optimal search results!",style:{color:H0[600]}}),d=()=>i=="best"&&t=="all";return _(di,{on_close:()=>e.on_blur&&e.on_blur(),title:e.search_window_title,child:_(R,{p:5,children:[_(bi,{onChange:(p,f)=>{c(f)},children:[_(yi,{expandIcon:!d()&&!a?l:_(ny,{}),children:_(ae,{component:"h2",children:[a?"Hide ":"Show ","Advanced Search Options"]})}),_(ki,{children:_(R,{width:1,children:[_(R,{display:"flex",justifyContent:"flex-start",alignItems:"stretch",children:[_(R,{mr:10,flexGrow:1,flexShrink:0,children:_(et,{variant:"standard",component:"fieldset",fullWidth:!0,children:[_(Wn,{component:"legend",children:"Search Type: "}),_(Kd,{name:"search_type",value:i,onChange:p=>o(p.target.value),children:[_(pi,{value:"exact",control:_(mi,{}),label:"Exact"}),_(pi,{value:"fuzzy",control:_(mi,{}),label:"Fuzzy"}),_(pi,{value:"best",control:_(mi,{}),label:"Best"})]})]})}),_(R,{mr:10,flexGrow:1,flexShrink:0,children:_(et,{variant:"standard",component:"fieldset",fullWidth:!0,children:[_(Wn,{component:"legend",children:"Search Over: "}),_(Kd,{name:"search_fields",value:t,onChange:p=>n(p.target.value),children:[_(pi,{value:"all",control:_(mi,{}),label:"All"}),_(pi,{value:"title",control:_(mi,{}),label:"Title Only"})]})]})}),_(R,{flexGrow:1,flexShrink:0,alignSelf:"flex-end",textAlign:"right",children:!d()&&_(je,{variant:"contained",color:"primary",onClick:()=>{o("best"),n("all")},endIcon:_(iy,{}),children:"Reset Search Options"})})]}),_(R,{style:{opacity:s?.7:0},children:["Used: ",s]})]})})]}),_(Pe,{placeholder:e.placeholder,selected_option_id:e.selected_option_id,initial_search_term:e.initial_search_term,options:e.options,allow_none:e.allow_none,on_change:p=>{e.on_change(p),e.on_blur&&e.on_blur()},on_mouse_over_option:e.on_mouse_over_option,on_mouse_leave_option:e.on_mouse_leave_option,extra_styles:e.extra_styles,start_expanded:!0,retain_invalid_search_term_on_blur:!0,search_fields:t,search_type:i,set_search_type_used:r,editing_allowed:!0,threshold_minimum_score:-1e3})]})})}const iN=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:ft(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),oN=j(iN);function sN(e){const t=li(e);return _(nN,{search_window_title:"Search for a Component",placeholder:"Search for a Component...",selected_option_id:"",initial_search_term:e.initial_search_term,allow_none:!0,options:t,on_change:e.on_change,on_blur:e.on_blur})}const sy=oN(sN);function rN(e){const{value:t,id_insertion_point:n,conditional_on_change:i,on_close:o}=e,s=_N({value:t,id_insertion_point:n}),r=Ee(!1);return _(sy,{initial_search_term:s,on_change:a=>{const c=aN({value:t,id_to_insert:a,id_insertion_point:n}),l=n+((a==null?void 0:a.length)||0),d=l+((s==null?void 0:s.length)||0),p={start:l,end:d};r.current=!0,i({new_value:c,on_focus_set_selection:p})},on_blur:()=>{if(r.current)return;const a=n+((s==null?void 0:s.length)||0);o({start:n,end:a})}})}function _N(e){const n=e.value.slice(e.id_insertion_point).match(/^(\w+)/);return n&&n[1]||""}function aN(e){const{value:t,id_to_insert:n,id_insertion_point:i}=e;return n===void 0?t:t.slice(0,i)+n+t.slice(i)}var K=(e=>(e[e.conditional=0]="conditional",e[e.always=1]="always",e))(K||{});const cN=e=>({presenting:e.display_options.consumption_formatting}),lN=j(cN);function dN(e){const{placeholder:t,disabled:n,presenting:i,editing_allowed:o,select_all_on_focus:s,force_focus_on_first_render:r,on_blur_type:a=0}=e,[c,l]=I(e.value);oe(()=>l(e.value),[e.value]);const d=Ee(void 0),p=Ee(void 0);if(o===!1||!e.conditional_on_change&&!e.on_blur||n||i&&o===void 0){const A=n?"disabled":"",M=!!e.value;return _("div",{className:A,children:[M&&!e.hide_label&&_("span",{className:"description_label",children:[e.placeholder," "]}),_(ty,{text:c||t})]})}const f=`editable_field ${c?"":"placeholder"}`,m=G(()=>A=>{if(!A)return;const M=!d.current;d.current=A,M&&uN({el:A,force_focus_on_first_render:r})},[]),h=G(()=>A=>{pN({e:A,select_all_on_focus:s})},[s]),v=G(()=>A=>{A!==e.value&&e.conditional_on_change&&e.conditional_on_change(A),l(A)},[e.value,e.conditional_on_change]),g=G(()=>A=>{e.modify_value_pre_on_blur&&(A=e.modify_value_pre_on_blur(A));const M=A!==e.value;(a===1||M)&&e.on_blur&&e.on_blur(A),l(A)},[e.value,a,e.on_blur]),b=G(()=>A=>{if(p.current!==void 0)return;const M=vN(A.currentTarget);M!==void 0&&(p.current=M),v(A.currentTarget.value)},[v]),w=G(()=>A=>{p.current===void 0&&g(A.currentTarget.value)},[e.value,g]),x=G(()=>A=>{mN(A,d.current,v,g)},[v,g]),y=Ee(g);y.current=g,oe(()=>()=>{!d.current||!(document.activeElement===d.current)||y.current(d.current.value)},[]);const[$,C]=I({}),E=G(()=>A=>{var M,D;(M=d.current)==null||M.focus(),p.current=void 0,C({}),(D=d.current)==null||D.setSelectionRange(A.start,A.end)},[]),N=G(()=>e.component({value:c,on_render:m,on_focus:h,on_change:b,on_blur:w,on_key_down:x}),[c,m,h,b,w]);return _("div",{className:f,style:e.style,children:[N,p.current!==void 0&&_("div",{style:{fontSize:"initial",fontWeight:"initial"},children:_(rN,{value:c,id_insertion_point:p.current,conditional_on_change:({new_value:A,on_focus_set_selection:M})=>{v(A),setTimeout(()=>E(M),0)},on_close:A=>{E(A)}})})]})}const ry=lN(dN);function uN(e){e.force_focus_on_first_render&&setTimeout(()=>e.el.focus(),0)}function pN(e){if(e.select_all_on_focus){const t=e.e.currentTarget;t.setSelectionRange(0,t.value.length)}}function mN(e,t,n,i){document.activeElement===t&&(fN(e,t,n),hN(e,t,i))}function fN(e,t,n){if(!e.ctrlKey||e.key!=="k")return;e.preventDefault();const{value:i,selectionStart:o}=t;let{selectionEnd:s}=t;if(typeof o!="number")return;typeof s!="number"&&(s=o);const r=i.slice(o,s),a=r?r.startsWith("http")?0:1:2,c=a===1?r:"title",l=a===0?r:"url",d=i.slice(0,o)+"["+c+"]("+l+")"+i.slice(s);n(d);let p=o+1,f=p+c.length;a===1&&(p=s+3,f=p+l.length),setTimeout(()=>t.setSelectionRange(p,f),0)}function hN(e,t,n){if(e.ctrlKey&&e.key==="e"){n(t.value);return}e.key!=="Shift"&&e.key!=="Control"&&e.stopImmediatePropagation()}function vN({selectionStart:e,value:t}){if(typeof e=="number"){const n=t[e-2],i=t[e-1];if(n==="@"&&i==="@"&&ye().getState().global_keys.last_key==="@")return e}}function ei(e){return _(ry,{...e,component:({value:t,on_render:n,on_focus:i,on_change:o,on_blur:s,on_key_down:r})=>_(kn,{fullWidth:!0,size:"small",variant:"standard",label:e.placeholder,multiline:!0,value:t,onFocus:i,onChange:o,onBlur:s,onKeyDown:r,inputRef:n,spellcheck:e.spellcheck})})}function be(e){const t=G(()=>({value:n,on_render:i,on_focus:o,on_change:s,on_blur:r,on_key_down:a})=>_(kn,{fullWidth:!0,label:e.placeholder,variant:"outlined",value:n,onFocus:o,onChange:s,onBlur:r,onKeyDown:a,size:e.size,inputRef:i,spellcheck:e.spellcheck,disabled:e.disabled_input,title:e.title}),[e.placeholder,e.size,e.spellcheck,e.disabled_input,e.title]);return _(ry,{...e,component:t})}const gN=(e,t)=>{const n=e.routing,{selected_on:i=new Set}=t;let o=i.size>0;return i.size&&(i.has("route")&&t.route!==void 0&&(o=o&&t.route===n.route),t.args&&(i.has("args.view")&&t.args.view!==void 0&&(o=o&&t.args.view===n.args.view),i.has("args.subview_id")&&t.args.subview_id!==void 0&&(o=o&&t.args.subview_id===n.args.subview_id))),{current_routing_state:n,selected:o}},wN=(e,t)=>({change_route:n=>e(S.routing.change_route({route:t.route,sub_route:t.sub_route,item_id:t.item_id,args:n}))}),_y=j(gN,wN);function bN(e){const{children:t="Link"}=e,[n,i]=I(!1),o=Ee(void 0);if(e.disabled)return t;n&&!o.current&&(o.current=setTimeout(()=>{i(!1),o.current=void 0},300));const s=e.args||{},r=d=>{d.stopImmediatePropagation(),d.preventDefault(),!e.selected&&(i(!0),!(e.on_pointer_down&&e.on_pointer_down())&&e.change_route(s))},a=It(e.current_routing_state,e),c={...e.current_routing_state.args,...s};a.args=c;const l="link "+(n?" clicked_animate ":"")+(e.selected?" selected ":"")+(e.extra_class_name||"");return _("a",{onPointerDown:r,onClick:d=>{d.stopImmediatePropagation(),d.preventDefault()},href:Zn({...a}),className:l,style:e.extra_css_style,children:t})}const Je=_y(bN);function yN(e){const t=e.args||{},n=s=>{s.stopImmediatePropagation(),s.preventDefault(),!(e.on_pointer_down&&e.on_pointer_down())&&e.change_route(t)},i=It(e.current_routing_state,e),o={...e.current_routing_state.args,...t};return i.args=o,_(je,{size:"small",color:"primary",variant:"contained",onClick:n,href:Zn({...i}),children:e.name||"Link"})}const kN=_y(yN);function Li(e){const[t,n]=I(e.ready_to_progress??!1),{tooltip_text:i=""}=e;return _("div",{style:{display:"flex",justifyContent:"space-between",margin:"4px 0px"},children:[_(Ac,{injectFirst:!0,children:_($c,{theme:U0,children:_(F,{color:"secondary",disabled:e.disabled,is_hidden:!t,onClick:o=>{o.stopImmediatePropagation(),n(!1),e.on_click&&e.on_click()},startIcon:e.button_icon,children:_(ze,{title:i,"aria-label":i,children:_(R,{component:"span",children:"CONFIRM"})})})})}),_(Ac,{injectFirst:!0,children:_($c,{theme:Bh,children:_(F,{color:"primary",disabled:e.disabled,fullWidth:!t,is_hidden:!e.on_click,onClick:o=>{o.stopImmediatePropagation(),n(!t),t&&e.on_cancel&&e.on_cancel()},startIcon:t?"":e.button_icon,children:_(ze,{title:t?"":i,"aria-label":t?"":i,children:_(R,{component:"span",children:t?"Cancel":e.button_text})})})})})]})}function Cn(e){var n,i;let{className:t=""}=e;return t="MuiSvgIcon-root "+t,e.fontSize==="small"&&(t+=" MuiSvgIcon-fontSizeSmall "),_("span",{title:e.title,style:{width:(n=e.style)==null?void 0:n.width,height:(i=e.style)==null?void 0:i.height},children:_("svg",{className:t,viewBox:"0 0 24 24",style:e.style,children:[_("path",{d:e.d}),e.svg_elements]})})}const xN="M19 5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 14h-14v-5h14z m0 -12v5h-14v-5h1v-2h12v2z m-3 -2h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function SN(e){return _(Cn,{...e,d:xN})}const AN="M19 2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 7h-14v-5h14z m0 7h-1v2h-12v-2h-1v-5h14z m-3 0h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function $N(e){return _(Cn,{...e,d:AN})}function CN(e){const[t,n]=I(!1);return _(ue,{children:[_(ze,{title:"Add above",children:_(ce,{onClick:()=>e.update_calculations("add_above"),size:"large",children:_(SN,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),_(ze,{title:"Add below",children:_(ce,{onClick:()=>e.update_calculations("add_below"),size:"large",children:_($N,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),_(ze,{title:"Move up",children:_(ce,{onClick:()=>e.update_calculations("move_up"),size:"large",disabled:e.disallowed_commands.has("move_up"),children:_(G0,{})})}),_(ze,{title:"Move down",children:_(ce,{onClick:()=>e.update_calculations("move_down"),size:"large",disabled:e.disallowed_commands.has("move_down"),children:_(K0,{})})}),!t&&_(ce,{onClick:()=>n(!0),size:"large",children:_(Po,{})}),t&&_(Li,{on_click:e.delete_calculation,button_text:"",button_icon:_(Po,{}),ready_to_progress:!0,on_cancel:()=>n(!1)})]})}const TN=e=>({editing:!e.display_options.consumption_formatting}),EN=j(TN);function jN(e){const t=e.value!==void 0?e.value.toString():"",{allow_undefined:n,conditional_on_change:i,on_blur:o,on_blur_type:s,disabled:r,editing:a,default_value_when_invalid:c=0,editing_allowed:l}=e;let d="editable_number";if(!a||!i&&!o||r){d=d+(a?"":" not_editable ")+(r?" disabled ":"");const p=e.value!==void 0;return _("div",{className:d,style:e.style,children:[p&&_("span",{className:"description_label",children:e.placeholder})," ",p?e.value:e.placeholder]})}return _("div",{className:d,style:e.style,children:_(be,{placeholder:e.placeholder,size:e.size||"small",style:e.style,value:t,editing_allowed:l,select_all_on_focus:!0,conditional_on_change:p=>{if(!i)return;const f=ay(p,c);(cy(i,n)||f!==void 0)&&i(f)},on_blur:p=>{o&&NN({value:p,default_value_when_invalid:c,on_blur:o,allow_undefined:n})},on_blur_type:s||K.conditional})})}const rt=EN(jN);function ay(e,t){if(!e)return;const n=parseFloat(e);return Number.isNaN(n)?t:n}function cy(e,t){return!!t}function NN({value:e,default_value_when_invalid:t,on_blur:n,allow_undefined:i}){let o=ay(e,t);cy(n,i)||o===void 0&&(o=t),n(o)}function PN(e){const{result:t,default_significant_figures:n,temp_result_sig_figs:i,set_temp_result_sig_figs:o,result_display_type:s,update_calculation:r}=e,a=IN(t,i??n);return _("div",{style:{display:"flex"},children:[_("div",{"data-tooltip":"Significant figures","data-tooltip_left_-10":!0,"data-tooltip_bottom_-60":!0,children:_(rt,{size:"small",style:{marginLeft:5,marginTop:5,width:"80px"},placeholder:"Sig. figs",value:i,allow_undefined:!0,conditional_on_change:c=>{c=wh(c),o(c)},on_blur_type:K.always,on_blur:c=>{c=wh(c),o(c??n),r({result_sig_figs:c})}})}),_("div",{"data-tooltip":"Display type","data-tooltip_left_0":!0,"data-tooltip_bottom_-60":!0,style:{marginLeft:"10px",width:"120px"},children:[_("div",{className:"description_label",children:"Format"}),_(Pe,{selected_option_id:s,options:a,retain_options_order:!0,on_change:c=>{const l=a.find(p=>p.id===c),d=l==null?void 0:l.result_display_type;r({result_display_type:d})}})]})]})}function wh(e){if(e!==void 0)return Math.max(Math.round(e),0)}function IN(e,t){e=e??1000.23;const n={bare:{id:"bare",order:0,result_display_type:"bare",title:W(e,t,V.bare)},simple:{id:"simple",order:1,result_display_type:"simple",title:W(e,t,V.simple)},scaled:{id:"scaled",order:2,result_display_type:"scaled",title:W(e,t,V.scaled)},percentage:{id:"percentage",order:4,result_display_type:"percentage",title:W(e,t,V.percentage)},abbreviated_scaled:{id:"abbreviated_scaled",order:3,result_display_type:"abbreviated_scaled",title:W(e,t,V.abbreviated_scaled)},scientific:{id:"scientific",order:5,result_display_type:"scientific",title:W(e,t,V.scientific)}},i={...n};return n.abbreviated_scaled.title===n.scaled.title&&delete i.abbreviated_scaled,n.scaled.title===n.simple.title&&delete i.scaled,n.simple.title===n.bare.title&&delete i.simple,Object.values(i).sort((s,r)=>s.order-r.order)}const RN=2;function ly(e){const t=parseInt(e,10);return uy(t)?4:RN}function dy(e){const t=parseInt(e,10);return uy(t)?V.bare:e.trim().match(/\d+\.?\d*\s*\%/)?V.percentage:V.simple}function uy(e){return Number.isSafeInteger(e)&&e>=1900&&e<=2200}function mn(e,t=""){const n=t.toUpperCase(),i=DN(e);if(t&&!i.has(n))return t;let o=MN(t||"A"),s=bh(o);for(;i.has(s);)o=ON(o),s=bh(o);return t&&(s=qN(s,t)),s}function DN(e){return new Set([...Tc,...e].map(n=>n.toUpperCase().replaceAll(/\s*/g,"")))}function MN(e){return e=e.toUpperCase(),e.split("").map(t=>t.charCodeAt(0)).filter(t=>t>=65&&t<=90)}function bh(e){return e.map(t=>String.fromCharCode(t)).join("")}function ON(e){let t=!1;for(let n=e.length-1;n>=0;--n)if(e[n]=e[n]+1,e[n]>90)e[n]=65,t=!0;else{t=!1;break}return t&&e.push(65),e}function qN(e,t){return e.split("").map((n,i)=>{const o=t.charCodeAt(i);return o>=97&&o<=122&&(n=n.toLowerCase()),n}).join("")}function py(e){return e.replaceAll("*","\\*")}function VN(e){const{calculation:t,calculation_result:n,editing:i,existing_calculation_name_ids:o,show_options:s,set_show_options:r}=e,a=ly(t.value),{result_sig_figs:c=a}=t,[l,d]=I(c),p=dy(t.value),{result_display_type:f=p}=t;if(!i&&!t.value&&!t.units)return null;let m=_("div",{});if(n!==void 0&&n.value!==void 0){const b=W(n.value,l??a,f),{source_wcomponent_id:w}=n;m=_("div",{children:[" = ",_(Je,{disabled:w===void 0,route:"wcomponents",sub_route:void 0,item_id:w,args:void 0,extra_class_name:"normal",children:[b,n.units&&_("span",{style:{fontSize:"14px"},children:[" ",n.units]}),t.result_description&&_("span",{style:{fontSize:"14px"},children:[" ",_(ty,{text:t.result_description})]})]})]})}const h=i||my(t.value),v=!!t.value.match(O1),g={display:"flex"};return _(R,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",marginBottom:i?"18px":void 0,flexDirection:i?"column":"row",style:{display:"flex"},className:"form_section "+(s?"":"hidden_border"),children:[_(Rb,{result:n}),_("div",{style:{width:"100%",display:"flex"},children:[_(be,{size:"small",placeholder:"",hide_label:!0,value:t.name,on_blur:b=>{const w=o.filter(y=>y!==t.name),x=mn(w,b);e.update_calculation({...t,name:x})},on_blur_type:K.conditional}),h&&_(ue,{children:[" = ",_(ei,{placeholder:"Calculation",hide_label:!0,value:i?t.value:py(t.value),on_blur:b=>e.update_calculation({...t,value:b}),on_blur_type:K.conditional})," "]}),i&&_("div",{children:[_(be,{placeholder:"Units",hide_label:!0,disabled_input:v,title:v?"Editing disabled: edit units of referenced component":void 0,value:(v?n==null?void 0:n.units:t.units)||"",modify_value_pre_on_blur:b=>v?(n==null?void 0:n.units)||"":b,on_blur:b=>e.update_calculation({...t,units:b||void 0}),on_blur_type:K.conditional}),!v&&(n==null?void 0:n.units)&&n.units!==t.units&&_("span",{style:{fontSize:"10px",color:"#9b8465",cursor:"pointer"},onClick:()=>{e.update_calculation({...t,units:n.units})},children:["Suggestion: ",n.units]})]}),!i&&m]}),i&&_("div",{style:{...g,marginTop:void 0},children:[m,_(ce,{onClick:()=>r(!s),size:"small",style:{marginLeft:"auto"},children:_(Uh,{})})]}),e.editing&&s&&_(PN,{result:n==null?void 0:n.value,default_significant_figures:a,temp_result_sig_figs:l,set_temp_result_sig_figs:d,result_display_type:f,update_calculation:b=>{e.update_calculation({...t,...b})}}),e.editing&&s&&_("div",{style:{...g,marginLeft:10,marginTop:20},children:_("div",{style:{display:"flex"},children:_(be,{size:"small",placeholder:"Description",value:t.result_description||"",on_blur_type:K.conditional,on_blur:b=>{const w=b||void 0;e.update_calculation({...t,result_description:w})}})})}),e.editing&&s&&_("div",{style:{...g,justifyContent:"flex-end"},children:_(CN,{delete_calculation:()=>e.update_calculation(null),disallowed_commands:e.disallowed_commands,update_calculations:e.update_calculations})})]})}const FN=/.*[\^*/+\-()><=].*/g;function my(e){let t="";for(;t=e.replace(M1,"$1$3"),t!==e;)e=t;return!!t.match(FN)}const zN=k.delay("EditableCalculationRow support functions",()=>{k("should_show_calc_value",()=>{let e,t;e="(@@02d4a5f4-4abd-41a2-bb50-e68e358a3169/@@e34796cf-ab9e-47b8-9ea5-20cb00fb611d)*@@86635a8b-f4f8-4489-8a02-b4f09c0a22ec",t=my(e),u(t,!0,"Should return true for calculation with wcomponent ids")})}),LN=k.delay("get default formatting function",()=>{const e=[{calc_value:"  81.2  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when valid number with decimal space",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when only valid number"},{calc_value:"  1899  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (1899) outside of 1900-2200",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when integer number (1899) outside of 1900-2200"},{calc_value:"  1900  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (1900) inside of 1900-2200",expected_result_display_type:V.bare,test_description__result_display_type:"Should assign simple type when integer number (1900) inside of 1900-2200"},{calc_value:"  2200  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (2200) inside of 1900-2200",expected_result_display_type:V.bare,test_description__result_display_type:"Should assign simple type when integer number (2200) inside of 1900-2200"},{calc_value:"  2201  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (2201) outside of 1900-2200",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when integer number (2201) outside of 1900-2200"},{calc_value:"  81.2 %  ",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:V.percentage,test_description__result_display_type:"Should assign percentage type when % included with valid number containing spaces and decimal"},{calc_value:"83%",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:V.percentage,test_description__result_display_type:"Should assign percentage type when % included with simple valid number without spaces or decimal"}];k("get_default_significant_figures",()=>{let t;e.forEach(n=>{t=ly(n.calc_value),u(t,n.expected_sig_figs,n.test_description__sig_figs)})}),k("get_default_result_display_type",()=>{let t;e.forEach(n=>{t=dy(n.calc_value),u(t,n.expected_result_display_type,n.test_description__result_display_type)})})}),BN=k.delay("get_valid_calculation_name_id",()=>{let e,t,n,i;t=[],e=void 0,n="A",i=mn(t,e),u(i,n,"Without any other IDs"),t=["A"],e=void 0,n="B",i=mn(t,e),u(i,n,'With an existing ID of "A"'),t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],e=void 0,n="AA",i=mn(t,e),u(i,n,'With existing IDs of "A" up to "Z"'),t=["A","B"],e="a",n="c",i=mn(t,e),u(i,n,'With existing IDs of "A" and "B", and given a  lower case "a"'),t=["food"],e="Food",n="Fooe",i=mn(t,e),u(i,n,'With an existing ID of "food" and given "Food"')}),UN=k.delay("make_calculation_safe_for_rich_text",()=>{let e,t,n;e="A * B * C",n="A \\* B \\* C",t=py(e),u(t,n,"Should escape *")});function Bc(e){const{editing_allowed:t,wcomponent_id:n,knowledge_view:i,composed_wc_id_maps_object:o,foundation_composed_wc_id_map:s}=e,r={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},a=i.wc_id_map[n],c=o.composed_wc_id_map[n],l=!!(!a||a.blocked||a.passthrough);return r.show_wcomponent_status_in_this_kv_section=!!(i.id&&l),r.show_wcomponent_status_in_this_kv_section&&(r.wcomponent_status_in_this_kv_text=(a!=null&&a.blocked?"Deleted from":"Not present in")+" this knowledge view"+(c&&!c.blocked?" but is present in a foundational knowledge view":"")),r.show_add_button=r.show_wcomponent_status_in_this_kv_section&&t,r.show_add_button&&(r.add_button_text=(a!=null&&a.blocked?"Re-add":"Add")+" to current knowledge view"),r.show_remove_button=!!(t&&a&&!a.passthrough),r.show_remove_button&&(r.remove_button_text="Remove from knowledge view",r.remove_button_tooltip="Remove from current knowledge view ("+i.title+")",a!=null&&a.blocked&&s[n]&&(r.remove_button_text="Remove block (allow to show through from foundational knowledge view)",r.remove_button_tooltip="This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view ("+i.title+")")),r.show_remove_and_block_button=!!(t&&a&&!a.blocked&&!a.passthrough&&s[n]),r.show_remove_and_block_button&&(r.remove_and_block_button_text="Remove and Block from knowledge view",r.remove_and_block_button_tooltip="Remove and Block from showing in current knowledge view ("+i.title+")"),r}function fc(e,t,n){const i=new Date("2023-03-22 15:15:00");return{id:t,foundation_knowledge_view_ids:n?[n]:void 0,wc_id_map:e,title:"some title of "+t,description:"",sort_type:"normal",created_at:i,base_id:1}}const WN=k.delay("get_UI_data__wcomponent_add_or_for_knowledge_view",()=>{k("simple single knowledge view with no foundation",()=>{const e=fc({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0}},"kv1"),t={[e.id]:e},n=kt(e,t,!0),i=st(n,{}),o=kt(e,t,!1),s=st(o,{});u(i,{composed_wc_id_map:{wc2:{left:20,top:0}},composed_blocked_wc_id_map:{wc4:{left:40,top:0,blocked:!0}}},"Sanity check (no1) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),u(s,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}},"Sanity check (no2) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function c(p,f){return Bc({editing_allowed:p,wcomponent_id:f,knowledge_view:e,composed_wc_id_maps_object:i,foundation_composed_wc_id_map:s.composed_wc_id_map})}let l,d;k("editing_allowed is true",()=>{l=c(!0,"wc1"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent not yet added to knowledge view"),l=c(!0,"wc2"),d={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},u(l,d,"with normal wcomponent entry in knowledge view"),l=c(!0,"wc3"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent removed from this knowledge view"),l=c(!0,"wc4"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},u(l,d,"with wcomponent blocked from this knowledge view")}),k("editing_allowed is false",()=>{l=c(!1,"wc1"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent not yet added to knowledge view"),l=c(!1,"wc2"),d={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with normal wcomponent entry in knowledge view"),l=c(!1,"wc3"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent removed from this knowledge view"),l=c(!1,"wc4"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(l,d,"with wcomponent blocked from this knowledge view")})}),k("knowledge view with single knowledge view foundation",()=>{const e=fc({wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222},wc9:{left:90,top:222,passthrough:!0},wc10:{left:100,top:222,passthrough:!0},wc11:{left:110,top:222,passthrough:!0},wc12:{left:120,top:222,passthrough:!0},wc13:{left:130,top:222,blocked:!0},wc14:{left:140,top:222,blocked:!0},wc15:{left:150,top:222,blocked:!0},wc16:{left:160,top:222,blocked:!0}},"kv1"),t=fc({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0},wc6:{left:60,top:0},wc7:{left:70,top:0,passthrough:!0},wc8:{left:80,top:0,blocked:!0},wc10:{left:100,top:0},wc11:{left:110,top:0,passthrough:!0},wc12:{left:120,top:0,blocked:!0},wc14:{left:140,top:0},wc15:{left:150,top:0,passthrough:!0},wc16:{left:160,top:0,blocked:!0}},"kv2",e.id),n={[e.id]:e,[t.id]:t},i=kt(t,n,!0),o=st(i,{}),s=kt(t,n,!1),r=st(s,{});u(o,{composed_wc_id_map:{wc2:{left:20,top:0},wc5:{left:50,top:222},wc6:{left:60,top:0},wc7:{left:70,top:222},wc10:{left:100,top:0},wc14:{left:140,top:0}},composed_blocked_wc_id_map:{wc4:{blocked:!0,left:40,top:0},wc8:{blocked:!0,left:80,top:0},wc12:{blocked:!0,left:120,top:0},wc13:{blocked:!0,left:130,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:0}}},"Sanity check (no3) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),u(r,{composed_wc_id_map:{wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222}},composed_blocked_wc_id_map:{wc13:{blocked:!0,left:130,top:222},wc14:{blocked:!0,left:140,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:222}}},"Sanity check (no4) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function l(f,m){return Bc({editing_allowed:f,wcomponent_id:m,knowledge_view:t,composed_wc_id_maps_object:o,foundation_composed_wc_id_map:r.composed_wc_id_map})}let d,p;k("editing_allowed is true",()=>{k("with wcomponent not yet added to foundational knowledge view",()=>{d=l(!0,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")}),k("with wcomponent added to foundational knowledge view",()=>{d=l(!0,"wc5"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc6"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!0,remove_and_block_button_text:"Remove and Block from knowledge view",remove_and_block_button_tooltip:"Remove and Block from showing in current knowledge view (some title of kv2)"},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc7"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc8"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove block (allow to show through from foundational knowledge view)",remove_button_tooltip:"This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")}),k("with wcomponent removed from foundational knowledge view",()=>{d=l(!0,"wc9"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc10"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc11"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc12"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")}),k("with wcomponent removed and blocked in foundational knowledge view",()=>{d=l(!0,"wc13"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc14"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc15"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc16"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},u(d,p,"and with wcomponent blocked from this top/current/child knowledge view")})}),k("editing_allowed is false",()=>{k("with wcomponent not yet added to foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")}),k("with wcomponent added to foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")}),k("with wcomponent removed from foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")}),k("with wcomponent removed and blocked in foundational knowledge view",()=>{d=l(!1,"wc1"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),p={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),p={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},u(d,p,"with wcomponent blocked from this knowledge view")})})})});async function HN(){Jd.reset(),(await L1)(),(await VT)(),await(await FT)(),(await ok)(),(await rk)(),(await ak)(),(await lk)(),(await uk)(),(await RC)(),(await DC)(),(await zC)(),(await r7)(),(await b$)(),(await f7)(),(await w7)(),(await b7)(),(await S7)(),(await MT)(),(await qT)(),(await hC)(),(await gC)(),(await wC)(),(await Y2)(),(await zT)(),(await BT)(),(await UT)(),(await WT)(),(await HT)(),(await GT)(),(await KT)(),(await YT)(),(await JT)(),(await XT)(),(await eE)(),(await v3)(),(await N3)(),(await tE)(),(await nE)(),(await ZT)(),(await yS)(),(await xS)(),(await iE)(),(await oE)(),(await sE)(),(await rE)(),(await _E)(),(await aE)(),(await uE)(),(await pE)(),(await mE)(),(await xk)(),(await fE)(),(await hE)(),(await vE)(),(await hk)(),(await bk)(),(await wE)(),(await bE)(),(await yE)(),(await bC)(),(await zN)(),(await LN)(),(await BN)(),(await UN)(),(await WN)(),await MC(),await OC(),Jd.print()}function GN(){window.run_tests=HN}var Uc=(e=>(e.click="click",e.drag="drag",e))(Uc||{});const se={help:{shortcut:["?"],outcome:"Opens this help menu"},fit_view:{shortcut:["space"],outcome:"Fit view to components / cycle between groups of components."},toggle_present_edit:{shortcut:["Ctrl","e"],outcome:"Toggle between presentation and editing modes"},toggle_side:{shortcut:["Ctrl","d","s"],outcome:"Toggle showing side panel"},toggle_time:{shortcut:["Ctrl","d","t"],outcome:"Toggle showing time sliders"},toggle_focused:{shortcut:["Ctrl","d","f"],outcome:'Toggle "focused" mode on and off'},toggle_animating:{shortcut:["Ctrl","d","a"],outcome:"Toggle animating connections"},toggle_circular_connections:{shortcut:["Ctrl","d","c"],outcome:"Toggle showing connections as (more) circular"},select_multiple:{shortcut:["Shift","click","drag"],outcome:"Select multiple nodes"},deselect_multiple:{shortcut:["Shift","Ctrl","click","drag"],outcome:"Deselect multiple nodes"},select_all:{shortcut:["Ctrl","a"],outcome:"Select all nodes on knowledge view"},expand_select_forwards:{shortcut:["Ctrl","s","f"],outcome:"Expand selection towards effects (forwards)"},expand_select_backwards:{shortcut:["Ctrl","s","c"],outcome:"Expand selection towards causes (backwards)"},expand_select:{shortcut:["Ctrl","s","e"],outcome:"Expand selection"},decrease_select:{shortcut:["Ctrl","s","d"],outcome:"Decrease selection (along non circular connections and nodes)"},select_interconnections:{shortcut:["Ctrl","s","i"],outcome:"Select components inbetween (interconnections)"},search:{shortcut:["Ctrl","f"],outcome:"Open the search menu"}},KN=[se.help,se.fit_view,se.toggle_present_edit,se.toggle_side,se.toggle_time,se.toggle_focused,se.toggle_animating,se.toggle_circular_connections,se.select_multiple,se.deselect_multiple,se.select_all,se.expand_select_forwards,se.expand_select_backwards,se.expand_select,se.decrease_select,se.select_interconnections,se.search];function yt(e){return _("div",{className:"description",style:{display:"inline"},children:To(e.shortcut,()=>_("span",{children:" + "}))})}function YN(e){return _(ae,{component:"dt",style:{display:"inline"},children:e.shortcut.map((t,n)=>{const i=t===Uc.click||t===Uc.drag?"physical_action":"physical_button";return _("div",{style:{display:"inline"},children:[_("div",{className:i,children:t}),n<e.shortcut.length-1&&_("span",{className:"shortcut_plus",children:" + "})]})})})}function JN(e){return _(R,{component:"dl",children:[_(YN,{shortcut:e.shortcut}),_("div",{style:{display:"inline"},children:["   ",e.outcome," "]})]})}const XN=e=>({show:e.display_options.show_help_menu}),ZN={set_show_help_menu:S.display.set_show_help_menu},QN=j(XN,ZN);function eP(e){const[t,n]=I("kbd-shortcuts"),i=o=>(s,r)=>{n(r?o:!1)};return e.show?_(di,{size:"medium",title:"",on_close:()=>e.set_show_help_menu({show:!1}),child:_(R,{p:10,children:[_(ae,{component:"h1",variant:"h5",children:"Tips for using DataCurator"}),_(bi,{expanded:t==="kbd-shortcuts",onChange:i("kbd-shortcuts"),children:[_(yi,{children:_(ae,{component:"h2",variant:"h6",children:"Commands / shortcuts"})}),_(ki,{children:_(R,{children:["These shortcuts only work when you are not editing a text field.  Some may only work when you are viewing a map of components (also known as a knowledge view).",KN.map(o=>_(JN,{...o}))]})})]}),_(bi,{expanded:t==="linking-tips",onChange:i("linking-tips"),children:[_(yi,{children:_(ae,{component:"h2",variant:"h6",children:" Tips on Linking"})}),_(ki,{children:_(R,{children:nP.map(o=>_(ae,{component:"p",paragraph:!0,children:o}))})})]}),_(bi,{expanded:t==="general-tips",onChange:i("general-tips"),children:[_(yi,{children:_(ae,{component:"h2",variant:"h6",children:"General tips"})}),_(ki,{children:_(R,{children:iP.map(o=>_(ae,{component:"p",paragraph:!0,children:o}))})})]}),_(bi,{expanded:t==="detailed-tips",onChange:i("detailed-tips"),children:[_(yi,{children:_(ae,{component:"h2",variant:"h6",children:"Detailed tips"})}),_(ki,{children:_(R,{children:oP.map(o=>_(ae,{component:"p",paragraph:!0,children:o}))})})]})]})}):null}const tP=QN(eP),nP=[`Type "@@" in any text field to access a menu to link to any other component.
    This will insert the id of that component, e.g.  @@12345678-abcd-4123-abcd-1234567890ab.`,`Follow "@@some-id" with .url, .title and .description to get the attributes
    of that component e.g. "@@12345678-abcd-4123-abcd-1234567890ab.title".  Or if it has an
    associated knowledge view then add .map to go to that knowledge view.`,_("span",{children:["Markdown is available so you can use things like ",_("b",{children:"**some text**"}),'to make it bold once it is rendered during presentation mode. Other Markdown syntax like "1. some text" will give you numbered lists. See the full ',_("a",{href:"https: //www.markdownguide.org/basic-syntax/",children:"Markdown guide here"})]})],iP=[_("div",{children:[_(ae,{component:"h3",variant:"h6",children:'"Action" node type versus "State"'}),"The action components specify each action someone can perform when playing in a simulation built on this model.  e.g. building a new road, or changing a tax rate."]})],oP=[_("div",{children:[_(ae,{component:"h3",variant:"h6",children:"State subtypes"}),"There are three State subtypes:",_("ol",{children:[_("li",{children:"boolean, e.g. True / False"}),_("li",{children:"number"}),_("li",{children:"other"})]}),"Often you can represent the same attribute in different ways and this will depend on what level of detail is salient to the conversation / the model of the scenario you are interested in.",_("ol",{children:[_("li",{children:'a boolean, with title "The medical response was fast" or "The medical response time was adequate"'}),_("li",{children:'"other" with title "The medical response", with values of "Very slow", "Slow", "Medium", "Fast", "Very fast" etc.'}),_("li",{children:'"number" with title "The medical response speed", where the value perhaps represents the time in minutes until aid was first administered.'})]})]}),_("div",{children:[_(ae,{component:"h3",variant:"h6",children:"Multidimensional states"}),'Often there can be attributes / concepts which have two dimensions to them which are salient together, e.g. "The medical response was fast and effective".  These can be modelled using states with titles and subtypes in many ways, for example:',_("ol",{children:[_("li",{children:'a boolean, with title "The medical response was (adequately) fast and effective"'}),_("li",{children:'"number" with title "The medical response speed and effectiveness", where the value is derived from some formula to calculate a single number based of the two attributes of speed and effectiveness.'})]}),'If the concept later needs to be analysed / comprehended / explored in greater detail it can be decomposed.  Either it could be change to a subtype of "other" with title "The medical response speed and effectiveness", with values of "fast and effective", "fast but ineffective", "slow but effective", "slow and ineffective".  Or replaced by two new seperate states, one for "Medical response speed" and one for "Medical response effectiveness".  In the latter case deleting the first node from the knowledge views would be best.  In the former case, ',_("a",{href:"https://github.com/AJamesPhillips/data-curator2/issues/36",children:"versioning the whole component"})," would make this easier from a user's perspective."]})];var Ql={},sP=ee;Object.defineProperty(Ql,"__esModule",{value:!0});var ed=Ql.default=void 0,rP=sP(Q()),_P=te(),aP=(0,rP.default)((0,_P.jsx)("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"}),"Menu");ed=Ql.default=aP;const cP=e=>({apply_filter:e.filter_context.apply_filter}),lP={set_apply_filter:S.filter_context.set_apply_filter},dP=j(cP,lP);function uP(e){return _("div",{children:["Filter",_("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:e.apply_filter,onClick:t=>{t.stopPropagation(),t.preventDefault()},onPointerDown:t=>{t.stopPropagation(),t.preventDefault(),e.set_apply_filter(!e.apply_filter)}})]})}const pP=dP(uP);function wn(e){return e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase()}function fy(e){return e==="wcomponents"?"Components":e==="display"?"Display Options":e==="select"?"Selection":wn(e.replaceAll("_"," "))}function mP(e){return e==="filter"?_(pP,{}):fy(e)}const fP=e=>({current_route:e.routing.route}),hP={change_route:S.routing.change_route},vP=j(fP,hP);function gP(e){const t=()=>{e.on_pointer_down(),e.change_route({route:e.id,sub_route:null,item_id:null})},n=()=>(e.on_pointer_down(),!1),i=mP(e.id);return _(hy,{on_pointer_down:t,children:_(Je,{route:e.id,sub_route:null,item_id:null,args:void 0,on_pointer_down:n,children:i})})}const wP=vP(gP);function hy(e){return _(Kc,{style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},onPointerDown:t=>{t.stopImmediatePropagation(),e.on_pointer_down()},children:e.children})}const bP=e=>({route:e.routing.route,editing:!e.display_options.consumption_formatting}),yP={set_show_help_menu:S.display.set_show_help_menu,change_route:S.routing.change_route},kP=j(bP,yP);function xP(e){const[t,n]=I(null),i=()=>{n(null)};return _("div",{children:[_("div",{style:{display:"flex",flexDirection:"row"},children:[_(je,{style:{display:"flex",flex:1},children:_("b",{style:{width:"100%",display:"flex"},onClick:()=>{e.change_route({route:e.route,item_id:null,sub_route:null})},children:fy(e.route)})}),_(je,{"aria-controls":"select_tab","aria-haspopup":"true",style:{display:"flex",flex:1,justifyContent:"end"},onClick:o=>n(o.currentTarget),children:_(ed,{})})]}),_(Y0,{anchorEl:t,id:"select_tab",onClose:i,open:!!t,keepMounted:!0,children:[hw.map(o=>_(wP,{id:o,on_pointer_down:i})),_(hy,{on_pointer_down:()=>{i(),e.set_show_help_menu({show:!0})},children:"Help"})]})]})}const SP=kP(xP);var td={},AP=ee;Object.defineProperty(td,"__esModule",{value:!0});var vy=td.default=void 0,$P=AP(Q()),yh=te(),CP=(0,$P.default)([(0,yh.jsx)("path",{d:"M15.5 5H11l5 7-5 7h4.5l5-7z"},"0"),(0,yh.jsx)("path",{d:"M8.5 5H4l5 7-5 7h4.5l5-7z"},"1")],"DoubleArrow");vy=td.default=CP;var nd={},TP=ee;Object.defineProperty(nd,"__esModule",{value:!0});var gy=nd.default=void 0,EP=TP(Q()),jP=te(),NP=(0,EP.default)((0,jP.jsx)("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"}),"Tune");gy=nd.default=NP;function PP(e){let t;const n=le(e);if(n){const{composed_visible_wc_id_map:i,wc_ids_by_type:o}=n,{x:s,y:r,zoom:a}=e.routing.args,c=Oe/a,l=s+yl(e.controls.display_side_panel)*c,d=r-is*c,p=os(e),f=d-kl(p)*c;t=!!Array.from(o.any_node).find(m=>{const h=i[m];if(!h)return!1;const{left:v,top:g}=h;return v>=s&&v<=l&&-g<=d&&-g>=f})}return t}var id={},IP=ee;Object.defineProperty(id,"__esModule",{value:!0});var wy=id.default=void 0,RP=IP(Q()),DP=te(),MP=(0,RP.default)((0,DP.jsx)("path",{d:"M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"}),"FilterCenterFocus");wy=id.default=MP;function OP(e){const{move:t,draw_attention:n,have_finished_drawing_attention:i=()=>{}}=e;return oe(()=>{if(e.enable_spacebar_move_to_shortcut)return U.global_keys.sub("key_down",o=>{t&&o.key===" "&&t()})},[e.enable_spacebar_move_to_shortcut,t]),_(R,{children:[_(ze,{placement:"top",title:t?"Move to component(s)":"No component(s) present",children:_("span",{children:_(ce,{size:"medium",onClick:t,disabled:!t,children:_(wy,{})})})}),_("div",{className:t&&n?"pulsating_circle":"",ref:o=>setTimeout(()=>{o==null||o.classList.remove("pulsating_circle"),i()},1e4)})]})}const qP=(e,t)=>{const n=t.wcomponent_id||e.routing.item_id||"";let i;return t.allow_drawing_attention&&(i=PP(e)),{initial_wcomponent_id:n,created_at_ms:e.routing.args.created_at_ms,components_on_screen:i,current_composed_knowledge_view:le(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,selected_wcomponent_ids_set:e.meta_wcomponents.selected_wcomponent_ids_set,display_side_panel:e.controls.display_side_panel,display_time_sliders:os(e)}},VP={move:(e,t)=>S.routing.change_route({args:{created_at_ms:e,...t}})},FP=j(qP,VP);function zP(e){const{components_on_screen:t,have_finished_drawing_attention:n,current_composed_knowledge_view:i,wcomponents_by_id:o,initial_wcomponent_id:s,selected_wcomponent_ids_set:r,created_at_ms:a,disable_if_not_present:c,display_side_panel:l,display_time_sliders:d}=e,{positions_no_sidepanel_or_timesliders:p,positions_sidepanel_no_timesliders:f,positions_timesliders_no_sidepanel:m,positions_with_sidepanel_or_timesliders:h,go_to_datetime_ms:v}=G(()=>W$({current_composed_knowledge_view:i,wcomponents_by_id:o,initial_wcomponent_id:s,selected_wcomponent_ids_set:r,created_at_ms:a,disable_if_not_present:c}),[i,o,s,r,a,c]),g=l||d?l&&d?h:l?f:m:p;let b=0;const w=g.length===0?void 0:()=>{let y=g[b++];y||(b=0,y=g[b++]),e.move(v,y)},x=e.allow_drawing_attention&&g.length>0&&!t;return _(OP,{move:w,draw_attention:x,have_finished_drawing_attention:n,enable_spacebar_move_to_shortcut:!e.wcomponent_id})}const by=FP(zP);var od={},LP=ee;Object.defineProperty(od,"__esModule",{value:!0});var yy=od.default=void 0,BP=LP(Q()),UP=te(),WP=(0,BP.default)((0,UP.jsx)("path",{d:"m15.96 10.29-2.75 3.54-1.96-2.36L8.5 15h11l-3.54-4.71zM3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"Filter");yy=od.default=WP;const sd=Ct(e=>({warning_button:{cursor:"help"},warning_icon:{color:e.palette.warning.main}})),HP=e=>{var i;const{wc_ids_excluded_by_created_at_datetime_filter:t,vap_set_number_excluded_by_created_at_datetime_filter:n=0}=((i=le(e))==null?void 0:i.filters)||{};return{components:(t==null?void 0:t.size)||0,vap_sets:n}},GP={set_display_time_sliders:S.controls.set_display_time_sliders},KP=j(HP,GP);function YP(e){const{components:t,vap_sets:n}=e;if(t+n===0)return null;const i=sd();let o=t?`${t} components are invisible `:"";return t&&n&&(o+="and "),o+=n?`${n} predictions are invisible `:"",o+="due to created at datetime filter",_(ze,{placement:"top",title:o,children:_(ce,{className:i.warning_button,component:"span",onClick:()=>e.set_display_time_sliders(!0),size:"small",children:_(yy,{className:i.warning_icon})})})}const rd=KP(YP);var _d={},JP=ee;Object.defineProperty(_d,"__esModule",{value:!0});var ky=_d.default=void 0,XP=JP(Q()),ZP=te(),QP=(0,XP.default)((0,ZP.jsx)("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore");ky=_d.default=QP;var ad={},e9=ee;Object.defineProperty(ad,"__esModule",{value:!0});var xy=ad.default=void 0,t9=e9(Q()),n9=te(),i9=(0,t9.default)((0,n9.jsx)("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext");xy=ad.default=i9;function o9(e){return _(F,{title:e.title,value:"Now",onClick:()=>{const t=new Date().getTime()+6e4;e.change_datetime_ms(t)}})}const s9=(e,{get_handle_ms:t})=>({handle_datetime_ms:t(e)}),r9=j(s9);function _9(e){const t=e.events.map(a=>{let c=a.datetime.getTime();return c=pk(c),c}),n=t[0],i=t[t.length-1],o=dn(t,a=>a,e.handle_datetime_ms);function s(a){typeof a=="number"&&e.change_handle_ms(a)}function r(a){return()=>{let c=o.index+a;o.exact||(a===1?c=Math.ceil(o.index):c=Math.floor(o.index));let l=t[c];for(;l===e.handle_datetime_ms;)c+=a,l=t[c];l&&e.change_handle_ms(l)}}return _(R,{className:"time_slider",my:2,px:5,children:[_(R,{className:"slider_container",display:"flex",children:[_(Gi,{size:"small",children:[_(ce,{onClick:r(-1),disabled:o.bounds==="n/a"||o.index<=0,title:"Previous "+e.title+" datetime",size:"large",children:_(ky,{})}),_(ce,{onClick:r(1),disabled:o.bounds==="n/a"||o.index>=t.length-1,title:"Next "+e.title+" datetime",size:"large",children:_(xy,{})})]}),_(R,{flexGrow:1,title:e.title+" datetimes",children:_(Wh,{onChange:(a,c)=>s(c),color:"secondary",value:e.handle_datetime_ms,getAriaValueText:a9,valueLabelFormat:c9,step:1,min:n,max:i,valueLabelDisplay:"auto",marks:t.map(a=>({value:a,label:""}))})})]}),_(R,{display:"flex",justifyContent:"flex-end",alignItems:"center",children:[_(xt,{title:e.title,value:new Date(e.handle_datetime_ms),on_change:a=>a&&e.change_handle_ms(a.getTime()),show_now_shortcut_button:!1,show_today_shortcut_button:!1,editing_allowed:!0}),_(o9,{title:"Set "+e.title+" to now",change_datetime_ms:a=>e.change_handle_ms(a)})]})]})}const kh=r9(_9),a9=e=>`${e}`,c9=e=>{const t=Go({date:new Date(e)});return _("span",{style:{whiteSpace:"nowrap"},children:t})},Sy=Ct(e=>({inverse_disabled:{color:e.palette.text.disabled,"&.Mui-disabled":{color:e.palette.text.primary,pointerEvents:"auto"}}}));var cd={},l9=ee;Object.defineProperty(cd,"__esModule",{value:!0});var Ay=cd.default=void 0,d9=l9(Q()),u9=te(),p9=(0,d9.default)((0,u9.jsx)("path",{d:"M3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"FilterNone");Ay=cd.default=p9;const m9=e=>({apply_filter:e.filter_context.apply_filter}),f9={change_route:S.routing.change_route},h9=j(m9,f9);function v9(e){const{apply_filter:t}=e,n=sd();return t?_(ze,{placement:"top",title:"A filter is in place which could result in components being hidden",children:_(ce,{className:n.warning_button,component:"span",size:"small",onClick:()=>e.change_route({route:"filter"}),children:_(Ay,{className:n.warning_icon})})}):null}const $y=h9(v9);var ld={},g9=ee;Object.defineProperty(ld,"__esModule",{value:!0});var Cy=ld.default=void 0,w9=g9(Q()),b9=te(),y9=(0,w9.default)((0,b9.jsx)("path",{d:"M11 4.07V2.05c-2.01.2-3.84 1-5.32 2.21L7.1 5.69c1.11-.86 2.44-1.44 3.9-1.62zm7.32.19C16.84 3.05 15.01 2.25 13 2.05v2.02c1.46.18 2.79.76 3.9 1.62l1.42-1.43zM19.93 11h2.02c-.2-2.01-1-3.84-2.21-5.32L18.31 7.1c.86 1.11 1.44 2.44 1.62 3.9zM5.69 7.1 4.26 5.68C3.05 7.16 2.25 8.99 2.05 11h2.02c.18-1.46.76-2.79 1.62-3.9zM4.07 13H2.05c.2 2.01 1 3.84 2.21 5.32l1.43-1.43c-.86-1.1-1.44-2.43-1.62-3.89zM15 12c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3zm3.31 4.9 1.43 1.43c1.21-1.48 2.01-3.32 2.21-5.32h-2.02c-.18 1.45-.76 2.78-1.62 3.89zM13 19.93v2.02c2.01-.2 3.84-1 5.32-2.21l-1.43-1.43c-1.1.86-2.43 1.44-3.89 1.62zm-7.32-.19C7.16 20.95 9 21.75 11 21.95v-2.02c-1.46-.18-2.79-.76-3.9-1.62l-1.42 1.43z"}),"FilterTiltShift");Cy=ld.default=y9;const k9=e=>({focused_mode:e.display_options.focused_mode}),x9={set_or_toggle_focused_mode:S.display.set_or_toggle_focused_mode},S9=j(k9,x9);function A9(e){const{focused_mode:t}=e,n=t?"WARNING: Focused Mode is active, unselected components will be almost invisible":"Activate focused mode",i=t?sd():C9();return _(ze,{placement:"top",title:n,children:_("span",{children:_(ce,{component:"span",size:"medium",onClick:()=>e.set_or_toggle_focused_mode(),children:_(Cy,{className:i.warning_icon})})})})}const $9=S9(A9),C9=Ct(e=>({warning_icon:{color:e.palette.primary.main}}));const T9=e=>{const t=le(e),n=(t&&t.composed_datetime_line_config.time_origin_ms)!==void 0,i=qe(e);return{display_time_marks:e.display_options.display_time_marks,sim_ms:e.routing.args.sim_ms,time_origin_ms_present:n,current_kv:i,presenting:e.display_options.consumption_formatting}},E9={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view,set_display_time_marks:S.display.set_display_time_marks},j9=j(T9,E9);function N9(e){const{display_time_marks:t,time_origin_ms_present:n,current_kv:i,presenting:o}=e;return o&&!n?null:_(R,{component:"label",children:_(Gi,{disableElevation:!0,variant:"contained",children:_(je,{onClick:()=>{const s=!t;if(s&&!n&&i){const r=ye(),a=si(r.getState()).left,c={...i,datetime_line_config:{...i.datetime_line_config,time_origin_ms:e.sim_ms,time_origin_x:a}};e.upsert_knowledge_view({knowledge_view:c})}e.set_display_time_marks(s)},"aria-label":"Toggle displaying time markers",children:[t?"Hide":"Show"+(n?"":" (Set)")," time"]})})})}const P9=j9(N9),I9=e=>({linked_datetime_sliders:e.controls.linked_datetime_sliders,display_time_sliders:e.controls.display_time_sliders,actually_display_time_sliders:os(e),editing:!e.display_options.consumption_formatting,animate_connections:e.display_options.animate_connections,created_at_ms:e.routing.args.created_at_ms}),R9={change_display_at_created_datetime:S.display_at_created_datetime.change_display_at_created_datetime,change_display_at_sim_datetime:S.display_at_sim_datetime.change_display_at_sim_datetime,toggle_linked_datetime_sliders:S.controls.toggle_linked_datetime_sliders,set_display_time_sliders:S.controls.set_display_time_sliders,set_or_toggle_animate_connections:S.display.set_or_toggle_animate_connections},D9=j(I9,R9);function M9(e){const[t,n]=I(!0);Sy();const{created_events:i,sim_events:o}=e,s=q9();return _(R,{p:2,mb:2,borderTop:1,borderColor:"primary.main",position:"relative",children:[_(J0,{in:e.actually_display_time_sliders,children:_(R,{className:s.drawer_content,children:_(R,{flexGrow:1,children:e.actually_display_time_sliders&&_(ue,{children:[_(kh,{events:i,get_handle_ms:r=>r.routing.args.created_at_ms,change_handle_ms:r=>e.change_display_at_created_datetime({ms:r}),data_set_name:"content_controls_created_at_datetimes",title:"Created at"}),_(kh,{events:o,get_handle_ms:r=>r.routing.args.sim_ms,change_handle_ms:r=>e.change_display_at_sim_datetime({ms:r}),data_set_name:"content_controls_sim_datetimes",title:"Simulation"})]})})})}),_(Hh,{className:s.toolbar,variant:"dense",children:[_(R,{className:s.move_to_button_and_warnings,children:[_(by,{allow_drawing_attention:t,have_finished_drawing_attention:()=>n(!1),disable_if_not_present:!1}),_($9,{}),_(rd,{}),_($y,{})]}),Ot.get_state().enable_align_components_on_x_by_time&&_(P9,{}),_("div",{children:[_(ze,{placement:"top",title:e.animate_connections?"Stop animating connections":"Animate connections",children:_(ce,{component:"span",size:"medium",onClick:()=>e.set_or_toggle_animate_connections(),children:_(vy,{style:{color:e.animate_connections?"rgb(25, 118, 210)":""}})})}),_(ze,{placement:"top",title:e.display_time_sliders?"Hide time sliders":"Show time sliders",children:_(ce,{component:"span",size:"medium",onClick:()=>e.set_display_time_sliders(!e.display_time_sliders),children:_(gy,{})})})]})]})]})}const O9=D9(M9),q9=Ct(e=>({toolbar:{justifyContent:"space-between"},move_to_button_and_warnings:{display:"flex",flexDirection:"row"},drawer_content:{display:"flex",flexDirection:"row",alignItems:"center",alignContent:"center"},warning_icon:{color:e.palette.warning.main}}));function V9(e){const t=[],n=new Set,i=[],o=new Set;let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;function a(f,m){if(!f)return;const h=f.getTime();m!=="sim"&&!n.has(h)&&t.push({datetime:f,type:m}),m!=="created"&&!o.has(h)&&i.push({datetime:f,type:m}),s=Math.min(s,f.getTime()),r=Math.max(r,f.getTime())}function c(f){a(f.min,"sim"),a(f.value,"sim"),a(f.max,"sim")}e.forEach(f=>{a(f.custom_created_at||f.created_at,"created"),Ki(f)&&f.values_and_prediction_sets.forEach(({created_at:m,custom_created_at:h,datetime:v})=>{a(h||m,"created"),c(v)}),_v(f)&&f.event_at.forEach(({datetime:m})=>{c(m)})});const l=new Date;t.length===0&&a(l,"created");const d=s,p=r;return["created","sim"].forEach(f=>{a(new Date(d),f),a(new Date(p),f),a(new Date(d-864e5),f),a(new Date(p+864e5),f)}),t.sort(xh),i.sort(xh),{created_events:t,sim_events:i}}function xh({datetime:e},{datetime:t}){return e.getTime()<t.getTime()?-1:1}const F9=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,current_composed_knowledge_view:le(e)}),z9=j(F9);function L9(e){const{wcomponents_by_id:t,current_composed_knowledge_view:n}=e;if(!n)return _("div",{});const{composed_wc_id_map:i}=n,{created_events:o,sim_events:s}=G(()=>{const r=Object.keys(i).map(a=>t[a]).filter(ge);return V9(r)},[i,t]);return _(O9,{created_events:o,sim_events:s})}const B9=z9(L9),U9=e=>({view:e.routing.args.view}),W9=j(U9);function H9(e){const{view:t}=e;return _("div",{className:"main_content_controls",children:t==="knowledge"&&_(B9,{})})}const G9=W9(H9);function Ty(e){return _(R,{id:"main_area",display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,zIndex:1,children:[_(R,{id:"main_content",flexGrow:1,flexShrink:1,display:"flex",flexDirection:"column",position:"relative",zIndex:1,children:e.main_content}),_(R,{id:"main_content_controls",bgcolor:"#fafafa",flexGrow:0,flexShrink:1,position:"relative",zIndex:10,children:_(G9,{})}),e.extra_content]})}var dd={},K9=ee;Object.defineProperty(dd,"__esModule",{value:!0});var Ey=dd.default=void 0,Y9=K9(Q()),J9=te(),X9=(0,Y9.default)((0,J9.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),"Add");Ey=dd.default=X9;function Z9(e,t,n,i=vn){const o={left:0,top:0};if(!e||!t)return o;const s=e[t];if(!s)return o;const r=lw(e,n);let a=s;const c={left:s.left,top:s.top};for(;a;){c.top+=i;const l=cw(c),p=(r[l]||[])[0];a=p?e[p]:void 0}return c}function jy(e,t){let n=nl(e);return e&&(e={...e}),t.forEach(i=>{i.entries.forEach(o=>{var r;if(!o.value_id)return;e=e||{};const s=((r=e[o.value_id])==null?void 0:r.order)??++n;e[o.value_id]={id:o.value_id,value:o.value,description:o.description,order:s}})}),e}function Ny(e,t){return e.entries.map(n=>{const i=n.value_id===t?1:0;return{...n,relative_probability:i,probability:i,conviction:1}})}function Wc(e){const{existing_value_possibilities:t,orig_values_and_prediction_sets:n,base_id:i,action_value_possibility_id:o}=e,s=Te(P.action,t,n,i),r=Ny(s,o);return s.entries=r,[...n,s]}function Py(e){const t=jy(e.existing_value_possibilities,e.new_values_and_prediction_sets);e.update_VAPSets_and_value_possibilities({value_possibilities:t,values_and_prediction_sets:e.new_values_and_prediction_sets});const n=Sh(e.orig_values_and_prediction_sets,e.current_created_at_ms),i=Sh(e.new_values_and_prediction_sets,e.current_created_at_ms),o=1*60*1e3,s=10*o;let r;i.latest_created_at_ms>n.latest_created_at_ms&&(r=i.latest_created_at_ms+o);const a=new Date().getTime(),c=i.latest_sim_ms<a+o&&i.latest_sim_ms>a-s;let l;e.sim_ms<i.latest_sim_ms&&c&&(l=i.latest_sim_ms),(r!==void 0||l!==void 0)&&e.change_route({args:{sim_ms:l,created_at_ms:r}})}function Sh(e,t=0){let n=Number.NEGATIVE_INFINITY;return e.forEach(i=>{t=Math.max(it(i),t);const o=ii(i.datetime);o&&(n=Math.max(o.getTime(),n))}),{latest_created_at_ms:t,latest_sim_ms:n}}const Q9=e=>({composed_knowledge_view:le(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,base_id:mt(e)}),eI=j(Q9);function tI(e){const{most_recent_action_id:t,composed_knowledge_view:n,wcomponents_by_id:i,base_id:o,list_type:s}=e;if(!n)return null;const{id:r,composed_wc_id_map:a}=n,c=G(()=>nI({base_id:o,composed_wc_id_map:a,most_recent_action_id:t,wcomponents_by_id:i,list_type:s,knowledge_view_id:r}),[o,a,t,i,s,r]);return _(F,{className:"add_new_action_button",fullWidth:!1,onClick:c,disabled:o===void 0,title:o===void 0?"No project selected":"",children:_(Ey,{})})}const bo=eI(tI);function nI(e){const{base_id:t,composed_wc_id_map:n,most_recent_action_id:i,wcomponents_by_id:o,list_type:s,knowledge_view_id:r}=e;return function(){if(t===void 0)throw new Error("No base_id (project id) defined in click for AddNewActionButton");const c=Z9(n,i,o);let l=[];const d=s==="todo",p=s==="in_progress",f=s==="done";if((p||f)&&(l=Wc({existing_value_possibilities:void 0,orig_values_and_prediction_sets:[],base_id:t,action_value_possibility_id:we.action_in_progress}),f)){let h=new Date;const v=3600*1e3;h=new Date(h.getTime()-v),l[0].datetime.value=h}f&&(l=Wc({existing_value_possibilities:void 0,orig_values_and_prediction_sets:l,base_id:t,action_value_possibility_id:we.action_completed}));const m=jy(void 0,l);ri({wcomponent:{base_id:t,type:"action",values_and_prediction_sets:l,value_possibilities:m,todo_index:d?new Date().getTime():void 0},add_to_knowledge_view:{id:r,position:c}})}}var ud={},iI=ee;Object.defineProperty(ud,"__esModule",{value:!0});var Iy=ud.default=void 0,oI=iI(Q()),sI=te(),rI=(0,oI.default)((0,sI.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack");Iy=ud.default=rI;var pd={},_I=ee;Object.defineProperty(pd,"__esModule",{value:!0});var Ry=pd.default=void 0,aI=_I(Q()),cI=te(),lI=(0,aI.default)((0,cI.jsx)("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward");Ry=pd.default=lI;var md={},dI=ee;Object.defineProperty(md,"__esModule",{value:!0});var ys=md.default=void 0,uI=dI(Q()),pI=te(),mI=(0,uI.default)((0,pI.jsx)("path",{d:"m4 12 1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"}),"ArrowUpward");ys=md.default=mI;var fd={},fI=ee;Object.defineProperty(fd,"__esModule",{value:!0});var Dy=fd.default=void 0,hI=fI(Q()),vI=te(),gI=(0,hI.default)((0,vI.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"}),"Description");Dy=fd.default=gI;function wI(e){const{position:t,extra_styles:n,display:i,extra_css_class:o,title:s,children:r}=e,{on_pointer_enter:a,on_pointer_leave:c,on_pointer_down:l,on_pointer_up:d,on_click:p}=e,f={...t,position:t?"absolute":"relative",display:i===void 0||i?"":"none",...n},h=`node ${l||d||p||a||c?"mouseable":""} ${o||""}`;return _("div",{...e.extra_args,className:h,style:f,title:s,onPointerDown:l||(v=>{v.stopImmediatePropagation(),v.preventDefault()}),onPointerUp:d,onClick:p,onPointerEnter:a,onPointerLeave:c,onContextMenu:v=>{v.preventDefault()},children:r})}function bI(e){let{opacity:t}=e;const n={display:e.hidden?"none":"",opacity:t};e.unlimited_width&&(n.maxWidth="initial");const i={boxShadow:e.glow?`${e.glow} 0px 0px 10px`:"",backgroundColor:e.color,...e.extra_styles_for_node_main_content},{pointerupdown_on_connection_terminal:o=()=>{}}=e,s=" connectable_canvas_node "+(e.extra_css_class||"");return _(wI,{position:e.position,on_pointer_down:e.on_pointer_down,on_pointer_up:e.on_pointer_up,on_click:e.on_click,on_pointer_enter:e.on_pointer_enter,on_pointer_leave:e.on_pointer_leave,extra_css_class:s,extra_styles:n,extra_args:e.extra_args,children:[_(X0,{className:"node_main_content",variant:"outlined",style:i,children:[e.cover_image&&_(Z0,{component:"img",image:e.cover_image,className:"node_image_content",onContextMenu:r=>{r.stopImmediatePropagation()}}),_(Q0,{style:{padding:16},children:e.node_main_content}),e.terminals.map(({type:r,style:a,label:c})=>_("div",{className:"connection_terminal",style:{...yI,...a},onPointerDown:l=>{l.stopPropagation(),o(r,"down")},onPointerUp:l=>{l.stopPropagation(),o(r,"up")},children:c}))]}),e.other_children]})}const Ah=Vo*2,yI={width:Ah,height:Ah,borderRadius:Vo+1},kI={white:{r:255,g:255,b:255,a:1},white_a75:{r:255,g:255,b:255,a:.75}};function $t(e){return e?`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`:""}function My(e){if(!e)return{r:0,g:0,b:0,a:1};const n=e.r+e.g+e.b<383?255:0;return{r:n,g:n,b:n,a:1}}function xI(e){if(e)return{r:e.r/2,g:e.g/2,b:e.b/2,a:e.a}}function SI(e,{wcomponent_id:t}){const{wcomponents_by_id:n,knowledge_views_by_id:i}=e.specialised_objects;return{wcomponent:n[t],wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:ft(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}}const AI=j(SI);function $I(e){const{wcomponent:t}=e,n=t?at({wcomponent:t,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}):"&lt;Label not found&gt;";return _("div",{className:"label_v2",style:{backgroundColor:$t((t==null?void 0:t.label_color)||kI.white_a75),color:$t(My(t==null?void 0:t.label_color))},children:_(io,{options:Yl,children:n})})}const CI=AI($I);function TI(e){return _("div",{style:{display:"flex",flexWrap:"wrap"},children:(e.label_ids||[]).map(t=>_(CI,{wcomponent_id:t}))})}function nn(e){const t="⚠";return _("span",{style:{backgroundColor:e.backgroundColor||"yellow",color:"black"},title:e.message,children:t})}function EI(e,t){const n=ye(),i=n.getState(),{selected_wcomponent_ids_set:o}=i.meta_wcomponents;let s=new Set(o);if(!s.has(e)){s=new Set([e]);const d=S.meta_wcomponents.clicked_wcomponent({id:e});n.dispatch(d)}const r=S.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:s});n.dispatch(r);let a;const c=U.canvas.sub("canvas_move",d=>{a=ns({left:d.x-t.x,top:t.y-d.y}),U.canvas.pub("canvas_node_drag_relative_position",a)}),l=U.canvas.sub("canvas_pointer_up",()=>{if(a){const p=S.specialised_object.bulk_edit_knowledge_view_entries({wcomponent_ids:Array.from(s),change_left:a.left,change_top:a.top});n.dispatch(p)}const d=S.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:new Set});n.dispatch(d),c(),l()})}function Bi(e){return e==="counterfactualv2"?"counterfactual":e==="statev2"?"state":e.replaceAll("_"," ")}function Oy(e){const{wcomponent_id:t,shift_or_control_keys_are_down:n,change_route:i,clicked_wcomponent:o,clear_selected_wcomponents:s,is_current_item:r}=e;return a=>{a.stopImmediatePropagation(),a.preventDefault(),o({id:t}),n?i({route:"wcomponents",sub_route:"wcomponents_edit_multiple",item_id:null}):r?(i({route:"wcomponents",sub_route:null,item_id:null}),s()):i({route:"wcomponents",sub_route:null,item_id:t})}}function hd(e,t){return t*(Oe/e)}function qy(e,t,n){return e+hd(t,n)}function Vy(e,t,n){return e-hd(t,n)}var vd={},jI=ee;Object.defineProperty(vd,"__esModule",{value:!0});var Fy=vd.default=void 0,NI=jI(Q()),PI=te(),II=(0,NI.default)((0,PI.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"}),"Search");Fy=vd.default=II;const RI="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z";function DI(e){return _(Cn,{...e,d:RI,svg_elements:[_("line",{x1:"0",x2:"13",y1:"18",y2:"18",stroke:"white","stroke-width":"6"}),_("line",{x1:"6.5",x2:"6.5",y1:"11.5",y2:"24",stroke:"white","stroke-width":"6"}),_("line",{x1:"1.5",x2:"11.5",y1:"18",y2:"18","stroke-width":"3"}),_("line",{x1:"6.5",x2:"6.5",y1:"13",y2:"23","stroke-width":"3"})]})}const MI=(e,t)=>{const n=Me(e,t.wcomponent_id),o=(ey(e,t.wcomponent_id)||[]).find(s=>e.specialised_objects.knowledge_views_by_id[s]);return{wcomponent:n,kvwc:e.specialised_objects.knowledge_views_by_id[t.wcomponent_id],subview_id:e.routing.args.subview_id,nested_knowledge_view_ids_entry:e.derived.nested_knowledge_view_ids.map[t.wcomponent_id],presenting:e.display_options.consumption_formatting,any_overlapping_wcomponents_have_kvs:o}},OI=j(MI);function qI(e){let{kvwc:t}=e;const{is_highlighted:n,nested_knowledge_view_ids_entry:i,any_overlapping_wcomponents_have_kvs:o}=e,s=!e.presenting,r=!t&&(e.presenting||s&&!n&&!o),a=e.subview_id===e.wcomponent_id,c=i&&i.parent_id,l=s&&!!e.wcomponent,d=a?c?2:-1:t?1:l?3:-2,p=a&&!c,f="node_handle explore "+(r?" hidden ":"")+(t?" has_knowledge_view ":"")+(p?" current_but_no_parent ":"")+(d===3?" will_create_on_click ":"")+(d===-2?" error_disabled ":"");return _("div",{className:f,title:d===2?"Navigate up to parent":d===-1?"No parent to navigate up to":d===1?"Navigate to knowledge view":d===3?"Create then navigate to knowledge view":d===-2?"Error: could not find the component to create a new knowledge view for":"Unknown error",onClick:h=>{h.preventDefault(),h.stopImmediatePropagation();const v=ye();if(a)c&&tu(c,v);else{if(!t){const g=VI(e,v);if(!g)return;t=g,v.dispatch(S.specialised_object.upsert_knowledge_view({knowledge_view:t}))}tu(t.id,v)}},children:a?_(ys,{}):d===3?_(DI,{}):_(Fy,{})})}const gd=OI(qI);function VI(e,t){if(!e.wcomponent)return!1;const n=t.getState(),i=si(n),o={[e.wcomponent.id]:e.wcomponent_current_kv_entry||i},s=at({wcomponent:e.wcomponent,wc_id_to_counterfactuals_map:ft(n),text_type:pe.plain,wcomponents_by_id:n.specialised_objects.wcomponents_by_id,knowledge_views_by_id:n.specialised_objects.knowledge_views_by_id,created_at_ms:n.routing.args.created_at_ms,sim_ms:n.routing.args.sim_ms}),a=Xt(s)||`Knowledge view for ${e.wcomponent.id} created: ${Ko()}`,c=le(n),l=c&&c.id,d={id:e.wcomponent.id,base_id:e.wcomponent.base_id,wc_id_map:o,title:a,sort_type:l?"normal":"hidden",parent_knowledge_view_id:l};return Fe(d)}const FI="M14 2H4c-1.11 0-2 .9-2 2v10h2V4h10V2zm4 4H8c-1.11 0-2 .9-2 2v10h2V8h10V6zm2 4h-8c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z";function zI(e){return _(Cn,{...e,d:FI})}const LI=(e,t)=>({overlapping_wcomponent_ids:ey(e,t.wcomponent_id)}),BI={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,change_route:S.routing.change_route},UI=j(LI,BI);function WI(e){const{overlapping_wcomponent_ids:t,set_highlighted_wcomponent:n,change_route:i}=e,o=(t==null?void 0:t.length)||0,r="node_handle overlapping_nodes"+(o===0?" hidden ":""),a=o?`${o-1} other nodes at this location`:"",c=G(()=>{if(t)return l=>{l.stopImmediatePropagation(),n({id:e.wcomponent_id,highlighted:!1}),i({item_id:t[0]})}},[i,t]);return _("div",{className:r,title:a,onClick:c,children:_(zI,{fontSize:"small"})})}const HI=UI(WI);function GI(e){return _("div",{className:"handles",children:[_(KI,{show_move_handle:e.show_move_handle,user_requested_node_move:e.user_requested_node_move}),_(gd,{wcomponent_id:e.wcomponent_id,wcomponent_current_kv_entry:e.wcomponent_current_kv_entry,is_highlighted:e.is_highlighted}),_(HI,{wcomponent_id:e.wcomponent_id})]})}function KI(e){const{show_move_handle:t,user_requested_node_move:n}=e,i="node_handle movement highlight_on_hover";return t?_("div",{className:i,onPointerDown:s=>{s.stopPropagation();const r=YI(s);n(r)},children:"✥"}):_("div",{className:i,children:" "})}function YI(e){const t=ye().getState(),{x:n,y:i,zoom:o}=t.routing.args;return{x:qy(n,o,e.clientX),y:Vy(i,o,e.clientY)}}function zy(e){const{values_and_prediction_sets:t=[],created_at_ms:n,sim_ms:i}=e,{present_item:o}=zi({items:t,created_at_ms:n,sim_ms:i});return o}function JI(e){const{VAP_set:t,VAP_set_id_to_counterfactual_v2_map:n,knowledge_views_by_id:i}=e,o=(n==null?void 0:n[t.id])||[],s={};return o.forEach(r=>{const{target_VAP_id:a}=r;if(!a)return;const c=Q2(r.id,i),l={counterfactual_v2_id:r.id,counterfactual_has_knowledge_view:c},d=s[a]||[];d.push(l),s[a]=d}),s}function wd(e){var a;const t=uC(e.VAP_set,e.VAPs_represent),n=(a=t.shared_entry_values)==null?void 0:a.conviction;let i=0;const o=Iw(e.wcomponent),s=t.entries.map(c=>{const l=fk(c,e.VAPs_represent),d=Rw(l,o),p=n??c.conviction,f=c.probability*p;return i+=f,{VAP_id:c.id,value_id:c.value_id,parsed_value:l,value_text:d,certainty:f}}),r=Ke(s,c=>c.certainty,Be.descending);return mC(i,r)}const XI="m9.78 11.16-1.42 1.42c-.68-.69-1.34-1.58-1.79-2.94l1.94-.49c.32.89.77 1.5 1.27 2.01zM11 6 7 2 3 6h3.02c.02.81.08 1.54.19 2.17l1.94-.49C8.08 7.2 8.03 6.63 8.02 6H11zm10 0-4-4-4 4h2.99c-.1 3.68-1.28 4.75-2.54 5.88-.5.44-1.01.92-1.45 1.55-.34-.49-.73-.88-1.13-1.24L9.46 13.6c.93.85 1.54 1.54 1.54 3.4v5h2v-5c0-2.02.71-2.66 1.79-3.63 1.38-1.24 3.08-2.78 3.2-7.37H21z";function Ly(e){return _(Cn,{...e,d:XI})}const By="darkorange";function ZI(e){const{VAP_visual:t,counterfactual_VAP_set:n,VAP_id_to_counterfactuals_info_map:i}=e,o=t.certainty*100,s=`${o}%`,r=Math.round(o);let a=100;r<100&&(a=r*1.25);const c=i[t.VAP_id]||[],l=n.has_any_counterfactual_applied?"warning_color":"";return _("div",{className:`value_and_prediction prob-${r} ${l}`,style:{fontSize:`${a}%`,maxHeight:s,minHeight:s},children:[t.value_text,c.map(d=>_(QI,{any_active:n.has_any_counterfactual_applied,counterfactual:d,active_counterfactual_v2_id:n.active_counterfactual_v2_id}))]})}function QI(e){const i={fontSize:"25px",color:e.counterfactual.counterfactual_v2_id===e.active_counterfactual_v2_id?By:e.any_active?"white":"#ffc965",verticalAlign:"middle",fontWeight:"bold",width:"20px"};return _("span",{onPointerDown:o=>o.stopImmediatePropagation(),onClick:o=>o.stopImmediatePropagation(),style:{display:"inline-flex"},children:[" ",_(Je,{route:void 0,sub_route:void 0,item_id:e.counterfactual.counterfactual_v2_id,args:void 0,extra_css_style:i,children:_(Ly,{fontSize:"small"})}),e.counterfactual.counterfactual_has_knowledge_view&&_("span",{style:{fontSize:14},children:_(gd,{wcomponent_id:e.counterfactual.counterfactual_v2_id||"",is_highlighted:!0})})," "]})}function eR(e){const{counterfactual_VAP_set:t,VAP_id_to_counterfactuals_info_map:n}=e,i={},o=de(e.wcomponent,i),s=wd({...e,VAP_set:t,VAPs_represent:o}),r=s.filter(a=>a.certainty>0);return _(R,{height:"100%",maxWidth:"100%",minWidth:100,overflow:"hidden",position:"relative",flexDirection:"column",justifyContent:"flex-end",alignItems:"stretch",alignContent:"stretch",className:`value_and_prediction_set_summary items-${s.length} visible-${r.length}`,children:s.map((a,c)=>_(ZI,{wcomponent:e.wcomponent,VAP_visual:a,counterfactual_VAP_set:t,VAP_id_to_counterfactuals_info_map:n}))})}const tR=(e,t)=>({VAP_set_id_to_counterfactual_v2_map:Qb(e,t.wcomponent.id),knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),nR=j(tR);function iR(e){const{wcomponent:t,VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o}=e,s=xl({VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i}),r=JI({VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o});return _(eR,{wcomponent:t,counterfactual_VAP_set:s,VAP_id_to_counterfactuals_info_map:r})}const oR=nR(iR);function sR(e){if(!Ki(e.wcomponent))return null;const t=zy({...e,values_and_prediction_sets:e.wcomponent.values_and_prediction_sets});return t?_(oR,{wcomponent:e.wcomponent,VAP_set:t}):null}const Hc={r:175,g:175,b:175,a:.11};const $h=tt,Ch=tt,rR=e=>{var t;return{is_editing:!e.display_options.consumption_formatting,frame_is_resizing:e.meta_wcomponents.frame_is_resizing,knowledge_view_id:(t=qe(e))==null?void 0:t.id}},_R={set_frame_is_resizing:S.meta_wcomponents.set_frame_is_resizing,upsert_knowledge_view_entry:S.specialised_object.upsert_knowledge_view_entry},aR=j(rR,_R);function cR(e){const{wcomponent_id:t,kv_entry:n,is_editing:i,frame_is_resizing:o,knowledge_view_id:s,set_frame_is_resizing:r}=e;if((n==null?void 0:n.frame_width)===void 0||(n==null?void 0:n.frame_height)===void 0)return null;const[a,c]=I(void 0),[l,d]=I(void 0),p=v=>g=>{g.stopImmediatePropagation(),g.preventDefault(),r({frame_is_resizing:!0}),c(v)},f=G(()=>p(!0),[]),m=G(()=>p(!1),[]);oe(()=>U.canvas.sub("canvas_move",v=>{if(a===void 0)return;const g=a?n.frame_width:qt(v.x-n.left+Ch),b=a?qt(-v.y-n.top+$h):n.frame_height;d({...n,frame_width:g,frame_height:b})})),oe(()=>U.canvas.sub("canvas_pointer_up",()=>{!o||!s||l&&(e.upsert_knowledge_view_entry({wcomponent_id:t,knowledge_view_id:s,entry:l}),d(void 0),r({frame_is_resizing:!1}),c(void 0))}));const h=l||n;return _("div",{className:"wcomponent_background_frame",style:{top:h.top-$h,left:h.left-Ch,width:h.frame_width,height:h.frame_height,backgroundColor:$t(h.frame_color||Hc),borderColor:$t(xI(h.frame_color||Hc))},children:[i&&_("div",{className:"editable_edge editable_edge_bottom",onPointerDown:f}),i&&_("div",{className:"editable_edge editable_edge_right",onPointerDown:m})]})}const lR=aR(cR),Uy=!1,dR=(e,t)=>{const{id:n,always_show:i=Uy}=t,o=e.global_keys.derived.shift_or_control_down,s=J2(e,n),{current_composed_knowledge_view:r}=e.derived,a=e.derived.composed_wcomponents_by_id[n],c=a&&r&&a.base_id!==r.base_id;let l,d=new Set;r&&(l=r.composed_wc_id_map[n],d=r.filters.wc_ids_excluded_by_filters);const p=e.meta_wcomponents.selected_wcomponent_ids_set.has(n),{created_at_ms:f,sim_ms:m}=e.routing.args,h=i||!a?!0:Eo({wcomponent:a,kv_entry:l,created_at_ms:f,sim_ms:m,is_selected:p,wc_ids_excluded_by_filters:d});return{on_current_knowledge_view:s,kv_entry:l,derived_composed_wcomponent:a,kv_from_different_base:c,wc_id_to_counterfactuals_map:ft(e),composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,is_current_item:e.routing.item_id===n,is_selected:p,is_highlighted:e.meta_wcomponents.highlighted_wcomponent_ids.has(n),shift_or_control_keys_are_down:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,is_editing:!e.display_options.consumption_formatting,should_display:h,focused_mode:e.display_options.focused_mode,node_is_moving:e.meta_wcomponents.wcomponent_ids_to_move_set.has(n),display_time_marks:e.display_options.display_time_marks,connected_neighbour_is_highlighted:e.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(n)}},uR={clicked_wcomponent:S.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:S.meta_wcomponents.clear_selected_wcomponents,change_route:S.routing.change_route,set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,pointerupdown_on_component:S.meta_wcomponents.pointerupdown_on_component,pointerupdown_on_connection_terminal:S.meta_wcomponents.pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move:S.meta_wcomponents.set_wcomponent_ids_to_move,request_searching_for_wcomponents_by_id_in_any_base:S.sync.request_searching_for_wcomponents_by_id_in_any_base},pR=j(dR,uR);function mR(e){const{id:t,is_on_canvas:n=!0,always_show:i=Uy,is_editing:o,derived_composed_wcomponent:s,kv_entry:r,kv_from_different_base:a,wc_id_to_counterfactuals_map:c,knowledge_views_by_id:l,is_current_item:d,is_selected:p,is_highlighted:f,shift_or_control_keys_are_down:m,should_display:h,created_at_ms:v,sim_ms:g,clicked_wcomponent:b,clear_selected_wcomponents:w,composed_wcomponents_by_id:x}=e,{change_route:y,set_highlighted_wcomponent:$}=e;if(oe(()=>{s||e.request_searching_for_wcomponents_by_id_in_any_base({ids:[t]})},[!!s]),!r&&!i)return _("div",{children:["Could not find knowledge view entry for id ",t]});const C=r||{left:0,top:0},[E,N]=I(void 0);if(oe(()=>{if(!e.node_is_moving)return;const Ze=U.canvas.sub("throttled_canvas_node_drag_relative_position",En=>{const ui={...C};ui.left+=En.left,ui.top+=En.top,N(ui)});return()=>{N(void 0),Ze()}},[e.node_is_moving]),!h)return null;let A=Pb({is_editing:o,is_highlighted:f,connected_neighbour_is_highlighted:e.connected_neighbour_is_highlighted,is_selected:p,is_current_item:d,focused_mode:e.focused_mode});A=e.node_is_moving?.3:A;const M=Oy({wcomponent_id:t,clicked_wcomponent:b,clear_selected_wcomponents:w,shift_or_control_keys_are_down:m,change_route:y,is_current_item:d}),D=e.node_is_moving?[]:[_(GI,{show_move_handle:n&&o&&f,user_requested_node_move:Ze=>{EI(t,Ze)},wcomponent_id:t,wcomponent_current_kv_entry:C,is_highlighted:f})],T=s?at({wcomponent:s,wcomponents_by_id:x,knowledge_views_by_id:l,wc_id_to_counterfactuals_map:c,created_at_ms:v,sim_ms:g}):"&lt;Not found&gt;",L=o,ne={transform:`scale(${C.s&&n?C.s:1})`},Ue=f?"orange":(p||d)&&"blue",Xe=hR({wcomponent:s,wcomponents_by_id:x,sim_ms:g,created_at_ms:v,display_time_marks:e.display_time_marks}),Tn=` wcomponent_canvas_node  wcomponent_${t} `+(o?e.on_current_knowledge_view?" node_on_kv ":" node_on_foundational_kv ":"")+(e.node_is_moving?" node_is_moving ":"")+(f?" node_is_highlighted ":"")+(d?" node_is_current_item ":"")+(p?" node_is_selected ":"")+(s?` node_is_type_${s.type} `:"")+(L?" compact_title ":"")+Xe.font+Xe.background;let Bt=!1;s&&(Bt=o&&At(s)||!s.hide_state&&ni(s));const ht=fR({is_on_canvas:n,is_editing:o,is_highlighted:f}),Ss=Ze=>{Ze.stopImmediatePropagation(),Ze.preventDefault(),e.pointerupdown_on_component({up_down:"down",wcomponent_id:t})},As=Ze=>{Ze.stopImmediatePropagation(),Ze.preventDefault(),e.pointerupdown_on_component({up_down:"up",wcomponent_id:t})},$s=(Ze,En)=>e.pointerupdown_on_connection_terminal({terminal_type:Ze,up_down:En,wcomponent_id:t}),ro=n?E||C:void 0,Cs=G(()=>vR(s),[s]);return _("div",{children:[_(lR,{wcomponent_id:t,kv_entry:ro}),_(bI,{position:ro,cover_image:s==null?void 0:s.summary_image,node_main_content:_("div",{children:[!(s!=null&&s.summary_image)&&_("div",{className:"background_image"}),_("div",{className:"node_title",children:[r===void 0&&o&&_("span",{children:[_(nn,{message:"Missing from this knowledge view"})," "]}),a&&o&&_("span",{children:[_(nn,{message:"Is from a different project to this knowledge view"})," "]}),(o||!(s!=null&&s.hide_title))&&_(io,{options:{...Yl,forceInline:!0},children:T})]}),s&&Bt&&_("div",{className:"node_state_container",children:[o&&_("div",{className:"description_label",children:"state  "}),_("div",{className:"value_and_prediction_summary",children:_(sR,{wcomponent:s,created_at_ms:v,sim_ms:g})})]}),s&&o&&_("div",{className:"description_label",children:Bi(s.type)}),_("div",{style:{display:"flex"},title:s!=null&&s.description.trim()?"Further details are included":void 0,children:[(s==null?void 0:s.description.trim())&&_(Dy,{className:"description_icon",fontSize:"small",color:"disabled"}),s&&_(TI,{label_ids:Cs})]})]}),extra_css_class:Tn,extra_styles_for_node_main_content:ne,opacity:A,unlimited_width:!1,glow:Ue,on_click:M,on_pointer_enter:()=>$({id:t,highlighted:!0}),on_pointer_leave:()=>$({id:t,highlighted:!1}),terminals:ht,on_pointer_down:Ss,on_pointer_up:As,pointerupdown_on_connection_terminal:$s,other_children:D})]})}const Gc=pR(mR),hc=[],Wy=[];J1.forEach(e=>{X1.forEach(t=>{const n={attribute:e,side:t},i=Bw(n),o=n.attribute.slice(0,1).toUpperCase();Wy.push({type:n,style:i,label:o})})});function fR(e){return!e.is_on_canvas||!e.is_editing||!e.is_highlighted?hc:Wy}function hR(e){let t="",n="";const{wcomponent:i,created_at_ms:o,sim_ms:s}=e;if(!i)return{background:" node_missing ",font:n};if(ot(i)){const r=Qn({wcomponent:i,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:o,sim_ms:s}),a=r.most_probable_VAP_set_values[0];r.any_uncertainty?t=" past_uncertain ":a&&(a.value_id===we.action_completed||a.value_id===we.action_failed||a.value_id===we.action_rejected)&&(t=" past_certain ",n=" color_light ")}else{const r=rl(i.id,e.wcomponents_by_id);if(r){const{temporal_uncertainty:a,certainty:c}=r,l=ii(a);l&&l.getTime()<s?c===1||c===void 0?(t=" past_certain ",n=" color_light "):t=" past_uncertain ":l||(c===1||c===void 0)&&(t=" past_certain ",n=" color_light ")}}return{background:t,font:n}}function vR(e){if(!e)return[];const t=[...e.label_ids||[]],n=new Set(t);return ot(e)&&e.parent_goal_or_action_ids&&e.parent_goal_or_action_ids.forEach(i=>{n.has(i)||(t.push(i),n.add(i))}),t}const gR=e=>({editing:!e.display_options.consumption_formatting}),wR={upsert_wcomponent:S.specialised_object.upsert_wcomponent},bR=j(gR,wR);function yR(e){const{action:t,upsert_wcomponent:n}=e;return _("div",{className:"prioritisable_action",children:[_(Gc,{id:t.id,is_on_canvas:!1,always_show:!0}),e.show_icebox_actions&&_("div",{className:"controls",children:_(ce,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:new Date().getTime()}}),children:_(Ry,{})})}),e.show_todo_actions&&_("div",{className:"controls",children:[_(ce,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:new Date().getTime()}}),children:_(ys,{})}),_(ce,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:void 0}}),children:_(Iy,{})})]})]})}const yo=bR(yR);function kR(){return _(Ty,{main_content:_(CR,{})})}const xR=e=>{const{wcomponents_by_id:t}=e.specialised_objects;return{action_ids:u3(e),wcomponents_by_id:t,display_side_panel:e.controls.display_side_panel}},SR={upsert_wcomponent:S.specialised_object.upsert_wcomponent},AR=j(xR,SR);function $R(e){const{action_ids:t,wcomponents_by_id:n}=e,[i,o]=I(5),[s,r]=I(void 0),a=Ee(void 0),c=Ee(void 0),l=G(()=>{const w=Hv(n,t).filter(ot);return Ke(w,TR,Be.descending)},[t,n]),d=[],p=[],f=[],m=[],h=new Date().getTime();l.forEach(w=>{const y=Qn({wcomponent:w,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:h,sim_ms:h}).most_probable_VAP_set_values[0];(y==null?void 0:y.value_id)===we.action_in_progress?f.push(w):(y==null?void 0:y.value_id)===we.action_completed||(y==null?void 0:y.value_id)===we.action_rejected||(y==null?void 0:y.value_id)===we.action_failed?m.push(w):w.todo_index?p.push(w):d.push(w)});const v=m.length-i,g=Ke(p,w=>w.todo_index||0,Be.descending),b=G(()=>{var y;return((y=Ke(l,it,Be.descending)[0])==null?void 0:y.id)||""},[l]);return _("div",{className:`action_list_view_content ${s===void 0?"":"moving"}`,ref:w=>c.current=w||void 0,onPointerDown:w=>{const x=c.current;x&&(r({x:w.clientX,y:w.clientY}),a.current={left:x.scrollLeft,top:x.scrollTop})},onPointerMove:w=>{if(s===void 0||a.current===void 0||!c.current)return;const x=a.current.left-(w.clientX-s.x),y=a.current.top-(w.clientY-s.y);c.current.scroll(x,y)},onPointerUp:()=>r(void 0),onPointerLeave:()=>r(void 0),onPointerOut:w=>{let x=w.relatedTarget;x=a7(x,["action_list","action_list_view_content"]),!x&&r(void 0)},children:[_("div",{className:"action_list icebox",children:[_("h1",{children:["Icebox",_(bo,{list_type:"icebox",most_recent_action_id:b})]}),d.map(w=>_(yo,{action:w,show_icebox_actions:!0},w.id))]}),_("div",{className:"action_list todo",children:[_("h1",{children:["Todo",_(bo,{list_type:"todo",most_recent_action_id:b})]}),g.map(w=>_(yo,{action:w,show_todo_actions:!0},w.id))]}),_("div",{className:"action_list in_progress",children:[_("h1",{children:["In progress",_(bo,{list_type:"in_progress",most_recent_action_id:b})]}),f.map(w=>_(yo,{action:w},w.id))]}),_("div",{className:"action_list done_or_rejected",children:[_("h1",{children:["Done",_(bo,{list_type:"done",most_recent_action_id:b})]}),m.slice(0,i).map(w=>_(yo,{action:w},w.id)),v>0&&_("div",{style:{textAlign:"center",margin:40,cursor:"pointer"},onClick:()=>o(i+50),children:["... ",v," hidden ..."]})]}),_("div",{className:"side_panel_padding",style:{minWidth:e.display_side_panel?Ri:0}})]})}const CR=AR($R);function TR(e){return e.modified_at?e.modified_at.getTime():it(e)}function ER(e){const{canvas_start_x:t,canvas_start_y:n,canvas_end_x:i,canvas_end_y:o}=e,s={left:t,top:-o,width:i-t,height:o-n};return _("div",{className:`selection_box color_${e.color}`,style:s})}const Hy="graph_container",Gy="graph_visuals_container",jR=900,NR=10,PR=e=>{const{x:t,y:n,zoom:i}=e.routing.args,o=e.global_keys.keys_down.has("Shift"),s=e.global_keys.keys_down.has("Control");return{zoom:i,x:t,y:n,shift_key_down:o,control_key_down:s}},IR=e=>({change_routing_args:t=>{let n={};t.zoom!==void 0&&(n.zoom=Math.round(bl(t.zoom))),t.x!==void 0&&(n.x=Math.round(t.x)),t.y!==void 0&&(n.y=Math.round(t.y)),e(S.routing.change_route({args:n}))}}),RR=j(PR,IR);class DR extends Xh{constructor(n){super(n);dt(this,"manual_zoom_target");dt(this,"client_to_canvas",n=>hd(this.props.zoom,n));dt(this,"client_to_canvas_x",n=>qy(this.props.x,this.props.zoom,n));dt(this,"client_to_canvas_y",n=>Vy(this.props.y,this.props.zoom,n));dt(this,"on_pointer_down",n=>{if(U.canvas.pub("canvas_pointer_down",!0),n.button===2)return;const o=n.offsetX,s=n.offsetY,r={down:!0,area_select:this.props.shift_key_down,last_pointer_down_ms:new Date().getTime(),canvas_start_x:this.client_to_canvas_x(o),canvas_start_y:this.client_to_canvas_y(s),x_when_pointer_down:this.props.x,y_when_pointer_down:this.props.y,client_start_x:o,client_start_y:s};OR({zoom:this.props.zoom,current_pointer_state:this.state.pointer_state,new_pointer_state:r}),this.setState({pointer_state:r,canvas_current_x:r.canvas_start_x,canvas_current_y:r.canvas_start_y})});dt(this,"on_pointer_up",n=>{if(n==null||n.preventDefault(),U.canvas.pub("canvas_pointer_up",!0),this.state.pointer_state.area_select){const o=Eh(this.state),s={start_x:o.canvas_start_x,start_y:o.canvas_start_y,end_x:o.canvas_end_x,end_y:o.canvas_end_y};U.canvas.pub("canvas_area_select",s)}const i={...this.state.pointer_state,down:!1,area_select:!1};this.setState({pointer_state:i,canvas_current_x:void 0,canvas_current_y:void 0})});dt(this,"on_pointer_leave",()=>{this.state.pointer_state.area_select||this.on_pointer_up()});dt(this,"on_pointer_move",n=>{if(U.canvas.pub("canvas_move",{x:this.client_to_canvas_x(n.offsetX),y:this.client_to_canvas_y(n.offsetY)}),!this.state.pointer_state.down)return;const i=n.offsetX,o=n.offsetY;if(this.state.pointer_state.area_select){const s=this.client_to_canvas_x(i),r=this.client_to_canvas_y(o);this.setState({canvas_current_x:s,canvas_current_y:r})}else{const s=this.state.pointer_state.client_start_x-i,r=this.state.pointer_state.client_start_y-o,a=this.state.pointer_state.x_when_pointer_down+this.client_to_canvas(s),c=this.state.pointer_state.y_when_pointer_down-this.client_to_canvas(r);this.props.change_routing_args({x:a,y:c})}});dt(this,"on_wheel",n=>{n.stopPropagation(),n.preventDefault();const i=n.deltaY,o=w$({zoom:this.props.zoom,wheel_change:i});if(o===this.props.zoom)return;const s=this.props.zoom/Oe,{pointer_x:r,pointer_y:a}=qR(n,this.props,s),{offsetHeight:c,offsetWidth:l}=n.currentTarget,d=$w({old:this.props,new_zoom:o,pointer_x:r,pointer_y:a,client_height:c,client_width:l});this.props.change_routing_args({zoom:o,x:d.x,y:d.y}),this.manual_zoom_target=o});dt(this,"on_context_menu",n=>{n.stopPropagation(),n.preventDefault();const i=this.client_to_canvas_x(n.offsetX),o=this.client_to_canvas_y(n.offsetY);n.button===2&&U.canvas.pub("canvas_right_click",{x:i,y:o})});this.state={pointer_state:{down:!1,area_select:!1,last_pointer_down_ms:void 0,canvas_start_x:void 0,canvas_start_y:void 0,x_when_pointer_down:void 0,y_when_pointer_down:void 0,client_start_x:void 0,client_start_y:void 0},canvas_current_x:void 0,canvas_current_y:void 0}}render(){const{zoom:n}=this.props,i=n/Oe,o=-1*this.props.x*i,s=this.props.y*i,r=tt*i,a=this.state.pointer_state.down,c=this.manual_zoom_target===n;this.manual_zoom_target=void 0;const l=a?0:c?.1:1,d={transition:`background-position ${l}s, background-size ${l}s`,backgroundPosition:`${o}px ${s}px`,backgroundSize:`${r}px ${r}px`},p={transition:`background-position ${l}s, background-size ${l}s`,backgroundPosition:`${o}px ${s}px`,backgroundSize:`${Jn*i}px ${vn*i}px`},f={transition:`transform ${l}s`,transform:`translate(${o}px,${s}px)`},m={transition:`transform ${l}s`,transformOrigin:"left top",transform:`scale(${i})`},h=(this.props.plain_background?"":"squared_background ")+(this.state.pointer_state.down?"graph_background_pointer_down ":"");return _("div",{style:{flexGrow:1},className:this.props.extra_class_names,children:_("div",{id:Hy,className:h,style:d,onPointerDown:this.on_pointer_down,onPointerMove:this.on_pointer_move,onPointerUp:this.on_pointer_up,onPointerLeave:this.on_pointer_leave,onWheel:this.on_wheel,onDragOver:v=>{v.preventDefault(),v.dataTransfer.dropEffect="move"},onContextMenu:this.on_context_menu,children:[!this.props.plain_background&&this.props.show_large_grid&&_("div",{className:"big_squared_background",style:p}),_("div",{id:Gy,style:f,children:_("div",{style:m,children:[_("div",{id:"graph_lowest_elements_container",children:[_("svg",{style:{zIndex:0,position:"absolute",top:0,left:0},children:[Th,this.props.svg_children]}),this.props.children,_("svg",{style:{zIndex:2,position:"absolute",top:0,left:0},children:[Th,this.props.svg_upper_children]})]}),this.state.pointer_state.area_select&&_(ER,{...Eh(this.state),color:this.props.control_key_down?"red":"blue"})]})}),_("div",{children:this.props.overlay})]})})}}const MR=RR(DR),Th=_("defs",{children:Array.from(Array(101)).map((e,t)=>_("filter",{id:"blur_filter_"+t,x:"0",y:"0",children:_("feGaussianBlur",{in:"SourceGraphic",stdDeviation:t/20})}))});function OR(e){const{zoom:t,current_pointer_state:n,new_pointer_state:i}=e;if(!n.last_pointer_down_ms||!i.last_pointer_down_ms||i.last_pointer_down_ms-n.last_pointer_down_ms>jR)return;const{canvas_start_x:s,canvas_start_y:r}=n,{canvas_start_x:a,canvas_start_y:c}=i;if(s===void 0||r===void 0||a===void 0||c===void 0)return;const l=Math.abs(s-a),d=Math.abs(r-c),p=NR/t;l>p||d>p||U.canvas.pub("canvas_double_tap",{x:s,y:r})}function Eh(e){const t=e.pointer_state.canvas_start_x||0,n=e.pointer_state.canvas_start_y||0,i=e.canvas_current_x||0,o=e.canvas_current_y||0;return{canvas_start_x:Math.min(t,i),canvas_start_y:Math.min(n,o),canvas_end_x:Math.max(t,i),canvas_end_y:Math.max(n,o)}}function qR(e,t,n){let i=e.offsetX,o=e.offsetY,s=e.target;if(s.id!==Hy){for(;s.id!==Gy;)i+=s.offsetLeft||0,o+=s.offsetTop||0,s=s.parentElement;i-=t.x,o+=t.y,i*=n,o*=n,i=Math.round(i),o=Math.round(o)}return{pointer_x:i,pointer_y:o}}function VR(e){const[t,n]=I(!1),{connection_from_component:i,connection_to_component:o,line_behaviour:s,circular_links:r,on_pointer_over_out:a=()=>{},connection_end_type:c=Ft.positive,is_highlighted:l=!1}=e,d=t?2:e.thickness??2,p=Le(d*2.5,10,35),f=G(()=>Ie({connection_from_component:i,connection_to_component:o,line_behaviour:s,circular_links:r,end_size:p,connection_end_type:c}),[i,o,s,r,p,c]);if(!f)return null;const m=e.opacity??1,h=e.blur??0,v={strokeWidth:d+10},g={strokeOpacity:m,strokeWidth:d,filter:h?`url(#blur_filter_${Math.round(h)})`:""},b=t?" hovered ":e.focused_mode?"":l?" highlighted ":"",w=(e.on_click?" mouseable ":"")+b,x=()=>{n(!0),a(!0)},y=()=>{n(!1),a(!1)};return _("g",{className:"connection_container "+(e.extra_css_classes||""),onPointerDown:e.on_click,style:{display:e.hidden?"none":""},children:_(FR,{target_connection_coords:f,extra_background_classes:w,on_pointer_over:x,on_pointer_out:y,style_line_background:v,extra_line_classes:b,style_line:g,connection_end_type:c,opacity:m,blur:h,end_size:p,hovered:t,is_highlighted:l,line_behaviour:s})})}function FR(e){const[t,n]=I(e.target_connection_coords);oe(()=>BR(t,e.target_connection_coords,n),[e.target_connection_coords]);const i=zR(t,e.line_behaviour);return _(ue,{children:[_("path",{className:"connection_line_background "+e.extra_background_classes,d:i,onPointerOver:e.on_pointer_over,onPointerOut:e.on_pointer_out,style:e.style_line_background}),_("path",{className:"connection_line "+e.extra_line_classes,d:i,style:e.style_line}),_(LC,{type:e.connection_end_type,x:t.connection_end_x,y:t.connection_end_y,end_angle:t.end_angle,opacity:e.opacity,blur:e.blur,size:e.end_size,is_hovered:e.hovered,is_highlighted:e.is_highlighted})]})}function zR({line_start_x:e,line_start_y:t,relative_control_point1:n,relative_control_point2:i,line_end_x:o,line_end_y:s},r){if(r===Hn.angular){const p=(s-t)/2;return`
            M ${e} ${-t}
            L ${e} ${-t-p}
            L ${o} ${-t-p}
            L ${o} ${-s}
        `}const a=e+n.x,c=-t-n.y,l=o+i.x,d=-s-i.y;return`
        M ${e} ${-t}
        C ${a},${c}, ${l},${d}, ${o},${-s}
    `}const LR=1*1e3;function BR(e,t,n){if(e===t)return;let i=performance.now();function o(s){if(i<0)return;let r=(s-i)/LR;r=Math.min(r,1);const a={line_start_x:Pt(e.line_start_x,t.line_start_x,r),line_start_y:Pt(e.line_start_y,t.line_start_y,r),relative_control_point1:jh(e.relative_control_point1,t.relative_control_point1,r),relative_control_point2:jh(e.relative_control_point2,t.relative_control_point2,r),line_end_x:Pt(e.line_end_x,t.line_end_x,r),line_end_y:Pt(e.line_end_y,t.line_end_y,r),connection_end_x:Pt(e.connection_end_x,t.connection_end_x,r),connection_end_y:Pt(e.connection_end_y,t.connection_end_y,r),end_angle:Pt(e.end_angle,t.end_angle,r)};r>=1?(i=-1,n(t)):(n(a),requestAnimationFrame(o))}return requestAnimationFrame(o),()=>i=-1}function Pt(e,t,n){return e+(t-e)*n}function jh(e,t,n){return{x:Pt(e.x,t.x,n),y:Pt(e.y,t.y,n)}}function Ky(e){const{wcomponent:t,current_composed_knowledge_view:n,from_wc:i,to_wc:o}=e,{kv_entry_from_wc:s,kv_entry_to_wc:r,from_attribute:a,to_attribute:c}=UR({wcomponent:t,wc_id_map:n.composed_wc_id_map}),l={side:"right",attribute:a},d={side:"left",attribute:c},p=i==null?void 0:i.type,f=o==null?void 0:o.type;return{connection_from_component:s&&p&&{kv_wc_entry:s,wcomponent_type:p,connection_terminal_type:l},connection_to_component:r&&f&&{kv_wc_entry:r,wcomponent_type:f,connection_terminal_type:d}}}function UR({wcomponent:e,wc_id_map:t}){const n=t[e.from_id],i=t[e.to_id],o=e.from_type,s=e.to_type;return{kv_entry_from_wc:n,kv_entry_to_wc:i,from_attribute:o,to_attribute:s}}const WR=(e,t)=>{const{id:n}=t,i=Me(e,n),{selected_wcomponent_ids_set:o}=e.meta_wcomponents,{current_composed_knowledge_view:s}=e.derived,{created_at_ms:r,sim_ms:a}=e.routing.args,c=!e.display_options.consumption_formatting;let l=!1,d,p,f;if(!(!i||!s)){const{wc_ids_excluded_by_filters:h}=s.filters,v=s.composed_wc_id_map[i.id];if(Ne(i)){d=Me(e,i.from_id),p=Me(e,i.to_id);const g=s.composed_wc_id_map[i.from_id],b=s.composed_wc_id_map[i.to_id];l=un({wcomponent:i,kv_entry:v,from_wc:d,to_wc:p,from_wc__kv_entry:g,to_wc__kv_entry:b,created_at_ms:r,sim_ms:a,selected_wcomponent_ids_set:o,wc_ids_excluded_by_filters:h}),f=JR(i,d,e)}}const m=e.global_keys.derived.shift_or_control_down;return{current_composed_knowledge_view:s,wcomponent:i,from_wc:d,to_wc:p,connection_effect:f,should_display:l,is_current_item:e.routing.item_id===n,is_selected:e.meta_wcomponents.selected_wcomponent_ids_set.has(n),is_highlighted:e.meta_wcomponents.highlighted_wcomponent_ids.has(n),is_editing:c,shift_or_control_keys_are_down:m,focused_mode:e.display_options.focused_mode,connected_neighbour_is_highlighted:e.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(n),circular_links:e.display_options.circular_links}},HR={clicked_wcomponent:S.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:S.meta_wcomponents.clear_selected_wcomponents,set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,change_route:S.routing.change_route},GR=j(WR,HR);function KR(e){const{id:t,current_composed_knowledge_view:n,wcomponent:i,from_wc:o,to_wc:s,is_current_item:r,is_highlighted:a,is_selected:c,should_display:l,connection_effect:d,shift_or_control_keys_are_down:p,change_route:f,clicked_wcomponent:m,clear_selected_wcomponents:h}=e;if(!i)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but could not find it`),null;if(!tk(i))return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but was not a causal link`),null;if(!l)return null;if(!n)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but no current_composed_knowledge_view`),null;const v=Oy({wcomponent_id:t,clicked_wcomponent:m,clear_selected_wcomponents:h,shift_or_control_keys_are_down:p,change_route:f,is_current_item:r}),g=Ky({wcomponent:i,from_wc:o,to_wc:s,current_composed_knowledge_view:n}),{connection_from_component:b,connection_to_component:w}=G(()=>g,[JSON.stringify(g)]),x=Pb({is_editing:e.is_editing,is_current_item:r,is_selected:c,connected_neighbour_is_highlighted:e.connected_neighbour_is_highlighted,focused_mode:e.focused_mode});let y=2,$=Ft.positive,C="";d!==void 0&&(y=Le(Math.abs(d),2,15),d<0?($=Ft.negative,C="negative_connection_effect"):d===0&&($=Ft.noop,C="no_connection_effect"));let E;return Ne(i)&&(E=i.line_behaviour),_(VR,{connection_from_component:b,connection_to_component:w,on_click:v,on_pointer_over_out:N=>e.set_highlighted_wcomponent({id:t,highlighted:N}),line_behaviour:E,circular_links:e.circular_links,thickness:y,connection_end_type:$,opacity:x,is_highlighted:r||a||c,focused_mode:e.focused_mode,extra_css_classes:"connection_type_"+i.type+" "+C})}const YR=GR(KR);function JR(e,t,n){var o;let i;if(sn(e)&&(i=e.effect_when_true,Ye(t))){const s=zy({values_and_prediction_sets:t.values_and_prediction_sets,created_at_ms:n.routing.args.created_at_ms,sim_ms:n.routing.args.sim_ms});if(s){const r=Qb(n,t.id),a=xl({VAP_set:s,VAP_set_id_to_counterfactual_v2_map:r}),l=de(t,{}),p=(o=wd({wcomponent:t,VAP_set:a,VAPs_represent:l})[0])==null?void 0:o.parsed_value;p!=null&&(l===P.boolean?i=p===!0?e.effect_when_true:e.effect_when_false??e.effect_when_true:i=typeof p=="number"?e.effect_when_true!==void 0?p*e.effect_when_true:void 0:e.effect_when_true)}}return i!==void 0?Le(i,-100,100):void 0}var bd={},XR=ee;Object.defineProperty(bd,"__esModule",{value:!0});var Yy=bd.default=void 0,ZR=XR(Q()),QR=te(),eD=(0,ZR.default)((0,QR.jsx)("path",{d:"m20 12-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"}),"ArrowDownward");Yy=bd.default=eD;const tD=e=>{const t=le(e),n=t==null?void 0:t.composed_datetime_line_config;return{display_time_marks:e.display_options.display_time_marks,time_origin_ms:n==null?void 0:n.time_origin_ms,time_origin_x:n==null?void 0:n.time_origin_x,time_scale:n==null?void 0:n.time_scale,time_line_number:n==null?void 0:n.time_line_number,time_line_spacing_days:n==null?void 0:n.time_line_spacing_days,x:e.routing.args.x,zoom:e.routing.args.zoom,sim_ms:e.routing.args.sim_ms}},nD=j(tD);function iD(e){if(!(e.force_display??e.display_time_marks))return null;let{time_origin_ms:t,time_origin_x:n,time_scale:i}=e;if(e.force_display&&({time_origin_ms:t,time_origin_x:n,time_scale:i}=JA({time_origin_ms:t,time_origin_x:n,time_scale:i})),t===void 0||n===void 0||i===void 0)return null;const{sim_ms:o,time_line_number:s,time_line_spacing_days:r}=e,a=G(()=>_D({time_line_number:s&&s-1,time_line_spacing_days:r}),[s,r]),{x:c,zoom:l}=e,d=l/Oe,p=(c-n)*d,f=i/Lh*d,m=new Date().getTime();return _("div",{className:"datetime_lines_container",children:[a.map(h=>_(vc,{date_ms:(e.show_by_now?m:o)+h.offset,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:p,xd:d,color:"black",opacity:h.opacity},h.key)),!!s&&_(vc,{date_ms:m,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:p,xd:d,color:"red",left_label_when_off_screen:!0}),!!s&&!e.show_by_now&&_(vc,{date_ms:o,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:p,xd:d,color:"blue",left_label_when_off_screen:!0})]})}const oD=nD(iD),sD="yyyy-MM-dd";function vc(e){const{color:t,opacity:n}=e;let i=(e.date_ms-e.time_origin_ms)*e.time_scale_ms_to_pixels_fudge-e.xm;const o=document.body.clientWidth-20,s=i<0,r=i>o,a=!s&&!r;return!a&&!e.left_label_when_off_screen?null:(i=Le(i,0,o),_("div",{className:"datetime_container",style:{color:t,borderColor:t,left:i,opacity:n},children:[_("div",{className:"rotater",children:[s&&_(ys,{fontSize:"small"}),r&&_(Yy,{fontSize:"small"}),_("div",{className:"date_label",children:Zt(new Date(e.date_ms),sD)})]}),a&&_("div",{className:"datetime_line"})]}))}const rD=1e3*3600*24;function _D(e){const t=[],{time_line_number:n,time_line_spacing_days:i}=e;if(n===void 0||i===void 0)return[];const o=i*rD;for(let s=n;s>0;--s){const r=s/n,a=n-s+1;t.push({offset:o*a,opacity:r,key:`plus${s}`}),t.push({offset:-o*a,opacity:r,key:`minus${s}`})}return t}const aD=e=>{const{ready_for_reading:t}=e.sync,{current_composed_knowledge_view:n}=e.derived;t&&!n&&console.log("No current_composed_knowledge_view");const{wc_ids_by_type:i,wcomponent_unfound_ids:o}=n||{},s=e.meta_wcomponents.wcomponent_ids_to_move_set.size>0,r=e.meta_wcomponents.frame_is_resizing,a=s||r;return{ready:t,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,wc_ids_by_type:i,wcomponent_unfound_ids:o,presenting:e.display_options.consumption_formatting,show_large_grid:e.display_options.show_large_grid,canvas_drag_event:a}},cD=j(aD);function lD(e){const t=uD(e),[n,i]=I(!1);oe(()=>U.canvas.sub("canvas_pointer_down",()=>{i(!0)})),oe(()=>U.canvas.sub("canvas_pointer_up",()=>{i(!1)}));const o=e.canvas_drag_event||n?" canvas_drag_event ":"";return _(Ty,{main_content:_(MR,{svg_children:[],svg_upper_children:pD(e),overlay:mD(),plain_background:e.presenting,show_large_grid:e.show_large_grid,extra_class_names:o,children:t})})}const dD=cD(lD),gc=[],uD=e=>{const{ready:t,wc_ids_by_type:n,wcomponents_by_id:i,wcomponent_unfound_ids:o=[]}=e;if(!t||!n)return gc;const s=[];return n.any_node.forEach(a=>{const c=i[a];c&&s.push(c)}),s.length===0&&o.length===0?gc:[...s.map(({id:a})=>_(Gc,{id:a},a)),...o.map(a=>_(Gc,{id:a},a))]},pD=({wc_ids_by_type:e})=>{const t=ye().getState();return Do(t,e==null?void 0:e.any_link).filter(Ne).map(({id:i})=>_(YR,{id:i},i))},mD=()=>_(oD,{}),fD=e=>{const{view:t}=e.routing.args;return{view:t}},hD=j(fD);function vD(e){let t=_("div",{children:["Unsupported view: ",e.view]});return e.view==="knowledge"?t=_(dD,{}):e.view==="actions_list"&&(t=_(kR,{})),t}const gD=hD(vD);function wD(){return bD(),I(!1),null}const bD=Ct(e=>({button:{display:"inline-block",marginRight:"1em",border:`1px ${e.palette.divider} solid`},icon:{position:"relative",zIndex:10}}));const yD=()=>{const[e,t]=I([]);return oe(()=>{const n=kD(),i=U.toast.sub("accepted_toast_message",o=>{t(s=>[...s,o]),setTimeout(()=>{t(s=>s.filter(r=>r!==o))},o.duration)});return()=>{n(),i()}},[]),_("div",{class:"toast-container",children:e.map(n=>{const i={animationDelay:`0s, ${n.duration-500}ms`};return _("div",{class:`toast toast-${n.type}`,style:i,ref:o=>{o&&o.style.setProperty("--toast-height",`${o.offsetHeight}px`)},children:n.text},n.id)})})};function kD(){const e=ye();let t;const n=5e3;function i(){const o=e.getState();o.toast_message.warn_can_not_edit_ms&&(t?o.toast_message.warn_can_not_edit_ms-t:Number.MAX_SAFE_INTEGER)>n&&(t=o.toast_message.warn_can_not_edit_ms,U.toast.pub("send_toast_message",{type:"info",text:"You can view this project (but not edit it).",duration:n}))}return e.subscribe(i)}const xD="2025-07-03";function SD(){return _("div",{children:[_("span",{className:"description_label",children:"Version"})," ",_("b",{children:xD})]})}function nt(e){e.value;const{on_change:t}=e,n=e.disabled||!t;return _("input",{type:"checkbox",checked:e.value,disabled:n,style:{cursor:n?"not-allowed":""},onChange:i=>{if(!t)return;const o=i.currentTarget.checked;t(o)}})}function AD(){const e=Ot.get_state();return _(ue,{children:[_("b",{children:_(ko,{show_label:!0})}),_("p",{className:"section",children:[_(ko,{})," ",_("b",{children:["Enable Angular Connections ",_("span",{style:{position:"relative",top:"-0.5em"},children:["⌞",_("span",{style:{position:"relative",top:"0.8em",left:"-2px"},children:"⌝"})]})]}),_(nt,{value:e.enable_angular_connections,on_change:t=>{Ot.set_state_and_reload_page({enable_angular_connections:t})}})]}),_("p",{className:"section",children:[_(ko,{})," ",_("b",{children:"Enable actions kanban view"}),_(nt,{value:e.enable_action_kanban_view,on_change:t=>{Ot.set_state_and_reload_page({enable_action_kanban_view:t})}})]}),_("div",{className:"section",children:[_(ko,{})," ",_("b",{children:"Enable aligning components by time on x-axis"}),_(nt,{value:e.enable_align_components_on_x_by_time,on_change:t=>{Ot.set_state_and_reload_page({enable_align_components_on_x_by_time:t})}})]})]})}function ko(e){const t="Experimental feature.  May be changed or removed in the future.  Toggling an experimental feature on or off will reload the page.";return _(no,{warning:t,label:e.show_label?t:""})}const $D=e=>({focused_mode:e.display_options.focused_mode,circular_links:e.display_options.circular_links,animate_connections:e.display_options.animate_connections,show_large_grid:e.display_options.show_large_grid,display_time_sliders:e.controls.display_time_sliders}),CD={set_or_toggle_focused_mode:S.display.set_or_toggle_focused_mode,set_or_toggle_circular_links:S.display.set_or_toggle_circular_links,set_or_toggle_animate_connections:S.display.set_or_toggle_animate_connections,set_or_toggle_show_large_grid:S.display.set_or_toggle_show_large_grid,set_display_time_sliders:S.controls.set_display_time_sliders},TD=j($D,CD);function ED(e){return _("div",{className:"side_panel",children:[_("p",{className:"section",children:[_("b",{children:'Use "Focused" Mode'}),"  ",_(yt,{...se.toggle_focused}),_(nt,{value:e.focused_mode,on_change:e.set_or_toggle_focused_mode})]}),_("p",{className:"section",children:[_("b",{children:"Show connections as more circular"}),"  ",_(yt,{...se.toggle_circular_connections}),_(nt,{value:e.circular_links,on_change:e.set_or_toggle_circular_links})]}),_("p",{className:"section",children:[_("b",{children:"Animate connections"}),"  ",_(yt,{...se.toggle_animating}),_(nt,{value:e.animate_connections,on_change:e.set_or_toggle_animate_connections})]}),_("p",{className:"section",children:[_("b",{children:"Show large grid (whilst editing)"}),_(nt,{value:e.show_large_grid,on_change:e.set_or_toggle_show_large_grid})]}),_("hr",{}),_(AD,{}),_("hr",{}),_("h3",{children:"Controls"}),_("p",{className:"section",children:[_("b",{children:'Display time sliders for "created at" and "simulated" time'}),"  ",_(yt,{...se.toggle_time}),_(nt,{value:e.display_time_sliders,on_change:t=>{e.set_display_time_sliders(t)}})]})]})}const jD=TD(ED);var yd={},ND=ee;Object.defineProperty(yd,"__esModule",{value:!0});var Jy=yd.default=void 0,PD=ND(Q()),ID=te(),RD=(0,PD.default)((0,ID.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear");Jy=yd.default=RD;function DD(e){const{editing:t,option:n,on_remove_option:i,on_pointer_down_selected_option:o,on_mouse_over_option:s,on_mouse_leave_option:r}=e;return n?_(Gi,{size:"small",color:"primary",variant:"contained",fullWidth:!0,disableElevation:!0,style:{margin:5},children:[_(F,{onClick:()=>o&&o(n.id),disabled:!o,style:{cursor:o?"":"not-allowed",backgroundColor:n.color&&$t(n.color),color:n.color&&$t(My(n.color))},children:_(ze,{title:n.jsx||n.title,children:_(ae,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:n.jsx||n.title})})}),t&&_(ce,{onClick:()=>i(n.id),size:"small",children:_(Jy,{})})]}):null}const MD=(e,t)=>({editable:t.editing_allowed!==void 0?t.editing_allowed:!e.display_options.consumption_formatting}),OD={change_route:S.routing.change_route},qD=j(MD,OD);function VD(e){const{editable:t,options:n,selected_option_ids:i}=e,{filtered_options:o,missing_options_by_id:s}=G(()=>{const a=n.filter(({id:l})=>!i.includes(l)),c={};if(a.length!==i.length){const l=new Set(a.map(({id:p})=>p));i.filter(p=>!l.has(p)).forEach(p=>{const f={id:p,title:"<Label Not found>"};c[p]=f,a.push(f)})}return{filtered_options:a,missing_options_by_id:c}},[n,i]),r=G(()=>{const a={...s};return n.forEach(c=>a[c.id]=c),a},[n,s]);return _(R,{width:"100%",children:[t&&_(Pe,{...e,selected_option_id:void 0,options:o,on_change:a=>{a!==void 0&&e.on_change([...i,a])},editing_allowed:t}),_("div",{style:{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden"},children:i.map(a=>_("div",{style:{flexGrow:1,flexShrink:1,flexBasis:"30%",maxWidth:"100%"},children:_(DD,{editing:t,option:r[a],on_remove_option:c=>{e.on_change(i.filter(l=>l!==c))},on_mouse_over_option:e.on_mouse_over_option,on_mouse_leave_option:e.on_mouse_leave_option,on_pointer_down_selected_option:c=>{e.change_route({item_id:c})}})}))})]})}const FD=qD(VD);function Ui(e){return _(FD,{...e})}const zD=e=>({ready:e.sync.ready_for_reading,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:ft(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),LD={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent},BD=j(zD,LD);function UD(e){const{ready:t,label_ids:n=[]}=e;if(!t)return _("div",{children:"Loading labels..."});let i;e.allowed_label_ids&&(i=new Set(e.allowed_label_ids),n.forEach(s=>i==null?void 0:i.add(s)));const o=li({allowed_wcomponent_ids:i,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _(Ui,{placeholder:"Add Label",selected_option_ids:n,options:o,allow_none:!0,on_change:s=>{e.on_change(s.filter(r=>!!r))},on_mouse_over_option:s=>e.set_highlighted_wcomponent({id:s,highlighted:!0}),on_mouse_leave_option:s=>e.set_highlighted_wcomponent({id:s,highlighted:!1}),editing_allowed:e.editing_allowed})}const Wo=BD(UD),WD=e=>{var i;const{wc_label_ids:t,wc_types:n}=((i=e.derived.current_composed_knowledge_view)==null?void 0:i.available_filter_options)||{};return{wc_label_ids:t,wc_types:n,apply_filter:e.filter_context.apply_filter,filters:e.filter_context.filters,is_on_actions_list_view:mw(e)}},HD={set_apply_filter:S.filter_context.set_apply_filter,set_filters:S.filter_context.set_filters},GD=j(WD,HD);function KD(e){const{wc_label_ids:t,wc_types:n,filters:i}=e,o=G(()=>[...n||[]].concat(i.exclude_by_component_types).map(a=>({id:a,title:Bi(a)})),[n,i]),s=G(()=>[...n||[]].concat(i.include_by_component_types).map(a=>({id:a,title:Bi(a)})),[n,i]);return _("div",{children:[_("p",{children:["Enabled: ",_(nt,{value:e.apply_filter,on_change:()=>e.set_apply_filter(!e.apply_filter)})]}),_("p",{children:["Filter by label:",_(Wo,{allowed_label_ids:t,label_ids:e.filters.include_by_label_ids,on_change:r=>{e.set_filters({filters:{...e.filters,include_by_label_ids:r}})},editing_allowed:!0})]}),_("p",{children:["Exclude by label:",_(Wo,{allowed_label_ids:t,label_ids:e.filters.exclude_by_label_ids,on_change:r=>{e.set_filters({filters:{...e.filters,exclude_by_label_ids:r}})},editing_allowed:!0})]}),_("p",{children:["Filter by component type:",_(Ui,{placeholder:"",selected_option_ids:e.filters.include_by_component_types,options:s,allow_none:!0,on_change:r=>{e.set_filters({filters:{...e.filters,include_by_component_types:r}})},editing_allowed:!0})]}),_("p",{children:["Exclude by component type:",_(Ui,{placeholder:"",selected_option_ids:e.filters.exclude_by_component_types,options:o,allow_none:!0,on_change:r=>{e.set_filters({filters:{...e.filters,exclude_by_component_types:r}})},editing_allowed:!0})]}),e.is_on_actions_list_view&&_(ue,{children:[_("br",{}),_("hr",{}),_("h3",{children:"Actions list filters"}),_("p",{children:["Filter by current knowledge view: ",_(nt,{value:e.filters.filter_by_current_knowledge_view,on_change:()=>{const r={...e.filters,filter_by_current_knowledge_view:!e.filters.filter_by_current_knowledge_view};e.set_filters({filters:r})}})]}),_("p",{children:["Filter by text: ",_(be,{size:"small",placeholder:"",editing_allowed:!0,value:e.filters.filter_by_text,on_blur:r=>{const a={...e.filters,filter_by_text:r.trim()};e.set_filters({filters:a})},on_blur_type:K.conditional})]})]})]})}const YD=GD(KD),JD=["priority","normal","hidden","archived"];function ti(){return _("div",{className:"external_link_icon"})}const XD=e=>({bases_by_id:e.user_info.bases_by_id,chosen_base_id:e.user_info.chosen_base_id}),ZD=j(XD);function QD(e){const t=e.base_id_to_move_to===void 0?void 0:`${e.base_id_to_move_to}`,n=Object.values(e.bases_by_id||{}).filter(i=>i.id!==e.chosen_base_id&&i.can_edit).map(i=>({id:`${i.id}`,title:i.title}));return _("div",{children:_(Pe,{selected_option_id:t,allow_none:!0,options:n,on_change:i=>{const o=i===void 0?void 0:parseInt(i);e.on_change(o)}})})}const eM=ZD(QD),tM=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),nM=j(tM);function iM(e){const{wcomponents_move_conflicts:t,wcomponents_by_id:n,knowledge_views_by_id:i}=e,o=new Date().getTime(),s=o;return _("div",{children:Object.entries(t||{}).map(([r,a],c)=>{const l=n[r],d=l&&at({wcomponent:l,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:void 0,created_at_ms:o,sim_ms:s})||r;return _("div",{children:[_(Je,{route:"wcomponents",sub_route:void 0,item_id:r,args:void 0,children:['Component "',_(io,{children:d}),'" in:']}),_("ul",{children:a.map(p=>{const f=i[p.kv_id],m=(f==null?void 0:f.title)||p.kv_id,h=Oo(p,!0);return _("li",{children:_(Je,{route:"wcomponents",sub_route:void 0,item_id:r,args:{subview_id:p.kv_id,...h},children:["    ",m]})})})})]},r)})})}const oM=nM(iM),sM=e=>({nested_knowledge_view_ids_map:e.derived.nested_knowledge_view_ids.map,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,chosen_base_id:e.user_info.chosen_base_id}),rM=j(sM);function _M(e){const{knowledge_view:t,nested_knowledge_view_ids_map:n,knowledge_views_by_id:i,wcomponents_by_id:o,chosen_base_id:s}=e,[r,a]=I(new Set),[c,l]=I(void 0),[d,p]=I(void 0),[f,m]=I(void 0);if(s===void 0)return _("div",{children:[_("h4",{children:"Change project of knowledge view"}),"Need to select a project first"]});if(!c)return _("div",{children:[_("h4",{children:"Change project of knowledge view"}),_(F,{value:"Check if safe to move",onClick:()=>{const{kv_ids_to_move:g,wc_ids_to_move:b,wcomponents_move_conflicts:w}=Hw({root_knowledge_view_id_to_move:t.id,nested_knowledge_view_ids_map:n,knowledge_views_by_id:i,wcomponents_by_id:o});a(Bn(g,b)),l(w)}})]});const h=Object.keys(c).length,v=r.size+h;return _("div",{children:[_("h4",{children:"Change project of knowledge view"}),h>0&&_("p",{children:["All the nested knowledge views and their components will be moved however there are other knowledge views which are not nested under this knowledge view and that contain ",_("span",{style:{color:"darkred"},children:[h," components"]})," that are also in this knowledge view.  These knowledge views and their components can be moved to the new project or left assigned to this project."]}),h>0&&_("p",{children:[_("i",{children:_("b",{children:[h," component(s) also present in other knowledge views:"]})}),_(oM,{wcomponents_move_conflicts:c})]}),h===0&&_("p",{children:[_("i",{children:_("b",{children:"Safe to move!"})}),"   All of the knowledge views and components in and nested under this knowledge view are contained in this knowledge view.  None of them are present in any other knowledge views that are not nested under this knowledge view."]}),_("p",{children:[_("i",{children:_("b",{children:"Step 2 of 3: Select project to move to"})}),_(eM,{base_id_to_move_to:d,on_change:g=>p(g)})]}),d!==void 0&&_("div",{children:[r.size!==v&&_(Li,{disabled:v===0,button_text:`Move all ${v} components to new project (including conflicted components)`,on_click:()=>{const g=Array.from(r).concat(Object.keys(c));Nh(g,s,d,m)}}),_(Li,{disabled:r.size===0,button_text:`Only move ${r.size} components to new project, leaving conflicted components in this project.`,on_click:()=>{const g=Array.from(r);Nh(g,s,d,m)}})]}),f&&_("p",{children:[f.error&&_("div",{style:{backgroundColor:"pink"},children:["Got error whilst trying to change project id of components ",_("br",{}),_("pre",{children:JSON.stringify(f.error,null,2)})]}),f.data&&_("div",{style:{backgroundColor:"lightgreen"},children:["Successfully changed project id of ",f.data," components & knowledge views.  Reloading page in ",Xy," seconds"]})]})]})}const aM=rM(_M),Xy=2;async function Nh(e,t,n,i){const s=await ke().rpc("move_ids_to_new_base",{ids:e,from_base_id:t,to_base_id:n});i(s),s.error||(en.debug("Reloading page after moving ids to new project"),setTimeout(()=>document.location.reload(),Xy*1e3))}const cM=e=>({knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids_map:e.derived.nested_knowledge_view_ids.map}),lM=j(cM);function dM(e){const{placeholder:t,selected_option_id:n=void 0,allowed_ids:i,exclude_ids:o=new Set,on_change:s,knowledge_views:r,nested_knowledge_view_ids_map:a}=e,c=G(()=>uM(r,i,o).map(({id:d,title:p})=>{let f="",m=a[d];for(;m;)f=" / "+m.title+f,m=a[m.parent_id||""];return{id:d,title:p,subtitle:f}}).sort((d,p)=>d.title<p.title?-1:1),[r,i,o,a]);return _(Pe,{placeholder:t||"Select knowledge view...",allow_none:!0,selected_option_id:n,options:c,on_change:s,editing_allowed:e.editing_allowed})}const oo=lM(dM);function uM(e,t,n){let i=e;return t&&(i=i.filter(({id:o})=>t.has(o))),n.size&&(i=i.filter(({id:o})=>!n.has(o))),i}const pM=e=>({knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,editing:!e.display_options.consumption_formatting}),mM={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},fM=j(pM,mM);function hM(e){const{owner_knowledge_view:t,knowledge_views_by_id:n,on_change:i,editing:o}=e,s=t.foundation_knowledge_view_ids||[],r=new Set(s),a=[],c=[];s.forEach(m=>{const h=n[m];h?a.push(h):c.push(m)}),c.length&&console.warn(`Did not find foundational knowledge view ids: ${c.join(", ")}`);const l=new Set(r);l.add(t.id);const d=a.length,{parent_knowledge_view_id:p}=t,f=!!a.find(m=>m.id===p);return _("div",{children:[(o||a.length>0)&&"Foundational Views",o&&_("span",{children:["(",d,")"]}),o&&_(oo,{placeholder:"Search for knowledge view to add...",exclude_ids:l,on_change:m=>{m&&i([m,...s])}}),o&&p&&!f&&_(F,{value:"Use parent view as foundation",onClick:()=>i([p,...s])}),a.map((m,h)=>_("div",{style:{display:"flex",flexDirection:"row"},children:[_("div",{style:{flex:"1"},children:d-h}),_("div",{style:{flex:"9"},children:m.title}),_("div",{style:{flex:"3"},children:o&&_(F,{value:"remove",onClick:()=>{i(wl(s,v=>v===m.id))}})})]},m.id)),c.length>0&&_("div",{children:["Could not find ",c.length," knowledge views"]})]})}const vM=fM(hM),gM=(e,t)=>{const n=Kn(e,t.knowledge_view_id),{wcomponents_by_id:i,knowledge_views_by_id:o}=e.specialised_objects;return{knowledge_view:n,wcomponents_by_id:i,knowledge_views_by_id:o,editing:!e.display_options.consumption_formatting,is_current_kv:e.routing.args.subview_id===t.knowledge_view_id}},wM=j(gM);function bM(e){const{editing:t,knowledge_view:n,wcomponents_by_id:i,knowledge_views_by_id:o,on_change:s}=e,[r,a]=I(e.is_current_kv||e.show_automatically||!1);if(!n)return _("div",{});if(!r)return _(F,{value:"Calculate active assumptions",onClick:()=>a(!0)});const c=n.active_counterfactual_v2_ids||[],l=kt(n,o,!0),d=G(()=>{const p=st(l,i).composed_wc_id_map;return Object.keys(p).map(m=>i[m]).filter(ge).filter(({type:m})=>m==="counterfactualv2").map(m=>({id:m.id,title:at({wcomponent:m,text_type:pe.plain,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:void 0,created_at_ms:Ph,sim_ms:Ph})}))},[i,...l]);if(t){if(d.length===0)return _("div",{children:"No counterfactuals in composed knowledge view (includes foundational knowledge views)"})}else if(c.length===0)return _("div",{children:"No assumptions set"});return _("div",{children:_(Ui,{placeholder:"...",allow_none:!0,selected_option_ids:c,options:d,on_change:s})})}const yM=wM(bM),Ph=new Date().getTime()+1e11,kM=e=>{if(!Ot.get_state().enable_align_components_on_x_by_time)return null;const{editing:n,knowledge_view:i}=e,o=kt(i,e.knowledge_views_by_id,!1),s=uw(o,!1),{datetime_line_config:r={}}=i,a=r.time_origin_ms??s.time_origin_ms,c=m=>{const h={...r,...m};e.update_item({...i,datetime_line_config:h})};if(a===void 0)return n?_("div",{children:[_("h4",{children:"Configure X Axis Datetime"}),_("p",{children:_(xt,{title:"Time origin",value:void 0,on_change:m=>{const h=m?m.getTime():void 0;c({time_origin_ms:h})}})})]}):null;const l=xo(r,s,"time_origin_x"),d=xo(r,s,"time_scale"),p=xo(r,s,"time_line_number"),f=xo(r,s,"time_line_spacing_days");return _("div",{children:[_("h4",{children:"Configure X Axis Datetime"}),_("p",{children:_(xt,{title:"Time origin",value:new Date(a),on_change:m=>{const h=m?m.getTime():void 0;c({time_origin_ms:h})}})}),_("p",{children:[_(rt,{placeholder:"Time origin position",value:l.value,allow_undefined:!0,on_blur:m=>{c({time_origin_x:m})},on_blur_type:K.conditional,style:{width:"70%"}}),n&&_(So,{source:l.source})]}),_("p",{children:[_(rt,{placeholder:"Time scale",value:d.value,allow_undefined:!0,on_blur:m=>{c({time_scale:m})},on_blur_type:K.conditional,style:{width:"70%"}}),n&&_(So,{source:d.source})]}),_("p",{children:[_(rt,{placeholder:"Time line number",value:p.value,allow_undefined:!0,on_blur:m=>{c({time_line_number:m})},on_blur_type:K.conditional,style:{width:"70%"}}),n&&_(So,{source:p.source})]}),_("p",{children:[_(rt,{placeholder:"Days between time line",value:f.value,allow_undefined:!0,on_blur:m=>{c({time_line_spacing_days:m})},on_blur_type:K.conditional,style:{width:"70%"}}),n&&_(So,{source:f.source})]}),n&&_("p",{children:_(F,{value:"Clear (to inherited or default to month)",fullWidth:!0,onClick:()=>{c({time_scale:void 0,time_line_number:void 0,time_line_spacing_days:void 0})}})}),n&&_("p",{style:{display:"flex",flexDirection:"row",justifyContent:"space-evenly",alignItems:"center"},children:[_("div",{children:"Defaults:"}),"  ",_(F,{value:"Week",fullWidth:!1,onClick:()=>{c({time_scale:3,time_line_number:8,time_line_spacing_days:7})}})," ",_(F,{value:"Month",fullWidth:!1,onClick:()=>{c({time_scale:Pi.time_scale,time_line_number:Pi.time_line_number,time_line_spacing_days:Pi.time_line_spacing_days})}})," ",_(F,{value:"Year",fullWidth:!1,onClick:()=>{c({time_scale:.3,time_line_number:2,time_line_spacing_days:365})}})]})]})};function xo(e,t,n){const i=e[n]??t[n]??Pi[n],o=i===e[n]?0:i===t[n]?1:2;return{value:i,source:o}}function So(e){if(e.source===0)return null;const t=e.source===1?"Inherited from foundation":"Default";return _("div",{style:{color:"grey",fontSize:11},title:t,children:e.source===1?"(Inherited)":"(Default)"})}function Zy(e){const{items_descriptor:t,on_click_header:n,other_content:i=()=>null}=e;return _("div",{onClick:o=>{o.stopImmediatePropagation(),n&&n()},style:{cursor:n?"pointer":"default"},title:e.items_descriptor_title,children:[i(),_("div",{className:"item_descriptors",children:t}),_("div",{style:{clear:"both"}})]})}var Qy=(e=>(e[e.collapsed=0]="collapsed",e[e.partial_expansion=1]="partial_expansion",e[e.expanded=2]="expanded",e))(Qy||{});const xM=e=>({editing:!e.display_options.consumption_formatting}),SM=j(xM);function AM(e){const t=e.expanded_initial_state||(e.disable_collapsed?e.disable_partial_collapsed?2:1:0),[n,i]=I(t),o=n===2,{header_content:s=()=>null,content:r,items_count:a,item_descriptor:c,items_descriptor:l=kd(c,a,e.editing),items_descriptor_title:d,disable_partial_collapsed:p=!1}=e;function f(){let m=(n+1)%3;e.disable_collapsed&&m===0&&++m,p&&m===1&&++m,i(m)}return _("div",{children:[_(Zy,{items_descriptor:l,items_descriptor_title:d,on_click_header:f,other_content:s}),r({disable_partial_collapsed:p,expanded_items:n>0,expanded_item_rows:o})]})}const Mi=SM(AM);function kd(e,t,n=!0){return(n||t!==void 0&&t!==0)&&(e+=` (${t})`),e}function xd(e){const{new_item_descriptor:t,on_pointer_down_new_list_entry:n}=e;return _("div",{children:_(F,{fullWidth:!0,onClick:i=>{i.stopImmediatePropagation(),n()},children:`New ${t}`})})}const $M=e=>({consumption_formatting:e.display_options.consumption_formatting}),CM=j($M);function TM(e){const{items_count:t,item_descriptor:n,new_item_descriptor:i=n,consumption_formatting:o}=e;return _(Mi,{header_content:()=>o?null:_(xd,{new_item_descriptor:i,on_pointer_down_new_list_entry:e.on_click_new_item}),content:e.content,items_count:t,items_descriptor:e.items_descriptor,item_descriptor:n,disable_collapsed:e.disable_collapsed,disable_partial_collapsed:e.disable_partial_collapsed,expanded_initial_state:e.expanded_initial_state})}const e0=CM(TM);var Sd={},EM=ee;Object.defineProperty(Sd,"__esModule",{value:!0});var Ad=Sd.default=void 0,jM=EM(Q()),NM=te(),PM=(0,jM.default)((0,NM.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}),"Delete");Ad=Sd.default=PM;const IM=e=>({consumption_formatting:e.display_options.consumption_formatting}),RM=j(IM);function DM(e){return e.consumption_formatting?null:_(Li,{disabled:e.disabled,on_click:e.on_delete,button_text:e.button_text??"Delete",button_icon:_(Ad,{}),tooltip_text:e.tooltip_text})}const bn=RM(DM);class $d extends Xh{constructor(t){super(t);const{calc_initial_custom_expansion_state:n}=t,i=n&&n(t.item),o=i!==void 0?i:!!t.expanded;this.state={internal__expanded:o}}componentDidUpdate(t,n){this.props.expanded!==t.expanded&&this.setState({internal__expanded:!!this.props.expanded})}render(){const{item:t,get_created_at:n,get_custom_created_at:i,set_custom_created_at:o=($,C)=>({...$,custom_created_at:C}),get_summary:s,get_details:r,get_details2:a,get_details3:c,crud:l,delete_button_text:d,hide_expansion_button:p}=this.props,{update_item:f,delete_item:m}=l,h=i?i(t):void 0,{internal__expanded:v}=this.state,g=v?"expanded":"",b=this.props.extra_class_names||"",w=`editable_list_entry ${g} ${b}`,x=G(()=>m&&(()=>m(t)),[m,t]),y=$=>{f(o(t,$))};return _("div",{className:w,children:[_("div",{className:"summary_header",children:[_("div",{className:"summary",children:s(t,l,v)}),!(p&&p(t))&&_("div",{className:"expansion_button",title:v?"Collapse":"Expand",onClick:()=>this.setState({internal__expanded:!v})})]}),v&&_(ue,{children:[r(t,l),_("div",{className:"details2",children:a&&a(t,l)}),_("div",{children:[x&&_(bn,{on_delete:x,button_text:d}),_("br",{}),(n||i)&&_(et,{children:_(xt,{title:"Created at",invariant_value:n&&n(t),value:h,on_change:y})})]}),_("div",{className:"details3",children:c&&c(t,l)})]})]})}}function Cd(e){const{items:t,get_id:n,item_props:i,debug_item_descriptor:o=""}=e;return r=>{const{expanded_items:a,expanded_item_rows:c}=r;return _("div",{style:{display:a?"":"none",cursor:"initial"},onClick:l=>l.stopPropagation(),children:t.map((l,d)=>_("div",{children:[_("hr",{className:"entries_horizontal_dividers"}),_($d,{item:l,...i,expanded:c})]},n(l)))})}}function gi(e){const{parent_knowledge_view_id:t,knowledge_views:n,sort_type:i}=e;if(!e.editing&&n.length===0)return null;const o=Cd({items:n,get_id:a=>a.id,item_props:{get_summary:MM(),get_details:o0(e),get_details3:OM,calc_initial_custom_expansion_state:VM(e),crud:{update_item:a=>{e.upsert_knowledge_view({knowledge_view:a})}}},debug_item_descriptor:"View"}),s=qM(e);if(i==="hidden"||i==="archived"||i==="errored")return _(Mi,{items_count:n.length,content:o,item_descriptor:wn(i)+" "+(e.item_descriptor||"View"),disable_collapsed:!1,expanded_initial_state:s});const r=(i==="priority"?"Priority ":"")+(e.item_descriptor||"View");return _(e0,{items_count:n.length,on_click_new_item:()=>{vS({knowledge_view:{title:i0(),parent_knowledge_view_id:t,sort_type:i}})},content:o,item_descriptor:r,disable_collapsed:!0,expanded_initial_state:s})}function MM(){const e="knowledge";return(t,n)=>_(Je,{route:void 0,sub_route:void 0,item_id:void 0,args:{view:e,subview_id:t.id},selected_on:new Set(["route","args.subview_id"]),children:t.title})}function OM(){return _("div",{children:[_("br",{}),_("br",{})]})}function qM(e){const{current_kv_parent_ids:t,knowledge_views:n,current_subview_id:i}=e;return!!n.find(({id:s})=>s===i||t.has(s))?Qy.partial_expansion:void 0}function VM(e){return t=>e.current_kv_parent_ids.has(t.id)?!0:void 0}function t0(e){const{priority:t,normal:n,hidden:i,archived:o,errored:s}=G(()=>{const r=[],a=[],c=[],l=[],d=[];return e.knowledge_views.forEach(p=>{const f=e.nested_knowledge_view_ids.map[p.id];(f==null?void 0:f.sort_type)==="errored"?d.push(p):p.sort_type==="hidden"?c.push(p):p.sort_type==="archived"?l.push(p):p.sort_type==="priority"?r.push(p):a.push(p)}),{priority:r,normal:a,hidden:c,archived:l,errored:d}},[e.knowledge_views]);return _("div",{children:[_("br",{}),_(gi,{...e,knowledge_views:t,sort_type:"priority"}),_("br",{}),_(gi,{...e,knowledge_views:n,sort_type:"normal"}),_("br",{}),_(gi,{...e,knowledge_views:i,sort_type:"hidden"}),_("br",{}),_(gi,{...e,knowledge_views:o,sort_type:"archived"}),_("br",{}),_(gi,{...e,knowledge_views:s,sort_type:"errored"})]})}function n0(e,t){const n=new Set;let i=e[t];for(;i&&i.parent_id;)n.add(i.parent_id),i=e[i.parent_id];return n}const i0=()=>Ko(!1),o0=e=>(t,n)=>{const{editing:i,nested_knowledge_view_ids:o}=e,s=o.map[t.id],r=((s==null?void 0:s.child_ids)||[]).map(h=>e.knowledge_views_by_id[h]).filter(ge),a=!!e.wcomponents_by_id[t.id||""],c=t.base_id!==e.chosen_base_id,l=(e.bases_by_id||{})[t.base_id],d=e.current_subview_id===t.id,p=G(()=>new Set(e.possible_parent_knowledge_view_ids),[e.possible_parent_knowledge_view_ids]);let f="";s!=null&&s.ERROR_is_circular&&(f="Is circularly nested"),s!=null&&s.ERROR_parent_kv_missing&&(f="Parent knowledge view is missing (may be present in a different project)");let m="";return s!=null&&s.ERROR_parent_from_diff_base&&(m="Parent knowledge view from a different project"),_("div",{style:{backgroundColor:"white",border:"thin solid #aaa",borderRadius:3,padding:5,margin:5},children:[c&&_("div",{style:{cursor:"pointer"},onClick:()=>e.update_chosen_base_id({base_id:t.base_id}),title:`Click to change to project ${t.base_id}`,children:[_(nn,{message:""}),'  Is part of project "',l==null?void 0:l.title,'"']}),_("div",{style:{display:"inline-flex"},children:[_(be,{placeholder:"Title",value:t.title,on_blur:h=>{const v=i0();n.update_item({...t,title:h||v})},on_blur_type:K.conditional}),a&&_(Je,{route:"wcomponents",sub_route:void 0,item_id:t.id,args:void 0,children:[_(ti,{}),"Component"]}),!a&&i&&_("span",{style:{cursor:"pointer"},onClick:()=>{ri({wcomponent:{base_id:t.base_id,id:t.id,title:t.title,type:"statev2"}})},children:[_(ti,{}),"Create Component"]})]}),(i||t.description)&&_("div",{children:[i&&_("span",{className:"description_label",children:"Description"}),"  ",_(ei,{placeholder:"...",value:t.description,on_blur:h=>{n.update_item({...t,description:h})},on_blur_type:K.conditional})]}),_("div",{children:[_("span",{className:"description_label",children:"Active assumptions (counterfactuals)"}),_(yM,{knowledge_view_id:t.id,on_change:h=>n.update_item({...t,active_counterfactual_v2_ids:h})})]}),_("div",{children:_(vM,{owner_knowledge_view:t,on_change:h=>{n.update_item({...t,foundation_knowledge_view_ids:h})}})}),(i||f||m)&&_("div",{children:[_("span",{className:"description_label",children:"Nest under"}),f&&_("div",{style:{backgroundColor:"pink"},children:[" ",f," "]}),m&&_("div",{children:[_(nn,{message:m})," ",m]}),_(oo,{selected_option_id:t.parent_knowledge_view_id,allowed_ids:p,on_change:h=>{n.update_item({...t,parent_knowledge_view_id:h})}})]}),i&&_("div",{children:[_("span",{className:"description_label",children:"Sort status"}),_(Pe,{selected_option_id:t.sort_type,options:JD.map(h=>({id:h,title:h})),allow_none:!1,on_change:h=>h&&n.update_item({...t,sort_type:h})})]}),_("hr",{}),i&&!d&&_("div",{children:[_(Je,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:t.id},children:"Change to this knowledge view"})," to edit datetime lines config and change the project."]}),i&&d&&_("div",{children:[_(kM,{editing:i,knowledge_view:t,knowledge_views_by_id:e.knowledge_views_by_id,update_item:n.update_item}),_("hr",{}),_(aM,{knowledge_view:t}),_("hr",{}),_("br",{})]}),(i||r.length>0)&&_("div",{children:_(t0,{...e,parent_knowledge_view_id:t.id,knowledge_views:r,item_descriptor:"Nested"})}),_("br",{})]})},FM=e=>{const t=qe(e);return{ready_for_reading:e.sync.ready_for_reading,knowledge_view:t,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids:e.derived.nested_knowledge_view_ids,editing:!e.display_options.consumption_formatting,current_view:e.routing.args.view,current_subview_id:e.routing.args.subview_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}},zM={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view,update_chosen_base_id:S.user_info.update_chosen_base_id},LM=j(FM,zM);function BM(e){const{knowledge_view:t,upsert_knowledge_view:n}=e;if(!e.ready_for_reading)return _("div",{children:"Loading..."});if(!t)return _("div",{children:"No knowledge view selected"});const i=G(()=>e.knowledge_views.filter(a=>a.base_id===e.chosen_base_id).map(a=>a.id),[e.knowledge_views]),o=n0(e.nested_knowledge_view_ids.map,e.current_subview_id),r={create_item:()=>{throw new Error("Not implemented create knowledge view")},update_item:a=>n({knowledge_view:a}),delete_item:()=>{throw new Error("Not implemented delete knowledge view")}};return o0({...e,possible_parent_knowledge_view_ids:i,current_kv_parent_ids:o,chosen_base_id:e.chosen_base_id,bases_by_id:e.bases_by_id,update_chosen_base_id:e.update_chosen_base_id})(t,r)}const UM=LM(BM),WM=e=>({ready:e.sync.ready_for_reading,knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids:e.derived.nested_knowledge_view_ids,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,current_view:e.routing.args.view,current_subview_id:e.routing.args.subview_id,editing:!e.display_options.consumption_formatting,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}),HM={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view,update_chosen_base_id:S.user_info.update_chosen_base_id},GM=j(WM,HM);function KM(e){if(e.knowledge_views.length===0)return _("div",{style:{cursor:"progress"},children:e.ready?"Automatically creating a knowledge view...":"Loading..."});const t=G(()=>e.knowledge_views.filter(o=>o.base_id===e.chosen_base_id).map(o=>o.id),[e.knowledge_views]),n=e.nested_knowledge_view_ids.top_ids.map(o=>e.knowledge_views_by_id[o]).filter(ge),i=n0(e.nested_knowledge_view_ids.map,e.current_subview_id);return _(t0,{...e,parent_knowledge_view_id:void 0,knowledge_views:n,possible_parent_knowledge_view_ids:t,upsert_knowledge_view:e.upsert_knowledge_view,current_kv_parent_ids:i,chosen_base_id:e.chosen_base_id,bases_by_id:e.bases_by_id,update_chosen_base_id:e.update_chosen_base_id})}const YM=GM(KM);function JM(e){return _(R,{p:1,pt:5,class:"views_side_panel",children:["Current View:",_(UM,{}),_("br",{}),_("br",{}),_("br",{}),_("br",{}),_("br",{}),_(YM,{})]})}const XM={change_route:S.routing.change_route},ZM=j(null,XM);function QM(e){return _(sy,{on_change:t=>{t&&e.change_route({route:"wcomponents",item_id:t})},on_blur:()=>{e.change_route({route:"wcomponents"})}})}const eO=ZM(QM);function tO(){const e=ye();return _("div",{className:"side_panel",children:[_("p",{className:"section",children:[_(F,{value:"Expand towards causes (backwards)",fullWidth:!0,onClick:()=>ew(e)}),_(yt,{...se.expand_select_backwards})]}),_("p",{className:"section",children:[_(F,{value:"Expand towards effects (forwards)",fullWidth:!0,onClick:()=>Qg(e)}),_(yt,{...se.expand_select_forwards})]}),_("p",{className:"section",children:[_(F,{value:"Select all components",fullWidth:!0,onClick:()=>vl(e)}),_(yt,{...se.select_all})]}),_("p",{className:"section",children:[_(F,{value:"Expand selection (in all directions)",fullWidth:!0,onClick:()=>Xg(e)}),_(yt,{...se.expand_select})]}),_("p",{className:"section",children:[_(F,{value:"Contract selection (in all directions)",fullWidth:!0,onClick:()=>Zg(e)}),_(yt,{...se.decrease_select})]}),_("p",{className:"section",children:[_(F,{value:"Select components inbetween",fullWidth:!0,onClick:()=>nw(e)}),_(yt,{...se.select_interconnections}),_("div",{className:"description",children:"Only selects the immediate components inbetween.  e.g. if A ---B--> C ---D--> E, then selecting nodes A and C followed by this command will also select connection B.  But if only node A and node E are selected, then this command will not do anything."})]})]})}const Ih=()=>({r:255,g:255,b:255,a:1});function s0(e){const[t,n]=I(e.color||Ih());oe(()=>{n(e.color||Ih())},[$t(e.color)]);const i=s=>{const r=Rh(t,s);n(r)},o=s=>{const r=Rh(t,s);Dh(t,r)&&n(r),Dh(e.color,r)&&e.conditional_on_blur(r)};return _("div",{className:"color_picker",children:[_(rt,{placeholder:"r",value:t.r,allow_undefined:!1,conditional_on_change:s=>i({r:s}),on_blur:s=>o({r:s}),on_blur_type:K.always,style:{width:65}}),"  ",_(rt,{placeholder:"g",value:t.g,allow_undefined:!1,conditional_on_change:s=>i({g:s}),on_blur:s=>o({g:s}),on_blur_type:K.always,style:{width:65}}),"  ",_(rt,{placeholder:"b",value:t.b,allow_undefined:!1,conditional_on_change:s=>i({b:s}),on_blur:s=>o({b:s}),on_blur_type:K.always,style:{width:65}}),"  ",_(rt,{placeholder:"a",value:t.a,allow_undefined:!1,conditional_on_change:s=>i({a:s}),on_blur:s=>o({a:s}),on_blur_type:K.always,style:{width:65}}),"  ",_("div",{className:"color_swatch",style:{backgroundColor:$t(t)}})]})}function Rh(e,t){const n={...e,...t};return nO(n)}function nO(e){let{r:t,g:n,b:i,a:o}=e;return t=Le(t,0,255),n=Le(n,0,255),i=Le(i,0,255),o=Le(o,0,1),{r:t,g:n,b:i,a:o}}function Dh(e,t){return e?$t(e)!==$t(t):!0}const iO=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),oO={change_route:S.routing.change_route},sO=j(iO,oO);function rO(e){const{wcomponent_id:t,wcomponents_by_id:n,knowledge_views_by_id:i}=e,[o,s]=I(!1),[r,a]=I([]);if(oe(()=>{let d=[];o&&(d=Object.values(n).filter(p=>Jo(p)).filter(p=>p.title.includes(t)||p.description.includes(t)||(p.label_ids||[]).includes(t)||ot(p)&&(p.parent_goal_or_action_ids||[]).includes(t)||ni(p)&&p.values_and_prediction_sets.find(f=>f.entries.find(m=>(m.explanation||"").includes(t)))||Ne(p)&&(p.from_id===t||p.to_id===t)||pt(p)&&p.attribute_wcomponent_id===t).filter(p=>p.id!==t)),a(d)},[t,n,o]),!o)return _("div",{children:_(F,{value:"Find back references",onClick:()=>s(!0)})});if(r.length===0)return _("div",{children:"No back references found in this project.  (Searching over all public and private projects not implemented yet.)"});const c=new Date().getTime(),l=c;return _("div",{children:["Back references:",r.map(d=>_("div",{children:_(Je,{route:void 0,sub_route:void 0,item_id:d.id,args:void 0,children:_(io,{children:at({wcomponent:d,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:void 0,created_at_ms:c,sim_ms:l})||`No title for component ${d.id}`})})}))]})}const _O=sO(rO),aO=e=>{const t=le(e),n=qe(e),i=t==null?void 0:t.composed_datetime_line_config;return{kv:n,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,created_at_ms:e.routing.args.created_at_ms,time_origin_ms:i==null?void 0:i.time_origin_ms,time_origin_x:i==null?void 0:i.time_origin_x,time_scale:i==null?void 0:i.time_scale}},cO={upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},lO=j(aO,cO);function dO(e){const[t,n]=I(void 0),{kv:i,wcomponent_id:o,wcomponents_by_id:s,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l,upsert_knowledge_view:d}=e,p=(o?[o]:e.wcomponent_ids)||[],{id:f,wc_id_map:m}=i||{},h=!i||!f||m===void 0||a===void 0||c===void 0||l===void 0||!!o&&gl({wcomponent_id:o,wcomponents_by_id:s,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l})===void 0,v=h?a===void 0?"Disabled as time origin not set":c===void 0?"Disabled as time origin X position is not set":"Diabled":"";let g="";return t!==void 0&&(t?p.length>1&&(g=`Changed ${t}`):g="No changes"),_("div",{style:{display:"inline-block"},children:[_(F,{disabled:h,value:"X by time",title:v,onClick:()=>{if(h)return;const{number_changed:b,knowledge_view:w}=pO({wcomponent_ids:p,wcomponents_by_id:s,kv:i,wc_id_map:m,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l});b&&w&&d({knowledge_view:w}),n(b),setTimeout(()=>n(void 0),1e3)}}),g]})}const uO=lO(dO);function pO(e){const{wcomponent_ids:t,wcomponents_by_id:n,kv:i,wc_id_map:o,created_at_ms:s,time_origin_ms:r,time_origin_x:a,time_scale:c}=e;let l=0;if(!i||!o||r===void 0||a===void 0||c===void 0)return{number_changed:l,knowledge_view:void 0};const d={...o};t.forEach(f=>{const m=o[f];if(!m)return;const h=gl({wcomponent_id:f,wcomponents_by_id:n,created_at_ms:s,time_origin_ms:r,time_origin_x:a,time_scale:c});if(h===void 0)return;const v={...m,left:h};d[f]=v,l+=1});const p=l?{...i,wc_id_map:d}:void 0;return{number_changed:l,knowledge_view:p}}const mO=(e,t)=>{const n=qe(e),i=n==null?void 0:n.id,o=t.wcomponent_ids||[t.wcomponent_id],s=!!o.find(a=>e.derived.wcomponent_ids_by_type.any_node.has(a)),r=!!o.find(a=>e.derived.wcomponent_ids_by_type.any_link.has(a));return{knowledge_view_id:i,kv:n,wcomponent_node_present:s,wcomponent_link_present:r}},fO={snap_to_grid_knowledge_view_entries:S.specialised_object.snap_to_grid_knowledge_view_entries,bulk_add_to_knowledge_view:S.specialised_object.bulk_add_to_knowledge_view,bulk_update_knowledge_view_entries:S.specialised_object.bulk_update_knowledge_view_entries,change_current_knowledge_view_entries_order:S.specialised_object.change_current_knowledge_view_entries_order},hO=j(mO,fO);function vO(e){const{wcomponent_id:t,knowledge_view_id:n,kv:i}=e,o=e.wcomponent_ids||[e.wcomponent_id],s=i&&t?Object.keys(i.wc_id_map).findIndex(l=>l===t):void 0,r=i?Object.keys(i.wc_id_map).length:void 0,a=s!==void 0&&s+1===r,c=s===0;return _("div",{children:[_("h3",{children:"Align"}),e.wcomponent_node_present&&_(ue,{children:[_(F,{disabled:!n,value:"Snap to grid",onClick:()=>{n&&e.snap_to_grid_knowledge_view_entries({wcomponent_ids:o,knowledge_view_id:n})}}),Ot.get_state().enable_align_components_on_x_by_time&&_(ue,{children:[" ",_(uO,{...e})]})," ",_(F,{disabled:!n,value:"Bring here",onClick:()=>{if(!n)return;const l=ye().getState(),d=si(l);e.bulk_add_to_knowledge_view({knowledge_view_id:n,wcomponent_ids:o,override_entry:d})}})]}),e.wcomponent_node_present&&e.wcomponent_link_present&&_("br",{}),e.wcomponent_link_present&&_(ue,{children:_(F,{disabled:!n,value:"Manually update link location",onClick:()=>{if(!n)return;const l=ye().getState(),d=gO(o,l);d&&e.bulk_update_knowledge_view_entries({knowledge_view_id:n,changes:d})}})}),_("br",{}),_("span",{title:a?"Already at front":"Move to front",children:_(F,{value:"Move to front",disabled:a,onClick:()=>{e.change_current_knowledge_view_entries_order({wcomponent_ids:o,order:"front"})}})})," ",_("span",{title:c?"Already at back":"Move to back",children:_(F,{value:"Move to back",disabled:c,onClick:()=>{e.change_current_knowledge_view_entries_order({wcomponent_ids:o,order:"back"})}})})]})}const r0=hO(vO);function gO(e,t){const n=t.derived.current_composed_knowledge_view;if(n)return e.map(i=>Me(t,i)).filter(Ne).map(i=>{const o=Me(t,i.from_id),s=Me(t,i.to_id),r=Ky({wcomponent:i,from_wc:o,to_wc:s,current_composed_knowledge_view:n}),a=Ie({...r,end_size:1,line_behaviour:i.line_behaviour,circular_links:!0,connection_end_type:Ft.positive});if(!a)return;const c=s7({point1:{x:a.line_start_x,y:a.line_start_y},relative_control_point1:a.relative_control_point1,relative_control_point2:a.relative_control_point2,point2:{x:a.line_end_x,y:a.line_end_y}});return{wcomponent_id:i.id,left:c.x,top:-c.y}}).filter(i=>!!i)}const wO=(e,t)=>{const{wcomponent_id:n}=t,i=qe(e),o=i&&i.wc_id_map[n],s=e.derived.knowledge_views;return{knowledge_view_id:i&&i.id,knowledge_view_entry:o,all_knowledge_views:s}},bO=j(wO);function yO(e){const{knowledge_view_id:t,wcomponent_id:n,knowledge_view_entry:i}=e,o=e.all_knowledge_views.filter(({id:r})=>r!==t).filter(({wc_id_map:r})=>{const a=r[n];return a&&!a.blocked&&!a.passthrough});if(o.length===0)return null;const s=!i||i.blocked||i.passthrough;return _("div",{children:[s?"Present":"Also"," in:",o.map(r=>{const a=r.wc_id_map[e.wcomponent_id],c=Oo(a,!0);return _("div",{children:_(Je,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:r.id,...c},children:r.title})})})]})}const _0=bO(yO),kO=(e,t)=>{const{wcomponent_id:n}=t,i=qe(e),o=i&&i.wc_id_map[n],s=le(e),r=s&&s.composed_wc_id_map[n],a=si(e);return{knowledge_view:i,composed_knowledge_view_entry:r,knowledge_view_entry:o,middle_position_left:a.left,middle_position_top:a.top,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id}},xO={upsert_knowledge_view_entry:S.specialised_object.upsert_knowledge_view_entry,bulk_remove_from_knowledge_view:S.specialised_object.bulk_remove_from_knowledge_view},SO=j(kO,xO);function AO(e){const{wcomponent_id:t,knowledge_view:n,composed_knowledge_view_entry:i,knowledge_view_entry:o,editing_allowed:s,knowledge_views_by_id:r,wcomponents_by_id:a}=e;if(!n)return null;const c=kt(n,r,!0),l=st(c,a),d=kt(n,r,!1),p=st(d,a),f=Bc({editing_allowed:s,wcomponent_id:t,knowledge_view:n,composed_wc_id_maps_object:l,foundation_composed_wc_id_map:p.composed_wc_id_map}),{show_wcomponent_status_in_this_kv_section:m,wcomponent_status_in_this_kv_text:h,show_add_button:v,add_button_text:g,show_remove_button:b,remove_button_text:w,remove_button_tooltip:x,show_remove_and_block_button:y,remove_and_block_button_text:$,remove_and_block_button_tooltip:C}=f;function E(A,M={}){const D={...i||{left:e.middle_position_left,top:e.middle_position_top},...M};e.upsert_knowledge_view_entry({wcomponent_id:t,knowledge_view_id:A,entry:D})}const N=(o==null?void 0:o.frame_width)!==void 0&&o.frame_height!==void 0;return _("div",{children:[s&&o&&!o.blocked&&_(et,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(Wn,{component:"legend",children:"Size"}),_(Wh,{color:"secondary",defaultValue:1,marks:!0,min:.25,max:2,onChange:(A,M)=>{const D=Array.isArray(M)?M[0]:M;E(n.id,{s:D})},step:.25,value:o.s?o.s:1,valueLabelDisplay:"on"})]}),s&&o&&!o.blocked&&_(et,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(Wn,{component:"legend",children:"Frame"}),_("div",{children:_(F,{value:N?"Remove Frame":"Add Frame",onClick:()=>{const A={};N?(A.frame_color=void 0,A.frame_width=void 0,A.frame_height=void 0):(A.frame_color=A.frame_color??Hc,A.frame_width=A.frame_width??(Jn+tt)*2,A.frame_height=A.frame_height??(vn+tt)*2),E(n.id,A)}})}),N&&_(ue,{children:[_("span",{className:"description_label",children:"Frame Color"}),_(s0,{color:o.frame_color,conditional_on_blur:A=>{E(n.id,{frame_color:A})}})]})]}),s&&_("div",{children:[_(r0,{wcomponent_id:t}),_("br",{})]}),_("div",{style:{display:"inline-flex"},children:[_(by,{wcomponent_id:t,disable_if_not_present:!0}),_(R,{zIndex:10,m:4,class:"node_handle",children:_(gd,{wcomponent_id:t,wcomponent_current_kv_entry:i,is_highlighted:!0})})]}),m&&_("div",{children:[h,_("br",{}),v&&_(F,{value:g,onClick:()=>E(n.id,{blocked:void 0,passthrough:void 0})})]}),b&&_("div",{children:_(bn,{button_text:w,tooltip_text:x,on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"passthrough"})}})}),y&&_("div",{children:_(bn,{button_text:$,tooltip_text:C,on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"block"})}})}),s&&_("div",{children:["Add to knowledge view",_(oo,{on_change:A=>{A&&E(A,{blocked:void 0,passthrough:void 0})}})]}),_("div",{children:_(_0,{wcomponent_id:t})}),_("div",{children:_(_O,{wcomponent_id:t})})]})}const a0=SO(AO),$O=(e,t)=>{const n=qe(e),i=n&&n.wc_id_map[t.wcomponent_id];return{knowledge_view_title:n&&n.title,knowledge_view_entry:i,editing:!e.display_options.consumption_formatting}},CO={bulk_remove_from_knowledge_view:S.specialised_object.bulk_remove_from_knowledge_view},TO=j($O,CO);function EO(e){const{wcomponent_id:t,knowledge_view_title:n,knowledge_view_entry:i,editing:o}=e;return _("div",{children:[_(a0,{wcomponent_id:t,editing_allowed:o}),o&&i&&!i.passthrough&&_("p",{children:_(bn,{button_text:"Delete from knowledge view",tooltip_text:"Delete from current knowledge view ("+n+")",on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"passthrough"})}})}),_("p",{children:_(_0,{wcomponent_id:t})})]})}const jO=TO(EO);function NO(e,t){const n=t.type!==void 0&&t.type!==e.type;return e={...e,...t},{wcomponent:e,different_type:n}}function PO(e){const{UI_value:t}=e,{values_string:n,counterfactual_applied:i,uncertain:o,derived__using_values_from_wcomponent_ids:s}=t,r=i||!!(s!=null&&s.length),a=`value ${r?"assumption":""} ${o?"uncertain":""}`;let c="Current value";return r&&(c+=" is an assumption"),r&&o&&(c+=" and"),o&&(c+=" has uncertainty"),_(ue,{children:[_(ze,{className:a,title:c,"aria-label":c,children:_("span",{children:n})}),(s||[]).map(l=>_(MO,{uuid:l}))]})}const IO=(e,t)=>{const{composed_wcomponents_by_id:n}=e.derived,i=n[t.uuid],o=ft(e),s=e.specialised_objects.knowledge_views_by_id;return{title:i&&at({wcomponent:i,text_type:pe.plain,wcomponents_by_id:n,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms})}},RO=j(IO);function DO(e){const{uuid:t,title:n}=e;let i="a different component";n!=null&&n.trim()&&(i=`'${Xt(n.trim())}'`);const o="Value derived from "+i;return _(Je,{route:void 0,sub_route:void 0,item_id:t,args:void 0,children:_(Ly,{className:"material-icons",title:o,style:{fill:By,height:"16px"}})},t)}const MO=RO(DO),OO={boolean:!0,number:!0,other:!0},qO=Object.keys(OO),c0=ul.map(e=>({id:e,title:Bi(e)})),VO=qO.map(e=>({id:e,title:e}));function FO(e){const{wcomponent:t}=e;return _(l0,{effect_string:t.effect_string,effect_when_true:t.effect_when_true,effect_when_false:t.effect_when_false,editing:e.editing,wcomponents_by_id:e.wcomponents_by_id,upsert_wcomponent:e.upsert_wcomponent})}function l0(e){const{effect_string:t,effect_when_true:n,effect_when_false:i,editing:o,wcomponents_by_id:s,upsert_wcomponent:r}=e,a=G(()=>{if(!t)return;const m=H([{id:-1,name:"",value:t}],s)[0],h=m==null?void 0:m.value;return h!==void 0&&r({effect_when_true:h}),m},[t]),c=o||t!==void 0,l=n!==void 0,d=i!==void 0;return _("p",{style:{display:"flex",flexDirection:"column"},children:[c&&_("div",{children:[_("span",{className:"description_label",children:"Effect"}),"  ",_("div",{style:{display:"flex"},children:[a&&_(Rb,{result:a}),_(be,{placeholder:"",value:t||"",editing_allowed:o,on_blur:p=>r({effect_string:p}),on_blur_type:K.conditional})]})]}),l&&_("div",{children:[_("span",{className:"description_label",children:"Effect value"}),"  ",_("span",{children:n})]}),d&&_("div",{children:[_("span",{className:"description_label",children:"Effect value when false"}),"  ",_("span",{children:i}),o&&_(ue,{children:[" ",_("span",{className:"description_label",style:{cursor:"pointer",color:"#F99"},onClick:()=>r({effect_when_false:void 0}),children:"Field deprecated (click to remove)"})]})]})]})}function zO(e){const{wcomponent:t,editing:n,upsert_wcomponent:i}=e,{line_behaviour:o}=t;return _("div",{children:n&&_("p",{children:[_("span",{className:"description_label",children:"Line style behaviour"}),"  ",_(Pe,{selected_option_id:o,allow_none:!0,options:BO,on_change:s=>{i({line_behaviour:s})}})]})})}const LO=Ot.get_state(),BO=Z1.map(e=>({id:e,title:wn(e)})).filter(e=>e.id!==Hn.angular||LO.enable_angular_connections),UO=e=>{const t=qe(e),n=le(e);return{knowledge_view:t,editing:!e.display_options.consumption_formatting,composed_wc_id_map:n&&n.composed_wc_id_map,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},WO={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},HO=j(UO,WO);function GO(e){const{wcomponent:t,upsert_wcomponent:n,wcomponents_by_id:i,knowledge_views_by_id:o,composed_wc_id_map:s,knowledge_view:r}=e;if(!s)return _("div",{children:"Counterfactual form can not render: No current knowledge view"});const a=Object.keys(s).map(v=>i[v]).filter(ge).filter(At),c=li({wcomponents:a,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:void 0,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}),l=i[t.target_wcomponent_id||""];let d=[],p=[];At(l)&&(d=l.values_and_prediction_sets||[],p=d.map(({id:v,datetime:g})=>{const b=Qh(g);return{id:v,title:b}}));const f=de(l,i),m=d.find(({id:v})=>v===t.target_VAP_set_id);let h=!1;return r&&(h=(r.active_counterfactual_v2_ids||[]).includes(t.id)),_("div",{children:[_("p",{children:[_("span",{className:"description_label",children:"Target component"}),"  ",t.target_wcomponent_id&&_(Je,{route:void 0,sub_route:void 0,item_id:t.target_wcomponent_id,args:void 0,children:[_(ti,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(Pe,{allow_none:!0,selected_option_id:t.target_wcomponent_id,options:c,on_change:v=>n({target_wcomponent_id:v,target_VAP_set_id:void 0,target_VAP_id:void 0}),on_mouse_over_option:v=>e.set_highlighted_wcomponent({id:v,highlighted:!0}),on_mouse_leave_option:v=>e.set_highlighted_wcomponent({id:v,highlighted:!1})})})]}),t.target_wcomponent_id&&_("p",{children:[_("span",{className:"description_label",children:"Target value and prediction set to override"}),"  ",_("div",{style:{width:"60%",display:"inline-block"},children:_(Pe,{allow_none:!0,selected_option_id:t.target_VAP_set_id,options:p,on_change:v=>{n({target_VAP_set_id:v,target_VAP_id:void 0})}})})]}),l&&m&&_("p",{children:[_("span",{className:"description_label",children:"Counterfactual value"}),"  ",wd({VAP_set:m,VAPs_represent:f,wcomponent:l}).map(v=>{const{VAP_id:g,value_text:b}=v,w=g===t.target_VAP_id;return _("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:g,value:b,checked:w,onChange:()=>n({target_VAP_id:g})}),_("label",{for:g,children:b})]})})]}),r&&_("p",{children:[_("span",{className:"description_label",children:"Apply counterfactual in this knowledge view"}),"  ",_(nt,{value:h,on_change:()=>{const{id:v}=t,g=kw(r.active_counterfactual_v2_ids||[],v),b={...r,active_counterfactual_v2_ids:g};e.upsert_knowledge_view({knowledge_view:b})}}),!m&&h&&_("span",{title:"Will not be applied yet, you need to target a component and one of its value sets",children:_(bs,{})})]})]})}const KO=HO(GO);function Wi(e){if(e===void 0)return"";const t=Le(e,0,1)*100;return t.toPrecision(t<98?2:3).replace(/\.0$/,"")}function Hi(e){const t=Wi(e.value),{conditional_on_change:n,on_blur:i,on_blur_type:o=K.conditional,disabled:s}=e;if(!n&&!i||s){const r="editable_percentage"+(s?"disabled":""),a=e.value!==void 0;return _("div",{className:r,children:[a&&_("span",{className:"description_label",children:e.placeholder}),t||e.placeholder," %"]})}return _("div",{className:"editable_percentage",children:[_(be,{placeholder:e.placeholder,value:t,conditional_on_change:r=>{const a=Mh(r);a!==void 0&&n&&n(a)},on_blur:r=>{const a=Mh(r);a!==void 0&&i&&i(a)},on_blur_type:o})," %"]})}function Mh(e){if(!e)return;const t=parseFloat(e);return Number.isNaN(t)?0:Le(t,0,100)/100}function YO(e){const{size:t,border_width:n,elements_width:i,conviction:o}=e,s=t/i;return _("g",{className:"conviction_mask",onMouseEnter:r=>r.currentTarget.classList.add("hovered"),onMouseLeave:r=>r.currentTarget.classList.remove("hovered"),ref:r=>{if(!r)return;const a=r.getElementsByClassName("parts")[0];Array.from(a.children).forEach(c=>{const l=c.getAttribute("data-group_id");if(!l)return;let p=parseInt(l,10)/100<=o?"display: none;":"";const f=130+Math.random()*45;p+=`fill: rgb(${f},${f},${f})`,c.setAttribute("style",p)})},children:[_("rect",{x:0,y:0,width:t+2,height:t+2,fill:"rgba(0,0,0,0)"}),_("g",{className:"parts",children:JO.map(r=>_("rect",{"data-group_id":r[2],x:n+r[0]*s,y:n+r[1]*s,width:s,height:s}))})]})}const JO=[[0,9,40],[0,8,30],[0,7,40],[0,6,90],[0,5,10],[0,4,95],[0,3,60],[0,2,60],[0,1,90],[0,0,40],[1,9,20],[1,8,50],[1,7,80],[1,6,60],[1,5,80],[1,4,90],[1,3,90],[1,2,30],[1,1,50],[1,0,30],[2,9,20],[2,8,50],[2,7,80],[2,6,40],[2,5,70],[2,4,20],[2,3,20],[2,2,50],[2,1,60],[2,0,40],[3,9,90],[3,8,50],[3,7,20],[3,6,30],[3,5,60],[3,4,50],[3,3,20],[3,2,2],[3,1,95],[3,0,10],[4,9,80],[4,8,30],[4,7,90],[4,6,60],[4,5,50],[4,4,100],[4,3,40],[4,2,70],[4,1,30],[4,0,98],[5,9,20],[5,8,40],[5,7,70],[5,6,50],[5,5,70],[5,4,90],[5,3,50],[5,2,70],[5,1,10],[5,0,80],[6,9,20],[6,8,5],[6,7,30],[6,6,50],[6,5,70],[6,4,100],[6,3,20],[6,2,90],[6,1,60],[6,0,60],[7,9,30],[7,8,70],[7,7,80],[7,6,70],[7,5,20],[7,4,10],[7,3,30],[7,2,98],[7,1,98],[7,0,90],[8,9,5],[8,8,60],[8,7,95],[8,6,70],[8,5,70],[8,4,80],[8,3,95],[8,2,40],[8,1,95],[8,0,2],[9,9,40],[9,8,40],[9,7,80],[9,6,80],[9,5,90],[9,4,10],[9,3,5],[9,2,60],[9,1,80],[9,0,30]];function d0(e){const{size:t,elements_width:n=10}=e,i=n*n,o=t/n,{counterfactual_probability:s,counterfactual_conviction:r,set_counterfactual:a}=e,c=Ao(s)||Ao(r),{probability:l,conviction:d}=XO(e),p=Ao(s)?s:l,f=Ao(r)?r:d;function m(){if(!a)return;const w=Ae({probability:l,conviction:d,counterfactual_probability:s,counterfactual_conviction:r});a({probability:w.new_counterfactual_probability,conviction:w.new_counterfactual_conviction})}const h=3,g=`prediction_badge ${`counterfactual_${c?"":"in"}active`}`,b="Visual display of probability and confidence";return _("div",{style:{cursor:e.disabled?"not-allowed":"pointer"},title:b,children:_("svg",{width:t+h*2,height:t+h*2,onClick:()=>!e.disabled&&m(),className:g,children:[_("rect",{x:0,y:0,width:t+h*2,height:t+h*2,className:"outline"}),_("g",{children:Array.from(Array(i)).map((w,x)=>{const y=x/i,$=x%n,C=Math.floor(x/n);return{i:x,i_frac:y,x:$,y:C,ys:h+(n-1-$)*o,xs:h+C*o}}).map(w=>{const $=(w.i_frac<p?0:1)*255;return{...w,fill:`rgb(${$},${$},${$})`}}).map(w=>_("rect",{x:w.xs,y:w.ys,width:o,height:o,fill:w.fill}))}),_(YO,{size:t,border_width:h,elements_width:n,conviction:f})]})})}function XO({probability:e,conviction:t}){const n=Le(e,0,1),i=Le(t,0,1);return n!==e&&console.error(`probability: ${e} not in range 0 to 1`),i!==t&&console.error(`conviction: ${t} not in range 0 to 1`),{probability:n,conviction:i}}function Ao(e){return Number.isFinite(e)}const ZO=e=>({show_unused_fields:!e.display_options.consumption_formatting}),QO=j(ZO);function e6(e){const{datetime:t,on_change:n,show_unused_fields:i}=e;return _("div",{className:"datetimes",children:[t.min&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(xt,{title:"Minimum datetime",value:t.min,on_change:o=>n({...t,min:o})})})}),(i||t.value)&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(xt,{title:"Expected datetime",value:t.value,on_change:o=>n({...t,value:o})})})}),t.max&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(xt,{title:"Maximum datetime",value:t.max,on_change:o=>n({...t,max:o})})})})]})}const u0=QO(e6),t6=e=>({editing:!e.display_options.consumption_formatting,base_id:mt(e)}),n6=j(t6);function i6(e){const{wcomponent:t,upsert_wcomponent:n,base_id:i}=e,o=t.event_at&&t.event_at[0],s=r=>{const a={event_at:[{probability:1,conviction:1,datetime:{},id:"",base_id:i||-1,explanation:"",...o||{...Xo()},...r}]};n(a)};return _("p",{children:[_(u0,{datetime:o?o.datetime:{},on_change:r=>s({datetime:r})}),_("br",{}),_("div",{style:{display:"inline-flex"},children:[_(Hi,{placeholder:"Probability",value:o==null?void 0:o.probability,on_blur:r=>s({probability:r}),on_blur_type:K.conditional}),_(Hi,{placeholder:"Confidence",value:o==null?void 0:o.conviction,on_blur:r=>s({conviction:r}),on_blur_type:K.conditional}),"  ",o&&_(d0,{disabled:!0,size:20,probability:o.probability,conviction:o.conviction})]}),_("br",{}),_("br",{}),e.editing&&_(F,{fullWidth:!0,value:o?"Clear Event":"Create Default Event",onClick:()=>{o?n({event_at:[]}):s({conviction:1,probability:1})}})]})}const o6=n6(i6);const s6=e=>{var t;return{allowed_wcomponent_ids:(t=e.derived.current_composed_knowledge_view)==null?void 0:t.wc_ids_by_type.any_node,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:ft(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},r6={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent},_6=j(s6,r6);function a6(e){const{connection_terminal_description:t,wcomponent_id:n,connection_terminal_type:i,allowed_wcomponent_ids:o,wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:a,on_update_id:c,on_update_type:l,set_highlighted_wcomponent:d}=e,p=n?s[n]:void 0,f=li({wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:a,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms,exclude_ids:e.exclude_ids}),m=[{id:"validity",title:"Validity"},{id:"state",title:"State"},{id:"meta",title:"Meta"}];return _("div",{title:p&&p.title,className:"wcomponent_from_to",children:[_("span",{className:"description_label",children:[t,"  "]}),_(Pe,{placeholder:t+"...",selected_option_id:n,options:f,allow_none:!0,on_change:h=>c(h),on_mouse_over_option:h=>d({id:h,highlighted:!0}),on_mouse_leave_option:h=>d({id:h,highlighted:!1})}),n&&_(Je,{route:void 0,sub_route:void 0,item_id:n,args:void 0,children:_(ti,{})}),l&&_(Pe,{placeholder:"attribute...",selected_option_id:i,options:m,allow_none:!1,on_change:h=>l(h),on_mouse_over_option:h=>d({id:n,highlighted:!0}),on_mouse_leave_option:h=>d({id:n,highlighted:!1})})]})}const Oh=_6(a6);function c6(e){const{wcomponent:t,upsert_wcomponent:n}=e,i=t.summary_image||void 0;return _(kn,{fullWidth:!0,label:"Summary Image URL",onChange:o=>{const s=o.currentTarget.value;n({summary_image:s})},value:i,variant:"outlined"})}const l6=e=>{var t;return{current_kv_id:(t=qe(e))==null?void 0:t.id,action_wcomponent_ids:e.derived.wcomponent_ids_by_type.action,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,is_editing:!e.display_options.consumption_formatting,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},d6=j(l6);function u6(e){const{wcomponent:t,wcomponents_by_id:n,upsert_wcomponent:i}=e,o=G(()=>{const r=Array.from(e.action_wcomponent_ids).map(c=>n[c]).filter(ge);function a(c){return c.id===e.current_kv_id?new Date().getTime():c.created_at.getTime()}return Ke(r,a,Be.descending)},[e.action_wcomponent_ids,n,e.current_kv_id]),s=li({wcomponents:o,wcomponents_by_id:n,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:{},created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _(et,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(Wn,{component:"legend",children:"Parent Action"}),_(Ui,{placeholder:"Add Label",selected_option_ids:t.parent_goal_or_action_ids||[],options:s,allow_none:!0,on_change:r=>{const a=r.filter(c=>!!c);i({parent_goal_or_action_ids:a})}})]})}const p6=d6(u6),m6=e=>({editing:!e.display_options.consumption_formatting,wcomponents_by_id:e.derived.composed_wcomponents_by_id}),f6={},h6=j(m6,f6);function v6(e){const{editing:t,wcomponent:n}=e,{calculation_custom_units:i=[]}=n,o=i.length>0,[s,r]=I(t?o:!1);if(!t&&!o)return null;let a=0;return i.forEach(c=>{c.id>a&&(a=c.id+1)}),_("div",{className:"editable_list_entry padded "+(s?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>r(!s),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Calculation Custom Units ",!s&&i.length?`(${i.length})`:""]})}),_("div",{className:"expansion_button"})]}),s&&_("div",{children:[_(R,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map((c,l)=>_(w6,{editing:t,custom_unit:c,update_calculation_custom_units:d=>{const p=[...i.slice(0,l),d,...i.slice(l+1)],f=[];p.forEach(m=>m&&f.push(m)),e.upsert_wcomponent({calculation_custom_units:f})}},c.id))}),t&&_(F,{value:"Add custom unit",fullWidth:!0,onClick:()=>{const c={id:a++,name:"",scale:1,target:""},l=[...i,c];e.upsert_wcomponent({calculation_custom_units:l})}})]})]})}const g6=h6(v6);function w6(e){const{editing:t,custom_unit:n}=e,[i,o]=I(!1),s=n.name.trim().length===0||n.target.trim().length===0;return _(R,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",marginBottom:t?"18px":void 0,flexDirection:t?"column":"row",style:{display:"flex",flexDirection:"row",justifyContent:"flex-start",gap:"5px"},children:[_(Ib,{message:s?"Name and target must be set":"",is_error:s}),t&&_(ue,{children:[_("div",{style:{width:"90%",display:"flex",flexDirection:"column",justifyContent:"space-between",gap:"10px"},children:[_(be,{size:"small",placeholder:"Custom unit name",value:n.name,on_blur:a=>{e.update_calculation_custom_units({...n,name:a})},on_blur_type:K.conditional}),_(be,{size:"small",placeholder:"Converts to",value:n.target,on_blur:a=>{e.update_calculation_custom_units({...n,target:a})},on_blur_type:K.conditional}),i&&_(Li,{on_click:()=>{e.update_calculation_custom_units(null)},button_text:"",button_icon:_(Po,{}),ready_to_progress:!0,on_cancel:()=>o(!1)})]}),_("div",{style:{width:"10%",display:"flex"},children:!i&&_(ce,{onClick:()=>o(!0),size:"large",children:_(Po,{})})})]}),!t&&_(ue,{children:[_(be,{size:"small",placeholder:"Custom unit name",value:n.name||"..."}),_(be,{size:"small",placeholder:"Converts to",value:n.target||"..."})]})]})}const b6=e=>({editing:!e.display_options.consumption_formatting,wcomponents_by_id:e.derived.composed_wcomponents_by_id}),y6={},k6=j(b6,y6);function x6(e){const{wcomponent:t,wcomponents_by_id:n}=e,{calculations:i=[],calculation_custom_units:o=[]}=t;i.forEach((f,m)=>f.id=f.id??m);const[s,r]=I(i.length>0),a={};i.forEach(f=>a[f.id]=!1);const[c,l]=I(a),d=H(i,n,o),p=i.map(({name:f})=>f);return _("div",{className:"editable_list_entry padded "+(s?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>r(!s),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Calculations ",!s&&i.length?`(${i.length})`:""]})}),_("div",{className:"expansion_button"})]}),s&&_("div",{children:[_(R,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map((f,m)=>_(VN,{editing:e.editing,show_options:c[f.id]||!1,set_show_options:h=>{const v={...c,[f.id]:h};l(v)},calculation:f,calculation_result:d[m],existing_calculation_name_ids:p,update_calculation:h=>{const g=[...i.slice(0,m),h,...i.slice(m+1)].filter(w=>!!w),b=g.length?g:void 0;e.upsert_wcomponent({calculations:b})},disallowed_commands:(()=>{const h=new Set;return m===0&&h.add("move_up"),m===i.length-1&&h.add("move_down"),h})(),update_calculations:h=>{if(h==="move_up"){const v=m-1;if(!bt(i,v))return;const g=gt(i,m,v);e.upsert_wcomponent({calculations:g})}else if(h==="move_down"){const v=m+1;if(!bt(i,v))return;const g=gt(i,m,v);e.upsert_wcomponent({calculations:g})}else if(h==="add_above"){const v=wc(i),g=wt(i,v,m);e.upsert_wcomponent({calculations:g})}else if(h==="add_below"){const v=wc(i),g=wt(i,v,m+1);e.upsert_wcomponent({calculations:g})}}},f.id))}),e.editing&&_(F,{value:"Add calculation",fullWidth:!0,onClick:()=>{const f=wc(i),m=[...i,f];e.upsert_wcomponent({calculations:m})}})]})]})}const S6=k6(x6);function wc(e){let t=-1;e.forEach(o=>t=Math.max(t,o.id)),++t;const n=mn(e.map(({name:o})=>o));return{id:t,name:n,value:""}}function A6(e){const t=nl(e);return{id:Jc(),value:"",description:"",order:t+1}}function $6(e){const{editing:t,value_possibility:n,count_of_value_possibilities:i,update_value_possibility:o}=e,[s,r]=I(n.value);oe(()=>r(n.value),[n.value]);const c=(i[s.toLowerCase()]||0)>1?`Current value "${s}" is already present in other possible values.`:"";return _(R,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",style:{display:"flex"},children:[_(R,{style:{width:"100%"},children:[_(no,{warning:c,label:"Duplicate"}),_(ae,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:_(be,{placeholder:"Possible value",hide_label:!0,value:n.value,conditional_on_change:l=>r(l),on_blur:l=>{o({...n,value:l})},on_blur_type:K.conditional})})]}),Ec[n.id]&&_(R,{style:{width:100,color:"#cb4",cursor:"pointer"},title:"Using interoperable ID",children:Ec[n.id]}),t&&_(ce,{onClick:()=>o(void 0),size:"large",children:_(Ad,{})})]},e.value_possibility.id)}function C6(e){const[t,n]=I(!1);if(e.VAPs_represent===P.undefined)return null;const i=E6(e.value_possibilities),{count_of_value_possibilities:o,max_count:s}=T6(i),r=s>1?"Duplicate value possibilities present":"",a=`editable_list_entry padded ${t?"expanded":""}`,{attribute_wcomponent:c}=e;return _("div",{className:a,children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>n(!t),children:[_("div",{className:"summary",children:[_("h4",{style:{display:"inline-block"},children:["Possible Values ",!t&&i.length?`(${i.length})`:""]}),_("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:_(no,{warning:r,label:""})})]}),_("div",{className:"expansion_button"})]}),t&&_("div",{children:[_(R,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map(l=>_($6,{editing:e.editing,value_possibility:l,count_of_value_possibilities:o,update_value_possibility:d=>{const p={...e.value_possibilities};d?p[d.id]=d:delete p[l.id];const f=Object.keys(p).length>0;e.update_value_possibilities(f?p:void 0)}}))}),e.editing&&_(F,{value:"New possibility",fullWidth:!0,onClick:()=>{const l=A6(e.value_possibilities),d={...e.value_possibilities,[l.id]:l};e.update_value_possibilities(d)}}),e.editing&&_(F,{value:"Use defaults",fullWidth:!0,onClick:()=>{const l=hn(e.VAPs_represent,void 0,e.values_and_prediction_sets),d=tn(l,"default_possible_values");e.update_value_possibilities(d)}}),e.editing&&c&&Ye(c)&&_(F,{value:"Use attribute's possibilities",fullWidth:!0,onClick:()=>{const l=hn(e.VAPs_represent,c.value_possibilities,c.values_and_prediction_sets||[]),d=tn(l,"attribute's possible_values");e.update_value_possibilities(d)}})]})]})}function T6(e){const t={};let n=0;return e.forEach(({value:i})=>{i=i.toLowerCase();const o=(t[i]||0)+1;t[i]=o,n=Math.max(n,o)}),{count_of_value_possibilities:t,max_count:n}}function E6(e){return Object.values(e||{}).sort((t,n)=>t.order<n.order?-1:1)}const j6=(e,t)=>({created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:t.editing_allowed??!e.display_options.consumption_formatting,current_created_at_ms:e.routing.args.created_at_ms}),N6={change_route:S.routing.change_route},P6=j(j6,N6);function I6(e){var E;const{existing_value_possibilities:t,values_and_prediction_sets:n,VAPs_represent:i,base_id:o,editing:s,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l}=e;if(!s||i!==P.action)return null;const{latest:d}=sl(n),f=Sl(d)[0],m=(E=f==null?void 0:f.entries.find(N=>N.probability===1))==null?void 0:E.value_id,h=m===we.action_potential,v=m===we.action_paused,g=m===we.action_in_progress,b=m===we.action_completed,w=!f||h||v,x=b,y=g,$=!f||g;function C(N){const A=Wc({existing_value_possibilities:t,orig_values_and_prediction_sets:n,base_id:o,action_value_possibility_id:N});Py({existing_value_possibilities:t,new_values_and_prediction_sets:A,orig_values_and_prediction_sets:n,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l})}return _("div",{children:[(w||x)&&_(F,{value:x?"Restart (In Progress)":"In Progress",fullWidth:!0,color:"secondary",onClick:()=>C(we.action_in_progress)}),y&&_(F,{value:"Pause",fullWidth:!0,color:"secondary",onClick:()=>C(we.action_paused)}),$&&_(F,{value:"Completed",fullWidth:!0,color:"secondary",onClick:()=>C(we.action_completed)})]})}const R6=P6(I6);function D6(e){const{new_item:t,set_new_item:n,item_descriptor:i,item_props:o}=e,{crud:s}=o,r=G(()=>({...s,update_item:n}),[s,n]);return t?_(R,{children:_(e1,{"aria-labelledby":"new_item_title",open:!0,onClose:()=>n(void 0),fullWidth:!0,maxWidth:"sm",children:[_(t1,{id:"new_item_title",children:["New ",i]}),_(n1,{children:_($d,{item:t,...o,expanded:!0,crud:r})}),_(i1,{children:[_(F,{onClick:()=>{setTimeout(()=>s.create_item(t),0)},children:["Add ",i]}),_(F,{onClick:()=>n(void 0),children:"Cancel"})]})]})}):null}function M6(e,t){const n=ss(e.entries,t),i=n[0];if(t===P.boolean&&i)return _(ue,{children:i.probability>.5?"True":"False"});const o=t===P.number,s=n.filter(({probability:r})=>r>0);return _(ue,{children:[s.map((r,a)=>_("span",{children:[o?_(O6,{value:r.value}):r.value,a<s.length-1&&", "]},a)),s.length===0&&"-"]})}function O6(e){return $e(e.value)?_(ue,{children:e.value}):_("span",{style:{borderRadius:5,border:"thin solid #999",padding:"2px 3px 0px 3px"},children:[_(nn,{message:"Number is invalid",backgroundColor:"white"}),e.value]})}function q6(e,t){const n=ss(e.entries,t),i=n[0];return t===P.boolean&&i?Wi(i.probability):n.filter(({probability:s})=>s>0).map(s=>Wi(s.probability)).join(", ")}function V6(e,t){const n=ss(e.entries,t),i=n[0];if(t===P.boolean&&i)return Wi(i.conviction);const o=n.filter(({probability:a})=>a>0),s=new Set;o.forEach(({conviction:a})=>s.add(a));const r=s.size<=1;return o.slice(0,r?1:void 0).map(a=>Wi(a.conviction)).join(", ")}var Td={},F6=ee;Object.defineProperty(Td,"__esModule",{value:!0});var No=Td.default=void 0,z6=F6(Q()),L6=te(),B6=(0,z6.default)((0,L6.jsx)("path",{d:"M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5zm-1 4h-2.19l2 2H16zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3 2 4.27z"}),"LinkOff");No=Td.default=B6;const U6="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM19 12h-2v3h-3v2h3v3h2v-3h3v-2h-3z";function W6(e){return _(Cn,{...e,d:U6})}const H6="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1z M16 18.17 14.33 16.5l-1.42 1.41L16 21 21.0 15.8l-1.41-1.41z";function G6(e){return _(Cn,{...e,d:H6})}function K6(e){const{editing:t,VAP:n,value_possibilities:i,update_VAP:o}=e,s=G(()=>Nb(e.value_possibilities,!0),[e.value_possibilities]);if(i===void 0)return _("span",{title:"Need to first add value possibilities to link to.",className:"possible_value_link disabled",children:_(No,{})});if(!!i[n.value_id||""])return _("span",{title:"Linked to possible value.  Click to unlink.",className:"possible_value_link "+(t?"clickable":"disabled"),onClick:()=>{const c={...n};delete c.value_id,o(c)},children:[_(G6,{className:"hide_on_hover"}),_(No,{className:"show_on_hover"})]});const a=s[n.value.toLowerCase()];return a?_("span",{title:"Linkable to value possibility.  Click to link.",className:"possible_value_link "+(t?"clickable":"disabled"),onClick:()=>{const l=i[a.id].description||n.description,d={...n,value_id:a.id,description:l};o(d)},children:_(W6,{})}):_("span",{title:"No matching value possibility to link to.",className:"possible_value_link disabled",children:_(No,{})})}const Y6=e=>({editing:!e.display_options.consumption_formatting}),J6=j(Y6);function X6(e){const{editing:t,value_possibilities:n,VAPs_represent:i}=e,o=e.values_and_predictions,s=i===P.boolean&&o.length>=1?"only_one_VAP":"",r=i===P.number,a={get_summary:Q6({value_possibilities:n,VAPs_represent:i,editing:t}),get_details:eq(i,t),extra_class_names:"value_and_prediction",crud:{update_item:l=>{const d=wi(l),p=yw(o,l,f=>wi(f)===d);e.update_values_and_predictions(p)},delete_item:l=>{const d=wi(l),p=wl(o,f=>wi(f)===d);e.update_values_and_predictions(p)}},delete_button_text:"Delete Value & Prediction",hide_expansion_button:l=>!t&&!l.description&&!l.source&&(!r||!l.min&&!l.max),calc_initial_custom_expansion_state:l=>!!(l.description||l.source||r&&(l.min||l.max))},c="Value and prediction";return _("div",{className:`value_and_predictions ${s}`,children:[_(Zy,{items_descriptor:kd(c,o.length),other_content:()=>!t||i===P.boolean?null:_(xd,{new_item_descriptor:c,on_pointer_down_new_list_entry:()=>{const l=[...o,Re()];e.update_values_and_predictions(l)}})}),Cd({items:o,get_id:wi,item_props:a,debug_item_descriptor:c})({expanded_item_rows:!1,expanded_items:!0,disable_partial_collapsed:!1})]})}const Z6=J6(X6),wi=e=>e.id,Q6=e=>(t,n,i)=>{const{value_possibilities:o,VAPs_represent:s,editing:r}=e,{probability:a,relative_probability:c,conviction:l,min:d,value:p,max:f}=t,m=s===P.boolean,h=s===P.number,v=c!==void 0,g=v&&!m,b=!v||m;return _("div",{className:"value_and_prediction_summary",children:[_("br",{}),_("div",{className:"temporal_uncertainty",children:[h&&(r&&i||d)&&_("div",{children:[_(bc,{value:d}),_(be,{placeholder:"Min",value:d||"",modify_value_pre_on_blur:w=>w.trim(),on_blur:w=>n.update_item({...t,min:w}),on_blur_type:K.conditional}),_("br",{})]},"min"),(r||p)&&_("div",{style:{position:"relative"},children:[h&&_(bc,{value:p}),_(be,{disabled:m,placeholder:"Value",value:m?a>.5?"True":"False":p,modify_value_pre_on_blur:w=>w.trim(),on_blur:w=>n.update_item({...t,value:w}),on_blur_type:K.conditional}),!h&&!m&&_("div",{style:{position:"absolute",right:"-25px",top:"15px"},children:_(K6,{editing:r,VAP:t,value_possibilities:o,update_VAP:w=>n.update_item(w)})}),_("br",{})]},"value"),h&&(r&&i||f)&&_("div",{children:[_(bc,{value:f}),_(be,{placeholder:"Max",value:f||"",modify_value_pre_on_blur:w=>w.trim(),on_blur:w=>n.update_item({...t,max:w}),on_blur_type:K.conditional}),_("br",{})]},"max")]}),_("div",{className:"predictions",children:[m&&_("div",{className:g?"disabled":"",children:_(Hi,{disabled:g,placeholder:"Probability",value:a,on_blur:w=>{n.update_item({...t,probability:w})},on_blur_type:K.conditional})}),m&&_("div",{children:_(Hi,{placeholder:"Confidence",value:l,on_blur:w=>n.update_item({...t,conviction:w}),on_blur_type:K.conditional})}),!m&&c!==void 0&&_("div",{className:b?"disabled":"",children:_(rt,{disabled:b,placeholder:"Relative probability",size:"medium",value:c,allow_undefined:!0,on_blur:w=>{w=w||0,n.update_item({...t,relative_probability:w})},on_blur_type:K.conditional})}),"  ",_(d0,{disabled:!0,size:20,probability:a,conviction:l})]})]})},eq=(e,t)=>(n,i)=>e===P.boolean?_("div",{children:[_("div",{className:"description_label",children:"Description"}),"Boolean value of this state, i.e. either true (100%), false (0%) or somewhere in between."]}):!t&&!n.description&&!n.source?_(ue,{}):_("div",{children:[(t||n.description)&&_(ei,{placeholder:"Description",value:n.description,on_blur:o=>i.update_item({...n,description:o.trim()}),on_blur_type:K.conditional}),t&&_("br",{}),(t||n.source)&&_(be,{placeholder:"Source",size:"small",value:n.source||"",on_blur:o=>i.update_item({...n,source:o?o.trim():void 0}),on_blur_type:K.conditional}),t&&_("br",{})]});function bc(e){const t=$e(e.value||"");return _("div",{style:{maxHeight:t?0:100,overflow:"hidden",transition:"max-height 1s ease 0s"},children:_(no,{warning:"Number is invalid"})})}function tq(e){const{value:t,created_at:n,datetime:i,probability:o,conviction:s}=e;return _("div",{children:[n&&_("div",{style:{display:"inline-flex"},children:["Created:  ",_(xt,{invariant_value:n,value:void 0})]}),_("div",{className:"summary_container",children:[_("div",{className:"summary_row",children:[_("div",{className:"datetimes",children:Qh(i)}),t&&_("div",{children:["      ",t]})]}),_("div",{className:"summary_row",children:[_("div",{children:[_("span",{className:"description_label",children:"Prob"})," ",o]}),"   ",_("div",{children:[_("span",{className:"description_label",children:"Confidence"})," ",s]})]})]})]})}const Ed=(e,t)=>(n,i)=>{let o=p0(n,e);n={...n,entries:o};const s=M6(n,e),r=q6(n,e)+"%",a=V6(n,e)+"%";return _(tq,{created_at:t?n.custom_created_at||n.created_at:void 0,value:s,datetime:n.datetime,probability:r,conviction:a})},jd=(e,t)=>(n,i)=>{const o=p0(n,t);return _("div",{className:"VAP_set_details",children:[_("br",{}),_(u0,{datetime:n.datetime,on_change:s=>i.update_item({...n,datetime:s})}),_("div",{children:[_("br",{}),_(Z6,{value_possibilities:e,VAPs_represent:t,values_and_predictions:o,update_values_and_predictions:s=>{const r=nq(s,n,t),a=el(r,t),c={...n,entries:a};i.update_item(c)}}),_("br",{})]}),_("br",{})]})},Nd=(e,t)=>(n,i)=>{const o=n.shared_entry_values||{},s=n.entries.map(({explanation:d})=>d.trim()).filter(d=>d).join(`

`),r=o.explanation||s||"",a=o.conviction||1,c=e!==P.boolean,l=!!(t||r);return _("div",{className:"shared_VAP_set_details",children:[c&&_("div",{children:_(Hi,{disabled:!1,placeholder:"Confidence",value:a,on_blur:d=>{const p={...n.shared_entry_values,conviction:d},f=n.entries.map(m=>({...m,conviction:d}));i.update_item({...n,entries:f,shared_entry_values:p})},on_blur_type:K.conditional})}),l&&_(ei,{placeholder:"Explanation",value:r,on_blur:d=>{const p={...n.shared_entry_values,explanation:d};i.update_item({...n,shared_entry_values:p})},on_blur_type:K.conditional}),_("br",{})]})};function p0(e,t){let n=e.entries;return t===P.boolean&&n.length!==1&&(n=n.slice(0,1)),n}function nq(e,t,n){return n===P.boolean&&(e=e.concat(t.entries.slice(1))),e}function iq(e){const{VAP_set:t,on_change:n}=e;if(!t.entries[0])return null;const o=ii(t.datetime),s=o===void 0;return _("div",{children:[o?Go({date:o}):"Is Eternal",_("br",{}),s&&_(F,{value:"Set to 'From today'",onClick:()=>n({...t,datetime:{value:w1()}})}),!s&&_(F,{value:"Set to Eternal",onClick:()=>n({...t,datetime:{}})}),_("br",{}),_("br",{})]})}const oq=(e,t)=>{const n=Object.keys(t||{}).length>0,i=e===P.other&&n,o=e===P.boolean||e===P.action||i,[s,r]=I(!o);return(a,c)=>{const{update_item:l}=c;return _("div",{children:[!s&&e===P.boolean&&_(sq,{VAP_set:a,on_change:l}),!s&&e===P.action&&_(rq,{possible_value_possibilities:t,VAP_set:a,on_change:l}),!s&&i&&_(_q,{possible_value_possibilities:t,VAP_set:a,on_change:l}),!s&&_("div",{children:[_("span",{className:"description_label",children:"Datetime"}),_(iq,{VAP_set:a,on_change:l})]}),_(F,{value:(s?"Hide":"Show")+" advanced options",onClick:()=>r(!s)}),s&&_("div",{children:[_("br",{}),_("br",{}),_("hr",{}),Ed(e,!1)(a,c),jd(t,e)(a,c),Nd(e,!0)(a,c)]})]})}};function sq(e){const{VAP_set:t,on_change:n}=e,i=t.entries[0];if(!i)return null;const o=i.probability===1&&i.conviction===1,s=i.probability===0&&i.conviction===1;return _("div",{children:[o&&"True",s&&"False",_("br",{}),!o&&_(F,{value:"Set to True",onClick:()=>{n({...t,entries:[{...i,probability:1,conviction:1}]})}}),!s&&_(F,{value:"Set to False",onClick:()=>{n({...t,entries:[{...i,probability:0,conviction:1}]})}}),_("br",{}),_("br",{})]})}function rq(e){return _(m0,{...e,title:"Set action status to:"})}function _q(e){return _(m0,{...e,title:"Set value to:"})}function m0(e){const{title:t,possible_value_possibilities:n,VAP_set:i,on_change:o}=e,s=cq(i),r=aq(n);return _("div",{children:[t,_(Pe,{selected_option_id:s,options:r,allow_none:!0,on_change:a=>{if(!a)return;const c=Ny(i,a);o({...i,entries:c})}}),_("br",{}),_("br",{})]})}function aq(e){return e===void 0?[]:Object.values(e).map(({id:t,value:n})=>({id:t,title:wn(n)}))}function cq(e){var o,s;let t;const n=((o=e.shared_entry_values)==null?void 0:o.conviction)||0,i=((s=e.shared_entry_values)==null?void 0:s.probability)||0;return e.entries.forEach(r=>{Math.max(n,r.conviction)===1&&Math.max(i,r.probability)===1&&(t=r.value_id)}),t}const lq=e=>({editing:!e.display_options.consumption_formatting}),dq=j(lq);function uq(e){const{editing:t,value_possibilities:n,VAPs_represent:i,older_VAP_sets:o,create_item:s,update_item:r,delete_item:a}=e,c="Older version",l=G(()=>()=>{const p=kk(e.current_VAP_set);s(p)},[e.current_VAP_set,s]),d=G(()=>Cd({items:o,get_id:mq,debug_item_descriptor:c,item_props:{get_created_at:fq,get_custom_created_at:hq,get_summary:Ed(i,!0),get_details:jd(n,i),get_details2:Nd(i,t),extra_class_names:"value_and_prediction_set",crud:{create_item:s,update_item:r,delete_item:a},delete_button_text:"Delete Older Set of Value & Predictions"}}),[o,c,i,t,s,r,a]);return _(e0,{items_count:o.length,item_descriptor:c,new_item_descriptor:"Version",content:d,on_click_new_item:l})}const pq=dq(uq),mq=e=>e.id,fq=e=>e.created_at,hq=e=>e.custom_created_at;function vq(e){const[t,n]=I(void 0),{wcomponent_id:i,VAPs_represent:o,update_values_and_predictions:s,existing_value_possibilities:r,values_and_prediction_sets:a,invalid_future_items:c,future_items:l,present_item:d,past_items:p,previous_versions_by_id:f,editing:m}=e,h=d?[d]:[],v=xc({existing_value_possibilities:r,subset_VAP_sets:l,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:J.future,editing:m}),g=xc({existing_value_possibilities:r,subset_VAP_sets:h,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:J.present,editing:m}),b=xc({existing_value_possibilities:r,subset_VAP_sets:p,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:J.past,editing:m}),x={get_created_at:f0,get_custom_created_at:h0,get_summary:oq(o,r),get_details:()=>_("div",{}),get_details2:()=>_("div",{}),extra_class_names:"value_and_prediction_set new",crud:{create_item:N=>{const A=[...a,N];s(A),n(void 0)},update_item:n}},y="Value Prediction",$=m||l.length>0,C=m||h.length>0,E=m||p.length>0;return _("div",{className:"value_and_prediction_sets",children:[m&&_(xd,{new_item_descriptor:y,on_pointer_down_new_list_entry:()=>{const N=Te(o,r,a,e.base_id);n(N)}}),_(D6,{new_item:t,set_new_item:n,item_props:x,item_descriptor:y}),c.length>0&&_("div",{children:["Hidden (",c.length,") ",_(rd,{})]}),$&&_(Mi,{content:v,item_descriptor:"",items_descriptor:yc("Future",l,f,m),items_descriptor_title:kc("Future",l,f),disable_collapsed:!0}),($||C)&&_("hr",{}),C&&_(Mi,{content:g,item_descriptor:"",items_descriptor:yc("Present",h,f,m),items_descriptor_title:kc("Present",h,f),disable_collapsed:!0}),C&&E&&_("hr",{}),E&&_(Mi,{content:b,item_descriptor:"",items_descriptor:yc("Past",p,f,m),items_descriptor_title:kc("Past",p,f),disable_collapsed:!0})]})}function yc(e,t,n,i){if(!i)return e;let o=0;return t.forEach(({id:s})=>o+=(n[s]||[]).length),o===0?kd(e,t.length,i):`${e} (${t.length}+)`}function kc(e,t,n){let i=0;return t.forEach(({id:o})=>i+=(n[o]||[]).length),i===0?`${t.length} ${e} items`:`${t.length} ${e} items with ${i} older versions`}function xc(e){const{existing_value_possibilities:t,subset_VAP_sets:n,all_VAP_sets:i,previous_versions_by_id:o,update_values_and_predictions:s,VAPs_represent:r,tense:a,editing:c}=e;return d=>{const{disable_partial_collapsed:p,expanded_items:f,expanded_item_rows:m}=d,h={create_item:v=>{const g=[...i,v];s(g)},update_item:v=>{const g=qh(v),b=yw(i,v,g);s(b)},delete_item:v=>{const g=qh(v),b=wl(i,g);s(b)}};return _("div",{style:{display:f?"":"none",cursor:"initial"},onClick:v=>v.stopPropagation(),children:n.map(v=>_("div",{children:[_("hr",{className:"entries_horizontal_dividers"}),_($d,{item:v,get_created_at:f0,get_custom_created_at:h0,get_summary:Ed(r,!1),get_details:jd(t,r),get_details2:Nd(r,c),get_details3:gq(t,r,o),extra_class_names:`value_and_prediction_set ${a===J.future?"future":a===J.present?"present":"past"}`,expanded:m,crud:h,delete_button_text:"Delete Set of Value & Predictions"})]},v.id))})}}const f0=e=>e.created_at,h0=e=>e.custom_created_at,qh=e=>t=>e.id===t.id&&e.created_at.getTime()===t.created_at.getTime(),gq=(e,t,n)=>(i,o)=>_(R,{className:"VAP_set_details",children:[_("br",{}),_(pq,{value_possibilities:e,VAPs_represent:t,current_VAP_set:i,older_VAP_sets:n[i.id]||[],create_item:o.create_item,update_item:o.update_item,delete_item:o.delete_item}),_("br",{}),_("br",{})]}),wq=(e,t)=>({current_created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:t.editing_allowed??!e.display_options.consumption_formatting,base_id:mt(e)||-1}),bq={change_route:S.routing.change_route},yq=j(wq,bq);function kq(e){const{wcomponent_id:t,existing_value_possibilities:n,values_and_prediction_sets:i,VAPs_represent:o,base_id:s,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l}=e,{invalid_future_items:d,past_items:p,present_item:f,future_items:m,previous_versions_by_id:h}=zi({items:i,created_at_ms:e.current_created_at_ms,sim_ms:a});return _(vq,{wcomponent_id:t,VAPs_represent:o,update_values_and_predictions:v=>{Py({existing_value_possibilities:n,new_values_and_prediction_sets:v,orig_values_and_prediction_sets:i,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l})},existing_value_possibilities:e.existing_value_possibilities,values_and_prediction_sets:i,invalid_future_items:d,past_items:p,present_item:f,future_items:m,previous_versions_by_id:h,base_id:s,editing:e.editing})}const xq=yq(kq),Sq=e=>({wcomponents_by_id:e.derived.composed_wcomponents_by_id,presenting:e.display_options.consumption_formatting}),Aq={},$q=j(Sq,Aq);function Cq(e){const{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,VAPs_represent:o,orig_values_and_prediction_sets:s,orig_value_possibilities:r}=e,a=s.length>0||t&&o===P.action,[c,l]=I(a),d=Ye(n)&&n.units,[p,f]=I(!!d),m=p&&(o===P.number||!!d)||e.presenting&&o===P.number&&!!d;return _("div",{className:"editable_list_entry padded "+(c?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>l(!c),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Value Predictions ",!c&&s.length?`(${s.length})`:""]})}),_("div",{className:"expansion_button"})]}),Ye(n)&&_("div",{children:[e.editing_allowed&&_(ce,{onClick:()=>f(!p),size:"small",style:{marginLeft:"auto",display:"flex"},children:_(Uh,{})}),m&&_(be,{style:{padding:"10px 0px"},size:"small",placeholder:"Units",hide_label:!1,disabled:!e.editing_allowed,value:n.units||"",on_blur:h=>e.upsert_wcomponent({units:h||void 0}),on_blur_type:K.conditional})]}),c&&_("div",{children:[o===P.undefined&&_("div",{children:n.type==="state_value"?"Set subtype of target 'state' component to show Value Predictions on this 'state value' component":"Set subtype to show Value Predictions"}),o===P.action&&_(R6,{VAPs_represent:o,base_id:n.base_id,existing_value_possibilities:r,values_and_prediction_sets:s,update_VAPSets_and_value_possibilities:({value_possibilities:h,values_and_prediction_sets:v})=>{i({value_possibilities:h,values_and_prediction_sets:v})},editing_allowed:t}),o!==P.undefined&&_(xq,{wcomponent_id:n.id,VAPs_represent:o,existing_value_possibilities:r,values_and_prediction_sets:s,update_VAPSets_and_value_possibilities:({value_possibilities:h,values_and_prediction_sets:v})=>{i({value_possibilities:h,values_and_prediction_sets:v})},editing_allowed:t})]})]})}const Tq=$q(Cq),Eq=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id}),jq={},Nq=j(Eq,jq);function Pq(e){const{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,wcomponents_by_id:o}=e,s=de(n,o),r=n.values_and_prediction_sets,a=n.value_possibilities;return _(ue,{children:[(t&&ik(n)||nk(n)&&n.calculations.length>0)&&_(ue,{children:[_(S6,{wcomponent:n,upsert_wcomponent:i}),_(g6,{wcomponent:n,upsert_wcomponent:i})]}),r!==void 0&&(t||r.length>0)&&_(Tq,{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,VAPs_represent:s,orig_values_and_prediction_sets:r,orig_value_possibilities:a}),s!==P.undefined&&r!==void 0&&(t||Object.keys(a||{}).length>0)&&_(C6,{editing:t,attribute_wcomponent:o[pt(n)&&n.attribute_wcomponent_id||""],VAPs_represent:s,value_possibilities:a,values_and_prediction_sets:r,update_value_possibilities:c=>{const l=Fn(r,c);i({value_possibilities:c,values_and_prediction_sets:l})}})]})}const Iq=Nq(Pq),Rq=e=>({current_knowledge_view:le(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:e.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:!e.display_options.consumption_formatting,wc_id_to_counterfactuals_map:ft(e)}),Dq={set_highlighted_wcomponent:S.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:S.specialised_object.upsert_knowledge_view},Mq=j(Rq,Dq);function Oq(e){const{current_knowledge_view:t,wcomponents_by_id:n,knowledge_views_by_id:i,wcomponent:o,upsert_wcomponent:s,wc_id_to_counterfactuals_map:r}=e,a=Array.from(e.wcomponent_ids_with_state_VAPs).map(f=>n[f]).filter(ge).filter(At),c=t==null?void 0:t.composed_wc_id_map[o.id];function l(f){const m=t==null?void 0:t.composed_wc_id_map[f.id];return YA(c,m)}const d=Ke(a,l,Be.ascending),p=li({wcomponents:d,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:r,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _("div",{children:_("p",{children:[_("span",{className:"description_label",children:"Attribute (target) component"}),"  ",o.attribute_wcomponent_id&&_(Je,{route:void 0,sub_route:void 0,item_id:o.attribute_wcomponent_id,args:void 0,children:[_(ti,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(Pe,{allow_none:!0,selected_option_id:o.attribute_wcomponent_id,options:p,on_change:f=>{const m=n[f||""];let{value_possibilities:h}=o;if((!h||!Object.keys(h))&&Ye(m)){const v=de(m,n),g=hn(v,m.value_possibilities,m.values_and_prediction_sets||[]);h=tn(g,"attribute's possible_values")}s({attribute_wcomponent_id:f,value_possibilities:h})},on_mouse_over_option:f=>e.set_highlighted_wcomponent({id:f,highlighted:!0}),on_mouse_leave_option:f=>e.set_highlighted_wcomponent({id:f,highlighted:!1})})})]})})}const qq=Mq(Oq),Vq=(e,{wcomponent:t})=>{let n,i;Ne(t)&&(n=Me(e,t.from_id),i=Me(e,t.to_id));const o=ft(e),s=!e.display_options.consumption_formatting,r=(e.user_info.bases_by_id||{})[t.base_id],a=!!(r!=null&&r.can_edit);return{ready:e.sync.ready_for_reading,base_id:mt(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:o,from_wcomponent:n,to_wcomponent:i,derived_composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,derived_composed_wcomponent:e.derived.composed_wcomponents_by_id[t.id],is_in_editing_mode:s,allowed_to_edit:a,editing_allowed:s&&a,base_for_wcomponent:r,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},Fq={upsert_wcomponent:S.specialised_object.upsert_wcomponent,delete_wcomponent:S.specialised_object.delete_wcomponent,update_chosen_base_id:S.user_info.update_chosen_base_id},zq=j(Vq,Fq);function Lq(e){var A,M,D;const{wcomponent:t,ready:n,base_id:i,wcomponents_by_id:o,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:r,from_wcomponent:a,to_wcomponent:c,derived_composed_wcomponents_by_id:l,derived_composed_wcomponent:d,editing_allowed:p,created_at_ms:f,sim_ms:m}=e,h=t.id,[v,g]=I(h);if(!n)return _("div",{children:"Loading..."});if(!d)return _("div",{children:"Loading..."});if(i===void 0)return _("div",{children:"Choose a project first."});const b=r&&((A=r[h])==null?void 0:A.VAP_sets),w=Ee(!0);if(oe(()=>g(h),[h]),v!==h)return w.current=!0,null;const x=w.current;w.current=!1;const y=T=>{const L=NO(t,T).wcomponent;e.upsert_wcomponent({wcomponent:L})};let $,C=!1;At(t)&&($=rs({wcomponent:d,VAP_set_id_to_counterfactual_v2_map:b,created_at_ms:f,sim_ms:m}),C=(((M=t.values_and_prediction_sets)==null?void 0:M.length)||0)>0);const E=at({text_type:p?pe.raw:pe.rich,wcomponent:d,wcomponents_by_id:l,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:r,created_at_ms:f,sim_ms:m}),N=T=>y({title:T});return _(R,{children:[e.is_in_editing_mode&&!e.allowed_to_edit&&_("div",{children:[_(nn,{message:""}),"  Not allow to edit.  Ask project owner to give you edit permissions."]}),e.wcomponent_from_different_base&&_("div",{style:{cursor:"pointer"},onClick:()=>e.update_chosen_base_id({base_id:t.base_id}),title:`Click to change to project ${t.base_id}`,children:[_(nn,{}),'  Is part of project "',(D=e.base_for_wcomponent)==null?void 0:D.title,'"']}),_(et,{variant:"standard",fullWidth:!0,margin:"normal",style:{fontWeight:600,fontSize:22},children:_(ei,{editing_allowed:p,placeholder:t.type==="action"?"Passive imperative title...":t.type==="relation_link"?"Verb...":"Title...",value:E,on_blur:N,on_blur_type:K.conditional,force_focus_on_first_render:x,hide_label:!0,spellcheck:!0})}),$&&_("span",{children:[_("span",{className:"description_label",children:"Value "}),_(PO,{UI_value:$})]}),(p||t.type!=="statev2"||C)&&_(et,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:_(Pe,{editing_allowed:p,placeholder:"Type: ",selected_option_id:t.type,options:c0,on_change:T=>{if(!T)return;const ne={...O({type:T,base_id:t.base_id}),...t};ne.type=T,y(ne)}})}),Ye(t)&&(p||t.subtype)&&_("div",{children:[_("span",{className:"description_label",children:"Subtype"})," ",_("div",{style:{width:"60%",display:"inline-block"},children:_(Pe,{editing_allowed:p,placeholder:"Subtype...",selected_option_id:t.subtype,options:VO,allow_none:!0,on_change:T=>y({subtype:T})})})]}),(p||t.description)&&_(et,{variant:"standard",fullWidth:!0,margin:"normal",children:_(ei,{editing_allowed:p,placeholder:"Description...",value:t.description,on_blur:T=>y({description:T}),on_blur_type:K.conditional,hide_label:!0})}),pt(t)&&_(qq,{wcomponent:t,upsert_wcomponent:y}),Zc(t)&&_(KO,{wcomponent:t,upsert_wcomponent:y}),Ne(t)&&_("div",{children:[_("div",{children:_(Oh,{connection_terminal_description:"From",wcomponent_id:a&&a.id,connection_terminal_type:t.from_type,on_update_id:T=>y({from_id:T}),on_update_type:T=>y({from_type:T}),exclude_ids:new Set([t.id])})}),_("div",{children:_(Oh,{connection_terminal_description:"To",wcomponent_id:c&&c.id,connection_terminal_type:t.to_type,on_update_id:T=>y({to_id:T}),on_update_type:T=>y({to_type:T}),exclude_ids:new Set([t.id])})}),p&&_("div",{style:{display:"flex",alignItems:"center",flexDirection:"column"},children:_(F,{value:"Reverse Direction",onClick:()=>{y({to_id:t.from_id,from_id:t.to_id})}})})]}),sn(t)&&_(FO,{wcomponent:t,from_wcomponent:a,editing:p,wcomponents_by_id:o,upsert_wcomponent:y}),Ne(t)&&_(zO,{wcomponent:t,editing:p,upsert_wcomponent:y}),ot(t)&&_(p6,{wcomponent:t,upsert_wcomponent:y}),(p||t.label_ids&&t.label_ids.length>0)&&_(et,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(Wn,{component:"legend",children:"Labels"}),_(Wo,{label_ids:t.label_ids,on_change:T=>y({label_ids:T})})]}),Xc(t)&&_(o6,{wcomponent:t,upsert_wcomponent:y}),At(t)&&_(Iq,{editing_allowed:p,wcomponent:t,upsert_wcomponent:y}),_("br",{}),_("br",{}),_(et,{variant:"standard",fullWidth:!0,children:[_(xt,{editing_allowed:p,title:"Created at",invariant_value:t.created_at,value:t.custom_created_at,on_change:T=>{y({custom_created_at:T})}}),_("br",{})]}),p&&_("div",{children:[_("span",{className:"description_label",children:"Label color"}),_(s0,{color:t.label_color,conditional_on_blur:T=>y({label_color:T})})]}),p&&_(c6,{wcomponent:t,upsert_wcomponent:y}),!p&&t.summary_image&&_("div",{children:_("a",{href:t.summary_image,target:"_blank",children:[_(ti,{}),"Open image"]})}),p&&_("div",{children:[_("span",{className:"description_label",children:"Hide node title"}),_(nt,{value:t.hide_title,on_change:T=>y({hide_title:T})}),_("span",{className:"description_label",children:"Hide node state"}),_(nt,{value:t.hide_state,on_change:T=>y({hide_state:T})}),_("hr",{})]}),_(a0,{wcomponent_id:t.id,editing_allowed:p}),_("br",{}),_("br",{}),p&&Jo(t)&&_("div",{children:_(bn,{button_text:"Soft Delete (can undo)",tooltip_text:"Remove from all knowledge views",on_delete:()=>e.delete_wcomponent({wcomponent_id:h})})}),p&&Qc(t)&&_("div",{children:_(F,{title:"Undo delete",onClick:()=>y({deleted_at:void 0}),children:"Restore"})}),_("br",{})]})}const Bq=zq(Lq);function v0(e){return e==="owner"?"Editor (Owner)":e==="editor"?"Editor":e==="viewer"?"Viewer":"Viewer (public access)"}const Uq=e=>({current_knowledge_view:le(e),editing:!e.display_options.consumption_formatting,base_id:mt(e),can_not_edit:Vi(e),access_level:al(e)}),Wq={toggle_consumption_formatting:S.display.toggle_consumption_formatting},Hq=j(Uq,Wq);function Gq(e){const{current_knowledge_view:t,editing:n,can_not_edit:i,base_id:o}=e;return o===void 0?_("div",{class:"create_new_wcomponent",children:"Select a project first."}):i?_("div",{children:[_("p",{children:'Select a component to view it or use the "breadcrumbs" at the top of the page to change to a different project or knowledge view.'}),_("p",{children:["You have '",v0(e.access_level),"' access, so you can view this project but not edit it."]})]}):n?t?_("div",{class:"create_new_wcomponent",children:[_("h3",{children:"Create new component"}),_(Gi,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:ul.map(s=>_(je,{onClick:()=>Yq(o,s),children:Bi(s)}))})]}):_("div",{class:"create_new_wcomponent",children:[_("h3",{children:"Create new component"}),_("p",{children:"Please select a knowledge view first"})]}):_("div",{class:"create_new_wcomponent",children:_(F,{onClick:()=>e.toggle_consumption_formatting(),children:"Swap to editing"})})}const Kq=Hq(Gq);function Yq(e,t){ri({wcomponent:{base_id:e,type:t}})}function Jq(e){const[t,n]=I(0),[i,o]=I(0),s=r=>{e.on_update({change_left:r.change_left?qt(r.change_left):0,change_top:r.change_top?qt(r.change_top):0})};return _("div",{children:[_("p",{style:{fontSize:10,color:"#888"},children:["Increments of ",tt," pixels"]}),"Move right: ",_(rt,{placeholder:"Right",value:t,allow_undefined:!1,on_blur:r=>n(qt(r)),on_blur_type:K.conditional}),_("input",{type:"button",value:"Move",disabled:t===0,onClick:()=>s({change_left:t})}),"  ",_("input",{type:"button",value:"←",onClick:()=>s({change_left:-tt})}),_("input",{type:"button",value:"←←",onClick:()=>s({change_left:-Jn})}),_("input",{type:"button",value:"→→",onClick:()=>s({change_left:Jn})}),_("input",{type:"button",value:"→",onClick:()=>s({change_left:tt})}),_("br",{}),_("br",{}),"Move up: ",_(rt,{placeholder:"Up",value:-i,allow_undefined:!1,on_blur:r=>o(qt(-r)),on_blur_type:K.conditional}),_("input",{type:"button",value:"Move",disabled:i===0,onClick:()=>s({change_top:i})}),"  ",_("input",{type:"button",value:"↑",onClick:()=>s({change_top:-tt})}),_("input",{type:"button",value:"↑↑",onClick:()=>s({change_top:-vn})}),_("input",{type:"button",value:"↓↓",onClick:()=>s({change_top:vn})}),_("input",{type:"button",value:"↓",onClick:()=>s({change_top:tt})})]})}const Xq=e=>{const t=le(e),{selected_wcomponent_ids_set:n}=e.meta_wcomponents,{wcomponents_by_id:i}=e.specialised_objects;return{ready:e.sync.ready_for_reading,selected_wcomponent_ids_set:n,wcomponents_by_id:i,knowledge_view_id:t==null?void 0:t.id,composed_wc_id_map:t==null?void 0:t.composed_wc_id_map,editing:!e.display_options.consumption_formatting}},Zq={bulk_edit_knowledge_view_entries:S.specialised_object.bulk_edit_knowledge_view_entries,bulk_add_to_knowledge_view:S.specialised_object.bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view:S.specialised_object.bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries:S.specialised_object.snap_to_grid_knowledge_view_entries,bulk_edit_wcomponents:S.specialised_object.bulk_edit_wcomponents,upsert_wcomponent:S.specialised_object.upsert_wcomponent},Qq=j(Xq,Zq);function e8(e){if(!e.ready)return _("div",{children:"Loading..."});const{selected_wcomponent_ids_set:t,composed_wc_id_map:n,knowledge_view_id:i,wcomponents_by_id:o,editing:s,bulk_edit_knowledge_view_entries:r,bulk_add_to_knowledge_view:a,bulk_remove_from_knowledge_view:c,snap_to_grid_knowledge_view_entries:l,bulk_edit_wcomponents:d,upsert_wcomponent:p}=e,f=Hv(o,t).filter(ge),m=Array.from(t),h=n8(m,n),v=new Set,g=[];let b;f.forEach(x=>{(x.label_ids||[]).forEach(y=>v.add(y)),sn(x)&&(g.push(x.id),b=b||x.effect_string)});const w=Array.from(v).sort();return m.length===0?_("div",{children:_("h2",{children:"No selected components"})}):_("div",{children:[_("h2",{children:[s?"Bulk editing":"Viewing"," ",m.length," components"]}),s&&_("p",{children:[_("h3",{children:"Position"}),_(Jq,{on_update:x=>{r({wcomponent_ids:m,...x})}})]}),s&&_("p",{children:_(r0,{wcomponent_ids:m})}),(s||w.length>0)&&_("p",{children:[_("h3",{children:"Labels"}),_(Wo,{label_ids:w,on_change:x=>{const y=new Set(x),$=new Set(w.filter(E=>!y.has(E))),C=new Set(x.filter(E=>!v.has(E)));d({wcomponent_ids:m,change:{},remove_label_ids:$,add_label_ids:C})}})]}),s&&g.length>0&&_("p",{children:["Causal Connection Values",_(l0,{effect_string:b,effect_when_true:void 0,effect_when_false:void 0,editing:s,wcomponents_by_id:o,upsert_wcomponent:x=>d({wcomponent_ids:g,change:x})})]}),s&&_("p",{children:["Component types",_(Pe,{placeholder:"Type: ",selected_option_id:void 0,allow_none:!0,options:c0,on_change:x=>{x&&f.forEach(y=>{const C={...O({base_id:y.base_id,type:x}),...y};C.type=x,p({wcomponent:C})})}})]}),s&&_("p",{children:[_("h3",{children:"Created at"}),_(xt,{value:void 0,on_change:x=>d({wcomponent_ids:m,change:{custom_created_at:x}})})]}),s&&_("p",{children:[_("h3",{children:"Add to knowledge view"}),h?"":_("span",{children:[_(nn,{message:"Not all components present in current view so will be added to center of view."}),"Not all components present in current view so will be added to center of view."]}),_(oo,{on_change:x=>{if(!x)return;const y=ye().getState(),$=si(y);a({wcomponent_ids:m,knowledge_view_id:x,default_entry:$})}})]}),s&&_("p",{children:_(bn,{button_text:"Delete from knowledge view",tooltip_text:"Delete from knowledge view",on_delete:()=>{c({wcomponent_ids:m,remove_type:"passthrough"})}})}),s&&_("p",{children:_(bn,{button_text:"Delete and Block from knowledge view",tooltip_text:"Delete and Block from showing in current knowledge view",on_delete:()=>{c({wcomponent_ids:m,remove_type:"block"})}})})]})}const t8=Qq(e8);function n8(e,t){return t?e.find(n=>!t[n])===void 0:!1}const i8=e=>{const{ready_for_reading:t}=e.sync,{bases_by_id:n,chosen_base_id:i}=e.user_info,{sub_route:o,item_id:s}=e.routing,r=Me(e,s),a=e.meta_wcomponents.selected_wcomponent_ids_list;return{bases_by_id:n,chosen_base_id:i,ready_for_reading:t,sub_route:o,item_id:s,wcomponent:r,selected_ids:a,editing:!e.display_options.consumption_formatting,wcomponent_ids_searched_for_in_any_base:e.sync.wcomponent_ids_searched_for_in_any_base}},o8={clear_selected_wcomponents:S.meta_wcomponents.clear_selected_wcomponents,set_or_toggle_display_select_storage:S.controls.set_or_toggle_display_select_storage,request_searching_for_wcomponents_by_id_in_any_base:S.sync.request_searching_for_wcomponents_by_id_in_any_base},s8=j(i8,o8);function r8(e){const{ready_for_reading:t,item_id:n}=e,i=n?!e.wcomponent_ids_searched_for_in_any_base.has(n):!1,o=e.wcomponent,s=e.bases_by_id&&!e.chosen_base_id?0:t?e.sub_route==="wcomponents_edit_multiple"?2:n===null?3:4:1;if(oe(()=>{o||s===4&&n&&e.request_searching_for_wcomponents_by_id_in_any_base({ids:[n]})},[t,s,n,o,i]),s===0)return _("div",{children:_(F,{value:"Choose a project to view",onClick:()=>e.set_or_toggle_display_select_storage(!0)})});if(s===1)return _("div",{children:"Loading..."});if(s===2)return _("div",{children:_(t8,{})});if(s===3)return _("div",{children:[e.selected_ids.length>0&&_("p",{children:[_("div",{style:{display:"inline-flex"},children:[_(kN,{name:`View ${e.selected_ids.length} component(s) already selected`,route:"wcomponents",sub_route:e.selected_ids.length>1?"wcomponents_edit_multiple":void 0,item_id:e.selected_ids.length===1?e.selected_ids[0]:void 0,args:void 0})," ",_(F,{value:"Clear selection",onClick:()=>e.clear_selected_wcomponents()})]}),_("br",{}),_("br",{}),_("hr",{})]}),_(Kq,{})]});if(o){const r=!!e.wcomponent&&e.wcomponent.base_id!==e.chosen_base_id;return _(Bq,{wcomponent:o,wcomponent_from_different_base:r})}return _("div",{children:["Component not found for id: ",n,_("br",{}),_("br",{}),i&&_("div",{children:"Searching in other projects..."}),!i&&_("div",{children:["Not found in other projects (that you have access to).",e.editing&&n&&_(jO,{wcomponent_id:n})]})]})}const _8=s8(r8),a8=e=>({route:e.routing.route}),c8=j(a8);function l8(e){return _("div",{children:[e.route==="filter"&&_(YD,{}),e.route==="select"&&_(tO,{}),e.route==="display"&&_(jD,{}),e.route==="views"&&_(JM,{}),e.route==="wcomponents"&&_(_8,{}),e.route==="about"&&_(SD,{}),e.route==="search"&&_(eO,{})]})}const d8=c8(l8);var Pd={},u8=ee;Object.defineProperty(Pd,"__esModule",{value:!0});var g0=Pd.default=void 0,p8=u8(Q()),m8=te(),f8=(0,p8.default)((0,m8.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");g0=Pd.default=f8;const h8=e=>({display_side_panel:e.controls.display_side_panel}),v8={set_or_toggle_display_side_panel:S.controls.set_or_toggle_display_side_panel},g8=j(h8,v8);function w8(e){return _(ce,{"aria-label":"open side panel",color:"inherit",edge:"end",onClick:()=>e.set_or_toggle_display_side_panel(),size:"small",children:e.display_side_panel?_(g0,{}):_(ed,{})})}const b8=g8(w8);var Id={},y8=ee;Object.defineProperty(Id,"__esModule",{value:!0});var w0=Id.default=void 0,k8=y8(Q()),x8=te(),S8=(0,k8.default)((0,x8.jsx)("path",{d:"M18.99 11.5c.34 0 .67.03 1 .07L20 0 0 20h11.56c-.04-.33-.07-.66-.07-1 0-4.14 3.36-7.5 7.5-7.5zm3.71 7.99c.02-.16.04-.32.04-.49 0-.17-.01-.33-.04-.49l1.06-.83c.09-.08.12-.21.06-.32l-1-1.73c-.06-.11-.19-.15-.31-.11l-1.24.5c-.26-.2-.54-.37-.85-.49l-.19-1.32c-.01-.12-.12-.21-.24-.21h-2c-.12 0-.23.09-.25.21l-.19 1.32c-.3.13-.59.29-.85.49l-1.24-.5c-.11-.04-.24 0-.31.11l-1 1.73c-.06.11-.04.24.06.32l1.06.83c-.02.16-.03.32-.03.49 0 .17.01.33.03.49l-1.06.83c-.09.08-.12.21-.06.32l1 1.73c.06.11.19.15.31.11l1.24-.5c.26.2.54.37.85.49l.19 1.32c.02.12.12.21.25.21h2c.12 0 .23-.09.25-.21l.19-1.32c.3-.13.59-.29.84-.49l1.25.5c.11.04.24 0 .31-.11l1-1.73c.06-.11.03-.24-.06-.32l-1.07-.83zm-3.71 1.01c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"}),"PermDataSetting");w0=Id.default=S8;var Rd={},A8=ee;Object.defineProperty(Rd,"__esModule",{value:!0});var b0=Rd.default=void 0,$8=A8(Q()),C8=te(),T8=(0,$8.default)((0,C8.jsx)("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"}),"Sync");b0=Rd.default=T8;var Dd={},E8=ee;Object.defineProperty(Dd,"__esModule",{value:!0});var Md=Dd.default=void 0,j8=E8(Q()),N8=te(),P8=(0,j8.default)((0,N8.jsx)("path",{d:"M3 12c0 2.21.91 4.2 2.36 5.64L3 20h6v-6l-2.24 2.24C5.68 15.15 5 13.66 5 12c0-2.61 1.67-4.83 4-5.65V4.26C5.55 5.15 3 8.27 3 12zm8 5h2v-2h-2v2zM21 4h-6v6l2.24-2.24C18.32 8.85 19 10.34 19 12c0 2.61-1.67 4.83-4 5.65v2.09c3.45-.89 6-4.01 6-7.74 0-2.21-.91-4.2-2.36-5.64L21 4zm-10 9h2V7h-2v6z"}),"SyncProblem");Md=Dd.default=P8;function y0(e){const{state:t,text:n="Refresh",title:i="Refresh",on_click:o,style:s}=e,r=t==="error";return _("span",{title:i,onClick:o,style:s,children:[n,!r&&_(b0,{className:t==="in_progress"?"animate spinning":""}),r&&_(Md,{})]})}function Ho(e){const{error:t}=e;return t===null?null:t.message.includes("Thanks for registering")&&t.status===400?_("div",{children:"Please check your email"}):_("div",{children:["Error : ",t.message||t]})}function so(e){const{error:t}=e;if(!t)return null;const n=t.message||t;let i=`${n}`;return i==="[object Object]"&&(i=JSON.stringify(n)),_("div",{children:["Error: ",i]})}var Od={},I8=ee;Object.defineProperty(Od,"__esModule",{value:!0});var qd=Od.default=void 0,R8=I8(Q()),D8=te(),M8=(0,R8.default)((0,D8.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"}),"Edit");qd=Od.default=M8;function k0(e){var s;const{users_by_id:t,current_user_id:n,other_user_id:i}=e;let o=((s=t[i])==null?void 0:s.name)||"";return n?o=n===i?"me":o||"(someone else)":o=o||"Someone",_("span",{title:i,children:o})}function O8(e){const{user:t,users_by_id:n,base:i,selected:o,on_click:s,on_click_edit:r}=e,{title:a,access_level:c}=i,l=v0(c);return _("tr",{className:"base_option "+(o?"selected":""),onClick:s,children:[_("td",{className:"narrow",children:_("input",{type:"radio",checked:o,style:{cursor:"pointer"}})}),_("td",{children:a||"(No title)"}),_("td",{children:i.public_read?"Public":"Private"}),_("td",{children:k0({users_by_id:n,current_user_id:t==null?void 0:t.id,other_user_id:i.owner_user_id})}),_("td",{children:l}),_("td",{className:"narrow edit_title",onClick:i.can_edit?d=>{d.stopImmediatePropagation(),r()}:void 0,children:i.can_edit&&_(qd,{})})]})}const q8=e=>({user:e.user_info.user,users_by_id:e.user_info.users_by_id,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}),V8={update_chosen_base_id:S.user_info.update_chosen_base_id},F8=j(q8,V8);function z8(e){const{on_choose:t,on_click_edit:n,user:i,users_by_id:o,chosen_base_id:s,bases_by_id:r,update_chosen_base_id:a}=e,[c,l]=I("initial"),[d,p]=I(void 0);if(!o)return"Loading users...";if(!r)return"Loading projects...";const f=Ke(Object.values(r),m=>m.inserted_at.getTime(),Be.descending);return f.length===0?null:_("div",{style:{margin:10},children:[_(y0,{state:c,title:"Refresh sharing options",on_click:async()=>{l("in_progress");const m=await Mc();l(m.error?"error":"success"),p(m.error)},style:{float:"right"}}),_("h4",{children:"Select a project"}),_(so,{error:d}),_("table",{children:[_("thead",{children:_("tr",{children:[_("th",{}),_("th",{children:"Project Title"}),_("th",{}),_("th",{children:"Owner"}),_("th",{children:"Your Access"}),_("th",{})]})}),_("tbody",{children:f.map(m=>_(O8,{user:i,users_by_id:o,base:m,selected:m.id===s,on_click:()=>{a({base_id:m.id}),t&&t()},on_click_edit:()=>n(m.id)}))})]})]})}const L8=F8(z8);async function B8(e){const t=ke(),{data:n,error:i}=await t.from("access_controls").select().eq("base_id",e);return{access_controls:n?n.map(s=>({...s,inserted_at:new Date(s.inserted_at),updated_at:new Date(s.updated_at)})):void 0,error:i}}async function U8(e){const t={base_id:e.base_id,user_id:e.other_user_id,access_level:e.grant};return await ke().from("access_controls").upsert(t).select()}function x0(e){const t=["editor","viewer","none"];return _(Gh,{variant:"standard",disabled:e.disabled,value:e.current_level,title:e.title||"Select access level",onChange:n=>{const i=n.target.value;e.on_change(i)},children:t.map(n=>_(Kc,{value:n,children:wn(n)}))})}function W8(e){const{access_control:t,base_id:n,users_by_id:i,current_user_id:o,is_owner:s,on_update:r}=e,{user_id:a,access_level:c}=t;if(c==="owner")return null;const l=d=>U8({base_id:n,other_user_id:a,grant:d}).then(r);return _("tr",{children:[_("td",{children:k0({users_by_id:i,current_user_id:o,other_user_id:a})}),_("td",{children:_(x0,{disabled:!s,current_level:c,title:s?"Select access level":"Only owners can edit access levels",on_change:l})}),_("br",{})]})}function H8(e){const[t,n]=I(""),[i,o]=I("editor"),[s,r]=I("initial"),a=s==="in_progress",c=s==="success",[l,d]=I(null),{base_id:p}=e;return _("div",{children:["Share with new user: ",_("br",{}),_("input",{type:"text",placeholder:"User's ID or email",value:t,disabled:a,style:{minWidth:200},onKeyUp:f=>n(f.currentTarget.value),onChange:f=>n(f.currentTarget.value),onBlur:f=>n(f.currentTarget.value)}),"  ",_(x0,{current_level:i,on_change:o}),_("br",{}),a&&_("span",{children:"Adding..."}),c&&_("span",{children:"Added."}),_(so,{error:l}),_("br",{}),t&&_("input",{type:"button",onClick:async()=>{r("in_progress");const m=await ke().rpc("invite_user_to_base",{base_id:p,email_or_uid:t,access_level:i}),{status:h,error:v}=m;d(v),r(v?"error":"success"),v||(n(""),e.on_add_or_exit(!0))},value:"Add user",disabled:!t}),"  ",_("input",{type:"button",onClick:()=>e.on_add_or_exit(!1),value:"Back"})]})}const G8=e=>({users_by_id:e.user_info.users_by_id}),K8=j(G8);function Y8(e){const{user:t,base:n,on_save_or_exit:i,users_by_id:o}=e,[s,r]=I("initial"),[a,c]=I(void 0),[l,d]=I(void 0),p=n.owner_user_id===t.id;function f(){r("in_progress"),B8(n.id).then(m=>{r(m.error?"error":"success"),c(m.access_controls),d(m.error||void 0),!m.error&&U.user.pub("stale_users_by_id",!1)})}return oe(()=>f(),[]),o?_("div",{children:[_(y0,{state:s,title:"Refresh sharing options",on_click:()=>f(),style:{float:"right"}}),_("h4",{children:"Sharing options"}),_(so,{error:l}),a&&_("div",{children:[a.length===0&&"Not shared with anyone yet",a.length>0&&_("table",{className:"access_controls_table",children:_("tbody",{children:a.map(m=>_(W8,{access_control:m,base_id:n.id,users_by_id:o,current_user_id:t.id,is_owner:p,on_update:h=>{d(h.error||void 0),h.error||f()}}))})}),_("br",{})]}),!p&&_("div",{children:"Sharing with new users (Only owners can do this for now)"}),p&&_(H8,{base_id:n.id,on_add_or_exit:m=>{m?f():i()}})]}):_("div",{children:"Fetching users..."})}const J8=K8(Y8);function X8(e){const{base:t,on_save_or_exit:n,user:i}=e,[o,s]=I(t);oe(()=>s(t),[t]);const[r,a]=I(void 0),c=t.owner_user_id===i.id,l=JSON.stringify(t)!==JSON.stringify(o),d=!!o.title;function p(f,m){let h=f.currentTarget.value;m&&(h=h.trim()),s({...o,title:h})}return c?_("div",{children:[_("h4",{children:"Edit project"}),"Title   ",_("input",{type:"text",placeholder:"title",value:o.title,onChange:f=>p(f,!1),onBlur:f=>p(f,!0)}),_("br",{}),_("br",{}),"Visibility   ",_("input",{type:"button",onClick:()=>{s({...o,public_read:!o.public_read})},value:o.public_read?"Make private":"Publish (make public)"}),_("br",{}),_("br",{}),"Default view   ",_(oo,{selected_option_id:o.default_knowledge_view_id??void 0,on_change:f=>{s({...o,default_knowledge_view_id:f})},editing_allowed:!0}),_("br",{}),_("br",{}),_("div",{children:[l&&d&&_("input",{type:"button",disabled:!d,onClick:async()=>{const f=await aC(o);if(f.error)return a(f.error);a(void 0),U.user.pub("stale_bases",!1)},value:"Save changes"}),"  ",_("input",{type:"button",onClick:n,value:l?"Cancel":"Back"}),_("br",{}),_(so,{error:r})]}),_("br",{}),_("hr",{})]}):null}const Z8=e=>({user:e.user_info.user}),Q8=j(Z8);function eV(e){const{base:t,on_save_or_exit:n,user:i}=e;return i?_("div",{style:{margin:10},children:[_(X8,{user:i,base:t,on_save_or_exit:n}),_(J8,{user:i,base:t,on_save_or_exit:n})]}):"Please sign in"}const tV=Q8(eV),nV=e=>({user:e.user_info.user,users_by_id:e.user_info.users_by_id,bases_by_id:e.user_info.bases_by_id}),iV={update_chosen_base_id:S.user_info.update_chosen_base_id},oV=j(nV,iV);function sV(e){const{on_close:t,user:n,users_by_id:i,bases_by_id:o,update_chosen_base_id:s}=e,[r,a]=I(""),[c,l]=I("initial"),[d,p]=I(void 0),[f,m]=I(void 0);if(!i)return"Loading users...";if(!o)return"Loading projects...";const h=n==null?void 0:n.id,v=Object.keys(o).length,g=h===void 0?void 0:async function(){l("in_progress");const b=await rC({owner_user_id:h,title:r.trim()});l(b.error?"error":"success"),m(b.base),b.error||(U.user.pub("stale_bases",!1),a(""))};return d!==void 0?_("div",{style:{margin:10},children:_(tV,{base:o[d],on_save_or_exit:()=>p(void 0)})}):_("div",{style:{margin:10},children:[_(L8,{on_choose:t,on_click_edit:b=>p(b)}),v>0&&g&&_("hr",{}),g&&_("div",{children:[_("h4",{children:["Create ",v?"a new":"your first"," project"]}),_("input",{type:"text",value:r,onKeyUp:b=>a(b.currentTarget.value),onChange:b=>a(b.currentTarget.value),onBlur:b=>a(b.currentTarget.value)}),_("br",{}),_("input",{type:"button",disabled:!r.trim()||c==="in_progress",onClick:g,value:"Create new project"}),"  ",_V(c),"  ",f&&_("input",{type:"button",onClick:()=>{s({base_id:f.id}),t&&t()},value:"Select new project"})]})]})}const rV=oV(sV);function _V(e){return e==="initial"?"":e==="in_progress"?"Creating...":e==="success"?"Created.":"Error"}function aV(e){const{on_close:t}=e;return _(di,{title:_("div",{style:{margin:10},children:_("h2",{style:{display:"inline"},children:"Projects"})}),size:"medium",on_close:t&&(n=>{n==null||n.stopImmediatePropagation(),t()}),child:_(rV,{on_close:t})})}const cV=e=>({base_name:fS(e),needs_to_create_a_base:Ng(e),display_select_storage:e.controls.display_select_storage}),lV={set_or_toggle_display_select_storage:S.controls.set_or_toggle_display_select_storage},dV=j(cV,lV);function uV(e){const{needs_to_create_a_base:t,display_select_storage:n,set_or_toggle_display_select_storage:i}=e;return oe(()=>{t&&i(!0)},[t]),_(ae,{component:"span",children:[_(je,{id:"storage_info_button",color:"primary",disableElevation:!0,onClick:()=>i(!0),size:"small",endIcon:_(w0,{titleAccess:"Create and Select Projects"}),style:{textTransform:"none"},variant:"contained",children:_("span",{class:"storage_name",children:e.base_name||"Choose store"})}),n&&_(aV,{on_close:t?void 0:()=>i(!1)})]})}const pV=dV(uV);var Vd={},mV=ee;Object.defineProperty(Vd,"__esModule",{value:!0});var S0=Vd.default=void 0,fV=mV(Q()),hV=te(),vV=(0,fV.default)((0,hV.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"}),"Save");S0=Vd.default=vV;const gV=e=>({sync_state_specialised_objects:e.sync.specialised_objects,sync_state_bases:e.sync.bases,ready_for_writing:e.sync.ready_for_writing}),wV={update_sync_status:S.sync.update_sync_status},bV=j(gV,wV);function yV(e){const{sync_state_specialised_objects:t,sync_state_bases:n,ready_for_writing:i}=e,o=t.status==="FAILED"||n.status==="FAILED",s=t.status==="LOADING"||n.status==="LOADING",r=t.status==="SAVING"||n.status==="SAVING",a=[t.error_message,n.error_message].filter(ge).join(", "),c=s||r,l=xV();let d=wn(t.status||"");return n.status&&n.status!=="LOADED"&&n.status!=="SAVED"&&(d+=n.status!==t.status&&", "+wn(n.status)||""),d?_(ae,{component:"span",children:_(je,{className:l.button,size:"small",disabled:!i,onClick:async p=>{p.currentTarget.blur();const f=ye();await zg(f,!0)},startIcon:o?_(Md,{color:"error"}):_(S0,{className:c?"animate spinning":""}),title:o?a:d,children:[_(ae,{className:`${l.animate} ${l.initially_shown} show`,color:o?"error":"initial",component:"span",noWrap:!0,children:o?"Failed!":d}),_(ae,{className:`${l.animate} ${l.initially_hidden} hide`,color:"initial",component:"span",noWrap:!0,children:o?"Retry Now":"Save Now"}),_(ae,{component:"span",children:" "})]})}):null}const kV=bV(yV),xV=Ct(e=>({button:{textTransform:"none","&:hover .show":{fontSize:0},"&:focus .show":{fontSize:0},"&:hover .hide":{fontSize:"initial"},"&:focus .hide":{fontSize:"initial"}},animate:{transitionProperty:"all",transitionDuration:"0.23s"},initially_hidden:{fontSize:0},initially_shown:{fontSize:"initial"}}));var Fd={},SV=ee;Object.defineProperty(Fd,"__esModule",{value:!0});var A0=Fd.default=void 0,AV=SV(Q()),$V=te(),CV=(0,AV.default)((0,$V.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"}),"AccountCircle");A0=Fd.default=CV;const TV="(No user name)";var zd={},EV=ee;Object.defineProperty(zd,"__esModule",{value:!0});var $0=zd.default=void 0,jV=EV(Q()),NV=te(),PV=(0,jV.default)((0,NV.jsx)("path",{d:"M10.09 15.59 11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"ExitToApp");$0=zd.default=PV;const IV=e=>{const{need_to_handle_password_recovery:t}=e.user_info;return{user:e.user_info.user,need_to_handle_password_recovery:t}},RV={set_user:S.user_info.set_user,set_need_to_handle_password_recovery:S.user_info.set_need_to_handle_password_recovery},DV=j(IV,RV);function MV(e){const{on_close:t,user:n,set_user:i,need_to_handle_password_recovery:o,set_need_to_handle_password_recovery:s}=e,[r,a]=I(""),[c,l]=I(null);if(!n)return null;async function d(){const f=ke(),m=n==null?void 0:n.email,h=await f.auth.updateUser({email:m,password:r});l(h.error),h.error||(i({user:h.data.user}),s(!1),t())}const p=OV();return _(Kh,{className:"section",children:[o&&_("p",{children:"Please set a new password."}),_(R,{className:p.root,children:[_(et,{variant:"standard",children:_(kn,{inputProps:{type:"password"},onBlur:f=>a(f.currentTarget.value),onChange:f=>a(f.currentTarget.value),onKeyUp:f=>a(f.currentTarget.value),label:"password",size:"small",value:r,variant:"outlined"})}),_(R,{className:p.update_button_container,children:_(je,{className:p.update_button,disabled:!n.email||!r,onClick:d,variant:"contained",children:"Update password"})}),_(R,{children:!o&&_(je,{variant:"contained",onClick:()=>{t(),l(null)},children:"Cancel"})})]}),_(Ho,{error:c})]})}const OV=Ct(()=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),qV=DV(MV),VV=e=>{const{user:t,users_by_id:n}=e.user_info;return{user:t,users_by_id:n,need_to_set_user_name:_l(e)}},FV={},zV=j(VV,FV);function LV(e){const{on_close:t,user:n,need_to_set_user_name:i}=e,[o,s]=I(""),r=(e.users_by_id||{})[(n==null?void 0:n.id)||""],a=(r==null?void 0:r.name)||"";oe(()=>s(a),[a]);const[c,l]=I("initial"),d=c==="in_progress",[p,f]=I(null);if(!n)return null;const{id:m}=n;async function h(){var y;const g=ke();l("in_progress");const{data:b,error:w}=await g.from("users").upsert({id:m,name:o}).eq("id",m).select();f(w),((b&&((y=b[0])==null?void 0:y.name))??void 0)&&U.user.pub("stale_users_by_id",!0),l(w?"error":"success")}const v=BV();return _(Kh,{className:"section",children:[_(R,{className:v.root,children:[_(et,{variant:"standard",children:_(kn,{disabled:d,onChange:g=>{s(g.currentTarget.value)},onBlur:g=>{s(g.currentTarget.value)},placeholder:"Username",size:"small",value:o,variant:"outlined"})}),_(R,{className:v.update_button_container,children:_(je,{className:v.update_button,disabled:!o||d,onClick:h,variant:"contained",children:[i?"Set":"Change"," username"]})}),_(R,{children:!i&&_(je,{variant:"contained",onClick:()=>{t(),f(null)},children:"Close"})})]}),d&&"Saving...",c==="success"&&"Saved.",_(so,{error:p})]})}const BV=Ct(e=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},username_input:{borderTopRightRadius:0,borderBottomRightRadius:0},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),UV=zV(LV),WV=e=>{const{need_to_handle_password_recovery:t}=e.user_info;return{user:e.user_info.user,user_name:es(e),need_to_set_user_name:_l(e),need_to_handle_password_recovery:t}},HV={set_user:S.user_info.set_user},GV=j(WV,HV),KV=Ct(e=>({root:{margin:5},section:{display:"flex",justifyContent:"space-between",alignItems:"center"},logout_section:{flexBasis:"100%"},button:{marginBottom:5},label:{marginBottom:10}}));function YV(e){const{user:t,user_name:n,need_to_set_user_name:i,need_to_handle_password_recovery:o,set_user:s}=e,[r,a]=I("initial"),[c,l]=I(null);if(console.log("user account info form need_to_set_user_name",i,"form_state",r),oe(()=>{i&&a("updating_username")},[i,r]),!t)return null;if(r==="updating_password"||o)return _(qV,{on_close:()=>a("initial")});if(r==="updating_username")return _(UV,{on_close:()=>a("initial")});const d=KV();return _(R,{className:d.root,children:[_(R,{className:`${d.section} ${d.logout_section} section`,children:[_("p",{children:["Logged in with",_("strong",{children:[" ",t.email," "]})]}),_(R,{children:_(je,{onClick:()=>Hg(!0),variant:"contained",endIcon:_($0,{}),children:"Log out"})})]}),_(R,{className:`${d.section} section`,display:"flex",justifyContent:"space-between",children:[_(ae,{component:"p",children:["User name ",_("strong",{children:n?`: ${n}`:""}),_("br",{}),_("small",{children:["user id:   ",t.id]})]}),_(R,{children:[_(je,{className:d.button,variant:"contained",onClick:()=>a("updating_username"),children:[i?"Set":"Change"," username"]}),_("br",{}),_(je,{variant:"contained",onClick:()=>a("updating_password"),children:"Change password"})]})]}),_(Ho,{error:c})]})}const JV=GV(YV);function XV(e){const{on_close:t}=e;return _(di,{title:_("div",{style:{margin:10,textAlign:"center"},children:_("h2",{children:"User Account"})}),size:"medium",on_close:t?n=>{n==null||n.stopImmediatePropagation(),t()}:void 0,child:_("div",{style:{textAlign:"center"},children:_(JV,{on_close:t})})})}const ZV={set_user:S.user_info.set_user},QV=j(null,ZV);function eF(e){const{set_user:t}=e,n=ke(),[i,o]=I("initial"),[s,r]=I(""),[a,c]=I(""),[l,d]=I(null),[p,f]=I(!1),[m,h]=I(!1);function v(y){r(y),f(!1)}function g(y){c(y),h(!1)}async function b(){if(!s||!a){s||f(!0),a||h(!0);return}const{error:y}=await n.auth.signUp({email:s,password:a,options:{emailRedirectTo:"https://datacurator.org/app/"}});d(y),y||o("registered")}async function w(){if(!s||!a){s||f(!0),a||h(!0);return}const{data:{user:y},error:$}=await n.auth.signInWithPassword({email:s,password:a});d($),t({user:y||void 0})}async function x(){if(!s){f(!0),h(!1);return}const{error:y}=await n.auth.resetPasswordForEmail(s);d(y),y||o("reset_password")}return i==="initial"?_("div",{className:"section",children:[_("form",{children:[_("br",{}),_("br",{}),_("input",{type:"email",placeholder:"email",value:s,onKeyUp:y=>v(y.currentTarget.value),onChange:y=>v(y.currentTarget.value),onBlur:y=>v(y.currentTarget.value)}),_("div",{className:"error_form_input_empty "+(p?"":"inactive"),children:"Email required"}),_("br",{}),_("input",{type:"password",placeholder:"password",value:a,onKeyUp:y=>g(y.currentTarget.value),onChange:y=>g(y.currentTarget.value),onBlur:y=>g(y.currentTarget.value)}),_("div",{className:"error_form_input_empty "+(m?"":"inactive"),children:"Password required"})]}),_("div",{children:[_("br",{}),_("input",{type:"button",onClick:w,value:"Signin"}),"  ",_("input",{type:"button",onClick:b,value:"Register"}),_("br",{}),_("br",{}),_("input",{type:"button",onClick:x,value:"Forgot password?"}),_("br",{}),_("br",{})]}),_(Ho,{error:l}),_("br",{})]}):i==="reset_password"?_("div",{className:"section",children:[_("h3",{children:"Password reset"}),_("br",{}),!l&&"Please check your email",_(Ho,{error:l})]}):_("div",{className:"section",children:[_("h3",{children:"Registered"}),_("br",{}),"Please check your email"]})}const tF=QV(eF);function nF(e){return _(di,{title:_("div",{style:{margin:10,textAlign:"center"},children:_("h2",{children:"Signin / Register"})}),size:"medium",on_close:e.on_close,child:_("div",{style:{textAlign:"center"},children:_(tF,{})})})}const iF=e=>({user:e.user_info.user,bases_by_id:e.user_info.bases_by_id,users_by_id:e.user_info.users_by_id,chosen_base_id:e.user_info.chosen_base_id,user_name:es(e),need_to_set_user_name:_l(e)}),oF={},sF=j(iF,oF);function rF(e){const{user:t,bases_by_id:n,users_by_id:i,chosen_base_id:o,user_name:s,need_to_set_user_name:r}=e,a=!i,[c,l]=I("hidden"),d=Ee(t),p=s||TV;return oe(()=>{const f=!d.current&&t;d.current=t;const m=n&&o?!n[o]:!1;l(!t&&m?"signin":a?"loading":r?"account_info":f?"hidden":c)},[t,n,o,a,r]),_("div",{children:[_(je,{color:"primary",endIcon:_(A0,{}),fullWidth:!0,disableElevation:!0,onClick:()=>l(t?"account_info":"signin"),size:"small",style:{textTransform:"none"},variant:"contained",children:_(ae,{noWrap:!0,children:t?p:a?"Loading":"Sign in"})}),c==="signin"&&_(nF,{on_close:()=>l("hidden")}),c==="account_info"&&_(XV,{on_close:r?void 0:()=>l("hidden")})]})}const _F=sF(rF);var Ld={},aF=ee;Object.defineProperty(Ld,"__esModule",{value:!0});var C0=Ld.default=void 0,cF=aF(Q()),lF=te(),dF=(0,cF.default)((0,lF.jsx)("path",{d:"M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16.02H3V4.98h18v14.04zM10 12H8l4-4 4 4h-2v4h-4v-4z"}),"PresentToAll");C0=Ld.default=dF;const uF=e=>{const t=al(e),n=Vi(e);return{presenting:e.display_options.consumption_formatting,access_level:t,can_not_edit:n}},pF={toggle_consumption_formatting:S.display.toggle_consumption_formatting,change_route:S.routing.change_route},mF=j(uF,pF);function fF(e){const{access_level:t,can_not_edit:n}=e,i=!e.presenting,[o,s]=I(void 0),r=Ee(!1);oe(()=>{t!==void 0&&(r.current||(r.current=!0,s(n)))},[t]);const a=n?"No editing rights":"",c=n?e.presenting?"rgba(183, 28, 26, 0.5)":"rgba(183, 28, 26)":"",l=Sy();return _(Gi,{size:"small",children:[_(ze,{title:a,"aria-label":a,children:_(ce,{className:l.inverse_disabled,disabled:i,onClick:i?void 0:e.toggle_consumption_formatting,value:"editing",size:"large",children:_(qd,{style:{color:c}})})}),_(ce,{className:l.inverse_disabled,disabled:e.presenting,onClick:e.toggle_consumption_formatting,value:"presenting",size:"large",children:_(C0,{})})]})}const hF=mF(fF),vF=e=>{const t=e.routing.args.subview_id;return{ready_for_reading:e.sync.ready_for_reading,presenting:e.display_options.consumption_formatting,view:e.routing.args.view,kv_id:t,nested_kv_ids_map:e.derived.nested_knowledge_view_ids}},gF={toggle_consumption_formatting:S.display.toggle_consumption_formatting,change_route:S.routing.change_route},wF=j(vF,gF);function bF(e){if(!e.ready_for_reading)return null;const{kv_id:t,nested_kv_ids_map:n}=e;let i=n.map[t];const o=[];let s=Zl;for(;i;){const c=i.child_ids.map(l=>n.map[l]).filter(ge);if(c.length){const l=c.map(Vh);o.unshift({options:l,selected_id:s,parent_id:i.id})}s=i.id,i=i.parent_id!==void 0?n.map[i.parent_id]:void 0}const r=n.top_ids.map(c=>n.map[c]).filter(ge).map(Vh);o.unshift({options:r,selected_id:s,parent_id:void 0});const a=e.view!=="knowledge"||xF.length>1;return _(o1,{style:{marginTop:"8px"},children:[a&&_(R,{children:_(Gh,{variant:"standard",label:_(ae,{noWrap:!0,children:"View Type:"}),name:"select_view",value:e.view,children:T0.map(c=>_(Kc,{value:c.id,selected:c.id===e.view,disabled:!c.selectable,onPointerDown:l=>{l.stopImmediatePropagation(),e.change_route({args:{view:c.id}})},children:c.title}))})}),o.map(c=>_(R,{children:_(Pe,{allow_none:c.parent_id!==void 0,selected_option_id:c.selected_id,options:c.options,on_change:l=>e.change_route({args:{subview_id:l||c.parent_id}}),on_choose_same:l=>e.change_route({args:{subview_id:l||c.parent_id}}),editing_allowed:!0,threshold_minimum_score:!1,retain_options_order:!0})}))]})}const yF=wF(bF),kF=Ot.get_state(),T0=[{id:"knowledge",title:"Knowledge",selectable:!0},{id:"actions_list",title:"Actions list",selectable:kF.enable_action_kanban_view}],xF=T0.filter(e=>e.selectable);function Vh(e){const t=e.sort_type==="hidden"||e.sort_type==="archived"||e.sort_type==="errored",n=e.sort_type==="errored"?SF:void 0;return{id:e.id,title:e.title,is_hidden:t,color:n}}const SF={r:231,g:190,b:201,a:1},AF=e=>({display_side_panel:e.controls.display_side_panel,animate_connections:e.display_options.animate_connections,network_functional:e.sync.network_functional,network_function_last_checked:e.sync.network_function_last_checked}),$F=j(AF);function CF(e){return oe(()=>{e.network_functional||setTimeout(()=>{Kg(ye())},1e3)},[e.network_functional,e.network_function_last_checked]),_(Ac,{injectFirst:!0,children:_($c,{theme:Bh,children:[_(s1,{}),_(EF,{...e})]})})}const TF=$F(CF);function EF(e){const t=jF();return _(ue,{children:[!e.network_functional&&_(di,{title:"",size:"small",child:_(R,{children:[_(ae,{id:"modal-modal-title",variant:"h6",component:"h2",children:"Reconnecting..."}),_(ae,{id:"modal-modal-description",sx:{mt:2},children:["Last attempt: ",Ln({date:e.network_function_last_checked,time_resolution:"second"})]})]})}),_(yD,{}),_(R,{id:"app",className:t.root,children:[_(r1,{elevation:1,id:"header",position:"fixed",className:"app_header "+t.app_bar,children:_(Hh,{variant:"dense",className:t.toolbar,children:[_(R,{className:`${t.toolbar_section} ${t.grow} ${t.small_full_width}`,children:[_(R,{className:`${t.toolbar_item}`,children:_(hF,{})}),_(R,{className:`${t.toolbar_item} ${t.grow}`,children:_(yF,{})})]}),_(R,{className:`${t.toolbar_section} ${t.small_full_width}`,justifyContent:"flex-end",children:[_(R,{className:`${t.toolbar_item}`,children:[_(rd,{}),_($y,{})]}),_(R,{className:`${t.toolbar_item}`,children:_(wD,{})}),_(R,{className:`${t.toolbar_item}`,children:_(kV,{})}),_(R,{className:`${t.toolbar_item}`,children:_(pV,{})}),_(R,{className:`${t.toolbar_item}`,children:_(_F,{})}),_(R,{className:`${t.toolbar_item}`,children:_(b8,{})})]})]})}),_(R,{id:"app_content",component:"div",className:_1(t.content,{[t.content_with_open_side_panel]:e.display_side_panel,animate_connections:e.animate_connections}),children:_(gD,{})}),_(a1,{anchor:"right",className:t.drawer,open:e.display_side_panel,variant:"persistent",children:_(R,{component:"aside",className:t.side_panel,id:"side_panel",children:_(R,{id:"side_panel_content",className:t.side_panel_content,children:[_(SP,{}),_(d8,{})]})})}),_(R,{className:t.help_popup,children:_(tP,{})})]})]})}const jF=Ct(e=>({root:{width:"100%",height:"100%",overflow:"hidden",display:"flex"},app_bar:{transition:e.transitions.create(["all"],{easing:e.transitions.easing.sharp,duration:e.transitions.duration.leavingScreen}),zIndex:e.zIndex.drawer+1},app_bar_with_open_side_panel:{},content:{width:"100%",flexGrow:1,display:"flex",marginRight:-Ri,transition:e.transitions.create(["margin"],{easing:e.transitions.easing.sharp,duration:e.transitions.duration.leavingScreen})},content_with_open_side_panel:{marginRight:0,transition:e.transitions.create(["margin"],{easing:e.transitions.easing.easeOut,duration:e.transitions.duration.enteringScreen})},drawer:{width:Ri,flexShrink:0},side_panel:{backgroundColor:e.palette.background.paper,width:Ri,position:"relative",paddingTop:50},side_panel_content:{marginTop:10,padding:10},sidebar_toolbar:{flexGrow:1,justifyContent:"flex-end"},toolbar:{flexGrow:1,justifyContent:"space-between",flexWrap:"wrap",[e.breakpoints.up("md")]:{flexWrap:"nowrap"}},toolbar_section:{display:"inherit",flexGrow:0,flexShrink:1,flexBasis:"auto",marginRight:5,"&:last-child":{marginRight:0},"&:empty":{display:"none"}},toolbar_item:{marginRight:5,"&:last-child":{marginRight:0}},help_popup:{position:"relative",zIndex:e.zIndex.drawer+1},small_full_width:{[e.breakpoints.down("md")]:{flexGrow:0,flexShrink:1,flexBasis:"100%",margin:0}},grow:{flexGrow:1},hide:{display:"none"},warning_icon:{color:e.palette.warning.main}}));GN();function Bd(e=!1){const n=xs().derived.current_composed_knowledge_view;if(e&&!n)throw new Error("Lacking current_composed_knowledge_view");return n}function ks(){return xs().specialised_objects.wcomponents_by_id}function E0(e={}){const t=Bd(!0),n=ks(),{causal_only:i=!0}=e,o=new Set(Object.keys(t.composed_visible_wc_id_map)),a=Array.from(i?t.wc_ids_by_type.causal_link:t.wc_ids_by_type.any_link).filter(d=>o.has(d)).map(d=>n[d]).filter(Ne).filter(d=>d.from_id&&d.to_id).filter(d=>n[d.from_id]&&n[d.to_id]),c=new Set,l={};return a.forEach(d=>{c.add(d.from_id),c.add(d.to_id);const p=l[d.from_id]||{};l[d.from_id]=p;const f=p[d.to_id]||[];p[d.to_id]=f;let m=1;sn(d)&&(m=d.effect_when_true??1),f.push(m)}),{node_ids_connections_map:l,node_ids:c}}function NF(e={}){const{node_ids_connections_map:t,node_ids:n}=E0(e),i=[],o=[""];return i.push(o),Array.from(n).forEach(s=>o.push(s)),Array.from(n).forEach(s=>{const r=[s];Array.from(n).forEach(a=>{const c=(t[a]||{})[s]||[];r.push(c)}),i.push(r)}),i}function PF(){const e=Bd(!0),t=ks(),i=Object.keys(e.composed_visible_wc_id_map).map(s=>t[s]).filter(ge),o={};return i.forEach(s=>{!s.label_ids||s.label_ids.length===0||(o[s.id]=s.label_ids)}),o}function IF(){const e=ks(),t=PF(),n={},i={};return Object.entries(t).forEach(([o,s])=>{const r=s.map(a=>{const c=e[a];if(!c)return"";const l=n[a]||c.title;return n[a]=l,l});i[o]=r}),i}function j0(e,t){return e.map(i=>i.map(o=>typeof o!="string"?o:o?t(o):""))}function RF(e,t){const n={},i={};return j0(t,s=>{let r=n[s]||"";if(!r){r=(e[s]||[]).join(",");const c=(i[r]||0)+1;i[r]=c,r+=`_${c}`,n[s]=r}return r})}function DF(e,t){return j0(t,i=>{var o;return((o=e[i])==null?void 0:o.title)||""})}function MF(e){const t=[];return e.forEach(n=>{const i=[];n.forEach(o=>{typeof o=="string"?i.push(o):o.length===0?i.push(""):o.length===1?i.push((o[0]||0).toString()):i.push(JSON.stringify(o))}),t.push(i.join(",")+`
`)}),t.join("")}function OF(){return{get_connection_map:E0,get_connection_matrix:NF,get_component_id_to_label_names_map:IF}}function qF(){const e=xs(),t=e.routing.item_id||"";return e.specialised_objects.wcomponents_by_id[t]}function VF(){const e=xs();return e.meta_wcomponents.selected_wcomponent_ids_list.map(t=>Me(e,t)).filter(sv)}function FF(){const e={get_current_visible_graph:OF,matrix_component_ids_to_labels:RF,matrix_component_ids_to_titles:DF,matrix_to_csv:MF,get_current_kv:Bd,get_wcomponents_by_id:ks,create_wcomponent:ri,get_current_wcomponent:qF,get_selected_wcomponents:VF};window.console_api=e}function xs(){return window.debug_state}const Sc=document.getElementById("root");if(Sc){Sc.innerText="";const e=ye({load_state_from_storage:!0});m1(_(f1,{store:e,children:_(TF,{})}),Sc)}Fh();KS();FF();
