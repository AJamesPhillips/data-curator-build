var ln=Object.defineProperty;var dn=(t,ee,te)=>ee in t?ln(t,ee,{enumerable:!0,configurable:!0,writable:!0,value:te}):t[ee]=te;var Oe=(t,ee,te)=>(dn(t,typeof ee!="symbol"?ee+"":ee,te),te);import{r as requireCreateSvgIcon,g as get_supabase,s as set_window_title,A as APP_DETAILS,a as get_persisted_state_object,p as persist_state_object,t as time_scale_days_to_ms_pixels_fudge_factor,W as WarningTheme,D as DefaultTheme}from"./set_window_title-fb6829c5.js";import{h as h$1,b as _$d,F as F$1,m as connect,s as sn,c as y$1,n as createStore,d as k$1,p as p$1,o as b$1,r as FlexSearch,t as fuzzysort,M as Model,u as commonjsGlobal,v as commonjsRequire,w as getDefaultExportFromCjs,P as Provider,D as D$1}from"./common_libraries-bfebe378.js";import{o as o$1,i as interopRequireDefaultExports,r as requireJsxRuntime,c as Card,d as CardMedia,e as CardContent,b as Button$2,B as Box,f as Tooltip,I as IconButton,H as Hidden,g as TextField,h as ButtonGroup,j as Slider,m as makeStyles,k as Collapse,l as Toolbar,y as yellow,A as Accordion,n as AccordionSummary,a as Typography,p as AccordionDetails,F as FormControl,q as FormLabel,R as RadioGroup,s as FormControlLabel,t as Radio,M as MenuItem,u as Menu$1,S as StyledEngineProvider,T as ThemeProvider,D as Dialog,v as DialogTitle,w as DialogContent,x as DialogActions,z as ArrowUpward$1,E as ArrowDownward$1,G as DeleteIcon,J as SettingsIcon,K as Select,L as Breadcrumbs,N as FormGroup,O as withStyles,P as Badge,Q as CssBaseline,U as AppBar,V as clsx,W as Drawer,C as Container}from"./common_style_libraries-bc88b241.js";function _mergeNamespaces(t,ee){for(var te=0;te<ee.length;te++){const ne=ee[te];if(typeof ne!="string"&&!Array.isArray(ne)){for(const oe in ne)if(oe!=="default"&&!(oe in t)){const ie=Object.getOwnPropertyDescriptor(ne,oe);ie&&Object.defineProperty(t,oe,ie.get?ie:{enumerable:!0,get:()=>ne[oe]})}}}return Object.freeze(Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}))}const App$2="",WComponentCanvasConnection$1="",CanvasConnnection$1="",rads={_0:0,_5:.08726646259971647,_10:.17453292519943295,_15:.2617993877991494,_20:.3490658503988659,_25:.4363323129985824,_30:.5235987755982988,_35:.6108652381980153,_40:.6981317007977318,_45:.7853981633974483,_50:.8726646259971648,_55:.9599310885968813,_60:1.0471975511965976,_65:1.1344640137963142,_70:1.2217304763960306,_75:1.3089969389957472,_80:1.3962634015954636,_85:1.48352986419518,_90:1.5707963267948966,_95:1.6580627893946132,_100:1.7453292519943295,_105:1.8325957145940461,_110:1.9198621771937625,_115:2.007128639793479,_120:2.0943951023931953,_125:2.1816615649929116,_130:2.2689280275926285,_135:2.356194490192345,_140:2.443460952792061,_145:2.530727415391778,_150:2.6179938779914944,_155:2.705260340591211,_160:2.792526803190927,_165:2.8797932657906435,_170:2.96705972839036,_175:3.0543261909900767,_180:3.141592653589793,_185:3.2288591161895095,_190:3.3161255787892263,_195:3.4033920413889422,_200:3.490658503988659,_205:3.5779249665883754,_210:3.6651914291880923,_215:3.752457891787808,_220:3.839724354387525,_225:3.9269908169872414,_230:4.014257279586958,_235:4.101523742186674,_240:4.1887902047863905,_245:4.276056667386108,_250:4.363323129985823,_255:4.4505895925855405,_260:4.537856055185257,_265:4.625122517784973,_270:4.71238898038469,_275:4.799655442984406,_280:4.886921905584122,_285:4.974188368183839,_290:5.061454830783556,_295:5.148721293383272,_300:5.235987755982989,_305:5.323254218582705,_310:5.410520681182422,_315:5.497787143782138,_320:5.585053606381854,_325:5.672320068981571,_330:5.759586531581287,_335:5.846852994181004,_340:5.93411945678072,_345:6.021385919380437,_350:6.1086523819801535,_355:6.19591884457987};function get_angle(t,ee,te,ne){const oe=ne-ee,ie=te-t;return Math.atan2(oe,ie)}const TWO_PI=Math.PI*2;function normalise_angle_between_neg_Pi_and_Pi(t){return t+TWO_PI*Math.floor((Math.PI-t)/TWO_PI)}function to_vec(t,ee){const te=ee*Math.cos(t),ne=ee*Math.sin(t);return{x:te,y:ne}}function add_vec(t,ee){return{x:t.x+ee.x,y:t.y+ee.y}}var ConnectionEndType=(t=>(t[t.positive=0]="positive",t[t.negative=1]="negative",t[t.noop=2]="noop",t))(ConnectionEndType||{});function ConnectionEnd(t){const{type:ee,x:te,y:ne,end_angle:oe,opacity:ie,blur:se,size:re,is_hovered:_e,is_highlighted:ae}=t;let ce=`${ae?"highlighted":""} ${_e?"hovered":""}`;const le=ie*(1-se/100),ue={fillOpacity:le};let de;ee===0?de=get_connection_arrow_end(oe,re):ee===1?de=get_connection_bar_end(oe,re):(ue.fillOpacity=0,ue.strokeOpacity=le,de=get_connection_noop_end(oe),ce+=" noop_end ");const me=points_to_path({x:te,y:ne},de);return o$1("polygon",{className:"connection_end "+ce,points:me,style:ue})}function points_to_path(t,ee){const{x:te,y:ne}=t;let oe=`${te}, ${-ne} `;return ee.forEach(ie=>oe+=`${te+ie.x}, ${-ne-ie.y} `),oe}function get_connection_arrow_end(t,ee){const te=get_arrow_end_points(t,1,ee),ne=get_arrow_end_points(t,-1,ee);return[te,ne]}const arrow_angle=rads._25;function get_arrow_end_points(t,ee,te){return to_vec(t+ee*arrow_angle,te)}const BAR_WIDTH=12,BAR_HALF_WIDTH=BAR_WIDTH/2,BAR_THICKNESS=4;function get_connection_bar_end(t,ee){ee=ee/10;const te=to_vec(t+rads._90,BAR_HALF_WIDTH*ee),ne=add_vec(to_vec(t,BAR_THICKNESS*ee),te),oe=add_vec(to_vec(t-rads._90,BAR_WIDTH*ee),ne),ie=add_vec(to_vec(t-rads._180,BAR_THICKNESS*ee),oe);return[te,ne,oe,ie]}const NOOP_SIZE=9,NOOP_THICKNESS=Math.sin(rads._45)*NOOP_SIZE*2;function get_connection_noop_end(t){const ee=to_vec(t+rads._315,NOOP_SIZE),te=add_vec(to_vec(t+rads._45,NOOP_SIZE),ee),ne=add_vec(to_vec(t+rads._135,NOOP_SIZE),te),oe=add_vec(to_vec(t+rads._225,NOOP_SIZE),ne);return[ee,te,ne,oe]}const grid_small_step=20,h_step=grid_small_step*18,v_step=grid_small_step*8;function round_number(t,ee){return Math.round(t/ee)*ee}function round_coordinate_small_step(t){return round_number(t,grid_small_step)}function position_to_point(t){return{left:t.x,top:-t.y}}function round_canvas_point(t,ee="small"){return ee==="small"?{left:round_coordinate_small_step(t.left),top:round_coordinate_small_step(t.top)}:{left:round_number(t.left,h_step),top:round_number(t.top,v_step)}}const NODE_WIDTH=250,node_height_approx=(t=!1)=>t?120:59,half_node_width=NODE_WIDTH/2,half_node_height=t=>node_height_approx(t)/2;function offset_input_by_half_node(t){return{left:t.left-half_node_width,top:t.top-half_node_height(!1)}}function offset_entry_by_half_node(t,ee){const te=t.s??1,ne=t.left+te*half_node_width,oe=t.top+te*half_node_height(ee);return{left:ne,top:oe}}function square_distance_between_kv_entries(t,ee){return!t||!ee?Number.POSITIVE_INFINITY:(t.left-ee.left)**2+(t.top-ee.top)**2}const connection_diameter$1=12,connection_radius=connection_diameter$1/2,connection_left=-6,connection_top=27;let connection_top_increment=22;try{navigator.platform.indexOf("Win")>-1&&(connection_top_increment=17)}catch{}const attribute_type_to_ordinal={meta:0,validity:1,state:2};function get_top_left_for_terminal_type(t,ee=1){const te=attribute_type_to_ordinal[t.attribute],ne=ee**1.14,oe=(connection_top+te*connection_top_increment)*ne;return{left:connection_left+(t.direction==="from"?NODE_WIDTH:0)*ee,top:oe}}function get_connection_point(t,ee){const te=t.s||1;let{left:ne,top:oe}=get_top_left_for_terminal_type(ee,te);return ne+=t.left+connection_radius,oe+=t.top+connection_radius,{left:ne,top:oe}}const NODE_WIDTH_plus_fudge=NODE_WIDTH+45,minimum_line_bow=30;function derive_coords(t){let{from_node_position:ee,to_node_position:te,from_connection_type:ne,to_connection_type:oe,line_behaviour:ie,circular_links:se,end_size:re,connection_end_type:_e}=t,ae=0,ce=0,le=1,ue=1,de,me=!1;se&&(ee.left<te.left-NODE_WIDTH_plus_fudge||(te.left<ee.left-NODE_WIDTH_plus_fudge?(ae=30,ce=30,oe={...oe,direction:"from"},ne={...ne,direction:"to"},me=!0):(de=te.top<ee.top,de?(ne={...ne,direction:"to"},ae=30):(oe={...oe,direction:"from"},ce=30,me=!0))));const pe=get_connection_point(ee,ne),fe=get_connection_point(te,oe),ge=pe.left,he=-pe.top+ae,be=fe.left,ve=-fe.top+ce;de!==void 0&&(ge<be?de?le=-1:ue=-1:de?ue=-1:le=-1);let ye={x:0,y:0},we=ye,Ae=get_angle(ge,he,be,ve)+rads._180;if(ie===void 0||ie==="curve"){const Se=(be-ge)/2,Ie=Math.max(Math.abs(Se),minimum_line_bow)*(Math.sign(Se)||-1);let Pe=Ie*le,Re=-Ie*ue,De=0,Ve=0;const Le=be<=ge;if(!se&&Le){const je=ve-he;Pe=Math.min(-Pe,300),Re=Math.max(-Re,-300),De=je||-minimum_line_bow,Ve=-je||-minimum_line_bow}Ae=me?0:rads._180,ye={x:Pe,y:De},we={x:Re,y:Ve}}const $e=_e===ConnectionEndType.negative?BAR_THICKNESS*re:_e===ConnectionEndType.noop?NOOP_THICKNESS:9*re,xe=be+Math.cos(Ae)*$e,Ce=ve+Math.sin(Ae)*$e;return{x1:ge,y1:he,xe2:be,ye2:ve,xo2:xe,yo2:Ce,relative_control_point1:ye,relative_control_point2:we,end_angle:Ae}}function bounded(t,ee,te){return Math.max(Math.min(t,te),ee)}function rescale(t,ee,te,ne=0,oe=1){const se=(bounded(t,ne,oe)-ne)/(oe-ne);return ee+se*(te-ee)}function CanvasConnnection(t){const[ee,te]=h$1(!1),ne=_$d(void 0),oe=_$d(void 0),ie=_$d(void 0),{from_node_position:se,to_node_position:re,from_connection_type:_e,to_connection_type:ae,line_behaviour:ce,circular_links:le,on_pointer_over_out:ue=()=>{},should_animate:de=!0,connection_end_type:me=ConnectionEndType.positive}=t;if(!se||!re)return null;let pe=t.intensity??1;const fe=ee?2:t.thickness??2,ge=bounded(fe*2.5,10,35),he=t.blur??0,be={strokeWidth:fe+10},ve={strokeOpacity:pe,strokeWidth:fe,filter:he?`url(#blur_filter_${Math.round(he)})`:""},ye=ee?" hovered ":t.focused_mode?"":t.is_highlighted?" highlighted ":"",we=(t.on_click?" mouseable ":"")+ye,{xe2:ke,ye2:Ae,end_angle:$e,target_position:xe}=F$1(()=>{const{x1:Se,y1:Ie,xe2:Pe,ye2:Re,xo2:De,yo2:Ve,relative_control_point1:Le,relative_control_point2:je,end_angle:He}=derive_coords({from_node_position:se,to_node_position:re,from_connection_type:_e,to_connection_type:ae,line_behaviour:ce,circular_links:le,end_size:ge/10,connection_end_type:me}),Ye={x1:Se,y1:Ie,relative_control_point_x1:Le.x,relative_control_point_y1:Le.y,relative_control_point_x2:je.x,relative_control_point_y2:je.y,x2:De,y2:Ve,progress:0};return{xe2:Pe,ye2:Re,end_angle:He,target_position:Ye}},[se,re,_e,ae,ce,le,ge,me]),Ce=de&&ne.current||xe;return o$1("g",{className:"connection_container "+(t.extra_css_classes||""),onPointerDown:t.on_click,style:{display:t.hidden?"none":""},children:[o$1("path",{className:"connection_line_background "+we,d:calc_d(xe),onPointerOver:()=>{te(!0),ue(!0)},onPointerOut:()=>{te(!1),ue(!1)},style:be,ref:Se=>oe.current=Se||void 0}),o$1("path",{className:"connection_line "+ye,d:calc_d(Ce),ref:Se=>{if(!Se||!de)return;ie.current&&clearTimeout(ie.current);const Ie=ee||t.is_highlighted?oe.current:void 0;ie.current=animate_to_target(Se,Ie,ne,xe)},style:ve}),o$1(ConnectionEnd,{type:me,x:ke,y:Ae,end_angle:$e,opacity:pe,blur:he,size:ge,is_hovered:ee,is_highlighted:t.is_highlighted})]})}function calc_d({x1:t,y1:ee,relative_control_point_x1:te,relative_control_point_y1:ne,relative_control_point_x2:oe,relative_control_point_y2:ie,x2:se,y2:re}){const _e=t+te,ae=-ee-ne,ce=se+oe,le=-re-ie;return`M ${t} ${-ee} C ${_e},${ae}, ${ce},${le}, ${se},${-re}`}const step_ms=30,animation_total_ms=1*1e3,progress_step=step_ms/animation_total_ms;function animate_to_target(t,ee,te,ne){if(te.current===void 0||te.current===ne){ne.progress=1,te.current=ne;return}const oe=te.current;let ie;function se(){let re=ne.progress+progress_step;re=Math.min(re,1),ne.progress=re;const _e={x1:tween(oe.x1,ne.x1,re),y1:tween(oe.y1,ne.y1,re),relative_control_point_x1:tween(oe.relative_control_point_x1,ne.relative_control_point_x1,re),relative_control_point_y1:tween(oe.relative_control_point_y1,ne.relative_control_point_y1,re),relative_control_point_x2:tween(oe.relative_control_point_x2,ne.relative_control_point_x2,re),relative_control_point_y2:tween(oe.relative_control_point_y2,ne.relative_control_point_y2,re),x2:tween(oe.x2,ne.x2,re),y2:tween(oe.y2,ne.y2,re)},ae=calc_d(_e);t.setAttribute("d",ae),ee==null||ee.setAttribute("d",ae),re>=1&&(ie&&clearTimeout(ie),te.current=ne)}return ie=setInterval(se,step_ms),ie}function tween(t,ee,te){return t+(ee-t)*te}var SortDirection=(t=>(t[t.ascending=0]="ascending",t[t.descending=1]="descending",t))(SortDirection||{});function sort_list(t,ee,te){const ne=get_sort_function(te);return t.map((oe,ie)=>({item:oe,key_value:ee(oe,ie)})).sort(ne).map(({item:oe})=>oe)}function get_sort_function(t){const ee=t===0,te=ee?-1:1,ne=ee?1:-1;return(oe,ie)=>oe.key_value<ie.key_value?te:oe.key_value>ie.key_value?ne:0}const connection_terminal_attributes=["meta","validity","state"],connection_terminal_directions=["from","to"],connection_line_behaviours=["curve","straight"];function is_a_wcomponent(t){return!!t}function wcomponent_is_event(t){return wcomponent_is_a("event",t)}function wcomponent_is_statev2(t){return wcomponent_is_a("statev2",t)}function wcomponent_is_state_value(t,ee=""){return wcomponent_is_a("state_value",t,ee)}function wcomponent_is_process(t){return wcomponent_is_a("process",t)}function wcomponent_is_a(t,ee,te=""){let ne=!1;return te=typeof te=="string"?te:"",ee?ee.type!==t?te&&console.error(`wcomponent with id "${te}" is not a ${t}`):ne=!0:te&&console.error(`wcomponent with id "${te}" does not exist`),ne}function wcomponent_is_action(t,ee=""){return wcomponent_is_a("action",t,ee)}function wcomponent_is_goal(t,ee=""){return wcomponent_is_a("goal",t,ee)}function wcomponent_has_objectives(t,ee=""){return wcomponent_is_action(t,void 0)||wcomponent_is_goal(t,ee)}function wcomponent_is_prioritisation(t,ee=""){return wcomponent_is_a("prioritisation",t,ee)}function wcomponent_is_causal_link(t){return wcomponent_is_a("causal_link",t)}function wcomponent_is_relation_link(t){return wcomponent_is_a("relation_link",t)}function wcomponent_is_plain_connection(t){return wcomponent_is_causal_link(t)||wcomponent_is_relation_link(t)}function wcomponent_is_judgement_or_objective(t,ee=""){return wcomponent_is_a("judgement",t,void 0)||wcomponent_is_a("objective",t,ee)}function wcomponent_is_sub_state(t,ee=""){return wcomponent_is_a("sub_state",t,ee)}function wcomponent_is_counterfactual_v2(t,ee=""){return wcomponent_is_a("counterfactualv2",t,ee)}function wcomponent_can_render_connection(t){return wcomponent_is_plain_connection(t)}function wcomponent_has_event_at(t){return t.event_at!==void 0}function wcomponent_is_deleted(t){return t?t.deleted_at!==void 0:void 0}function wcomponent_is_not_deleted(t){return t?t.deleted_at===void 0:void 0}function wcomponent_has_validity_predictions(t){const{validity:ee}=t;return ee!==void 0&&ee.length>0}const types_without_validity=new Set(["prioritisation","counterfactualv2","sub_state"]);function wcomponent_can_have_validity_predictions(t){return!types_without_validity.has(t.type)}function wcomponent_has_existence_predictions(t){return t.existence!==void 0}function wcomponent_has_VAP_sets(t){return t.values_and_prediction_sets!==void 0}function wcomponent_has_value_possibilities(t){return(t==null?void 0:t.value_possibilities)!==void 0}function wcomponent_is_allowed_to_have_state_VAP_sets(t){return wcomponent_is_statev2(t)||wcomponent_is_state_value(t)||wcomponent_is_action(t)}function wcomponent_has_legitimate_non_empty_state_VAP_sets(t){return wcomponent_has_VAP_sets(t)&&t.values_and_prediction_sets.length>0&&wcomponent_is_allowed_to_have_state_VAP_sets(t)}var VAPsType=(t=>(t[t.boolean=0]="boolean",t[t.number=1]="number",t[t.other=2]="other",t[t.action=3]="action",t[t.undefined=4]="undefined",t))(VAPsType||{}),ACTION_VALUE_POSSIBILITY_ID=(t=>(t.action_potential="action__value_possibility__potential_id",t.action_in_progress="action__value_possibility__in_progress_id",t.action_paused="action__value_possibility__paused_id",t.action_completed="action__value_possibility__completed_id",t.action_failed="action__value_possibility__failed_id",t.action_rejected="action__value_possibility__rejected_id",t))(ACTION_VALUE_POSSIBILITY_ID||{});const VALUE_POSSIBILITY_IDS={uncertainty:"value_possibility_uncertainty_id__undefined__",boolean_true:"value_possibility_true_id",boolean_false:"value_possibility_false_id",...ACTION_VALUE_POSSIBILITY_ID},ORDERED_ACTION_VALUE_POSSIBILITY_ID=["action__value_possibility__potential_id","action__value_possibility__in_progress_id","action__value_possibility__paused_id","action__value_possibility__completed_id","action__value_possibility__failed_id","action__value_possibility__rejected_id"],VALUE_POSSIBILITY_IDS_to_text={[VALUE_POSSIBILITY_IDS.uncertainty]:"Uncertainty",[VALUE_POSSIBILITY_IDS.boolean_true]:"True",[VALUE_POSSIBILITY_IDS.boolean_false]:"False",[VALUE_POSSIBILITY_IDS.action_potential]:"Potential",[VALUE_POSSIBILITY_IDS.action_in_progress]:"In Progress",[VALUE_POSSIBILITY_IDS.action_paused]:"Paused",[VALUE_POSSIBILITY_IDS.action_completed]:"Completed",[VALUE_POSSIBILITY_IDS.action_failed]:"Failed",[VALUE_POSSIBILITY_IDS.action_rejected]:"Rejected"};function parse_VAP_value(t,ee){return ee===VAPsType.boolean?t.probability>.5:ee===VAPsType.number?parse_string_as_number(t.value):t.value}function is_string_valid_number(t){return!Number.isNaN(parse_string_as_number(t))}function parse_string_as_number(t){if(t=t.trim(),t==="")return null;const ee=t.match(/^(-?[0-9]*\.?[0-9]*)\s*(?:(e)\s*(-?[0-9]+))?\s*(\%)?$/);let te=NaN;do{if(!ee)break;const[,ne,oe,ie,se]=ee;if(!ne||(te=parseFloat(ne),Number.isNaN(te)))break;oe&&ie&&(te=te*10**parseInt(ie)),se&&(te=te/100)}while(!1);return te}function get_parsed_value_represented_by_a_VAP(t,ee){let te=parse_VAP_value(t,ee);return ee===VAPsType.boolean&&(te=t.value_id===VALUE_POSSIBILITY_IDS.boolean_true),te}function get_boolean_representation(t,ee){let te="",ne="";if(wcomponent_is_statev2(t)){const{value_possibilities:oe={}}=t,ie=oe[VALUE_POSSIBILITY_IDS.boolean_true],se=oe[VALUE_POSSIBILITY_IDS.boolean_false];te=(ie==null?void 0:ie.value)||te,ne=(se==null?void 0:se.value)||ne}return te=te?ee?te+" (True)":te:"True",ne=ne?ee?ne+" (False)":ne:"False",{true:te,false:ne}}function parsed_value_to_string(t,ee){let te;return typeof t=="boolean"?te=t?ee.true:ee.false:te=`${t}`,te}const VAP_visual_uncertainty_id="VAP_uncertainty_id__undefined__",VAP_visual_false_id="VAP_false_id__undefined__";function ensure_VAP_set_entries_consistent_with_representing_type(t,ee){let te=ee===VAPsType.boolean?t.entries.slice(0,1):t.entries;return te=expand_booleans(te,ee),{...t,entries:te}}function expand_booleans(t,ee){if(ee===VAPsType.boolean){const te=t[0];if(!te)return t;const ne={...te,probability:1-te.probability,id:VAP_visual_false_id,value_id:VALUE_POSSIBILITY_IDS.boolean_false,description:""};t=[{...te,value_id:VALUE_POSSIBILITY_IDS.boolean_true},ne]}return t}function add_uncertain_VAP_visual(t,ee){const te=1-t,ne={VAP_id:VAP_visual_uncertainty_id,value_id:VALUE_POSSIBILITY_IDS.uncertainty,value_text:"?",certainty:te,parsed_value:null};return[...ee,ne]}function convert_VAP_set_to_VAP_visuals(t){var _e;const ee=ensure_VAP_set_entries_consistent_with_representing_type(t.VAP_set,t.VAPs_represent),te=(_e=ee.shared_entry_values)==null?void 0:_e.conviction;let ne=0;const oe=get_boolean_representation(t.wcomponent),ie=ee.entries.map(ae=>{const ce=get_parsed_value_represented_by_a_VAP(ae,t.VAPs_represent),le=parsed_value_to_string(ce,oe),ue=ae.probability*(te!==void 0?te:ae.conviction);return ne+=ue,{VAP_id:ae.id,value_id:ae.value_id,parsed_value:ce,value_text:le,certainty:ue}}),re=t.sort===void 0||t.sort?sort_list(ie,ae=>ae.certainty,SortDirection.descending):ie;return add_uncertain_VAP_visual(ne,re)}function apply_counterfactuals_v2_to_VAP_set(t){const{VAP_set_id_to_counterfactual_v2_map:ee}=t;let{VAP_set:te}=t;const ne=(ee==null?void 0:ee[te.id])||[];let oe=!1,ie;return ne.forEach(se=>{const{target_VAP_id:re}=se;re&&(te=distort_VAP_set_for_counterfactual(te,re),oe=!0,ie=se.id)}),{...te,has_any_counterfactual_applied:oe,active_counterfactual_v2_id:ie}}function distort_VAP_set_for_counterfactual(t,ee){const te=ee===VAP_visual_uncertainty_id?0:1,ne={...t.shared_entry_values,conviction:te},oe=t.entries.map(ie=>{const se=ie.id===ee?1:0;return{...ie,probability:se,relative_probability:0,conviction:te}});return{...t,shared_entry_values:ne,entries:oe,target_VAP_id:ee}}function stable_stringify(t,ee={}){const te=typeof ee.space=="number"?Array(ee.space+1).join(" "):ee.space||"",ne=typeof ee.cycles=="boolean"?ee.cycles:!1,oe=ee.replacer||((re,_e)=>is_date(_e)?_e.toISOString():_e),ie=ee.comparison_function&&function(re){return function(_e,ae){return ee.comparison_function({key:_e,value:re[_e]},{key:ae,value:re[ae]})}},se=[];return function re(_e,ae,ce,le){const ue=te?`
`+new Array(le+1).join(te):"",de=te?": ":":";if(ce=oe.call(_e,ae,ce),ce===void 0)return;if(typeof ce!="object"||ce===null)return JSON.stringify(ce);if(Array.isArray(ce)){const fe=[];for(let ge=0;ge<ce.length;ge++){const he=re(ce,ge,ce[ge],le+1)||JSON.stringify(null);fe.push(ue+te+he)}return"["+fe.join(",")+ue+"]"}if(se.indexOf(ce)!==-1){if(ne)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else se.push(ce);const me=Object.keys(ce).sort(ie&&ie(ce)),pe=[];return me.forEach(fe=>{const ge=re(ce,fe,ce[fe],le+1);if(!ge)return;const he=JSON.stringify(fe)+de+ge;pe.push(ue+te+he)}),se.splice(se.indexOf(ce),1),"{"+pe.join(",")+ue+"}"}({"":t},"",t,0)}function is_date(t){return Object.prototype.toString.call(t)==="[object Date]"}const test_fn=(t,ee,te="",ne=!0)=>{const oe=ne?stable_stringify(t):JSON.stringify(t),ie=ne?stable_stringify(ee):JSON.stringify(ee);if(oe===ie)console.log("pass  "+te);else{console.error(`fail: "${oe}" !== "${ie}"  ${te}`);try{if((t==null?void 0:t.constructor)===Object){const re=[...new Set([...Object.keys(t),...Object.keys(ee)])];re.sort(),re.forEach(_e=>{const ae=t[_e],ce=ee[_e],le=ne?stable_stringify(ae):JSON.stringify(ae),ue=ne?stable_stringify(ce):JSON.stringify(ce);le===ue||console.debug(`Test failure: different values for key "${_e}", got: '${le}', expected: '${ue}'`)})}}catch(re){console.debug("error in providing debugging for test failure",re)}}},test=test_fn;test.skip=(t,ee,te="",ne=!0)=>{console.log("skipping  "+te)};const describe_fn=(t,ee,te=!0)=>{function ne(){console.group(t),ee(),console.groupEnd()}return te&&ne(),ne},describe=describe_fn;describe.skip=(t,ee,te=!0)=>{function ne(){console.log("skipping  "+t)}return te&&ne(),ne};function get_uncertain_datetime(t){return t&&(t.min||t.value||t.max)}function uncertain_datetime_is_eternal(t){return get_uncertain_datetime(t)===void 0}function get_created_at_datetime(t){return t.custom_created_at||t.created_at}function get_created_at_ms(t){return get_created_at_datetime(t).getTime()}function get_sim_datetime(t){return get_uncertain_datetime(t.datetime)}function get_sim_datetime_ms(t){const ee=get_sim_datetime(t);return ee===void 0?void 0:ee.getTime()}function partition_items_by_created_at_datetime(t){const{items:ee,created_at_ms:te}=t,ne=[],oe=[];return ee.forEach(ie=>{get_created_at_ms(ie)>te?ne.push(ie):oe.push(ie)}),{invalid_future_items:ne,current_items:oe}}const test_partition_items_by_created_at_datetime=describe("partition_items_by_created_at_datetime",()=>{function t(de){const me=partition_items_by_created_at_datetime(de);return{invalid_future_items:me.invalid_future_items.map(({id:pe})=>pe),current_items:me.current_items.map(({id:pe})=>pe)}}let ee,te;const oe=new Date("2021-04-01 00:00").getTime(),ie=new Date("2021-04-01 00:01"),se=ie.getTime(),re=new Date("2021-04-01 00:02"),_e=re.getTime(),ce=new Date("2021-04-01 00:03").getTime(),le={base_id:-1,id:"1",created_at:ie},ue={base_id:-1,id:"2",created_at:re};ee=[],te=t({items:ee,created_at_ms:ce}),test(te,{invalid_future_items:[],current_items:[]}),ee=[le,ue],te=t({items:ee,created_at_ms:ce}),test(te,{invalid_future_items:[],current_items:[le.id,ue.id]}),te=t({items:ee,created_at_ms:_e}),test(te,{invalid_future_items:[],current_items:[le.id,ue.id]}),te=t({items:ee,created_at_ms:se}),test(te,{invalid_future_items:[ue.id],current_items:[le.id]}),te=t({items:ee,created_at_ms:oe}),test(te,{invalid_future_items:[le.id,ue.id],current_items:[]})},!1);var Tense=(t=>(t[t.past=0]="past",t[t.present=1]="present",t[t.future=2]="future",t[t.eternal=3]="eternal",t))(Tense||{});function get_tense_of_uncertain_datetime(t,ee){const{min:te,value:ne,max:oe}=t.datetime||{},[ie,se]=te===void 0?[!1,0]:[!0,te.getTime()],[re,_e]=ne===void 0?[!1,0]:[!0,ne.getTime()],[ae,ce]=oe===void 0?[!1,0]:[!0,oe.getTime()];if(ie){if(se>ee)return Tense.future;if(se===ee||!ae&&se<ee)return Tense.present}if(ae)return ce<=ee?Tense.past:Tense.present;if(re){if(_e<ee)return Tense.past;if(_e===ee)return Tense.present;if(_e>ee)return Tense.future}return Tense.eternal}const test_get_tense_of_uncertain_datetime=describe("get_tense_of_uncertain_datetime",()=>{let t;const te=new Date("2021-04-01 00:01").getTime(),ne=new Date("2021-04-01 00:02"),oe=ne.getTime(),ie=new Date("2021-04-01 00:03"),se=ie.getTime(),re=new Date("2021-04-01 00:04"),_e=re.getTime(),ce=new Date("2021-04-01 00:05").getTime();t=get_tense_of_uncertain_datetime({datetime:{}},te),test(t,Tense.eternal),t=get_tense_of_uncertain_datetime({datetime:{min:ne}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{min:ne}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne}},se),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{value:ne}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{value:ne}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{value:ne}},se),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{max:ne}},te),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{max:ne}},oe),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{max:ne}},se),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},se),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,max:ie}},_e),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:re}},te),test(t,Tense.future),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:re}},oe),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:re}},se),test(t,Tense.present),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:re}},_e),test(t,Tense.past),t=get_tense_of_uncertain_datetime({datetime:{min:ne,value:ie,max:re}},ce),test(t,Tense.past)},!1);function partition_and_sort_by_uncertain_event_datetimes(t){const{items:ee,sim_ms:te}=t,ne=sort_by_uncertain_event_datetimes(ee);return partition_sorted_items_by_datetimes({sorted_items:ne,sim_ms:te})}function sort_by_uncertain_event_datetimes(t,ee=SortDirection.descending){return sort_list(t,({datetime:ne})=>{if(uncertain_datetime_is_eternal(ne))return Number.NEGATIVE_INFINITY;const{max:oe,value:ie,min:se}=ne;return se?se.getTime()*10+2:ie?ie.getTime()*10+1:oe?oe.getTime()*10:1},ee)}function partition_sorted_items_by_datetimes(t){const{sorted_items:ee,sim_ms:te}=t;let ne=[],oe=[],ie=[];const se=[];ee.forEach(_e=>{const ae=get_tense_of_uncertain_datetime(_e,te);ae===Tense.past?ne.push(_e):ae===Tense.future?se.push(_e):ae===Tense.present?oe.push(_e):ie.push(_e)}),oe.length!==1&&(oe.length>1?(ne=oe.slice(1).concat(ne),oe=oe.slice(0,1)):ne.length&&(oe=ne.slice(0,1),ne=ne.slice(1))),ie.length&&(oe.length!==1&&(oe=ie.slice(0,1),ie=ie.slice(1)),ne=ne.concat(ie));const re=oe[0];return{past_items:ne,present_item:re,future_items:se}}const test_partition_sorted_items_by_datetimes=describe("partition_sorted_items_by_datetimes",()=>{function t(pe){var ge;const fe=partition_sorted_items_by_datetimes(pe);return{past_items:fe.past_items.map(({id:he})=>he),present_item:(ge=fe.present_item)==null?void 0:ge.id,future_items:fe.future_items.map(({id:he})=>he)}}let ee,te;const oe=new Date("2021-04-01 00:00").getTime(),ie=new Date("2021-04-01 00:01"),se=ie.getTime(),re=new Date("2021-04-01 00:02"),_e=re.getTime(),ce=new Date("2021-04-01 00:03").getTime(),le={id:"10",datetime:{}},ue={id:"11",datetime:{}},de={id:"20",datetime:{value:ie}},me={id:"30",datetime:{value:re}};ee=[],te=t({sorted_items:ee,sim_ms:ce}),test(te,{past_items:[],present_item:void 0,future_items:[]}),ee=[le,ue],te=t({sorted_items:ee,sim_ms:oe}),test(te,{past_items:[ue.id],present_item:le.id,future_items:[]},"Can handle multiple eternal elements"),ee=[me,de,ue],te=t({sorted_items:ee,sim_ms:oe}),test(te,{past_items:[],present_item:ue.id,future_items:[me.id,de.id]}),te=t({sorted_items:ee,sim_ms:se}),test(te,{past_items:[ue.id],present_item:de.id,future_items:[me.id]}),te=t({sorted_items:ee,sim_ms:_e}),test(te,{past_items:[de.id,ue.id],present_item:me.id,future_items:[]}),te=t({sorted_items:ee,sim_ms:ce}),test(te,{past_items:[de.id,ue.id],present_item:me.id,future_items:[]})},!1),test_sort_by_uncertain_event_datetimes=describe("sort_by_uncertain_event_datetimes",()=>{function t(ke){return sort_by_uncertain_event_datetimes(ke).map(({id:$e})=>$e)}function ee(ke,Ae){const $e=[...ke].reverse(),xe=Ae.map(({id:Se})=>Se);ne=t(ke);const Ce=t($e);test(ne,Ce,"",!1),test(ne,xe,"",!1)}let te=[],ne,oe;const ie=new Date("2021-04-01 00:00"),se=new Date("2021-04-01 00:01"),re=new Date("2021-04-01 00:02"),_e=new Date("2021-04-01 00:03");let ae=0;const ce=()=>`${ae++}`,le={id:ce(),datetime:{}},ue={id:ce(),datetime:{}},de={id:ce(),datetime:{value:se}},me={id:ce(),datetime:{value:re}},pe={id:ce(),datetime:{max:se}},fe={id:ce(),datetime:{max:re}},ge={id:ce(),datetime:{min:se}},he={id:ce(),datetime:{min:re}},be={id:ce(),datetime:{min:ie,max:_e}},ve={id:ce(),datetime:{min:se,max:re}};te=[],ne=t(te),test(ne,[],"",!1),te=[le,ue];const ye=[...te].reverse();ne=t(te);const we=t(ye);test(JSON.stringify(ne)!==JSON.stringify(we),!0,"Should be different (indeterminant sort)"),te=[le,de,me],oe=[me,de,le],ee(te,oe),te=[le,ge,he],oe=[he,ge,le],ee(te,oe),te=[le,pe,fe],oe=[fe,pe,le],ee(te,oe),te=[le,de,me,ge,he,pe,fe],oe=[he,me,fe,ge,de,pe,le],ee(te,oe),te=[le,be,ve],oe=[ve,be,le],ee(te,oe)},!1);function group_versions_by_id(t){const ee={};t.forEach(oe=>{const ie=ee[oe.id]||[];ie.push(oe),ee[oe.id]=ie});const te={};return{latest:Object.values(ee).map(oe=>{const ie=sort_list(oe,get_created_at_ms,SortDirection.descending),se=ie[0];return te[se.id]=ie.slice(1),se}),previous_versions_by_id:te}}function partition_and_prune_items_by_datetimes_and_versions(t){const{invalid_future_items:ee,current_items:te}=partition_items_by_created_at_datetime(t),{latest:ne,previous_versions_by_id:oe}=group_versions_by_id(te),ie=partition_and_sort_by_uncertain_event_datetimes({items:ne,sim_ms:t.sim_ms});return{invalid_future_items:ee,...ie,previous_versions_by_id:oe}}function prune_items_by_created_at_and_versions_and_sort_by_datetimes(t,ee){const te=prune_items_by_created_at_and_versions(t,ee);return sort_by_uncertain_event_datetimes(te)}function prune_items_by_created_at_and_versions(t,ee){const{current_items:te}=partition_items_by_created_at_datetime({items:t,created_at_ms:ee}),{latest:ne}=group_versions_by_id(te);return ne}function get_current_VAP_set(t){const{values_and_prediction_sets:ee=[],created_at_ms:te,sim_ms:ne}=t,{present_item:oe}=partition_and_prune_items_by_datetimes_and_versions({items:ee,created_at_ms:te,sim_ms:ne});return oe}function get_wcomponent_VAPs_represent(t,ee,te=new Set){let ne=VAPsType.undefined;do{if(te.has((t==null?void 0:t.id)||"")){console.log(`Recursion prevented in "get_wcomponent_VAPs_represent" for wcomponent id: "${t==null?void 0:t.id}" type: "${t==null?void 0:t.type}"`);break}if(t&&te.add(t.id),!wcomponent_is_allowed_to_have_state_VAP_sets(t))break;if(wcomponent_is_statev2(t))ne=subtype_to_VAPsType(t.subtype);else if(wcomponent_is_action(t))ne=VAPsType.action;else if(wcomponent_is_state_value(t)){const oe=ee[t.attribute_wcomponent_id||""];oe&&(ne=get_wcomponent_VAPs_represent(oe,ee,te))}else console.error(`Unimplemented "get_wcomponent_VAPs_represent" for wcomponent id: "${t.id}" type: "${t.type}"`)}while(!1);return ne}function subtype_to_VAPsType(t){return t==="boolean"?VAPsType.boolean:t==="number"?VAPsType.number:t==="other"?VAPsType.other:VAPsType.undefined}const toggle_linked_datetime_sliders_type="toggle_linked_datetime_sliders",toggle_linked_datetime_sliders=()=>({type:toggle_linked_datetime_sliders_type}),is_toggle_linked_datetime_sliders=t=>t.type===toggle_linked_datetime_sliders_type,set_display_time_sliders_type="set_display_time_sliders",set_display_time_sliders=t=>({type:set_display_time_sliders_type,display_time_sliders:t}),is_set_display_time_sliders=t=>t.type===set_display_time_sliders_type,toggle_display_time_sliders_type="toggle_display_time_sliders",toggle_display_time_sliders=()=>({type:toggle_display_time_sliders_type}),is_toggle_display_time_sliders=t=>t.type===toggle_display_time_sliders_type,set_or_toggle_display_side_panel_type="set_or_toggle_display_side_panel",set_or_toggle_display_side_panel=t=>(typeof t!="boolean"&&(t=void 0),{type:set_or_toggle_display_side_panel_type,display_side_panel:t}),is_set_or_toggle_display_side_panel=t=>t.type===set_or_toggle_display_side_panel_type,set_or_toggle_display_select_storage_type="set_or_toggle_display_select_storage",set_or_toggle_display_select_storage=t=>(typeof t!="boolean"&&(t=void 0),{type:set_or_toggle_display_select_storage_type,display_select_storage:t}),is_set_or_toggle_display_select_storage=t=>t.type===set_or_toggle_display_select_storage_type,controls_actions={toggle_linked_datetime_sliders,set_display_time_sliders,toggle_display_time_sliders,set_or_toggle_display_side_panel,set_or_toggle_display_select_storage},toggle_use_creation_context_type="toggle_use_creation_context",toggle_use_creation_context=()=>({type:toggle_use_creation_context_type}),is_toggle_use_creation_context=t=>t.type===toggle_use_creation_context_type,set_custom_created_at_type="set_custom_created_at",set_custom_created_at=t=>({type:set_custom_created_at_type,...t}),is_set_custom_created_at=t=>t.type===set_custom_created_at_type,set_label_ids_type="set_label_ids",set_label_ids=t=>({type:set_label_ids_type,...t}),is_set_label_ids=t=>t.type===set_label_ids_type,set_replace_text_type="set_replace_text",set_replace_text=t=>({type:set_replace_text_type,...t}),is_set_replace_text=t=>t.type===set_replace_text_type,creation_context_actions={toggle_use_creation_context,set_custom_created_at,set_label_ids,set_replace_text},toggle_consumption_formatting_type="toggle_consumption_formatting",toggle_consumption_formatting=t=>({type:toggle_consumption_formatting_type,...t}),is_toggle_consumption_formatting=t=>t.type===toggle_consumption_formatting_type,set_or_toggle_focused_mode_type="set_or_toggle_focused_mode",set_or_toggle_focused_mode=t=>({type:set_or_toggle_focused_mode_type,focused_mode:t}),is_set_or_toggle_focused_mode=t=>t.type===set_or_toggle_focused_mode_type,set_time_resolution_type="set_time_resolution",set_time_resolution=t=>({type:set_time_resolution_type,...t}),is_set_time_resolution=t=>t.type===set_time_resolution_type,set_validity_filter_type="set_validity_filter",set_validity_filter=t=>({type:set_validity_filter_type,...t}),is_set_validity_filter=t=>t.type===set_validity_filter_type,set_certainty_formatting_type="set_certainty_formatting",set_certainty_formatting=t=>({type:set_certainty_formatting_type,...t}),is_set_certainty_formatting=t=>t.type===set_certainty_formatting_type,set_display_by_simulated_time_type="set_display_by_simulated_time",set_display_by_simulated_time=t=>({type:set_display_by_simulated_time_type,display_by_simulated_time:t}),is_set_display_by_simulated_time=t=>t.type===set_display_by_simulated_time_type,set_display_time_marks_type="set_display_time_marks",set_display_time_marks=t=>({type:set_display_time_marks_type,display_time_marks:t}),is_set_display_time_marks=t=>t.type===set_display_time_marks_type,set_or_toggle_animate_connections_type="set_or_toggle_animate_connections",set_or_toggle_animate_connections=t=>({type:set_or_toggle_animate_connections_type,animate_connections:t}),is_set_or_toggle_animate_connections=t=>t.type===set_or_toggle_animate_connections_type,set_or_toggle_circular_links_type="set_or_toggle_circular_links",set_or_toggle_circular_links=t=>({type:set_or_toggle_circular_links_type,circular_links:t}),is_set_or_toggle_circular_links=t=>t.type===set_or_toggle_circular_links_type,set_show_help_menu_type="set_show_help_menu",set_show_help_menu=t=>({type:set_show_help_menu_type,...t}),is_set_show_help_menu=t=>t.type===set_show_help_menu_type,set_or_toggle_show_large_grid_type="set_or_toggle_show_large_grid",set_or_toggle_show_large_grid=t=>({type:set_or_toggle_show_large_grid_type,show_large_grid:t}),is_set_or_toggle_show_large_grid=t=>t.type===set_or_toggle_show_large_grid_type,display_actions={toggle_consumption_formatting,set_or_toggle_focused_mode,set_time_resolution,set_validity_filter,set_certainty_formatting,set_display_by_simulated_time,set_display_time_marks,set_or_toggle_animate_connections,set_or_toggle_circular_links,set_show_help_menu,set_or_toggle_show_large_grid},set_apply_filter_type="set_apply_filter",set_apply_filter=t=>({type:set_apply_filter_type,apply_filter:t}),is_set_apply_filter=t=>t.type===set_apply_filter_type,set_filters_type="set_filters",set_filters=t=>({type:set_filters_type,...t}),is_set_filters=t=>t.type===set_filters_type,filter_context_actions={set_apply_filter,set_filters},key_down_type="key_down",key_down=t=>({type:key_down_type,...t}),is_key_down=t=>t.type===key_down_type,key_up_type="key_up",key_up=t=>({type:key_up_type,...t}),is_key_up=t=>t.type===key_up_type,clear_all_keys_type="clear_all_keys",clear_all_keys=()=>({type:clear_all_keys_type}),is_clear_all_keys=t=>t.type===clear_all_keys_type,global_keys_actions={key_down,key_up,clear_all_keys},change_route_type="change_route",change_route=t=>{const ee=t.args;return ee&&(ee.x=round_position(ee.x),ee.y=round_position(ee.y),ee.zoom=round_position(ee.zoom)),{type:change_route_type,...t}};function round_position(t){return t===void 0?t:Math.round(t)}const is_change_route=t=>t.type===change_route_type,routing_actions={change_route};function update_state(t,ee,te){return t[ee]===te?t:{...t,[ee]:te}}function update_substate(t,ee,te,ne){const oe=update_state(t[ee],te,ne);return update_state(t,ee,oe)}function update_subsubstate(t,ee,te,ne,oe){const ie=update_state(t[ee][te],ne,oe),se=update_state(t[ee],te,ie);return update_state(t,ee,se)}function update_subsubsubstate(t,ee,te,ne,oe,ie){const se=update_state(t[ee][te][ne],oe,ie),re=update_state(t[ee][te],ne,se),_e=update_state(t[ee],te,re);return update_state(t,ee,_e)}function routing_arg_datetime_strings_to_datetime(t,ee){return t?date_and_time_strings_to_datetime(t,ee||""):new Date}function date_and_time_strings_to_datetime(t,ee){const te=new Date(t+" "+ee);return Number.isNaN(te.getTime())?new Date:te}function get_datetime_and_ms(t){return t.ms===void 0?{ms:t.datetime.getTime(),datetime:t.datetime}:{ms:t.ms,datetime:new Date(t.ms)}}function get_datetime_or_ms(t,ee,te=console.warn){return ee===void 0?t?t.getTime():void 0:(t!==void 0&&te("do not set both new_ms and new_datetime"),ee)}const display_at_created_datetime_reducer=(t,ee)=>{if(is_change_display_at_created_datetime(ee)){const{ms:te,datetime:ne}=get_datetime_and_ms(ee),oe={...t.routing.args,created_at_datetime:ne,created_at_ms:te};t.controls.linked_datetime_sliders&&(oe.sim_datetime=ne,oe.sim_ms=te),t=update_substate(t,"routing","args",oe)}return t},change_display_at_created_datetime_type="change_display_at_created_datetime",change_display_at_created_datetime=t=>({type:change_display_at_created_datetime_type,...t}),is_change_display_at_created_datetime=t=>t.type===change_display_at_created_datetime_type,display_at_created_datetime_actions={change_display_at_created_datetime},one_hour=3600*1e3;function periodically_change_display_at_created_datetime(t){setTimeout(()=>{t.dispatch(change_display_at_created_datetime({datetime:new Date}))},one_hour)}const display_at_sim_datetime_reducer=(t,ee)=>{if(is_change_display_at_sim_datetime(ee)){const{ms:te,datetime:ne}=get_datetime_and_ms(ee),oe={...t.routing.args,sim_datetime:ne,sim_ms:te};t.controls.linked_datetime_sliders&&(oe.created_at_datetime=ne,oe.created_at_ms=te),t=update_substate(t,"routing","args",oe)}return t},change_display_at_sim_datetime_type="change_display_at_sim_datetime",change_display_at_sim_datetime=t=>({type:change_display_at_sim_datetime_type,...t}),is_change_display_at_sim_datetime=t=>t.type===change_display_at_sim_datetime_type,display_at_sim_datetime_actions={change_display_at_sim_datetime},search_reducer=(t,ee)=>(is_update_search_fields(ee)&&(t=update_substate(t,"search","search_fields",ee.search_fields)),is_update_search_type(ee)&&(t=update_substate(t,"search","search_type",ee.search_type)),t),update_search_fields_type="update_search_fields",update_search_type_type="update_search_type",update_search_fields=t=>({type:update_search_fields_type,...t}),is_update_search_fields=t=>t.type===update_search_fields_type,update_search_type=t=>({type:update_search_fields_type,...t}),is_update_search_type=t=>t.type===update_search_type_type,search_actions={update_search_fields,update_search_type};function safe_merge(t,ee={},te={},ne={},oe={},ie={},se={},re={},_e={}){return{...t,...ee,...te,...ne,...oe,...ie,...se,...re,..._e}}function get_wcomponent_from_state(t,ee){return ee?t.specialised_objects.wcomponents_by_id[ee]:void 0}function get_wcomponents_from_ids(t,ee){return ee=ee||[],ee=ee instanceof Set?Array.from(ee):ee,ee.map(te=>t[te])}function get_wcomponents_from_state(t,ee){return ee=ee||[],ee=ee instanceof Set?Array.from(ee):ee,ee.map(te=>get_wcomponent_from_state(t,te))}function get_current_composed_knowledge_view_from_state(t){return t.derived.current_composed_knowledge_view}function get_current_knowledge_view_from_state(t){return t.specialised_objects.knowledge_views_by_id[t.routing.args.subview_id]}function is_on_current_knowledge_view(t,ee){const te=get_current_knowledge_view_from_state(t);if(!te)return!1;const ne=te.wc_id_map[ee];return!!ne&&!ne.passthrough}function get_knowledge_view_from_state(t,ee){return t.specialised_objects.knowledge_views_by_id[ee]}function get_nested_knowledge_view_ids(t,ee){const te=new Set(t.map(se=>se.id));t=t.filter(se=>se.base_id===ee);const ne=new Set(t.map(se=>se.id)),oe={top_ids:[],map:{}},ie=[];return t.forEach(se=>{const{parent_knowledge_view_id:re,title:_e,sort_type:ae="normal"}=se;re?ie.push({...se,parent_knowledge_view_id:re}):(oe.top_ids.push(se.id),oe.map[se.id]={id:se.id,title:_e,sort_type:ae,parent_id:void 0,child_ids:[]})}),add_child_views(te,ne,ie,oe,ee),oe}function add_child_views(t,ee,te,ne,oe){if(te.length===0)return;const ie=[];if(te.forEach(se=>{const re=ne.map[se.parent_knowledge_view_id];if(re){const{id:_e,title:ae,sort_type:ce="normal"}=se;re.child_ids.push(_e),ne.map[_e]={id:_e,title:ae,sort_type:ce,parent_id:re.id,child_ids:[]}}else ie.push(se)}),te.length===ie.length){const se=ie.filter(re=>re.base_id===oe);se.length&&console.warn(`Maybe broken knowledge view tree.  Look in "Views" for:
 * ${se.map(re=>`${re.title} ${re.id}`).join(`
 * `)}`),ie.forEach(({id:re,title:_e,parent_knowledge_view_id:ae})=>{ne.top_ids.push(re);const ce=ee.has(ae),le=!t.has(ae),ue=!ce&&!le;ne.map[re]={id:re,title:_e,sort_type:"errored",parent_id:void 0,child_ids:[],ERROR_is_circular:ce,ERROR_parent_kv_missing:le,ERROR_parent_from_diff_base:ue}})}else add_child_views(t,ee,ie,ne,oe)}function sort_nested_knowledge_map_ids_by_priority_then_title(t){t.top_ids=sort_knowledge_map_ids_by_priority_then_title(t.top_ids,t.map),Object.values(t.map).forEach(ee=>{ee.child_ids=sort_knowledge_map_ids_by_priority_then_title(ee.child_ids,t.map)})}const sort_type_to_prefix={priority:"0",normal:"1",hidden:"2",archived:"3",errored:"4"};function sort_knowledge_map_ids_by_priority_then_title(t,ee){return sort_list(t,te=>{const ne=ee[te];return sort_type_to_prefix[ne.sort_type]+ne.title.toLowerCase()},SortDirection.ascending)}function wcomponent_has_knowledge_view(t,ee){return!!ee[t]}function get_current_datetime_from_wcomponent(t,ee,te){const ne=get_current_temporal_value_certainty_from_wcomponent(t,ee,te);return get_uncertain_datetime(ne==null?void 0:ne.temporal_uncertainty)}function get_current_temporal_value_certainty_from_wcomponent(t,ee,te){const ne=ee[t];if(wcomponent_is_event(ne)){let{event_at:oe=[]}=ne;const ie=oe[0];if(!ie)return;const se=ie.datetime,re=ie.probability*ie.conviction;return{temporal_uncertainty:se,certainty:re}}else if(wcomponent_is_sub_state(ne)){const{target_wcomponent_id:oe,selector:ie}=ne,se=ee[oe||""],re=wcomponent_is_allowed_to_have_state_VAP_sets(se)&&se;if(!re||!ie)return;const{target_VAP_set_id:_e}=ie;if(!_e)return;let{values_and_prediction_sets:ae}=re;ae=ae.filter(({id:le})=>le===_e),ae=partition_items_by_created_at_datetime({items:ae,created_at_ms:te}).current_items,ae=sort_list(ae,get_created_at_ms,SortDirection.descending);const ce=ae[0];return convert_VAP_set_to_temporal_certainty(ce)}else if(ne&&wcomponent_has_legitimate_non_empty_state_VAP_sets(ne)){const oe=wcomponent_has_single_statev2_datetime(ne);if(oe)return convert_VAP_set_to_temporal_certainty(oe)}}function wcomponent_has_single_statev2_datetime(t){let ee=t.values_and_prediction_sets||[];ee=group_versions_by_id(ee).latest;const te=ee[0];if(te&&ee.length===1)return te;const ne=ee.filter(ie=>!uncertain_datetime_is_eternal(ie.datetime)),oe=ne[0];return oe&&ne.length===1?oe:!1}function convert_VAP_set_to_temporal_certainty(t){var ne;if(!t)return;let ee;const te=(ne=t.shared_entry_values)==null?void 0:ne.conviction;return t.entries.forEach(oe=>{const ie=oe.probability*(te!==void 0?te:oe.conviction);ee=Math.max(ee||0,ie)}),{temporal_uncertainty:t.datetime,certainty:ee}}const highlighting_reducer=(t,ee)=>{if(is_set_highlighted_wcomponent(ee)){const{id:te,highlighted:ne}=ee;let oe=new Set(t.meta_wcomponents.highlighted_wcomponent_ids);te===void 0?oe=new Set:ne?oe.add(te):oe.delete(te),t=update_substate(t,"meta_wcomponents","highlighted_wcomponent_ids",oe);let{neighbour_ids_of_highlighted_wcomponent:ie}=t.meta_wcomponents;if(t.display_options.focused_mode){const re=get_current_composed_knowledge_view_from_state(t);if(re&&(ie=new Set,te!==void 0&&ee.highlighted)){const _e=re.wc_id_connections_map[te];_e&&(ie=new Set(_e),t.derived.wcomponent_ids_by_type.any_node.has(te)&&_e.forEach(ae=>{const ce=re.wc_id_connections_map[ae];ce&&ce.forEach(le=>ie.add(le))}))}}else ie.size&&(ie=new Set);t=update_substate(t,"meta_wcomponents","neighbour_ids_of_highlighted_wcomponent",ie)}return t},set_highlighted_wcomponent_type="set_highlighted_wcomponent",set_highlighted_wcomponent=t=>({type:set_highlighted_wcomponent_type,id:t.id,highlighted:t.highlighted}),is_set_highlighted_wcomponent=t=>t.type===set_highlighted_wcomponent_type,highlighting_actions={set_highlighted_wcomponent},replace_all_specialised_objects_type="replace_all_specialised_objects",replace_all_specialised_objects=t=>({type:replace_all_specialised_objects_type,...t}),is_replace_all_specialised_objects=t=>t.type===replace_all_specialised_objects_type,clear_from_mem_all_specialised_objects_type="clear_from_mem_all_specialised_objects",clear_from_mem_all_specialised_objects=()=>({type:clear_from_mem_all_specialised_objects_type}),is_clear_from_mem_all_specialised_objects=t=>t.type===clear_from_mem_all_specialised_objects_type,syncing_actions={replace_all_specialised_objects,clear_from_mem_all_specialised_objects},bulk_edit_wcomponents_type="bulk_edit_wcomponents",bulk_edit_wcomponents=t=>({type:bulk_edit_wcomponents_type,...t}),is_bulk_edit_wcomponents=t=>t.type===bulk_edit_wcomponents_type,bulk_editing_wcomponents_actions={bulk_edit_wcomponents},upsert_wcomponent_type="upsert_wcomponent",upsert_wcomponent=t=>({type:upsert_wcomponent_type,...t}),is_upsert_wcomponent=t=>t.type===upsert_wcomponent_type,delete_wcomponent_type="delete_wcomponent",delete_wcomponent=t=>({type:delete_wcomponent_type,...t}),is_delete_wcomponent=t=>t.type===delete_wcomponent_type,add_wcomponents_to_store_type="add_wcomponents_to_store",add_wcomponents_to_store=t=>({type:add_wcomponents_to_store_type,...t}),is_add_wcomponents_to_store=t=>t.type===add_wcomponents_to_store_type,wcomponent_actions={upsert_wcomponent,delete_wcomponent,add_wcomponents_to_store,...bulk_editing_wcomponents_actions},bulk_edit_knowledge_view_entries_type="bulk_edit_knowledge_view_entries",bulk_edit_knowledge_view_entries=t=>({type:bulk_edit_knowledge_view_entries_type,...t}),is_bulk_edit_knowledge_view_entries=t=>t.type===bulk_edit_knowledge_view_entries_type,snap_to_grid_knowledge_view_entries_type="snap_to_grid_knowledge_view_entries",snap_to_grid_knowledge_view_entries=t=>({type:snap_to_grid_knowledge_view_entries_type,...t}),is_snap_to_grid_knowledge_view_entries=t=>t.type===snap_to_grid_knowledge_view_entries_type,change_current_knowledge_view_entries_order_type="change_current_knowledge_view_entries_order",change_current_knowledge_view_entries_order=t=>({type:change_current_knowledge_view_entries_order_type,...t}),is_change_current_knowledge_view_entries_order=t=>t.type===change_current_knowledge_view_entries_order_type,bulk_add_to_knowledge_view_type="bulk_add_to_knowledge_view",bulk_add_to_knowledge_view=t=>({type:bulk_add_to_knowledge_view_type,...t}),is_bulk_add_to_knowledge_view=t=>t.type===bulk_add_to_knowledge_view_type,bulk_remove_from_knowledge_view_type="bulk_remove_from_knowledge_view",bulk_remove_from_knowledge_view=t=>({type:bulk_remove_from_knowledge_view_type,...t}),is_bulk_remove_from_knowledge_view=t=>t.type===bulk_remove_from_knowledge_view_type,bulk_editing_knowledge_view_entries_actions={bulk_edit_knowledge_view_entries,bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries,change_current_knowledge_view_entries_order},upsert_knowledge_view_entry_type="upsert_knowledge_view_entry",upsert_knowledge_view_entry=t=>({type:upsert_knowledge_view_entry_type,...t}),is_upsert_knowledge_view_entry=t=>t.type===upsert_knowledge_view_entry_type,upsert_knowledge_view_type="upsert_knowledge_view",upsert_knowledge_view=t=>({type:upsert_knowledge_view_type,...t}),is_upsert_knowledge_view=t=>t.type===upsert_knowledge_view_type,knowledge_view_actions={upsert_knowledge_view_entry,upsert_knowledge_view,...bulk_editing_knowledge_view_entries_actions},specialised_object_actions=safe_merge(highlighting_actions,syncing_actions,wcomponent_actions,knowledge_view_actions),update_sync_status_type="update_sync_status",update_sync_status=t=>({type:update_sync_status_type,...t}),is_update_sync_status=t=>t.type===update_sync_status_type,debug_refresh_all_specialised_object_ids_pending_save_type="debug_refresh_all_specialised_object_ids_pending_save",debug_refresh_all_specialised_object_ids_pending_save=()=>({type:debug_refresh_all_specialised_object_ids_pending_save_type}),is_debug_refresh_all_specialised_object_ids_pending_save=t=>t.type===debug_refresh_all_specialised_object_ids_pending_save_type,update_specialised_object_sync_info_type="update_specialised_object_sync_info",update_specialised_object_sync_info=t=>({type:update_specialised_object_sync_info_type,...t}),is_update_specialised_object_sync_info=t=>t.type===update_specialised_object_sync_info_type,update_network_status_type="update_network_status",update_network_status=t=>({type:update_network_status_type,...t}),is_update_network_status=t=>t.type===update_network_status_type,request_searching_for_wcomponents_by_id_in_any_base_type="request_searching_for_wcomponents_by_id_in_any_base",request_searching_for_wcomponents_by_id_in_any_base=t=>({type:request_searching_for_wcomponents_by_id_in_any_base_type,...t}),is_request_searching_for_wcomponents_by_id_in_any_base=t=>t.type===request_searching_for_wcomponents_by_id_in_any_base_type,searching_for_wcomponents_by_id_in_any_base_type="searching_for_wcomponents_by_id_in_any_base",searching_for_wcomponents_by_id_in_any_base=()=>({type:searching_for_wcomponents_by_id_in_any_base_type}),is_searching_for_wcomponents_by_id_in_any_base=t=>t.type===searching_for_wcomponents_by_id_in_any_base_type,searched_for_wcomponents_by_id_in_any_base_type="searched_for_wcomponents_by_id_in_any_base",searched_for_wcomponents_by_id_in_any_base=t=>({type:searched_for_wcomponents_by_id_in_any_base_type,...t}),is_searched_for_wcomponents_by_id_in_any_base=t=>t.type===searched_for_wcomponents_by_id_in_any_base_type,sync_actions={update_sync_status,debug_refresh_all_specialised_object_ids_pending_save,update_specialised_object_sync_info,update_network_status,request_searching_for_wcomponents_by_id_in_any_base,searching_for_wcomponents_by_id_in_any_base,searched_for_wcomponents_by_id_in_any_base},set_user_type="set_user",set_user=t=>({type:set_user_type,...t}),is_set_user=t=>t.type===set_user_type,set_need_to_handle_password_recovery_type="set_need_to_handle_password_recovery",set_need_to_handle_password_recovery=t=>({type:set_need_to_handle_password_recovery_type,need_to_handle_password_recovery:t}),is_set_need_to_handle_password_recovery=t=>t.type===set_need_to_handle_password_recovery_type,set_users_type="set_users",set_users=t=>({type:set_users_type,...t}),is_set_users=t=>t.type===set_users_type,update_chosen_base_id_type="update_chosen_base_id",update_chosen_base_id=t=>({type:update_chosen_base_id_type,...t}),is_update_chosen_base_id=t=>t.type===update_chosen_base_id_type,update_bases_type="update_bases",update_bases=t=>({type:update_bases_type,...t}),is_update_bases=t=>t.type===update_bases_type,user_info_actions={set_user,set_need_to_handle_password_recovery,set_users,update_chosen_base_id,update_bases},set_action_ids_to_show_type="set_action_ids_to_show",set_action_ids_to_show=t=>({type:set_action_ids_to_show_type,...t}),is_set_action_ids_to_show=t=>t.type===set_action_ids_to_show_type,view_priorities_actions={set_action_ids_to_show},set_find_all_causal_paths_wcomponent_ids_type="set_find_all_causal_paths_wcomponent_ids",set_find_all_causal_paths_wcomponent_ids=t=>({type:set_find_all_causal_paths_wcomponent_ids_type,...t}),is_set_find_all_causal_paths_wcomponent_ids=t=>t.type===set_find_all_causal_paths_wcomponent_ids_type,find_all_causal_paths_actions={set_find_all_causal_paths_wcomponent_ids},clicked_wcomponent_type="clicked_wcomponent",clicked_wcomponent=t=>({type:clicked_wcomponent_type,...t}),is_clicked_wcomponent=t=>t.type===clicked_wcomponent_type,clear_selected_wcomponents_type="clear_selected_wcomponents",clear_selected_wcomponents=t=>({type:clear_selected_wcomponents_type,...t}),is_clear_selected_wcomponents=t=>t.type===clear_selected_wcomponents_type,set_selected_wcomponents_type="set_selected_wcomponents",set_selected_wcomponents=t=>({type:set_selected_wcomponents_type,...t}),is_set_selected_wcomponents=t=>t.type===set_selected_wcomponents_type,pointerupdown_on_connection_terminal_type="pointerupdown_on_connection_terminal",pointerupdown_on_connection_terminal=t=>({type:pointerupdown_on_connection_terminal_type,...t}),is_pointerupdown_on_connection_terminal=t=>t.type===pointerupdown_on_connection_terminal_type,is_pointerup_on_connection_terminal=t=>is_pointerupdown_on_connection_terminal(t)&&t.up_down==="up",is_pointerdown_on_connection_terminal=t=>is_pointerupdown_on_connection_terminal(t)&&t.up_down==="down",pointerupdown_on_component_type="pointerupdown_on_component",pointerupdown_on_component=t=>({type:pointerupdown_on_component_type,...t}),is_pointerupdown_on_component=t=>t.type===pointerupdown_on_component_type,is_pointerup_on_component=t=>is_pointerupdown_on_component(t)&&t.up_down==="up",is_pointerdown_on_component=t=>is_pointerupdown_on_component(t)&&t.up_down==="down",clear_pointerupdown_on_connection_terminal_type="clear_pointerupdown_on_connection_terminal",clear_pointerupdown_on_connection_terminal=t=>({type:clear_pointerupdown_on_connection_terminal_type,...t}),is_clear_pointerupdown_on_connection_terminal=t=>t.type===clear_pointerupdown_on_connection_terminal_type,set_wcomponent_ids_to_move_type="set_wcomponent_ids_to_move",set_wcomponent_ids_to_move=t=>({type:set_wcomponent_ids_to_move_type,...t}),is_set_wcomponent_ids_to_move=t=>t.type===set_wcomponent_ids_to_move_type,selecting_actions={clicked_wcomponent,clear_selected_wcomponents,set_selected_wcomponents,pointerupdown_on_connection_terminal,pointerupdown_on_component,clear_pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move},set_frame_is_resizing_type="set_frame_is_resizing",set_frame_is_resizing=t=>({type:set_frame_is_resizing_type,...t}),is_set_frame_is_resizing=t=>t.type===set_frame_is_resizing_type,meta_wcomponents_actions=safe_merge({set_frame_is_resizing},selecting_actions,find_all_causal_paths_actions),ACTIONS={controls:controls_actions,creation_context:creation_context_actions,filter_context:filter_context_actions,display:display_actions,sync:sync_actions,routing:routing_actions,global_keys:global_keys_actions,display_at_created_datetime:display_at_created_datetime_actions,display_at_sim_datetime:display_at_sim_datetime_actions,search:search_actions,specialised_object:specialised_object_actions,meta_wcomponents:meta_wcomponents_actions,user_info:user_info_actions,view_priorities:view_priorities_actions};function calc_prediction_is_uncertain({probability:t,conviction:ee}){return t>0&&t<1||ee!==1}function calc_prediction_certainty({probability:t,conviction:ee}){return Math.min(t,ee)}const default_value=()=>({is_defined:!1,is_valid:!0,certainty:1});function get_wcomponent_validity_value(t){const{wcomponent:ee,created_at_ms:te,sim_ms:ne}=t;if(!wcomponent_has_validity_predictions(ee))return default_value();const oe=partition_and_prune_items_by_datetimes_and_versions({items:ee.validity,created_at_ms:te,sim_ms:ne}).present_item;if(!oe)return default_value();const ie=oe.probability>.5,se=calc_prediction_certainty(oe);return{is_defined:!0,is_valid:ie,certainty:se}}function calc_wcomponent_should_display(t){const{wcomponent:ee,kv_entry:te,sim_ms:ne,selected_wcomponent_ids_set:oe,wc_ids_excluded_by_filters:ie}=t;if(!te||te.blocked)return!1;if(oe.has(ee.id))return{display_certainty:1};if(ie.has(ee.id)||wcomponent_is_not_yet_created(ee,t.created_at_ms))return!1;const re=get_wcomponent_validity_value(t).certainty;if(get_wcomponent_is_invalid_for_display({validity_certain:re,validity_filter:t.validity_filter}))return!1;let ae=re;if(wcomponent_has_event_at(ee)){const ce=get_certainty_for_wcomponent_event_at({event_at:ee.event_at,sim_ms:ne});ce!==void 0&&(ae=Math.min(ae,ce))}return{display_certainty:ae}}function wcomponent_is_not_yet_created(t,ee){return get_created_at_ms(t)>ee}function get_wcomponent_is_invalid_for_display(t){let ee=!1;const{validity_certain:te,validity_filter:ne}=t;return ne.show_invalid?ee=!0:ne.maybe_invalid?ee=te>0:ne.only_maybe_valid?ee=te>.5:ne.only_certain_valid?ee=te===1:console.error("Unsupported validity_filter: "+JSON.stringify(ne)),!ee}function get_certainty_for_wcomponent_event_at(t){const{event_at:ee,sim_ms:te}=t,ne=ee[0];if(ne)return ne.probability*ne.conviction}function calc_connection_wcomponent_should_display(t){const{from_wc:ee,from_wc__kv_entry:te,to_wc:ne,to_wc__kv_entry:oe}=t;if(!ee||!ne)return{display_certainty:1};if(!te||!oe)return!1;const ie=calc_wcomponent_should_display(t);if(!ie)return!1;const se=calc_wcomponent_should_display({...t,wcomponent:ee,kv_entry:te});return!se||!calc_wcomponent_should_display({...t,wcomponent:ne,kv_entry:oe})?!1:{display_certainty:Math.min(ie.display_certainty,se.display_certainty)}}function calc_judgement_connection_wcomponent_should_display(t){const{target_wc:ee,target_wc__kv_entry:te}=t;if(!ee||!te)return!1;const ne=calc_wcomponent_should_display(t);if(!ne)return!1;const oe=calc_wcomponent_should_display({...t,wcomponent:ee,kv_entry:te});return oe?{display_certainty:Math.min(ne.display_certainty,oe.display_certainty)}:!1}function calc_display_opacity(t){if(t.is_highlighted||t.is_selected||t.is_current_item||t.certainty_formatting.render_100_opacity&&!t.focused_mode||t.connected_neighbour_is_highlighted)return 1;if(t.focused_mode)return .1;if(t.is_editing)return 1;const ee=t.certainty_formatting.render_certainty_as_easier_opacity;return t.certainty===1?1:ee?rescale(t.certainty,.4,.7):rescale(t.certainty,.1,.5)}function factory_on_click(t){const{wcomponent_id:ee,shift_or_control_keys_are_down:te,change_route:ne,clicked_wcomponent:oe,clear_selected_wcomponents:ie,is_current_item:se}=t;return re=>{re.stopImmediatePropagation(),re.preventDefault(),oe({id:ee}),te?ne({route:"wcomponents",sub_route:"wcomponents_edit_multiple",item_id:null}):se?(ne({route:"wcomponents",sub_route:null,item_id:null}),ie({})):ne({route:"wcomponents",sub_route:null,item_id:ee})}}function get_wc_id_to_counterfactuals_v2_map$1(t,ee=!0){var te,ne;return ee?(te=t.derived.current_composed_knowledge_view)==null?void 0:te.wc_id_to_active_counterfactuals_v2_map:(ne=t.derived.current_composed_knowledge_view)==null?void 0:ne.wc_id_to_counterfactuals_v2_map}function get_VAP_set_id_to_counterfactual_v2_map(t,ee){var ne;if(!ee)return;const te=get_wc_id_to_counterfactuals_v2_map$1(t);return te&&((ne=te[ee])==null?void 0:ne.VAP_sets)}function get_overlapping_wcomponent_ids(t,ee){const{overlapping_wc_ids:te={}}=t.derived.current_composed_knowledge_view||{};return te[ee]}const map_state$1X=(t,ee)=>{const{id:te}=ee,ne=get_wcomponent_from_state(t,te),{selected_wcomponent_ids_set:oe}=t.meta_wcomponents,{current_composed_knowledge_view:ie}=t.derived,{created_at_ms:se,sim_ms:re}=t.routing.args,{derived_validity_filter:_e}=t.display_options,ae=!t.display_options.consumption_formatting;let ce=!1,le,ue,de;if(!(!ne||!ie)){const{wc_ids_excluded_by_filters:fe}=ie.filters,ge=ie.composed_wc_id_map[ne.id];if(wcomponent_is_plain_connection(ne)){le=get_wcomponent_from_state(t,ne.from_id),ue=get_wcomponent_from_state(t,ne.to_id);const he=ie.composed_wc_id_map[ne.from_id],be=ie.composed_wc_id_map[ne.to_id];ce=calc_connection_wcomponent_should_display({wcomponent:ne,kv_entry:ge,validity_filter:_e,from_wc:le,to_wc:ue,from_wc__kv_entry:he,to_wc__kv_entry:be,created_at_ms:se,sim_ms:re,selected_wcomponent_ids_set:oe,wc_ids_excluded_by_filters:fe}),de=calculate_effect(ne,le,t)}else if(wcomponent_is_judgement_or_objective(ne)){const he=ne.judgement_target_wcomponent_id,be=get_wcomponent_from_state(t,he),ve=ie.composed_wc_id_map[he];ce=calc_judgement_connection_wcomponent_should_display({wcomponent:ne,kv_entry:ge,validity_filter:_e,target_wc:be,target_wc__kv_entry:ve,created_at_ms:se,sim_ms:re,selected_wcomponent_ids_set:oe,wc_ids_excluded_by_filters:fe})}}const me=ce===!1?!1:ce.display_certainty,pe=t.global_keys.derived.shift_or_control_down;return{current_composed_knowledge_view:ie,wcomponent:ne,connection_effect:de,validity_value:me,is_current_item:t.routing.item_id===te,is_selected:t.meta_wcomponents.selected_wcomponent_ids_set.has(te),is_highlighted:t.meta_wcomponents.highlighted_wcomponent_ids.has(te),is_editing:ae,certainty_formatting:t.display_options.derived_certainty_formatting,shift_or_control_keys_are_down:pe,focused_mode:t.display_options.focused_mode,connected_neighbour_is_highlighted:t.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(te),circular_links:t.display_options.circular_links}},map_dispatch$16={clicked_wcomponent:ACTIONS.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:ACTIONS.meta_wcomponents.clear_selected_wcomponents,set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,change_route:ACTIONS.routing.change_route},connector$1Z=connect(map_state$1X,map_dispatch$16);function _WComponentCanvasConnection(t){const{id:ee,current_composed_knowledge_view:te,wcomponent:ne,is_current_item:oe,is_highlighted:ie,is_selected:se,validity_value:re,connection_effect:_e,shift_or_control_keys_are_down:ae,change_route:ce,clicked_wcomponent:le,clear_selected_wcomponents:ue}=t;if(!ne)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${ee}" but could not find it`),null;if(!wcomponent_can_render_connection(ne))return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${ee}" but was not a causal link`),null;if(re===!1)return null;if(!te)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${ee}" but no current_composed_knowledge_view`),null;const de=factory_on_click({wcomponent_id:ee,clicked_wcomponent:le,clear_selected_wcomponents:ue,shift_or_control_keys_are_down:ae,change_route:ce,is_current_item:oe}),{from_node_position:me,to_node_position:pe,from_attribute:fe,to_attribute:ge}=get_connection_terminal_node_positions({wcomponent:ne,wc_id_map:te.composed_wc_id_map}),{from_connection_type:he,to_connection_type:be}=F$1(()=>({from_connection_type:{direction:"from",attribute:fe},to_connection_type:{direction:"to",attribute:ge}}),[fe,ge]),ve=calc_display_opacity({is_editing:t.is_editing,certainty:re,is_current_item:oe,is_selected:se,connected_neighbour_is_highlighted:t.connected_neighbour_is_highlighted,certainty_formatting:t.certainty_formatting,focused_mode:t.focused_mode});let ye=2,we=ConnectionEndType.positive,ke="";_e!==void 0&&(ye=bounded(Math.abs(_e),2,15),_e<0?(we=ConnectionEndType.negative,ke="negative_connection_effect"):_e===0&&(we=ConnectionEndType.noop,ke="no_connection_effect"));let Ae;return wcomponent_is_plain_connection(ne)&&(Ae=ne.line_behaviour),o$1(CanvasConnnection,{from_node_position:me,to_node_position:pe,from_connection_type:he,to_connection_type:be,on_click:de,on_pointer_over_out:$e=>t.set_highlighted_wcomponent({id:ee,highlighted:$e}),line_behaviour:Ae,circular_links:t.circular_links,thickness:ye,connection_end_type:we,intensity:ve,is_highlighted:oe||ie||se,focused_mode:t.focused_mode,extra_css_classes:"connection_type_"+ne.type+" "+ke})}const WComponentCanvasConnection=connector$1Z(_WComponentCanvasConnection);function get_connection_terminal_node_positions({wcomponent:t,wc_id_map:ee}){let te,ne,oe,ie;return wcomponent_is_plain_connection(t)?(te=ee[t.from_id],ne=ee[t.to_id],oe=t.from_type,ie=t.to_type):(te=ee[t.id],ne=ee[t.judgement_target_wcomponent_id],oe="meta",ie="meta"),{from_node_position:te,to_node_position:ne,from_attribute:oe,to_attribute:ie}}function calculate_effect(t,ee,te){var oe;let ne;if(wcomponent_is_causal_link(t)&&(ne=t.effect_when_true,wcomponent_is_statev2(ee))){const ie=get_current_VAP_set({values_and_prediction_sets:ee.values_and_prediction_sets,created_at_ms:te.routing.args.created_at_ms,sim_ms:te.routing.args.sim_ms});if(ie){const se=get_VAP_set_id_to_counterfactual_v2_map(te,ee.id),re=apply_counterfactuals_v2_to_VAP_set({VAP_set:ie,VAP_set_id_to_counterfactual_v2_map:se}),ae=get_wcomponent_VAPs_represent(ee,{}),le=(oe=convert_VAP_set_to_VAP_visuals({wcomponent:ee,VAP_set:re,VAPs_represent:ae})[0])==null?void 0:oe.parsed_value;le!=null&&(ae===VAPsType.boolean?ne=le===!0?t.effect_when_true:t.effect_when_false:ne=typeof le=="number"?t.effect_when_true!==void 0?le*t.effect_when_true:void 0:t.effect_when_true)}}return ne!==void 0?bounded(ne,-100,100):void 0}function n(){return n=Object.assign||function(t){for(var ee=1;ee<arguments.length;ee++){var te=arguments[ee];for(var ne in te)Object.prototype.hasOwnProperty.call(te,ne)&&(t[ne]=te[ne])}return t},n.apply(this,arguments)}const e=["children","options"],r=["allowFullScreen","allowTransparency","autoComplete","autoFocus","autoPlay","cellPadding","cellSpacing","charSet","className","classId","colSpan","contentEditable","contextMenu","crossOrigin","encType","formAction","formEncType","formMethod","formNoValidate","formTarget","frameBorder","hrefLang","inputMode","keyParams","keyType","marginHeight","marginWidth","maxLength","mediaGroup","minLength","noValidate","radioGroup","readOnly","rowSpan","spellCheck","srcDoc","srcLang","srcSet","tabIndex","useMap"].reduce((t,ee)=>(t[ee.toLowerCase()]=ee,t),{for:"htmlFor"}),o={amp:"&",apos:"'",gt:">",lt:"<",nbsp:" ",quot:"“"},c=["style","script"],a=/([-A-Z0-9_:]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|(?:\{((?:\\.|{[^}]*?}|[^}])*)\})))?/gi,_$c=/mailto:/i,u=/\n{2,}$/,i$1=/^( *>[^\n]+(\n[^\n]+)*\n*)+\n{2,}/,l=/^ *> ?/gm,s=/^ {2,}\n/,f=/^(?:( *[-*_])){3,} *(?:\n *)+\n/,d$a=/^\s*(`{3,}|~{3,}) *(\S+)?([^\n]*?)?\n([\s\S]+?)\s*\1 *(?:\n *)*\n?/,p=/^(?: {4}[^\n]+\n*)+(?:\n *)+\n?/,m=/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,g=/^(?:\n *)*\n/,y=/\r\n?/g,h=/^\[\^([^\]]+)](:.*)\n/,k=/^\[\^([^\]]+)]/,x=/\f/g,b=/^\s*?\[(x|\s)\]/,v=/^ *(#{1,6}) *([^\n]+?)(?: +#*)?(?:\n *)*(?:\n|$)/,$=/^([^\n]+)\n *(=|-){3,} *(?:\n *)+\n/,S=/^ *(?!<[a-z][^ >/]* ?\/>)<([a-z][^ >/]*) ?([^>]*)\/{0}>\n?(\s*(?:<\1[^>]*?>[\s\S]*?<\/\1>|(?!<\1)[\s\S])*?)<\/\1>\n*/i,z=/&([a-zA-Z]+);/g,w=/^<!--[\s\S]*?(?:-->)/,A=/^(data|aria|x)-[a-z_][a-z\d_.-]*$/,E=/^ *<([a-z][a-z0-9:]*)(?:\s+((?:<.*?>|[^>])*))?\/?>(?!<\/\1>)(\s*\n)?/i,L=/^\{.*\}$/,M=/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,I=/^<([^ >]+@[^ >]+)>/,O=/^<([^ >]+:\/[^ >]+)>/,B=/-([a-z])?/gi,R=/^(.*\|?.*)\n *(\|? *[-:]+ *\|[-| :]*)\n((?:.*\|.*\n)*)\n?/,T=/^\[([^\]]*)\]:\s+<?([^\s>]+)>?\s*("([^"]*)")?/,j=/^!\[([^\]]*)\] ?\[([^\]]*)\]/,C=/^\[([^\]]*)\] ?\[([^\]]*)\]/,D=/(\[|\])/g,N=/(\n|^[-*]\s|^#|^ {2,}|^-{2,}|^>\s)/,Z=/\t/g,F=/^ *\| */,P=/(^ *\||\| *$)/g,G=/ *$/,H=/^ *:-+: *$/,q=/^ *:-+ *$/,U=/^ *-+: *$/,V=/^([*_])\1((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1\1(?!\1)/,W=/^([*_])((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1(?!\1|\w)/,Q=/^==((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)==/,X=/^~~((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)~~/,J=/^\\([^0-9A-Za-z\s])/,K=/^[\s\S]+?(?=[^0-9A-Z\s\u00c0-\uffff&;.()'"]|\d+\.|\n\n| {2,}\n|\w+:\S|$)/i,Y=/^\n+/,tt=/^([ \t]*)/,nt=/\\([^\\])/g,et=/ *\n+$/,rt=/(?:^|\n)( *)$/,ot="(?:\\d+\\.)",ct="(?:[*+-])";function at(t){return"( *)("+(t===1?ot:ct)+") +"}const _t=at(1),ut=at(2);function it(t){return new RegExp("^"+(t===1?_t:ut))}const lt=it(1),st=it(2);function ft(t){return new RegExp("^"+(t===1?_t:ut)+"[^\\n]*(?:\\n(?!\\1"+(t===1?ot:ct)+" )[^\\n]*)*(\\n|$)","gm")}const dt=ft(1),pt=ft(2);function mt(t){const ee=t===1?ot:ct;return new RegExp("^( *)("+ee+") [\\s\\S]+?(?:\\n{2,}(?! )(?!\\1"+ee+" (?!"+ee+" ))\\n*|\\s*\\n*$)")}const gt=mt(1),yt=mt(2);function ht(t,ee){const te=ee===1,ne=te?gt:yt,oe=te?dt:pt,ie=te?lt:st;return{t(se,re,_e){const ae=rt.exec(_e);return ae&&(re.o||!re._&&!re.u)?ne.exec(se=ae[1]+se):null},i:Gt.HIGH,l(se,re,_e){const ae=te?+se[2]:void 0,ce=se[0].replace(u,`
`).match(oe);let le=!1;return{p:ce.map(function(ue,de){const me=ie.exec(ue)[0].length,pe=new RegExp("^ {1,"+me+"}","gm"),fe=ue.replace(pe,"").replace(ie,""),ge=de===ce.length-1,he=fe.indexOf(`

`)!==-1||ge&&le;le=he;const be=_e._,ve=_e.o;let ye;_e.o=!0,he?(_e._=!1,ye=fe.replace(et,`

`)):(_e._=!0,ye=fe.replace(et,""));const we=re(ye,_e);return _e._=be,_e.o=ve,we}),m:te,g:ae}},h:(se,re,_e)=>t(se.m?"ol":"ul",{key:_e.k,start:se.g},se.p.map(function(ae,ce){return t("li",{key:ce},re(ae,_e))}))}}const kt=/^\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,xt=/^!\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,bt=[i$1,d$a,p,v,$,w,R,dt,gt,pt,yt],vt=[...bt,/^[^\n]+(?:  \n|\n{2,})/,S,E];function $t(t){return t.replace(/[ÀÁÂÃÄÅàáâãäåæÆ]/g,"a").replace(/[çÇ]/g,"c").replace(/[ðÐ]/g,"d").replace(/[ÈÉÊËéèêë]/g,"e").replace(/[ÏïÎîÍíÌì]/g,"i").replace(/[Ññ]/g,"n").replace(/[øØœŒÕõÔôÓóÒò]/g,"o").replace(/[ÜüÛûÚúÙù]/g,"u").replace(/[ŸÿÝý]/g,"y").replace(/[^a-z0-9- ]/gi,"").replace(/ /gi,"-").toLowerCase()}function St(t){return U.test(t)?"right":H.test(t)?"center":q.test(t)?"left":null}function zt(t,ee,te){const ne=te.v;te.v=!0;const oe=ee(t.trim(),te);te.v=ne;let ie=[[]];return oe.forEach(function(se,re){se.type==="tableSeparator"?re!==0&&re!==oe.length-1&&ie.push([]):(se.type!=="text"||oe[re+1]!=null&&oe[re+1].type!=="tableSeparator"||(se.$=se.$.replace(G,"")),ie[ie.length-1].push(se))}),ie}function wt(t,ee,te){te._=!0;const ne=zt(t[1],ee,te),oe=t[2].replace(P,"").split("|").map(St),ie=function(se,re,_e){return se.trim().split(`
`).map(function(ae){return zt(ae,re,_e)})}(t[3],ee,te);return te._=!1,{S:oe,A:ie,L:ne,type:"table"}}function At(t,ee){return t.S[ee]==null?{}:{textAlign:t.S[ee]}}function Et(t){return function(ee,te){return te._?t.exec(ee):null}}function Lt(t){return function(ee,te){return te._||te.u?t.exec(ee):null}}function Mt(t){return function(ee,te){return te._||te.u?null:t.exec(ee)}}function It(t){return function(ee){return t.exec(ee)}}function Ot(t,ee,te){if(ee._||ee.u||te&&!te.endsWith(`
`))return null;let ne="";t.split(`
`).every(ie=>!bt.some(se=>se.test(ie))&&(ne+=ie+`
`,ie.trim()));const oe=ne.trimEnd();return oe==""?null:[ne,oe]}function Bt(t){try{if(decodeURIComponent(t).replace(/[^A-Za-z0-9/:]/g,"").match(/^\s*(javascript|vbscript|data(?!:image)):/i))return null}catch{return null}return t}function Rt(t){return t.replace(nt,"$1")}function Tt(t,ee,te){const ne=te._||!1,oe=te.u||!1;te._=!0,te.u=!0;const ie=t(ee,te);return te._=ne,te.u=oe,ie}function jt(t,ee,te){const ne=te._||!1,oe=te.u||!1;te._=!1,te.u=!0;const ie=t(ee,te);return te._=ne,te.u=oe,ie}function Ct(t,ee,te){return te._=!1,t(ee+`

`,te)}const Dt=(t,ee,te)=>({$:Tt(ee,t[1],te)});function Nt(){return{}}function Zt(){return null}function Ft(...t){return t.filter(Boolean).join(" ")}function Pt(t,ee,te){let ne=t;const oe=ee.split(".");for(;oe.length&&(ne=ne[oe[0]],ne!==void 0);)oe.shift();return ne||te}var Gt;function Ht(t,ee={}){ee.overrides=ee.overrides||{},ee.slugify=ee.slugify||$t,ee.namedCodesToUnicode=ee.namedCodesToUnicode?n({},o,ee.namedCodesToUnicode):o;const te=ee.createElement||y$1;function ne(de,me,...pe){const fe=Pt(ee.overrides,`${de}.props`,{});return te(function(ge,he){const be=Pt(he,ge);return be?typeof be=="function"||typeof be=="object"&&"render"in be?be:Pt(he,`${ge}.component`,ge):ge}(de,ee.overrides),n({},me,fe,{className:Ft(me==null?void 0:me.className,fe.className)||void 0}),...pe)}function oe(de){let me=!1;ee.forceInline?me=!0:ee.forceBlock||(me=N.test(de)===!1);const pe=ce(ae(me?de:`${de.trimEnd().replace(Y,"")}

`,{_:me}));for(;typeof pe[pe.length-1]=="string"&&!pe[pe.length-1].trim();)pe.pop();if(ee.wrapper===null)return pe;const fe=ee.wrapper||(me?"span":"div");let ge;if(pe.length>1||ee.forceWrapper)ge=pe;else{if(pe.length===1)return ge=pe[0],typeof ge=="string"?ne("span",{key:"outer"},ge):ge;ge=null}return y$1(fe,{key:"outer"},ge)}function ie(de){const me=de.match(a);return me?me.reduce(function(pe,fe,ge){const he=fe.indexOf("=");if(he!==-1){const be=function(ke){return ke.indexOf("-")!==-1&&ke.match(A)===null&&(ke=ke.replace(B,function(Ae,$e){return $e.toUpperCase()})),ke}(fe.slice(0,he)).trim(),ve=function(ke){const Ae=ke[0];return(Ae==='"'||Ae==="'")&&ke.length>=2&&ke[ke.length-1]===Ae?ke.slice(1,-1):ke}(fe.slice(he+1).trim()),ye=r[be]||be,we=pe[ye]=function(ke,Ae){return ke==="style"?Ae.split(/;\s?/).reduce(function($e,xe){const Ce=xe.slice(0,xe.indexOf(":"));return $e[Ce.replace(/(-[a-z])/g,Se=>Se[1].toUpperCase())]=xe.slice(Ce.length+1).trim(),$e},{}):ke==="href"?Bt(Ae):(Ae.match(L)&&(Ae=Ae.slice(1,Ae.length-1)),Ae==="true"||Ae!=="false"&&Ae)}(be,ve);typeof we=="string"&&(S.test(we)||E.test(we))&&(pe[ye]=sn(oe(we.trim()),{key:ge}))}else fe!=="style"&&(pe[r[fe]||fe]=!0);return pe},{}):null}const se=[],re={},_e={blockQuote:{t:Mt(i$1),i:Gt.HIGH,l:(de,me,pe)=>({$:me(de[0].replace(l,""),pe)}),h:(de,me,pe)=>ne("blockquote",{key:pe.k},me(de.$,pe))},breakLine:{t:It(s),i:Gt.HIGH,l:Nt,h:(de,me,pe)=>ne("br",{key:pe.k})},breakThematic:{t:Mt(f),i:Gt.HIGH,l:Nt,h:(de,me,pe)=>ne("hr",{key:pe.k})},codeBlock:{t:Mt(p),i:Gt.MAX,l:de=>({$:de[0].replace(/^ {4}/gm,"").replace(/\n+$/,""),M:void 0}),h:(de,me,pe)=>ne("pre",{key:pe.k},ne("code",n({},de.I,{className:de.M?`lang-${de.M}`:""}),de.$))},codeFenced:{t:Mt(d$a),i:Gt.MAX,l:de=>({I:ie(de[3]||""),$:de[4],M:de[2]||void 0,type:"codeBlock"})},codeInline:{t:Lt(m),i:Gt.LOW,l:de=>({$:de[2]}),h:(de,me,pe)=>ne("code",{key:pe.k},de.$)},footnote:{t:Mt(h),i:Gt.MAX,l:de=>(se.push({O:de[2],B:de[1]}),{}),h:Zt},footnoteReference:{t:Et(k),i:Gt.HIGH,l:de=>({$:de[1],R:`#${ee.slugify(de[1])}`}),h:(de,me,pe)=>ne("a",{key:pe.k,href:Bt(de.R)},ne("sup",{key:pe.k},de.$))},gfmTask:{t:Et(b),i:Gt.HIGH,l:de=>({T:de[1].toLowerCase()==="x"}),h:(de,me,pe)=>ne("input",{checked:de.T,key:pe.k,readOnly:!0,type:"checkbox"})},heading:{t:Mt(v),i:Gt.HIGH,l:(de,me,pe)=>({$:Tt(me,de[2],pe),j:ee.slugify(de[2]),C:de[1].length}),h:(de,me,pe)=>ne(`h${de.C}`,{id:de.j,key:pe.k},me(de.$,pe))},headingSetext:{t:Mt($),i:Gt.MAX,l:(de,me,pe)=>({$:Tt(me,de[1],pe),C:de[2]==="="?1:2,type:"heading"})},htmlComment:{t:It(w),i:Gt.HIGH,l:()=>({}),h:Zt},image:{t:Lt(xt),i:Gt.HIGH,l:de=>({D:de[1],R:Rt(de[2]),N:de[3]}),h:(de,me,pe)=>ne("img",{key:pe.k,alt:de.D||void 0,title:de.N||void 0,src:Bt(de.R)})},link:{t:Et(kt),i:Gt.LOW,l:(de,me,pe)=>({$:jt(me,de[1],pe),R:Rt(de[2]),N:de[3]}),h:(de,me,pe)=>ne("a",{key:pe.k,href:Bt(de.R),title:de.N},me(de.$,pe))},linkAngleBraceStyleDetector:{t:Et(O),i:Gt.MAX,l:de=>({$:[{$:de[1],type:"text"}],R:de[1],type:"link"})},linkBareUrlDetector:{t:(de,me)=>me.Z?null:Et(M)(de,me),i:Gt.MAX,l:de=>({$:[{$:de[1],type:"text"}],R:de[1],N:void 0,type:"link"})},linkMailtoDetector:{t:Et(I),i:Gt.MAX,l(de){let me=de[1],pe=de[1];return _$c.test(pe)||(pe="mailto:"+pe),{$:[{$:me.replace("mailto:",""),type:"text"}],R:pe,type:"link"}}},orderedList:ht(ne,1),unorderedList:ht(ne,2),newlineCoalescer:{t:Mt(g),i:Gt.LOW,l:Nt,h:()=>`
`},paragraph:{t:Ot,i:Gt.LOW,l:Dt,h:(de,me,pe)=>ne("p",{key:pe.k},me(de.$,pe))},ref:{t:Et(T),i:Gt.MAX,l:de=>(re[de[1]]={R:de[2],N:de[4]},{}),h:Zt},refImage:{t:Lt(j),i:Gt.MAX,l:de=>({D:de[1]||void 0,F:de[2]}),h:(de,me,pe)=>ne("img",{key:pe.k,alt:de.D,src:Bt(re[de.F].R),title:re[de.F].N})},refLink:{t:Et(C),i:Gt.MAX,l:(de,me,pe)=>({$:me(de[1],pe),P:me(de[0].replace(D,"\\$1"),pe),F:de[2]}),h:(de,me,pe)=>re[de.F]?ne("a",{key:pe.k,href:Bt(re[de.F].R),title:re[de.F].N},me(de.$,pe)):ne("span",{key:pe.k},me(de.P,pe))},table:{t:Mt(R),i:Gt.HIGH,l:wt,h:(de,me,pe)=>ne("table",{key:pe.k},ne("thead",null,ne("tr",null,de.L.map(function(fe,ge){return ne("th",{key:ge,style:At(de,ge)},me(fe,pe))}))),ne("tbody",null,de.A.map(function(fe,ge){return ne("tr",{key:ge},fe.map(function(he,be){return ne("td",{key:be,style:At(de,be)},me(he,pe))}))})))},tableSeparator:{t:function(de,me){return me.v?F.exec(de):null},i:Gt.HIGH,l:function(){return{type:"tableSeparator"}},h:()=>" | "},text:{t:It(K),i:Gt.MIN,l:de=>({$:de[0].replace(z,(me,pe)=>ee.namedCodesToUnicode[pe]?ee.namedCodesToUnicode[pe]:me)}),h:de=>de.$},textBolded:{t:Lt(V),i:Gt.MED,l:(de,me,pe)=>({$:me(de[2],pe)}),h:(de,me,pe)=>ne("strong",{key:pe.k},me(de.$,pe))},textEmphasized:{t:Lt(W),i:Gt.LOW,l:(de,me,pe)=>({$:me(de[2],pe)}),h:(de,me,pe)=>ne("em",{key:pe.k},me(de.$,pe))},textEscaped:{t:Lt(J),i:Gt.HIGH,l:de=>({$:de[1],type:"text"})},textMarked:{t:Lt(Q),i:Gt.LOW,l:Dt,h:(de,me,pe)=>ne("mark",{key:pe.k},me(de.$,pe))},textStrikethroughed:{t:Lt(X),i:Gt.LOW,l:Dt,h:(de,me,pe)=>ne("del",{key:pe.k},me(de.$,pe))}};ee.disableParsingRawHTML!==!0&&(_e.htmlBlock={t:It(S),i:Gt.HIGH,l(de,me,pe){const[,fe]=de[3].match(tt),ge=new RegExp(`^${fe}`,"gm"),he=de[3].replace(ge,""),be=(ve=he,vt.some(Ae=>Ae.test(ve))?Ct:Tt);var ve;const ye=de[1].toLowerCase(),we=c.indexOf(ye)!==-1;pe.Z=pe.Z||ye==="a";const ke=we?de[3]:be(me,he,pe);return pe.Z=!1,{I:ie(de[2]),$:ke,G:we,H:we?ye:de[1]}},h:(de,me,pe)=>ne(de.H,n({key:pe.k},de.I),de.G?de.$:me(de.$,pe))},_e.htmlSelfClosing={t:It(E),i:Gt.HIGH,l:de=>({I:ie(de[2]||""),H:de[1]}),h:(de,me,pe)=>ne(de.H,n({},de.I,{key:pe.k}))});const ae=function(de){let me=Object.keys(de);function pe(fe,ge){let he=[],be="";for(;fe;){let ve=0;for(;ve<me.length;){const ye=me[ve],we=de[ye],ke=we.t(fe,ge,be);if(ke){const Ae=ke[0];fe=fe.substring(Ae.length);const $e=we.l(ke,pe,ge);$e.type==null&&($e.type=ye),he.push($e),be=Ae;break}ve++}}return he}return me.sort(function(fe,ge){let he=de[fe].i,be=de[ge].i;return he!==be?he-be:fe<ge?-1:1}),function(fe,ge){return pe(function(he){return he.replace(y,`
`).replace(x,"").replace(Z,"    ")}(fe),ge)}}(_e),ce=(le=function(de){return function(me,pe,fe){return de[me.type].h(me,pe,fe)}}(_e),function de(me,pe={}){if(Array.isArray(me)){const fe=pe.k,ge=[];let he=!1;for(let be=0;be<me.length;be++){pe.k=be;const ve=de(me[be],pe),ye=typeof ve=="string";ye&&he?ge[ge.length-1]+=ve:ve!==null&&ge.push(ve),he=ye}return pe.k=fe,ge}return le(me,de,pe)});var le;const ue=oe(t);return se.length?ne("div",null,ue,ne("footer",{key:"footer"},se.map(function(de){return ne("div",{id:ee.slugify(de.B),key:de.B},de.B,ce(ae(de.O,{_:!0})))}))):ue}(function(t){t[t.MAX=0]="MAX",t[t.HIGH=1]="HIGH",t[t.MED=2]="MED",t[t.LOW=3]="LOW",t[t.MIN=4]="MIN"})(Gt||(Gt={}));const Markdown=t=>{let{children:ee,options:te}=t,ne=function(oe,ie){if(oe==null)return{};var se,re,_e={},ae=Object.keys(oe);for(re=0;re<ae.length;re++)ie.indexOf(se=ae[re])>=0||(_e[se]=oe[se]);return _e}(t,e);return sn(Ht(ee,te),ne)};var Description={},_interopRequireDefault$y=interopRequireDefaultExports;Object.defineProperty(Description,"__esModule",{value:!0});var default_1$y=Description.default=void 0,_createSvgIcon$y=_interopRequireDefault$y(requireCreateSvgIcon()),_jsxRuntime$y=requireJsxRuntime(),_default$y=(0,_createSvgIcon$y.default)((0,_jsxRuntime$y.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"}),"Description");default_1$y=Description.default=_default$y;const WComponentCanvasNode$1="",ConnectableCanvasNode$1="";function CanvasNode(t){const{position:ee,extra_styles:te,display:ne,extra_css_class:oe,title:ie,children:se}=t,{on_pointer_enter:re,on_pointer_leave:_e,on_pointer_down:ae,on_pointer_up:ce,on_click:le}=t,ue={...ee,position:ee?"absolute":"relative",display:ne===void 0||ne?"":"none",...te},me=`node ${ae||ce||le||re||_e?"mouseable":""} ${oe||""}`;return o$1("div",{...t.extra_args,className:me,style:ue,title:ie,onPointerDown:ae||(pe=>{pe.stopImmediatePropagation(),pe.preventDefault()}),onPointerUp:ce,onClick:le,onPointerEnter:re,onPointerLeave:_e,onContextMenu:pe=>{pe.preventDefault()},children:se})}const display_colors="";function ConnectableCanvasNode(t){let{opacity:ee}=t;const te={display:t.hidden?"none":"",opacity:ee};t.unlimited_width&&(te.maxWidth="initial");const ne={boxShadow:t.glow?`${t.glow} 0px 0px 10px`:"",backgroundColor:t.color,...t.extra_styles_for_node_main_content},{pointerupdown_on_connection_terminal:oe=()=>{}}=t,ie=" connectable_canvas_node "+(t.extra_css_class||"");return o$1(CanvasNode,{position:t.position,on_pointer_down:t.on_pointer_down,on_pointer_up:t.on_pointer_up,on_click:t.on_click,on_pointer_enter:t.on_pointer_enter,on_pointer_leave:t.on_pointer_leave,extra_css_class:ie,extra_styles:te,extra_args:t.extra_args,children:[o$1(Card,{className:"node_main_content",variant:"outlined",style:ne,children:[t.cover_image&&o$1(CardMedia,{component:"img",image:t.cover_image,className:"node_image_content",onContextMenu:se=>{se.stopImmediatePropagation()}}),o$1(CardContent,{style:{padding:16},children:t.node_main_content}),t.terminals.map(({type:se,style:re,label:_e})=>o$1("div",{className:"connection_terminal",style:{...connection_style_common,...re},onPointerDown:ae=>{ae.stopPropagation(),oe(se,"down")},onPointerUp:ae=>{ae.stopPropagation(),oe(se,"up")},children:_e}))]}),t.other_children]})}const connection_diameter=connection_radius*2,connection_style_common={width:connection_diameter,height:connection_diameter,borderRadius:connection_radius+1},LabelV2$1="";function get_VAPs_ordered_by_prob(t,ee){const te=t[0];return ee===VAPsType.boolean&&te?[te]:t.sort((ne,oe)=>ne.probability>oe.probability?-1:ne.probability<oe.probability?1:0)}function get_most_probable_VAPs(t,ee){const te=get_VAPs_ordered_by_prob(t,ee),ne=te[0];if(!ne)return[];const{probability:oe}=ne;return te.filter(ie=>ie.probability===oe)}const is_defined=t=>t!==void 0;function get_wcomponent_state_value_and_probabilities(t){const{wcomponent:ee,VAP_set_id_to_counterfactual_v2_map:te,created_at_ms:ne,sim_ms:oe}=t;if(!wcomponent_is_allowed_to_have_state_VAP_sets(ee))return{most_probable_VAP_set_values:[]};const se=get_wcomponent_VAPs_represent(ee,{}),{values_and_prediction_sets:re=[]}=ee,_e=re.map(de=>apply_counterfactuals_v2_to_VAP_set({VAP_set:de,VAP_set_id_to_counterfactual_v2_map:te})),{present_item:ae}=partition_and_prune_items_by_datetimes_and_versions({items:_e,created_at_ms:ne,sim_ms:oe}),{most_probable_VAP_set_values:ce,any_uncertainty:le}=get_most_probable_VAP_set_values(ae,se);let ue=[ae==null?void 0:ae.active_counterfactual_v2_id,ee._derived__using_value_from_wcomponent_id].filter(is_defined);return ue=ue.length?ue:void 0,{most_probable_VAP_set_values:ce,any_uncertainty:le,counterfactual_applied:ae==null?void 0:ae.has_any_counterfactual_applied,derived__using_value_from_wcomponent_ids:ue}}function get_most_probable_VAP_set_values(t,ee){if(!t||t.entries.length===0)return{most_probable_VAP_set_values:[],any_uncertainty:!1};const te=get_VAPs_ordered_by_prob(t.entries,ee);let ne=!1;const oe=[];return te.forEach(ie=>{const se=parse_VAP_value(ie,ee),re=calc_prediction_certainty(ie),_e=calc_prediction_is_uncertain(ie);ne=ne||_e,(ee===VAPsType.boolean||_e||ie.probability!==0)&&oe.push({probability:ie.probability,conviction:ie.conviction,certainty:re,parsed_value:se,value_id:ie.value_id})}),{most_probable_VAP_set_values:oe,any_uncertainty:ne}}function get_wcomponent_state_UI_value(t){const{most_probable_VAP_set_values:ee,any_uncertainty:te,counterfactual_applied:ne,derived__using_value_from_wcomponent_ids:oe}=get_wcomponent_state_value_and_probabilities(t),ie=get_boolean_representation(t.wcomponent),se=[];ee.forEach(ae=>{const ce=parsed_value_to_string(ae.parsed_value,ie);se.push(ce)});const re=ee.length>0;return{values_string:reduce_display_string_values(se),is_defined:re,counterfactual_applied:ne,uncertain:te,derived__using_values_from_wcomponent_ids:oe}}const max_items=3;function reduce_display_string_values(t){let ee=t.length?t.slice(0,max_items).join(", "):"not defined";return t.length>max_items&&(ee+=`, (${t.length-max_items} more)`),ee}function get_default_wcomponent_title(t){let ee="";if(wcomponent_is_plain_connection(t.wcomponent)){const te=t.wcomponents_by_id[t.wcomponent.from_id],ne=t.wcomponents_by_id[t.wcomponent.to_id];(te||ne)&&(ee=`${te?"@@"+te.id:"_"} -> ${ne?"@@"+ne.id:"_"} <auto generated>`)}else if(wcomponent_is_counterfactual_v2(t.wcomponent)){ee="Counterfactual (no target set) <auto generated>";const te=t.wcomponent.target_wcomponent_id;te&&(ee=`Counterfactual of: @@${te} <auto generated>`)}else if(wcomponent_is_sub_state(t.wcomponent)){ee="Sub state (no target set) <auto generated>";const{target_wcomponent_id:te,selector:ne}=t.wcomponent;if(te){if(ee=`Sub state of @@${te}`,ne!=null&&ne.target_value&&(ne!=null&&ne.target_value_id_type)){const{target_value:oe,target_value_id_type:ie}=ne;let se="";if(ie==="id"){const re=t.wcomponents_by_id[te];if(wcomponent_has_value_possibilities(re)){const _e=((re==null?void 0:re.value_possibilities)||{})[oe];_e&&(se=_e.value)}}else se=oe;ee+=": "+se}ee+=" <auto generated>"}}else if(wcomponent_is_state_value(t.wcomponent)){ee="State value (no target attribute set) <auto generated>";const{attribute_wcomponent_id:te}=t.wcomponent;te&&(ee=te?`Alternative state value for @@${te} `:"No target attribute ",ee+="<auto generated>")}return ee}const uuids_regex=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})$/gi,double_at_mentioned_uuids_regex=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi;function is_valid_uuid(t){return!!t.match(uuids_regex)}const old_ids_and_functions_regex=/.*?(@@\w*\d+)\.([\w]+)/g,uuids_and_functions_regex=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\.([\w]+)/gi,non_square_bracket_ids_regex=/(?:^|.*?[^\[a-zA-Z0-9_])([a-zA-Z][a-zA-Z0-9_]*)/gi,square_bracket_ids_regex=/.*?\[([^\]]+)\]/gi,curly_bracket_content_regex=/.*?\{([^\}]+)\}/gi,format_wcomponent_id_error=(t,ee)=>`✗${t} (${ee})`,format_wcomponent_url=(t,ee,te="")=>`${t}#wcomponents/${ee}`+(te?`&subview_id=${te}`:""),format_wcomponent_link=(t,ee,te="□",ne="")=>`[${te}](${format_wcomponent_url(t,ee,ne)})`;function replace_function_ids_in_text(t,ee,te){const{get_title:ne,root_url:oe,render_links:ie,depth_limit:se}=te;if(ee>=se)return t;const re=get_functional_ids_from_text(t);return re.length===0||(re.forEach(({id:_e,funktion:ae})=>{const ce=te.wcomponents_by_id[_e];if(!is_supported_funktion(ae))return;let le="";if(ae==="map"){const de=te.knowledge_views_by_id[_e],me=(de==null?void 0:de.title)||_e;le=format_wcomponent_link(oe,ce?_e:"",me,_e)}else if(ce)if(ae==="url")le=format_wcomponent_url(oe,_e);else if(ae==="value"){const de=new Date().getTime();le=get_wcomponent_state_UI_value({wcomponent:ce,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:de,sim_ms:de}).values_string}else le=ie?format_wcomponent_link(oe,_e):"",ae==="title"?le=ne(ce):ae==="description"&&(le+=ce.description);else return;const ue=new RegExp(`@@${_e}.${ae}`,"g");t=t.replace(ue,le)}),ee<se&&(t=replace_function_ids_in_text(t,ee+1,te))),t}function get_functional_ids_from_text(t){return[...t.matchAll(uuids_and_functions_regex),...t.matchAll(old_ids_and_functions_regex)].map(te=>({id:te[1].slice(2),funktion:te[2]}))}const _supported_functions={url:!0,title:!0,description:!0,map:!0,value:!0},supported_funktions=new Set(Object.keys(_supported_functions));function is_supported_funktion(t){return supported_funktions.has(t)}function replace_normal_ids(t,ee,te){const{root_url:ne,depth_limit:oe,get_title:ie,render_links:se}=te;return get_double_at_mentioned_uuids_from_text(t).forEach(_e=>{const ae=new RegExp(`@@${_e}`,"g"),ce=te.wcomponents_by_id[_e];if(!ce){const de=se?format_wcomponent_link(ne,_e,`@@${_e}`):`@@${_e}`;t=t.replace(ae,format_wcomponent_id_error(de,"not found"));return}const le=ee<oe?ie(ce):`@@${_e}`,ue=se?format_wcomponent_link(ne,_e,le):le;t=t.replace(ae,ue)}),t}function get_double_at_mentioned_uuids_from_text(t){return[...t.matchAll(double_at_mentioned_uuids_regex)].map(te=>te[1].slice(2))}const DEFAULT_MAX_DEPTH_LIMIT=3;var RichTextType=(t=>(t[t.raw=0]="raw",t[t.plain=1]="plain",t[t.rich=2]="rich",t))(RichTextType||{});function get_title$1(t){const{wcomponent:ee,wc_id_to_counterfactuals_map:te,created_at_ms:ne,sim_ms:oe}=t,ie=t.text_type??2;let se=ee.title;if(se||(se=get_default_wcomponent_title(t)),ie===0)return se;const re=replace_value_in_text({text:se,wcomponent:ee,wc_id_to_counterfactuals_map:te,created_at_ms:ne,sim_ms:oe});return replace_ids_in_text({...t,text:re,text_type:ie})}function replace_value_in_text(t){var se;let{text:ee,wcomponent:te,wc_id_to_counterfactuals_map:ne={}}=t;if(!ee.includes("${value}"))return ee;const oe=(se=ne[te.id])==null?void 0:se.VAP_sets,ie=get_wcomponent_state_UI_value({wcomponent:te,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return ee=ee.replace(/\$\{value\}/g,`${ie.values_string}`),ee}function replace_ids_in_text(t){const{text:ee,text_type:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,depth_limit:ie=DEFAULT_MAX_DEPTH_LIMIT,current_depth:se=0,root_url:re="",wc_id_to_counterfactuals_map:_e,created_at_ms:ae,sim_ms:ce}=t;return te===0?ee:_replace_ids_in_text(ee,te,ne,oe,ie,se,re,_e,ae,ce)}function _replace_ids_in_text(t,ee,te,ne,oe,ie,se,re,_e,ae){ee=ee===2?ie===0?2:1:ee;function ce(ue){return get_title$1({text_type:ee,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:re,created_at_ms:_e,sim_ms:ae,depth_limit:oe,current_depth:ie+1,root_url:se,wcomponent:ue})}const le={wcomponents_by_id:te,knowledge_views_by_id:ne,depth_limit:oe,render_links:ee===2,root_url:se,get_title:ce};return t=replace_function_ids_in_text(t,ie,le),t=replace_normal_ids(t,ie,le),t}function color_to_string(t){return t?`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`:""}function color_to_opposite(t){if(!t)return{r:0,g:0,b:0,a:1};const te=t.r+t.g+t.b<383?255:0;return{r:te,g:te,b:te,a:1}}function darker_color(t){if(t)return{r:t.r/2,g:t.g/2,b:t.b/2,a:t.a}}const regexp_code_block=/^(([ ]{0,3}```)|([ ]{4,})).*/gm,regexp_list_line=/^[ \t]*(\*|\d+\.)/gm,regexp_text_line=/^[ \t]*[^\s]+/gm;function add_newlines_to_markdown(t){const ee=[];let te=!1;const ne=t.split(`
`);return ne.forEach((ie,se)=>{if(se>0){const re=ne[se-1];re.match(regexp_code_block)&&(te=!te),te||re.match(regexp_text_line)&&!re.match(regexp_list_line)&&(ie.match(regexp_list_line)?ee[se-1]=re+`
`:ie.match(regexp_text_line)&&(ee[se-1]=re+"<br>"))}ee.push(ie)}),ee.join(`
`)}function run_add_newlines_to_markdown_tests(){console.log("running tests of add_newlines_to_markdown"),test(add_newlines_to_markdown(`
test 1
test2
`),`
test 1<br>
test2
`);const t=`* Test bullet 1
* Test bullet 2`;test(add_newlines_to_markdown(t),t);let te=add_newlines_to_markdown(`Test 1
Test
  Test 3  
	Test 4
* Test bullet 1
* Test bullet 2

Test 5
1. Test number 1
2. Test number 2

`),ne=`Test 1<br>
Test<br>
  Test 3  <br>
	Test 4

* Test bullet 1
* Test bullet 2

Test 5

1. Test number 1
2. Test number 2

`;test(te,ne),describe("Code blocks should not contain <br>",()=>{te=add_newlines_to_markdown("\n```\nsome text\n```\n"),ne="\n```\nsome text\n```\n",test(te,ne,"Three ``` should stop <br> insertion"),te=add_newlines_to_markdown("\n   ```\nsome text\n```\n"),ne="\n   ```\nsome text\n```\n",test(te,ne,"Three ``` with three prepended spaces should stop <br> insertion"),te=add_newlines_to_markdown(`
   more text
   some more text
`),ne=`
   more text<br>
   some more text
`,test(te,ne,"Three prepended spaces for normal text should allow <br> insertion"),te=add_newlines_to_markdown("\n    ```some text\n    some more text\n"),ne="\n    ```some text\n    some more text\n",test(te,ne,"Four prepended spaces for ``` and normal text should stop <br> insertion")})}function AnchorTag(t){return o$1("a",{href:t.href,onClick:ee=>ee.stopImmediatePropagation(),onPointerDown:ee=>ee.stopImmediatePropagation(),children:t.children})}const map_state$1W=t=>({rich_text:t.display_options.consumption_formatting,composed_wcomponents_by_id:t.derived.composed_wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}),connector$1Y=connect(map_state$1W);function _RichMarkDown(t){const{text:ee,rich_text:te,composed_wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,placeholder:se="...",created_at_ms:re,sim_ms:_e}=t,ae=te?RichTextType.rich:RichTextType.raw,ce=replace_ids_in_text({text:ee,text_type:ae,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,created_at_ms:re,sim_ms:_e});return o$1(Markdown,{options:MARKDOWN_OPTIONS,children:ce&&add_newlines_to_markdown(ce)||se})}const RichMarkDown=connector$1Y(_RichMarkDown),MARKDOWN_OPTIONS={overrides:{a:AnchorTag,script:t=>t.children,auto:t=>"",iframe:t=>{const{src:ee}=t;return new URL(ee).hostname==="www.youtube.com"?o$1("iframe",{...t}):null},tweet:t=>{const ee=`https://platform.twitter.com/embed/Tweet.html?dnt=false&frame=false&hideCard=false&hideThread=false&id=${t.id}&lang=en-gb&theme=light&widgetsVersion=0a8eea3%3A1643743420422&width=400px"`;return o$1("iframe",{src:ee,scrolling:"no",frameBorder:0,allowTransparency:!0,allowFullScreen:!0,style:{width:401,height:624}})},img:t=>{var ee;return(ee=t.style)==null||delete ee.position,o$1("img",{src:t.src,style:t.style,alt:t.alt})}}},COLOURS={white:{r:255,g:255,b:255,a:1},white_a75:{r:255,g:255,b:255,a:.75}};function map_state$1V(t,{wcomponent_id:ee}){const{wcomponents_by_id:te,knowledge_views_by_id:ne}=t.specialised_objects;return{wcomponent:te[ee],wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}}const connector$1X=connect(map_state$1V);function _LabelV2(t){const{wcomponent:ee}=t,te=ee?get_title$1({wcomponent:ee,wcomponents_by_id:t.wcomponents_by_id,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:t.wc_id_to_counterfactuals_map,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}):"&lt;Label not found&gt;";return o$1("div",{className:"label_v2",style:{backgroundColor:color_to_string((ee==null?void 0:ee.label_color)||COLOURS.white_a75),color:color_to_string(color_to_opposite(ee==null?void 0:ee.label_color))},children:o$1(Markdown,{options:MARKDOWN_OPTIONS,children:te})})}const LabelV2=connector$1X(_LabelV2);function LabelsListV2(t){return o$1("div",{style:{display:"flex",flexWrap:"wrap"},children:(t.label_ids||[]).map(ee=>o$1(LabelV2,{wcomponent_id:ee}))})}function wcomponent_type_to_text(t){return t==="counterfactualv2"?"counterfactual":t==="statev2"?"state":t.replaceAll("_"," ")}function WarningTriangle(t){return o$1("span",{style:{backgroundColor:t.backgroundColor||"yellow",color:"black"},title:t.message,children:"⚠"})}const WComponentJudgements$1="";function calculate_judgement_value(t){const{judgement_wcomponent:ee,target_wcomponent:te,VAP_set_id_to_counterfactual_v2_map:ne,created_at_ms:oe,sim_ms:ie}=t;if(ee.judgement_manual!==void 0)return ee.judgement_manual;if(!te)return;const{most_probable_VAP_set_values:se}=get_wcomponent_state_value_and_probabilities({wcomponent:te,VAP_set_id_to_counterfactual_v2_map:ne,created_at_ms:oe,sim_ms:ie});if(se.length!==1)return;const _e=se[0].parsed_value,ce=get_wcomponent_VAPs_represent(te,{});return core_calculate_judgement_value({judgement_wcomponent:ee,target_VAPs_represent:ce,value:_e})}function core_calculate_judgement_value(t){const{judgement_wcomponent:ee,target_VAPs_represent:te,value:ne}=t,{judgement_operator:oe,judgement_comparator_value:ie,judgement_manual:se}=ee;if(se!==void 0)return se;const re=te===VAPsType.number?parseFloat(ie||""):te===VAPsType.boolean?ie==="True"||(ie==="False"?!1:void 0):ie;let _e;return ne===null||re===void 0?_e=void 0:oe==="=="?_e=ne===re:oe==="!="?_e=ne!==re:oe==="<"?_e=ne<re:oe==="<="?_e=ne<=re:oe===">"?_e=ne>re:oe===">="&&(_e=ne>=re),_e}var TrendingUp={},_interopRequireDefault$x=interopRequireDefaultExports;Object.defineProperty(TrendingUp,"__esModule",{value:!0});var default_1$x=TrendingUp.default=void 0,_createSvgIcon$x=_interopRequireDefault$x(requireCreateSvgIcon()),_jsxRuntime$x=requireJsxRuntime(),_default$x=(0,_createSvgIcon$x.default)((0,_jsxRuntime$x.jsx)("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"}),"TrendingUp");default_1$x=TrendingUp.default=_default$x;var TrendingFlat={},_interopRequireDefault$w=interopRequireDefaultExports;Object.defineProperty(TrendingFlat,"__esModule",{value:!0});var default_1$w=TrendingFlat.default=void 0,_createSvgIcon$w=_interopRequireDefault$w(requireCreateSvgIcon()),_jsxRuntime$w=requireJsxRuntime(),_default$w=(0,_createSvgIcon$w.default)((0,_jsxRuntime$w.jsx)("path",{d:"m22 12-4-4v3H3v2h15v3z"}),"TrendingFlat");default_1$w=TrendingFlat.default=_default$w;var TrendingDown={},_interopRequireDefault$v=interopRequireDefaultExports;Object.defineProperty(TrendingDown,"__esModule",{value:!0});var default_1$v=TrendingDown.default=void 0,_createSvgIcon$v=_interopRequireDefault$v(requireCreateSvgIcon()),_jsxRuntime$v=requireJsxRuntime(),_default$v=(0,_createSvgIcon$v.default)((0,_jsxRuntime$v.jsx)("path",{d:"m16 18 2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"}),"TrendingDown");default_1$v=TrendingDown.default=_default$v;function CommonIcon(t){var te,ne;let{className:ee=""}=t;return ee="MuiSvgIcon-root "+ee,t.fontSize==="small"&&(ee+=" MuiSvgIcon-fontSizeSmall "),o$1("span",{title:t.title,style:{width:(te=t.style)==null?void 0:te.width,height:(ne=t.style)==null?void 0:ne.height},children:o$1("svg",{className:ee,viewBox:"0 0 24 24",style:t.style,children:[o$1("path",{d:t.d}),t.svg_elements]})})}const d$9="M11.07 12.85c.77-1.39 2.25-2.21 3.11-3.44.91-1.29.4-3.7-2.18-3.7-1.69 0-2.52 1.28-2.87 2.34L6.54 6.96C7.25 4.83 9.18 3 11.99 3c2.35 0 3.96 1.07 4.78 2.41.7 1.15 1.11 3.3.03 4.9-1.2 1.77-2.35 2.31-2.97 3.45-.25.46-.35.76-.35 2.24h-2.89c-.01-.78-.13-2.05.48-3.15zM14 20c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z";function QuestionMarkIcon(t){return o$1(CommonIcon,{...t,d:d$9})}const JudgementBadge$1="",Link$1="",month_to_3text={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function date2str(t,ee){const te={M:t.getMonth()+1,d:t.getDate(),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()};return ee=ee.replace(/MMM/g,function(ne){return month_to_3text[t.getMonth()]||""}),ee=ee.replace(/(M+|d+|h+|m+|s+)/g,function(ne){return((ne.length>1?"0":"")+te[ne.slice(-1)]).slice(-2)}),ee.replace(/(y+)/g,function(ne){return t.getFullYear().toString().slice(-ne.length)})}function date2str_auto(t){const{date:ee,time_resolution:te="minute",trim_midnight:ne=!0}=t,ie=date2str(ee,te==="day"?"yyyy-MM-dd":te==="hour"?"yyyy-MM-dd hh:00":te==="minute"?"yyyy-MM-dd hh:mm":"yyyy-MM-dd hh:mm:ss");return ne?ie.replace(" 00:00",""):ie}function get_today_str(t=!0){return date2str(new Date,"yyyy-MM-dd")+(t?" 00:00":"")}function get_today_date(){return new Date(get_today_str())}const MSECONDS_IN_DAY=24*3600*1e3,TIME_ZONE_IN_MS=new Date().getTimezoneOffset()*6e4;function*get_inclusive_dates(t,ee){const te=Math.floor((t.getTime()-TIME_ZONE_IN_MS)/MSECONDS_IN_DAY),ne=Math.ceil((ee.getTime()-TIME_ZONE_IN_MS)/MSECONDS_IN_DAY);let oe=te;for(;oe<ne;)yield new Date(oe*MSECONDS_IN_DAY),++oe}function get_inclusive_date_strs(t,ee){const te="yyyy-MM-dd";return[...get_inclusive_dates(t,ee)].map(ne=>date2str(ne,te))}const ALLOWED_SUB_ROUTES={views:[],wcomponents:["wcomponents_edit_multiple"],search:[],filter:[],select:[],display:[],statements:[],objects:["objects_bulk_import","objects_bulk_import/setup"],patterns:[],creation_context:[],about:[]},ALLOWED_ROUTES=Object.keys(ALLOWED_SUB_ROUTES),_view_types={priorities:!0,priorities_list:!0,actions_list:!0,knowledge:!0,objectives:!0},routing_view_types=Object.keys(_view_types),is_routing_view_types=t=>routing_view_types.includes(t),ALLOWED_ROUTE_ARGS={view:!0,subview_id:!0,zoom:!0,x:!0,y:!0,storage_location:!0,cdate:!0,ctime:!0,sdate:!0,stime:!0},ALLOWED_ROUTE_ARGS_COUNT=Object.keys(ALLOWED_ROUTE_ARGS).length;function routing_state_to_string(t){const ee=t.sub_route?`${t.sub_route}/`:"",te=t.item_id?`${t.item_id}/`:"",ne=t.args,oe=routing_args_to_string(ne);return"#"+t.route+"/"+ee+te+oe}const exclude_routing_keys=new Set(["order","rotation","created_at_datetime","created_at_ms","sim_datetime","sim_ms"]);function routing_args_to_string(t){const ee={...t,cdate:date2str(t.created_at_datetime,"yyyy-MM-dd"),ctime:date2str(t.created_at_datetime,"hh:mm:ss"),sdate:date2str(t.sim_datetime,"yyyy-MM-dd"),stime:date2str(t.sim_datetime,"hh:mm:ss")};return Object.keys(t).filter(ne=>!exclude_routing_keys.has(ne)).sort().concat(["sdate","stime","cdate","ctime"]).map(ne=>`&${ne}=${ee[ne]??""}`).join("")}function url_is_incomplete(t){const ee=parse_url(t);return!ee.route||ee.args_from_url.length!==ALLOWED_ROUTE_ARGS_COUNT}function parse_url(t){const te=(t.split("#")[1]||"").split("&"),oe=te[0].split("/").filter(ae=>!!ae),{route:ie,sub_route:se,item_id:re}=get_route_subroute_and_item_id(oe),_e=te.slice(1).map(ae=>ae.split("=")).filter(ae=>ALLOWED_ROUTE_ARGS[ae[0]]);return{route:ie,sub_route:se,item_id:re,args_from_url:_e}}function merge_route_params_prioritising_url_over_state(t,ee){const{route:te,sub_route:ne,item_id:oe,args_from_url:ie}=parse_url(t),se=update_args_from_url(ee.args,ie);return{route:te,sub_route:ne,item_id:oe,args:se}}function get_route_subroute_and_item_id(t){let ee=t[0],te=null,ne=null;if(!ALLOWED_ROUTES.includes(ee))ee="wcomponents";else{const oe=t.slice(1).join("/")||null;ALLOWED_SUB_ROUTES[ee].includes(oe)?te=oe:ne=oe}return{route:ee,sub_route:te,item_id:ne}}function update_args_from_url(t,ee){t={...t};let te=null,ne=null,oe=null,ie=null;return ee.forEach(se=>{const[re,_e]=se;re==="cdate"?te=_e:re==="ctime"?ne=_e:re==="sdate"?oe=_e:re==="stime"?ie=_e:update_args_with_value(t,re,_e)}),t.created_at_datetime=routing_arg_datetime_strings_to_datetime(te,ne),t.sim_datetime=oe?routing_arg_datetime_strings_to_datetime(oe,ie):t.created_at_datetime,t.created_at_ms=t.created_at_datetime.getTime(),t.sim_ms=t.sim_datetime.getTime(),t}function update_args_with_value(t,ee,te){ee==="view"?is_routing_view_types(te)&&(t.view=te):routing_arg_is_a_number(ee)?t[ee]=parse_int_or_0(te):ee==="subview_id"?t.subview_id=te:ee==="storage_location"&&(t.storage_location=parse_int_or_undefined(te))}const ROUTING_ARGS_WHICH_ARE_NUMBERS=new Set(["x","y","zoom"]);function routing_arg_is_a_number(t){return ROUTING_ARGS_WHICH_ARE_NUMBERS.has(t)}function parse_int_or_0(t){const ee=parseInt(t);return Number.isNaN(ee)?0:ee}function parse_int_or_undefined(t){const ee=parseInt(t);return Number.isNaN(ee)?void 0:ee}const test_routing_state_to_string=describe("routing_state_to_string",()=>{let t,ee;t={route:"wcomponents",sub_route:null,item_id:"wc88",args:{view:"knowledge",subview_id:"kv77",zoom:100,x:101,y:158,storage_location:void 0,created_at_datetime:new Date("2020-10-21T17:04:24.000Z"),created_at_ms:1603299864e3,sim_datetime:new Date("2021-04-26T09:23:13.000Z"),sim_ms:1619428993e3}},ee=routing_state_to_string(t),test(ee,"#wcomponents/wc88/&storage_location=&subview_id=kv77&view=knowledge&x=101&y=158&zoom=100&sdate=2021-04-26&stime=10:23:13&cdate=2020-10-21&ctime=18:04:24")},!1);function merge_routing_state(t,ee,te){const{route:ne,sub_route:oe,item_id:ie,args:se}=t,re=ee.args||{};re.created_at_ms=get_datetime_or_ms(re.created_at_datetime,re.created_at_ms,te),re.created_at_datetime=re.created_at_ms?new Date(re.created_at_ms):void 0,re.sim_ms=get_datetime_or_ms(re.sim_datetime,re.sim_ms,te),re.sim_datetime=re.sim_ms?new Date(re.sim_ms):void 0,Object.keys(re).forEach(ae=>{if(ae==="storage_location")return;const ce=re[ae];(ce===void 0||ce==="")&&delete re[ae]});const _e={...se,...re};return{route:ee.route||ne,sub_route:ee.sub_route===null?null:ee.sub_route||oe,item_id:ee.item_id===null?null:ee.item_id||ie,args:_e}}const test_merge_routing_state=describe("merge_routing_state",()=>{const t=new Date("2021-04-09 23:25:26"),ee=new Date("2022-01-01 01:01:01"),te=new Date("2023-01-01 01:01:01"),ne={route:"wcomponents",sub_route:null,item_id:"wc53611570523449304",args:{created_at_datetime:t,created_at_ms:t.getTime(),sim_datetime:t,sim_ms:t.getTime(),view:"knowledge",subview_id:"kv7207606403961189",zoom:100,x:0,y:0,storage_location:1}};let oe,ie,se;const re=_e=>se=_e;oe={args:{x:0}},ie=merge_routing_state(ne,oe),test(ie,ne),oe={args:{zoom:void 0}},ie=merge_routing_state(ne,oe),test(ie,ne),oe={args:{created_at_datetime:ee,created_at_ms:te.getTime()}},se="",ie=merge_routing_state(ne,oe,re),test(ie.args.created_at_datetime,te),test(ie.args.created_at_ms,te.getTime()),test(se,"do not set both new_ms and new_datetime"),oe={args:{sim_datetime:ee,sim_ms:te.getTime()}},se="",ie=merge_routing_state(ne,oe,re),test(ie.args.sim_datetime,te),test(ie.args.sim_ms,te.getTime()),test(se,"do not set both new_ms and new_datetime"),oe={args:{sim_ms:void 0,created_at_ms:void 0}},ie=merge_routing_state(ne,oe),test(ie.args.sim_ms,t.getTime(),"should leave sim_ms unchanged when called with `{ args: { sim_ms: undefined }}`"),test(ie.args.created_at_ms,t.getTime(),"should leave created_at_ms unchanged when called with `{ args: { created_at_ms: undefined }}`"),oe={args:{storage_location:void 0}},ie=merge_routing_state(ne,oe),test(ie.args.storage_location,void 0)},!1),map_state$1U=(t,ee)=>{const te=t.routing,{selected_on:ne=new Set}=ee;let oe=ne.size>0;return ne.size&&(ne.has("route")&&ee.route!==void 0&&(oe=oe&&ee.route===te.route),ee.args&&(ne.has("args.view")&&ee.args.view!==void 0&&(oe=oe&&ee.args.view===te.args.view),ne.has("args.subview_id")&&ee.args.subview_id!==void 0&&(oe=oe&&ee.args.subview_id===te.args.subview_id))),{current_routing_state:te,selected:oe}},map_dispatch$15=(t,ee)=>({change_route:te=>t(ACTIONS.routing.change_route({route:ee.route,sub_route:ee.sub_route,item_id:ee.item_id,args:te}))}),connector$1W=connect(map_state$1U,map_dispatch$15);function _Link(t){const[ee,te]=h$1(!1),ne=_$d(void 0);ee&&!ne.current&&(ne.current=setTimeout(()=>{te(!1),ne.current=void 0},300));const oe=t.args||{},ie=ae=>{ae.stopImmediatePropagation(),ae.preventDefault(),!t.selected&&(te(!0),!(t.on_pointer_down&&t.on_pointer_down())&&t.change_route(oe))},se=merge_routing_state(t.current_routing_state,t),re={...t.current_routing_state.args,...oe};se.args=re;const _e="link "+(ee?" clicked_animate ":"")+(t.selected?" selected ":"")+(t.extra_class_name||"");return o$1("a",{onPointerDown:ie,onClick:ae=>{ae.stopImmediatePropagation(),ae.preventDefault()},href:routing_state_to_string({...se}),className:_e,style:t.extra_css_style,children:t.children||"Link"})}const Link=connector$1W(_Link);function _LinkButton(t){const ee=t.args||{},te=ie=>{ie.stopImmediatePropagation(),ie.preventDefault(),!(t.on_pointer_down&&t.on_pointer_down())&&t.change_route(ee)},ne=merge_routing_state(t.current_routing_state,t),oe={...t.current_routing_state.args,...ee};return ne.args=oe,o$1(Button$2,{size:"small",color:"primary",variant:"contained",onClick:te,href:routing_state_to_string({...ne}),children:t.name||"Link"})}const LinkButton=connector$1W(_LinkButton),bound_zoom=t=>bounded(t,10,400),SCALE_BY=100,zoom_sensitivity=.01;function calculate_new_zoom(t){const{zoom:ee,wheel_change:te}=t,ne=ee-te*zoom_sensitivity*ee;return bound_zoom(Math.round(ne))}function calculate_new_zoom_xy(t){const{old:ee,new_zoom:te,pointer_x:ne,pointer_y:oe,client_width:ie,client_height:se}=t,re=ne/ie,_e=oe/se,ae=SCALE_BY/te-SCALE_BY/ee.zoom,ce=re*ie*ae,le=_e*se*ae,ue=ee.x-ce,de=ee.y+le;return{x:ue,y:de}}const test_calculate_new_zoom_xy=describe.skip("calculate_new_zoom_xy (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{let t,ie,se,re;const _e={pointer_x:5,pointer_y:15},ae={pointer_x:5+900,pointer_y:15+600};function ce(le){const ue=le.pointer==="top_left"?_e:ae;return calculate_new_zoom_xy({old:{x:le.x,y:le.y,zoom:le.zoom},new_zoom:le.new_zoom,...ue,client_width:900,client_height:600})}re="top_left",t=ce({x:0,y:0,zoom:10,new_zoom:200,pointer:re}),test(t,{x:0,y:0}),t=ce({x:100,y:100,zoom:200,new_zoom:200,pointer:re}),test(t,{x:100,y:100}),t=ce({x:100,y:100,zoom:200,new_zoom:10,pointer:re}),test(t,{x:100,y:100}),re="bottom_right",ie=100,se=50,t=ce({x:0,y:0,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:-900,y:600}),t=ce({x:100,y:100,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:-900+100,y:600+100}),ie=200,se=100,t=ce({x:0,y:0,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:-900/2,y:600/2}),t=ce({x:100,y:100,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:-900/2+100,y:600/2+100}),ie=100,se=200,t=ce({x:0,y:0,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:900/2,y:-600/2}),t=ce({x:100,y:100,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:900/2+100,y:-600/2+100}),ie=50,se=100,t=ce({x:0,y:0,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:900,y:-600}),t=ce({x:100,y:100,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:900+100,y:-600+100}),ie=50,se=50,t=ce({x:0,y:0,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:0,y:0}),t=ce({x:100,y:100,zoom:ie,new_zoom:se,pointer:re}),test(t,{x:100,y:100})},!1),SIDE_PANEL_WIDTH=440,STARTING_ZOOM=100;function get_routing_starting_state(){const t=new Date,ee=t.getTime(),ne={route:"wcomponents",sub_route:null,item_id:null,args:{view:"knowledge",subview_id:"",zoom:100,x:0,y:0,storage_location:void 0,created_at_datetime:t,created_at_ms:ee,sim_datetime:t,sim_ms:ee}};return merge_route_params_prioritising_url_over_state(window.location.toString(),ne)}const TOP_HEADER_FUDGE=48,bottom_controls_fudge=t=>t?300:120,side_panel_fudge=t=>t?SIDE_PANEL_WIDTH:0,get_screen_width=t=>document.body.clientWidth-side_panel_fudge(t),get_visible_screen_height=t=>document.body.clientHeight-TOP_HEADER_FUDGE-bottom_controls_fudge(t),half_screen_width=t=>get_screen_width(t)/2,half_screen_height=t=>get_visible_screen_height(t)/2;function calculate_xy_for_middle(t,ee,te){const ne=round_number(t.x+half_screen_width(ee)*(SCALE_BY/t.zoom),h_step),oe=round_number(t.y-half_screen_height(te)*(SCALE_BY/t.zoom)+TOP_HEADER_FUDGE,v_step);return{x:ne,y:oe}}function calculate_xy_for_put_middle(t,ee){const te=t.x-half_screen_width(ee.display_side_panel)*(SCALE_BY/t.zoom),ne=t.y+(half_screen_height(ee.display_time_sliders)+TOP_HEADER_FUDGE)*(SCALE_BY/t.zoom);return{x:te,y:ne}}function get_middle_of_screen(t){const ee=calculate_xy_for_middle(t.routing.args,t.controls.display_side_panel,t.controls.display_time_sliders);return position_to_point(ee)}const DEFAULT_DISPLAY_ARGS={display_side_panel:!1,display_time_sliders:!1};function lefttop_to_xy(t,ee,te){if(!t)return;const{left:ne,top:oe,zoom:ie=STARTING_ZOOM}=t,se=oe!==void 0?-1*oe:void 0;return ee&&ne!==void 0&&se!==void 0?{...calculate_xy_for_put_middle({x:ne,y:se,zoom:ie},te||DEFAULT_DISPLAY_ARGS),zoom:ie}:{x:ne,y:se,zoom:ie}}function needs_save(t){const{wcomponent_ids:ee,knowledge_view_ids:te}=t.sync.specialised_object_ids_pending_save;return ee.size+te.size>0}function get_next_specialised_state_id_to_save(t){const{wcomponent_ids:ee,knowledge_view_ids:te}=t.sync.specialised_object_ids_pending_save,oe=ee.values().next();if(!oe.done)return{id:oe.value,object_type:"wcomponent"};const se=te.values().next();if(!se.done)return{id:se.value,object_type:"knowledge_view"}}function merge_base_object(t){const{last_source_of_truth_value:ee,current_value:te,source_of_truth_value:ne,get_custom_field_merger:oe}=t;let ie={...ne},se=!1,re=[];return get_fields(te,ee,ne).forEach(ae=>{const le=(oe(ae)||get_default_base_object_field_merger(ae))(t);se=se||le.needs_save,le.unresolvable_conflict&&re.push(ae),ie[ae]=le.value}),{value:ie,needs_save:se,unresolvable_conflicted_fields:re}}function get_fields(...t){const ee=new Set;return t.forEach(te=>{Object.keys(te).forEach(ne=>{ee.add(ne)})}),Array.from(ee)}function get_default_base_object_field_merger(t){const ee=new Set(["needs_save","saving"]),te=new Set(["id","created_at","modified_at"]);function ne(oe){const ie=oe.source_of_truth_value[t],se=oe.current_value[t];let re=!1,_e=!1;return ee.has(t)?{needs_save:re,unresolvable_conflict:_e,value:se}:te.has(t)?{needs_save:re,unresolvable_conflict:_e,value:ie}:get_default_field_merger(t)(oe)}return ne}function get_default_field_merger(t){function ee(ne,oe){return JSON.stringify(ne)===JSON.stringify(oe)}function te(ne){const oe=ne.source_of_truth_value[t],ie=ne.current_value[t],se=ne.last_source_of_truth_value[t];let re=!1,_e=!1,ae;return ne.update_successful||ee(oe,se)?(ae=ie,re=!ee(ie,oe)):(ae=oe,ee(ie,se)||(_e=!ee(ie,oe),_e&&console.debug("unresolvable_conflict with field: ",t,"last_source_of_truth_field_value",se,"source_of_truth_field_value",oe,"current_field_value",ie))),{needs_save:re,unresolvable_conflict:_e,value:ae}}return te}var getRandomValues,rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}const REGEX=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function validate(t){return typeof t=="string"&&REGEX.test(t)}var byteToHex=[];for(var i=0;i<256;++i)byteToHex.push((i+256).toString(16).substr(1));function stringify$1(t){var ee=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,te=(byteToHex[t[ee+0]]+byteToHex[t[ee+1]]+byteToHex[t[ee+2]]+byteToHex[t[ee+3]]+"-"+byteToHex[t[ee+4]]+byteToHex[t[ee+5]]+"-"+byteToHex[t[ee+6]]+byteToHex[t[ee+7]]+"-"+byteToHex[t[ee+8]]+byteToHex[t[ee+9]]+"-"+byteToHex[t[ee+10]]+byteToHex[t[ee+11]]+byteToHex[t[ee+12]]+byteToHex[t[ee+13]]+byteToHex[t[ee+14]]+byteToHex[t[ee+15]]).toLowerCase();if(!validate(te))throw TypeError("Stringified UUID is invalid");return te}function v4(t,ee,te){t=t||{};var ne=t.random||(t.rng||rng)();if(ne[6]=ne[6]&15|64,ne[8]=ne[8]&63|128,ee){te=te||0;for(var oe=0;oe<16;++oe)ee[te+oe]=ne[oe];return ee}return stringify$1(ne)}function get_new_id(){return v4()}const get_new_wcomponent_id=()=>get_new_id(),get_new_prediction_id=()=>"pr"+get_new_id(),get_new_value_and_prediction_set_id=()=>"vps"+get_new_id(),get_new_VAP_id=()=>"VAP"+get_new_id(),get_new_knowledge_view_id=()=>get_new_id(),uuidv4_regex=new RegExp(/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i),is_uuid_v4=t=>!!t&&uuidv4_regex.test(t);function floor_mseconds_to_resolution(t,ee){return floor_datetime_to_resolution(new Date(t),ee).getTime()}function floor_datetime_to_resolution(t,ee){const te=date2str_auto({date:t,time_resolution:ee});return new Date(te)}function get_new_created_ats(t){const ee=new Date;let te;if(t){const{use_creation_context:ne,creation_context:oe}=t;te=ne?oe&&oe.custom_created_at:void 0}return{created_at:ee,custom_created_at:te}}function selector_current_user(t){const{user:ee,users_by_id:te}=t.user_info;return ee&&te?te[ee.id]:void 0}function selector_user_name(t){const ee=selector_current_user(t);return ee==null?void 0:ee.name}function selector_need_to_set_user_name(t){const{user:ee,users_by_id:te}=t.user_info;return ee&&te&&!selector_user_name(t)}function selector_chosen_base(t,ee=""){const{bases_by_id:te,chosen_base_id:ne}=t.user_info,oe=te&&te[ne||""];function ie(se){ee&&console.error(se+ee)}return te||ie("No state.user_info.bases_by_id present"),ne===void 0&&ie("No state.user_info.chosen_base_id present"),oe===void 0&&ie("No chosen_base present"),oe}function selector_chosen_base_name(t){const ee=selector_chosen_base(t),te=selector_chosen_base_id(t);return ee?ee.title:te===void 0?"Not set":`Store: ${te}`}function selector_editable_bases(t){const{user:ee,bases_by_id:te}=t.user_info;if(ee&&te)return Object.values(te).filter(ne=>ne.can_edit)}function selector_have_an_editable_base(t){const ee=selector_editable_bases(t);return ee===void 0?void 0:ee.length>0}function selector_chosen_base_id(t){return t.user_info.chosen_base_id}function selector_needs_to_create_a_base(t){const{bases_by_id:ee}=t.user_info;return ee===void 0?!1:selector_have_an_editable_base(t)===!1&&selector_chosen_base(t)===void 0}function selector_current_user_access_level(t){const ee=selector_chosen_base(t);return ee==null?void 0:ee.access_level}function get_new_knowledge_view_object(t,ee){return{id:get_new_knowledge_view_id(),...get_new_created_ats(ee),title:"",description:"",wc_id_map:{},goal_ids:[],sort_type:"normal",...t}}function create_new_knowledge_view(t){const ee=t.store||get_store(),te=selector_chosen_base_id(ee.getState()),ne={...t.knowledge_view,base_id:te},oe=get_new_knowledge_view_object(ne,t.creation_context);ee.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:oe}))}function navigate_to_knowledge_view_or_kvwcomponent(t,ee){ee.dispatch(ACTIONS.routing.change_route({route:"wcomponents",args:{subview_id:t}}))}function merge_knowledge_view(t){return merge_base_object({...t,get_custom_field_merger:get_custom_field_merger$1})}function get_custom_field_merger$1(t){if(t!=="wc_id_map")return;function ee(te,ne){return JSON.stringify(te)===JSON.stringify(ne)}return te=>{const ne=te.source_of_truth_value.wc_id_map,oe=te.current_value.wc_id_map,ie=te.last_source_of_truth_value.wc_id_map;let se=!1,re=!1,_e;return te.update_successful||ee(ne,ie)?(_e=oe,se=!ee(oe,ne)):(_e=ne,ee(oe,ie)||Array.from(new Set(Object.keys(oe).concat(Object.keys(ne)))).forEach(ce=>{const le=get_default_field_merger(ce)({source_of_truth_value:ne,current_value:oe,last_source_of_truth_value:ie,update_successful:te.update_successful});_e[ce]=le.value,le.unresolvable_conflict&&console.debug("unresolvable_conflict in wc_id_map with wc_id: ",ce,"last_source_of_truth_value",ie[ce],"source_of_truth_value",ne[ce],"current_value",oe[ce]),se=se||le.needs_save,re=re||le.unresolvable_conflict})),{needs_save:se,unresolvable_conflict:re,value:_e}}}const test_merge_knowledge_views=describe("merge knowledge view functions",()=>{const t=new Date("2021-01-01"),ee=new Date("2021-02-02");function te(oe,ie=!0){if(!oe&&ie)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return oe?oe.getTime():void 0}const ne=oe=>({left:oe,top:oe});describe("should handle adding entry on client",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(1)},needs_save:!0,saving:!0},se={...oe,wc_id_map:{0:ne(1)},modified_at:ee},re=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:se,update_successful:!0});test(te(re.value.modified_at),te(ee)),test(re.value.wc_id_map,{0:ne(1)}),test(re.needs_save,!1),test(re.unresolvable_conflicted_fields,[])}),describe("should handle adding entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(1)},needs_save:!0,saving:!0},se={...oe,wc_id_map:{2:ne(3)},modified_at:ee},re=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:se,update_successful:!1});test(te(re.value.modified_at),te(ee)),test(re.value.wc_id_map,{0:ne(1),2:ne(3)}),test(re.needs_save,!0),test(re.unresolvable_conflicted_fields,[])}),describe("should handle nonconflicting changing different entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1),2:ne(3)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(4),2:ne(3)},needs_save:!0,saving:!0},se={...oe,wc_id_map:{0:ne(1),2:ne(5)},modified_at:ee},re=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:se,update_successful:!1});test(te(re.value.modified_at),te(ee)),test(re.value.wc_id_map,{0:ne(4),2:ne(5)}),test(re.needs_save,!0),test(re.unresolvable_conflicted_fields,[])}),describe("should handle conflict changing same entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(3)},needs_save:!0,saving:!0},se={...oe,wc_id_map:{0:ne(2)},modified_at:ee},re=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:se,update_successful:!1});test(te(re.value.modified_at),te(ee)),test(re.value.wc_id_map,{0:ne(2)}),test(re.needs_save,!1),test(re.unresolvable_conflicted_fields,["wc_id_map"])}),describe("should handle resolveable conflict changing same entries on client and remote",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(2)},needs_save:!0,saving:!0},se={...oe,wc_id_map:{0:ne(2)},modified_at:ee},re=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:se,update_successful:!1});test(te(re.value.modified_at),te(ee)),test(re.value.wc_id_map,{0:ne(2)}),test(re.needs_save,!1),test(re.unresolvable_conflicted_fields,[])}),describe("should handle non and conflict changes and second client change",()=>{const oe=get_new_knowledge_view_object({wc_id_map:{0:ne(1)},modified_at:t,base_id:0}),ie={...oe,wc_id_map:{0:ne(4),1:ne(10)},needs_save:!0,saving:!0},se={...oe,wc_id_map:{0:ne(2)},modified_at:ee},re=merge_knowledge_view({last_source_of_truth_value:oe,current_value:ie,source_of_truth_value:se,update_successful:!1});test(te(re.value.modified_at),te(ee)),test(re.value.wc_id_map,{0:ne(2),1:ne(10)}),test(re.needs_save,!0),test(re.unresolvable_conflicted_fields,["wc_id_map"])})},!1);function prepare_new_contextless_wcomponent_object(t){const ee={id:get_new_wcomponent_id(),created_at:new Date,base_id:t.base_id,title:"",description:"",type:"process"},te=t.custom_created_at||t.created_at||ee.custom_created_at||ee.created_at;let ne;if(t.type==="causal_link"||t.type==="relation_link"){let oe={...ee,from_id:"",to_id:"",from_type:"state",to_type:"state",...t,type:t.type};wcomponent_is_causal_link(oe)&&(oe={effect_when_true:1,effect_when_false:-1,values_and_prediction_sets:[],...oe}),ne=oe}else t.type==="judgement"||t.type==="objective"?ne={...ee,judgement_target_wcomponent_id:"",judgement_operator:"==",judgement_comparator_value:"True",judgement_manual:void 0,...t,type:t.type}:t.type==="statev2"?ne={...ee,subtype:void 0,values_and_prediction_sets:[],...t,type:t.type}:t.type==="prioritisation"?ne={...ee,title:date2str_auto({date:te,time_resolution:"day"}),goals:{},datetime:{value:te},...t,type:t.type}:t.type==="goal"?ne={...ee,objective_ids:[],...t,type:t.type}:t.type==="action"?ne={...ee,values_and_prediction_sets:[],reason_for_status:"",depends_on_action_ids:[],...t,type:t.type}:ne={...ee,...t,type:t.type||"process"};return ne}function prepare_new_wcomponent_object(t,ee){let te={...prepare_new_contextless_wcomponent_object(t),...get_new_created_ats(ee)};return te=set_creation_context_label_ids(te,ee),te}function set_creation_context_label_ids(t,ee){const te=ee.creation_context,ne=ee.use_creation_context&&te&&te.label_ids||[],oe=t.label_ids||[],ie=new Set(oe);return ne.forEach(se=>ie.has(se)?"":oe.push(se)),{...t,label_ids:oe}}function merge_wcomponent(t){return merge_base_object({...t,get_custom_field_merger})}function get_custom_field_merger(t){}const test_merge_wcomponent=describe("merge_wcomponent",()=>{const t=new Date("2021-01-01"),ee=new Date("2021-02-02");function te(ne,oe=!0){if(!ne&&oe)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return ne?ne.getTime():void 0}describe("should handle update on client",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TB",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!0});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TB"),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,[])}),describe("should handle nonconflicting updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TB"),test(se.value.description,"DX"),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,[])}),describe("should handle conflicting updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TX",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TX"),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,["title"])}),describe("should handle multiple updates on client",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TB",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!0});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TC"),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,[])}),describe("should handle nonconflicting updates with multiple client updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TC"),test(se.value.description,"DX"),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,[])}),describe("should handle conflicting updates with multiple client updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",modified_at:t}),oe={...ne,title:"TC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TX",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TX"),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,["title"])}),describe("should handle non and conflicting updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TB",description:"DB",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TB"),test(se.value.description,"DX"),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,["description"])}),describe("should handle non and conflicting updates with multiple client updates",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,title:"TA",description:"DA",modified_at:t}),oe={...ne,title:"TC",description:"DC",needs_save:!0,saving:!0};({...ne});const ie={...ne,title:"TA",description:"DX",modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!1});test(te(se.value.modified_at),te(ee)),test(se.value.title,"TC"),test(se.value.description,"DX"),test(se.needs_save,!0),test(se.unresolvable_conflicted_fields,["description"])}),describe("should handle different custom created at",()=>{const ne=prepare_new_contextless_wcomponent_object({base_id:-1,custom_created_at:new Date("2021"),modified_at:t}),oe={...ne,custom_created_at:new Date("2015"),needs_save:!0,saving:!0};({...ne});const ie={...ne,custom_created_at:new Date("2015"),modified_at:ee},se=merge_wcomponent({last_source_of_truth_value:ne,current_value:oe,source_of_truth_value:ie,update_successful:!0});test(te(se.value.modified_at),te(ee)),test(new Date("2021"),new Date("2021")),test(se.value.custom_created_at,new Date("2015")),test(se.needs_save,!1),test(se.unresolvable_conflicted_fields,[])})},!1);function get_last_source_of_truth_wcomponent_from_state(t,ee){return t.sync.last_source_of_truth_specialised_objects_by_id.wcomponents[ee||""]}function get_last_source_of_truth_knowledge_view_from_state(t,ee){return t.sync.last_source_of_truth_specialised_objects_by_id.knowledge_views[ee||""]}function clean_base_object_of_sync_meta_fields(t){return t={...t},delete t.needs_save,delete t.saving,t}function parse_base_dates(t){return{...t,created_at:new Date(t.created_at),custom_created_at:optional_date(t.custom_created_at),modified_at:optional_date(t.modified_at),datetime:optional_datetime_temporal_uncertainty(t.datetime)}}const optional_date=t=>t===void 0?void 0:new Date(t);function optional_datetime_temporal_uncertainty(t){if(t)return{...t,value:optional_date(t.value),min:optional_date(t.min),max:optional_date(t.max)}}function parse_knowledge_view(t,ee,te=!1){t=clean_base_object_of_sync_meta_fields(t);let ne=t.wc_id_map;return te&&(ne=remove_wc_id_map_passthrough_entries(ne)),t={...t,...parse_base_dates(t),wc_id_map:ne,sort_type:t.sort_type||"normal"},t=upgrade_2021_05_24_knowledge_view(t),t=upgrade_2021_11_19_knowledge_view(t),t}function remove_wc_id_map_passthrough_entries(t){const ee={...t};return Object.entries(ee).forEach(([te,ne])=>{ne.passthrough&&delete ee[te]}),ee}function upgrade_2021_05_24_knowledge_view(t){const ee=t.goal_ids||[];return{...t,goal_ids:ee}}function upgrade_2021_11_19_knowledge_view(t){const{wc_id_map:ee}=t,te={...ee};return Object.values(te).forEach(ne=>{ne.deleted&&(delete ne.deleted,ne.blocked=!0)}),{...t,wc_id_map:te}}async function supabase_create_item(t){const ee=t.converter_app_to_supabase(t.item),te=await t.supabase.from(t.table).insert(ee).eq("id",ee.id),oe=(te.data||[]).map(t.converter_supabase_to_app)[0];return{status:te.status,item:oe,error:te.error||void 0}}const SUPABASE_MAX_ROWS=1e3;async function supabase_get_items(t){const ee=t.offset||0,te=t.specific_ids?100:SUPABASE_MAX_ROWS,ne=ee+te-1;let oe=t.supabase.from(t.table).select("*").order("id",{ascending:!0});if(t.base_id!==void 0&&(oe=oe.eq("base_id",t.base_id)),t.specific_ids===void 0)oe=oe.range(ee,ne);else{const ae=t.specific_ids.slice(ee,ne+1);oe=oe.in("id",ae)}const ie=await oe;let se=ie.error||void 0,re=(ie.data||[]).map(t.converter);const _e=t.specific_ids&&ee+te<t.specific_ids.length;if(!se&&(re.length===te||_e)){const ae=await supabase_get_items({...t,offset:ee+te});ae.error?se=ae.error:re=re.concat(ae.items)}return{error:se,items:re}}function app_item_to_supabase(t,ee){if(ee=t.base_id??ee,ee===void 0)throw new Error("Must provide base_id for app_item_to_supabase");const te=clean_base_object_of_sync_meta_fields(t);return delete te.base_id,{id:t.id,modified_at:t.modified_at?t.modified_at.toISOString():void 0,base_id:ee,json:te,title:t.title}}function supabase_item_to_app(t){let{json:ee,id:te,base_id:ne,modified_at:oe}=t;const ie=oe?new Date(oe+"Z"):void 0;return delete ee.base_id,ee={...ee,id:te,base_id:ne,modified_at:ie},ee}const TABLE_NAME$1="knowledge_views";function supabase_get_knowledge_views(t){return supabase_get_items({...t,table:TABLE_NAME$1,converter:knowledge_view_supabase_to_app,specific_ids:t.ids})}async function supabase_get_knowledge_views_from_other_bases(t){const ee=t.wcomponents_from_other_bases.filter(se=>wcomponent_is_not_deleted(se)),te=Array.from(new Set(ee.map(se=>se.id))),ne=new Set(t.knowledge_views.map(se=>se.id)),oe=t.knowledge_views.map(se=>se.parent_knowledge_view_id).filter(is_defined).filter(se=>!ne.has(se));let ie=te.concat(oe);return t.knowledge_views.map(se=>se.foundation_knowledge_view_ids).forEach(se=>{se==null||se.filter(re=>!ne.has(re)).forEach(re=>ie.push(re))}),ie=Array.from(new Set(ie)),await supabase_get_knowledge_views({supabase:t.supabase,ids:ie,all_bases:!0})}async function supabase_upsert_knowledge_view(t){return t.knowledge_view.modified_at?supabase_update_knowledge_view(t):supabase_create_knowledge_view(t)}async function supabase_create_knowledge_view(t){return supabase_create_item({supabase:t.supabase,table:TABLE_NAME$1,item:t.knowledge_view,converter_app_to_supabase:knowledge_view_app_to_supabase,converter_supabase_to_app:knowledge_view_supabase_to_app})}async function supabase_update_knowledge_view(t){const ee=knowledge_view_app_to_supabase(t.knowledge_view),te=await t.supabase.rpc("update_knowledge_view",{item:ee});if(te.status===401)return{status:te.status,error:{message:"JWT expired"},item:void 0};let ne,oe=te.error||void 0;try{let ie=te.data;te.status===409&&(ie=JSON.parse(te.error.details)),ne=knowledge_view_supabase_to_app(ie)}catch(ie){console.error("Exception whilst handling rpc update_knowledge_view response",ie),oe=ie}return{status:te.status,error:oe,item:ne}}function knowledge_view_app_to_supabase(t,ee){return app_item_to_supabase(t,ee)}function knowledge_view_supabase_to_app(t){let ee=supabase_item_to_app(t);return ee=parse_knowledge_view(ee),ee}function parse_wcomponent(t){if(t=clean_base_object_of_sync_meta_fields(t),t=upgrade_2021_05_19_process_actions(t),t=upgrade_2021_05_19_existence_predictions(t),t=upgrade_2021_05_24_action(t),t=upgrade_2021_06_12_goal(t),t={...parse_base_dates(t)},wcomponent_has_validity_predictions(t)&&(t.validity=t.validity.map(parse_prediction)),wcomponent_has_VAP_sets(t)){const ee=t.values_and_prediction_sets;t.values_and_prediction_sets=ee&&ee.map(parse_values_and_predictions_set)}return wcomponent_has_event_at(t)&&(t.event_at=t.event_at.map(parse_base_dates)),wcomponent_is_plain_connection(t)&&(t.from_type=upgrade_2021_05_19_connection_fromto_types(t.from_type),t.to_type=upgrade_2021_05_19_connection_fromto_types(t.to_type),t.from_type=upgrade_2021_05_31_connection_fromto_types(t.from_type),t.to_type=upgrade_2021_05_31_connection_fromto_types(t.to_type)),t}function upgrade_2021_05_19_connection_fromto_types(t){return t==="meta-effector"||t==="meta-effected"?"meta":t==="effector"||t==="effected"?"state":t||"state"}function upgrade_2021_05_31_connection_fromto_types(t){return t==="value"?"state":t||"state"}function upgrade_2021_05_19_process_actions(t){return!wcomponent_is_process(t)||!t.is_action?t:{...t,is_action:void 0,type:"action"}}function upgrade_2021_05_19_existence_predictions(t){if(!wcomponent_has_existence_predictions(t)||(t.existence=t.existence.map(parse_prediction),wcomponent_has_VAP_sets(t)))return t;const ee=t.existence.map(ne=>({id:ne.id.replace("pr","vps"),created_at:ne.created_at,base_id:ne.base_id,custom_created_at:ne.custom_created_at,datetime:ne.datetime||{},entries:[{id:get_new_VAP_id(),value:"",description:"",explanation:ne.explanation,probability:ne.probability,conviction:ne.conviction}]}));return{...t,existence:void 0,values_and_prediction_sets:ee}}function upgrade_2021_05_24_action(t){if(wcomponent_is_action(t)){const ee=t.depends_on_action_ids||[];t={...t,depends_on_action_ids:ee}}return t}function upgrade_2021_06_12_goal(t){if(wcomponent_is_goal(t)){const ee=t.objective_ids||[];t={...t,objective_ids:ee}}return t}const parse_prediction=t=>parse_base_dates(t),parse_values_and_predictions_set=t=>parse_base_dates(t),TABLE_NAME="wcomponents";function supabase_get_wcomponents(t){return supabase_get_items({...t,table:TABLE_NAME,converter:wcomponent_supabase_to_app})}async function supabase_get_wcomponents_from_any_base(t){const ee=await supabase_get_items({supabase:t.supabase,all_bases:!0,base_id:void 0,specific_ids:t.ids,table:TABLE_NAME,converter:wcomponent_supabase_to_app});return{error:ee.error,wcomponents:ee.items}}async function supabase_get_wcomponents_from_other_bases(t){const ee=new Set(t.wcomponents.map(ie=>ie.id)),te=new Set;function ne(ie,se){ie.forEach(re=>{if(!is_valid_uuid(re)){console.trace(`Found invalid UUID "${re}".  Source of ids: "${se}"`);return}ee.has(re)||te.add(re)})}t.knowledge_views.forEach(ie=>{ne(Object.keys(ie.wc_id_map),`wc_id_map of knowledge view "${ie.id}"`)}),t.wcomponents.forEach(ie=>{const se=`wcomponent "${ie.id}"`;ne(ie.label_ids||[],se);let re=get_double_at_mentioned_uuids_from_text(ie.title);ne(re,se),re=get_double_at_mentioned_uuids_from_text(ie.description),ne(re,se),wcomponent_is_action(ie)&&ne(ie.parent_goal_or_action_ids||[],se)});const oe=Array.from(te);return await supabase_get_wcomponents_from_any_base({supabase:t.supabase,ids:oe})}async function supabase_upsert_wcomponent(t){return t.wcomponent.modified_at?supabase_update_wcomponent(t):supabase_create_wcomponent(t)}async function supabase_create_wcomponent(t){return supabase_create_item({supabase:t.supabase,table:TABLE_NAME,item:t.wcomponent,converter_app_to_supabase:wcomponent_app_to_supabase,converter_supabase_to_app:wcomponent_supabase_to_app})}async function supabase_update_wcomponent(t){const ee=wcomponent_app_to_supabase(t.wcomponent),te=await t.supabase.rpc("update_wcomponent",{item:ee});if(te.status===401)return{status:te.status,error:{message:"JWT expired"},item:void 0};let ne,oe=te.error||void 0;try{let ie=te.data;te.status===409&&(ie=JSON.parse(te.error.details)),ne=wcomponent_supabase_to_app(ie)}catch(ie){console.error("Exception whilst handling rpc update_wcomponent response",ie),oe=ie}return{status:te.status,error:oe,item:ne}}function wcomponent_app_to_supabase(t,ee){return{...app_item_to_supabase(t,ee),type:t.type,attribute_id:wcomponent_is_state_value(t)?t.attribute_wcomponent_id:void 0}}function wcomponent_supabase_to_app(t){let ee=supabase_item_to_app(t);return ee=parse_wcomponent(ee),ee}function error_to_string(t){if(t){if("type"in t&&typeof t.type=="string")return t.type+": "+(t.message||"<no message>");if(`${t}`.includes("[object"))return JSON.stringify(t)}return`${t}`}let global_attempts=0;async function save_state(t,ee=!1){const te=t.getState();if(!te.sync.ready_for_writing)return console.error(`Inconsistent state violation.  Save state called whilst state.sync.status: "${te.sync.specialised_objects.status}", ready_for_writing: ${te.sync.ready_for_writing}`),Promise.reject();const ne=get_next_specialised_state_id_to_save(te);if(!ne){const{wcomponent_ids:ie,knowledge_view_ids:se}=te.sync.specialised_object_ids_pending_save,re=JSON.stringify(Array.from(ie)),_e=JSON.stringify(Array.from(se));return t.dispatch(ACTIONS.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})),ee?(console.log(`No ids need to be saved: "${re}", "${_e}"`),Promise.resolve()):(console.error(`Inconsistent state violation.  No ids need to be saved: "${re}", "${_e}"`),Promise.reject())}t.dispatch(ACTIONS.sync.update_sync_status({status:"SAVING",data_type:"specialised_objects"}));let oe;ne.object_type==="knowledge_view"?oe=save_knowledge_view(ne.id,t):oe=save_wcomponent(ne.id,t);try{global_attempts+=1,await oe&&(global_attempts=0),global_attempts<10?t.dispatch(ACTIONS.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})):t.dispatch(ACTIONS.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:"Try manually saving or refresh the page.  Failing that contact the team.",attempt:global_attempts}))}catch(ie){console.error(`Got error saving ${ne.object_type} ${ne.id}.  Error: ${ie}`),t.dispatch(ACTIONS.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:`${ie}`,attempt:global_attempts}))}return Promise.resolve()}async function save_knowledge_view(t,ee){const te="knowledge_view",ne=get_knowledge_view_from_state(ee.getState(),t),oe=pre_upsert_check(t,ee,te,ne);if(oe.error)return oe.error;const ie=oe.initial_item,se=get_supabase(),re=await supabase_upsert_knowledge_view({supabase:se,knowledge_view:ie}),_e=post_upsert_check(t,ee,te,re);if(_e.error)return _e.error;const{create_successful:ae,update_successful:ce,latest_source_of_truth_value:le}=_e,ue=get_last_source_of_truth_knowledge_view_from_state(ee.getState(),t),de=get_knowledge_view_from_state(ee.getState(),t);ee.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:le,is_source_of_truth:!0}));const me=check_merge_args({object_type:te,initial_item:ie,last_source_of_truth_value:ue,current_value:de});if(me.error)return me.error;if(me.merge_args){const pe=merge_knowledge_view({...me.merge_args,source_of_truth_value:le,update_successful:ce});pe.needs_save&&ee.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:{...pe.value},is_source_of_truth:!1})),pe.unresolvable_conflicted_fields.length}return Promise.resolve(ae||ce)}async function save_wcomponent(t,ee){const te="wcomponent",ne=get_wcomponent_from_state(ee.getState(),t),oe=pre_upsert_check(t,ee,te,ne);if(oe.error)return oe.error;const ie=oe.initial_item,se=get_supabase(),re=await supabase_upsert_wcomponent({supabase:se,wcomponent:ie}),_e=post_upsert_check(t,ee,te,re);if(_e.error)return _e.error;const{create_successful:ae,update_successful:ce,latest_source_of_truth_value:le}=_e,ue=get_last_source_of_truth_wcomponent_from_state(ee.getState(),t),de=get_wcomponent_from_state(ee.getState(),t);ee.dispatch(ACTIONS.specialised_object.upsert_wcomponent({wcomponent:le,is_source_of_truth:!0}));const me=check_merge_args({object_type:te,initial_item:ie,last_source_of_truth_value:ue,current_value:de});if(me.error)return me.error;if(me.merge_args){const pe=merge_wcomponent({...me.merge_args,source_of_truth_value:le,update_successful:ce});pe.needs_save&&ee.dispatch(ACTIONS.specialised_object.upsert_wcomponent({wcomponent:{...pe.value},is_source_of_truth:!1})),pe.unresolvable_conflicted_fields.length}return Promise.resolve(ae||ce)}function pre_upsert_check(t,ee,te,ne){return ne?(ee.dispatch(ACTIONS.sync.update_specialised_object_sync_info({id:ne.id,object_type:te,saving:!0})),{error:void 0,initial_item:ne}):(ee.dispatch(ACTIONS.sync.debug_refresh_all_specialised_object_ids_pending_save()),{error:Promise.reject(`Inconsistent state violation.  save_"${te}" but no item for id: "${t}".  Updating all specialised_object_ids_pending_save.`),initial_item:void 0})}function post_upsert_check(t,ee,te,ne){const oe=ne.status===201,ie=ne.status===200;if(!oe&&!ie&&ne.status!==409){const re=error_to_string(ne.error);return{error:Promise.reject(`save_"${te}" got "${ne.status}" error: "${re}"`),create_successful:oe,update_successful:ie,latest_source_of_truth_value:void 0}}const se=ne.item;return se?{error:void 0,create_successful:oe,update_successful:ie,latest_source_of_truth_value:se}:{error:Promise.reject(`Inconsistent state violation.  save_"${te}" got "${ne.status}" but no latest_source_of_truth_value item.  Error: "${JSON.stringify(ne.error)}".`),create_successful:oe,update_successful:ie,latest_source_of_truth_value:se}}function check_merge_args(t){const{object_type:ee,initial_item:te,last_source_of_truth_value:ne,current_value:oe}=t;return ne?oe?{error:void 0,merge_args:{last_source_of_truth_value:ne,current_value:oe}}:{error:Promise.reject(`Inconsistent state violation.  save_"${ee}" found "${ee}" last_source_of_truth_value but no current_value for id "${te.id}".`),merge_args:void 0}:te.modified_at?{error:Promise.reject(`Inconsistent state violation.  save_"${ee}" found no last_source_of_truth_value "${ee}" for id: "${te.id}" but "${ee}" had a modified_at already set`),merge_args:void 0}:{error:void 0,merge_args:void 0}}async function conditionally_save_state(t){if(!calc_should_save(t,!0))return Promise.resolve();await save_state(t)}function calc_should_save(t,ee){if(!t.load_state_from_storage)return!1;const te=t.getState(),{ready_for_writing:ne,specialised_objects:oe}=te.sync;return!(!ne||ee&&oe.status==="FAILED"||ee&&!needs_save(te))}async function save_and_optionally_signout(t){const ee=get_store(),te=get_supabase();try{await conditionally_save_state(ee)}catch{}try{if(t){const{error:ne}=await te.auth.signOut();localStorage.clear()}}catch{}window.location.reload()}const window_on_focus_listeners=[];function setup_window_on_focus_listener(){window.addEventListener("focus",function(){window_on_focus_listeners.forEach(t=>t())},!1)}function register_window_on_focus_listener(t){window_on_focus_listeners.push(t)}let registered=!1;function register_window_focus_session_check(t){if(registered){console.error("Already run register_window_focus_session_check");return}registered=!0,register_window_on_focus_listener(()=>check_and_handle_connection_and_session(t))}async function check_and_handle_connection_and_session(t){if(!t.load_state_from_storage)return;const ee=get_supabase(),te=await check_connection_and_session(t,ee);handle_connection_and_session_check_result(te,t)}async function check_connection_and_session(t,ee){var te,ne,oe;if(!t.getState().user_info.user)return console.log("User not signed in once yet."),0;try{const ie=await ee.auth.update({});if(((te=ie.error)==null?void 0:te.message)==="Not logged in."||((ne=ie.error)==null?void 0:ne.status)===401)return 1;if(((oe=ie.error)==null?void 0:oe.message)==="Network request failed")return console.log("Network error"),2;if(ie.error){debugger;return console.log("Unexpected error whilst check_connection_and_session",ie.error),3}else return 4}catch(ie){return console.error("Unexpected exception whilst check_connection_and_session",ie),3}}function handle_connection_and_session_check_result(t,ee){if(t===0)return;if(t===1){console.log("User not logged in.  Reloading page."),window.location.reload();return}else if(t===3){save_and_optionally_signout(!1);return}let te=!0;t===2&&(te=!1),ee.dispatch(ACTIONS.sync.update_network_status({network_functional:te,last_checked:new Date}))}function register_window_title_updater_subscriber(t){let ee="";t.subscribe(()=>{const te=t.getState(),ne=get_current_knowledge_view_from_state(te);if(ne&&ne.title!==ee){ee=ne.title;const oe=(ee?ee+" | ":"")+APP_DETAILS.NAME;set_window_title(oe)}})}function controls_subscribers(t){show_side_panel_on_change_route(t)}function show_side_panel_on_change_route(t){t.subscribe(()=>{const ee=t.getState();ee.routing.route,should_display_side_panel(ee)&&t.dispatch(ACTIONS.controls.set_or_toggle_display_side_panel(!0))})}function should_display_side_panel(t){return t.last_action?!t.controls.display_side_panel&&is_change_route(t.last_action)&&t.last_action.route!==void 0&&(t.last_action.route==="search"||t.last_action.route==="filter"):!1}function throttle(t,ee){let te;const ne=()=>{te&&(clearTimeout(te),te=void 0)};let oe;return{throttled:(...re)=>{ne(),oe=re,te=setTimeout(()=>{t(...re),oe=void 0},ee)},cancel:ne,flush:()=>{ne(),oe&&(t(...oe),oe=void 0)}}}function min_throttle(t,ee){let te;const ne=()=>{te&&(clearTimeout(te),te=void 0)};let oe={args:void 0},ie;const se=(...ae)=>(oe.args=ae,te||(te=setTimeout(()=>{t(...oe.args),oe.args=void 0,te=void 0},ee),ie=performance.now()+ee),ie);let re;return{throttled:se,cancel:ne,flush:()=>(re||(re=new Promise(ae=>{setTimeout(()=>{if(ne(),re=void 0,oe.args){const ce=oe.args;oe.args=void 0,ae(t(...ce))}ae(void 0)},0)})),re)}}function pub_sub_factory(t={}){const ee={};function te(ie,se){const re=t[ie];if(re){const ce=re(se);if(!ce.continue)return;se=ce.message}const _e=ee[ie];(_e===void 0?[]:_e).forEach(ce=>{setTimeout(()=>ce(se),0)})}function ne(ie,se){const re=ee[ie],_e=re===void 0?[]:re;return _e.push(se),ee[ie]=_e,oe(ie,se)}function oe(ie,se){return()=>{const re=ee[ie],ae=(re===void 0?[]:re).filter(ce=>ce!==se);ee[ie]=ae}}return{pub:te,sub:ne}}const canvas_pub_sub=pub_sub_factory({canvas_node_drag_relative_position:canvas_node_drag_relative_position_middleware});let last_node_drag_position;function canvas_node_drag_relative_position_middleware(t){const ee=(last_node_drag_position==null?void 0:last_node_drag_position.left)!==t.left||(last_node_drag_position==null?void 0:last_node_drag_position.top)!==t.top;return last_node_drag_position=t,{continue:ee,message:t}}function handle_canvas_node_drag_relative_position(t){canvas_pub_sub.pub("throttled_canvas_node_drag_relative_position",t)}const throttled_handle_canvas_node_drag_relative_position=min_throttle(handle_canvas_node_drag_relative_position,30);canvas_pub_sub.sub("canvas_node_drag_relative_position",throttled_handle_canvas_node_drag_relative_position.throttled);const global_keys_pub_sub=pub_sub_factory(),user_pub_sub=pub_sub_factory(),pub_sub={canvas:canvas_pub_sub,global_keys:global_keys_pub_sub,user:user_pub_sub};function conditional_ctrl_f_search(t,ee){ee.ctrl_key&&ee.key==="f"&&(ee.event.preventDefault(),t.dispatch(ACTIONS.routing.change_route({route:"search"})))}const conditionally_select_all_components=factory_conditionally_select_components(t=>Object.keys(t.composed_visible_wc_id_map)),conditionally_expand_selected_components=factory_conditionally_select_components((t,ee)=>{const te=[...ee],ne=new Set(te),{wc_id_connections_map:oe,composed_visible_wc_id_map:ie}=t;return ee.forEach(se=>{const re=oe[se];re&&re.forEach(_e=>{ne.has(_e)||ie[se]&&(te.push(_e),ne.add(_e))})}),te}),conditionally_decrease_selected_components=factory_conditionally_select_components((t,ee,te)=>{const ne=new Set(ee),oe=new Set,{wc_id_connections_map:ie,composed_visible_wc_id_map:se,wc_ids_by_type:re}=t;return ee.forEach(_e=>{const ae=ie[_e];if(!ae)oe.add(_e);else{const ce=Array.from(ae).filter(le=>se[le]).filter(le=>ne.has(le));if(ce.length<=1)oe.add(_e);else if(re.any_node.has(_e)){let le;Array.from(ce).map(de=>te[de]).filter(wcomponent_is_plain_connection).find(de=>{const me=de.from_id===_e;if(le===void 0)le=me;else if(le!==me)return!0;return!1})||oe.add(_e)}}}),ee.filter(_e=>!oe.has(_e))}),conditionally_select_forward_causal_components=factory_conditionally_select_causal_components("forward"),conditionally_select_source_causal_components=factory_conditionally_select_causal_components("source");function factory_conditionally_select_causal_components(t){const ee=t==="forward";return factory_conditionally_select_components((te,ne,oe)=>{const ie=[...ne],se=new Set(ie);function re(ce){se.has(ce)||(se.add(ce),ie.push(ce))}const{wc_id_connections_map:_e,composed_visible_wc_id_map:ae}=te;return ne.forEach(ce=>{const le=_e[ce];if(!le)return;Array.from(le).concat([ce]).filter(de=>ae[de]).map(de=>oe[de]).filter(wcomponent_is_causal_link).filter(de=>(ee?de.from_id:de.to_id)===ce||de.id===ce).forEach(({id:de,from_id:me,to_id:pe})=>{re(de),re(ee?pe:me)})}),ie})}const conditionally_select_interconnections=factory_conditionally_select_components((t,ee)=>{const te=new Set(ee),ne=[...ee],oe=new Set(ne),{wc_id_connections_map:ie,composed_visible_wc_id_map:se}=t;function re(_e){return!se[_e]}return ee.forEach(_e=>{if(re(_e))return;const ae=ie[_e];ae&&ae.forEach(ce=>{if(re(ce))return;const le=ie[ce];le&&le.forEach(ue=>{ue!==_e&&te.has(ue)&&(re(ue)||oe.has(ce)||(ne.push(ce),oe.add(ce)))})})}),ne});function factory_conditionally_select_components(t){return ee=>{const te=ee.getState(),ne=get_current_composed_knowledge_view_from_state(te);if(!ne||!(te.routing.args.view==="knowledge"))return;const ie=te.meta_wcomponents.selected_wcomponent_ids_list,{wcomponents_by_id:se}=te.specialised_objects,re=t(ne,ie,se);ee.dispatch(ACTIONS.meta_wcomponents.set_selected_wcomponents({ids:re})),ee.dispatch(ACTIONS.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))}}function meta_wcomponents_selecting_subscribers(t){handle_canvas_area_select(t)}function handle_ctrl_a(t,ee){ee.key==="a"&&ee.ctrl_key&&(ee.event.preventDefault(),conditionally_select_all_components(t))}function handle_canvas_area_select(t){pub_sub.canvas.sub("canvas_area_select",ee=>{const te=t.getState(),ne=get_current_composed_knowledge_view_from_state(te);if(!ne||!(te.routing.args.view==="knowledge"))return;const{start_x:ie,start_y:se,end_x:re,end_y:_e}=ee,ae=-se,ce=-_e,le=Object.entries(ne.composed_visible_wc_id_map).filter(([me,pe])=>pe.left>=ie&&pe.left<=re&&pe.top<=ae&&pe.top>=ce).map(([me])=>me).filter(me=>!ne.wc_ids_by_type.any_link.has(me)),ue=te.global_keys.keys_down.has("Control"),de=calculate_new_selected_ids(ue,te,le);t.dispatch(ACTIONS.meta_wcomponents.set_selected_wcomponents({ids:de})),t.dispatch(ACTIONS.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))})}function calculate_new_selected_ids(t,ee,te){let ne=[];if(t){const oe=new Set(ee.meta_wcomponents.selected_wcomponent_ids_set);te.forEach(ie=>oe.delete(ie)),ne=Array.from(oe)}else ne=ee.meta_wcomponents.selected_wcomponent_ids_list.concat(te);return ne}function display_options_subscribers(t){toggle_consumption_formatting_on_key_press(t)}function toggle_consumption_formatting_on_key_press(t){let ee="";pub_sub.global_keys.sub("key_down",te=>{if(ee){handle_key_combo(ee,te,t);return}const ne=te.ctrl_key&&root_key_combo.has(te.key);if(ee=ne?ee=te.key:"",ne){te.event.preventDefault();return}te.ctrl_key&&te.key==="e"?(te.event.preventDefault(),t.dispatch(ACTIONS.display.toggle_consumption_formatting({}))):te.shift_key&&te.key==="?"?(te.event.preventDefault(),t.getState().display_options.show_help_menu||t.dispatch(ACTIONS.display.set_show_help_menu({show:!0}))):(handle_ctrl_a(t,te),conditional_ctrl_f_search(t,te))}),pub_sub.global_keys.sub("key_up",te=>{te.key==="Control"&&(ee="")})}function handle_key_combo(t,ee,te){let ne=!1;t==="d"?ne=handle_display_key_combo(ee.key,te):t==="s"&&(ne=handle_selection_key_combo(ee.key,te)),ne&&ee.event.preventDefault()}const root_key_combo=new Set(["d","s"]);function handle_display_key_combo(t,ee){let te=!0;return t==="f"?ee.dispatch(ACTIONS.display.set_or_toggle_focused_mode()):t==="t"?ee.dispatch(ACTIONS.controls.toggle_display_time_sliders()):t==="s"?ee.dispatch(ACTIONS.controls.set_or_toggle_display_side_panel()):t==="a"?ee.dispatch(ACTIONS.display.set_or_toggle_animate_connections()):t==="c"?ee.dispatch(ACTIONS.display.set_or_toggle_circular_links()):te=!1,te}function handle_selection_key_combo(t,ee){let te=!0;return t==="a"?conditionally_select_all_components(ee):t==="e"?conditionally_expand_selected_components(ee):t==="d"?conditionally_decrease_selected_components(ee):t==="f"?conditionally_select_forward_causal_components(ee):t==="c"?conditionally_select_source_causal_components(ee):t==="i"?conditionally_select_interconnections(ee):te=!1,te}function record_keyupdown_activity(t){document.onkeydown=ee=>{const te={event:ee,time_stamp:ee.timeStamp,alt_key:ee.altKey,code:ee.code,ctrl_key:ee.ctrlKey,key:ee.key,meta_key:ee.metaKey,shift_key:ee.shiftKey};t.dispatch(ACTIONS.global_keys.key_down(te)),pub_sub.global_keys.pub("key_down",te)},document.onkeyup=ee=>{const te={event:ee,time_stamp:ee.timeStamp,alt_key:ee.altKey,code:ee.code,ctrl_key:ee.ctrlKey,key:ee.key,meta_key:ee.metaKey,shift_key:ee.shiftKey};t.dispatch(ACTIONS.global_keys.key_up(te)),pub_sub.global_keys.pub("key_up",te)},window.onfocus=()=>{t.getState().global_keys.keys_down.size!==0&&t.dispatch(ACTIONS.global_keys.clear_all_keys())}}function pick(t,ee){const te={};return t.forEach(ne=>{te[ne]=ee[ne]}),te}function controls_persist(t){const ee=pick(["display_time_sliders","display_side_panel"],t.controls);persist_state_object("controls",ee)}function controls_starting_state(t){const ee=get_persisted_state_object("controls");return{linked_datetime_sliders:!1,display_time_sliders:!1,display_side_panel:!0,display_select_storage:t.storage_location===void 0,...ee}}function creation_context_persist(t){const ee=pick(["use_creation_context","creation_context"],t.creation_context);persist_state_object("creation_context",ee)}function creation_context_starting_state(){const t=get_persisted_state_object("creation_context"),{use_creation_context:ee=!1,creation_context:te={custom_created_at:void 0,label_ids:[]}}=t;let{custom_created_at:ne}=te;return ne=ne&&new Date(ne),te.custom_created_at=ne,{use_creation_context:ee,creation_context:te}}function derive_validity_filter(t){return{only_certain_valid:t==="only_certain_valid",only_maybe_valid:t==="only_maybe_valid",maybe_invalid:t==="maybe_invalid",show_invalid:t==="show_invalid"}}function derive_certainty_formatting(t){return{render_certainty_as_opacity:t==="render_certainty_as_opacity",render_certainty_as_easier_opacity:t==="render_certainty_as_easier_opacity",render_100_opacity:t==="render_100_opacity"}}function display_options_persist(t){const ee=pick(["consumption_formatting","time_resolution","display_by_simulated_time","display_time_marks","animate_connections","circular_links","show_large_grid","validity_filter","certainty_formatting"],t.display_options);persist_state_object("display_options",ee)}function display_options_starting_state(){const t=get_persisted_state_object("display_options"),ee=t.validity_filter||"show_invalid",te=t.certainty_formatting||"render_certainty_as_opacity",ne=derive_validity_filter(ee),oe=derive_certainty_formatting(te);return{consumption_formatting:!0,focused_mode:!1,time_resolution:"minute",display_by_simulated_time:!1,display_time_marks:!1,animate_connections:!1,circular_links:!0,show_help_menu:!1,show_large_grid:!1,validity_filter:ee,certainty_formatting:te,derived_validity_filter:ne,derived_certainty_formatting:oe,...t}}function filter_context_persist(t){const ee=pick(["apply_filter","filters"],t.filter_context);persist_state_object("filter_context",ee)}function filter_context_starting_state(){const t=get_persisted_state_object("filter_context");t.filters instanceof Array&&delete t.filters;const{apply_filter:ee=!1,filters:te={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""}}=t;return{apply_filter:ee,filters:te}}function search_persist(t){const ee=pick(["search_fields","search_type"],t.search);persist_state_object("search",ee)}function search_starting_state(){return{search_fields:"all",search_type:"best",...get_persisted_state_object("search")}}function sync_persist(t){const ee=pick([],t.sync);persist_state_object("sync",ee)}function sync_starting_state(){const t=get_persisted_state_object("sync"),ee={status:void 0,error_message:"",retry_attempt:void 0,loading_base_id:void 0};return{last_source_of_truth_specialised_objects_by_id:{wcomponents:{},knowledge_views:{}},specialised_object_ids_pending_save:{wcomponent_ids:new Set,knowledge_view_ids:new Set},specialised_objects_save_conflicts:{wcomponent_conflicts_by_id:{},knowledge_view_conflicts_by_id:{}},ready_for_reading:!1,ready_for_writing:!1,network_functional:!0,network_function_last_checked:void 0,wcomponent_ids_to_search_for_in_any_base:new Set,wcomponent_ids_searching_for_in_any_base:new Set,wcomponent_ids_searched_for_in_any_base:new Set,bases:{...ee},specialised_objects:{...ee},...t}}const local_raw_data={wcomponents_by_id:{},knowledge_views_by_id:{}},local_user={},{wcomponents_by_id,knowledge_views_by_id}=local_raw_data,wcomponents=Object.values(wcomponents_by_id).map(t=>parse_wcomponent(t)),knowledge_views=Object.values(knowledge_views_by_id).map(t=>parse_knowledge_view(t)),local_data={wcomponents,knowledge_views};function user_info_persist(t){const ee=pick(["has_signed_in_at_least_once","chosen_base_id"],t.user_info);persist_state_object("user_info",ee)}function user_info_starting_state(t){const ee=get_persisted_state_object("user_info"),ne=(re=>document.location.hash.includes(re))("type=recovery"),oe=t.storage_location!==void 0?t.storage_location:ee.chosen_base_id;return{has_signed_in_at_least_once:!1,user:t.load_state_from_storage?get_supabase().auth.user()||void 0:local_user,need_to_handle_password_recovery:ne,users_by_id:void 0,bases_by_id:void 0,...ee,chosen_base_id:oe}}function persist_relevant_state(t){creation_context_persist(t),controls_persist(t),display_options_persist(t),filter_context_persist(t),search_persist(t),sync_persist(t),user_info_persist(t)}const controls_reducer=(t,ee)=>{if(is_toggle_linked_datetime_sliders(ee)){const te=!t.controls.linked_datetime_sliders;t=update_substate(t,"controls","linked_datetime_sliders",te)}if(is_set_display_time_sliders(ee)){const{display_time_sliders:te}=ee;t=update_substate(t,"controls","display_time_sliders",te)}if(is_toggle_display_time_sliders(ee)){const{display_time_sliders:te}=t.controls;t=update_substate(t,"controls","display_time_sliders",!te)}if(is_set_or_toggle_display_side_panel(ee)){const{display_side_panel:te}=t.controls,ne=ee.display_side_panel??!te;t=update_substate(t,"controls","display_side_panel",ne)}if(is_set_or_toggle_display_select_storage(ee)){const{display_select_storage:te}=t.controls,ne=ee.display_select_storage??!te;t=update_substate(t,"controls","display_select_storage",ne)}return t},creation_context_reducer=(t,ee)=>{if(is_toggle_use_creation_context(ee)){const ne=!t.creation_context.use_creation_context;t=update_substate(t,"creation_context","use_creation_context",ne)}let te=!1;if(is_set_custom_created_at(ee)){const ne={label_ids:[],...t.creation_context.creation_context,custom_created_at:ee.custom_created_at};t=update_substate(t,"creation_context","creation_context",ne),te=te||!!ee.custom_created_at}if(is_set_label_ids(ee)){const ne={...t.creation_context.creation_context,label_ids:ee.label_ids};t=update_substate(t,"creation_context","creation_context",ne),te=te||ee.label_ids.length>0}if(is_set_replace_text(ee)){const ne={label_ids:[],...t.creation_context.creation_context};ee.value_type==="target"?ne.replace_text_target=ee.value:ne.replace_text_replacement=ee.value,t=update_substate(t,"creation_context","creation_context",ne)}return te&&(t=update_substate(t,"creation_context","use_creation_context",!0)),t},DEFAULT_DATETIME_LINE_CONFIG={time_origin_x:0,time_scale:1,time_line_number:4,time_line_spacing_days:30};function default_time_origin_parameters(t){const ee=t.time_origin_ms??new Date().getTime(),te=t.time_origin_x??0,ne=t.time_scale??1;return{time_origin_ms:ee,time_origin_x:te,time_scale:ne}}function calculate_canvas_x_for_wcomponent_temporal_uncertainty(t){const ee=get_current_datetime_from_wcomponent(t.wcomponent_id,t.wcomponents_by_id,t.created_at_ms);if(!ee)return;const te=calculate_canvas_x_for_datetime({datetime:ee,...t});return round_coordinate_small_step(te)}function calculate_canvas_x_for_datetime(t){const ee=t.datetime.getTime()-t.time_origin_ms,te=t.time_scale/time_scale_days_to_ms_pixels_fudge_factor;return ee*te+t.time_origin_x}function wc_map_entry_to_coord_key(t){return`${t.left},${t.top}`}function get_wc_position_to_id_map(t,ee){const te={};return Object.entries(t).forEach(([ne,oe])=>{if(wcomponent_is_plain_connection(ee[ne]))return;const ie=round_canvas_point(oe,"large"),se=wc_map_entry_to_coord_key(ie),re=te[se]||[];re.push(ne),te[se]=re}),te}function ensure_item_in_set(t,ee){return t.has(ee)||(t=new Set(t),t.add(ee)),t}function ensure_item_not_in_set(t,ee){return t.has(ee)&&(t=new Set(t),t.delete(ee)),t}function set_union(...t){let ee=[];return t.forEach(te=>ee=ee.concat(Array.from(te))),new Set(ee)}function set_difference(t,ee){const te=new Set(t);return ee.forEach(ne=>te.delete(ne)),te.size===t.size?t:te}function get_empty_wcomponent_ids_by_type(){return{event:new Set,statev2:new Set,state_value:new Set,sub_state:new Set,multidimensional_state:new Set,process:new Set,action:new Set,actor:new Set,causal_link:new Set,relation_link:new Set,judgement:new Set,objective:new Set,counterfactualv2:new Set,goal:new Set,prioritisation:new Set,judgement_or_objective:new Set,goal_or_action:new Set,has_objectives:new Set,any_link:new Set,any_node:new Set,any_state_VAPs:new Set,has_single_datetime:new Set}}function get_wcomponent_ids_by_type(t,ee){const te=get_empty_wcomponent_ids_by_type(),ne=new Set;return ee.forEach(oe=>{const ie=t[oe];if(!ie){console.warn(`Could not find wcomponent by id: ${oe}.  Wrong ID or in another base?`);return}wcomponent_is_deleted(ie)||(te[ie.type].add(oe),wcomponent_has_legitimate_non_empty_state_VAP_sets(ie)&&wcomponent_has_single_statev2_datetime(ie)&&ne.add(ie.id))}),te.judgement_or_objective=set_union(te.judgement,te.objective),te.goal_or_action=set_union(te.goal,te.action),te.has_objectives=set_union(te.action,te.goal),te.any_link=set_union(te.causal_link,te.relation_link),te.any_node=set_difference(new Set(ee),te.any_link),te.any_state_VAPs=set_union(te.statev2,te.causal_link,te.action),te.has_single_datetime=set_union(te.event,te.sub_state,ne),te}function calc_if_wcomponent_should_exclude_because_label_or_type(t,ee){const{id:te,label_ids:ne=[],type:oe}=t,{exclude_by_label_ids:ie,include_by_label_ids:se,exclude_by_component_types:re,include_by_component_types:_e}=ee,ae=ie.has(te)||!!ne.find(pe=>ie.has(pe)),ce=se.size>0&&!se.has(te)&&!ne.find(pe=>se.has(pe)),le=re.has(oe),ue=_e.size>0&&!_e.has(oe);return{should_exclude:ae||le,lacks_include:ce||ue}}const test_calc_if_wcomponent_should_exclude_because_label_or_type=describe("calc_if_wcomponent_should_exclude_because_label_or_type",()=>{const t=prepare_new_contextless_wcomponent_object({id:"1",base_id:1}),ee=prepare_new_contextless_wcomponent_object({id:"2",base_id:1,label_ids:[t.id]}),te=prepare_new_contextless_wcomponent_object({id:"3",base_id:1,label_ids:[]}),ne={exclude_by_label_ids:new Set,include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},oe={exclude_by_label_ids:new Set([t.id]),include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},ie={exclude_by_label_ids:new Set,include_by_label_ids:new Set([t.id]),exclude_by_component_types:new Set,include_by_component_types:new Set},se={exclude_by_label_ids:new Set([t.id]),include_by_label_ids:new Set([t.id]),exclude_by_component_types:new Set,include_by_component_types:new Set};let{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,ne);test(re,!1),test(_e,!1),{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,oe),test(re,!0),test(_e,!1),{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,ie),test(re,!1),test(_e,!1),{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(te,ie),test(re,!1),test(_e,!0),{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(ee,se),test(re,!0),test(_e,!1),{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(t,oe),test(re,!0),test(_e,!1),{should_exclude:re,lacks_include:_e}=calc_if_wcomponent_should_exclude_because_label_or_type(t,ie),test(re,!1),test(_e,!1)},!1);function get_knowledge_view_given_routing(t){let ee=t.routing.args.subview_id;return ee=is_uuid_v4(ee)?ee:"",get_knowledge_view_from_state(t,ee)}function get_composed_wc_id_maps_object(t,ee){let te={};t.forEach(ie=>{Object.entries(ie.wc_id_map).forEach(([se,re])=>{re.passthrough||(delete te[se],te[se]=re)})}),remove_deleted_wcomponents(te,ee);const ne=partition_wc_id_map_on_blocked(te);te=ne.composed_wc_id_map;const oe=ne.composed_blocked_wc_id_map;return{composed_wc_id_map:te,composed_blocked_wc_id_map:oe}}function remove_deleted_wcomponents(t,ee){Object.keys(t).forEach(te=>{const ne=ee[te];wcomponent_is_deleted(ne)&&delete t[te]})}function partition_wc_id_map_on_blocked(t){const ee={};return Object.entries(t).forEach(([te,ne])=>{ne.blocked&&(ee[te]=ne,delete t[te])}),{composed_wc_id_map:t,composed_blocked_wc_id_map:ee}}function get_available_filter_options(t){const ee=new Set,te=new Set;t.forEach(oe=>{oe.label_ids&&oe.label_ids.forEach(ie=>ee.add(ie)),te.add(oe.type)});const ne=Array.from(te).sort();return{wc_label_ids:ee,wc_types:ne}}const links_regex=/(.*?)(?:\[([^\]]*)\]\([^\)]*\))/g,tags_regex=/(.*?)(\<[^\>]*\>)/g;function remove_rich_text(t){return t=t.replaceAll(links_regex,"$1$2"),t=t.replaceAll(tags_regex,"$1"),t}const knowledge_views_derived_reducer=(t,ee)=>{t.specialised_objects.knowledge_views_by_id!==ee.specialised_objects.knowledge_views_by_id&&(ee=update_derived_knowledge_view_state(ee));const ne=get_knowledge_view_given_routing(t),oe=get_knowledge_view_given_routing(ee);(ne==null?void 0:ne.id)!==(oe==null?void 0:oe.id)&&(ee=update_substate(ee,"derived","current_composed_knowledge_view",void 0));const se=ne!==oe,re=t.specialised_objects.wcomponents_by_id!==ee.specialised_objects.wcomponents_by_id,_e=se||re,ae=t.routing.args.created_at_ms!==ee.routing.args.created_at_ms,ce=ae||t.filter_context!==ee.filter_context||re,le=t.display_options.display_time_marks!==ee.display_options.display_time_marks,ue=ae||le;if(oe){if(_e){let de=update_current_composed_knowledge_view_state(ee,oe);de=update_composed_knowledge_view_filters(ee,de),de=add_ephemeral_overrides_to_wc_id_map(ee,de),ee=update_substate(ee,"derived","current_composed_knowledge_view",de)}else if(ce){const de=update_composed_knowledge_view_filters(ee,ee.derived.current_composed_knowledge_view);ee=update_substate(ee,"derived","current_composed_knowledge_view",de)}else if(ue){let{current_composed_knowledge_view:de}=ee.derived;de=update_ephemeral_overrides_of_current_composed_kv(de,le,ee,oe),ee=update_substate(ee,"derived","current_composed_knowledge_view",de)}}return ee};function update_derived_knowledge_view_state(t){const{knowledge_views_by_id:ee}=t.specialised_objects,te=selector_chosen_base_id(t),oe=Object.values(ee).map(re=>({...re,title:remove_rich_text(re.title)})),ie=sort_list(oe,({title:re})=>re,SortDirection.ascending),se=get_nested_knowledge_view_ids(ie,te);return sort_nested_knowledge_map_ids_by_priority_then_title(se),t={...t,derived:{...t.derived,knowledge_views:ie,nested_knowledge_view_ids:se}},t}function update_current_composed_knowledge_view_state(t,ee){const{knowledge_views_by_id:te,wcomponents_by_id:ne}=t.specialised_objects,{current_composed_knowledge_view:oe}=t.derived;return calculate_composed_knowledge_view({knowledge_view:ee,current_composed_knowledge_view:oe,knowledge_views_by_id:te,wcomponents_by_id:ne})}function calculate_composed_knowledge_view(t){const{knowledge_view:ee,knowledge_views_by_id:te,wcomponents_by_id:ne}=t,oe=t.current_composed_knowledge_view||{composed_visible_wc_id_map:{},active_judgement_or_objective_ids_by_target_id:{},active_judgement_or_objective_ids_by_goal_or_action_id:{},filters:{wc_ids_excluded_by_any_filter:new Set,wc_ids_excluded_by_filters:new Set,wc_ids_excluded_by_created_at_datetime_filter:new Set,vap_set_number_excluded_by_created_at_datetime_filter:0}},ie=get_foundational_knowledge_views(ee,te,!0),{composed_wc_id_map:se,composed_blocked_wc_id_map:re}=get_composed_wc_id_maps_object(ie,ne),_e=get_overlapping_wc_ids(se,ne),ae=Object.keys(se),ce=get_wcomponent_ids_by_type(ne,ae),le=[],ue=[];ae.forEach(we=>{const ke=ne[we];ke?le.push(ke):ue.push(we)});const de=le.filter(is_wcomponent_node),me=le.filter(wcomponent_can_render_connection),pe=get_wc_id_to_counterfactuals_v2_map({wc_ids_by_type:ce,wcomponents_by_id:ne}),fe=get_wc_id_to_counterfactuals_v2_map({wc_ids_by_type:ce,wcomponents_by_id:ne,active_counterfactual_ids:ee.active_counterfactual_v2_ids}),ge=get_prioritisations(ce.prioritisation,ne),he=get_wc_id_connections_map(ce.any_link,ne),be=get_available_filter_options(le),ve=get_composed_datetime_lines_config(ie,!0),ye={...ee,...oe,composed_wc_id_map:se,composed_blocked_wc_id_map:re,overlapping_wc_ids:_e,wcomponent_nodes:de,wcomponent_connections:me,wcomponent_unfound_ids:ue,wc_id_to_counterfactuals_v2_map:pe,wc_id_to_active_counterfactuals_v2_map:fe,wc_ids_by_type:ce,prioritisations:ge,wc_id_connections_map:he,available_filter_options:be,composed_datetime_line_config:ve};return delete ye.wc_id_map,delete ye.datetime_line_config,ye}function get_foundational_knowledge_views(t,ee,te){const{foundation_knowledge_view_ids:ne=[]}=t,oe=ne.map(ie=>ee[ie]).filter(is_defined);return te&&oe.push(t),oe}const invalid_node_types=new Set(["causal_link","relation_link"]),is_wcomponent_node=t=>!invalid_node_types.has(t.type);function get_wc_id_to_counterfactuals_v2_map(t){const ee={},te=t.active_counterfactual_ids?new Set(t.active_counterfactual_ids):!1;return t.wc_ids_by_type.counterfactualv2.forEach(ne=>{if(te&&!te.has(ne))return;const oe=t.wcomponents_by_id[ne];if(!wcomponent_is_counterfactual_v2(oe))return;const{target_wcomponent_id:ie,target_VAP_set_id:se}=oe;if(!ie||!se)return;const re=ee[ie]||{VAP_sets:{}};ee[ie]=re;const _e=re.VAP_sets[se]||[];_e.push(oe),re.VAP_sets[se]=_e}),ee}function get_prioritisations(t,ee){const te=Array.from(t).map(ne=>ee[ne]).filter(wcomponent_is_prioritisation);return sort_list(te,ne=>get_sim_datetime_ms(ne)||get_created_at_ms(ne),SortDirection.descending)}function get_wc_id_connections_map(t,ee){const te={};function ne(ie,se){const re=te[ie]||new Set;re.add(se),te[ie]=re}function oe(ie,se){ne(ie,se),ne(se,ie)}return t.forEach(ie=>{const se=ee[ie];wcomponent_is_plain_connection(se)&&(se.from_id&&oe(se.from_id,se.id),se.to_id&&oe(se.to_id,se.id))}),te}function get_composed_datetime_lines_config(t,ee){let te={};return ee&&(te={...DEFAULT_DATETIME_LINE_CONFIG}),t.forEach(ne=>{const{datetime_line_config:oe}=ne;oe&&(te.time_origin_ms=oe.time_origin_ms??te.time_origin_ms,te.time_origin_x=oe.time_origin_x??te.time_origin_x,te.time_scale=oe.time_scale??te.time_scale,te.time_line_number=oe.time_line_number??te.time_line_number,te.time_line_spacing_days=oe.time_line_spacing_days??te.time_line_spacing_days)}),te}function update_composed_knowledge_view_filters(t,ee){if(!ee)return;const{wc_ids_by_type:te,composed_wc_id_map:ne}=ee,oe=get_wcomponents_from_state(t,te.any_node).filter(is_defined),ie=get_wcomponents_from_state(t,te.any_link).filter(wcomponent_is_plain_connection),se=oe.concat(ie),re=new Set;if(t.filter_context.apply_filter){const{exclude_by_label_ids:pe,include_by_label_ids:fe,exclude_by_component_types:ge,include_by_component_types:he}=t.filter_context.filters,be=new Set(pe),ve=new Set(fe),ye=new Set(ge),we=new Set(he),ke={exclude_by_label_ids:be,include_by_label_ids:ve,include_by_label_ids_list:fe,exclude_by_component_types:ye,include_by_component_types:we};oe.forEach($e=>{const{should_exclude:xe,lacks_include:Ce}=calc_if_wcomponent_should_exclude_because_label_or_type($e,ke);(xe||Ce)&&re.add($e.id)});const{selected_wcomponent_ids_set:Ae}=t.meta_wcomponents;ie.forEach($e=>{const{from_id:xe,to_id:Ce}=$e;let Se=!xe||!Ce;Se=Se||!Ae.has(xe)&&re.has(xe)||!Ae.has(Ce)&&re.has(Ce),Se=Se||calc_if_wcomponent_should_exclude_because_label_or_type($e,ke).should_exclude,Se&&re.add($e.id)})}const _e=new Set(re),{created_at_ms:ae}=t.routing.args;let ce=0;const le=se.filter(pe=>(wcomponent_has_legitimate_non_empty_state_VAP_sets(pe)&&pe.values_and_prediction_sets.forEach(fe=>{get_created_at_ms(fe)>ae&&++ce}),get_created_at_ms(pe)>ae)).map(({id:pe})=>pe),ue=new Set(le),de=set_union(_e,ue),me={...ne};return de.forEach(pe=>{delete me[pe]}),{...ee,composed_visible_wc_id_map:me,filters:{wc_ids_excluded_by_any_filter:de,wc_ids_excluded_by_filters:_e,wc_ids_excluded_by_created_at_datetime_filter:ue,vap_set_number_excluded_by_created_at_datetime_filter:ce}}}function get_overlapping_wc_ids(t,ee){const te=get_wc_position_to_id_map(t,ee),ne={};return Object.values(te).forEach(oe=>{oe.length<=1||oe.forEach((ie,se)=>{const re=se+1;ne[ie]=[...oe.slice(re),...oe.slice(0,re)]})}),ne}function update_ephemeral_overrides_of_current_composed_kv(t,ee,te,ne){if(t){if(ee&&!te.display_options.display_time_marks){const{knowledge_views_by_id:oe,wcomponents_by_id:ie}=te.specialised_objects,se=get_foundational_knowledge_views(ne,oe,!0),re=get_composed_wc_id_maps_object(se,ie);t={...t,...re}}else t=add_ephemeral_overrides_to_wc_id_map(te,t);return t}}function add_ephemeral_overrides_to_wc_id_map(t,ee){if(!ee)return;const{display_time_marks:te}=t.display_options,{wc_ids_by_type:ne,composed_wc_id_map:oe,composed_datetime_line_config:ie}=ee,{time_origin_ms:se,time_origin_x:re,time_scale:_e}=ie,{wcomponents_by_id:ae}=t.specialised_objects,{created_at_ms:ce}=t.routing.args;if(!te||se===void 0)return ee;const le={...oe};let ue=!1;return Array.from(ne.has_single_datetime).forEach(de=>{const me=oe[de];if(!me)return;const pe=calculate_canvas_x_for_wcomponent_temporal_uncertainty({wcomponent_id:de,wcomponents_by_id:ae,created_at_ms:ce,time_origin_ms:se,time_origin_x:re,time_scale:_e});pe===void 0||me.left===pe||(ue=!0,le[de]={...me,left:pe})}),ue?{...ee,composed_wc_id_map:le}:ee}function derived_composed_wcomponents_by_id_reducer(t,ee){var _e,ae;const te=t.specialised_objects.wcomponents_by_id!==ee.specialised_objects.wcomponents_by_id,ne=(_e=t.derived.current_composed_knowledge_view)==null?void 0:_e.composed_visible_wc_id_map,oe=(ae=ee.derived.current_composed_knowledge_view)==null?void 0:ae.composed_visible_wc_id_map;if(!(te||ne!==oe))return ee;const re=get_composed_wcomponents_by_id(ee);return ee=update_substate(ee,"derived","composed_wcomponents_by_id",re),ee}function get_composed_wcomponents_by_id(t){const{wcomponents_by_id:ee}=t.specialised_objects,te={...ee},{composed_visible_wc_id_map:ne}=t.derived.current_composed_knowledge_view||{},{created_at_ms:oe}=t.routing.args;return Object.keys(ne||{}).forEach(ie=>{const se=ee[ie];if(se&&wcomponent_is_state_value(se)){const re=ee[se.attribute_wcomponent_id||""];if(!wcomponent_is_statev2(re))return;let _e;se.values_and_prediction_sets&&(_e=partition_items_by_created_at_datetime({items:se.values_and_prediction_sets,created_at_ms:oe}).current_items,_e=sort_list(_e,get_created_at_ms,SortDirection.descending));const ae={...re,values_and_prediction_sets:_e,value_possibilities:se.value_possibilities,_derived__using_value_from_wcomponent_id:se.id};te[ae.id]=ae}}),te}function derived_state_reducer(t,ee){if(t.specialised_objects.wcomponents_by_id!==ee.specialised_objects.wcomponents_by_id){const te=Object.keys(ee.specialised_objects.wcomponents_by_id),ne=get_wcomponent_ids_by_type(ee.specialised_objects.wcomponents_by_id,te);ee=update_substate(ee,"derived","wcomponent_ids_by_type",ne);const oe=get_judgement_or_objectives(ee,ee.derived.wcomponent_ids_by_type.judgement_or_objective),ie=update_judgement_or_objective_ids_by_target_id(oe);ee=update_substate(ee,"derived","judgement_or_objective_ids_by_target_id",ie);const se=get_wcomponents_from_state(ee,ee.derived.wcomponent_ids_by_type.goal).filter(is_defined).filter(wcomponent_is_goal),re=update_judgement_or_objective_ids_by_goal_or_action_id(se);ee=update_substate(ee,"derived","judgement_or_objective_ids_by_goal_or_action_id",re)}return ee=knowledge_views_derived_reducer(t,ee),ee=derived_composed_wcomponents_by_id_reducer(t,ee),ee=conditionally_update_active_judgement_or_objective_ids(t,ee),ee}function get_judgement_or_objectives(t,ee){return get_wcomponents_from_state(t,ee).filter(is_defined).filter(wcomponent_is_judgement_or_objective)}function update_judgement_or_objective_ids_by_target_id(t){const ee={};return t.forEach(te=>{const ne=te.judgement_target_wcomponent_id;if(!ne)return;const oe=ee[ne]||[];oe.push(te.id),ee[ne]=oe}),ee}function update_judgement_or_objective_ids_by_goal_or_action_id(t){const ee={};return t.forEach(({id:te,objective_ids:ne})=>{ee[te]=ne||[]}),ee}function conditionally_update_active_judgement_or_objective_ids(t,ee){var ae;let{current_composed_knowledge_view:te}=ee.derived;const ne=((ae=t.derived.current_composed_knowledge_view)==null?void 0:ae.id)!==(te==null?void 0:te.id),oe=t.derived.judgement_or_objective_ids_by_target_id!==ee.derived.judgement_or_objective_ids_by_target_id,{created_at_ms:ie,sim_ms:se}=ee.routing.args,re=t.routing.args.created_at_ms!==ie,_e=t.routing.args.sim_ms!==se;if(te&&(ne||oe||re||_e)){let ce=function(ye){return fe[ye]};const le={},ue={},{wc_ids_by_type:de,composed_visible_wc_id_map:me}=te,pe=get_judgement_or_objectives(ee,de.judgement_or_objective),fe={};pe.forEach(ye=>{if(!me[ye.id])return;const{is_valid:we}=get_wcomponent_validity_value({wcomponent:ye,created_at_ms:ie,sim_ms:se});we&&(fe[ye.id]=!0)});const ge={};Object.keys(me).forEach((ye,we)=>{ge[ye]=we});const he=ye=>ge[ye]||-1,{judgement_or_objective_ids_by_target_id:be,judgement_or_objective_ids_by_goal_or_action_id:ve}=ee.derived;Object.keys(me).forEach(ye=>{const we=be[ye],ke=ve[ye];if(we){const Ae=we.filter(ce);if(Ae.length){const $e=sort_list(Ae,he,SortDirection.descending);le[ye]=$e}}if(ke){const Ae=ke.filter(ce);if(Ae.length){const $e=sort_list(Ae,he,SortDirection.descending);ue[ye]=$e}}}),te={...te,active_judgement_or_objective_ids_by_target_id:le,active_judgement_or_objective_ids_by_goal_or_action_id:ue},ee=update_substate(ee,"derived","current_composed_knowledge_view",te)}return ee}const display_reducer=(t,ee)=>{if(is_toggle_consumption_formatting(ee)&&(t=update_substate(t,"display_options","consumption_formatting",!t.display_options.consumption_formatting)),is_set_or_toggle_focused_mode(ee)){const te=boolean_or_toggle(ee.focused_mode,t.display_options.focused_mode);t=update_substate(t,"display_options","focused_mode",te)}if(is_set_time_resolution(ee)&&(t=update_substate(t,"display_options","time_resolution",ee.time_resolution)),is_set_validity_filter(ee)){t=update_substate(t,"display_options","validity_filter",ee.validity_filter);const te=derive_validity_filter(ee.validity_filter);t=update_substate(t,"display_options","derived_validity_filter",te)}if(is_set_certainty_formatting(ee)){t=update_substate(t,"display_options","certainty_formatting",ee.certainty_formatting);const te=derive_certainty_formatting(ee.certainty_formatting);t=update_substate(t,"display_options","derived_certainty_formatting",te)}if(is_set_display_by_simulated_time(ee)&&(t=update_substate(t,"display_options","display_by_simulated_time",ee.display_by_simulated_time)),is_set_display_time_marks(ee)&&(t=update_substate(t,"display_options","display_time_marks",ee.display_time_marks)),is_set_or_toggle_animate_connections(ee)){const te=boolean_or_toggle(ee.animate_connections,t.display_options.animate_connections);t=update_substate(t,"display_options","animate_connections",te)}if(is_set_or_toggle_circular_links(ee)){const te=boolean_or_toggle(ee.circular_links,t.display_options.circular_links);t=update_substate(t,"display_options","circular_links",te)}if(is_set_show_help_menu(ee)&&(t=update_substate(t,"display_options","show_help_menu",ee.show)),is_set_or_toggle_show_large_grid(ee)){const te=boolean_or_toggle(ee.show_large_grid,t.display_options.show_large_grid);t=update_substate(t,"display_options","show_large_grid",te)}return t};function boolean_or_toggle(t,ee){return t===void 0&&(t=!ee),t}function get_is_on_actions_list_view(t){return t.routing.args.view==="actions_list"}function get_action_ids_for_actions_list_view(t){let ee=t.derived.wcomponent_ids_by_type.action;const{apply_filter:te,filters:ne}=t.filter_context;if(!te)return ee;const{filter_by_current_knowledge_view:oe,filter_by_text:ie}=ne;if(oe){const se=get_current_composed_knowledge_view_from_state(t);se&&(ee=se.wc_ids_by_type.action)}if(ie){const se=Array.from(ee).map(re=>t.specialised_objects.wcomponents_by_id[re]).filter(is_a_wcomponent).filter(re=>re.title.includes(ie)||re.description.includes(ie)).map(re=>re.id);ee=new Set(se)}return ee}const filter_context_reducer=(t,ee)=>{if(is_set_apply_filter(ee)&&(t=update_substate(t,"filter_context","apply_filter",ee.apply_filter)),is_set_filters(ee)){t=update_substate(t,"filter_context","filters",ee.filters);const te=get_is_on_actions_list_view(t),{exclude_by_label_ids:ne,include_by_label_ids:oe,exclude_by_component_types:ie,include_by_component_types:se,filter_by_current_knowledge_view:re,filter_by_text:_e}=ee.filters,ae=ne.length+oe.length+ie.length+se.length>0||te&&(re||_e.length>0);t=update_substate(t,"filter_context","apply_filter",ae)}return t},global_keys_reducer=(t,ee)=>{let te=!1;if(is_key_down(ee)){te=!0;const ne=new Set([...t.global_keys.keys_down]);ne.add(ee.key),t={...t,global_keys:{...t.global_keys,last_key:ee.key,last_key_time_stamp:ee.time_stamp,keys_down:ne}}}if(is_key_up(ee)){te=!0;let ne=new Set([...t.global_keys.keys_down]);ne.delete(ee.key),t={...t,global_keys:{...t.global_keys,last_key:ee.key,last_key_time_stamp:ee.time_stamp,keys_down:ne}}}return is_clear_all_keys(ee)&&(te=!0,t=update_substate(t,"global_keys","keys_down",new Set)),te&&(t=set_derived_state(t)),t};function set_derived_state(t){const{keys_down:ee}=t.global_keys,te=ee.has("Control"),ne=ee.has("Shift"),oe={...t.global_keys,derived:{shift_down:ne,control_down:te,shift_or_control_down:te||ne}};return{...t,global_keys:oe}}const view_priorities_reducer=(t,ee)=>(is_set_action_ids_to_show(ee)&&(t=update_substate(t,"view_priorities","action_ids_to_show",ee.action_ids),t=update_substate(t,"view_priorities","date_shown",ee.date_shown)),t),ONE_MINUTE$1=60*1e3;function get_latest_sim_ms_for_routing(t,ee){let te=Number.NEGATIVE_INFINITY;return wcomponent_has_legitimate_non_empty_state_VAP_sets(t)&&t.type==="action"&&t.values_and_prediction_sets.forEach(ne=>{var ie;const oe=((ie=get_uncertain_datetime(ne.datetime))==null?void 0:ie.getTime())||Number.NEGATIVE_INFINITY;te=Math.max(te,oe)}),te=Math.max(te+ONE_MINUTE$1,ee.routing.args.sim_ms),te}const routing_reducer=(t,ee)=>{if(is_change_route(ee)){const{route:te,sub_route:ne,item_id:oe,args:ie}=t.routing,se=merge_routing_state(t.routing,ee);(te!==se.route||ne!==se.sub_route||oe!==se.item_id||routing_args_to_string(ie)!==routing_args_to_string(se.args))&&(t={...t,routing:se})}if(is_upsert_wcomponent(ee)){const te=get_latest_sim_ms_for_routing(ee.wcomponent,t);te!==t.routing.args.sim_ms&&(t=update_subsubstate(t,"routing","args","sim_ms",te))}return t},find_all_causal_paths_reducer=(t,ee)=>{if(is_set_find_all_causal_paths_wcomponent_ids(ee)){const te=ee.direction==="from"?"find_all_causal_paths_from_wcomponent_ids":"find_all_causal_paths_to_wcomponent_ids";t=update_substate(t,"meta_wcomponents",te,ee.ids)}return t};function replace_element(t,ee,te){const ne=t.findIndex(te);return ne<0?(console.error(`Can not find element by predicate: ${te.toString()}`),t):[...t.slice(0,ne),ee,...t.slice(ne+1)]}function upsert_entry(t,ee,te,ne=""){let oe=-1;const ie=t.filter((re,_e)=>{const ae=te(re);return ae&&(oe=_e),ae});if(ie.length>1)throw new Error(`During upsert_entry multiple (${ie.length}) "${ne}" items matching predicate: "${te.toString()}"`);let se=t;return ie.length===1?ie[0]!==ee&&(se=[...t.slice(0,oe),ee,...t.slice(oe+1)]):se=[...t,ee],se}function remove_element(t,ee){const te=t.filter(ne=>!ee(ne));return te.length===t.length?t:te}function toggle_item_in_list(t,ee,te){const ne=te||(ie=>ie===ee),oe=t.filter(ie=>!ne(ie));return oe.length===t.length&&oe.push(ee),oe}function index_is_in_bounds(t,ee){return t.length>0&&ee>=0&&ee<t.length}function swap_elements(t,ee,te){if(!index_is_in_bounds(t,ee)||!index_is_in_bounds(t,te))return t;const ne=Math.min(ee,te),oe=Math.max(ee,te),ie=[...t],se=ie[ne];return ie[ne]=ie[oe],ie[oe]=se,ie}function insert_element_at_index(t,ee,te){return te<=0?t=[ee,...t]:te>=t.length?t=[...t,ee]:t=[...t.slice(0,te),ee,...t.slice(te)],t}const selecting_reducer=(t,ee)=>{const te=t.meta_wcomponents.selected_wcomponent_ids_list;if(is_clicked_wcomponent(ee)){const{id:ne}=ee;let oe=[...t.meta_wcomponents.selected_wcomponent_ids_list];const{shift_or_control_down:ie}=t.global_keys.derived;ie?oe=toggle_item_in_list(oe,ne):oe=[ne];const se={...t.meta_wcomponents,selected_wcomponent_ids_list:oe,last_clicked_wcomponent_id:ne};t={...t,meta_wcomponents:se}}if(is_clear_selected_wcomponents(ee)&&(t=handle_clear_selected_wcomponents(t)),is_set_selected_wcomponents(ee)&&(t=handle_set_selected_wcomponents(t,ee)),is_pointerdown_on_component(ee)){const ne={wcomponent_id:ee.wcomponent_id,terminal_type:void 0};t=update_substate(t,"meta_wcomponents","last_pointer_down_connection_terminal",ne)}if(is_pointerdown_on_connection_terminal(ee)){const{wcomponent_id:ne,terminal_type:oe}=ee;t=update_substate(t,"meta_wcomponents","last_pointer_down_connection_terminal",{wcomponent_id:ne,terminal_type:oe})}return is_clear_pointerupdown_on_connection_terminal(ee)&&(t=update_substate(t,"meta_wcomponents","last_pointer_down_connection_terminal",void 0)),is_set_wcomponent_ids_to_move(ee)&&(t=update_substate(t,"meta_wcomponents","wcomponent_ids_to_move_set",ee.wcomponent_ids_to_move)),te!==t.meta_wcomponents.selected_wcomponent_ids_list&&(t=update_derived_selected_wcomponent_ids(t)),t};function handle_clear_selected_wcomponents(t){return t=update_substate(t,"meta_wcomponents","selected_wcomponent_ids_list",[]),t}function handle_set_selected_wcomponents(t,ee){return t=update_substate(t,"meta_wcomponents","selected_wcomponent_ids_list",[...ee.ids]),t}function update_derived_selected_wcomponent_ids(t){const ee=new Set(t.meta_wcomponents.selected_wcomponent_ids_list),te={};t.meta_wcomponents.selected_wcomponent_ids_list.forEach((oe,ie)=>te[oe]=ie);const ne={...t.meta_wcomponents,selected_wcomponent_ids_set:ee,selected_wcomponent_ids_to_ordinal_position_map:te};return{...t,meta_wcomponents:ne}}const meta_wcomponents_reducer=(t,ee)=>(t=find_all_causal_paths_reducer(t,ee),t=selecting_reducer(t,ee),is_set_frame_is_resizing(ee)&&(t=update_substate(t,"meta_wcomponents","frame_is_resizing",ee.frame_is_resizing)),t);function derived_meta_wcomponents_state_reducer(t,ee){return ee=handle_route_changed(t,ee),ee}function handle_route_changed(t,ee){const te=t.sync.ready_for_reading!==ee.sync.ready_for_reading;if((t.routing.item_id!==ee.routing.item_id||te)&&ee.routing.item_id&&is_uuid_v4(ee.routing.item_id)){const ne=[ee.routing.item_id];ee=update_substate(ee,"meta_wcomponents","selected_wcomponent_ids_list",ne),ee=update_derived_selected_wcomponent_ids(ee)}return ee}function prepare_new_VAP(){return{id:get_new_VAP_id(),explanation:"",probability:0,conviction:1,value:"",description:""}}function set_VAP_probabilities(t,ee){const te=t.length>1;let ne=0;return t=t.map(oe=>{const ie=te?oe.relative_probability===void 0?oe.probability:oe.relative_probability:void 0;return ie!==void 0&&(ne+=ie),{...oe,relative_probability:ie}}),ee!==VAPsType.boolean&&(ne=ne||1,t=t.map(oe=>{const se=(oe.relative_probability===void 0?1:oe.relative_probability)/ne;return{...oe,probability:se}})),t}function tidy_wcomponent(t,ee){if(wcomponent_has_validity_predictions(t)){const te=sort_list(t.validity,get_created_at_ms,SortDirection.ascending);t.validity=te}if(wcomponent_has_VAP_sets(t)){const te=sort_list(t.values_and_prediction_sets||[],get_created_at_ms,SortDirection.ascending),ne=get_wcomponent_VAPs_represent(t,ee),oe=te.map(ie=>({...ie,entries:set_VAP_probabilities(ie.entries,ne)}));t.values_and_prediction_sets=oe}return wcomponent_is_allowed_to_have_state_VAP_sets(t)&&(t._derived__using_value_from_wcomponent_id&&console.error(`WComponent "${t.id}" had _derived__using_value_from_wcomponent_id set ("${t._derived__using_value_from_wcomponent_id}") but this should never happen and only be used on wcomponents from state.derived.composed_wcomponents_by_id`),delete t._derived__using_value_from_wcomponent_id),t}function update_specialised_object_ids_pending_save$1(t,ee,te,ne){let{wcomponent_ids:oe,knowledge_view_ids:ie}=t.sync.specialised_object_ids_pending_save;const se=ee==="wcomponent";let re=se?oe:ie;return re=ne?ensure_item_in_set(re,te):ensure_item_not_in_set(re,te),t=update_subsubstate(t,"sync","specialised_object_ids_pending_save",se?"wcomponent_ids":"knowledge_view_ids",re),t}function update_wcomponent_last_source_of_truth(t,ee){return ee=tidy_wcomponent(ee,t.specialised_objects.wcomponents_by_id),ee=clean_base_object_of_sync_meta_fields(ee),t=update_subsubsubstate(t,"sync","last_source_of_truth_specialised_objects_by_id","wcomponents",ee.id,ee),t}function update_knowledge_view_last_source_of_truth(t,ee){return ee=clean_base_object_of_sync_meta_fields(ee),t=update_subsubsubstate(t,"sync","last_source_of_truth_specialised_objects_by_id","knowledge_views",ee.id,ee),t}function update_modified_by(t,ee){return update_modified_or_deleted_by(t,ee,!1)}function update_modified_or_deleted_by(t,ee,te){return t={...t,needs_save:!0,modified_by_username:selector_user_name(ee)},te&&(t.deleted_at=new Date),t}function handle_upsert_knowledge_view(t,ee,te){const ne={...t.specialised_objects.knowledge_views_by_id};return ee=te?ee:update_modified_by(ee,t),ne[ee.id]=ee,t=update_substate(t,"specialised_objects","knowledge_views_by_id",ne),t=update_specialised_object_ids_pending_save$1(t,"knowledge_view",ee.id,!!ee.needs_save),t}const bulk_editing_knowledge_view_entries_reducer=(t,ee)=>(is_bulk_edit_knowledge_view_entries(ee)&&(t=handle_bulk_edit_knowledge_view_entries(t,ee)),is_snap_to_grid_knowledge_view_entries(ee)&&(t=handle_snap_to_grid_knowledge_view_entries(t,ee)),is_change_current_knowledge_view_entries_order(ee)&&(t=handle_change_current_knowledge_view_entries_order(t,ee)),is_bulk_add_to_knowledge_view(ee)&&(t=handle_bulk_add_to_knowledge_view(t,ee)),is_bulk_remove_from_knowledge_view(ee)&&(t=handle_bulk_remove_from_knowledge_view(t,ee)),t);function handle_bulk_add_to_knowledge_view(t,ee){const{knowledge_view_id:te,wcomponent_ids:ne,override_entry:oe,default_entry:ie}=ee,se=t.specialised_objects.knowledge_views_by_id[te],re=get_current_composed_knowledge_view_from_state(t);if(!se)console.error(`Could not find knowledge view for bulk_add_to_knowledge_view by id: "${te}"`);else if(!re)console.error("There should always be a current knowledge view if bulk editing position of world components");else{let _e={};ne.forEach(ce=>{let le={...ie,...re.composed_wc_id_map[ce],...oe,blocked:void 0,passthrough:void 0};if(le.left===void 0||le.top===void 0){console.error(`we should always have an entry but no bulk_entry provided and wcomponent "${ce}" lacking entry in composed_kv composed_wc_id_map for "${te}"`);return}_e[ce]=le}),_e={...se.wc_id_map,..._e};const ae={...se,wc_id_map:_e};t=handle_upsert_knowledge_view(t,ae)}return t}function handle_bulk_remove_from_knowledge_view(t,ee){const{wcomponent_ids:te,remove_type:ne}=ee,oe=ne==="block",ie=get_current_knowledge_view_from_state(t),se=get_current_composed_knowledge_view_from_state(t);if(!ie||!se)console.error("There should always be a current and current composed knowledge view if bulk editing (removing) positions of world components");else{const re={...ie.wc_id_map};te.forEach(ae=>{const ce=oe?se.composed_wc_id_map[ae]:ie.wc_id_map[ae];if(!ce)return;const le=oe?{...ce,blocked:!0,passthrough:void 0}:{...ce,blocked:void 0,passthrough:!0};re[ae]=le});const _e={...ie,wc_id_map:re};t=handle_upsert_knowledge_view(t,_e)}return t}function handle_snap_to_grid_knowledge_view_entries(t,ee){const{wcomponent_ids:te,knowledge_view_id:ne}=ee,oe=t.specialised_objects.knowledge_views_by_id[ne];if(oe){const ie={...oe.wc_id_map};te.forEach(re=>{const _e=oe.wc_id_map[re];if(!_e)return;const ae=round_canvas_point(_e,"large");ie[re]=ae});const se={...oe,wc_id_map:ie};t=handle_upsert_knowledge_view(t,se)}return t}function handle_change_current_knowledge_view_entries_order(t,ee){const{wcomponent_ids:te,order:ne}=ee,oe=get_current_knowledge_view_from_state(t),ie=get_current_composed_knowledge_view_from_state(t);if(!oe||!ie)return console.error("There should always be a current knowledge view and current composed knowledge view if bulk editing (moving to top) world components"),t;let se={};ne==="front"?(se={...oe.wc_id_map},te.forEach(_e=>{const ae=ie.composed_wc_id_map[_e];ae&&(delete se[_e],se[_e]=ae)})):ne==="back"&&(te.forEach(_e=>{const ae=ie.composed_wc_id_map[_e];ae&&(se[_e]=ae)}),se={...se,...oe.wc_id_map});const re={...oe,wc_id_map:se};return t=handle_upsert_knowledge_view(t,re),t}function handle_bulk_edit_knowledge_view_entries(t,ee){const{wcomponent_ids:te,change_left:ne,change_top:oe}=ee,ie=get_current_knowledge_view_from_state(t),se=get_current_composed_knowledge_view_from_state(t);if(ie&&se){const re={...ie.wc_id_map};te.forEach(ae=>{const ce=se.composed_wc_id_map[ae];if(!ce||ce.blocked||ce.passthrough)return;const le={...ce};le.left+=ne,le.top+=oe,re[ae]=le});const _e={...ie,wc_id_map:re};t=handle_upsert_knowledge_view(t,_e)}else console.error("There should always be a current knowledge view if bulk editing position of world components");return t}const knowledge_views_reducer=(t,ee)=>{if(is_upsert_knowledge_view(ee)&&(t=handle_upsert_knowledge_view(t,ee.knowledge_view,ee.is_source_of_truth)),is_upsert_wcomponent(ee)){const{wcomponent:te,add_to_knowledge_view:ne,add_to_top:oe}=ee;if(ne){const se={...ne.position};t=handle_upsert_knowledge_view_entry(t,ne.id,te.id,se,oe)}const ie=t.specialised_objects.knowledge_views_by_id[te.id];if(ie&&ie.title!==te.title){const se={...ie,title:te.title};t=handle_upsert_knowledge_view(t,se,ee.is_source_of_truth)}}if(is_upsert_knowledge_view_entry(ee)&&(t=handle_upsert_knowledge_view_entry(t,ee.knowledge_view_id,ee.wcomponent_id,ee.entry)),is_update_specialised_object_sync_info(ee)&&ee.object_type==="knowledge_view"){let te=get_knowledge_view_from_state(t,ee.id);te?(te={...te,saving:ee.saving},t=update_subsubstate(t,"specialised_objects","knowledge_views_by_id",ee.id,te)):console.error(`Could not find knowledge_view by id: "${ee.id}" whilst handling is_update_specialised_object_sync_info`)}return t=bulk_editing_knowledge_view_entries_reducer(t,ee),t};function handle_upsert_knowledge_view_entry(t,ee,te,ne,oe){const ie=get_knowledge_view_from_state(t,ee);return ie?add_wcomponent_entry_to_knowledge_view(t,ie,te,ne,oe):(console.error(`Could not find knowledge_view for id: "${ee}"`),t)}function add_wcomponent_entry_to_knowledge_view(t,ee,te,ne,oe=!0){let ie={...ee.wc_id_map};const se=ie[te];se&&(se.blocked&&!ne.blocked||se.passthrough&&!ne.passthrough)&&delete ie[te],oe?ie[te]=ne:ie={[te]:ne,...ie};const re={...ee,wc_id_map:ie};return handle_upsert_knowledge_view(t,re)}const _wcomponent_types={event:!0,statev2:!0,state_value:!0,sub_state:!0,multidimensional_state:!0,process:!0,action:!0,actor:!0,causal_link:!0,relation_link:!0,judgement:!0,objective:!0,counterfactualv2:!0,goal:!0,prioritisation:!0},wcomponent_types=Object.keys(_wcomponent_types).sort().filter(t=>t!=="multidimensional_state");function get_items_by_id(t,ee){const te={};return t.forEach(ne=>{if(te[ne.id])throw new Error(`Duplicate "${ee}".id: "${te[ne.id]}".  "${te[ne.id].title}" and "${ne.title}"`);te[ne.id]=ne}),te}const syncing_reducer=(t,ee)=>{if(is_replace_all_specialised_objects(ee)){const{wcomponents:te,knowledge_views:ne}=ee.specialised_objects,oe=get_items_by_id(te,"wcomponents"),ie=get_items_by_id(ne,"knowledge_views");t={...t,specialised_objects:{wcomponents_by_id:oe,knowledge_views_by_id:ie}}}return is_clear_from_mem_all_specialised_objects(ee)&&(t={...t,specialised_objects:{wcomponents_by_id:{},knowledge_views_by_id:{}}}),t};function handle_upsert_wcomponent(t,ee,te,ne=!1){const oe={...t.specialised_objects.wcomponents_by_id};return ee=te?ee:update_modified_or_deleted_by(ee,t,ne),oe[ee.id]=ee,t=update_substate(t,"specialised_objects","wcomponents_by_id",oe),t=update_specialised_object_ids_pending_save$1(t,"wcomponent",ee.id,!!ee.needs_save),t}function handle_add_wcomponents_to_store(t,ee){const te={...t.specialised_objects.wcomponents_by_id};return ee.forEach(ne=>te[ne.id]=ne),t=update_substate(t,"specialised_objects","wcomponents_by_id",te),t}const bulk_editing_wcomponents_reducer=(t,ee)=>(is_bulk_edit_wcomponents(ee)&&(t=handle_bulk_edit_wcomponents(t,ee)),t);function handle_bulk_edit_wcomponents(t,ee){const{wcomponent_ids:te,change:ne,remove_label_ids:oe,add_label_ids:ie}=ee,se=get_wcomponents_from_state(t,te).filter(is_defined);return se.length&&se.forEach(re=>{const _e={...re,...ne},ae=modify_label_ids(_e,oe,ie),ce=tidy_wcomponent(ae,t.specialised_objects.wcomponents_by_id);t=handle_upsert_wcomponent(t,ce,!1)}),t}function modify_label_ids(t,ee,te){let{label_ids:ne}=t;if(ne&&ee&&(ne=ne.filter(oe=>!ee.has(oe))),te){const oe=ne||[],ie=new Set(oe);Array.from(te).forEach(se=>{ie.has(se)||oe.push(se)}),ne=oe}return{...t,label_ids:ne}}const wcomponents_reducer=(t,ee)=>{if(is_upsert_wcomponent(ee)){const te=tidy_wcomponent(ee.wcomponent,t.specialised_objects.wcomponents_by_id);t=handle_upsert_wcomponent(t,te,ee.is_source_of_truth)}if(is_delete_wcomponent(ee)){const{wcomponent_id:te}=ee;let{wcomponents_by_id:ne}=t.specialised_objects;const oe=ne[te];oe&&(t=handle_upsert_wcomponent(t,oe,!1,!0))}if(is_add_wcomponents_to_store(ee)){const te=ee.wcomponents.map(ne=>tidy_wcomponent(ne,t.specialised_objects.wcomponents_by_id));t=handle_add_wcomponents_to_store(t,te)}if(is_update_specialised_object_sync_info(ee)&&ee.object_type==="wcomponent"){let te=get_wcomponent_from_state(t,ee.id);te?(te={...te,saving:ee.saving},t=update_subsubstate(t,"specialised_objects","wcomponents_by_id",ee.id,te)):console.error(`Could not find wcomponent by id: "${ee.id}" whilst handling is_update_specialised_object_sync_info`)}return t=bulk_editing_wcomponents_reducer(t,ee),t},specialised_objects_reducer=(t,ee)=>(t=highlighting_reducer(t,ee),t=syncing_reducer(t,ee),t=wcomponents_reducer(t,ee),t=knowledge_views_reducer(t,ee),t),sync_reducer=(t,ee)=>{if(is_update_sync_status(ee)){const{status:te,loading_base_id:ne,error_message:oe="",attempt:ie}=ee,se={...t.sync[ee.data_type],status:te,error_message:oe,retry_attempt:ie};ne!==void 0&&(se.loading_base_id=ne),t=update_substate(t,"sync",ee.data_type,se),t=update_ready_for_fields(t)}if(is_debug_refresh_all_specialised_object_ids_pending_save(ee)){const te=Object.values(t.specialised_objects.wcomponents_by_id),ne=Object.values(t.specialised_objects.knowledge_views_by_id),oe=prepare_specialised_object_ids_pending_save({wcomponents:te,knowledge_views:ne});t=update_specialised_object_ids_pending_save(t,oe)}if(is_clear_from_mem_all_specialised_objects(ee)&&(t=update_specialised_object_ids_pending_save(t,{knowledge_view_ids:new Set,wcomponent_ids:new Set}),t=update_substate(t,"sync","last_source_of_truth_specialised_objects_by_id",{wcomponents:{},knowledge_views:{}}),t=update_substate(t,"sync","specialised_objects",{status:void 0,loading_base_id:void 0,error_message:"",retry_attempt:0}),t=update_ready_for_fields(t)),is_replace_all_specialised_objects(ee)){const{wcomponents:te,knowledge_views:ne}=ee.specialised_objects,oe=prepare_specialised_object_ids_pending_save({wcomponents:te,knowledge_views:ne});t=update_specialised_object_ids_pending_save(t,oe);const ie={wcomponents:get_items_by_id(te,"wcomponents"),knowledge_views:get_items_by_id(ne,"knowledge_views")};t=update_substate(t,"sync","last_source_of_truth_specialised_objects_by_id",ie)}if(is_upsert_wcomponent(ee)&&ee.is_source_of_truth&&(t=update_wcomponent_last_source_of_truth(t,ee.wcomponent)),is_upsert_knowledge_view(ee)&&ee.is_source_of_truth&&(t=update_knowledge_view_last_source_of_truth(t,ee.knowledge_view)),is_update_network_status(ee)&&(t=update_substate(t,"sync","network_functional",ee.network_functional),t=update_substate(t,"sync","network_function_last_checked",ee.last_checked)),is_request_searching_for_wcomponents_by_id_in_any_base(ee)){const te=new Set(t.sync.wcomponent_ids_to_search_for_in_any_base),{wcomponent_ids_searching_for_in_any_base:ne,wcomponent_ids_searched_for_in_any_base:oe}=t.sync;ee.ids.filter(ie=>!te.has(ie)&&!ne.has(ie)&&!oe.has(ie)&&!t.specialised_objects.wcomponents_by_id[ie]).forEach(ie=>te.add(ie)),t=update_substate(t,"sync","wcomponent_ids_to_search_for_in_any_base",te)}if(is_searching_for_wcomponents_by_id_in_any_base(ee)){const te=set_union(t.sync.wcomponent_ids_to_search_for_in_any_base,t.sync.wcomponent_ids_searching_for_in_any_base);t=update_substate(t,"sync","wcomponent_ids_to_search_for_in_any_base",new Set),t=update_substate(t,"sync","wcomponent_ids_searching_for_in_any_base",te)}if(is_searched_for_wcomponents_by_id_in_any_base(ee)){const te=new Set(t.sync.wcomponent_ids_searching_for_in_any_base),ne=new Set(t.sync.wcomponent_ids_searched_for_in_any_base);ee.ids.forEach(oe=>{te.delete(oe),ne.add(oe)}),t=update_substate(t,"sync","wcomponent_ids_searching_for_in_any_base",te),t=update_substate(t,"sync","wcomponent_ids_searched_for_in_any_base",ne)}return t};function update_ready_for_fields(t){const{bases:ee,specialised_objects:te}=t.sync,ne=get_ready_for_fields_for_data_type(te);return t=update_substate(t,"sync","ready_for_reading",ne.ready_for_reading),t=update_substate(t,"sync","ready_for_writing",ne.ready_for_writing),t}function get_ready_for_fields_for_data_type(t){const{status:ee}=t;return{ready_for_reading:ee!==void 0&&ee!=="LOADING",ready_for_writing:ee==="SAVED"||ee==="LOADED"||ee==="FAILED"}}function prepare_specialised_object_ids_pending_save(t){const ee=new Set(t.wcomponents.filter(ne=>ne.needs_save).map(({id:ne})=>ne)),te=new Set(t.knowledge_views.filter(ne=>ne.needs_save).map(({id:ne})=>ne));return{wcomponent_ids:ee,knowledge_view_ids:te}}function update_specialised_object_ids_pending_save(t,ee){return update_substate(t,"sync","specialised_object_ids_pending_save",ee)}const user_info_reducer=(t,ee)=>{if(is_set_user(ee)){t=update_substate(t,"user_info","user",ee.user);const te=t.user_info.has_signed_in_at_least_once||!!ee.user;t=update_substate(t,"user_info","has_signed_in_at_least_once",te),pub_sub.user.pub("changed_user",!0)}if(is_set_users(ee)){let te;ee.users&&(te={},ee.users.forEach(ne=>te[ne.id]=ne)),t=update_substate(t,"user_info","users_by_id",te)}if(is_set_need_to_handle_password_recovery(ee)&&(t=update_substate(t,"user_info","need_to_handle_password_recovery",ee.need_to_handle_password_recovery)),is_update_bases(ee)){const{bases:te}=ee,ne=build_bases_by_id_map(te);t=update_substate(t,"user_info","bases_by_id",ne);let oe=!1;if(t.user_info.user){const ie=t.user_info.chosen_base_id;t=ensure_valid_chosen_base_id(t),oe=ie!==t.user_info.chosen_base_id}pub_sub.user.pub("changed_bases",!0),oe&&pub_sub.user.pub("changed_chosen_base_id",!0)}if(is_update_chosen_base_id(ee)){const te=t.user_info.chosen_base_id;t=update_substate(t,"user_info","chosen_base_id",ee.base_id),te!==t.user_info.chosen_base_id&&pub_sub.user.pub("changed_chosen_base_id",!0)}return t};function build_bases_by_id_map(t){let ee;return t&&(ee={},t.forEach(te=>ee[te.id]=te)),ee}function ensure_valid_chosen_base_id(t){var ne;const{bases_by_id:ee,chosen_base_id:te}=t.user_info;if(ee&&(te===void 0||!ee[te])){const oe=selector_editable_bases(t),ie=oe&&((ne=oe[0])==null?void 0:ne.id);t=update_substate(t,"user_info","chosen_base_id",ie)}return t}const root_reducer$1=(t,ee)=>{const te=t;return t=display_reducer(t,ee),t=sync_reducer(t,ee),t=routing_reducer(t,ee),t=global_keys_reducer(t,ee),t=display_at_created_datetime_reducer(t,ee),t=display_at_sim_datetime_reducer(t,ee),t=specialised_objects_reducer(t,ee),t=meta_wcomponents_reducer(t,ee),t=controls_reducer(t,ee),t=creation_context_reducer(t,ee),t=filter_context_reducer(t,ee),t=user_info_reducer(t,ee),t=view_priorities_reducer(t,ee),t=search_reducer(t,ee),t={...t,last_action:ee},t=derived_state_reducer(te,t),t=derived_meta_wcomponents_state_reducer(te,t),window.debug_state=t,t},factory_location_hash=t=>{let ee;const te=factory_throttled_update_location_hash();record_location_hash_change(t);function ne(){const oe=t.getState();if(oe.routing===ee)return;const ie=calc_changed_only_xy(ee,oe.routing);ee=oe.routing,te(ie,oe.routing)}return ne(),ne};let hash_pending_update=!1;function factory_throttled_update_location_hash(){const t=throttle(te=>{const ne=routing_state_to_string(te);window.DEBUG_ROUTING&&console.log("DELAYED changing route from ",window.location.hash.toString(),"   to:   ",ne),window.location.hash=ne,hash_pending_update=!1},1e3),ee=throttle(te=>{const ne=routing_state_to_string(te),oe=url_is_incomplete(window.location.toString());window.DEBUG_ROUTING&&console.log(`Debounced changing route from "${oe?"incomplete":"complete"}"`,window.location.hash.toString(),"   to:   ",ne),oe?history.replaceState(null,"",ne):window.location.hash=ne,hash_pending_update=!1},0);return(te,ne)=>{hash_pending_update=!0,te?t.throttled(ne):(t.cancel(),ee.cancel(),ee.throttled(ne))}}function calc_changed_only_xy(t,ee){return!t||!t.args?!1:t.args.x!==ee.args.x||t.args.y!==ee.args.y}function record_location_hash_change(t){window.onhashchange=ee=>{var oe,ie,se,re;if(hash_pending_update)return;const te=ee,ne=t.getState();if(ne.sync.ready_for_reading){const _e="#"+(te.newURL.split("#")[1]||""),ae=routing_state_to_string(ne.routing);if(ae===_e){window.DEBUG_ROUTING&&console.log("on hash change but no difference to current hash route_from_state",ae);return}window.DEBUG_ROUTING&&console.log("on hash change difference.  new url is: ",_e,"   state is:   ",ae),t.dispatch(ACTIONS.meta_wcomponents.clear_selected_wcomponents({}));const le=merge_route_params_prioritising_url_over_state(te.newURL,ne.routing);((oe=le==null?void 0:le.args)==null?void 0:oe.created_at_ms)!==void 0&&((ie=le==null?void 0:le.args)==null||delete ie.created_at_datetime),((se=le==null?void 0:le.args)==null?void 0:se.sim_ms)!==void 0&&((re=le==null?void 0:le.args)==null||delete re.sim_datetime),t.dispatch(ACTIONS.routing.change_route(le))}}}function sync_storage_location_subscriber(t){const ee=t.getState();let{chosen_base_id:te}=ee.user_info;t.subscribe(()=>{const ne=t.getState(),{chosen_base_id:oe}=ne.user_info,{storage_location:ie}=ne.routing.args;ie===void 0?ie!==oe&&(console.log(`Change storage_location in route to "${oe}" as nothing was set`),t.dispatch(ACTIONS.routing.change_route({args:{storage_location:oe}}))):ie!==oe&&(te!==oe?t.dispatch(ACTIONS.routing.change_route({args:{storage_location:oe}})):t.dispatch(ACTIONS.user_info.update_chosen_base_id({base_id:ie}))),te=oe})}const routing_subscribers={sync_storage_location_subscriber};function get_default_parent_goal_or_action_ids(t,ee,te){let ne=t?ee[t]:void 0;for(;ne;){const oe=te[ne.id];if(wcomponent_is_action(oe)||wcomponent_is_goal(oe))return[oe.id];ne=ne.parent_knowledge_view_id?ee[ne.parent_knowledge_view_id]:void 0}return[]}function get_max_value_possibilities_order(t){let ee=-1;if(t){let te;Array.isArray(t)?te=t:te=Object.values(t),te.forEach(({order:ne=-1})=>ee=Math.max(ee,ne))}return ee}function ensure_possible_values_have_ids(t){let ee=get_max_value_possibilities_order(t);return t.map(ne=>{const oe=ne.id||v4(),ie=ne.order??++ee;return{description:"",...ne,id:oe,order:ie}})}const action_statuses=["potential","in progress","paused","completed","failed","rejected"];new Set(action_statuses);function default_possible_values(t,ee){return t===VAPsType.boolean?ee=[{value:"True",id:VALUE_POSSIBILITY_IDS.boolean_true,order:0},{value:"False",id:VALUE_POSSIBILITY_IDS.boolean_false,order:1}]:t===VAPsType.action?ee=ORDERED_ACTION_VALUE_POSSIBILITY_ID.map((te,ne)=>({id:te,value:VALUE_POSSIBILITY_IDS_to_text[te]||"?",order:ne})):ee.length===0&&(t===VAPsType.number?["1"]:[""]).forEach((te,ne)=>{ee.push({value:te,order:ne})}),ee}const test_default_possible_values=describe("default_possible_values",()=>{const t=[{id:"730a7cb4-7523-45f7-bfde-a00d0acb9f65",value:"",description:"",order:0},{id:"724c4da6-f4ee-4680-a493-556ee241f29d",value:"",description:"",order:1}];let ee=default_possible_values(VAPsType.boolean,t);test.skip(ee.length,1,"If boolean and given more than one value possibility, it should be reduced back to 1"),ee=default_possible_values(VAPsType.boolean,[]),test(ee.length,2,"If boolean and no value possibilities, it should create 2"),ee=default_possible_values(VAPsType.action,[]),test(ee.length,action_statuses.length,"If action and no value possibilities, it should create the set"),ee=default_possible_values(VAPsType.other,[]),test(ee.length,1,"If other and no value possibilities, it should create an empty value"),ee=default_possible_values(VAPsType.number,[]),test(ee.length,1,"If other and no value possibilities, it should create an empty value")},!1);function get_possibilities_from_VAP_sets(t,ee,te){const ne=get_simple_possibilities_from_VAP_sets(t,ee,te);return ensure_possible_values_have_ids(ne)}function get_simple_possibilities_from_VAP_sets(t,ee,te){const ne=Object.values(ee||{}).map(ie=>({...ie,id:void 0,value_id:ie.id}));te.forEach(ie=>{ie.entries.forEach(({value_id:se,value:re})=>{ne.push({value_id:se,value:re})})});const oe=get_simple_possibilities_from_values(ne,ee);return default_possible_values(t,oe)}function get_simple_possibilities_from_values(t,ee={}){let te=[];const ne=new Set;let oe=0;return t.forEach(({value_id:ie})=>{const se=ee[ie||""];!se||ne.has(se.value)||(te.push(se),oe=Math.max(oe,se.order),ne.add(se.value))}),t.forEach(({value:ie,value_id:se})=>{ne.has(ie)||(te.push({value:ie,id:se,order:++oe}),ne.add(ie))}),t.length===0&&(te=Object.values(ee)),te.sort((ie,se)=>(ie.order??0)<(se.order??0)?-1:1)}const test_get_possibilities_from_VAP_sets=describe("get_possibilities_from_VAP_sets",()=>{var ie,se,re,_e,ae,ce,le;const t=VAPsType.number,ee="val_prob_id_123",te=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...prepare_new_VAP(),value_id:ee,value:"abc",description:""},{...prepare_new_VAP(),value_id:void 0,value:"duplicated",description:""},{...prepare_new_VAP(),value_id:void 0,value:"duplicated",description:""}]}];let ne=get_possibilities_from_VAP_sets(t,void 0,te);test(ne.length,2,"Should get possibilities for all unique values and remove duplicates"),test((ie=ne[0])==null?void 0:ie.value,"abc"),test.skip(((se=ne[0])==null?void 0:se.id)!==ee,!0,"Should set a new ID"),test((re=ne[1])==null?void 0:re.value,"duplicated"),test(((_e=ne[1])==null?void 0:_e.id)!==void 0,!0,"Should set a new ID if original is undefined");let oe={[ee]:{id:ee,value:"new abc",description:"",order:1}};ne=get_possibilities_from_VAP_sets(t,oe,te),test((ae=ne[0])==null?void 0:ae.value,"new abc"),test((ce=ne[0])==null?void 0:ce.id,ee,"Should reuse existing ID"),test((le=ne[1])==null?void 0:le.order,2,"Should increment off maximum order")},!1),ONE_MINUTE=60*1e3;function create_wcomponent(t){const ee=t.store||get_store(),te=ee.getState(),ne=te.creation_context;let oe=prepare_new_wcomponent_object(t.wcomponent,ne);oe=set_judgement_or_objective_target(oe,te),oe=set_parent_goal_or_action_ids(oe,te),oe=set_state_value_fields(oe,te);const ie=get_knowledge_view_entry(t.add_to_knowledge_view,oe,te),se=!wcomponent_is_judgement_or_objective(oe);let re=get_created_at_ms(oe);re=Math.max(re+ONE_MINUTE,te.routing.args.created_at_ms);const _e=get_latest_sim_ms_for_routing(oe,te);return ee.dispatch(ACTIONS.specialised_object.upsert_wcomponent({wcomponent:oe,add_to_knowledge_view:ie,add_to_top:se})),ee.dispatch(ACTIONS.meta_wcomponents.clear_selected_wcomponents({})),ee.dispatch(ACTIONS.routing.change_route({route:"wcomponents",item_id:oe.id,args:{created_at_ms:re,sim_ms:_e}})),!0}function set_judgement_or_objective_target(t,ee){if(wcomponent_is_judgement_or_objective(t)){const te=ee.meta_wcomponents.selected_wcomponent_ids_list,ne=te[0];if(te.length===1&&ne){const oe=get_wcomponent_from_state(ee,ne);oe&&(t={...t,judgement_target_wcomponent_id:oe.id})}}return t}function set_parent_goal_or_action_ids(t,ee){if(!wcomponent_is_action(t)||t.parent_goal_or_action_ids)return t;const te=get_current_composed_knowledge_view_from_state(ee),{wcomponents_by_id:ne,knowledge_views_by_id:oe}=ee.specialised_objects,ie=te==null?void 0:te.id,se=get_default_parent_goal_or_action_ids(ie,oe,ne);return{...t,parent_goal_or_action_ids:se}}function get_knowledge_view_entry(t,ee,te){const ne=get_current_composed_knowledge_view_from_state(te);if(!t&&ne){let oe;wcomponent_is_judgement_or_objective(ee)?oe=ee.judgement_target_wcomponent_id:wcomponent_is_state_value(ee)&&(oe=ee.attribute_wcomponent_id);let ie=ne.composed_wc_id_map[oe||""];ie||(ie=get_middle_of_screen(te)),t={id:ne.id,position:ie}}return t}function set_state_value_fields(t,ee){if(wcomponent_is_state_value(t)){const{wcomponents_by_id:te}=ee.specialised_objects;let{attribute_wcomponent_id:ne,value_possibilities:oe}=t;const ie=ee.meta_wcomponents.selected_wcomponent_ids_list,se=ie[0];if(ie.length===1&&se){const re=get_wcomponent_from_state(ee,se);if(re&&wcomponent_is_statev2(re)){const _e=re;if(ne=re.id,!oe||!Object.keys(oe)){const ae=get_wcomponent_VAPs_represent(_e,te),ce=get_possibilities_from_VAP_sets(ae,_e.value_possibilities,_e.values_and_prediction_sets||[]);oe=get_items_by_id(ce,"attribute's possible_values")}}}t={...t,attribute_wcomponent_id:ne,value_possibilities:oe}}return t}function create_links_on_connection_terminal_mouse_events__subscriber(t){return()=>{const ee=t.getState(),{last_pointer_down_connection_terminal:te}=ee.meta_wcomponents;if(!te)return;const ne=selector_chosen_base_id(ee);if(ne===void 0)return;if(ee.global_keys.last_key==="Escape"||ee.display_options.consumption_formatting){t.dispatch(ACTIONS.meta_wcomponents.clear_pointerupdown_on_connection_terminal({}));return}if(!ee.last_action)return;let oe=!1;const{terminal_type:ie,wcomponent_id:se}=te,re=(ie==null?void 0:ie.attribute)||"state";let _e=ie==null?void 0:ie.direction,ae,ce="state",le=((ie==null?void 0:ie.direction)||"from")==="from"?"to":"from";if(is_pointerup_on_component(ee.last_action))ae=ee.last_action.wcomponent_id,oe=se===ae&&(ie==null?void 0:ie.direction)===void 0;else if(is_pointerup_on_connection_terminal(ee.last_action))ae=ee.last_action.wcomponent_id,ce=ee.last_action.terminal_type.attribute,le=ee.last_action.terminal_type.direction;else return;if(oe=oe||se===ae&&_e===le,t.dispatch(ACTIONS.meta_wcomponents.clear_pointerupdown_on_connection_terminal({})),oe)return;_e=le==="from"?"to":"from";const ue=_e==="from";create_wcomponent({wcomponent:{base_id:ne,type:re==="meta"||ce==="meta"?"relation_link":"causal_link",from_id:ue?se:ae,to_id:ue?ae:se,from_type:ue?re:ce,to_type:ue?ce:re}})}}function clear_last_pointer_down_connection_terminal(t){function ee(){const te=t.getState(),{last_pointer_down_connection_terminal:ne}=te.meta_wcomponents;ne&&t.dispatch(ACTIONS.meta_wcomponents.clear_pointerupdown_on_connection_terminal({}))}pub_sub.canvas.sub("canvas_right_click",()=>{ee()}),pub_sub.canvas.sub("canvas_pointer_down",()=>{ee()}),pub_sub.canvas.sub("canvas_pointer_up",()=>{ee()})}function create_wcomponent_on_double_tap(t){pub_sub.canvas.sub("canvas_double_tap",ee=>{const te=t.getState(),ne=get_current_knowledge_view_from_state(te);if(!ne){console.error("No current_knowledge_view despite canvas double_tap");return}const oe=selector_chosen_base_id(te);if(oe===void 0){console.error("No base_id despite canvas double_tap");return}if(te.display_options.consumption_formatting||te.routing.args.view!=="knowledge")return;const ie=position_from_canvas_pointer_event(ee),se={id:ne.id,position:ie};create_wcomponent({wcomponent:{base_id:oe,type:"statev2"},add_to_knowledge_view:se,store:t})})}function position_from_canvas_pointer_event(t){const ee=offset_input_by_half_node(position_to_point(t));return round_canvas_point(ee,"large")}function cancel_selected_wcomponents_on_right_click(t){pub_sub.canvas.sub("canvas_right_click",ee=>{t.dispatch(ACTIONS.meta_wcomponents.clear_selected_wcomponents({}));const{route:te,item_id:ne,sub_route:oe}=t.getState().routing;(te==="wcomponents"&&ne||oe==="wcomponents_edit_multiple")&&t.dispatch(ACTIONS.routing.change_route({route:"wcomponents",sub_route:null,item_id:null}))})}function calculate_spatial_temporal_position_to_move_to(t){const{current_composed_knowledge_view:ee,wcomponents_by_id:te,initial_wcomponent_id:ne,disable_if_not_present:oe,display_side_panel:ie,display_time_sliders:se}=t;let{created_at_ms:re,selected_wcomponent_ids_set:_e}=t,ae,ce=[];if(ee){const{composed_wc_id_map:le,composed_visible_wc_id_map:ue,wc_ids_by_type:de}=ee,me=te[ne];ae=me&&get_created_at_ms(me);const{any_node:pe}=de;_e=new Set(_e),_e.delete(ne);const fe=get_wcomponent_group_positions_and_last_created_at({initial_wcomponent:me,disable_if_not_present:oe,composed_visible_wc_id_map:ue,selected_wcomponent_ids_set:_e,wcomponents_by_id:te,composed_wc_id_map:le,display_side_panel:ie,display_time_sliders:se,any_node:pe});ce=fe.positions,fe.wcomponent_created_at_ms&&(ae=Math.max(fe.wcomponent_created_at_ms,ae||0)),ae&&(re=Math.max(re,ae))}return{positions:ce,go_to_datetime_ms:re}}function calculate_all_display_combinations_of_spatial_temporal_position_to_move_to(t){const{current_composed_knowledge_view:ee,wcomponents_by_id:te,initial_wcomponent_id:ne,selected_wcomponent_ids_set:oe,created_at_ms:ie,disable_if_not_present:se}=t,re={current_composed_knowledge_view:ee,wcomponents_by_id:te,initial_wcomponent_id:ne,selected_wcomponent_ids_set:oe,created_at_ms:ie,disable_if_not_present:se},{positions:_e,go_to_datetime_ms:ae}=calculate_spatial_temporal_position_to_move_to({...re,display_side_panel:!1,display_time_sliders:!1}),ce=calculate_spatial_temporal_position_to_move_to({...re,display_side_panel:!0,display_time_sliders:!1}).positions,le=calculate_spatial_temporal_position_to_move_to({...re,display_side_panel:!1,display_time_sliders:!0}).positions,ue=calculate_spatial_temporal_position_to_move_to({...re,display_side_panel:!0,display_time_sliders:!0}).positions;return{positions_no_sidepanel_or_timesliders:_e,positions_sidepanel_no_timesliders:ce,positions_timesliders_no_sidepanel:le,positions_with_sidepanel_or_timesliders:ue,go_to_datetime_ms:ae}}function get_wcomponent_group_positions_and_last_created_at(t){const{initial_wcomponent:ee,disable_if_not_present:te,composed_visible_wc_id_map:ne,selected_wcomponent_ids_set:oe,wcomponents_by_id:ie,composed_wc_id_map:se,display_side_panel:re,display_time_sliders:_e,any_node:ae}=t;let ce=[],le;const ue={display_side_panel:re,display_time_sliders:_e},de=se[(ee==null?void 0:ee.id)||""];if(ee&&de){const{left:me,top:pe}=offset_entry_by_half_node(de,!!ee.summary_image),fe=lefttop_to_xy({left:me,top:pe,zoom:SCALE_BY},!0,ue);ce.push(fe)}else if(!te&&ne){let me=ids_on_map(oe,ne),pe=calculate_position_groups_with_zoom(me,ie,se,ue);pe.position_groups.length===0&&(me=ids_on_map(ae,ne),pe=calculate_position_groups_with_zoom(me,ie,se,ue)),le=pe.wcomponent_created_at_ms,ce=pe.position_groups.map(fe=>lefttop_to_xy({left:(fe.min_left+fe.max_left)/2,top:(fe.min_top+fe.max_top)/2,zoom:fe.zoom},!0,ue))}return{positions:ce,wcomponent_created_at_ms:le}}function calculate_position_groups_with_zoom(t,ee,te,ne){const oe=[];let ie;const se=Array.from(t);for(let re=0;re<se.length;++re){const _e=se[re];if(!_e)continue;const ae=ee[_e],ce=te[_e];if(!ae||!ce)continue;const le=ce.s??1,ue=node_height_approx(!!ae.summary_image),de=ce.left-NODE_WIDTH,me=ce.left+NODE_WIDTH*le+NODE_WIDTH,pe=ce.top-ue,fe=ce.top+ue*le;if(!oe.find(he=>{const be={min_left:Math.min(he.min_left,de),max_left:Math.max(he.max_left,me),min_top:Math.min(he.min_top,pe),max_top:Math.max(he.max_top,fe)},{zoom:ve,fits:ye}=calculate_zoom_to_contain_group(be,ne);return ye?(he.min_left=be.min_left,he.max_left=be.max_left,he.min_top=be.min_top,he.max_top=be.max_top,he.zoom=ve,!0):!1})){if(oe.length>10)break;const he={min_left:de,max_left:me,min_top:pe,max_top:fe,zoom:SCALE_BY};oe.push(he)}ie=get_created_at_ms(ae)}return{position_groups:oe,wcomponent_created_at_ms:ie}}function calculate_zoom_to_contain_group(t,ee){const te=t.max_left-t.min_left,ne=t.max_top-t.min_top,oe=get_screen_width(ee.display_side_panel)/te*SCALE_BY,ie=get_visible_screen_height(ee.display_time_sliders)/ne*SCALE_BY,se=Math.min(oe,ie),re=bound_zoom(Math.min(SCALE_BY,se));return{zoom:re,fits:se>=re}}function ids_on_map(t,ee){const te=new Set(t);return t.forEach(ne=>{ee[ne]||te.delete(ne)}),te}function get_actually_display_time_sliders(t){return t.controls.display_time_sliders}function ensure_any_knowledge_view_displayed(t){const ee=t.getState();if(!current_knowledge_view_is_valid(ee)){const te=selector_chosen_base(ee),ne=ee.specialised_objects.knowledge_views_by_id[(te==null?void 0:te.default_knowledge_view_id)||""],oe=ee.derived.knowledge_views[0],ie=ne||oe,se=ee.controls.display_side_panel,re=get_actually_display_time_sliders(ee);if(!ie)return;const _e=optionally_calculate_spatial_temporal_position_to_move_to(ee,ie,se,re),ae={subview_id:ie.id,..._e};t.dispatch(ACTIONS.routing.change_route({args:ae}))}}function current_knowledge_view_is_valid(t){const{subview_id:ee}=t.routing.args;return!!t.specialised_objects.knowledge_views_by_id[ee]}function optionally_calculate_spatial_temporal_position_to_move_to(t,ee,te,ne){let oe=update_current_composed_knowledge_view_state(t,ee);oe=update_composed_knowledge_view_filters(t,oe);const{wcomponents_by_id:ie}=t.specialised_objects,se=t.routing.item_id||"",{created_at_ms:re}=t.routing.args,{selected_wcomponent_ids_set:_e}=t.meta_wcomponents,ae=calculate_spatial_temporal_position_to_move_to({current_composed_knowledge_view:oe,wcomponents_by_id:ie,initial_wcomponent_id:se,selected_wcomponent_ids_set:_e,created_at_ms:re,disable_if_not_present:!1,display_side_panel:te,display_time_sliders:ne});return{x:0,y:0,z:0,...ae.positions[0],created_at_ms:ae.go_to_datetime_ms}}function ensure_a_knowledge_view_subscriber(t){return()=>{const ee=t.getState();if(!ee.sync.ready_for_reading||ee.derived.knowledge_views.length)return;const te=selector_chosen_base_id(ee);if(te===void 0){console.error("Can not create knowledge view without chosen_base_id");return}const ne=get_new_knowledge_view_object({title:"All",base_id:te},ee.creation_context);t.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:ne})),ensure_any_knowledge_view_displayed(t)}}function specialised_objects_subscribers(t){pub_sub_subscribers(t);const ee=create_links_on_connection_terminal_mouse_events__subscriber(t),te=ensure_a_knowledge_view_subscriber(t);return()=>{ee(),te()}}function pub_sub_subscribers(t){cancel_selected_wcomponents_on_right_click(t),create_wcomponent_on_double_tap(t),clear_last_pointer_down_connection_terminal(t)}function get_derived_starting_state(){return{composed_wcomponents_by_id:{},wcomponent_ids_by_type:get_empty_wcomponent_ids_by_type(),knowledge_views:[],nested_knowledge_view_ids:{top_ids:[],map:{}},judgement_or_objective_ids_by_target_id:{},judgement_or_objective_ids_by_goal_or_action_id:{},current_composed_knowledge_view:void 0}}function get_global_keys_starting_state(){return{last_key:void 0,last_key_time_stamp:void 0,keys_down:new Set,derived:{shift_down:!1,control_down:!1,shift_or_control_down:!1}}}function view_priorities_starting_state(){return{action_ids_to_show:[],date_shown:void 0}}function get_meta_wcomponents_starting_state(){return{selected_wcomponent_ids_list:[],selected_wcomponent_ids_set:new Set,selected_wcomponent_ids_to_ordinal_position_map:{},highlighted_wcomponent_ids:new Set,neighbour_ids_of_highlighted_wcomponent:new Set,last_clicked_wcomponent_id:void 0,last_pointer_down_connection_terminal:void 0,wcomponent_ids_to_move_set:new Set,frame_is_resizing:!1,find_all_causal_paths_from_wcomponent_ids:[],find_all_causal_paths_to_wcomponent_ids:[]}}function get_specialised_objects_starting_state(){return{wcomponents_by_id:{},knowledge_views_by_id:{}}}function get_starting_state$1(t){const ee=get_routing_starting_state(),{storage_location:te}=ee.args,ne=user_info_starting_state({load_state_from_storage:t,storage_location:te});return{controls:controls_starting_state({storage_location:te}),creation_context:creation_context_starting_state(),filter_context:filter_context_starting_state(),specialised_objects:get_specialised_objects_starting_state(),last_action:void 0,display_options:display_options_starting_state(),sync:sync_starting_state(),routing:ee,global_keys:get_global_keys_starting_state(),meta_wcomponents:get_meta_wcomponents_starting_state(),search:search_starting_state(),user_info:ne,view_priorities:view_priorities_starting_state(),derived:get_derived_starting_state()}}function parse_specialised_objects_fromto_server(t){const ee=new Set(["wcomponents","knowledge_views"]);let te=[],ne=[];if(t){delete t.wcomponent_ids_to_delete;const se=Object.keys(t).filter(ae=>!ee.has(ae));if(se.length)throw new Error(`Unexpected keys "${se.join(", ")}" in specialised objects state`);const re=Array.from(ee).filter(ae=>!t.hasOwnProperty(ae));if(re.length)throw new Error(`Expected keys "${re.join(", ")}" missing in specialised objects state`);te=t.wcomponents.map(parse_wcomponent);const _e=new Set(te.map(({id:ae})=>ae));ne=t.knowledge_views.map(ae=>parse_knowledge_view(ae,_e,!0))}return{wcomponents:te,knowledge_views:ne}}function parse_specialised_objects_from_server_data(t){try{return parse_specialised_objects_fromto_server(t)}catch(ee){throw console.error("Error parsing specialised objects state from server"),ee}}async function supabase_load_data(t,ee){if(!t)return Promise.resolve(local_data);const te=get_supabase(),ne=await supabase_get_knowledge_views({supabase:te,base_id:ee});if(ne.error)return Promise.reject(ne.error);const oe=await supabase_get_wcomponents({supabase:te,base_id:ee});if(oe.error)return Promise.reject(oe.error);const ie=await supabase_get_wcomponents_from_other_bases({supabase:te,base_id:ee,knowledge_views:ne.items,wcomponents:oe.items});if(ie.error)return Promise.reject(ie.error);const se=await supabase_get_knowledge_views_from_other_bases({supabase:te,knowledge_views:ne.items,wcomponents_from_other_bases:ie.wcomponents});if(se.error)return Promise.reject(se.error);const re=[...oe.items,...ie.wcomponents],_e=[...ne.items,...se.items];return Promise.resolve({knowledge_views:_e,wcomponents:re})}function load_state(t){let ee=t.getState();const{dispatch:te}=t,{chosen_base_id:ne}=ee.user_info;ne!==ee.sync.specialised_objects.loading_base_id&&(t.dispatch(ACTIONS.specialised_object.clear_from_mem_all_specialised_objects()),ne!==void 0&&(te(ACTIONS.sync.update_sync_status({status:"LOADING",data_type:"specialised_objects",loading_base_id:ne})),supabase_load_data(t.load_state_from_storage,ne).then(oe=>parse_specialised_objects_from_server_data(oe)).then(oe=>{te(ACTIONS.specialised_object.replace_all_specialised_objects({specialised_objects:oe})),ensure_any_knowledge_view_displayed(t),te(ACTIONS.sync.update_sync_status({status:"LOADED",data_type:"specialised_objects"}))}).catch(oe=>{const ie=error_to_string(oe);console.error(oe),te(ACTIONS.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:ie}))})))}function sync_subscribers(t){pub_sub.user.sub("changed_bases",()=>{const{ready_for_reading:oe}=t.getState().sync;oe||load_state(t)}),pub_sub.user.sub("changed_chosen_base_id",()=>load_state(t));const ee=t.getState(),{user:te,chosen_base_id:ne}=ee.user_info;te&&ne!==void 0&&load_state(t),subscribe_search_for_requested_wcomponents_in_any_base(t)}function subscribe_search_for_requested_wcomponents_in_any_base(t){const ee=get_supabase(),te=min_throttle(async()=>{const ne=t.getState();if(!ne.sync.wcomponent_ids_to_search_for_in_any_base.size)return;const oe=Array.from(ne.sync.wcomponent_ids_to_search_for_in_any_base);t.dispatch(ACTIONS.sync.searching_for_wcomponents_by_id_in_any_base());const ie=await supabase_get_wcomponents_from_any_base({supabase:ee,ids:oe});t.dispatch(ACTIONS.sync.searched_for_wcomponents_by_id_in_any_base({ids:oe})),t.dispatch(ACTIONS.specialised_object.add_wcomponents_to_store({wcomponents:ie.wcomponents}))},50);t.subscribe(async()=>{const ne=t.getState();ne.sync.ready_for_reading&&ne.sync.wcomponent_ids_to_search_for_in_any_base.size&&te.throttled()}),pub_sub.user.sub("changed_chosen_base_id",()=>{te.cancel()})}function conditionally_warn_unsaved_exit(t,ee){if(t&&needs_save(ee))return!0}function setup_warning_of_unsaved_data_beforeunload(t,ee){let te=performance.now();const ne=30*1e3;window.onbeforeunload=()=>{const oe=ee.getState();let ie=conditionally_warn_unsaved_exit(t,oe);return ie&&(ie=performance.now()-te>ne),ie&&(te=performance.now()),ie}}async function get_all_bases(t){const te=await get_supabase().from("bases").select("*, access_controls(access_level,user_id)").order("inserted_at",{ascending:!0}),ne=te.data?te.data.map(oe=>base_supabase_to_app(oe,oe.access_controls,t)):void 0;return{error:te.error,data:ne}}async function create_a_base(t){const{owner_user_id:ee,title:te="Primary"}=t,oe=await get_supabase().from("bases").insert({owner_user_id:ee,title:te});return{base:oe.data&&oe.data[0]||void 0,error:oe.error}}function santise_base(t){return{id:t.id,inserted_at:t.inserted_at,updated_at:t.updated_at,owner_user_id:t.owner_user_id,public_read:t.public_read,title:t.title,default_knowledge_view_id:t.default_knowledge_view_id}}function base_supabase_to_app(t,ee,te){let{inserted_at:ne,updated_at:oe,owner_user_id:ie,public_read:se}=t;ne=new Date(ne),oe=new Date(oe);const re=ee==null?void 0:ee.find(ce=>ce.user_id===te),_e=(re==null?void 0:re.access_level)||(te===ie?"owner":se?"viewer":"none"),ae=_e==="owner"||_e==="editor";return{...santise_base(t),inserted_at:ne,updated_at:oe,access_level:_e,can_edit:ae}}async function modify_base(t){const ee=santise_base(t);return await get_supabase().from("bases").update(ee).eq("id",ee.id)}async function refresh_bases_for_current_user(t,ee=!1){t||(t=get_store()),ee&&t.dispatch(ACTIONS.user_info.update_bases({bases:void 0}));const{user:te}=t.getState().user_info;t.dispatch(ACTIONS.sync.update_sync_status({status:"LOADING",data_type:"bases"}));const{data:ne,error:oe}=await get_all_bases(te==null?void 0:te.id);t.dispatch(ACTIONS.user_info.update_bases({bases:ne}));const ie=oe?"FAILED":"LOADED";return t.dispatch(ACTIONS.sync.update_sync_status({status:ie,data_type:"bases"})),{error:oe||void 0}}function user_info_subscribers(t){if(!t.load_state_from_storage)return;const ee=t.getState(),{users_by_id:te,bases_by_id:ne}=ee.user_info;te||get_users(t),ne||refresh_bases_for_current_user(t),pub_sub.user.sub("changed_user",()=>{var ie;(ie=selector_chosen_base(t.getState()))!=null&&ie.public_read||t.dispatch(ACTIONS.specialised_object.clear_from_mem_all_specialised_objects()),pub_sub.user.pub("stale_users_by_id",!0),pub_sub.user.pub("stale_bases",!0)}),pub_sub.user.sub("stale_users_by_id",ie=>{ie&&t.dispatch(ACTIONS.user_info.set_users({users:void 0})),get_users(t)}),pub_sub.user.sub("stale_bases",ie=>{refresh_bases_for_current_user(t,ie)});const oe=get_supabase();oe.auth.onAuthStateChange(()=>{const ie=t.getState().user_info.user,se=oe.auth.user()||void 0;(ie==null?void 0:ie.id)!==(se==null?void 0:se.id)&&t.dispatch(ACTIONS.user_info.set_user({user:se}))})}async function get_users(t){const ee=get_supabase(),{data:te,error:ne}=await ee.from("users").select("*");te&&t.dispatch(ACTIONS.user_info.set_users({users:te}))}let cached_store$1;function get_store(t={}){const{use_cache:ee=!0,override_preloaded_state:te={},load_state_from_storage:ne=!1}=t;if(cached_store$1&&ee)return cached_store$1;const oe={...get_starting_state$1(ne),...te},ie=createStore(root_reducer$1,oe);ie.load_state_from_storage=ne,cached_store$1=ie;const se=()=>{const re=ie.getState();persist_relevant_state(re),conditionally_save_state(ie)};return ie.subscribe(se),setup_warning_of_unsaved_data_beforeunload(ne,ie),ie.subscribe(factory_location_hash(ie)),ie.subscribe(specialised_objects_subscribers(ie)),controls_subscribers(ie),display_options_subscribers(ie),meta_wcomponents_selecting_subscribers(ie),periodically_change_display_at_created_datetime(ie),record_keyupdown_activity(ie),routing_subscribers.sync_storage_location_subscriber(ie),user_info_subscribers(ie),sync_subscribers(ie),register_window_focus_session_check(ie),register_window_title_updater_subscriber(ie),ie}function JudgementBadge(t){const{judgement:ee,judgement_trend_manual:te,size:ne}=t,ie=`judgement_badge ${ne} ${ee?"positive":ee===void 0?"inactive":"negative"} ${te??""}`,se=te==="improving"?o$1(default_1$x,{}):te==="stable"?o$1(default_1$w,{}):te==="worsening"?o$1(default_1$v,{}):te==="unknown"?o$1(QuestionMarkIcon,{}):o$1("span",{});if(!t.judgement_or_objective_id)return o$1("div",{className:ie,children:se});let re;return t.position&&(re=lefttop_to_xy({...t.position,zoom:100},!0)),o$1(Link,{route:void 0,sub_route:void 0,item_id:t.judgement_or_objective_id,args:re,extra_class_name:ie,on_pointer_down:()=>{const _e=get_store(),ae=_e.getState(),{display_side_panel:ce,display_time_sliders:le}=ae.controls;return t.position&&(re=lefttop_to_xy({...t.position,zoom:100},!0,{display_side_panel:ce,display_time_sliders:le})),_e.dispatch(ACTIONS.routing.change_route({item_id:t.judgement_or_objective_id,args:re})),!0},children:se})}const map_state$1T=(t,ee)=>{let te=get_wcomponent_from_state(t,ee.judgement_or_objective_id);wcomponent_is_judgement_or_objective(te)||(te=void 0);let ne,oe;if(te){const re=te.judgement_target_wcomponent_id;ne=get_wcomponent_from_state(t,re),oe=get_VAP_set_id_to_counterfactual_v2_map(t,re)}const ie=get_current_composed_knowledge_view_from_state(t),se=ie==null?void 0:ie.composed_wc_id_map[ee.judgement_or_objective_id];return{judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,position:se}},connector$1V=connect(map_state$1T);function _JudgementBadgeConnected(t){const{judgement_or_objective_id:ee,judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:se,position:re}=t;if(!te||!ne)return null;const _e=calculate_judgement_value({judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:se});return o$1(JudgementBadge,{judgement:_e,judgement_trend_manual:t.hide_judgement_trend?void 0:te.judgement_trend_manual,judgement_or_objective_id:ee,position:re,size:t.hide_judgement_trend?"small":"medium"})}const JudgementBadgeConnected=connector$1V(_JudgementBadgeConnected),map_state$1S=(t,ee)=>{let te=get_wcomponent_from_state(t,ee.judgement_or_objective_id);wcomponent_is_judgement_or_objective(te)||(te=void 0);const ne=get_current_composed_knowledge_view_from_state(t),oe=ne?ne.composed_wc_id_map[ee.judgement_or_objective_id]:void 0;return{judgement_wcomponent:te,position:oe}},connector$1U=connect(map_state$1S);function _JudgementBadgeSimple(t){const{judgement_or_objective_id:ee,judgement_wcomponent:te,position:ne,target_VAPs_represent:oe,value:ie}=t;if(!te)return null;const se=core_calculate_judgement_value({judgement_wcomponent:te,target_VAPs_represent:oe,value:ie});return o$1(JudgementBadge,{judgement:se,judgement_trend_manual:t.hide_judgement_trend?void 0:te.judgement_trend_manual,judgement_or_objective_id:ee,position:ne,size:t.hide_judgement_trend?"small":"medium"})}const JudgementBadgeSimple=connector$1U(_JudgementBadgeSimple),map_state$1R=t=>{const ee=get_current_composed_knowledge_view_from_state(t);return{active_judgement_or_objective_ids_by_target_id:ee==null?void 0:ee.active_judgement_or_objective_ids_by_target_id,active_judgement_or_objective_ids_by_goal_or_action_id:ee==null?void 0:ee.active_judgement_or_objective_ids_by_goal_or_action_id}},connector$1T=connect(map_state$1R);function _WComponentJudgements(t){const{active_judgement_or_objective_ids_by_target_id:ee,active_judgement_or_objective_ids_by_goal_or_action_id:te,target_VAPs_represent:ne,value:oe}=t,ie=F$1(()=>[...(ee||{})[t.wcomponent.id]||[],...(te||{})[t.wcomponent.id]||[]],[ee,te]),se="node_judgements_container ";return oe===void 0||ne===void 0?o$1("div",{className:se,children:ie.map(re=>o$1(JudgementBadgeConnected,{judgement_or_objective_id:re,hide_judgement_trend:t.hide_judgement_trend}))}):o$1("div",{className:se,children:ie.map(re=>o$1(JudgementBadgeSimple,{judgement_or_objective_id:re,hide_judgement_trend:t.hide_judgement_trend,target_VAPs_represent:ne,value:oe}))})}const WComponentJudgements=connector$1T(_WComponentJudgements);function get_VAP_id_to_counterfactuals_info_map(t){const{VAP_set:ee,VAP_set_id_to_counterfactual_v2_map:te,knowledge_views_by_id:ne}=t,oe=(te==null?void 0:te[ee.id])||[],ie={};return oe.forEach(se=>{const{target_VAP_id:re}=se;if(!re)return;const _e=wcomponent_has_knowledge_view(se.id,ne),ae={counterfactual_v2_id:se.id,counterfactual_has_knowledge_view:_e},ce=ie[re]||[];ce.push(ae),ie[re]=ce}),ie}const ValueAndPredictionSetSummary$1="";var ArrowUpward={},_interopRequireDefault$u=interopRequireDefaultExports;Object.defineProperty(ArrowUpward,"__esModule",{value:!0});var default_1$u=ArrowUpward.default=void 0,_createSvgIcon$u=_interopRequireDefault$u(requireCreateSvgIcon()),_jsxRuntime$u=requireJsxRuntime(),_default$u=(0,_createSvgIcon$u.default)((0,_jsxRuntime$u.jsx)("path",{d:"m4 12 1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"}),"ArrowUpward");default_1$u=ArrowUpward.default=_default$u;var Search={},_interopRequireDefault$t=interopRequireDefaultExports;Object.defineProperty(Search,"__esModule",{value:!0});var default_1$t=Search.default=void 0,_createSvgIcon$t=_interopRequireDefault$t(requireCreateSvgIcon()),_jsxRuntime$t=requireJsxRuntime(),_default$t=(0,_createSvgIcon$t.default)((0,_jsxRuntime$t.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"}),"Search");default_1$t=Search.default=_default$t;const Handles$1="",d$8="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z";function AddSearchIcon(t){return o$1(CommonIcon,{...t,d:d$8,svg_elements:[o$1("line",{x1:"0",x2:"13",y1:"18",y2:"18",stroke:"white","stroke-width":"6"}),o$1("line",{x1:"6.5",x2:"6.5",y1:"11.5",y2:"24",stroke:"white","stroke-width":"6"}),o$1("line",{x1:"1.5",x2:"11.5",y1:"18",y2:"18","stroke-width":"3"}),o$1("line",{x1:"6.5",x2:"6.5",y1:"13",y2:"23","stroke-width":"3"})]})}const map_state$1Q=(t,ee)=>{const te=get_wcomponent_from_state(t,ee.wcomponent_id),oe=(get_overlapping_wcomponent_ids(t,ee.wcomponent_id)||[]).find(ie=>t.specialised_objects.knowledge_views_by_id[ie]);return{wcomponent:te,kvwc:t.specialised_objects.knowledge_views_by_id[ee.wcomponent_id],subview_id:t.routing.args.subview_id,nested_knowledge_view_ids_entry:t.derived.nested_knowledge_view_ids.map[ee.wcomponent_id],presenting:t.display_options.consumption_formatting,any_overlapping_wcomponents_have_kvs:oe}},connector$1S=connect(map_state$1Q);function _ExploreButtonHandle(t){let{kvwc:ee}=t;const{is_highlighted:te,nested_knowledge_view_ids_entry:ne,any_overlapping_wcomponents_have_kvs:oe}=t,ie=!t.presenting,se=!ee&&(t.presenting||ie&&!te&&!oe),re=t.subview_id===t.wcomponent_id,_e=ne&&ne.parent_id,ae=ie&&!!t.wcomponent,ce=re?_e?2:-1:ee?1:ae?3:-2,le=re&&!_e,ue="node_handle explore "+(se?" hidden ":"")+(ee?" has_knowledge_view ":"")+(le?" current_but_no_parent ":"")+(ce===3?" will_create_on_click ":"")+(ce===-2?" error_disabled ":"");return o$1("div",{className:ue,title:ce===2?"Navigate up to parent":ce===-1?"No parent to navigate up to":ce===1?"Navigate to knowledge view":ce===3?"Create then navigate to knowledge view":ce===-2?"Error: could not find the component to create a new knowledge view for":"Unknown error",onClick:me=>{me.preventDefault(),me.stopImmediatePropagation();const pe=get_store();if(re)_e&&navigate_to_knowledge_view_or_kvwcomponent(_e,pe);else{if(!ee){const fe=prepare_wcomponent_knowledge_view(t,pe);if(!fe)return;ee=fe,pe.dispatch(ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:ee}))}navigate_to_knowledge_view_or_kvwcomponent(ee.id,pe)}},children:re?o$1(default_1$u,{}):ce===3?o$1(AddSearchIcon,{}):o$1(default_1$t,{})})}const ExploreButtonHandle=connector$1S(_ExploreButtonHandle);function prepare_wcomponent_knowledge_view(t,ee){if(!t.wcomponent)return!1;const te=ee.getState(),ne=get_middle_of_screen(te),oe={[t.wcomponent.id]:t.wcomponent_current_kv_entry||ne},ie=get_title$1({wcomponent:t.wcomponent,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(te),text_type:RichTextType.plain,wcomponents_by_id:te.specialised_objects.wcomponents_by_id,knowledge_views_by_id:te.specialised_objects.knowledge_views_by_id,created_at_ms:te.routing.args.created_at_ms,sim_ms:te.routing.args.sim_ms}),re=remove_rich_text(ie)||`Knowledge view for ${t.wcomponent.id} created: ${get_today_str()}`,_e=get_current_composed_knowledge_view_from_state(te),ae=_e&&_e.id,ce={id:t.wcomponent.id,base_id:t.wcomponent.base_id,wc_id_map:oe,title:re,sort_type:ae?"normal":"hidden",parent_knowledge_view_id:ae},{creation_context:le}=te;return get_new_knowledge_view_object(ce,le)}const d$7="m9.78 11.16-1.42 1.42c-.68-.69-1.34-1.58-1.79-2.94l1.94-.49c.32.89.77 1.5 1.27 2.01zM11 6 7 2 3 6h3.02c.02.81.08 1.54.19 2.17l1.94-.49C8.08 7.2 8.03 6.63 8.02 6H11zm10 0-4-4-4 4h2.99c-.1 3.68-1.28 4.75-2.54 5.88-.5.44-1.01.92-1.45 1.55-.34-.49-.73-.88-1.13-1.24L9.46 13.6c.93.85 1.54 1.54 1.54 3.4v5h2v-5c0-2.02.71-2.66 1.79-3.63 1.38-1.24 3.08-2.78 3.2-7.37H21z";function AltRouteIcon(t){return o$1(CommonIcon,{...t,d:d$7})}const ALTERNATIVE_VALUE_COLOR="darkorange";function ValueAndPredictionEntryRow(t){const{VAP_visual:ee,show_judgements:te,counterfactual_VAP_set:ne,VAP_id_to_counterfactuals_info_map:oe}=t,ie={},se=get_wcomponent_VAPs_represent(t.wcomponent,ie),re=ee.certainty*100,_e=`${re}%`,ae=Math.round(re);let ce=100;ae<100&&(ce=ae*1.25);const le=oe[ee.VAP_id]||[],ue=ne.has_any_counterfactual_applied?"warning_color":"";return o$1("div",{className:`value_and_prediction prob-${ae} ${ue}`,style:{fontSize:`${ce}%`,maxHeight:_e,minHeight:_e},children:[ee.value_text,te&&o$1(WComponentJudgements,{wcomponent:t.wcomponent,target_VAPs_represent:se,value:ee.parsed_value,hide_judgement_trend:!0}),le.map(de=>o$1(CounterfactualLink,{any_active:ne.has_any_counterfactual_applied,counterfactual:de,active_counterfactual_v2_id:ne.active_counterfactual_v2_id}))]})}function CounterfactualLink(t){const ne={fontSize:"25px",color:t.counterfactual.counterfactual_v2_id===t.active_counterfactual_v2_id?ALTERNATIVE_VALUE_COLOR:t.any_active?"white":"#ffc965",verticalAlign:"middle",fontWeight:"bold",width:"20px"};return o$1("span",{onPointerDown:oe=>oe.stopImmediatePropagation(),onClick:oe=>oe.stopImmediatePropagation(),style:{display:"inline-flex"},children:[" ",o$1(Link,{route:void 0,sub_route:void 0,item_id:t.counterfactual.counterfactual_v2_id,args:void 0,extra_css_style:ne,children:o$1(AltRouteIcon,{fontSize:"small"})}),t.counterfactual.counterfactual_has_knowledge_view&&o$1("span",{style:{fontSize:14},children:o$1(ExploreButtonHandle,{wcomponent_id:t.counterfactual.counterfactual_v2_id||"",is_highlighted:!0})})," "]})}function ValueAndPredictionSetSummary(t){const[ee,te]=h$1(!1),{counterfactual_VAP_set:ne,VAP_id_to_counterfactuals_info_map:oe}=t,ie={},se=get_wcomponent_VAPs_represent(t.wcomponent,ie),re=convert_VAP_set_to_VAP_visuals({...t,VAP_set:ne,VAPs_represent:se}),_e=re.filter(ae=>ae.certainty>0);return o$1(Box,{height:"100%",maxWidth:"100%",minWidth:100,overflow:"hidden",position:"relative",flexDirection:"column",justifyContent:"flex-end",alignItems:"stretch",alignContent:"stretch",className:`value_and_prediction_set_summary items-${re.length} visible-${_e.length}`,onPointerOver:()=>te(!0),onPointerLeave:()=>te(!1),children:re.map((ae,ce)=>{const le=ee||ce===0;return o$1(ValueAndPredictionEntryRow,{wcomponent:t.wcomponent,VAP_visual:ae,show_judgements:le,counterfactual_VAP_set:ne,VAP_id_to_counterfactuals_info_map:oe})})})}const map_state$1P=(t,ee)=>({VAP_set_id_to_counterfactual_v2_map:get_VAP_set_id_to_counterfactual_v2_map(t,ee.wcomponent.id),knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),connector$1R=connect(map_state$1P);function _ConnectedValueAndPredictionSetSummary(t){const{wcomponent:ee,VAP_set:te,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe}=t,ie=apply_counterfactuals_v2_to_VAP_set({VAP_set:te,VAP_set_id_to_counterfactual_v2_map:ne}),se=get_VAP_id_to_counterfactuals_info_map({VAP_set:te,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe});return o$1(ValueAndPredictionSetSummary,{wcomponent:ee,counterfactual_VAP_set:ie,VAP_id_to_counterfactuals_info_map:se})}const ConnectedValueAndPredictionSetSummary=connector$1R(_ConnectedValueAndPredictionSetSummary);function NodeValueAndPredictionSetSummary(t){if(!wcomponent_has_VAP_sets(t.wcomponent))return null;const ee=get_current_VAP_set({...t,values_and_prediction_sets:t.wcomponent.values_and_prediction_sets});return ee?o$1(ConnectedValueAndPredictionSetSummary,{wcomponent:t.wcomponent,VAP_set:ee}):null}const DisplayValue$1="";function DisplayValue(t){const{UI_value:ee}=t,{values_string:te,counterfactual_applied:ne,uncertain:oe,derived__using_values_from_wcomponent_ids:ie}=ee,se=ne||!!(ie!=null&&ie.length),re=`value ${se?"assumption":""} ${oe?"uncertain":""}`;let _e="Current value";return se&&(_e+=" is an assumption"),se&&oe&&(_e+=" and"),oe&&(_e+=" has uncertainty"),o$1(k$1,{children:[o$1(Tooltip,{className:re,title:_e,"aria-label":_e,children:o$1("span",{children:te})}),(ie||[]).map(ae=>o$1(LinkToComponent,{uuid:ae}))]})}const map_state$1O=(t,ee)=>{const{composed_wcomponents_by_id:te}=t.derived,ne=te[ee.uuid],oe=get_wc_id_to_counterfactuals_v2_map$1(t),ie=t.specialised_objects.knowledge_views_by_id;return{title:ne&&get_title$1({wcomponent:ne,text_type:RichTextType.plain,wcomponents_by_id:te,knowledge_views_by_id:ie,wc_id_to_counterfactuals_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms})}},connector$1Q=connect(map_state$1O);function _LinkToComponent(t){const{uuid:ee,title:te}=t;return o$1(Link,{route:void 0,sub_route:void 0,item_id:ee,args:void 0,children:o$1(AltRouteIcon,{className:"material-icons",title:"Value derived from "+(te?`'${te}'`:"a different component"),style:{fill:ALTERNATIVE_VALUE_COLOR,height:"16px"}})},ee)}const LinkToComponent=connector$1Q(_LinkToComponent);function get_wcomponent_validity_UI_value(t){const{wcomponent:ee,created_at_ms:te,sim_ms:ne}=t,{is_defined:oe,is_valid:ie,certainty:se}=get_wcomponent_validity_value({wcomponent:ee,created_at_ms:te,sim_ms:ne});return{is_defined:oe,values_string:ie?"Valid":"Invalid",counterfactual_applied:void 0,uncertain:void 0,derived__using_values_from_wcomponent_ids:void 0}}const map_state$1N=t=>{const{created_at_ms:ee,sim_ms:te}=t.routing.args;return{created_at_ms:ee,sim_ms:te}},connector$1P=connect(map_state$1N);function _WComponentValidityValue(t){const ee=get_wcomponent_validity_UI_value(t);return o$1("div",{className:"node_validity_value_container",children:o$1(DisplayValue,{UI_value:ee})})}const WComponentValidityValue=connector$1P(_WComponentValidityValue),d$6="M14 2H4c-1.11 0-2 .9-2 2v10h2V4h10V2zm4 4H8c-1.11 0-2 .9-2 2v10h2V8h10V6zm2 4h-8c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z";function AutoAwesomeMotionIcon(t){return o$1(CommonIcon,{...t,d:d$6})}const map_state$1M=(t,ee)=>({overlapping_wcomponent_ids:get_overlapping_wcomponent_ids(t,ee.wcomponent_id)}),map_dispatch$14={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,change_route:ACTIONS.routing.change_route},connector$1O=connect(map_state$1M,map_dispatch$14);function _OverlappingNodesHandle(t){const{overlapping_wcomponent_ids:ee,set_highlighted_wcomponent:te,change_route:ne}=t,oe=(ee==null?void 0:ee.length)||0,se="node_handle overlapping_nodes"+(oe===0?" hidden ":""),re=oe?`${oe-1} other nodes at this location`:"",_e=F$1(()=>{if(ee)return ae=>{ae.stopImmediatePropagation(),te({id:t.wcomponent_id,highlighted:!1}),ne({item_id:ee[0]})}},[ne,ee]);return o$1("div",{className:se,title:re,onClick:_e,children:o$1(AutoAwesomeMotionIcon,{fontSize:"small"})})}const OverlappingNodesHandle=connector$1O(_OverlappingNodesHandle);function client_to_canvas(t,ee){return ee*(SCALE_BY/t)}function client_to_canvas_x(t,ee,te){return t+client_to_canvas(ee,te)}function client_to_canvas_y(t,ee,te){return t-client_to_canvas(ee,te)}function Handles(t){return o$1("div",{className:"handles",children:[o$1(HandleForMoving,{show_move_handle:t.show_move_handle,user_requested_node_move:t.user_requested_node_move}),o$1(ExploreButtonHandle,{wcomponent_id:t.wcomponent_id,wcomponent_current_kv_entry:t.wcomponent_current_kv_entry,is_highlighted:t.is_highlighted}),o$1(OverlappingNodesHandle,{wcomponent_id:t.wcomponent_id})]})}function HandleForMoving(t){const{show_move_handle:ee,user_requested_node_move:te}=t,ne="node_handle movement highlight_on_hover";return ee?o$1("div",{className:ne,onPointerDown:ie=>{ie.stopPropagation();const se=canvas_pointer_event_to_position(ie);te(se)},children:"✥"}):o$1("div",{className:ne,children:" "})}function canvas_pointer_event_to_position(t){const ee=get_store().getState(),{x:te,y:ne,zoom:oe}=ee.routing.args;return{x:client_to_canvas_x(te,oe,t.clientX),y:client_to_canvas_y(ne,oe,t.clientY)}}function convert_VAP_sets_to_visual_sub_state_value_possibilities(t){const{selector:ee,target_wcomponent:te}=t,{target_VAP_set_id:ne,target_value_id_type:oe,target_value:ie}=ee||{},se=get_substate_target_VAP_sets(te,ne),_e=get_wcomponent_VAPs_represent(te,{}),ae=[];return se.forEach(le=>{convert_VAP_set_to_VAP_visuals({VAP_set:le,VAPs_represent:_e,wcomponent:te}).forEach(({value_id:ue,value_text:de})=>ae.push({value_id:ue,value:de}))}),get_simple_possibilities_from_values(ae,te.value_possibilities).map(le=>{const ue=predicate_target_value_possibility({target_value_id_type:oe,target_value:ie,value_text:le.value,value_id:le.id});return{...le,selected:ue}})}function get_substate_target_VAP_sets(t,ee){let te=t.values_and_prediction_sets||[];return ee&&(te=te.filter(({id:ne})=>ne===ee)),te}function predicate_target_value_possibility(t){return t.target_value_id_type===void 0?void 0:t.target_value_id_type==="value_string"?t.value_text===t.target_value:t.value_id===t.target_value}function ratio_to_percentage_string(t){if(t===void 0)return"";const ee=bounded(t,0,1)*100;return ee.toPrecision(ee<98?2:3).replace(/\.0$/,"")}const map_state$1L=(t,ee)=>{const{target_wcomponent_id:te}=ee.wcomponent,{wcomponents_by_id:ne}=t.specialised_objects,oe=ne[te||""],ie=wcomponent_is_allowed_to_have_state_VAP_sets(oe)&&oe,se=get_VAP_set_id_to_counterfactual_v2_map(t,te);return{target_wcomponent:ie,wcomponents_by_id:ne,VAP_set_id_to_counterfactual_v2_map:se,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}},connector$1N=connect(map_state$1L);function _NodeSubStateSummary(t){const{target_wcomponent:ee,wcomponents_by_id:te,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe}=t;if(!ee)return null;const{selector:ie}=t.wcomponent,{target_VAP_set_id:se,target_value_id_type:re,target_value:_e}=ie||{},ae=re!==void 0&&_e!==void 0;let ce=ee.values_and_prediction_sets||[];const le=get_wcomponent_VAPs_represent(ee,te);if(se===void 0)return ae?null:o$1(NodeValueAndPredictionSetSummary,{wcomponent:ee,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});ce=ce.filter(({id:he})=>he===se),ce=prune_items_by_created_at_and_versions(ce,t.created_at_ms);const ue=ce[0];if(!ue)return o$1("div",{children:"Invalid configuration"});if(!ae)return o$1(ConnectedValueAndPredictionSetSummary,{wcomponent:ee,VAP_set:ue});const de=apply_counterfactuals_v2_to_VAP_set({VAP_set:ue,VAP_set_id_to_counterfactual_v2_map:ne}),me=get_VAP_id_to_counterfactuals_info_map({VAP_set:ue,VAP_set_id_to_counterfactual_v2_map:ne,knowledge_views_by_id:oe});let fe=convert_VAP_set_to_VAP_visuals({...t,VAP_set:de,VAPs_represent:le}).find(({value_id:he,value_text:be})=>predicate_target_value_possibility({target_value_id_type:re,target_value:_e,value_id:he,value_text:be}));if(!fe)return o$1("div",{children:"Invalid configuration"});let{value_text:ge}=fe;return ge=` ${ratio_to_percentage_string(fe.certainty)}%`,fe={...fe,value_text:ge,certainty:1},o$1(ValueAndPredictionEntryRow,{wcomponent:ee,VAP_visual:fe,show_judgements:!0,counterfactual_VAP_set:de,VAP_id_to_counterfactuals_info_map:me})}const NodeSubStateSummary=connector$1N(_NodeSubStateSummary),d$5="m14.5 14.2 2.9 1.7-.8 1.3L13 15v-5h1.5v4.2zM22 14c0 4.41-3.59 8-8 8-2.02 0-3.86-.76-5.27-2H4c-1.15 0-2-.85-2-2V9c0-1.12.89-1.96 2-2v-.5C4 4.01 6.01 2 8.5 2c2.34 0 4.24 1.79 4.46 4.08.34-.05.69-.08 1.04-.08 4.41 0 8 3.59 8 8zM6 7h5v-.74C10.88 4.99 9.8 4 8.5 4 7.12 4 6 5.12 6 6.5V7zm14 7c0-3.31-2.69-6-6-6s-6 2.69-6 6 2.69 6 6 6 6-2.69 6-6z";function LockClockIcon(t){return o$1(CommonIcon,{...t,d:d$5})}const d$4="M8 18h3v3h2v-3h3l-4-4-4 4zm8-12h-3v-3h-2v3h-3l4 4 4-4zm-12 5v2h16v-2z";function ReducedPossibilitiesIcon(t){return o$1(CommonIcon,{...t,d:d$4})}const map_state$1K=(t,ee)=>{const{target_wcomponent_id:te}=ee.wcomponent,ne=t.specialised_objects.wcomponents_by_id[te||""];return{target_wcomponent:wcomponent_is_allowed_to_have_state_VAP_sets(ne)&&ne,presenting:t.display_options.consumption_formatting}},connector$1M=connect(map_state$1K);function _NodeSubStateTypeIndicators(t){const{target_wcomponent:ee,presenting:te}=t;if(!ee||te)return null;const{selector:ne}=t.wcomponent,{target_VAP_set_id:oe,target_value_id_type:ie,target_value:se}=ne||{},re=ee.values_and_prediction_sets||[],_e=oe===void 0?0:re.find(({id:de})=>de===oe)?1:2,ae=convert_VAP_sets_to_visual_sub_state_value_possibilities({selector:ne,target_wcomponent:ee}),ce=ie===void 0||se===void 0?0:ae.find(({selected:de})=>de)?1:2,le=sub_state_type_status_to_color(_e),ue=sub_state_type_status_to_color(ce);return o$1("div",{className:"sub_state_type_indicators",children:[o$1(LockClockIcon,{className:le,title:"Specific Time "+sub_state_type_status_to_title(_e),style:{height:"30px"}}),o$1(ReducedPossibilitiesIcon,{className:ue,title:"Specific Possibility "+sub_state_type_status_to_title(ce),style:{height:"30px"}})]})}const NodeSubStateTypeIndicators=connector$1M(_NodeSubStateTypeIndicators);function sub_state_type_status_to_color(t){return t===1?" sub_state_type_status__set ":t===0?" sub_state_type_status__not_set ":" sub_state_type_status__invalid "}function sub_state_type_status_to_title(t){return t===1?"Set":t===0?"Not set":"Invalid"}function start_moving_wcomponents(t,ee){const te=get_store(),ne=ACTIONS.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:t});te.dispatch(ne);let oe;const ie=pub_sub.canvas.sub("canvas_move",re=>{oe=round_canvas_point({left:re.x-ee.x,top:ee.y-re.y}),pub_sub.canvas.pub("canvas_node_drag_relative_position",oe)}),se=pub_sub.canvas.sub("canvas_pointer_up",()=>{if(oe){const _e=ACTIONS.specialised_object.bulk_edit_knowledge_view_entries({wcomponent_ids:Array.from(t),change_left:oe.left,change_top:oe.top});te.dispatch(_e)}const re=ACTIONS.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:new Set});te.dispatch(re),ie(),se()})}const WComponentCanvasNodeBackgroundFrame$1="",default_frame_color={r:175,g:175,b:175,a:.11},OFFSET_TOP=grid_small_step,OFFSET_RIGHT=grid_small_step,map_state$1J=t=>{var ee;return{is_editing:!t.display_options.consumption_formatting,frame_is_resizing:t.meta_wcomponents.frame_is_resizing,knowledge_view_id:(ee=get_current_knowledge_view_from_state(t))==null?void 0:ee.id}},map_dispatch$13={set_frame_is_resizing:ACTIONS.meta_wcomponents.set_frame_is_resizing,upsert_knowledge_view_entry:ACTIONS.specialised_object.upsert_knowledge_view_entry},connector$1L=connect(map_state$1J,map_dispatch$13);function _WComponentCanvasNodeBackgroundFrame(t){const{wcomponent_id:ee,kv_entry:te,is_editing:ne,frame_is_resizing:oe,knowledge_view_id:ie,set_frame_is_resizing:se}=t;if((te==null?void 0:te.frame_width)===void 0||(te==null?void 0:te.frame_height)===void 0)return null;const[re,_e]=h$1(void 0),[ae,ce]=h$1(void 0),le=pe=>fe=>{fe.stopImmediatePropagation(),fe.preventDefault(),se({frame_is_resizing:!0}),_e(pe)},ue=F$1(()=>le(!0),[]),de=F$1(()=>le(!1),[]);p$1(()=>pub_sub.canvas.sub("canvas_move",pe=>{if(re===void 0)return;const fe=re?te.frame_width:round_coordinate_small_step(pe.x-te.left+OFFSET_RIGHT),ge=re?round_coordinate_small_step(-pe.y-te.top+OFFSET_TOP):te.frame_height;ce({...te,frame_width:fe,frame_height:ge})})),p$1(()=>pub_sub.canvas.sub("canvas_pointer_up",()=>{!oe||!ie||ae&&(t.upsert_knowledge_view_entry({wcomponent_id:ee,knowledge_view_id:ie,entry:ae}),ce(void 0),se({frame_is_resizing:!1}),_e(void 0))}));const me=ae||te;return o$1("div",{className:"wcomponent_background_frame",style:{top:me.top-OFFSET_TOP,left:me.left-OFFSET_RIGHT,width:me.frame_width,height:me.frame_height,backgroundColor:color_to_string(me.frame_color||default_frame_color),borderColor:color_to_string(darker_color(me.frame_color||default_frame_color))},children:[ne&&o$1("div",{className:"editable_edge editable_edge_bottom",onPointerDown:ue}),ne&&o$1("div",{className:"editable_edge editable_edge_right",onPointerDown:de})]})}const WComponentCanvasNodeBackgroundFrame=connector$1L(_WComponentCanvasNodeBackgroundFrame),map_state$1I=(t,ee)=>{const{id:te}=ee,ne=t.global_keys.derived.shift_or_control_down,oe=is_on_current_knowledge_view(t,te),{current_composed_knowledge_view:ie}=t.derived,se=t.derived.composed_wcomponents_by_id[te],re=se&&ie&&se.base_id!==ie.base_id;let _e=!1;return ie&&(_e=!!(ie.active_judgement_or_objective_ids_by_target_id[te]||ie.active_judgement_or_objective_ids_by_goal_or_action_id[te])),{on_current_knowledge_view:oe,current_composed_knowledge_view:ie,derived_composed_wcomponent:se,kv_from_different_base:re,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t),composed_wcomponents_by_id:t.derived.composed_wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,is_current_item:t.routing.item_id===te,selected_wcomponent_ids_set:t.meta_wcomponents.selected_wcomponent_ids_set,is_highlighted:t.meta_wcomponents.highlighted_wcomponent_ids.has(te),shift_or_control_keys_are_down:ne,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,is_editing:!t.display_options.consumption_formatting,validity_filter:t.display_options.derived_validity_filter,certainty_formatting:t.display_options.derived_certainty_formatting,focused_mode:t.display_options.focused_mode,have_judgements:_e,node_is_moving:t.meta_wcomponents.wcomponent_ids_to_move_set.has(te),display_time_marks:t.display_options.display_time_marks,connected_neighbour_is_highlighted:t.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(te)}},map_dispatch$12={clicked_wcomponent:ACTIONS.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:ACTIONS.meta_wcomponents.clear_selected_wcomponents,change_route:ACTIONS.routing.change_route,set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,pointerupdown_on_component:ACTIONS.meta_wcomponents.pointerupdown_on_component,pointerupdown_on_connection_terminal:ACTIONS.meta_wcomponents.pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move:ACTIONS.meta_wcomponents.set_wcomponent_ids_to_move,request_searching_for_wcomponents_by_id_in_any_base:ACTIONS.sync.request_searching_for_wcomponents_by_id_in_any_base},connector$1K=connect(map_state$1I,map_dispatch$12);function _WComponentCanvasNode(t){const{id:ee,is_on_canvas:te=!0,always_show:ne=!1,is_editing:oe,derived_composed_wcomponent:ie,current_composed_knowledge_view:se,kv_from_different_base:re,wc_id_to_counterfactuals_map:_e,composed_wcomponents_by_id:ae,knowledge_views_by_id:ce,is_current_item:le,selected_wcomponent_ids_set:ue,is_highlighted:de,shift_or_control_keys_are_down:me,created_at_ms:pe,sim_ms:fe,validity_filter:ge,certainty_formatting:he,clicked_wcomponent:be,clear_selected_wcomponents:ve}=t,{change_route:ye,set_highlighted_wcomponent:we}=t;if(!se)return o$1("div",{children:"No current knowledge view"});p$1(()=>{ie||t.request_searching_for_wcomponents_by_id_in_any_base({ids:[ee]})},[!!ie]);const ke=se.composed_wc_id_map[ee];if(!ke&&!ne)return o$1("div",{children:["Could not find knowledge view entry for id ",ee]});const Ae=ke||{left:0,top:0},[$e,xe]=h$1(void 0);p$1(()=>{if(!t.node_is_moving)return;const Fe=pub_sub.canvas.sub("throttled_canvas_node_drag_relative_position",We=>{const Ne={...Ae};Ne.left+=We.left,Ne.top+=We.top,xe(Ne)});return()=>{xe(void 0),Fe()}},[t.node_is_moving]);const{wc_ids_excluded_by_filters:Ce}=se.filters,Se=ne||!ie?{display_certainty:1}:calc_wcomponent_should_display({wcomponent:ie,kv_entry:Ae,created_at_ms:pe,sim_ms:fe,validity_filter:ge,selected_wcomponent_ids_set:ue,wc_ids_excluded_by_filters:Ce});if(!Se)return null;const Ie=ue.has(ee),Pe=calc_display_opacity({is_editing:oe,certainty:Se.display_certainty,is_highlighted:de,connected_neighbour_is_highlighted:t.connected_neighbour_is_highlighted,is_selected:Ie,is_current_item:le,certainty_formatting:he,focused_mode:t.focused_mode}),Re=t.node_is_moving?.3:Pe,De=factory_on_click({wcomponent_id:ee,clicked_wcomponent:be,clear_selected_wcomponents:ve,shift_or_control_keys_are_down:me,change_route:ye,is_current_item:le}),Ve=t.node_is_moving?[]:[o$1(Handles,{show_move_handle:te&&oe&&de,user_requested_node_move:Fe=>{let We=new Set(ue);We.has(ee)||(We=new Set([ee]),t.clicked_wcomponent({id:ee})),start_moving_wcomponents(We,Fe)},wcomponent_id:ee,wcomponent_current_kv_entry:Ae,is_highlighted:de})],Le=ie?get_title$1({wcomponent:ie,wcomponents_by_id:ae,knowledge_views_by_id:ce,wc_id_to_counterfactuals_map:_e,created_at_ms:pe,sim_ms:fe}):"&lt;Not found&gt;",je=oe,He={transform:`scale(${Ae.s&&te?Ae.s:1})`},Ye=de?"orange":(Ie||le)&&"blue",Ue=get_wcomponent_color({wcomponent:ie,wcomponents_by_id:ae,sim_ms:fe,created_at_ms:pe,display_time_marks:t.display_time_marks}),Te=` wcomponent_canvas_node  wcomponent_${ee} `+(oe?t.on_current_knowledge_view?" node_on_kv ":" node_on_foundational_kv ":"")+(t.node_is_moving?" node_is_moving ":"")+(de?" node_is_highlighted ":"")+(le?" node_is_current_item ":"")+(Ie?" node_is_selected ":"")+(ie?` node_is_type_${ie.type} `:"")+(je?" compact_title ":"")+Ue.font+Ue.background;let Ee=!1,Be=!1;ie&&(Ee=wcomponent_can_have_validity_predictions(ie)&&oe||wcomponent_has_validity_predictions(ie)&&le,Be=oe&&wcomponent_is_allowed_to_have_state_VAP_sets(ie)||!ie.hide_state&&(wcomponent_has_legitimate_non_empty_state_VAP_sets(ie)||wcomponent_is_judgement_or_objective(ie)||wcomponent_has_objectives(ie)&&(ie.objective_ids||[]).length>0||t.have_judgements));const ze=ie?(oe||!ie.hide_state)&&wcomponent_is_sub_state(ie)&&ie:!1,Ut=get_terminals({is_on_canvas:te,is_editing:oe,is_highlighted:de}),Xe=Fe=>{Fe.stopImmediatePropagation(),Fe.preventDefault(),t.pointerupdown_on_component({up_down:"down",wcomponent_id:ee})},Qe=Fe=>{Fe.stopImmediatePropagation(),Fe.preventDefault(),t.pointerupdown_on_component({up_down:"up",wcomponent_id:ee})},Qt=(Fe,We)=>t.pointerupdown_on_connection_terminal({terminal_type:Fe,up_down:We,wcomponent_id:ee}),Wt=te?$e||Ae:void 0,en=F$1(()=>calculate_label_ids(ie),[ie]);return o$1("div",{children:[o$1(WComponentCanvasNodeBackgroundFrame,{wcomponent_id:ee,kv_entry:Wt}),o$1(ConnectableCanvasNode,{position:Wt,cover_image:ie==null?void 0:ie.summary_image,node_main_content:o$1("div",{children:[!(ie!=null&&ie.summary_image)&&o$1("div",{className:"background_image"}),o$1("div",{className:"node_title",children:[ke===void 0&&oe&&o$1("span",{children:[o$1(WarningTriangle,{message:"Missing from this knowledge view"})," "]}),re&&oe&&o$1("span",{children:[o$1(WarningTriangle,{message:"Is from a different base to this knowledge view"})," "]}),(oe||!(ie!=null&&ie.hide_title))&&o$1(Markdown,{options:{...MARKDOWN_OPTIONS,forceInline:!0},children:Le})]}),ie&&Ee&&o$1("div",{className:"node_validity_container",children:[oe&&o$1("div",{className:"description_label",children:"validity"}),o$1(WComponentValidityValue,{wcomponent:ie})]}),ie&&Be&&o$1("div",{className:"node_state_container",children:[oe&&o$1("div",{className:"description_label",children:"state  "}),o$1(WComponentJudgements,{wcomponent:ie,hide_judgement_trend:!1}),o$1("div",{className:"value_and_prediction_summary",children:o$1(NodeValueAndPredictionSetSummary,{wcomponent:ie,created_at_ms:pe,sim_ms:fe})})]}),ze&&o$1("div",{className:"node_sub_state_container",children:o$1("div",{className:"value_and_prediction_summary",children:o$1(NodeSubStateSummary,{wcomponent:ze,created_at_ms:pe,sim_ms:fe})})}),ze&&o$1(NodeSubStateTypeIndicators,{wcomponent:ze}),ie&&oe&&o$1("div",{className:"description_label",children:wcomponent_type_to_text(ie.type)}),o$1("div",{style:{display:"flex"},title:ie!=null&&ie.description.trim()?"Further details are included":void 0,children:[(ie==null?void 0:ie.description.trim())&&o$1(default_1$y,{className:"description_icon",fontSize:"small",color:"disabled"}),ie&&o$1(LabelsListV2,{label_ids:en})]})]}),extra_css_class:Te,extra_styles_for_node_main_content:He,opacity:Re,unlimited_width:!1,glow:Ye,on_click:De,on_pointer_enter:()=>we({id:ee,highlighted:!0}),on_pointer_leave:()=>we({id:ee,highlighted:!1}),terminals:Ut,on_pointer_down:Xe,on_pointer_up:Qe,pointerupdown_on_connection_terminal:Qt,other_children:Ve})]})}const WComponentCanvasNode=connector$1K(_WComponentCanvasNode),no_terminals=[],terminals_with_label=[];connection_terminal_attributes.forEach(t=>{connection_terminal_directions.forEach(ee=>{const te={attribute:t,direction:ee},ne=get_top_left_for_terminal_type(te),oe=te.attribute.slice(0,1).toUpperCase();terminals_with_label.push({type:te,style:ne,label:oe})})});function get_terminals(t){return!t.is_on_canvas||!t.is_editing||!t.is_highlighted?no_terminals:terminals_with_label}function get_wcomponent_color(t){let ee="",te="";const{wcomponent:ne,created_at_ms:oe,sim_ms:ie}=t;if(!ne)return{background:" node_missing ",font:te};if(wcomponent_is_action(ne)){const se=get_wcomponent_state_value_and_probabilities({wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:oe,sim_ms:ie}),re=se.most_probable_VAP_set_values[0];se.any_uncertainty?ee=" past_uncertain ":re&&(re.value_id===ACTION_VALUE_POSSIBILITY_ID.action_completed||re.value_id===ACTION_VALUE_POSSIBILITY_ID.action_failed||re.value_id===ACTION_VALUE_POSSIBILITY_ID.action_rejected)&&(ee=" past_certain ",te=" color_light ")}else{const se=get_current_temporal_value_certainty_from_wcomponent(ne.id,t.wcomponents_by_id,oe);if(se){const{temporal_uncertainty:re,certainty:_e}=se,ae=get_uncertain_datetime(re);ae&&ae.getTime()<ie?_e===1||_e===void 0?(ee=" past_certain ",te=" color_light "):ee=" past_uncertain ":ae||(_e===1||_e===void 0)&&(ee=" past_certain ",te=" color_light ")}}return{background:ee,font:te}}function calculate_label_ids(t){if(!t)return[];const ee=[...t.label_ids||[]],te=new Set(ee);return wcomponent_is_action(t)&&t.parent_goal_or_action_ids&&t.parent_goal_or_action_ids.forEach(ne=>{te.has(ne)||(ee.push(ne),te.add(ne))}),ee}const Canvas$1="",SelectionBox$1="";function SelectionBox(t){const{canvas_start_x:ee,canvas_start_y:te,canvas_end_x:ne,canvas_end_y:oe}=t,ie={left:ee,top:-oe,width:ne-ee,height:oe-te};return o$1("div",{className:`selection_box color_${t.color}`,style:ie})}const GRAPH_CONTAINER_ID="graph_container",GRAPH_VISUALS_CONTAINER_ID="graph_visuals_container",MAX_DOUBLE_TAP_DELAY_MS=900,MAX_DOUBLE_TAP_XY_PIXEL_MOVEMENT=10,map_state$1H=t=>{const{x:ee,y:te,zoom:ne}=t.routing.args,oe=t.global_keys.keys_down.has("Shift"),ie=t.global_keys.keys_down.has("Control");return{zoom:ne,x:ee,y:te,shift_key_down:oe,control_key_down:ie}},map_dispatch$11=t=>({change_routing_args:ee=>{let te={};ee.zoom!==void 0&&(te.zoom=Math.round(bound_zoom(ee.zoom))),ee.x!==void 0&&(te.x=Math.round(ee.x)),ee.y!==void 0&&(te.y=Math.round(ee.y)),t(ACTIONS.routing.change_route({args:te}))}}),connector$1J=connect(map_state$1H,map_dispatch$11);class _Canvas extends b$1{constructor(te){super(te);Oe(this,"manual_zoom_target");Oe(this,"client_to_canvas",te=>client_to_canvas(this.props.zoom,te));Oe(this,"client_to_canvas_x",te=>client_to_canvas_x(this.props.x,this.props.zoom,te));Oe(this,"client_to_canvas_y",te=>client_to_canvas_y(this.props.y,this.props.zoom,te));Oe(this,"on_pointer_down",te=>{if(pub_sub.canvas.pub("canvas_pointer_down",!0),te.button===2)return;const oe=te.offsetX,ie=te.offsetY,se={down:!0,area_select:this.props.shift_key_down,last_pointer_down_ms:new Date().getTime(),canvas_start_x:this.client_to_canvas_x(oe),canvas_start_y:this.client_to_canvas_y(ie),x_when_pointer_down:this.props.x,y_when_pointer_down:this.props.y,client_start_x:oe,client_start_y:ie};handle_if_double_tap({zoom:this.props.zoom,current_pointer_state:this.state.pointer_state,new_pointer_state:se}),this.setState({pointer_state:se,canvas_current_x:se.canvas_start_x,canvas_current_y:se.canvas_start_y})});Oe(this,"on_pointer_up",te=>{if(te==null||te.preventDefault(),pub_sub.canvas.pub("canvas_pointer_up",!0),this.state.pointer_state.area_select){const oe=area_selection_args(this.state),ie={start_x:oe.canvas_start_x,start_y:oe.canvas_start_y,end_x:oe.canvas_end_x,end_y:oe.canvas_end_y};pub_sub.canvas.pub("canvas_area_select",ie)}const ne={...this.state.pointer_state,down:!1,area_select:!1};this.setState({pointer_state:ne,canvas_current_x:void 0,canvas_current_y:void 0})});Oe(this,"on_pointer_leave",()=>{this.state.pointer_state.area_select||this.on_pointer_up()});Oe(this,"on_pointer_move",te=>{if(pub_sub.canvas.pub("canvas_move",{x:this.client_to_canvas_x(te.offsetX),y:this.client_to_canvas_y(te.offsetY)}),!this.state.pointer_state.down)return;const ne=te.offsetX,oe=te.offsetY;if(this.state.pointer_state.area_select){const ie=this.client_to_canvas_x(ne),se=this.client_to_canvas_y(oe);this.setState({canvas_current_x:ie,canvas_current_y:se})}else{const ie=this.state.pointer_state.client_start_x-ne,se=this.state.pointer_state.client_start_y-oe,re=this.state.pointer_state.x_when_pointer_down+this.client_to_canvas(ie),_e=this.state.pointer_state.y_when_pointer_down-this.client_to_canvas(se);this.props.change_routing_args({x:re,y:_e})}});Oe(this,"on_wheel",te=>{te.stopPropagation(),te.preventDefault();const ne=te.deltaY,oe=calculate_new_zoom({zoom:this.props.zoom,wheel_change:ne});if(oe===this.props.zoom)return;const ie=this.props.zoom/SCALE_BY,{pointer_x:se,pointer_y:re}=get_pointer_position(te,this.props,ie),{offsetHeight:_e,offsetWidth:ae}=te.currentTarget,ce=calculate_new_zoom_xy({old:this.props,new_zoom:oe,pointer_x:se,pointer_y:re,client_height:_e,client_width:ae});this.props.change_routing_args({zoom:oe,x:ce.x,y:ce.y}),this.manual_zoom_target=oe});Oe(this,"on_context_menu",te=>{te.stopPropagation(),te.preventDefault();const ne=this.client_to_canvas_x(te.offsetX),oe=this.client_to_canvas_y(te.offsetY);te.button===2&&pub_sub.canvas.pub("canvas_right_click",{x:ne,y:oe})});this.state={pointer_state:{down:!1,area_select:!1,last_pointer_down_ms:void 0,canvas_start_x:void 0,canvas_start_y:void 0,x_when_pointer_down:void 0,y_when_pointer_down:void 0,client_start_x:void 0,client_start_y:void 0},canvas_current_x:void 0,canvas_current_y:void 0}}render(){const{zoom:te}=this.props,ne=te/SCALE_BY,oe=-1*this.props.x*ne,ie=this.props.y*ne,se=grid_small_step*ne,re=this.state.pointer_state.down,_e=this.manual_zoom_target===te;this.manual_zoom_target=void 0;const ae=re?0:_e?.1:1,ce={transition:`background-position ${ae}s, background-size ${ae}s`,backgroundPosition:`${oe}px ${ie}px`,backgroundSize:`${se}px ${se}px`},le={transition:`background-position ${ae}s, background-size ${ae}s`,backgroundPosition:`${oe}px ${ie}px`,backgroundSize:`${h_step*ne}px ${v_step*ne}px`},ue={transition:`transform ${ae}s`,transform:`translate(${oe}px,${ie}px)`},de={transition:`transform ${ae}s`,transformOrigin:"left top",transform:`scale(${ne})`},me=(this.props.plain_background?"":"squared_background ")+(this.state.pointer_state.down?"graph_background_pointer_down ":"");return o$1("div",{style:{flexGrow:1},className:this.props.extra_class_names,children:o$1("div",{id:GRAPH_CONTAINER_ID,className:me,style:ce,onPointerDown:this.on_pointer_down,onPointerMove:this.on_pointer_move,onPointerUp:this.on_pointer_up,onPointerLeave:this.on_pointer_leave,onWheel:this.on_wheel,onDragOver:pe=>{pe.preventDefault(),pe.dataTransfer.dropEffect="move"},onContextMenu:this.on_context_menu,children:[!this.props.plain_background&&this.props.show_large_grid&&o$1("div",{className:"big_squared_background",style:le}),o$1("div",{id:GRAPH_VISUALS_CONTAINER_ID,style:ue,children:o$1("div",{style:de,children:[o$1("div",{id:"graph_lowest_elements_container",children:[o$1("svg",{style:{zIndex:0,position:"absolute",top:0,left:0},children:[blur_filter_defs,this.props.svg_children]}),this.props.children,o$1("svg",{style:{zIndex:2,position:"absolute",top:0,left:0},children:[blur_filter_defs,this.props.svg_upper_children]})]}),this.state.pointer_state.area_select&&o$1(SelectionBox,{...area_selection_args(this.state),color:this.props.control_key_down?"red":"blue"})]})}),o$1("div",{children:this.props.overlay})]})})}}const Canvas=connector$1J(_Canvas),blur_filter_defs=o$1("defs",{children:Array.from(Array(101)).map((t,ee)=>o$1("filter",{id:"blur_filter_"+ee,x:"0",y:"0",children:o$1("feGaussianBlur",{in:"SourceGraphic",stdDeviation:ee/20})}))});function handle_if_double_tap(t){const{zoom:ee,current_pointer_state:te,new_pointer_state:ne}=t;if(!te.last_pointer_down_ms||!ne.last_pointer_down_ms||ne.last_pointer_down_ms-te.last_pointer_down_ms>MAX_DOUBLE_TAP_DELAY_MS)return;const{canvas_start_x:ie,canvas_start_y:se}=te,{canvas_start_x:re,canvas_start_y:_e}=ne;if(ie===void 0||se===void 0||re===void 0||_e===void 0)return;const ae=Math.abs(ie-re),ce=Math.abs(se-_e),le=MAX_DOUBLE_TAP_XY_PIXEL_MOVEMENT/ee;ae>le||ce>le||pub_sub.canvas.pub("canvas_double_tap",{x:ie,y:se})}function area_selection_args(t){const ee=t.pointer_state.canvas_start_x||0,te=t.pointer_state.canvas_start_y||0,ne=t.canvas_current_x||0,oe=t.canvas_current_y||0;return{canvas_start_x:Math.min(ee,ne),canvas_start_y:Math.min(te,oe),canvas_end_x:Math.max(ee,ne),canvas_end_y:Math.max(te,oe)}}function get_pointer_position(t,ee,te){let ne=t.offsetX,oe=t.offsetY,ie=t.target;if((ie==null?void 0:ie.id)!==GRAPH_CONTAINER_ID){for(;ie&&ie.id!==GRAPH_VISUALS_CONTAINER_ID;)ne+=ie.offsetLeft||0,oe+=ie.offsetTop||0,ie=ie.parentElement;ne-=ee.x,oe+=ee.y,ne*=te,oe*=te,ne=Math.round(ne),oe=Math.round(oe)}return{pointer_x:ne,pointer_y:oe}}const MainArea$1="";function get_wcomponent_time_slider_data(t){const ee=[],te=new Set,ne=[],oe=new Set;let ie=Number.POSITIVE_INFINITY,se=Number.NEGATIVE_INFINITY;function re(ue,de){if(!ue)return;const me=ue.getTime();de!=="sim"&&!te.has(me)&&ee.push({datetime:ue,type:de}),de!=="created"&&!oe.has(me)&&ne.push({datetime:ue,type:de}),ie=Math.min(ie,ue.getTime()),se=Math.max(se,ue.getTime())}function _e(ue){re(ue.min,"sim"),re(ue.value,"sim"),re(ue.max,"sim")}t.forEach(ue=>{re(ue.custom_created_at||ue.created_at,"created"),wcomponent_has_validity_predictions(ue)&&ue.validity.forEach(({created_at:de,custom_created_at:me,datetime:pe})=>{re(me||de,"created"),_e(pe)}),wcomponent_has_existence_predictions(ue)&&ue.existence.forEach(({created_at:de,custom_created_at:me,datetime:pe})=>{re(me||de,"created"),_e(pe)}),wcomponent_has_VAP_sets(ue)&&ue.values_and_prediction_sets.forEach(({created_at:de,custom_created_at:me,datetime:pe})=>{re(me||de,"created"),_e(pe)}),wcomponent_has_event_at(ue)&&ue.event_at.forEach(({datetime:de})=>{_e(de)})});const ae=new Date;ee.length===0&&re(ae,"created");const ce=ie,le=se;return["created","sim"].forEach(ue=>{re(new Date(ce),ue),re(new Date(le),ue),re(new Date(ce-864e5),ue),re(new Date(le+864e5),ue)}),ee.sort(sort_by_datetime),ne.sort(sort_by_datetime),{created_events:ee,sim_events:ne}}function sort_by_datetime({datetime:t},{datetime:ee}){return t.getTime()<ee.getTime()?-1:1}var Tune={},_interopRequireDefault$s=interopRequireDefaultExports;Object.defineProperty(Tune,"__esModule",{value:!0});var default_1$s=Tune.default=void 0,_createSvgIcon$s=_interopRequireDefault$s(requireCreateSvgIcon()),_jsxRuntime$s=requireJsxRuntime(),_default$s=(0,_createSvgIcon$s.default)((0,_jsxRuntime$s.jsx)("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"}),"Tune");default_1$s=Tune.default=_default$s;var DoubleArrow={},_interopRequireDefault$r=interopRequireDefaultExports;Object.defineProperty(DoubleArrow,"__esModule",{value:!0});var default_1$r=DoubleArrow.default=void 0,_createSvgIcon$r=_interopRequireDefault$r(requireCreateSvgIcon()),_jsxRuntime$r=requireJsxRuntime(),_default$r=(0,_createSvgIcon$r.default)([(0,_jsxRuntime$r.jsx)("path",{d:"M15.5 5H11l5 7-5 7h4.5l5-7z"},"0"),(0,_jsxRuntime$r.jsx)("path",{d:"M8.5 5H4l5 7-5 7h4.5l5-7z"},"1")],"DoubleArrow");default_1$r=DoubleArrow.default=_default$r;const ContentControls$1="";function calculate_if_components_on_screen(t){let ee;const te=get_current_composed_knowledge_view_from_state(t);if(te){const{composed_visible_wc_id_map:ne,wc_ids_by_type:oe}=te,{x:ie,y:se,zoom:re}=t.routing.args,_e=SCALE_BY/re,ae=ie+get_screen_width(t.controls.display_side_panel)*_e,ce=se-TOP_HEADER_FUDGE*_e,le=get_actually_display_time_sliders(t),ue=ce-get_visible_screen_height(le)*_e;ee=!!Array.from(oe.any_node).find(de=>{const me=ne[de];if(!me)return!1;const{left:pe,top:fe}=me;return pe>=ie&&pe<=ae&&-fe<=ce&&-fe>=ue})}return ee}var FilterCenterFocus={},_interopRequireDefault$q=interopRequireDefaultExports;Object.defineProperty(FilterCenterFocus,"__esModule",{value:!0});var default_1$q=FilterCenterFocus.default=void 0,_createSvgIcon$q=_interopRequireDefault$q(requireCreateSvgIcon()),_jsxRuntime$q=requireJsxRuntime(),_default$q=(0,_createSvgIcon$q.default)((0,_jsxRuntime$q.jsx)("path",{d:"M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"}),"FilterCenterFocus");default_1$q=FilterCenterFocus.default=_default$q;function MoveToItemButton(t){const{move:ee,draw_attention:te,have_finished_drawing_attention:ne=()=>{}}=t;return p$1(()=>{if(t.enable_spacebar_move_to_shortcut)return pub_sub.global_keys.sub("key_down",oe=>{ee&&oe.key===" "&&ee()})},[t.enable_spacebar_move_to_shortcut,ee]),o$1(Box,{children:[o$1(Tooltip,{placement:"top",title:ee?"Move to component(s)":"No component(s) present",children:o$1("span",{children:o$1(IconButton,{size:"medium",onClick:ee,disabled:!ee,children:o$1(default_1$q,{})})})}),o$1("div",{className:ee&&te?"pulsating_circle":"",ref:oe=>setTimeout(()=>{oe==null||oe.classList.remove("pulsating_circle"),ne()},1e4)})]})}const map_state$1G=(t,ee)=>{const te=ee.wcomponent_id||t.routing.item_id||"";let ne;return ee.allow_drawing_attention&&(ne=calculate_if_components_on_screen(t)),{initial_wcomponent_id:te,created_at_ms:t.routing.args.created_at_ms,components_on_screen:ne,current_composed_knowledge_view:get_current_composed_knowledge_view_from_state(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,selected_wcomponent_ids_set:t.meta_wcomponents.selected_wcomponent_ids_set,display_side_panel:t.controls.display_side_panel,display_time_sliders:get_actually_display_time_sliders(t)}},map_dispatch$10={move:(t,ee)=>ACTIONS.routing.change_route({args:{created_at_ms:t,...ee}})},connector$1I=connect(map_state$1G,map_dispatch$10);function _MoveToWComponentButton(t){const{components_on_screen:ee,have_finished_drawing_attention:te,current_composed_knowledge_view:ne,wcomponents_by_id:oe,initial_wcomponent_id:ie,selected_wcomponent_ids_set:se,created_at_ms:re,disable_if_not_present:_e,display_side_panel:ae,display_time_sliders:ce}=t,{positions_no_sidepanel_or_timesliders:le,positions_sidepanel_no_timesliders:ue,positions_timesliders_no_sidepanel:de,positions_with_sidepanel_or_timesliders:me,go_to_datetime_ms:pe}=F$1(()=>calculate_all_display_combinations_of_spatial_temporal_position_to_move_to({current_composed_knowledge_view:ne,wcomponents_by_id:oe,initial_wcomponent_id:ie,selected_wcomponent_ids_set:se,created_at_ms:re,disable_if_not_present:_e}),[ne,oe,ie,se,re,_e]),fe=ae||ce?ae&&ce?me:ae?ue:de:le;let ge=0;const he=fe.length===0?void 0:()=>{let ve=fe[ge++];ve||(ge=0,ve=fe[ge++]),t.move(pe,ve)},be=t.allow_drawing_attention&&fe.length>0&&!ee;return o$1(MoveToItemButton,{move:he,draw_attention:be,have_finished_drawing_attention:te,enable_spacebar_move_to_shortcut:!t.wcomponent_id})}const MoveToWComponentButton=connector$1I(_MoveToWComponentButton);var NavigateBefore={},_interopRequireDefault$p=interopRequireDefaultExports;Object.defineProperty(NavigateBefore,"__esModule",{value:!0});var default_1$p=NavigateBefore.default=void 0,_createSvgIcon$p=_interopRequireDefault$p(requireCreateSvgIcon()),_jsxRuntime$p=requireJsxRuntime(),_default$p=(0,_createSvgIcon$p.default)((0,_jsxRuntime$p.jsx)("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore");default_1$p=NavigateBefore.default=_default$p;var NavigateNext={},_interopRequireDefault$o=interopRequireDefaultExports;Object.defineProperty(NavigateNext,"__esModule",{value:!0});var default_1$o=NavigateNext.default=void 0,_createSvgIcon$o=_interopRequireDefault$o(requireCreateSvgIcon()),_jsxRuntime$o=requireJsxRuntime(),_default$o=(0,_createSvgIcon$o.default)((0,_jsxRuntime$o.jsx)("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext");default_1$o=NavigateNext.default=_default$o;const time_slider="",Editable="";function date_to_string(t){const{date:ee,time_resolution:te,trim_midnight:ne}=t;return ee&&valid_date(ee)?date2str_auto({date:ee,time_resolution:te,trim_midnight:ne}):""}function uncertain_date_to_string(t,ee){let te="Eternal";if(!uncertain_datetime_is_eternal(t)){const ne=date_to_string({date:t.min,time_resolution:ee}),oe=date_to_string({date:t.value,time_resolution:ee}),ie=date_to_string({date:t.max,time_resolution:ee});if(oe&&!ne&&!ie)return oe;te=[ne,ne?" ":"","<",oe?" ":"",oe,oe?" ":"","<",ie?" ":"",ie].filter(re=>re).join("")}return te}function valid_date(t){return!Number.isNaN(t.getTime())}function correct_datetime_for_local_time_zone(t){const ee=new Date(t);return valid_date(ee)?ee:void 0}const test_correct_datetime_for_local_time_zone=describe("correct_datetime_for_local_time_zone",()=>{let t;t=correct_datetime_for_local_time_zone("2021-04-16 15:00"),test(t&&t.toISOString(),"2021-04-16T14:00:00.000Z","Subtracts one hour (during summer time BST, will this fail during GMT?)"),t=correct_datetime_for_local_time_zone("2021-04-16 00:00"),test(t&&t.toISOString(),"2021-04-15T23:00:00.000Z","Subtracts one hour, goes back one day (during summer time BST, will this fail during GMT?)"),t=correct_datetime_for_local_time_zone("2021-04-16"),test.skip(t&&t.toISOString(),"2021-04-15T23:00:00.000Z")},!1),Button$1="";function Button(t){return o$1(Hidden,{xsUp:t.is_hidden,children:o$1(Button$2,{className:t.className,title:t.title,color:t.color||"primary",style:{...t.style,pointerEvents:"initial"},component:t.component,disabled:t.disabled||!1,disableElevation:t.disableElevation||!0,disableFocusRipple:t.disableFocusRipple||!1,endIcon:t.endIcon,fullWidth:t.fullWidth||!1,href:t.href,size:t.size||"small",startIcon:t.startIcon,variant:t.variant||"contained",onPointerDown:ee=>{ee.currentTarget.focus(),ee.stopImmediatePropagation(),ee.preventDefault(),t.onPointerDown&&t.onPointerDown(ee)},onClick:ee=>{ee.currentTarget.focus(),ee.stopImmediatePropagation(),ee.preventDefault(),t.onClick&&t.onClick(ee)},children:t.children||t.value})})}function find_parent_element_by_class(t,ee){for(;t;){const{classList:te}=t;if(te&&te.contains(ee))break;t=t.parentElement}return t}function find_parent_element_by_classes(t,ee){for(;t;){const{classList:te}=t;if(te&&ee.find(ne=>te.contains(ne)))break;t=t.parentElement}return t}const map_state$1F=t=>({time_resolution:t.display_options.time_resolution,presenting:t.display_options.consumption_formatting}),connector$1H=connect(map_state$1F);function _EditableCustomDateTime(t){const ee=props_to_str_value(t),[te,ne]=h$1(!1),oe=ee?"":"no_entry",{on_change:ie}=t;if(!ie)return o$1("div",{className:oe,children:ee});const{invariant_value:se,show_now_shortcut_button:re=!1,show_today_shortcut_button:_e=!0}=t,ae=is_value_valid(ee),ce=t.editing_allowed!==void 0?!t.editing_allowed:t.presenting,le=`editable_field ${ae?"":"invalid"} ${oe} ${ce?"not_editable":""}`,ue=(t.title||"DateTime")+(t.invariant_value&&t.value?" (custom)":"");function de(fe){ie&&diff_value(t.value,fe)&&ie(fe)}const me=_$d(void 0),pe=_$d(de);return pe.current=de,p$1(()=>()=>{if(!me.current||!(document.activeElement===me.current))return;const ge=handle_on_blur({working_value:me.current.value,invariant_value:se});pe.current(ge)},[]),o$1("div",{className:le,title:ue,children:[o$1(TextField,{disabled:ce,type:"text",label:ue,value:ee,onFocus:()=>ne(!0),inputRef:fe=>{if(!fe||(me.current=fe,!te))return;const ge=props_value(t),he=date_to_string({date:ge,time_resolution:"minute",trim_midnight:!1});fe.value=he,fe.setSelectionRange(0,fe.value.length)},onKeyDown:fe=>{var be;const ge=fe.key==="Enter",he=fe.key==="Escape";(ge||he)&&((be=fe.target)==null||be.blur())},onChange:fe=>{const ge=is_value_valid(fe.currentTarget.value),he=find_parent_element_by_class(fe.currentTarget,"editable_field");he&&(ge?he.classList.remove("invalid"):he.classList.add("invalid"))},onBlur:fe=>{const ge=fe.currentTarget.value,he=handle_on_blur({working_value:ge,invariant_value:se});de(he),ne(!1)},size:"small",variant:"outlined",fullWidth:!0}),te&&re&&o$1(NowButton$1,{on_change:de}),te&&_e&&o$1(Button,{value:"Today",onPointerDown:()=>{const fe=get_today_str();de(new Date(fe))}})]})}const EditableCustomDateTime=connector$1H(_EditableCustomDateTime);function is_value_valid(t){if(!t.trim())return!0;const ee=correct_datetime_for_local_time_zone(t);return!!ee&&valid_date(ee)}function NowButton$1(t){return o$1(Button,{value:"Now",onClick:()=>{const ee=new Date(new Date().getTime()+3e4),te=date2str(ee,"yyyy-MM-dd hh:mm");t.on_change(new Date(te))}})}function props_value(t){return t.value||t.invariant_value}function diff_value(t,ee){const te=t==null?void 0:t.getTime(),ne=ee==null?void 0:ee.getTime();return te!==ne}function props_to_str_value(t){const ee=props_value(t);return date_to_string({date:ee,time_resolution:t.time_resolution})}function handle_on_blur(t){const{working_value:ee,invariant_value:te}=t;let ne=correct_datetime_for_local_time_zone(ee);return ne&&ne.getTime()===(te&&te.getTime())&&(ne=void 0),ne}const test_handle_on_blur=describe("handle_on_blur",()=>{let t,ee,te;t=void 0,ee="2020-01-01",te=handle_on_blur({invariant_value:t,working_value:ee}),test(te==null?void 0:te.getTime(),new Date("2020-01-01T00:00:00.000Z").getTime()),t=void 0,ee="2021-04-25 08:37",te=handle_on_blur({invariant_value:t,working_value:ee}),test(te==null?void 0:te.getTime(),new Date("2021-04-25T07:37:00.000Z").getTime())},!1);function find_index_in_sorted_list(t,ee,te){let ne=0,oe=t.length-1;for(;ne<=oe;){let ie=Math.floor((ne+oe)/2);const se=ee(t[ie]);if(se===te)return ie;se<te?ne=ie+1:oe=ie-1}return-1}function find_nearest_index_in_sorted_list(t,ee,te){let ne=0,oe=t.length-1;for(;ne<=oe;){let ie=Math.floor((ne+oe)/2);const se=ee(t[ie]);if(se===te)return{index:ie,exact:!0,bounds:"in"};if(se<te?ne=ie+1:oe=ie-1,ne>oe){const re=oe===-1?"lower":ne===t.length?"higher":"in";return{index:re==="lower"?-.5:re==="higher"?t.length-.5:se<te?ie+.5:ie-.5,exact:!1,bounds:re}}}return{index:-1,exact:!1,bounds:"n/a"}}const test_binary_search_functions=describe("binary search functions",()=>{let t=find_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3);test(t,2),t=find_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3.5),test(t,-1);let ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3);test(ee,{index:2,exact:!0,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,0),test(ee,{index:-.5,exact:!1,bounds:"lower"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,1.5),test(ee,{index:.5,exact:!1,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,2.5),test(ee,{index:1.5,exact:!1,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,3.5),test(ee,{index:2.5,exact:!1,bounds:"in"}),ee=find_nearest_index_in_sorted_list([1,2,3,4,5,6,7,8,9],te=>te,9.5),test(ee,{index:8.5,exact:!1,bounds:"higher"})},!1);function NowButton(t){return o$1(Button,{title:t.title,value:"Now",onClick:()=>{const ee=new Date().getTime()+6e4;t.change_datetime_ms(ee)},is_left:!0})}const map_state$1E=(t,{get_handle_ms:ee})=>({handle_datetime_ms:ee(t),time_resolution:t.display_options.time_resolution}),connector$1G=connect(map_state$1E);function _TimeSlider(t){const ee=t.events.map(re=>{let _e=re.datetime.getTime();return _e=floor_mseconds_to_resolution(_e,t.time_resolution),_e}),te=ee[0],ne=ee[ee.length-1],oe=find_nearest_index_in_sorted_list(ee,re=>re,t.handle_datetime_ms);function ie(re){typeof re=="number"&&t.change_handle_ms(re)}function se(re){return()=>{let _e=oe.index+re;oe.exact||(re===1?_e=Math.ceil(oe.index):_e=Math.floor(oe.index));let ae=ee[_e];for(;ae===t.handle_datetime_ms;)_e+=re,ae=ee[_e];ae&&t.change_handle_ms(ae)}}return o$1(Box,{className:"time_slider",my:2,px:5,children:[o$1(Box,{className:"slider_container",display:"flex",children:[o$1(ButtonGroup,{size:"small",children:[o$1(IconButton,{onClick:se(-1),disabled:oe.bounds==="n/a"||oe.index<=0,title:"Previous "+t.title+" datetime",size:"large",children:o$1(default_1$p,{})}),o$1(IconButton,{onClick:se(1),disabled:oe.bounds==="n/a"||oe.index>=ee.length-1,title:"Next "+t.title+" datetime",size:"large",children:o$1(default_1$o,{})})]}),o$1(Box,{flexGrow:1,title:t.title+" datetimes",children:o$1(Slider,{onChange:(re,_e)=>ie(_e),color:"secondary",value:t.handle_datetime_ms,getAriaValueText:value_text,valueLabelFormat:get_value_label_format,step:1,min:te,max:ne,valueLabelDisplay:"auto",marks:ee.map(re=>({value:re,label:""}))})})]}),o$1(Box,{display:"flex",justifyContent:"flex-end",alignItems:"center",children:[o$1(EditableCustomDateTime,{title:t.title,value:new Date(t.handle_datetime_ms),on_change:re=>re&&t.change_handle_ms(re.getTime()),show_now_shortcut_button:!1,show_today_shortcut_button:!1,editing_allowed:!0}),o$1(NowButton,{title:"Set "+t.title+" to now",change_datetime_ms:re=>t.change_handle_ms(re)})]})]})}const TimeSlider=connector$1G(_TimeSlider),value_text=t=>`${t}`,get_value_label_format=t=>{const ee=date2str_auto({date:new Date(t),time_resolution:"minute"});return o$1("span",{style:{whiteSpace:"nowrap"},children:ee})},invert_disabled_appearance=makeStyles(t=>({inverse_disabled:{color:t.palette.text.disabled,"&.Mui-disabled":{color:t.palette.text.primary,pointerEvents:"auto"}}}));var Filter={},_interopRequireDefault$n=interopRequireDefaultExports;Object.defineProperty(Filter,"__esModule",{value:!0});var default_1$n=Filter.default=void 0,_createSvgIcon$n=_interopRequireDefault$n(requireCreateSvgIcon()),_jsxRuntime$n=requireJsxRuntime(),_default$n=(0,_createSvgIcon$n.default)((0,_jsxRuntime$n.jsx)("path",{d:"m15.96 10.29-2.75 3.54-1.96-2.36L8.5 15h11l-3.54-4.71zM3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"Filter");default_1$n=Filter.default=_default$n;const active_warning_styles=makeStyles(t=>({warning_button:{cursor:"help"},warning_icon:{color:t.palette.warning.main}})),map_state$1D=t=>{var ne;const{wc_ids_excluded_by_created_at_datetime_filter:ee,vap_set_number_excluded_by_created_at_datetime_filter:te=0}=((ne=get_current_composed_knowledge_view_from_state(t))==null?void 0:ne.filters)||{};return{components:(ee==null?void 0:ee.size)||0,vap_sets:te}},map_dispatch$$={set_display_time_sliders:ACTIONS.controls.set_display_time_sliders},connector$1F=connect(map_state$1D,map_dispatch$$);function _ActiveCreatedAtFilterWarning(t){const{components:ee,vap_sets:te}=t;if(ee+te===0)return null;const ne=active_warning_styles();let oe=ee?`${ee} components are invisible `:"";return ee&&te&&(oe+="and "),oe+=te?`${te} predictions are invisible `:"",oe+="due to created at datetime filter",o$1(Tooltip,{placement:"top",title:oe,children:o$1(IconButton,{className:ne.warning_button,component:"span",onClick:()=>t.set_display_time_sliders(!0),size:"small",children:o$1(default_1$n,{className:ne.warning_icon})})})}const ActiveCreatedAtFilterWarning=connector$1F(_ActiveCreatedAtFilterWarning),map_state$1C=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=(ee&&ee.composed_datetime_line_config.time_origin_ms)!==void 0,ne=get_current_knowledge_view_from_state(t);return{display_time_marks:t.display_options.display_time_marks,sim_ms:t.routing.args.sim_ms,time_origin_ms_present:te,current_kv:ne,presenting:t.display_options.consumption_formatting}},map_dispatch$_={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view,set_display_time_marks:ACTIONS.display.set_display_time_marks},connector$1E=connect(map_state$1C,map_dispatch$_);function _ToggleDatetimeMarkers(t){const{display_time_marks:ee,time_origin_ms_present:te,current_kv:ne,presenting:oe}=t;return oe&&!te?null:o$1(Box,{component:"label",children:o$1(ButtonGroup,{disableElevation:!0,variant:"contained",value:ee,children:o$1(Button$2,{onClick:()=>{const ie=!ee;if(ie&&!te&&ne){const se=get_store(),re=get_middle_of_screen(se.getState()).left,_e={...ne,datetime_line_config:{...ne.datetime_line_config,time_origin_ms:t.sim_ms,time_origin_x:re}};t.upsert_knowledge_view({knowledge_view:_e})}t.set_display_time_marks(ie)},"aria-label":"Toggle displaying time markers",children:[ee?"Hide":"Show"+(te?"":" (Set)")," time"]})})})}const ToggleDatetimeMarkers=connector$1E(_ToggleDatetimeMarkers);var FilterNone={},_interopRequireDefault$m=interopRequireDefaultExports;Object.defineProperty(FilterNone,"__esModule",{value:!0});var default_1$m=FilterNone.default=void 0,_createSvgIcon$m=_interopRequireDefault$m(requireCreateSvgIcon()),_jsxRuntime$m=requireJsxRuntime(),_default$m=(0,_createSvgIcon$m.default)((0,_jsxRuntime$m.jsx)("path",{d:"M3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"FilterNone");default_1$m=FilterNone.default=_default$m;const map_state$1B=t=>({apply_filter:t.filter_context.apply_filter}),map_dispatch$Z={change_route:ACTIONS.routing.change_route},connector$1D=connect(map_state$1B,map_dispatch$Z);function _ActiveFilterWarning(t){const{apply_filter:ee}=t,te=active_warning_styles();return ee?o$1(Tooltip,{placement:"top",title:"A filter is in place which could result in components being hidden",children:o$1(IconButton,{className:te.warning_button,component:"span",size:"small",onClick:()=>t.change_route({route:"filter"}),children:o$1(default_1$m,{className:te.warning_icon})})}):null}const ActiveFilterWarning=connector$1D(_ActiveFilterWarning);var PhotoFilter={},_interopRequireDefault$l=interopRequireDefaultExports;Object.defineProperty(PhotoFilter,"__esModule",{value:!0});var default_1$l=PhotoFilter.default=void 0,_createSvgIcon$l=_interopRequireDefault$l(requireCreateSvgIcon()),_jsxRuntime$l=requireJsxRuntime(),_default$l=(0,_createSvgIcon$l.default)((0,_jsxRuntime$l.jsx)("path",{d:"M19.02 10v9H5V5h9V3H5.02c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-9h-2zM17 10l.94-2.06L20 7l-2.06-.94L17 4l-.94 2.06L14 7l2.06.94zm-3.75.75L12 8l-1.25 2.75L8 12l2.75 1.25L12 16l1.25-2.75L16 12z"}),"PhotoFilter");default_1$l=PhotoFilter.default=_default$l;const map_state$1A=t=>({creation_context:t.creation_context,editing:!t.display_options.consumption_formatting}),map_dispatch$Y={change_route:ACTIONS.routing.change_route,set_or_toggle_display_side_panel:ACTIONS.controls.set_or_toggle_display_side_panel},connector$1C=connect(map_state$1A,map_dispatch$Y);function _ActiveCreationContextWarning(t){const{creation_context:ee,editing:te}=t,ne=active_warning_styles();return ee.use_creation_context&&te&&o$1(Tooltip,{placement:"top",title:"WARNING: Creation Context is active, which can result in components being created with incorrect information!",children:o$1(IconButton,{className:ne.warning_button,component:"span",size:"small",onClick:()=>{t.set_or_toggle_display_side_panel(!0),t.change_route({route:"creation_context"})},children:o$1(default_1$l,{className:ne.warning_icon})})})}const ActiveCreationContextWarning=connector$1C(_ActiveCreationContextWarning);var FilterTiltShift={},_interopRequireDefault$k=interopRequireDefaultExports;Object.defineProperty(FilterTiltShift,"__esModule",{value:!0});var default_1$k=FilterTiltShift.default=void 0,_createSvgIcon$k=_interopRequireDefault$k(requireCreateSvgIcon()),_jsxRuntime$k=requireJsxRuntime(),_default$k=(0,_createSvgIcon$k.default)((0,_jsxRuntime$k.jsx)("path",{d:"M11 4.07V2.05c-2.01.2-3.84 1-5.32 2.21L7.1 5.69c1.11-.86 2.44-1.44 3.9-1.62zm7.32.19C16.84 3.05 15.01 2.25 13 2.05v2.02c1.46.18 2.79.76 3.9 1.62l1.42-1.43zM19.93 11h2.02c-.2-2.01-1-3.84-2.21-5.32L18.31 7.1c.86 1.11 1.44 2.44 1.62 3.9zM5.69 7.1 4.26 5.68C3.05 7.16 2.25 8.99 2.05 11h2.02c.18-1.46.76-2.79 1.62-3.9zM4.07 13H2.05c.2 2.01 1 3.84 2.21 5.32l1.43-1.43c-.86-1.1-1.44-2.43-1.62-3.89zM15 12c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3zm3.31 4.9 1.43 1.43c1.21-1.48 2.01-3.32 2.21-5.32h-2.02c-.18 1.45-.76 2.78-1.62 3.89zM13 19.93v2.02c2.01-.2 3.84-1 5.32-2.21l-1.43-1.43c-1.1.86-2.43 1.44-3.89 1.62zm-7.32-.19C7.16 20.95 9 21.75 11 21.95v-2.02c-1.46-.18-2.79-.76-3.9-1.62l-1.42 1.43z"}),"FilterTiltShift");default_1$k=FilterTiltShift.default=_default$k;const map_state$1z=t=>({focused_mode:t.display_options.focused_mode}),map_dispatch$X={set_or_toggle_focused_mode:ACTIONS.display.set_or_toggle_focused_mode},connector$1B=connect(map_state$1z,map_dispatch$X);function _ActiveFocusedMode(t){const{focused_mode:ee}=t,te=ee?"WARNING: Focused Mode is active, unselected components will be almost invisible":"Activate focused mode",ne=ee?active_warning_styles():inactive_warning_styles();return o$1(Tooltip,{placement:"top",title:te,children:o$1("span",{children:o$1(IconButton,{component:"span",size:"medium",onClick:()=>t.set_or_toggle_focused_mode(),children:o$1(default_1$k,{className:ne.warning_icon})})})})}const ActiveFocusedMode=connector$1B(_ActiveFocusedMode),inactive_warning_styles=makeStyles(t=>({warning_icon:{color:t.palette.primary.main}})),map_state$1y=t=>({linked_datetime_sliders:t.controls.linked_datetime_sliders,display_by_simulated_time:t.display_options.display_by_simulated_time,display_time_sliders:t.controls.display_time_sliders,actually_display_time_sliders:get_actually_display_time_sliders(t),editing:!t.display_options.consumption_formatting,animate_connections:t.display_options.animate_connections,created_at_ms:t.routing.args.created_at_ms}),map_dispatch$W={change_display_at_created_datetime:ACTIONS.display_at_created_datetime.change_display_at_created_datetime,change_display_at_sim_datetime:ACTIONS.display_at_sim_datetime.change_display_at_sim_datetime,toggle_linked_datetime_sliders:ACTIONS.controls.toggle_linked_datetime_sliders,set_display_time_sliders:ACTIONS.controls.set_display_time_sliders,set_display_by_simulated_time:ACTIONS.display.set_display_by_simulated_time,set_or_toggle_animate_connections:ACTIONS.display.set_or_toggle_animate_connections},connector$1A=connect(map_state$1y,map_dispatch$W);function _ContentControls(t){const[ee,te]=h$1(!0);invert_disabled_appearance();const{created_events:ne,sim_events:oe}=t,ie=use_styles$6();return o$1(Box,{p:2,mb:2,borderTop:1,borderColor:"primary.main",position:"relative",children:[o$1(Collapse,{in:t.actually_display_time_sliders,children:o$1(Box,{className:ie.drawer_content,children:o$1(Box,{flexGrow:1,children:[o$1(TimeSlider,{events:ne,get_handle_ms:se=>se.routing.args.created_at_ms,change_handle_ms:se=>t.change_display_at_created_datetime({ms:se}),data_set_name:"content_controls_created_at_datetimes",title:"Created at"}),o$1(TimeSlider,{events:oe,get_handle_ms:se=>se.routing.args.sim_ms,change_handle_ms:se=>t.change_display_at_sim_datetime({ms:se}),data_set_name:"content_controls_sim_datetimes",title:"Simulation"})]})})}),o$1(Toolbar,{className:ie.toolbar,variant:"dense",children:[o$1(Box,{className:ie.move_to_button_and_warnings,children:[o$1(MoveToWComponentButton,{allow_drawing_attention:ee,have_finished_drawing_attention:()=>te(!1),disable_if_not_present:!1}),o$1(ActiveFocusedMode,{}),o$1(ActiveCreatedAtFilterWarning,{}),o$1(ActiveFilterWarning,{}),o$1(ActiveCreationContextWarning,{})]}),o$1(ToggleDatetimeMarkers,{}),o$1("div",{children:[o$1(Tooltip,{placement:"top",title:t.animate_connections?"Stop animating connections":"Animate connections",children:o$1(IconButton,{component:"span",size:"medium",onClick:()=>t.set_or_toggle_animate_connections(),children:o$1(default_1$r,{style:{color:t.animate_connections?"rgb(25, 118, 210)":""}})})}),o$1(Tooltip,{placement:"top",title:t.display_time_sliders?"Hide time sliders":"Show time sliders",children:o$1(IconButton,{component:"span",size:"medium",onClick:()=>t.set_display_time_sliders(!t.display_time_sliders),children:o$1(default_1$s,{})})})]})]})]})}const ContentControls=connector$1A(_ContentControls),use_styles$6=makeStyles(t=>({toolbar:{justifyContent:"space-between"},move_to_button_and_warnings:{display:"flex",flexDirection:"row"},drawer_content:{display:"flex",flexDirection:"row",alignItems:"center",alignContent:"center"},warning_icon:{color:t.palette.warning.main}})),map_state$1x=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,current_composed_knowledge_view:get_current_composed_knowledge_view_from_state(t)}),connector$1z=connect(map_state$1x);function _KnowledgeContentControls(t){const{wcomponents_by_id:ee,current_composed_knowledge_view:te}=t;if(!te)return o$1("div",{});const{composed_wc_id_map:ne}=te,{created_events:oe,sim_events:ie}=F$1(()=>{const se=Object.keys(ne).map(re=>ee[re]).filter(is_defined);return get_wcomponent_time_slider_data(se)},[ne,ee]);return o$1(ContentControls,{created_events:oe,sim_events:ie})}const KnowledgeContentControls=connector$1z(_KnowledgeContentControls),map_state$1w=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=ee==null?void 0:ee.prioritisations,ne=ee==null?void 0:ee.composed_datetime_line_config;return{prioritisations:te,time_origin_ms:ne==null?void 0:ne.time_origin_ms,time_origin_x:ne==null?void 0:ne.time_origin_x,time_scale:ne==null?void 0:ne.time_scale}},map_dispatch$V={change_display_at_created_datetime:ACTIONS.display_at_created_datetime.change_display_at_created_datetime,change_route:ACTIONS.routing.change_route},connector$1y=connect(map_state$1w,map_dispatch$V);function _PrioritiesContentControls(t){const[ee,te]=h$1(!0),{prioritisations:ne=[]}=t,{time_origin_ms:oe,time_origin_x:ie,time_scale:se}=default_time_origin_parameters(t);let re=calculate_canvas_x_for_datetime({datetime:new Date,time_origin_ms:oe,time_origin_x:ie,time_scale:se}),_e=re;const ae=140;ne.forEach(me=>{const pe=get_uncertain_datetime(me.datetime);if(!pe)return;const fe=calculate_canvas_x_for_datetime({datetime:pe,time_origin_ms:oe,time_origin_x:ie,time_scale:se});re=Math.min(re,fe),_e=Math.max(_e,fe)}),re-=100,_e+=200;const ce=calculate_zoom_to_contain_group({min_left:re,max_left:_e,min_top:ae,max_top:ae},{display_side_panel:!1,display_time_sliders:!1}).zoom,le={x:re,y:ae,zoom:ce};return o$1("div",{style:{borderTop:"thin solid rgb(206, 206, 206)"},children:o$1(MoveToItemButton,{move:()=>t.change_route({args:le}),draw_attention:ee&&le&&!!0,have_finished_drawing_attention:()=>te(!1),enable_spacebar_move_to_shortcut:!0})})}const PrioritiesContentControls=connector$1y(_PrioritiesContentControls),map_state$1v=t=>({view:t.routing.args.view}),connector$1x=connect(map_state$1v);function _MainContentControls(t){const{view:ee}=t;return o$1("div",{className:"main_content_controls",children:[ee==="knowledge"&&o$1(KnowledgeContentControls,{}),ee==="priorities"&&o$1(PrioritiesContentControls,{})]})}const MainContentControls=connector$1x(_MainContentControls);function MainArea(t){return o$1(Box,{id:"main_area",display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,zIndex:1,children:[o$1(Box,{id:"main_content",flexGrow:1,flexShrink:1,display:"flex",flexDirection:"column",position:"relative",zIndex:1,children:t.main_content}),o$1(Box,{id:"main_content_controls",bgcolor:"#fafafa",flexGrow:0,flexShrink:1,position:"relative",zIndex:10,children:o$1(MainContentControls,{})}),t.extra_content]})}var ArrowDownward={},_interopRequireDefault$j=interopRequireDefaultExports;Object.defineProperty(ArrowDownward,"__esModule",{value:!0});var default_1$j=ArrowDownward.default=void 0,_createSvgIcon$j=_interopRequireDefault$j(requireCreateSvgIcon()),_jsxRuntime$j=requireJsxRuntime(),_default$j=(0,_createSvgIcon$j.default)((0,_jsxRuntime$j.jsx)("path",{d:"m20 12-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"}),"ArrowDownward");default_1$j=ArrowDownward.default=_default$j;const KnowledgeGraphTimeMarkers$1="",map_state$1u=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=ee==null?void 0:ee.composed_datetime_line_config;return{display_time_marks:t.display_options.display_time_marks,time_origin_ms:te==null?void 0:te.time_origin_ms,time_origin_x:te==null?void 0:te.time_origin_x,time_scale:te==null?void 0:te.time_scale,time_line_number:te==null?void 0:te.time_line_number,time_line_spacing_days:te==null?void 0:te.time_line_spacing_days,x:t.routing.args.x,zoom:t.routing.args.zoom,sim_ms:t.routing.args.sim_ms}},connector$1w=connect(map_state$1u);function _KnowledgeGraphTimeMarkers(t){if(!(t.force_display??t.display_time_marks))return null;let{time_origin_ms:ee,time_origin_x:te,time_scale:ne}=t;if(t.force_display&&({time_origin_ms:ee,time_origin_x:te,time_scale:ne}=default_time_origin_parameters({time_origin_ms:ee,time_origin_x:te,time_scale:ne})),ee===void 0||te===void 0||ne===void 0)return null;const{sim_ms:oe,time_line_number:ie,time_line_spacing_days:se}=t,re=F$1(()=>get_other_datetime_lines({time_line_number:ie&&ie-1,time_line_spacing_days:se}),[ie,se]),{x:_e,zoom:ae}=t,ce=ae/SCALE_BY,le=(_e-te)*ce,ue=ne/time_scale_days_to_ms_pixels_fudge_factor*ce,de=new Date().getTime();return o$1("div",{className:"datetime_lines_container",children:[re.map(me=>o$1(DatetimeLine,{date_ms:(t.show_by_now?de:oe)+me.offset,time_origin_ms:ee,time_scale_ms_to_pixels_fudge:ue,xm:le,xd:ce,color:"black",opacity:me.opacity},me.key)),!!ie&&o$1(DatetimeLine,{date_ms:de,time_origin_ms:ee,time_scale_ms_to_pixels_fudge:ue,xm:le,xd:ce,color:"red",left_label_when_off_screen:!0}),!!ie&&!t.show_by_now&&o$1(DatetimeLine,{date_ms:oe,time_origin_ms:ee,time_scale_ms_to_pixels_fudge:ue,xm:le,xd:ce,color:"blue",left_label_when_off_screen:!0})]})}const KnowledgeGraphTimeMarkers=connector$1w(_KnowledgeGraphTimeMarkers),date_format="yyyy-MM-dd";function DatetimeLine(t){const{color:ee,opacity:te}=t;let ne=(t.date_ms-t.time_origin_ms)*t.time_scale_ms_to_pixels_fudge-t.xm;const oe=document.body.clientWidth-20,ie=ne<0,se=ne>oe,re=!ie&&!se;return!re&&!t.left_label_when_off_screen?null:(ne=bounded(ne,0,oe),o$1("div",{className:"datetime_container",style:{color:ee,borderColor:ee,left:ne,opacity:te},children:[o$1("div",{className:"rotater",children:[ie&&o$1(default_1$u,{fontSize:"small"}),se&&o$1(default_1$j,{fontSize:"small"}),o$1("div",{className:"date_label",children:date2str(new Date(t.date_ms),date_format)})]}),re&&o$1("div",{className:"datetime_line"})]}))}const milliseconds_in_day=1e3*3600*24;function get_other_datetime_lines(t){const ee=[],{time_line_number:te,time_line_spacing_days:ne}=t;if(te===void 0||ne===void 0)return[];const oe=ne*milliseconds_in_day;for(let ie=te;ie>0;--ie){const se=ie/te,re=te-ie+1;ee.push({offset:oe*re,opacity:se,key:`plus${ie}`}),ee.push({offset:-oe*re,opacity:se,key:`minus${ie}`})}return ee}const map_state$1t=t=>{const{ready_for_reading:ee}=t.sync,{current_composed_knowledge_view:te}=t.derived;ee&&!te&&console.log("No current_composed_knowledge_view");const{wcomponent_nodes:ne,wcomponent_connections:oe,wcomponent_unfound_ids:ie}=te||{},se=t.meta_wcomponents.wcomponent_ids_to_move_set.size>0,re=t.meta_wcomponents.frame_is_resizing,_e=se||re;return{ready:ee,wcomponent_nodes:ne,wcomponent_connections:oe,wcomponent_unfound_ids:ie,presenting:t.display_options.consumption_formatting,show_large_grid:t.display_options.show_large_grid,canvas_drag_event:_e}},connector$1v=connect(map_state$1t);function _KnowledgeGraphView(t){const ee=get_children$1(t),[te,ne]=h$1(!1);p$1(()=>pub_sub.canvas.sub("canvas_pointer_down",()=>{ne(!0)})),p$1(()=>pub_sub.canvas.sub("canvas_pointer_up",()=>{ne(!1)}));const oe=t.canvas_drag_event||te?" canvas_drag_event ":"";return o$1(MainArea,{main_content:o$1(Canvas,{svg_children:[],svg_upper_children:get_svg_upper_children(t),overlay:get_overlay_children$1(),plain_background:t.presenting,show_large_grid:t.show_large_grid,extra_class_names:oe,children:ee})})}const KnowledgeGraphView=connector$1v(_KnowledgeGraphView),no_children=[],get_children$1=t=>{const{ready:ee,wcomponent_nodes:te=[],wcomponent_unfound_ids:ne=[]}=t;return!ee||te.length===0&&ne.length===0?no_children:[...te.map(({id:ie})=>o$1(WComponentCanvasNode,{id:ie},ie)),...ne.map(ie=>o$1(WComponentCanvasNode,{id:ie},ie))]},get_svg_upper_children=({wcomponent_connections:t=[]})=>t.map(({id:ee})=>o$1(WComponentCanvasConnection,{id:ee},ee)),get_overlay_children$1=()=>o$1(KnowledgeGraphTimeMarkers,{}),PrioritiesListView$1="";function Prioritisation({prioritisation:t}){return o$1(WComponentCanvasNode,{id:t.id,is_on_canvas:!1,always_show:!0})}const EditableNumber$1="";function get_wcomponent_search_options(t){const{wcomponents:ee,allowed_wcomponent_ids:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,created_at_ms:se,sim_ms:re}=t;let _e=ee||Object.values(ne);return te&&(_e=_e.filter(({id:ce})=>te.has(ce))),_e.filter(wcomponent_is_not_deleted).map(ce=>{const le=get_title$1({wcomponent:ce,text_type:RichTextType.plain,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:ie,created_at_ms:se,sim_ms:re});let ue=`@@${ce.id} -- ${ce.title} -- ${ce.description}`;wcomponent_is_plain_connection(ce)&&(ue+=` -- @@${ce.from_id} -> @@${ce.to_id}`);let de;return wcomponent_is_judgement_or_objective(ce)&&(de=o$1("div",{children:[o$1(JudgementBadgeConnected,{judgement_or_objective_id:ce.id,hide_judgement_trend:!1}),le]})),{id:ce.id,title:le,jsx:de,raw_title:ce.title,subtitle:ue,color:ce.label_color}})}var ExpandMore={},_interopRequireDefault$i=interopRequireDefaultExports;Object.defineProperty(ExpandMore,"__esModule",{value:!0});var default_1$i=ExpandMore.default=void 0,_createSvgIcon$i=_interopRequireDefault$i(requireCreateSvgIcon()),_jsxRuntime$i=requireJsxRuntime(),_default$i=(0,_createSvgIcon$i.default)((0,_jsxRuntime$i.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");default_1$i=ExpandMore.default=_default$i;var Refresh={},_interopRequireDefault$h=interopRequireDefaultExports;Object.defineProperty(Refresh,"__esModule",{value:!0});var default_1$h=Refresh.default=void 0,_createSvgIcon$h=_interopRequireDefault$h(requireCreateSvgIcon()),_jsxRuntime$h=requireJsxRuntime(),_default$h=(0,_createSvgIcon$h.default)((0,_jsxRuntime$h.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"}),"Refresh");default_1$h=Refresh.default=_default$h;var Warning={},_interopRequireDefault$g=interopRequireDefaultExports;Object.defineProperty(Warning,"__esModule",{value:!0});var default_1$g=Warning.default=void 0,_createSvgIcon$g=_interopRequireDefault$g(requireCreateSvgIcon()),_jsxRuntime$g=requireJsxRuntime(),_default$g=(0,_createSvgIcon$g.default)((0,_jsxRuntime$g.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");default_1$g=Warning.default=_default$g;const AutocompleteText$1="";function Options(t){const{editing_options:ee,internal_options_to_display:te,is_option_wrapper_highlighted:ne,conditional_on_change:oe,set_highlighted_option_index:ie,on_mouse_over_option:se,on_mouse_leave_option:re}=t;if(te.length===0||!ee)return null;const _e=45;return o$1("div",{className:"options_outer",style:{marginTop:15},children:o$1("div",{className:"options_inner",ref:ae=>{if(!ae)return;const ce=`${document.body.clientHeight-ae.clientTop-_e}px`;ae.style.setProperty("max-height",ce)},children:te.map((ae,ce)=>o$1("div",{className:"option_wrapper "+(ne(ae,ce)?" highlighted ":""),onMouseDown:()=>oe(ae.id),onMouseOver:()=>{ie(ce),se(ae.id)},onMouseLeave:()=>re(ae.id),children:o$1("div",{className:"option",children:[ae.jsx||ae.title||ae.id||"none",o$1("div",{className:"option_subtitle",children:ae.subtitle})]})}))})})}const map_state$1s=t=>{var ee;return{presenting:(ee=t.display_options)==null?void 0:ee.consumption_formatting}},connector$1u=connect(map_state$1s);function _AutocompleteText(t){const ee=_$d([]),te=_$d(FlexSearch.Index()),ne=_$d([]);p$1(()=>{const Se=prepare_options(t.options,200,t.search_fields),Ie=prepare_targets(Se);ee.current=Ie,Se.forEach(Pe=>{te.current=te.current.add(Pe.id_num,Pe.unlimited_total_text)}),ne.current=Se},[t.options,t.search_fields]);const oe=_$d({actively_chosen:!1,id:void 0}),ie=ye(),[se,re]=h$1("");p$1(()=>{re(t.initial_search_term||ie)},[t.initial_search_term,ie]);const{throttled:_e,flush:ae}=throttle(re,300),[ce,le]=h$1(!1);function ue(Se){Se!==ce&&le(Se)}p$1(()=>{ue(!!t.start_expanded)},[t.start_expanded]);const{threshold_minimum_score:de=!1}=t,[me,pe]=h$1([]);p$1(()=>{const Se=get_options_to_display({temp_value_str:se,selected_any_option:t.selected_option_id!==OPTION_NONE_ID,allow_none:!!t.allow_none,internal_options:ne.current,prepared_targets:ee.current,flexsearch_index:te.current,search_type:t.search_type||"best",threshold_minimum_score:de,retain_options_order:t.retain_options_order||!1});pe(Se.internal_options),t.set_search_type_used&&t.set_search_type_used(Se.search_type_used),ae()},[se,t.selected_option_id,t.allow_none,ne.current,ee.current,te.current,t.search_type,de]);const[fe,ge]=h$1(0),he=_$d(new Set),be=F$1(()=>Se=>{Se&&he.current.add(Se),t.on_mouse_over_option&&t.on_mouse_over_option(Se)},[t.on_mouse_over_option]),ve=F$1(()=>Se=>{Se&&he.current.delete(Se),t.on_mouse_leave_option&&t.on_mouse_leave_option(Se)},[t.on_mouse_leave_option]);function ye(){const Se=get_selected_option(t);return(Se==null?void 0:Se.title)||""}const we=async(Se,Ie)=>{Se.stopImmediatePropagation();const Pe=Se.key,Re=Pe==="ArrowDown",De=Pe==="ArrowUp",Ve=Pe==="Enter",Le=Pe==="Escape";if(Ve||Le)if(Ve&&fe!==void 0){const je=Ie[fe];je&&Ae(je.id)}else Le&&Ae(t.selected_option_id);else if(Re||De){let je=fe+(Re?1:-1);je=je%Ie.length,ge(je)}},ke=()=>{ue(!1),!t.retain_invalid_search_term_on_blur&&re(ye()),ge(0)},Ae=Se=>{ke(),oe.current={actively_chosen:!0,id:Se}},$e=()=>{ke();const{on_mouse_leave_option:Se}=t;Se&&(he.current.forEach(De=>Se(De)),he.current=new Set);const{actively_chosen:Ie,id:Pe}=oe.current;if(!Ie)return;oe.current={actively_chosen:!1,id:void 0},t.selected_option_id===Pe?t.on_choose_same&&t.on_choose_same(Pe):t.on_change(Pe)},xe=get_selected_internal_option(me,se),Ce=(xe==null?void 0:xe.id)===OPTION_NONE.id&&t.allow_none||se.toLowerCase()===(xe==null?void 0:xe.title.toLowerCase());return o$1("div",{class:"editable_field autocomplete "+(Ce?"":"invalid "),style:t.extra_styles,children:[o$1(TextField,{variant:"standard",disabled:t.editing_allowed!==void 0?!t.editing_allowed:t.presenting,ref:Se=>{if(!Se)return;const Ie=Se.getElementsByTagName("input")[0];Ie&&setTimeout(ce?()=>Ie.focus():()=>Ie.blur(),0)},placeholder:t.placeholder,value:se||(ce?"":"-"),onFocus:Se=>{setTimeout(()=>ue(!0),0),Se.currentTarget.setSelectionRange(0,Se.currentTarget.value.length)},onChange:Se=>_e(Se.currentTarget.value),onKeyDown:Se=>we(Se,me),onBlur:()=>$e()}),o$1(Options,{editing_options:ce,internal_options_to_display:me,is_option_wrapper_highlighted:(Se,Ie)=>Ie===fe,conditional_on_change:Ae,set_highlighted_option_index:ge,on_mouse_over_option:be,on_mouse_leave_option:ve})]})}const ConnectedAutocompleteText=connector$1u(_AutocompleteText);function AutocompleteText(t){return o$1(ConnectedAutocompleteText,{...t})}function get_selected_option(t){return t.selected_option_id===void 0?t.allow_none?void 0:t.options[0]:t.options.find(({id:ee})=>ee===t.selected_option_id)}function get_selected_internal_option(t,ee){const te=ee.toLowerCase();return t.find(ne=>ne.title.toLowerCase()===te)}const OPTION_ID_NUM_START=1;function prepare_options(t,ee,te="all"){let ne=OPTION_ID_NUM_START;const oe=te==="all";return t.filter(({is_hidden:se})=>!se).map(se=>{const re=get_total_text(se,ee,oe),_e=get_total_text(se,0,oe);return{...se,limited_total_text:re,unlimited_total_text:_e,id_num:ne++}})}function get_total_text(t,ee,te){let ne=limit_string_length(t.title,ee);return te?ne+=t.subtitle?" "+limit_string_length(t.subtitle,ee):"":ne+=t.raw_title?" "+limit_string_length(t.raw_title,ee):"",ne}function limit_string_length(t,ee){return ee?t.slice(0,ee)+(t.length>ee?"...":""):t}function prepare_targets(t){return t.map(({limited_total_text:ee})=>fuzzysort.prepare(ee))}const OPTION_NONE_ID=void 0,OPTION_NONE={id:OPTION_NONE_ID,id_num:OPTION_ID_NUM_START-1,title:"(clear)",limited_total_text:"clear",unlimited_total_text:""};function get_options_to_display(t){const{temp_value_str:ee,selected_any_option:te,allow_none:ne,prepared_targets:oe,flexsearch_index:ie,search_type:se,threshold_minimum_score:re,retain_options_order:_e}=t;let{internal_options:ae}=t,ce;if(!ee)return ae=ne&&te?[OPTION_NONE,...ae]:ae,{internal_options:ae,search_type_used:ce};let le=fe=>0,ue=fe=>0,de=0;if(se==="best"||se==="exact"){ce="exact";const fe=ie.search(ee);de=fe.length;const ge={};fe.forEach((he,be)=>ge[he]=1e4-be),le=he=>ge[he.id_num]||-1e4}if(de<10&&(se==="best"||se==="fuzzy")){ce="fuzzy";const fe={limit:100,allowTypo:!0,threshold:-1e4},ge=fuzzysort.go(ee,oe,fe),he={};ge.forEach(({target:be,score:ve})=>he[be]=ve),ue=be=>{const ve=he[be.limited_total_text];return ve===void 0?le(be):ve}}else ue=le;const me=re===!1?ae:ae.filter(fe=>ue(fe)>re);let pe=me;return _e||(pe=sort_list(me,ue,SortDirection.descending)),ne&&te&&(pe=[OPTION_NONE,...pe]),{internal_options:pe,search_type_used:ce}}const Modal$1="";function map_state$1r(t,ee){const te=t.global_keys.last_key==="Escape",{last_key_time_stamp:ne=0}=t.global_keys;return{should_close:te&&ne>ee.time_stamp_first_rendered}}const connector$1t=connect(map_state$1r);function _ModalCore(t){const{on_close:ee}=t;return ee&&t.should_close&&setTimeout(()=>ee(),0),o$1("div",{id:"modal_background",className:(t.size||"medium")+"_modal",onClick:te=>{te.stopImmediatePropagation(),ee&&ee(te)},children:o$1("div",{id:"modal_container",style:t.scrollable===!1?{overflowY:"hidden"}:void 0,onClick:te=>te.stopPropagation(),children:[o$1("div",{id:"modal_title",children:t.title}),ee&&o$1("div",{id:"modal_close",onClick:te=>ee(te),children:o$1("span",{children:"X"})}),t.child]})})}const ModalCore=connector$1t(_ModalCore);function Modal(t){const ee=performance.now();return o$1(ModalCore,{...t,time_stamp_first_rendered:ee})}function SearchWindow(t){const[ee,te]=h$1("all"),[ne,oe]=h$1("best"),[ie,se]=h$1(void 0),[re,_e]=h$1(!1),ae=o$1(default_1$g,{titleAccess:"You might be getting sub optimal search results!",style:{color:yellow[600]}}),ce=()=>ne=="best"&&ee=="all";return o$1(Modal,{on_close:()=>t.on_blur&&t.on_blur(),title:t.search_window_title,child:o$1(Box,{p:5,children:[o$1(Accordion,{onChange:(le,ue)=>{_e(ue)},children:[o$1(AccordionSummary,{expandIcon:!ce()&&!re?ae:o$1(default_1$i,{}),children:o$1(Typography,{component:"h2",children:[re?"Hide ":"Show ","Advanced Search Options"]})}),o$1(AccordionDetails,{children:o$1(Box,{width:1,children:[o$1(Box,{display:"flex",justifyContent:"flex-start",alignItems:"stretch",children:[o$1(Box,{mr:10,flexGrow:1,flexShrink:0,children:o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,children:[o$1(FormLabel,{component:"legend",children:"Search Type: "}),o$1(RadioGroup,{name:"search_type",value:ne,onChange:le=>oe(le.target.value),children:[o$1(FormControlLabel,{value:"exact",control:o$1(Radio,{}),label:"Exact"}),o$1(FormControlLabel,{value:"fuzzy",control:o$1(Radio,{}),label:"Fuzzy"}),o$1(FormControlLabel,{value:"best",control:o$1(Radio,{}),label:"Best"})]})]})}),o$1(Box,{mr:10,flexGrow:1,flexShrink:0,children:o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,children:[o$1(FormLabel,{component:"legend",children:"Search Over: "}),o$1(RadioGroup,{name:"search_fields",value:ee,onChange:le=>te(le.target.value),children:[o$1(FormControlLabel,{value:"all",control:o$1(Radio,{}),label:"All"}),o$1(FormControlLabel,{value:"title",control:o$1(Radio,{}),label:"Title Only"})]})]})}),o$1(Box,{flexGrow:1,flexShrink:0,alignSelf:"flex-end",textAlign:"right",children:!ce()&&o$1(Button$2,{variant:"contained",color:"primary",onClick:()=>{oe("best"),te("all")},endIcon:o$1(default_1$h,{}),children:"Reset Search Options"})})]}),o$1(Box,{style:{opacity:ie?.7:0},children:["Used: ",ie]})]})})]}),o$1(AutocompleteText,{placeholder:t.placeholder,selected_option_id:t.selected_option_id,initial_search_term:t.initial_search_term,options:t.options,allow_none:t.allow_none,on_change:le=>{t.on_change(le),t.on_blur&&t.on_blur()},on_mouse_over_option:t.on_mouse_over_option,on_mouse_leave_option:t.on_mouse_leave_option,extra_styles:t.extra_styles,start_expanded:!0,retain_invalid_search_term_on_blur:!0,search_fields:ee,search_type:ne,set_search_type_used:se,editing_allowed:!0,threshold_minimum_score:-1e3})]})})}const map_state$1q=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}),connector$1s=connect(map_state$1q);function _WComponentSearchWindow(t){const ee=get_wcomponent_search_options(t);return o$1(SearchWindow,{search_window_title:"Search for a Component",placeholder:"Search for a Component...",selected_option_id:"",initial_search_term:t.initial_search_term,allow_none:!0,options:ee,on_change:t.on_change,on_blur:t.on_blur})}const WComponentSearchWindow=connector$1s(_WComponentSearchWindow);function ConditionalWComponentSearchWindow(t){const{value:ee,id_insertion_point:te,conditional_on_change:ne,on_close:oe}=t,ie=get_initial_search_term({value:ee,id_insertion_point:te}),se=_$d(!1);return o$1(WComponentSearchWindow,{initial_search_term:ie,on_change:re=>{const _e=insert_id_into_text({value:ee,id_to_insert:re,id_insertion_point:te}),ae=te+((re==null?void 0:re.length)||0),ce=ae+((ie==null?void 0:ie.length)||0),le={start:ae,end:ce};se.current=!0,ne({new_value:_e,on_focus_set_selection:le})},on_blur:()=>{if(se.current)return;const re=te+((ie==null?void 0:ie.length)||0);oe({start:te,end:re})}})}function get_initial_search_term(t){const te=t.value.slice(t.id_insertion_point).match(/^(\w+)/);return te&&te[1]||""}function insert_id_into_text(t){const{value:ee,id_to_insert:te,id_insertion_point:ne}=t;return te===void 0?ee:ee.slice(0,ne)+te+ee.slice(ne)}var EditableTextOnBlurType=(t=>(t[t.conditional=0]="conditional",t[t.always=1]="always",t))(EditableTextOnBlurType||{});const map_state$1p=t=>({presenting:t.display_options.consumption_formatting,use_creation_context:t.creation_context.use_creation_context,creation_context:t.creation_context.creation_context}),connector$1r=connect(map_state$1p);function _EditableTextCommon(t){const{placeholder:ee,disabled:te,presenting:ne,editing_allowed:oe,select_all_on_focus:ie,force_focus_on_first_render:se,on_blur_type:re=0}=t,[_e,ae]=h$1(t.value);p$1(()=>ae(t.value),[t.value]);const ce=_$d(void 0),le=_$d(void 0);if(oe===!1||!t.conditional_on_change&&!t.on_blur||te||ne&&oe===void 0){const $e=te?"disabled":"",xe=t.value!==void 0;return o$1("div",{className:$e,children:[xe&&!t.hide_label&&o$1("span",{className:"description_label",children:[t.placeholder," "]}),o$1(RichMarkDown,{text:_e||ee})]})}const ue=`editable_field ${_e?"":"placeholder"}`,de=F$1(()=>$e=>{if(!$e)return;const xe=!ce.current;ce.current=$e,xe&&handle_text_field_render({el:$e,force_focus_on_first_render:se})},[]),me=F$1(()=>$e=>{handle_text_field_focus({e:$e,select_all_on_focus:ie})},[ie]),pe=F$1(()=>$e=>{t.use_creation_context&&($e=custom_creation_context_replace_text(t.creation_context,$e)),$e!==t.value&&t.conditional_on_change&&t.conditional_on_change($e),ae($e)},[t.value,t.creation_context,t.conditional_on_change]),fe=F$1(()=>$e=>{t.use_creation_context&&($e=custom_creation_context_replace_text(t.creation_context,$e)),t.modify_value_pre_on_blur&&($e=t.modify_value_pre_on_blur($e));const xe=$e!==t.value;(re===1||xe)&&t.on_blur&&t.on_blur($e),ae($e)},[t.value,t.creation_context,re,t.on_blur]),ge=F$1(()=>$e=>{if(le.current!==void 0)return;const xe=get_id_insertion_point($e.currentTarget);xe!==void 0&&(le.current=xe),pe($e.currentTarget.value)},[pe]),he=F$1(()=>$e=>{le.current===void 0&&fe($e.currentTarget.value)},[t.value,fe]),be=F$1(()=>$e=>{handle_general_key_down($e,ce.current,pe,fe)},[pe,fe]),ve=_$d(fe);ve.current=fe,p$1(()=>()=>{!ce.current||!(document.activeElement===ce.current)||ve.current(ce.current.value)},[]);const[ye,we]=h$1({}),ke=F$1(()=>$e=>{var xe,Ce;(xe=ce.current)==null||xe.focus(),le.current=void 0,we({}),(Ce=ce.current)==null||Ce.setSelectionRange($e.start,$e.end)},[]),Ae=F$1(()=>t.component({value:_e,on_render:de,on_focus:me,on_change:ge,on_blur:he,on_key_down:be}),[_e,de,me,ge,he]);return o$1("div",{className:ue,style:t.style,children:[Ae,le.current!==void 0&&o$1("div",{style:{fontSize:"initial",fontWeight:"initial"},children:o$1(ConditionalWComponentSearchWindow,{value:_e,id_insertion_point:le.current,conditional_on_change:({new_value:$e,on_focus_set_selection:xe})=>{pe($e),setTimeout(()=>ke(xe),0)},on_close:$e=>{ke($e)}})})]})}const EditableTextCommon=connector$1r(_EditableTextCommon);function handle_text_field_render(t){t.force_focus_on_first_render&&setTimeout(()=>t.el.focus(),0)}function handle_text_field_focus(t){if(t.select_all_on_focus){const ee=t.e.currentTarget;ee.setSelectionRange(0,ee.value.length)}}function handle_general_key_down(t,ee,te,ne){document.activeElement===ee&&ee&&(handle_ctrl_k_link_insert(t,ee,te),handle_stop_propagation(t,ee,ne))}function handle_ctrl_k_link_insert(t,ee,te){if(!t.ctrlKey||t.key!=="k")return;t.preventDefault();const{value:ne,selectionStart:oe}=ee;let{selectionEnd:ie}=ee;if(typeof oe!="number")return;typeof ie!="number"&&(ie=oe);const se=ne.slice(oe,ie),re=se?se.startsWith("http")?0:1:2,_e=re===1?se:"title",ae=re===0?se:"url",ce=ne.slice(0,oe)+"["+_e+"]("+ae+")"+ne.slice(ie);te(ce);let le=oe+1,ue=le+_e.length;re===1&&(le=ie+3,ue=le+ae.length),setTimeout(()=>ee.setSelectionRange(le,ue),0)}function handle_stop_propagation(t,ee,te){if(t.ctrlKey&&t.key==="e"){te(ee.value);return}t.key!=="Shift"&&t.key!=="Control"&&t.stopImmediatePropagation()}function get_id_insertion_point({selectionStart:t,value:ee}){if(typeof t=="number"){const te=ee[t-2],ne=ee[t-1];if(te==="@"&&ne==="@"&&get_store().getState().global_keys.last_key==="@")return t}}function custom_creation_context_replace_text(t,ee){return t!=null&&t.replace_text_target&&(t!=null&&t.replace_text_replacement)&&(ee=ee.replaceAll(t.replace_text_target,t.replace_text_replacement)),ee}function EditableTextSingleLine(t){const ee=F$1(()=>({value:te,on_render:ne,on_focus:oe,on_change:ie,on_blur:se,on_key_down:re})=>o$1(TextField,{fullWidth:!0,label:t.placeholder,variant:"outlined",value:te,onFocus:oe,onChange:ie,onBlur:se,onKeyDown:re,size:t.size,inputRef:ne,spellcheck:t.spellcheck}),[t.placeholder,t.size,t.spellcheck]);return o$1(EditableTextCommon,{...t,component:ee})}const map_state$1o=t=>({editing:!t.display_options.consumption_formatting}),connector$1q=connect(map_state$1o);function _EditableNumber(t){const ee=t.value!==void 0?t.value.toString():"",{allow_undefined:te,conditional_on_change:ne,on_blur:oe,on_blur_type:ie,disabled:se,editing:re,default_value_when_invalid:_e=0,editing_allowed:ae}=t;let ce="editable_number";if(!re||!ne&&!oe||se){ce=ce+(re?"":" not_editable ")+(se?" disabled ":"");const le=t.value!==void 0;return o$1("div",{className:ce,style:t.style,children:[le&&o$1("span",{className:"description_label",children:t.placeholder})," ",le?t.value:t.placeholder]})}return o$1("div",{className:ce,style:t.style,children:o$1(EditableTextSingleLine,{placeholder:t.placeholder,size:t.size||"small",style:t.style,value:ee,editing_allowed:ae,select_all_on_focus:!0,conditional_on_change:le=>{if(!ne)return;const ue=string_to_number(le,_e);(on_event_handler_accepts_undefined(ne,te)||ue!==void 0)&&ne(ue)},on_blur:le=>{oe&&handle_blur({value:le,default_value_when_invalid:_e,on_blur:oe,allow_undefined:te})},on_blur_type:ie||EditableTextOnBlurType.conditional})})}const EditableNumber=connector$1q(_EditableNumber);function string_to_number(t,ee){if(!t)return;const te=parseFloat(t);return Number.isNaN(te)?ee:te}function on_event_handler_accepts_undefined(t,ee){return!!ee}function handle_blur({value:t,default_value_when_invalid:ee,on_blur:te,allow_undefined:ne}){let oe=string_to_number(t,ee);on_event_handler_accepts_undefined(te,ne)||oe===void 0&&(oe=ee),te(oe)}const map_state$1n=t=>({editing:!t.display_options.consumption_formatting}),map_dispatch$U={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1p=connect(map_state$1n,map_dispatch$U);function _PrioritisableGoal(t){var se;const{goal:ee,selected_prioritisation:te,editing:ne}=t,oe=te&&te.goals||{},ie=(se=oe[ee.id])==null?void 0:se.effort;return o$1("div",{style:{display:"flex"},children:[o$1(WComponentCanvasNode,{id:ee.id,is_on_canvas:!1,always_show:!0}),te&&(ne||!!ie)&&o$1("div",{children:[o$1("br",{}),o$1(EditableNumber,{placeholder:"Effort",allow_undefined:!0,value:ie,on_blur:re=>{const _e={...oe};re===void 0?delete _e[ee.id]:_e[ee.id]={effort:re};const ae={...te,goals:_e};t.upsert_wcomponent({wcomponent:ae})},on_blur_type:EditableTextOnBlurType.conditional})]})]})}const PrioritisableGoal=connector$1p(_PrioritisableGoal);function get_next_available_wc_map_position(t,ee,te,ne=v_step){const oe={left:0,top:0};if(!t||!ee)return oe;const ie=t[ee];if(!ie)return oe;const se=get_wc_position_to_id_map(t,te);let re=ie;const _e={left:ie.left,top:ie.top};for(;re;){_e.top+=ne;const ae=wc_map_entry_to_coord_key(_e),le=(se[ae]||[])[0];re=le?t[le]:void 0}return _e}function PrioritiesListView(t){return o$1(MainArea,{main_content:o$1(PrioritiesListViewContent,{})})}const map_state$1m=t=>{const ee=t.specialised_objects.wcomponents_by_id,te=get_current_composed_knowledge_view_from_state(t),ne=[];let oe,ie;if(te){te.wc_ids_by_type.has_objectives.forEach(re=>{const _e=ee[re];wcomponent_has_objectives(_e,re)&&ne.push(_e)}),oe=te.prioritisations;const{item_id:se}=t.routing;ie=oe.find(({id:re})=>re===se),Object.keys((ie==null?void 0:ie.goals)||{}).forEach(re=>{if(te.wc_ids_by_type.has_objectives.has(re))return;const _e=ee[re];wcomponent_has_objectives(_e,re)&&ne.push(_e)})}return{composed_knowledge_view:te,goals_and_actions:ne,prioritisations:oe,selected_prioritisation:ie,base_id:selector_chosen_base_id(t),wcomponents_by_id:ee,display_side_panel:t.controls.display_side_panel}},map_dispatch$T={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1o=connect(map_state$1m,map_dispatch$T);function _PrioritiesListViewContent(t){const{goals_and_actions:ee,prioritisations:te,composed_knowledge_view:ne,selected_prioritisation:oe,base_id:ie,wcomponents_by_id:se}=t,re=ne==null?void 0:ne.id,_e=(ne==null?void 0:ne.composed_wc_id_map)||{},ae=oe==null?void 0:oe.goals,{potential_goals:ce,prioritised_goals:le,deprioritised_goals:ue}=partition_and_sort_goals(ee,ae);return ie===void 0?o$1("div",{children:"No base id chosen"}):o$1("div",{className:"priorities_list_view_content",children:[o$1("div",{className:"priorities_list goals",children:[o$1("h1",{children:"Potential"}),ce.map(de=>o$1(PrioritisableGoal,{goal:de,selected_prioritisation:oe},de.id)),o$1("h1",{children:"Deprioritised"}),ue.map(de=>o$1(PrioritisableGoal,{goal:de,selected_prioritisation:oe},de.id))]}),o$1("div",{className:"priorities_list goals",children:[o$1("h1",{children:"Prioritised"}),le.map(de=>o$1(PrioritisableGoal,{goal:de,selected_prioritisation:oe},de.id))]}),o$1("div",{className:"priorities_list prioritisations",children:[o$1("h1",{children:["Prioritisations",re&&o$1("span",{className:"button_add_new",children:[" ",o$1(Button,{fullWidth:!1,onClick:de=>{var fe;const me=((fe=(te||[])[0])==null?void 0:fe.id)||"",pe=get_next_available_wc_map_position(_e,me,se);create_wcomponent({wcomponent:{base_id:ie,type:"prioritisation",goals:ae||{},description:(oe==null?void 0:oe.description)||""},add_to_knowledge_view:{id:re,position:pe}})},children:ae?"Copy":"Add"})]})]}),o$1("div",{className:"prioritisations_list",children:(te||[]).map(de=>o$1(Prioritisation,{prioritisation:de}))})]}),o$1("div",{className:"side_panel_padding",style:{minWidth:t.display_side_panel?SIDE_PANEL_WIDTH:0}})]})}const PrioritiesListViewContent=connector$1o(_PrioritiesListViewContent);function partition_and_sort_goals(t,ee){let te=[],ne=[],oe=[];return ee?t.forEach(ie=>{const se=ee[ie.id];se?se.effort>0?ne.push(ie):oe.push(ie):te.push(ie)}):te=t,te=sort_list(te,get_created_at_ms,SortDirection.descending),ne=sort_list(ne,factory_get_effort(ee),SortDirection.descending),oe=sort_list(oe,get_created_at_ms,SortDirection.descending),{potential_goals:te,prioritised_goals:ne,deprioritised_goals:oe}}function factory_get_effort(t){return ee=>{var te;return((te=(t||{})[ee.id])==null?void 0:te.effort)||0}}const map_state$1l=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),map_dispatch$S={change_route:ACTIONS.routing.change_route},connector$1n=connect(map_state$1l,map_dispatch$S);function _WComponentsList(t){const{wcomponent_ids:ee=[],wcomponents_by_id:te,knowledge_views_by_id:ne}=t,oe=ee.map(_e=>te[_e]).filter(is_defined),ie={},se=new Date().getTime(),re=se;return o$1("table",{class:"list",children:o$1("tbody",{children:oe.map(_e=>o$1("tr",{style:{cursor:"pointer"},onClick:()=>t.change_route({item_id:_e.id}),children:get_title$1({wcomponent:_e,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:ie,created_at_ms:se,sim_ms:re})}))})})}const WComponentsList=connector$1n(_WComponentsList),map_state$1k=t=>({action_ids_to_show:t.view_priorities.action_ids_to_show,date_shown:t.view_priorities.date_shown}),map_dispatch$R={set_action_ids_to_show:ACTIONS.view_priorities.set_action_ids_to_show},connector$1m=connect(map_state$1k,map_dispatch$R);function _WComponentActionsListModal(t){if(t.action_ids_to_show.length===0)return null;let ee="Actions";return t.date_shown&&(ee+=` (${date2str(t.date_shown,"yyyy-MMM-dd")})`),o$1(Modal,{on_close:()=>t.set_action_ids_to_show({action_ids:[]}),title:ee,child:o$1(WComponentsList,{wcomponent_ids:t.action_ids_to_show})})}const WComponentActionsListModal=connector$1m(_WComponentActionsListModal),map_dispatch$Q={set_action_ids_to_show:ACTIONS.view_priorities.set_action_ids_to_show},connector$1l=connect(null,map_dispatch$Q);function _DailyActionNode(t){const{x:ee,y:te,width:ne,height:oe,display:ie,action_ids:se,date_shown:re}=t;return o$1(CanvasNode,{position:{width:ne,height:oe,left:ee,top:te},display:ie,extra_styles:{backgroundColor:"orange",borderRadius:"2px",border:"thin solid #777",overflow:"hidden",fontSize:"7px",textAlign:"center"},on_click:()=>t.set_action_ids_to_show({action_ids:se,date_shown:re}),children:se.length})}const DailyActionNode=connector$1l(_DailyActionNode),PrioritisationEntryNode$1="",map_state$1j=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,created_at_ms:t.routing.args.created_at_ms}),map_dispatch$P={change_route:ACTIONS.routing.change_route},connector$1k=connect(map_state$1j,map_dispatch$P);function _PrioritisationEntryNode(t){const{wcomponents_by_id:ee,knowledge_views_by_id:te,created_at_ms:ne,x:oe,y:ie,width:se,effort:re,display:_e}=t,ae=ee[t.wcomponent_id];if(!ae)return null;const ce=get_title$1({wcomponent:ae,wcomponents_by_id:ee,knowledge_views_by_id:te,wc_id_to_counterfactuals_map:void 0,created_at_ms:ne,sim_ms:new Date().getTime()}),le=Math.max(se,60),ue=Math.max(se,250),[de,me]=h$1(le),pe=`${Math.round(re*100)}%`,ge={backgroundImage:`linear-gradient(to top, #a6eaff ${pe}, rgba(0,0,0,0) ${pe})`,backgroundColor:"white"};return o$1(CanvasNode,{position:{left:oe,top:ie,width:de},display:_e,on_pointer_down:he=>{he.stopImmediatePropagation(),he.preventDefault(),t.change_route({item_id:t.wcomponent_id})},on_pointer_enter:()=>me(ue),on_pointer_leave:()=>me(le),extra_css_class:" prioritisation_entry ",children:o$1("div",{className:"node_main_content",style:ge,children:[" ",o$1("span",{title:ce,children:o$1(Markdown,{options:MARKDOWN_OPTIONS,children:ce})}),o$1("div",{children:[o$1("br",{}),o$1("span",{style:{color:"grey",fontSize:10},children:["  ",re>0&&`Effort ${pe}`]})]})]})})}const PrioritisationEntryNode=connector$1k(_PrioritisationEntryNode);function cloneable_generator_factory(t,ee,te=[]){let ne=ee(t);const oe={next:(...ie)=>(te.push(ie),ne.next(...ie)),throw:ie=>ne.throw(ie),return:ie=>ne.return(ie),[Symbol.iterator]:()=>oe,clone:()=>{const ie=[...te].map(se=>[...se]);return cloneable_generator_factory(t,ee,ie)}};return te.forEach(ie=>ne.next(...ie)),oe}const test_cloneable_generator_factory=describe("cloneable_generator_factory",()=>{function*t(ne){let oe=ne.start;for(;;){let ie=yield++oe;ie!==void 0&&(oe+=ie)}}let ee=cloneable_generator_factory({start:10},t);test(ee.next().value,11,"should increment"),test(ee.next(3).value,11+1+3,"should use jump");let te=ee.clone();test(ee.next().value,16,"should increment again"),test(ee.next(10).value,16+1+10,"should jump again"),test(te.next().value,16,"should have been reset"),test(te.next().value,17,"should not use previous jump"),test(te.next(-10).value,17+1-10,"should jump on second branch"),test(ee.next().value,28,"should jump a third time on first branch")},!1);function random_int(t){return parseInt(`${Math.random()}`.slice(2,2+t),10)}function prepare_args_for_actions_parent_ids(t){const{all_action_ids:ee,all_goal_ids:te,wcomponents_by_id:ne}=t,oe=Array.from(ee).map(_e=>ne[_e]).filter(wcomponent_is_action),ie={};oe.forEach(_e=>ie[_e.id]=_e);const se=Array.from(te).map(_e=>ne[_e]).filter(wcomponent_is_goal),re={};return se.forEach(_e=>re[_e.id]=_e),{actions_by_id:ie,goals_by_id:re}}function*get_actions_parent_ids(t){const{action:ee,actions_by_id:te,goals_by_id:ne}=t;let oe=ee,ie=[],se=new Set([oe.id]);for(;;){(oe.parent_goal_or_action_ids||[]).forEach(le=>{if(se.has(le)){console.warn(`Parent action/goal id already seen: "${le}".  May be circular, may just be a common ancestor.`);return}if(se.add(le),!(te[le]||ne[le])){console.log(`Parent goal or action for id "${le}" not found.  Might be from another base?`);return}ie.push(le)});const re=ie.length>0;if((yield oe.id)||!re)return;const ae=ie.shift();if(!ae)return;const ce=te[ae]||ne[ae];if(!ce)return;oe=ce}}const test_get_actions_parent_ids=describe("get_actions_parent_ids",()=>{function t(oe,ie=[]){return prepare_new_contextless_wcomponent_object({type:"goal",base_id:-1,title:oe,id:oe+` ${random_int(4)}`,parent_goal_or_action_ids:ie})}function ee(oe,ie=[]){return prepare_new_contextless_wcomponent_object({type:"action",base_id:-1,title:oe,id:oe+` ${random_int(4)}`,parent_goal_or_action_ids:ie})}function te(oe){const ie={},se=new Set,re=new Set;return oe.forEach(_e=>{ie[_e.id]=_e,_e.type==="action"?se.add(_e.id):re.add(_e.id)}),prepare_args_for_actions_parent_ids({all_action_ids:se,all_goal_ids:re,wcomponents_by_id:ie})}function ne(oe,ie){const se={action:oe,...te(ie)};return cloneable_generator_factory(se,get_actions_parent_ids)}describe("No parents only self",()=>{const oe=ee("action0",[]),se=ne(oe,[oe]).next();test(se.value,oe.id,"Should return own id"),test(se.done,!1,"Should have no more ids")}),describe("Branching parents grandparents",()=>{const oe=t("goal1"),ie=t("goal2"),se=t("goal3"),re=t("subgoal2&3",[ie.id,se.id]),_e=ee("action1",[oe.id,re.id]);let ae=ne(_e,[_e,oe,ie,se,re]),ce=ae.next();test(ce.value,_e.id,"Should return own id"),test(ce.done,!1,"Should have more ids ready");let le=ae.clone();ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was own id and was also consumed"),test(ce.done,!0,"Should have no more ids ready when last id was own id and was also consumed"),ae=le,ce=ae.next(!1),test(ce.value,oe.id,"Should return next parent id, when last was own id and was not consumed"),le=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=le,ce=ae.next(!1),test(ce.value,re.id,"Should return next parent id, when last was not consumed but there is a sibling id"),le=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=le,ce=ae.next(!1),test(ce.value,ie.id,"Should return next parent id, when last was not consumed but there is a grandparent"),le=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=le,ce=ae.next(!1),test(ce.value,se.id,"Should return next parent id, when last was not consumed and there is a grandparent sibling"),le=ae.clone(),ce=ae.next(!0),test(ce.value,void 0,"Should return nothing when last id was consumed"),test(ce.done,!0,"Should have no more ids ready when last id was consumed"),ae=le,ce=ae.next(!1),test(ce.value,void 0,"Should return undefined when exhausted parent and grandparent ids"),test(ce.done,!0,"Should have no more ids")}),describe("get_actions_parent_ids should work if parents are also actions, and not just for parents that are goals",()=>{const oe=ee("action1"),ie=ee("action2"),se=ee("action3"),re=ee("subaction2&3",[ie.id,se.id]),_e=ee("action1",[oe.id,re.id]);let ae=ne(_e,[oe,ie,se,re,_e]),ce=ae.next();test(ce.value,_e.id,"Should return own id"),ce=ae.next(),test(ce.value,oe.id,"Should return next id"),ce=ae.next(),test(ce.value,re.id,"Should return next id"),ce=ae.next(),test(ce.value,ie.id,"Should return next id"),ce=ae.next(),test(ce.value,se.id,"Should return next id"),ce=ae.next(),test(ce.value,void 0,"Should return no more ids"),test(ce.done,!0,"Should be done")}),describe("Circular parents",()=>{const oe=t("goal1"),ie=ee("action1",[oe.id]);oe.parent_goal_or_action_ids=[ie.id];const se=ee("action2",[oe.id]);let re=ne(se,[ie,se,oe]),_e=re.next();test(_e.value,se.id,"Should return own id"),test(_e.done,!1,"Should have more ids ready"),_e=re.next(),test(_e.value,oe.id,"Should return next id"),test(_e.done,!1,"Should have more ids ready"),_e=re.next(),test(_e.value,ie.id,"Should return next id"),test(_e.done,!1,"Should have not finished"),_e=re.next(),test(_e.done,!0,"Should have finished")}),describe("Spread iterator containing one parent",()=>{const oe=t("goal1"),ie=ee("action1",[oe.id]),re=[...ne(ie,[ie,oe])];test(re,[ie.id,oe.id],"Should return both ids")})},!1),VALID_ACTION_VALUE_POSSIBILITY_ID=new Set(Object.values(ACTION_VALUE_POSSIBILITY_ID));function get_action_active_date_ranges(t){let ee=t.values_and_prediction_sets||[];ee=group_versions_by_id(ee).latest,ee=sort_by_uncertain_event_datetimes(ee,SortDirection.ascending);let te,ne;const oe=[];if(ee.forEach(ie=>{const{entries:se,datetime:re}=ie,ae=get_most_probable_VAPs(se,VAPsType.action).filter(ue=>ue.probability>0&&ue.value_id&&VALID_ACTION_VALUE_POSSIBILITY_ID.has(ue.value_id)),ce=ae[0];if(ae.length!==1||!ce){console.log(`Skipping calculating action_active_date_ranges for VAP_set "${ie.id}" of action "${t.id}"`);return}ce.value_id===ACTION_VALUE_POSSIBILITY_ID.action_in_progress?te||(te=get_uncertain_datetime(re)):te&&(ne=get_uncertain_datetime(re)),te&&ne&&(oe.push({start:te,stop:ne}),te=void 0,ne=void 0)}),te){let ie=new Date;ie.getTime()<te.getTime()&&(ie=te),oe.push({start:te,stop:ie})}return oe}function get_action_active_date_strs(t){const ee=get_action_active_date_ranges(t);let te=[],ne=new Set;return ee.forEach(oe=>{const se=get_inclusive_date_strs(oe.start,oe.stop).filter(re=>!ne.has(re));te=te.concat(se),ne=new Set(te)}),te}const map_state$1i=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=ee==null?void 0:ee.prioritisations,{action:ne,goal:oe}=t.derived.wcomponent_ids_by_type,ie=ee==null?void 0:ee.composed_datetime_line_config;return{prioritisations:te,time_origin_ms:ie==null?void 0:ie.time_origin_ms,time_origin_x:ie==null?void 0:ie.time_origin_x,time_scale:ie==null?void 0:ie.time_scale,presenting:t.display_options.consumption_formatting,all_action_ids:ne,all_goal_ids:oe,wcomponents_by_id:t.specialised_objects.wcomponents_by_id}},connector$1j=connect(map_state$1i),get_svg_children=t=>[];function has_start_date(t){return!!t.start_date}const get_children=t=>{const{prioritisations:ee=[],all_action_ids:te,all_goal_ids:ne,wcomponents_by_id:oe}=t,ie=F$1(()=>process_prioritisations(ee),[ee]),{denormalised_prioritisation_by_id:se,prioritised_goals_and_actions:re}=ie,_e=F$1(()=>process_actions({all_action_ids:te,all_goal_ids:ne,wcomponents_by_id:oe,prioritised_goals_and_actions:re}),[te,ne,oe,re]),{time_origin_ms:ae,time_origin_x:ce,time_scale:le}=default_time_origin_parameters(t),ue=F$1(()=>convert_prioritised_goals_and_actions_to_nodes({denormalised_prioritisation_by_id:se,prioritised_goals_and_actions:re,time_origin_ms:ae,time_origin_x:ce,time_scale:le}),[se,re,ae,ce,le]),de=F$1(()=>convert_daily_actions_to_nodes({date_str_to_daily_actions_map:_e,time_origin_ms:ae,time_origin_x:ce,time_scale:le,prioritised_goals_and_actions:re}),[_e,ae,ce,le,re]);return[...ue,...de]},get_overlay_children=()=>o$1(KnowledgeGraphTimeMarkers,{force_display:!0,show_by_now:!0});function _PrioritiesView(t){const ee=get_children(t);return o$1(MainArea,{main_content:o$1(Canvas,{svg_children:get_svg_children(),svg_upper_children:[],overlay:get_overlay_children(),plain_background:t.presenting,children:ee}),extra_content:o$1(WComponentActionsListModal,{})})}const PrioritiesView=connector$1j(_PrioritiesView),UNCATEGORISED_PRIORITY_ID="UNCATEGORISED_PRIORITY_ID";function process_prioritisations(t){const ee=new Date;let te=t.map(re=>({...re,total_effort:0,start_date:get_uncertain_datetime(re.datetime),end_date:ee})).filter(has_start_date);te=sort_list(te,re=>re.start_date.getTime(),SortDirection.ascending),te.forEach((re,_e)=>{const ae=te[_e+1];re.end_date=get_uncertain_datetime(ae==null?void 0:ae.datetime)||ee});let ne=0;const oe={},ie=[];te.forEach(re=>{Object.entries(re.goals).forEach(([_e,ae])=>{re.total_effort+=ae.effort;let ce=oe[_e];ce===void 0&&(ce=ne++,oe[_e]=ce),ie.push({prioritisation_id:re.id,goal_or_action_id:_e,effort:ae.effort,offset_index:ce})})});const se={};return te.forEach(re=>se[re.id]=re),{denormalised_prioritisation_by_id:se,prioritised_goals_and_actions:ie}}function process_actions(t){const{prioritised_goals_and_actions:ee}=t,te=new Set(ee.map(se=>se.goal_or_action_id)),ne={},oe=prepare_args_for_actions_parent_ids(t);return Object.values(oe.actions_by_id).forEach(se=>{const re=[...get_actions_parent_ids({action:se,...oe})];get_action_active_date_strs(se).forEach(ae=>{const ce=ne[ae]||{prioritised_goal_or_action_ids_to_action_ids_map:{}};let le=!1;for(let ue=0;ue<re.length;++ue){const de=re[ue];if(te.has(de)){le=!0;const me=ce.prioritised_goal_or_action_ids_to_action_ids_map[de]||[];me.push(se.id),ce.prioritised_goal_or_action_ids_to_action_ids_map[de]=me}}if(!le){const ue=ce.prioritised_goal_or_action_ids_to_action_ids_map[UNCATEGORISED_PRIORITY_ID]||[];ue.push(se.id),ce.prioritised_goal_or_action_ids_to_action_ids_map[UNCATEGORISED_PRIORITY_ID]=ue}ne[ae]=ce})}),ne}function convert_prioritised_goals_and_actions_to_nodes(t){const{denormalised_prioritisation_by_id:ee,prioritised_goals_and_actions:te,time_origin_ms:ne,time_origin_x:oe,time_scale:ie}=t;return te.map(({prioritisation_id:se,goal_or_action_id:re,effort:_e,offset_index:ae})=>{const{total_effort:ce,start_date:le,end_date:ue}=ee[se],de=calculate_canvas_x_for_datetime({datetime:le,time_origin_ms:ne,time_origin_x:oe,time_scale:ie}),me=calculate_canvas_x_for_datetime({datetime:ue,time_origin_ms:ne,time_origin_x:oe,time_scale:ie});return o$1(PrioritisationEntryNode,{effort:_e/ce,wcomponent_id:re,x:de,y:100*ae,width:me-de,display:!0})})}function convert_daily_actions_to_nodes(t){const{time_origin_ms:ee,time_origin_x:te,time_scale:ne,prioritised_goals_and_actions:oe}=t,ie={};oe.forEach(re=>{ie[re.goal_or_action_id]=re});const se=[];return Object.entries(t.date_str_to_daily_actions_map).forEach(([re,_e])=>{const ae=new Date(re),ce=calculate_canvas_x_for_datetime({datetime:ae,time_origin_ms:ee,time_origin_x:te,time_scale:ne});Object.entries(_e.prioritised_goal_or_action_ids_to_action_ids_map).forEach(([le,ue])=>{const de=ie[le];let me=-40;if(de)me=100*de.offset_index+70;else if(le!==UNCATEGORISED_PRIORITY_ID)return;se.push(o$1(DailyActionNode,{width:10,height:10,display:!0,x:ce,y:me,action_ids:ue,date_shown:ae}))})}),se}const KnowledgeTimeView$1="",map_state$1h=t=>{const{ready_for_reading:ee}=t.sync,{current_composed_knowledge_view:te}=t.derived;ee&&!te&&console.log("No current_composed_knowledge_view");const{selected_wcomponent_ids_to_ordinal_position_map:ne}=t.meta_wcomponents,{created_at_ms:oe,sim_ms:ie}=t.routing.args;let se=[];return te&&(se=te.wcomponent_nodes),{ready:ee,wcomponent_nodes:se,wcomponent_connections:te&&te.wcomponent_connections,presenting:t.display_options.consumption_formatting,selected_wcomponent_ids_to_ordinal_position_map:ne,created_at_ms:oe,sim_ms:ie}},connector$1i=connect(map_state$1h);class DateRange{constructor(t,ee){Oe(this,"scale","months");Oe(this,"single_time_units",this._ms(1,!1));Oe(this,"scales",Object.keys(this.single_time_units));Oe(this,"dates",[]);Oe(this,"cdate",new Date);Oe(this,"sdate",new Date);Oe(this,"time_resolution","hour");Oe(this,"timeline_spacing",!0);t.length!==0&&(this.time_resolution="day",this.scale=this.time_resolution+"s",this.cdate=new Date(ee.created_at_ms),this.sdate=new Date(ee.sim_ms),this.dates=t.sort((te,ne)=>te.getTime()-ne.getTime()))}_ms(ms,convert=!0){const operator=convert?"/":"*";return{milliseconds:ms,get seconds(){return eval(`${ms} ${operator} 1000`)},get minutes(){return eval(`${this.seconds} ${operator} 60`)},get hours(){return eval(`${this.minutes} ${operator} 60`)},get days(){return eval(`${this.hours} ${operator} 24`)},get months(){return eval(`${this.days} ${operator} 365 / 12`)},get years(){return eval(`${this.days} ${operator} 365`)}}}get scale_index(){return this.scales.indexOf(this.scale)}increment(t,ee=1,te=this.scale){const ne=new Date(t.getTime()),oe=this.get_date_prop_func_names(te);return Object(ne)[oe.set](Object(ne)[oe.get]()+ee),ne}get range_dates(){const t=[],ee=this.round_date(this.increment(this.end_date,1),!0,this.scale),te=this.round_date(this.increment(this.start_date,-1),!1,this.scale);return t.push(te),t.push(ee),t}get start_date(){const t=this.dates.first();return ensure_date(t)}get end_date(){const t=this.dates.last();return ensure_date(t)}get range_start_date(){const t=this.range_dates.first();return ensure_date(t)}get range_end_date(){const t=this.range_dates.last();return ensure_date(t)}get_date_offset_percent(t){let ee=0;const te=t.getTime(),ne=this.range_start_date.getTime(),oe=this.range_end_date.getTime();return ee=(te-ne)/(oe-ne)*100,ee}get_date_prop_func_names(t){let ee,te=null;const ne=t.charAt(0).toUpperCase()+t.slice(1),oe=new Date,ie=`get${ne}`;switch(t){case"days":ee="getDate";break;default:Object(oe)[ie]?ee=ie:Object(oe)[ie.replace(/s$/,"")]&&(ee=ie.replace(/s$/,""))}return ee&&(te=ee.replace(/^get/,"set")),{get:ee,set:te}}round_date(t,ee=!1,te=this.scale){const ne=new Date(t.getTime());return this.scales.forEach((oe,ie)=>{const se=this.get_date_prop_func_names(oe),re=oe==="days"?1:0;ee?ie===this.scale_index?Object(ne)[se.set](Object(ne)[se.get]()+1):ie<this.scale_index&&Object(ne)[se.set](re):ie<this.scale_index&&se.set&&Object(ne)[se.set]&&Object(ne)[se.set](re)}),ee&&ne.setTime(ne.getTime()-1),ne}render(t){if(t.length===0)return null;const ee=new Date(this.range_start_date.getTime()),te=[];for(te.push(new Date(ee.getTime()));ee.getTime()<=this.range_end_date.getTime();){let oe=this.get_date_prop_func_names(this.scale),ie=Object(ee)[oe.get]();Object(ee)[oe.set](ie+1),te.push(new Date(ee.getTime()))}const ne=this.timeline_spacing?`${100+te.length*1.42}%`:"100%";return o$1(Box,{id:"knowledge_time_view",className:`time_view scroll_area_x ${this.scale} ${this.timeline_spacing?"timeline_spacing":"event_spacing"}`,flexGrow:1,flexShrink:1,position:"relative",onScroll:oe=>{let se=oe.target.scrollLeft,re=document.getElementsByClassName("wc");for(let _e=0;_e<re.length;_e++){const ae=re[_e];ae&&(ae.style.marginLeft=`${se}px`)}},children:[o$1(Box,{className:"timeline",display:this.timeline_spacing?"block":"none",height:1,maxHeight:1,position:"absolute",minWidth:ne,width:ne,maxWidth:ne,top:0,right:"auto",bottom:0,left:0,zIndex:1,children:o$1(Box,{width:1,maxWidth:1,height:1,maxHeight:1,display:"flex",flexDirection:"row",flexWrap:"wrap",children:te.map((oe,ie)=>o$1(Box,{className:"unit",flexGrow:1,flexShrink:1,flexBasis:"auto",position:"relative",overflow:"visible",children:o$1(Box,{position:"absolute",className:"tick",width:0,height:1,top:0,right:0,bottom:0,left:0,children:o$1(Box,{className:"rotater",whiteSpace:"nowrap",children:[o$1(Box,{component:"small",className:"days weeks months years",children:oe.toLocaleDateString()}),o$1(Box,{component:"small",className:"hours",children:oe.toLocaleTimeString()})]})})}))})}),o$1(Box,{minWidth:ne,width:ne,maxWidth:ne,minHeight:1,height:1,maxHeight:1,overflow:"hidden",children:o$1(Box,{className:"scroll_area_y",minWidth:"100%",maxWidth:"100%",position:"relative",zIndex:10,height:1,maxHeight:1,children:o$1(Box,{className:"contents",mt:this.timeline_spacing?50:0,children:t.map(oe=>{const ie=wcomponent_has_VAP_sets(oe)?oe.values_and_prediction_sets:[];return o$1(Box,{width:1,maxWidth:1,overflow:"hidden",position:"relative",children:[o$1(Box,{id:`WC-${oe.id}`,className:"wc",display:"inline-block",position:"relative",top:0,children:o$1(WComponentCanvasNode,{id:oe.id,is_on_canvas:!1})}),o$1(Box,{className:"vaps",width:1,maxWidth:1,overflow:"hidden",minHeight:"7em",height:"7em",maxHeight:"7em",p:this.timeline_spacing?0:3,position:"relative",display:`${this.timeline_spacing?"block":"flex"}`,flexDirection:"row",justifyContent:"start",children:ie.map(se=>{const re=get_sim_datetime(se);if(!re)return null;const _e=this.get_date_offset_percent(re);return o$1(Box,{className:"vap",flexGrow:0,flexShrink:1,flexBasis:"auto",display:"inline-block",border:1,minHeight:"100%",height:"100%",maxHeight:"100%",position:`${this.timeline_spacing?"absolute":"static"}`,zIndex:1,left:`${_e}%`,children:o$1(ConnectedValueAndPredictionSetSummary,{wcomponent:oe,VAP_set:se})})})})]})})})})})]})}}function _KnowledgeTimeView(t){let{wcomponent_nodes:ee}=t;const{selected_wcomponent_ids_to_ordinal_position_map:te}=t,ne=[];ee=sort_list(ee,re=>{const _e=te[re.id];return _e!==void 0?_e:get_created_at_ms(re)},SortDirection.ascending),ee.forEach(re=>{(wcomponent_has_VAP_sets(re)?re.values_and_prediction_sets:[]).forEach(ae=>{const ce=get_sim_datetime(ae);ce&&ne.push(ce)})});const se=new DateRange(ne,t).render(ee);return o$1(MainArea,{main_content:se||o$1(Box,{})})}const KnowledgeTimeView=connector$1i(_KnowledgeTimeView);function ensure_date(t){return t instanceof Date?t:new Date}const ActionsListView$1="";var Add={},_interopRequireDefault$f=interopRequireDefaultExports;Object.defineProperty(Add,"__esModule",{value:!0});var default_1$f=Add.default=void 0,_createSvgIcon$f=_interopRequireDefault$f(requireCreateSvgIcon()),_jsxRuntime$f=requireJsxRuntime(),_default$f=(0,_createSvgIcon$f.default)((0,_jsxRuntime$f.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),"Add");default_1$f=Add.default=_default$f;const AddNewActionButton$1="";function prepare_new_VAP_set(t,ee,te,ne,oe){const ie=get_new_created_ats(oe),se=prepare_new_VAP_set_entries(t,ee,te),re=t===VAPsType.action?{value:new Date}:te.length>0?{value:new Date}:{};return{id:get_new_value_and_prediction_set_id(),...ie,base_id:ne,datetime:re,entries:se}}function prepare_new_VAP_set_entries(t,ee,te){const oe=get_possibilities_from_VAP_sets(t,ee,te).map(se=>({...prepare_new_VAP(),value:se.value,value_id:se.id,description:se.description||""}));return set_VAP_probabilities(oe,t)}function create_new_VAP_set_version(t,ee){return{...t,...get_new_created_ats(ee),entries:t.entries.map(ne=>({...ne,explanation:""})),shared_entry_values:{...t.shared_entry_values,explanation:void 0}}}const test_prepare_new_VAP_set=describe("prepare_new_VAP_set",()=>{const t=[{...prepare_new_VAP_set(VAPsType.other,void 0,[],1,{}),entries:[{...prepare_new_VAP(),value_id:"1",value:"a"},{...prepare_new_VAP(),value_id:"2",value:"b"}]},{...prepare_new_VAP_set(VAPsType.other,void 0,[],1,{}),entries:[{...prepare_new_VAP(),value_id:"1",value:"a"},{...prepare_new_VAP(),value_id:"2",value:"b"}]}],ee={1:{id:"1",value:"a",description:"",order:0},2:{id:"2",value:"b",description:"",order:1}};let te=prepare_new_VAP_set(VAPsType.other,ee,t,1,{});test(te.entries.length,2,"If there are only two unique possibilities, only return 2 VAPs")},!1);function update_value_possibilities_with_VAPSets(t,ee){let te=get_max_value_possibilities_order(t);return t&&(t={...t}),ee.forEach(ne=>{ne.entries.forEach(oe=>{var se;if(!oe.value_id)return;t=t||{};const ie=((se=t[oe.value_id])==null?void 0:se.order)??++te;t[oe.value_id]={id:oe.value_id,value:oe.value,description:oe.description,order:ie}})}),t}function update_VAP_set_VAP_probabilities(t,ee){return t.entries.map(te=>{const ne=te.value_id===ee?1:0;return{...te,relative_probability:ne,probability:ne,conviction:1}})}function set_action_VAP_set_state(t){const{existing_value_possibilities:ee,orig_values_and_prediction_sets:te,base_id:ne,creation_context:oe,action_value_possibility_id:ie}=t,se=prepare_new_VAP_set(VAPsType.action,ee,te,ne,oe),re=update_VAP_set_VAP_probabilities(se,ie);return se.entries=re,[...te,se]}function handle_update_VAP_sets(t){const ee=update_value_possibilities_with_VAPSets(t.existing_value_possibilities,t.new_values_and_prediction_sets);t.update_VAPSets_and_value_possibilities({value_possibilities:ee,values_and_prediction_sets:t.new_values_and_prediction_sets});const te=get_latest_VAP_set_datetimes_ms(t.orig_values_and_prediction_sets,t.current_created_at_ms),ne=get_latest_VAP_set_datetimes_ms(t.new_values_and_prediction_sets,t.current_created_at_ms),oe=1*60*1e3,ie=10*oe;let se;ne.latest_created_at_ms>te.latest_created_at_ms&&(se=ne.latest_created_at_ms+oe);const re=new Date().getTime(),_e=ne.latest_sim_ms<re+oe&&ne.latest_sim_ms>re-ie;let ae;t.sim_ms<ne.latest_sim_ms&&_e&&(ae=ne.latest_sim_ms),(se!==void 0||ae!==void 0)&&t.change_route({args:{sim_ms:ae,created_at_ms:se}})}function get_latest_VAP_set_datetimes_ms(t,ee=0){let te=Number.NEGATIVE_INFINITY;return t.forEach(ne=>{ee=Math.max(get_created_at_ms(ne),ee);const oe=get_uncertain_datetime(ne.datetime);oe&&(te=Math.max(oe.getTime(),te))}),{latest_created_at_ms:ee,latest_sim_ms:te}}const map_state$1g=t=>({creation_context:t.creation_context,composed_knowledge_view:get_current_composed_knowledge_view_from_state(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,base_id:selector_chosen_base_id(t)}),connector$1h=connect(map_state$1g);function _AddNewActionButton(t){const{most_recent_action_id:ee,composed_knowledge_view:te,wcomponents_by_id:ne,base_id:oe,list_type:ie,creation_context:se}=t;if(!te)return null;const{id:re,composed_wc_id_map:_e}=te,ae=F$1(()=>make_handle_click({base_id:oe,composed_wc_id_map:_e,most_recent_action_id:ee,wcomponents_by_id:ne,list_type:ie,creation_context:se,knowledge_view_id:re}),[oe,_e,ee,ne,ie,se,re]);return o$1(Button,{className:"add_new_action_button",fullWidth:!1,onClick:ae,disabled:oe===void 0,title:oe===void 0?"No knowledge base selected":"",children:o$1(default_1$f,{})})}const AddNewActionButton=connector$1h(_AddNewActionButton);function make_handle_click(t){const{base_id:ee,composed_wc_id_map:te,most_recent_action_id:ne,wcomponents_by_id:oe,list_type:ie,creation_context:se,knowledge_view_id:re}=t;return function(){if(ee===void 0)throw new Error("No base_id defined in click for AddNewActionButton");const ae=get_next_available_wc_map_position(te,ne,oe);let ce=[];const le=ie==="todo",ue=ie==="in_progress",de=ie==="done";if((ue||de)&&(ce=set_action_VAP_set_state({existing_value_possibilities:void 0,orig_values_and_prediction_sets:[],base_id:ee,creation_context:se,action_value_possibility_id:ACTION_VALUE_POSSIBILITY_ID.action_in_progress}),de)){let pe=new Date;const fe=3600*1e3;pe=new Date(pe.getTime()-fe),ce[0].datetime.value=pe}de&&(ce=set_action_VAP_set_state({existing_value_possibilities:void 0,orig_values_and_prediction_sets:ce,base_id:ee,creation_context:se,action_value_possibility_id:ACTION_VALUE_POSSIBILITY_ID.action_completed}));const me=update_value_possibilities_with_VAPSets(void 0,ce);create_wcomponent({wcomponent:{base_id:ee,type:"action",values_and_prediction_sets:ce,value_possibilities:me,todo_index:le?new Date().getTime():void 0},add_to_knowledge_view:{id:re,position:ae}})}}var ArrowForward={},_interopRequireDefault$e=interopRequireDefaultExports;Object.defineProperty(ArrowForward,"__esModule",{value:!0});var default_1$e=ArrowForward.default=void 0,_createSvgIcon$e=_interopRequireDefault$e(requireCreateSvgIcon()),_jsxRuntime$e=requireJsxRuntime(),_default$e=(0,_createSvgIcon$e.default)((0,_jsxRuntime$e.jsx)("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward");default_1$e=ArrowForward.default=_default$e;var ArrowBack={},_interopRequireDefault$d=interopRequireDefaultExports;Object.defineProperty(ArrowBack,"__esModule",{value:!0});var default_1$d=ArrowBack.default=void 0,_createSvgIcon$d=_interopRequireDefault$d(requireCreateSvgIcon()),_jsxRuntime$d=requireJsxRuntime(),_default$d=(0,_createSvgIcon$d.default)((0,_jsxRuntime$d.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack");default_1$d=ArrowBack.default=_default$d;const PrioritisableAction$1="",map_state$1f=t=>({editing:!t.display_options.consumption_formatting}),map_dispatch$O={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1g=connect(map_state$1f,map_dispatch$O);function _PrioritisableAction(t){const{action:ee,upsert_wcomponent:te}=t;return o$1("div",{className:"prioritisable_action",children:[o$1(WComponentCanvasNode,{id:ee.id,is_on_canvas:!1,always_show:!0}),t.show_icebox_actions&&o$1("div",{className:"controls",children:o$1(IconButton,{size:"medium",onClick:()=>te({wcomponent:{...ee,todo_index:new Date().getTime()}}),children:o$1(default_1$e,{})})}),t.show_todo_actions&&o$1("div",{className:"controls",children:[o$1(IconButton,{size:"medium",onClick:()=>te({wcomponent:{...ee,todo_index:new Date().getTime()}}),children:o$1(default_1$u,{})}),o$1(IconButton,{size:"medium",onClick:()=>te({wcomponent:{...ee,todo_index:void 0}}),children:o$1(default_1$d,{})})]})]})}const PrioritisableAction=connector$1g(_PrioritisableAction);function ActionsListView(t){return o$1(MainArea,{main_content:o$1(ActionsListViewContent,{})})}const map_state$1e=t=>{const{wcomponents_by_id:ee}=t.specialised_objects;return{action_ids:get_action_ids_for_actions_list_view(t),wcomponents_by_id:ee,display_side_panel:t.controls.display_side_panel}},map_dispatch$N={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$1f=connect(map_state$1e,map_dispatch$N);function _ActionsListViewContent(t){const{action_ids:ee,wcomponents_by_id:te}=t,[ne,oe]=h$1(5),[ie,se]=h$1(void 0),re=_$d(void 0),_e=_$d(void 0),ae=F$1(()=>{const he=get_wcomponents_from_ids(te,ee).filter(wcomponent_is_action);return sort_list(he,get_modified_or_created_at,SortDirection.descending)},[ee,te]),ce=[],le=[],ue=[],de=[],me=new Date().getTime();ae.forEach(he=>{const ve=get_wcomponent_state_value_and_probabilities({wcomponent:he,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:me,sim_ms:me}).most_probable_VAP_set_values[0];(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_in_progress?ue.push(he):(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_completed||(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_rejected||(ve==null?void 0:ve.value_id)===ACTION_VALUE_POSSIBILITY_ID.action_failed?de.push(he):he.todo_index?le.push(he):ce.push(he)});const pe=de.length-ne,fe=sort_list(le,he=>he.todo_index||0,SortDirection.descending),ge=F$1(()=>{var ve;return((ve=(sort_list(ae,get_created_at_ms,SortDirection.descending)||[])[0])==null?void 0:ve.id)||""},[ae]);return o$1("div",{className:`action_list_view_content ${ie===void 0?"":"moving"}`,ref:he=>_e.current=he||void 0,onPointerDown:he=>{const be=_e.current;be&&(se({x:he.clientX,y:he.clientY}),re.current={left:be.scrollLeft,top:be.scrollTop})},onPointerMove:he=>{if(ie===void 0||re.current===void 0||!_e.current)return;const be=re.current.left-(he.clientX-ie.x),ve=re.current.top-(he.clientY-ie.y);_e.current.scroll(be,ve)},onPointerUp:he=>se(void 0),onPointerLeave:he=>se(void 0),onPointerOut:he=>{let be=he.relatedTarget;be=find_parent_element_by_classes(be,["action_list","action_list_view_content"]),!be&&se(void 0)},children:[o$1("div",{className:"action_list icebox",children:[o$1("h1",{children:["Icebox",o$1(AddNewActionButton,{list_type:"icebox",most_recent_action_id:ge})]}),ce.map(he=>o$1(PrioritisableAction,{action:he,show_icebox_actions:!0},he.id))]}),o$1("div",{className:"action_list todo",children:[o$1("h1",{children:["Todo",o$1(AddNewActionButton,{list_type:"todo",most_recent_action_id:ge})]}),fe.map(he=>o$1(PrioritisableAction,{action:he,show_todo_actions:!0},he.id))]}),o$1("div",{className:"action_list in_progress",children:[o$1("h1",{children:["In progress",o$1(AddNewActionButton,{list_type:"in_progress",most_recent_action_id:ge})]}),ue.map(he=>o$1(PrioritisableAction,{action:he},he.id))]}),o$1("div",{className:"action_list done_or_rejected",children:[o$1("h1",{children:["Done",o$1(AddNewActionButton,{list_type:"done",most_recent_action_id:ge})]}),de.slice(0,ne).map(he=>o$1(PrioritisableAction,{action:he},he.id)),pe>0&&o$1("div",{style:{textAlign:"center",margin:40,cursor:"pointer"},onClick:()=>oe(ne+50),children:["... ",pe," hidden ..."]})]}),o$1("div",{className:"side_panel_padding",style:{minWidth:t.display_side_panel?SIDE_PANEL_WIDTH:0}})]})}const ActionsListViewContent=connector$1f(_ActionsListViewContent);function get_modified_or_created_at(t){return t.modified_at?t.modified_at.getTime():get_created_at_ms(t)}const map_state$1d=t=>{const{view:ee}=t.routing.args,{display_by_simulated_time:te}=t.display_options;return{view:ee,display_by_simulated_time:te}},connector$1e=connect(map_state$1d);function _MainAreaRouter(t){let ee=o$1("div",{children:["Unsupported view: ",t.view]});return t.view==="knowledge"?t.display_by_simulated_time?ee=o$1(KnowledgeTimeView,{}):ee=o$1(KnowledgeGraphView,{}):t.view==="priorities"?ee=o$1(PrioritiesView,{}):t.view==="priorities_list"?ee=o$1(PrioritiesListView,{}):t.view==="actions_list"&&(ee=o$1(ActionsListView,{})),ee}const MainAreaRouter=connector$1e(_MainAreaRouter);var Menu={},_interopRequireDefault$c=interopRequireDefaultExports;Object.defineProperty(Menu,"__esModule",{value:!0});var default_1$c=Menu.default=void 0,_createSvgIcon$c=_interopRequireDefault$c(requireCreateSvgIcon()),_jsxRuntime$c=requireJsxRuntime(),_default$c=(0,_createSvgIcon$c.default)((0,_jsxRuntime$c.jsx)("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"}),"Menu");default_1$c=Menu.default=_default$c;const map_state$1c=t=>({use_creation_context:t.creation_context.use_creation_context}),map_dispatch$M={toggle_use_creation_context:ACTIONS.creation_context.toggle_use_creation_context},connector$1d=connect(map_state$1c,map_dispatch$M);function _CreationContextTabTitle(t){return o$1("div",{children:["Creation Context",o$1("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:t.use_creation_context,onClick:ee=>{ee.stopPropagation(),ee.preventDefault()},onPointerDown:ee=>{ee.stopPropagation(),ee.preventDefault(),t.toggle_use_creation_context()}})]})}const CreationContextTabTitle=connector$1d(_CreationContextTabTitle),map_state$1b=t=>({apply_filter:t.filter_context.apply_filter}),map_dispatch$L={set_apply_filter:ACTIONS.filter_context.set_apply_filter},connector$1c=connect(map_state$1b,map_dispatch$L);function _FilterContextTabTitle(t){return o$1("div",{children:["Filter",o$1("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:t.apply_filter,onClick:ee=>{ee.stopPropagation(),ee.preventDefault()},onPointerDown:ee=>{ee.stopPropagation(),ee.preventDefault(),t.set_apply_filter(!t.apply_filter)}})]})}const FilterContextTabTitle=connector$1c(_FilterContextTabTitle);function sentence_case(t){return t.slice(0,1).toUpperCase()+t.slice(1).toLowerCase()}function route_to_text(t){return t==="wcomponents"?"Components":t==="display"?"Display Options":t==="select"?"Selection":sentence_case(t.replaceAll("_"," "))}function get_title(t){return t==="filter"?o$1(FilterContextTabTitle,{}):t==="creation_context"?o$1(CreationContextTabTitle,{}):route_to_text(t)}const map_state$1a=t=>({current_route:t.routing.route}),map_dispatch$K={change_route:ACTIONS.routing.change_route},connector$1b=connect(map_state$1a,map_dispatch$K);function _AppMenuItem(t){const ee=()=>{t.on_pointer_down(),t.change_route({route:t.id,sub_route:null,item_id:null})},te=()=>(t.on_pointer_down(),!1),ne=get_title(t.id);return o$1(CustomisableAppMenuItem,{on_pointer_down:ee,children:o$1(Link,{route:t.id,sub_route:null,item_id:null,args:void 0,on_pointer_down:te,children:ne})})}const AppMenuItem=connector$1b(_AppMenuItem);function CustomisableAppMenuItem(t){return o$1(MenuItem,{style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},onPointerDown:ee=>{ee.stopImmediatePropagation(),t.on_pointer_down()},children:t.children})}const map_state$19=t=>({route:t.routing.route,editing:!t.display_options.consumption_formatting}),map_dispatch$J={set_show_help_menu:ACTIONS.display.set_show_help_menu,change_route:ACTIONS.routing.change_route},connector$1a=connect(map_state$19,map_dispatch$J),hide_routes=new Set(["objects","patterns","statements"]),base_allowed_routes=ALLOWED_ROUTES.filter(t=>!hide_routes.has(t));function _AppMenuItemsContainer(t){const[ee,te]=h$1(null),ne=_e=>{te(_e.currentTarget)},oe=()=>{te(null)},[ie,se]=h$1(!1);let re=base_allowed_routes;if(!ie){const _e=new Set(["about","creation_context"]);re=re.filter(ae=>!_e.has(ae)||t.editing&&ae==="creation_context")}return o$1("div",{children:[o$1("div",{style:{display:"flex",flexDirection:"row"},children:[o$1(Button$2,{style:{display:"flex",flex:1},children:o$1("b",{style:{width:"100%",display:"flex"},onClick:()=>{t.change_route({route:t.route,item_id:null,sub_route:null})},children:route_to_text(t.route)})}),o$1(Button$2,{"aria-controls":"select_tab","aria-haspopup":"true",style:{display:"flex",flex:1,justifyContent:"end"},onClick:ne,children:o$1(default_1$c,{})})]}),o$1(Menu$1,{anchorEl:ee,id:"select_tab",onClose:oe,open:!!ee,keepMounted:!0,children:[re.map(_e=>o$1(AppMenuItem,{id:_e,on_pointer_down:oe})),o$1(CustomisableAppMenuItem,{on_pointer_down:()=>{oe(),t.set_show_help_menu({show:!0})},children:"Help"}),o$1(MenuItem,{onClick:()=>se(!ie),style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},children:[ie?"Hide extra":"Show all"," options"]})]})]})}const AppMenuItemsContainer=connector$1a(_AppMenuItemsContainer),map_state$18=t=>({}),connector$19=connect(map_state$18);function _AboutSidePanel(t){return o$1("div",{children:[o$1("span",{className:"description_label",children:"Version"})," ",o$1("b",{children:"2024-03-15"})]})}const AboutSidePanel=connector$19(_AboutSidePanel);function EditableCheckbox(t){t.value;const{on_change:ee}=t,te=t.disabled||!ee;return o$1("input",{type:"checkbox",checked:t.value,disabled:te,style:{cursor:te?"not-allowed":""},onChange:ne=>{if(!ee)return;const oe=ne.currentTarget.checked;ee(oe)}})}function EditableText(t){return o$1(EditableTextCommon,{...t,component:({value:ee,on_render:te,on_focus:ne,on_change:oe,on_blur:ie,on_key_down:se})=>o$1(TextField,{fullWidth:!0,size:"small",variant:"standard",label:t.placeholder,multiline:!0,value:ee,onFocus:ne,onChange:oe,onBlur:ie,onKeyDown:se,inputRef:te,spellcheck:t.spellcheck})})}var Clear={},_interopRequireDefault$b=interopRequireDefaultExports;Object.defineProperty(Clear,"__esModule",{value:!0});var default_1$b=Clear.default=void 0,_createSvgIcon$b=_interopRequireDefault$b(requireCreateSvgIcon()),_jsxRuntime$b=requireJsxRuntime(),_default$b=(0,_createSvgIcon$b.default)((0,_jsxRuntime$b.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear");default_1$b=Clear.default=_default$b;function SelectedOption(t){const{editing:ee,option:te,on_remove_option:ne,on_pointer_down_selected_option:oe,on_mouse_over_option:ie,on_mouse_leave_option:se}=t;return te?o$1(ButtonGroup,{size:"small",color:"primary",variant:"contained",fullWidth:!0,disableElevation:!0,style:{margin:5},children:[o$1(Button,{onClick:re=>oe&&oe(re,te.id),disabled:!oe,style:{cursor:oe?"":"not-allowed",backgroundColor:te.color&&color_to_string(te.color),color:te.color&&color_to_string(color_to_opposite(te.color))},children:o$1(Tooltip,{title:te.jsx||te.title,children:o$1(Typography,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:te.jsx||te.title})})}),ee&&o$1(IconButton,{onClick:()=>ne(te.id),size:"small",children:o$1(default_1$b,{})})]}):null}const map_state$17=(t,ee)=>({editable:ee.editing_allowed!==void 0?ee.editing_allowed:!t.display_options.consumption_formatting}),map_dispatch$I={change_route:ACTIONS.routing.change_route},connector$18=connect(map_state$17,map_dispatch$I);function _MultiAutocompleteText(t){const{editable:ee,options:te,selected_option_ids:ne}=t,{filtered_options:oe,missing_options_by_id:ie}=F$1(()=>{const re=te.filter(({id:ae})=>!ne.includes(ae)),_e={};if(re.length!==ne.length){const ae=new Set(re.map(({id:le})=>le));ne.filter(le=>!ae.has(le)).forEach(le=>{const ue={id:le,title:"<Label Not found>"};_e[le]=ue,re.push(ue)})}return{filtered_options:re,missing_options_by_id:_e}},[te,ne]),se=F$1(()=>{const re={...ie};return te.forEach(_e=>re[_e.id]=_e),re},[te,ie]);return o$1(Box,{width:"100%",overflowX:"hidden",children:[ee&&o$1(AutocompleteText,{...t,selected_option_id:void 0,options:oe,on_change:re=>{re!==void 0&&t.on_change([...ne,re])},editing_allowed:ee}),o$1("div",{style:{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden"},children:ne.map(re=>o$1("div",{style:{flexGrow:1,flexShrink:1,flexBasis:"30%",maxWidth:"100%"},children:o$1(SelectedOption,{editing:ee,option:se[re],on_remove_option:_e=>{t.on_change(ne.filter(ae=>ae!==_e))},on_mouse_over_option:t.on_mouse_over_option,on_mouse_leave_option:t.on_mouse_leave_option,on_pointer_down_selected_option:(_e,ae)=>{t.change_route({item_id:ae})}})}))})]})}const ConnectedMultiAutocompleteText=connector$18(_MultiAutocompleteText);function MultiAutocompleteText(t){return o$1(ConnectedMultiAutocompleteText,{...t})}const map_state$16=(t,{})=>({ready:t.sync.ready_for_reading,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}),map_dispatch$H={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent},connector$17=connect(map_state$16,map_dispatch$H);function _LabelsEditor(t){const{ready:ee,label_ids:te=[]}=t;if(!ee)return o$1("div",{children:"Loading labels..."});let ne;t.allowed_label_ids&&(ne=new Set(t.allowed_label_ids),te.forEach(ie=>ne==null?void 0:ne.add(ie)));const oe=get_wcomponent_search_options({allowed_wcomponent_ids:ne,wcomponents_by_id:t.wcomponents_by_id,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:t.wc_id_to_counterfactuals_map,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1(MultiAutocompleteText,{placeholder:"Add Label",selected_option_ids:te||[],options:oe,allow_none:!0,on_change:ie=>{t.on_change(ie.filter(se=>!!se))},on_mouse_over_option:ie=>t.set_highlighted_wcomponent({id:ie,highlighted:!0}),on_mouse_leave_option:ie=>t.set_highlighted_wcomponent({id:ie,highlighted:!1}),editing_allowed:t.editing_allowed})}const LabelsEditor=connector$17(_LabelsEditor),map_state$15=t=>{const{creation_context:ee}=t.creation_context;return{use_creation_context:t.creation_context.use_creation_context,custom_created_at:ee==null?void 0:ee.custom_created_at,label_ids:ee==null?void 0:ee.label_ids,replace_text_target:ee==null?void 0:ee.replace_text_target,replace_text_replacement:ee==null?void 0:ee.replace_text_replacement}},map_dispatch$G={toggle_use_creation_context:ACTIONS.creation_context.toggle_use_creation_context,set_custom_created_at:ACTIONS.creation_context.set_custom_created_at,set_label_ids:ACTIONS.creation_context.set_label_ids,set_replace_text:ACTIONS.creation_context.set_replace_text},connector$16=connect(map_state$15,map_dispatch$G);function _CreationContextSidePanel(t){return o$1("div",{children:[o$1("p",{children:["Enabled: ",o$1(EditableCheckbox,{value:t.use_creation_context,on_change:()=>t.toggle_use_creation_context()})]}),o$1("p",{children:["Custom created at datetime: ",o$1(EditableCustomDateTime,{value:t.custom_created_at,on_change:ee=>t.set_custom_created_at({custom_created_at:ee})}),t.custom_created_at!==void 0&&o$1("div",{style:{backgroundColor:"pink"},children:["Tip: you only need to set this for easing entry of historical data.  If you want to view the data you are currently entering in a lower time resolution then use the",o$1(Link,{route:"display",sub_route:void 0,item_id:void 0,args:void 0,children:" display options "}),"to change the time resolution."]})]}),o$1("p",{children:["Automatically label with: ",o$1(LabelsEditor,{label_ids:t.label_ids,on_change:ee=>t.set_label_ids({label_ids:ee})})]}),o$1("p",{children:["Automatically replace text:",o$1("br",{}),o$1(EditableText,{placeholder:"Target text...",value:t.replace_text_target||"",conditional_on_change:ee=>t.set_replace_text({value:ee||void 0,value_type:"target"})}),o$1("br",{}),o$1(EditableText,{placeholder:"Replacement text...",value:t.replace_text_replacement||"",conditional_on_change:ee=>t.set_replace_text({value:ee||void 0,value_type:"replacement"})})]})]})}const CreationContextSidePanel=connector$16(_CreationContextSidePanel),_time_resolution_types={second:!0,minute:!0,hour:!0,day:!0},time_resolution_types$1=Object.keys(_time_resolution_types),map_state$14=t=>({time_resolution:t.display_options.time_resolution,display_by_simulated_time:t.display_options.display_by_simulated_time}),map_dispatch$F={set_time_resolution:ACTIONS.display.set_time_resolution},connector$15=connect(map_state$14,map_dispatch$F);function _TimeResolutionOptions(t){const ee=invert_disabled_appearance();return t.display_by_simulated_time?null:o$1(ButtonGroup,{disableElevation:!0,variant:"contained",value:t.time_resolution,children:time_resolution_types.map(te=>o$1(Button$2,{value:te,onClick:()=>t.set_time_resolution({time_resolution:te}),className:ee.inverse_disabled,disabled:t.time_resolution===te,children:te}))})}const TimeResolutionOptions=connector$15(_TimeResolutionOptions),time_resolution_types=time_resolution_types$1.filter(t=>t!=="second");var ActionCommands=(t=>(t.click="click",t.drag="drag",t))(ActionCommands||{});const shortcuts_map={help:{shortcut:["?"],outcome:"Opens this help menu"},fit_view:{shortcut:["space"],outcome:"Fit view to components / cycle between groups of components."},toggle_present_edit:{shortcut:["Ctrl","e"],outcome:"Toggle between presentation and editing modes"},toggle_side:{shortcut:["Ctrl","d","s"],outcome:"Toggle showing side panel"},toggle_time:{shortcut:["Ctrl","d","t"],outcome:"Toggle showing time sliders"},toggle_focused:{shortcut:["Ctrl","d","f"],outcome:'Toggle "focused" mode on and off'},toggle_animating:{shortcut:["Ctrl","d","a"],outcome:"Toggle animating connections"},toggle_circular_connections:{shortcut:["Ctrl","d","c"],outcome:"Toggle showing connections as (more) circular"},select_multiple:{shortcut:["Shift","click","drag"],outcome:"Select multiple nodes"},deselect_multiple:{shortcut:["Shift","Ctrl","click","drag"],outcome:"Deselect multiple nodes"},select_all:{shortcut:["Ctrl","a"],outcome:"Select all nodes on knowledge view"},expand_select_forwards:{shortcut:["Ctrl","s","f"],outcome:"Expand selection towards effects (forwards)"},expand_select_backwards:{shortcut:["Ctrl","s","c"],outcome:"Expand selection towards causes (backwards)"},expand_select:{shortcut:["Ctrl","s","e"],outcome:"Expand selection"},decrease_select:{shortcut:["Ctrl","s","d"],outcome:"Decrease selection (along non circular connections and nodes)"},select_interconnections:{shortcut:["Ctrl","s","i"],outcome:"Select components inbetween (interconnections)"},search:{shortcut:["Ctrl","f"],outcome:"Open the search menu"}},shortcuts_list=[shortcuts_map.help,shortcuts_map.fit_view,shortcuts_map.toggle_present_edit,shortcuts_map.toggle_side,shortcuts_map.toggle_time,shortcuts_map.toggle_focused,shortcuts_map.toggle_animating,shortcuts_map.toggle_circular_connections,shortcuts_map.select_multiple,shortcuts_map.deselect_multiple,shortcuts_map.select_all,shortcuts_map.expand_select_forwards,shortcuts_map.expand_select_backwards,shortcuts_map.expand_select,shortcuts_map.decrease_select,shortcuts_map.select_interconnections,shortcuts_map.search];function intersperse(t,ee){const te=[];for(let ne=0;ne<t.length;++ne){const oe=t[ne];if(te.push(oe),ne>=t.length-1)continue;const ie=t[ne+1];te.push(ee(oe,ie))}return te}const test_array_functions=describe("array functions",()=>{let t=intersperse([],()=>0);test(t,[],"intersperse with no elements should be empty"),t=intersperse(["a"],()=>0),test(t,["a"],"intersperse with 1 element should have no interspersed values"),t=intersperse(["a","b","c"],(ee,te)=>ee.charCodeAt(0)+te.charCodeAt(0)),test(t,["a",195,"b",197,"c"],"intersperse with 3 elements should have interspersed values")},!1);function PlainShortcutKeys(t){return o$1("div",{className:"description",style:{display:"inline"},children:intersperse(t.shortcut,()=>o$1("span",{children:" + "}))})}function ShortcutKeys(t){return o$1(Typography,{component:"dt",style:{display:"inline"},children:t.shortcut.map((ee,te)=>{const ne=ee===ActionCommands.click||ee===ActionCommands.drag?"physical_action":"physical_button";return o$1("div",{style:{display:"inline"},children:[o$1("div",{className:ne,children:ee}),te<t.shortcut.length-1&&o$1("span",{className:"shortcut_plus",children:" + "})]})})})}function ShortcutCommand(t){return o$1(Box,{component:"dl",children:[o$1(ShortcutKeys,{shortcut:t.shortcut}),o$1("div",{style:{display:"inline"},children:["   ",t.outcome," "]})]})}const map_state$13=t=>({validity_filter:t.display_options.validity_filter,certainty_formatting:t.display_options.certainty_formatting,display_by_simulated_time:t.display_options.display_by_simulated_time,focused_mode:t.display_options.focused_mode,circular_links:t.display_options.circular_links,display_time_marks:t.display_options.display_time_marks,animate_connections:t.display_options.animate_connections,show_large_grid:t.display_options.show_large_grid,display_time_sliders:t.controls.display_time_sliders}),map_dispatch$E={set_validity_filter:ACTIONS.display.set_validity_filter,set_certainty_formatting:ACTIONS.display.set_certainty_formatting,set_display_by_simulated_time:ACTIONS.display.set_display_by_simulated_time,set_or_toggle_focused_mode:ACTIONS.display.set_or_toggle_focused_mode,set_or_toggle_circular_links:ACTIONS.display.set_or_toggle_circular_links,set_display_time_marks:ACTIONS.display.set_display_time_marks,set_or_toggle_animate_connections:ACTIONS.display.set_or_toggle_animate_connections,set_or_toggle_show_large_grid:ACTIONS.display.set_or_toggle_show_large_grid,set_display_time_sliders:ACTIONS.controls.set_display_time_sliders},connector$14=connect(map_state$13,map_dispatch$E);function _DisplayOptionsSidePanel(t){return o$1("div",{className:"side_panel",children:[o$1("p",{className:"section",children:[o$1("b",{children:"Validity filter"}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Show:   ",o$1(AutocompleteText,{placeholder:"",options:validity_filter_display_options,selected_option_id:t.validity_filter,allow_none:!1,on_change:ee=>{ee&&t.set_validity_filter({validity_filter:ee})},editing_allowed:!0})]}),o$1("br",{}),o$1("div",{className:"description",children:["Show only nodes and connections with validity ",o$1("br",{}),o$1("i",{children:["certainty ",validity_filter_descriptions[t.validity_filter]]})," ",description_of_certainty,"."]})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Validity formatting"}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Opacity:   ",o$1(AutocompleteText,{placeholder:"",options:certainty_formatting_display_options,selected_option_id:t.certainty_formatting,allow_none:!1,on_change:ee=>{ee&&t.set_certainty_formatting({certainty_formatting:ee})},editing_allowed:!0})]}),o$1("br",{}),o$1("div",{className:"description",children:["Show nodes and connection opacity as ",o$1("i",{children:certainty_formatting_descriptions[t.certainty_formatting]})," ",description_of_certainty,"."]})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Time resolution"}),"  ",o$1(TimeResolutionOptions,{})]}),o$1("p",{className:"section",children:[o$1("b",{children:'Use "Focused" Mode'}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_focused}),o$1(EditableCheckbox,{value:t.focused_mode,on_change:t.set_or_toggle_focused_mode})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Show connections as more circular"}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_circular_connections}),o$1(EditableCheckbox,{value:t.circular_links,on_change:t.set_or_toggle_circular_links})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Animate connections"}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_animating}),o$1(EditableCheckbox,{value:t.animate_connections,on_change:t.set_or_toggle_animate_connections})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Show time markers"}),o$1(EditableCheckbox,{value:t.display_time_marks,on_change:t.set_display_time_marks})]}),o$1("p",{className:"section",children:[o$1("b",{children:"Show large grid (whilst editing)"}),o$1(EditableCheckbox,{value:t.show_large_grid,on_change:t.set_or_toggle_show_large_grid})]}),o$1("hr",{}),o$1("h3",{children:"Controls"}),o$1("p",{className:"section",children:[o$1("b",{children:'Display time sliders for "created at" and "simulated" time'}),"  ",o$1(PlainShortcutKeys,{...shortcuts_map.toggle_time}),o$1(EditableCheckbox,{value:t.display_time_sliders,on_change:ee=>{t.set_display_time_sliders(ee)}})]})]})}const DisplayOptionsSidePanel=connector$14(_DisplayOptionsSidePanel),description_of_certainty="(certainty is the minimum of probability or confidence, e.g. something with 70% probability and 20% confidence is 20% certain)",validity_filter_display_options=[{id:"only_certain_valid",title:"Only valid"},{id:"only_maybe_valid",title:"Only maybe Valid"},{id:"maybe_invalid",title:"Maybe Invalid"},{id:"show_invalid",title:"Invalid"}],validity_filter_descriptions={only_certain_valid:"100%",only_maybe_valid:"> 50%",maybe_invalid:"> 0%",show_invalid:">= 0%"},certainty_formatting_display_options=[{id:"render_certainty_as_opacity",title:"Use certainty"},{id:"render_certainty_as_easier_opacity",title:"Use certainty (opacity >= 50%)"},{id:"render_100_opacity",title:"Always 100%"}],certainty_formatting_descriptions={render_certainty_as_opacity:"proportional to certainty",render_certainty_as_easier_opacity:"proportional to certainty but no lower than 50% (easier to see)",render_100_opacity:"always 100% (no transparency)"},map_state$12=t=>{var ne;const{wc_label_ids:ee,wc_types:te}=((ne=t.derived.current_composed_knowledge_view)==null?void 0:ne.available_filter_options)||{};return{wc_label_ids:ee,wc_types:te,apply_filter:t.filter_context.apply_filter,filters:t.filter_context.filters,is_on_actions_list_view:get_is_on_actions_list_view(t)}},map_dispatch$D={set_apply_filter:ACTIONS.filter_context.set_apply_filter,set_filters:ACTIONS.filter_context.set_filters},connector$13=connect(map_state$12,map_dispatch$D);function _FiltersSidePanel(t){const{wc_label_ids:ee,wc_types:te,filters:ne}=t,oe=F$1(()=>[...te||[]].concat(ne.exclude_by_component_types).map(re=>({id:re,title:wcomponent_type_to_text(re)})),[te,ne]),ie=F$1(()=>[...te||[]].concat(ne.include_by_component_types).map(re=>({id:re,title:wcomponent_type_to_text(re)})),[te,ne]);return o$1("div",{children:[o$1("p",{children:["Enabled: ",o$1(EditableCheckbox,{value:t.apply_filter,on_change:()=>t.set_apply_filter(!t.apply_filter)})]}),o$1("p",{children:["Filter by label:",o$1(LabelsEditor,{allowed_label_ids:ee,label_ids:t.filters.include_by_label_ids,on_change:se=>{t.set_filters({filters:{...t.filters,include_by_label_ids:se}})},editing_allowed:!0})]}),o$1("p",{children:["Exclude by label:",o$1(LabelsEditor,{allowed_label_ids:ee,label_ids:t.filters.exclude_by_label_ids,on_change:se=>{t.set_filters({filters:{...t.filters,exclude_by_label_ids:se}})},editing_allowed:!0})]}),o$1("p",{children:["Filter by component type:",o$1(MultiAutocompleteText,{placeholder:"",selected_option_ids:t.filters.include_by_component_types,options:ie,allow_none:!0,on_change:se=>{t.set_filters({filters:{...t.filters,include_by_component_types:se}})},editing_allowed:!0})]}),o$1("p",{children:["Exclude by component type:",o$1(MultiAutocompleteText,{placeholder:"",selected_option_ids:t.filters.exclude_by_component_types,options:oe,allow_none:!0,on_change:se=>{t.set_filters({filters:{...t.filters,exclude_by_component_types:se}})},editing_allowed:!0})]}),t.is_on_actions_list_view&&o$1(k$1,{children:[o$1("br",{}),o$1("hr",{}),o$1("h3",{children:"Actions list filters"}),o$1("p",{children:["Filter by current knowledge view: ",o$1(EditableCheckbox,{value:t.filters.filter_by_current_knowledge_view,on_change:()=>{const se={...t.filters,filter_by_current_knowledge_view:!t.filters.filter_by_current_knowledge_view};t.set_filters({filters:se})}})]}),o$1("p",{children:["Filter by text: ",o$1(EditableTextSingleLine,{size:"small",placeholder:"",editing_allowed:!0,value:t.filters.filter_by_text,on_blur:se=>{const re={...t.filters,filter_by_text:se.trim()};t.set_filters({filters:re})},on_blur_type:EditableTextOnBlurType.conditional})]})]})]})}const FiltersSidePanel=connector$13(_FiltersSidePanel),knowledge_view_tree_sort_types=["priority","normal","hidden","archived"],map_state$11=t=>({knowledge_views:t.derived.knowledge_views,nested_knowledge_view_ids_map:t.derived.nested_knowledge_view_ids.map}),connector$12=connect(map_state$11);function _SelectKnowledgeView(t){const{placeholder:ee,selected_option_id:te=void 0,allowed_ids:ne,exclude_ids:oe=new Set,on_change:ie,knowledge_views:se,nested_knowledge_view_ids_map:re}=t,_e=F$1(()=>filter_knowledge_views(se,ne,oe).map(({id:ce,title:le})=>{let ue="",de=re[ce];for(;de;)ue=" / "+de.title+ue,de=re[(de==null?void 0:de.parent_id)||""];return{id:ce,title:le,subtitle:ue}}).sort((ce,le)=>ce.title<le.title?-1:1),[se,ne,oe,re]);return o$1(AutocompleteText,{placeholder:ee||"Select knowledge view...",allow_none:!0,selected_option_id:te,options:_e,on_change:ie,editing_allowed:t.editing_allowed})}const SelectKnowledgeView=connector$12(_SelectKnowledgeView);function filter_knowledge_views(t,ee,te){let ne=t;return ee&&(ne=ne.filter(({id:oe})=>ee.has(oe))),te.size&&(ne=ne.filter(({id:oe})=>!te.has(oe))),ne}const map_state$10=t=>({knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,editing:!t.display_options.consumption_formatting}),map_dispatch$C={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$11=connect(map_state$10,map_dispatch$C);function _FoundationKnowledgeViewsList(t){const{owner_knowledge_view:ee,knowledge_views_by_id:te,on_change:ne,editing:oe}=t,ie=ee.foundation_knowledge_view_ids||[],se=new Set(ie),re=[],_e=[];ie.forEach(de=>{const me=te[de];me?re.push(me):_e.push(de)}),_e.length&&console.warn(`Did not find foundational knowledge view ids: ${_e.join(", ")}`);const ae=new Set(se);ae.add(ee.id);const ce=re.length,{parent_knowledge_view_id:le}=ee,ue=!!re.find(de=>de.id===le);return o$1("div",{children:[(oe||re.length>0)&&"Foundational Views",oe&&o$1("span",{children:["(",ce,")"]}),oe&&o$1(SelectKnowledgeView,{placeholder:"Search for knowledge view to add...",exclude_ids:ae,on_change:de=>{de&&ne([de,...ie])}}),oe&&le&&!ue&&o$1(Button,{value:"Use parent view as foundation",onClick:()=>ne([le,...ie])}),re.map((de,me)=>o$1("div",{style:{display:"flex",flexDirection:"row"},children:[o$1("div",{style:{flex:"1"},children:ce-me}),o$1("div",{style:{flex:"9"},children:de.title}),o$1("div",{style:{flex:"3"},children:oe&&o$1(Button,{value:"remove",onClick:()=>{ne(remove_element(ie,pe=>pe===de.id))}})})]},de.id)),_e.length>0&&o$1("div",{children:["Could not find ",_e.length," knowledge views"]})]})}const FoundationKnowledgeViewsList=connector$11(_FoundationKnowledgeViewsList),map_state$$=(t,ee)=>{const te=get_knowledge_view_from_state(t,ee.knowledge_view_id),{wcomponents_by_id:ne,knowledge_views_by_id:oe}=t.specialised_objects;return{knowledge_view:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,editing:!t.display_options.consumption_formatting,is_current_kv:t.routing.args.subview_id===ee.knowledge_view_id}},connector$10=connect(map_state$$);function _KnowledgeViewActiveCounterFactuals(t){const{editing:ee,knowledge_view:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,on_change:ie}=t,[se,re]=h$1(t.is_current_kv||t.show_automatically||!1);if(!te)return o$1("div",{});if(!se)return o$1(Button,{value:"Calculate active assumptions",onClick:()=>re(!0)});const _e=te.active_counterfactual_v2_ids||[],ae=get_foundational_knowledge_views(te,oe,!0),ce=F$1(()=>{const le=get_composed_wc_id_maps_object(ae,ne).composed_wc_id_map;return Object.keys(le).map(de=>ne[de]).filter(is_defined).filter(({type:de})=>de==="counterfactualv2").map(de=>({id:de.id,title:get_title$1({wcomponent:de,text_type:RichTextType.plain,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:void 0,created_at_ms:FUTURE_TIME_MS,sim_ms:FUTURE_TIME_MS})}))},[ne,...ae]);if(ee){if(ce.length===0)return o$1("div",{children:"No counterfactuals in composed knowledge view (includes foundational knowledge views)"})}else if(_e.length===0)return o$1("div",{children:"No assumptions set"});return o$1("div",{children:o$1(MultiAutocompleteText,{placeholder:"...",allow_none:!0,selected_option_ids:_e,options:ce,on_change:ie})})}const KnowledgeViewActiveCounterFactuals=connector$10(_KnowledgeViewActiveCounterFactuals),FUTURE_TIME_MS=new Date().getTime()+1e11;function ListHeader(t){const{items_descriptor:ee,on_click_header:te,other_content:ne=()=>null}=t;return o$1("div",{onClick:oe=>{oe.stopImmediatePropagation(),te&&te()},style:{cursor:te?"pointer":"default"},title:t.items_descriptor_title,children:[ne(),o$1("div",{className:"item_descriptors",children:ee}),o$1("div",{style:{clear:"both"}})]})}var ExpandedListStates=(t=>(t[t.collapsed=0]="collapsed",t[t.partial_expansion=1]="partial_expansion",t[t.expanded=2]="expanded",t))(ExpandedListStates||{});const map_state$_=t=>({editing:!t.display_options.consumption_formatting}),connector$$=connect(map_state$_);function _ExpandableList(t){const ee=t.expanded_initial_state||(t.disable_collapsed?t.disable_partial_collapsed?2:1:0),[te,ne]=h$1(ee),oe=te===2,{header_content:ie=()=>null,content:se,items_count:re,item_descriptor:_e,items_descriptor:ae=get_items_descriptor(_e,re,t.editing),items_descriptor_title:ce,disable_partial_collapsed:le=!1}=t;function ue(){let de=(te+1)%3;t.disable_collapsed&&de===0&&++de,le&&de===1&&++de,ne(de)}return o$1("div",{children:[o$1(ListHeader,{items_descriptor:ae,items_descriptor_title:ce,on_click_header:ue,other_content:ie}),se({disable_partial_collapsed:le,expanded_items:te>0,expanded_item_rows:oe})]})}const ExpandableList=connector$$(_ExpandableList);function get_items_descriptor(t,ee,te=!0){return(te||ee!==void 0&&ee!==0)&&(t+=` (${ee})`),t}function ListHeaderAddButton(t){const{new_item_descriptor:ee,on_pointer_down_new_list_entry:te}=t;return o$1("div",{children:o$1(Button,{fullWidth:!0,onClick:ne=>{ne.stopImmediatePropagation(),te()},children:`New ${ee}`})})}const map_state$Z=t=>({consumption_formatting:t.display_options.consumption_formatting}),connector$_=connect(map_state$Z);function _ExpandableListWithAddButton(t){const{items_count:ee,item_descriptor:te,new_item_descriptor:ne=te,consumption_formatting:oe}=t;return o$1(ExpandableList,{header_content:()=>oe?null:o$1(ListHeaderAddButton,{new_item_descriptor:ne,on_pointer_down_new_list_entry:t.on_click_new_item}),content:t.content,items_count:ee,items_descriptor:t.items_descriptor,item_descriptor:te,disable_collapsed:t.disable_collapsed,disable_partial_collapsed:t.disable_partial_collapsed,expanded_initial_state:t.expanded_initial_state})}const ExpandableListWithAddButton=connector$_(_ExpandableListWithAddButton),EditableListEntry$1="";var Delete={},_interopRequireDefault$a=interopRequireDefaultExports;Object.defineProperty(Delete,"__esModule",{value:!0});var default_1$a=Delete.default=void 0,_createSvgIcon$a=_interopRequireDefault$a(requireCreateSvgIcon()),_jsxRuntime$a=requireJsxRuntime(),_default$a=(0,_createSvgIcon$a.default)((0,_jsxRuntime$a.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}),"Delete");default_1$a=Delete.default=_default$a;function ConfirmatoryButton(t){const[ee,te]=h$1(t.ready_to_progress??!1),{tooltip_text:ne=""}=t;return o$1("div",{style:{display:"flex",justifyContent:"space-between",margin:"4px 0px"},children:[o$1(StyledEngineProvider,{injectFirst:!0,children:o$1(ThemeProvider,{theme:WarningTheme,children:o$1(Button,{color:"secondary",disabled:t.disabled,is_hidden:!ee,onClick:oe=>{oe.stopImmediatePropagation(),te(!1),t.on_click&&t.on_click()},startIcon:t.button_icon,children:o$1(Tooltip,{title:ne,"aria-label":ne,children:o$1(Box,{component:"span",children:"CONFIRM"})})})})}),o$1(StyledEngineProvider,{injectFirst:!0,children:o$1(ThemeProvider,{theme:DefaultTheme,children:o$1(Button,{color:"primary",disabled:t.disabled,fullWidth:!ee,is_hidden:!t.on_click,onClick:oe=>{oe.stopImmediatePropagation(),te(!ee),ee&&t.on_cancel&&t.on_cancel()},startIcon:ee?"":t.button_icon,children:o$1(Tooltip,{title:ee?"":ne,"aria-label":ee?"":ne,children:o$1(Box,{component:"span",children:ee?"Cancel":t.button_text})})})})})]})}const map_state$Y=t=>({consumption_formatting:t.display_options.consumption_formatting}),connector$Z=connect(map_state$Y);function _ConfirmatoryDeleteButton(t){return t.consumption_formatting?null:o$1(ConfirmatoryButton,{disabled:t.disabled,on_click:t.on_delete,button_text:t.button_text??"Delete",button_icon:o$1(default_1$a,{}),tooltip_text:t.tooltip_text})}const ConfirmatoryDeleteButton=connector$Z(_ConfirmatoryDeleteButton);class EditableListEntry extends b$1{constructor(ee){super(ee);const{calc_initial_custom_expansion_state:te}=ee,ne=te&&te(ee.item),oe=ne!==void 0?ne:!!ee.expanded;this.state={internal__expanded:oe}}componentDidUpdate(ee,te){this.props.expanded!==ee.expanded&&this.setState({internal__expanded:!!this.props.expanded})}render(){const{item:ee,get_created_at:te,get_custom_created_at:ne,set_custom_created_at:oe=(ye,we)=>({...ye,custom_created_at:we}),get_summary:ie,get_details:se,get_details2:re,get_details3:_e,crud:ae,delete_button_text:ce,hide_expansion_button:le}=this.props,{update_item:ue,delete_item:de}=ae,me=ne?ne(ee):void 0,{internal__expanded:pe}=this.state,fe=pe?"expanded":"",ge=this.props.extra_class_names||"",he=`editable_list_entry ${fe} ${ge}`,be=F$1(()=>de&&(()=>de(ee)),[de,ee]),ve=ye=>{ue(oe(ee,ye))};return o$1("div",{className:he,children:[o$1("div",{className:"summary_header",children:[o$1("div",{className:"summary",children:ie(ee,ae,pe)}),!(le&&le(ee))&&o$1("div",{className:"expansion_button",title:pe?"Collapse":"Expand",onClick:()=>this.setState({internal__expanded:!pe})})]}),pe&&o$1(k$1,{children:[se(ee,ae),o$1("div",{className:"details2",children:re&&re(ee,ae)}),o$1("div",{children:[be&&o$1(ConfirmatoryDeleteButton,{on_delete:be,button_text:ce}),o$1("br",{}),(te||ne)&&o$1(FormControl,{children:o$1(EditableCustomDateTime,{title:"Created at",invariant_value:te&&te(ee),value:me,on_change:ve})})]}),o$1("div",{className:"details3",children:_e&&_e(ee,ae)})]})]})}}function factory_render_list_content(t){const{items:ee,get_id:te,item_props:ne,debug_item_descriptor:oe=""}=t;return se=>{const{expanded_items:re,expanded_item_rows:_e}=se;return o$1("div",{style:{display:re?"":"none",cursor:"initial"},onClick:ae=>ae.stopPropagation(),children:ee.map((ae,ce)=>o$1("div",{children:[o$1("hr",{className:"entries_horizontal_dividers"}),o$1(EditableListEntry,{item:ae,...ne,expanded:_e})]},te(ae)))})}}const view_types_to_maintain=new Set(["knowledge","priorities"]);function optional_view_type(t){return view_types_to_maintain.has(t)?t:"knowledge"}function KnowledgeViewList(t){const{parent_knowledge_view_id:ee,knowledge_views:te,current_view:ne,sort_type:oe}=t;if(!t.editing&&te.length===0)return null;const ie=factory_render_list_content({items:te,get_id:_e=>_e.id,item_props:{get_summary:factory_get_summary(ne),get_details:factory_get_kv_details(t),get_details3:get_details3$1,calc_initial_custom_expansion_state:factory_calc_initial_custom_expansion_state(t),crud:{update_item:_e=>{t.upsert_knowledge_view({knowledge_view:_e})}}},debug_item_descriptor:"View"}),se=calc_expanded_initial_state(t);if(oe==="hidden"||oe==="archived"||oe==="errored")return o$1(ExpandableList,{items_count:te.length,content:ie,item_descriptor:sentence_case(oe)+" "+(t.item_descriptor||"View"),disable_collapsed:!1,expanded_initial_state:se});const re=(oe==="priority"?"Priority ":"")+(t.item_descriptor||"View");return o$1(ExpandableListWithAddButton,{items_count:te.length,on_click_new_item:()=>{create_new_knowledge_view({knowledge_view:{title:make_default_kv_title(),parent_knowledge_view_id:ee,sort_type:oe},creation_context:t.creation_context})},content:ie,item_descriptor:re,disable_collapsed:!0,expanded_initial_state:se})}function factory_get_summary(t){const ee=optional_view_type(t);return(te,ne)=>o$1(Link,{route:void 0,sub_route:void 0,item_id:void 0,args:{view:ee,subview_id:te.id},selected_on:new Set(["route","args.subview_id"]),children:te.title})}function get_details3$1(){return o$1("div",{children:[o$1("br",{}),o$1("br",{})]})}function calc_expanded_initial_state(t){const{current_kv_parent_ids:ee,knowledge_views:te,current_subview_id:ne}=t;return!!te.find(({id:ie})=>ie===ne||ee.has(ie))?ExpandedListStates.partial_expansion:void 0}function factory_calc_initial_custom_expansion_state(t){return ee=>t.current_kv_parent_ids.has(ee.id)?!0:void 0}function KnowledgeViewListsSet(t){const{priority:ee,normal:te,hidden:ne,archived:oe,errored:ie}=F$1(()=>{const se=[],re=[],_e=[],ae=[],ce=[];return t.knowledge_views.forEach(le=>{const ue=t.nested_knowledge_view_ids.map[le.id];(ue==null?void 0:ue.sort_type)==="errored"?ce.push(le):le.sort_type==="hidden"?_e.push(le):le.sort_type==="archived"?ae.push(le):le.sort_type==="priority"?se.push(le):re.push(le)}),{priority:se,normal:re,hidden:_e,archived:ae,errored:ce}},[t.knowledge_views]);return o$1("div",{children:[o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:ee,sort_type:"priority"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:te,sort_type:"normal"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:ne,sort_type:"hidden"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:oe,sort_type:"archived"}),o$1("br",{}),o$1(KnowledgeViewList,{...t,knowledge_views:ie,sort_type:"errored"})]})}const KnowledgeViewDatetimeLinesConfigForm=t=>{const{editing:ee,knowledge_view:te}=t,ne=get_foundational_knowledge_views(te,t.knowledge_views_by_id,!1),oe=get_composed_datetime_lines_config(ne,!1),{datetime_line_config:ie={}}=te,se=ie.time_origin_ms??oe.time_origin_ms,re=ue=>{const de={...ie,...ue};t.update_item({...te,datetime_line_config:de})};if(se===void 0)return ee?o$1("div",{children:[o$1("h4",{children:"Configure X Axis Datetime"}),o$1("p",{children:o$1(EditableCustomDateTime,{title:"Time origin",value:void 0,on_change:ue=>{const de=ue?ue.getTime():void 0;re({time_origin_ms:de})}})})]}):null;const _e=inherit_or_default(ie,oe,"time_origin_x"),ae=inherit_or_default(ie,oe,"time_scale"),ce=inherit_or_default(ie,oe,"time_line_number"),le=inherit_or_default(ie,oe,"time_line_spacing_days");return o$1("div",{children:[o$1("h4",{children:"Configure X Axis Datetime"}),o$1("p",{children:o$1(EditableCustomDateTime,{title:"Time origin",value:new Date(se),on_change:ue=>{const de=ue?ue.getTime():void 0;re({time_origin_ms:de})}})}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Time origin position",value:_e.value,allow_undefined:!0,on_blur:ue=>{re({time_origin_x:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:_e.source})]}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Time scale",value:ae.value,allow_undefined:!0,on_blur:ue=>{re({time_scale:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:ae.source})]}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Time line number",value:ce.value,allow_undefined:!0,on_blur:ue=>{re({time_line_number:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:ce.source})]}),o$1("p",{children:[o$1(EditableNumber,{placeholder:"Days between time line",value:le.value,allow_undefined:!0,on_blur:ue=>{re({time_line_spacing_days:ue})},on_blur_type:EditableTextOnBlurType.conditional,style:{width:"70%"}}),ee&&o$1(IndicateSource,{source:le.source})]}),ee&&o$1("p",{children:o$1(Button,{value:"Clear (to inherited or default to month)",fullWidth:!0,onClick:()=>{re({time_scale:void 0,time_line_number:void 0,time_line_spacing_days:void 0})}})}),ee&&o$1("p",{style:{display:"flex",flexDirection:"row",justifyContent:"space-evenly",alignItems:"center"},children:[o$1("div",{children:"Defaults:"}),"  ",o$1(Button,{value:"Week",fullWidth:!1,onClick:()=>{re({time_scale:3,time_line_number:8,time_line_spacing_days:7})}})," ",o$1(Button,{value:"Month",fullWidth:!1,onClick:()=>{re({time_scale:DEFAULT_DATETIME_LINE_CONFIG.time_scale,time_line_number:DEFAULT_DATETIME_LINE_CONFIG.time_line_number,time_line_spacing_days:DEFAULT_DATETIME_LINE_CONFIG.time_line_spacing_days})}})," ",o$1(Button,{value:"Year",fullWidth:!1,onClick:()=>{re({time_scale:.3,time_line_number:2,time_line_spacing_days:365})}})]})]})};function inherit_or_default(t,ee,te){const ne=t[te]??ee[te]??DEFAULT_DATETIME_LINE_CONFIG[te],oe=ne===t[te]?0:ne===ee[te]?1:2;return{value:ne,source:oe}}function IndicateSource(t){if(t.source===0)return null;const ee=t.source===1?"Inherited from foundation":"Default";return o$1("div",{style:{color:"grey",fontSize:11},title:ee,children:t.source===1?"(Inherited)":"(Default)"})}const ExternalLinkIcon$1="";function ExternalLinkIcon(){return o$1("div",{className:"external_link_icon"})}function calc_ids_to_move_and_conflicts(t){const{knowledge_views_by_id:ee,wcomponents_by_id:te}=t,ne=get_knowledge_views_to_move(t),oe=new Set(ne.map(_e=>_e.id)),ie=get_knowledge_views_to_keep({kv_ids_to_move:oe,knowledge_views_by_id:ee}),{wc_ids_to_move:se,wcomponents_move_conflicts:re}=get_possible_wc_ids_to_move({knowledge_views_to_move:ne,knowledge_views_to_keep:ie,wcomponents_by_id:te});return{kv_ids_to_move:oe,wc_ids_to_move:se,wcomponents_move_conflicts:re}}function get_knowledge_views_to_move(t){const ee=[],te=new Set,ne=[t.root_knowledge_view_id_to_move];for(;ne.length;){const oe=ne.pop();if(!oe)break;if(te.has(oe))continue;const ie=t.knowledge_views_by_id[oe],se=t.nested_knowledge_view_ids_map[oe];if(!se||!ie){console.error(`kv of id: "${oe}" kv is "${ie?"present":"absent"}" but nested kv map entry is "${se?"present":"absent"}"`);continue}ee.push(ie),te.add(oe),se.child_ids.forEach(re=>ne.push(re))}return ee}function get_knowledge_views_to_keep(t){return Object.values(t.knowledge_views_by_id).filter(ee=>!t.kv_ids_to_move.has(ee.id))}function get_possible_wc_ids_to_move(t){const ee={};t.knowledge_views_to_keep.forEach(se=>{Object.entries(se.wc_id_map).forEach(([re,_e])=>{if(_e.blocked||_e.passthrough)return;const ae=ee[re]||[];ae.push({kv_id:se.id,left:_e.left,top:_e.top}),ee[re]=ae})});const te=new Set(t.knowledge_views_to_keep.map(se=>se.id)),ne=new Set(t.knowledge_views_to_move.map(se=>se.id));let oe=new Set;const ie={};return t.knowledge_views_to_move.forEach(se=>Object.entries(se.wc_id_map).forEach(([re,_e])=>{if(_e.blocked||_e.passthrough||!t.wcomponents_by_id[re]||te.has(re))return;const ae=ee[re],ce=ne.has(re);ae&&!ce?ie[re]=ae:oe.add(re)})),{wc_ids_to_move:oe,wcomponents_move_conflicts:ie}}const test_calc_ids_to_move_and_conflicts_functions=describe("calc_ids_to_move_and_conflicts",()=>{const ee=get_new_knowledge_view_object({id:"uuid A",base_id:1,title:"A"}),te=get_new_knowledge_view_object({id:"uuid B",base_id:1,title:"B",parent_knowledge_view_id:ee.id}),ne=get_new_knowledge_view_object({id:"uuid C",base_id:1,title:"C",parent_knowledge_view_id:te.id}),oe=get_new_knowledge_view_object({id:"uuid I",base_id:1,title:"I",parent_knowledge_view_id:te.id}),ie=get_new_knowledge_view_object({id:"uuid J",base_id:1,title:"J",parent_knowledge_view_id:ee.id}),se=[ee,te,ne,oe,ie],re={};se.forEach(ye=>re[ye.id]=ye);const _e={},ae=ye=>(_e[ye.id]=ye,ye),ce=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:ee.title,id:ee.id})),le=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:te.title,id:te.id})),ue=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:ne.title,id:ne.id})),de=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:oe.title,id:oe.id})),me=ae(prepare_new_contextless_wcomponent_object({base_id:1,title:ie.title,id:ie.id})),pe=ae(prepare_new_contextless_wcomponent_object({id:"uuid E",base_id:1,title:"E"})),fe=ae(prepare_new_contextless_wcomponent_object({id:"uuid F",base_id:1,title:"F"})),ge=ae(prepare_new_contextless_wcomponent_object({id:"uuid G",base_id:1,title:"G"})),he=ae(prepare_new_contextless_wcomponent_object({id:"uuid H",base_id:1,title:"H"}));ee.wc_id_map[ce.id]={left:0,top:0},ee.wc_id_map[le.id]={left:0,top:0},ee.wc_id_map[pe.id]={left:0,top:0},ee.wc_id_map[fe.id]={left:0,top:0},ee.wc_id_map[de.id]={left:0,top:0},ee.wc_id_map[me.id]={left:0,top:0},te.wc_id_map[le.id]={left:0,top:0},te.wc_id_map[ue.id]={left:0,top:0},te.wc_id_map[pe.id]={left:0,top:0},te.wc_id_map[ge.id]={left:0,top:0},te.wc_id_map[de.id]={left:0,top:0},ne.wc_id_map[ue.id]={left:0,top:0},ne.wc_id_map[fe.id]={left:0,top:0},ne.wc_id_map[he.id]={left:0,top:0},ne.wc_id_map[me.id]={left:0,top:0},oe.wc_id_map[de.id]={left:0,top:0},ie.wc_id_map[me.id]={left:0,top:0};const be=get_nested_knowledge_view_ids(se,1).map,ve=calc_ids_to_move_and_conflicts({root_knowledge_view_id_to_move:te.id,nested_knowledge_view_ids_map:be,knowledge_views_by_id:re,wcomponents_by_id:_e});test(ve.kv_ids_to_move,new Set([te.id,ne.id,oe.id])),test(ve.wc_ids_to_move,new Set([le.id,ue.id,de.id,ge.id,he.id])),test(Object.keys(ve.wcomponents_move_conflicts),[pe.id,fe.id])},!1),map_state$X=t=>({bases_by_id:t.user_info.bases_by_id,chosen_base_id:t.user_info.chosen_base_id}),connector$Y=connect(map_state$X);function _SelectBaseToMoveTo(t){const ee=t.base_id_to_move_to===void 0?void 0:`${t.base_id_to_move_to}`,te=Object.values(t.bases_by_id||{}).filter(ne=>ne.id!==t.chosen_base_id&&ne.can_edit).map(ne=>({id:`${ne.id}`,title:ne.title}));return o$1("div",{children:o$1(AutocompleteText,{selected_option_id:ee,allow_none:!0,options:te,on_change:ne=>{const oe=ne===void 0?void 0:parseInt(ne);t.on_change(oe)}})})}const SelectBaseToMoveTo=connector$Y(_SelectBaseToMoveTo),map_state$W=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),connector$X=connect(map_state$W);function _WComponentMoveConflicts(t){const{wcomponents_move_conflicts:ee,wcomponents_by_id:te,knowledge_views_by_id:ne}=t,oe=new Date().getTime(),ie=oe;return o$1("div",{children:Object.entries(ee||{}).map(([se,re],_e)=>{const ae=te[se],ce=ae&&get_title$1({wcomponent:ae,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:void 0,created_at_ms:oe,sim_ms:ie})||se;return o$1("div",{children:[o$1(Link,{route:"wcomponents",sub_route:void 0,item_id:se,args:void 0,children:['Component "',o$1(Markdown,{children:ce}),'" in:']}),o$1("ul",{children:re.map(le=>{const ue=ne[le.kv_id],de=(ue==null?void 0:ue.title)||le.kv_id,me=lefttop_to_xy(le,!0);return o$1("li",{children:o$1(Link,{route:"wcomponents",sub_route:void 0,item_id:se,args:{subview_id:le.kv_id,...me},children:["    ",de]})})})})]},se)})})}const WComponentMoveConflicts=connector$X(_WComponentMoveConflicts),map_state$V=t=>({nested_knowledge_view_ids_map:t.derived.nested_knowledge_view_ids.map,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,chosen_base_id:t.user_info.chosen_base_id}),connector$W=connect(map_state$V);function _KnowledgeViewChangeBase(t){const{knowledge_view:ee,nested_knowledge_view_ids_map:te,knowledge_views_by_id:ne,wcomponents_by_id:oe,chosen_base_id:ie}=t,[se,re]=h$1(new Set),[_e,ae]=h$1(void 0),[ce,le]=h$1(void 0),[ue,de]=h$1(void 0);if(ie===void 0)return o$1("div",{children:[o$1("h4",{children:"Change base of knowledge view"}),"Need to select a base first"]});if(!_e)return o$1("div",{children:[o$1("h4",{children:"Change base of knowledge view"}),o$1(Button,{value:"Check if safe to move",onClick:()=>{const{kv_ids_to_move:fe,wc_ids_to_move:ge,wcomponents_move_conflicts:he}=calc_ids_to_move_and_conflicts({root_knowledge_view_id_to_move:ee.id,nested_knowledge_view_ids_map:te,knowledge_views_by_id:ne,wcomponents_by_id:oe});re(set_union(fe,ge)),ae(he)}})]});const me=Object.keys(_e).length,pe=se.size+me;return o$1("div",{children:[o$1("h4",{children:"Change base of knowledge view"}),me>0&&o$1("p",{children:["There are other knowledge views which are not nested under this knowledge view and that contain ",o$1("span",{style:{color:"darkred"},children:[me," components"]})," that are also in this knowledge view.  These entries can be moved to the new base or left assigned to this base.  All the nested knowledge views and their components will be moved regardless."]}),me>0&&o$1("p",{children:[o$1("i",{children:o$1("b",{children:[me," component(s) also present in other knowledge views:"]})}),o$1(WComponentMoveConflicts,{wcomponents_move_conflicts:_e})]}),me===0&&o$1("p",{children:[o$1("i",{children:o$1("b",{children:"Safe to move!"})}),"   All of the knowledge views and components in and nested under this knowledge view are contained in this knowledge view.  None of them are present in any other knowledge views that are not nested under this knowledge view."]}),o$1("p",{children:[o$1("i",{children:o$1("b",{children:"Step 2 of 3: Select base to move to"})}),o$1(SelectBaseToMoveTo,{base_id_to_move_to:ce,on_change:fe=>le(fe)})]}),ce!==void 0&&o$1("div",{children:[se.size!==pe&&o$1(ConfirmatoryButton,{disabled:pe===0,button_text:`Move all ${pe} components to new base (including conflicted)`,on_click:()=>{const fe=Array.from(se).concat(Object.keys(_e));move_ids_to_new_base(fe,ie,ce,de)}}),o$1(ConfirmatoryButton,{disabled:se.size===0,button_text:`Move ${se.size} components (no conflicts) to new base`,on_click:()=>{const fe=Array.from(se);move_ids_to_new_base(fe,ie,ce,de)}})]}),ue&&o$1("p",{children:[ue.error&&o$1("div",{style:{backgroundColor:"pink"},children:["Got error whilst trying to change base id of components ",o$1("br",{}),o$1("pre",{children:JSON.stringify(ue.error,null,2)})]}),ue.data&&o$1("div",{style:{backgroundColor:"lightgreen"},children:["Successfully changed base id of ",ue.data," components & knowledge views.  Reloading page in ",RELOAD_PAGE_DELAY_IN_SECONDS," seconds"]})]})]})}const KnowledgeViewChangeBase=connector$W(_KnowledgeViewChangeBase),RELOAD_PAGE_DELAY_IN_SECONDS=2;async function move_ids_to_new_base(t,ee,te,ne){const ie=await get_supabase().rpc("move_ids_to_new_base",{ids:t,from_base_id:ee,to_base_id:te});ne(ie),ie.error||setTimeout(()=>document.location.reload(),RELOAD_PAGE_DELAY_IN_SECONDS*1e3)}function get_all_parent_knowledge_view_ids(t,ee){const te=new Set;let ne=t[ee];for(;ne&&ne.parent_id;)te.add(ne.parent_id),ne=t[ne.parent_id];return te}const make_default_kv_title=()=>get_today_str(!1),factory_get_kv_details=t=>(ee,te)=>{const{editing:ne,nested_knowledge_view_ids:oe}=t,ie=oe.map[ee.id],se=((ie==null?void 0:ie.child_ids)||[]).map(me=>t.knowledge_views_by_id[me]).filter(is_defined),re=!!t.wcomponents_by_id[(ee==null?void 0:ee.id)||""],_e=ee.base_id!==t.chosen_base_id,ae=(t.bases_by_id||{})[ee.base_id],ce=t.current_subview_id===ee.id,le=F$1(()=>new Set(t.possible_parent_knowledge_view_ids),[t.possible_parent_knowledge_view_ids]);let ue="";ie!=null&&ie.ERROR_is_circular&&(ue="Is circularly nested"),ie!=null&&ie.ERROR_parent_kv_missing&&(ue="Parent knowledge view is missing (may be present in a different knowledge base)");let de="";return ie!=null&&ie.ERROR_parent_from_diff_base&&(de="Parent knowledge view from a different base"),o$1("div",{style:{backgroundColor:"white",border:"thin solid #aaa",borderRadius:3,padding:5,margin:5},children:[_e&&o$1("div",{style:{cursor:"pointer"},onClick:()=>t.update_chosen_base_id({base_id:ee.base_id}),title:`Click to change to base ${ee.base_id}`,children:[o$1(WarningTriangle,{message:""}),'  Is part of base "',ae==null?void 0:ae.title,'"']}),o$1("p",{style:{display:"inline-flex"},children:[o$1(EditableTextSingleLine,{placeholder:"Title",value:ee.title,on_blur:me=>{const pe=make_default_kv_title();te.update_item({...ee,title:me??pe})},on_blur_type:EditableTextOnBlurType.conditional}),re&&o$1(Link,{route:"wcomponents",sub_route:void 0,item_id:ee.id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"Component"]}),!re&&ne&&o$1("span",{style:{cursor:"pointer"},onClick:()=>{create_wcomponent({wcomponent:{base_id:ee.base_id,id:ee.id,title:ee.title,type:"statev2"}})},children:[o$1(ExternalLinkIcon,{}),"Create Component"]})]}),(ne||ee.description)&&o$1("p",{children:[ne&&o$1("span",{className:"description_label",children:"Description"}),"  ",o$1(EditableText,{placeholder:"...",value:ee.description,on_blur:me=>{te.update_item({...ee,description:me})},on_blur_type:EditableTextOnBlurType.conditional})]}),o$1("div",{children:[o$1("span",{className:"description_label",children:"Active assumptions (counterfactuals)"}),o$1(KnowledgeViewActiveCounterFactuals,{knowledge_view_id:ee.id,on_change:me=>te.update_item({...ee,active_counterfactual_v2_ids:me})})]}),o$1("p",{children:o$1(FoundationKnowledgeViewsList,{owner_knowledge_view:ee,on_change:me=>{te.update_item({...ee,foundation_knowledge_view_ids:me})}})}),(ne||ue||de)&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Nest under"}),ue&&o$1("div",{style:{backgroundColor:"pink"},children:[" ",ue," "]}),de&&o$1("div",{children:[o$1(WarningTriangle,{message:de})," ",de]}),o$1(SelectKnowledgeView,{selected_option_id:ee.parent_knowledge_view_id,allowed_ids:le,on_change:me=>{te.update_item({...ee,parent_knowledge_view_id:me})}})]}),ne&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Sort status"}),o$1(AutocompleteText,{selected_option_id:ee.sort_type,options:knowledge_view_tree_sort_types.map(me=>({id:me,title:me})),allow_none:!1,on_change:me=>me&&te.update_item({...ee,sort_type:me})})]}),o$1("hr",{}),ne&&!ce&&o$1("div",{children:[o$1(Link,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:ee.id},children:"Change to this knowledge view"})," to edit datetime lines config and change the base."]}),ne&&ce&&o$1("div",{children:[o$1(KnowledgeViewDatetimeLinesConfigForm,{editing:ne,knowledge_view:ee,knowledge_views_by_id:t.knowledge_views_by_id,update_item:te.update_item}),o$1("hr",{}),o$1(KnowledgeViewChangeBase,{knowledge_view:ee}),o$1("hr",{}),o$1("br",{})]}),(ne||se.length>0)&&o$1("p",{children:o$1(KnowledgeViewListsSet,{...t,parent_knowledge_view_id:ee.id,knowledge_views:se,item_descriptor:"Nested"})}),o$1("br",{})]})},map_state$U=t=>({ready:t.sync.ready_for_reading,knowledge_views:t.derived.knowledge_views,nested_knowledge_view_ids:t.derived.nested_knowledge_view_ids,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,creation_context:t.creation_context,current_view:t.routing.args.view,current_subview_id:t.routing.args.subview_id,editing:!t.display_options.consumption_formatting,chosen_base_id:t.user_info.chosen_base_id,bases_by_id:t.user_info.bases_by_id}),map_dispatch$B={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view,update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$V=connect(map_state$U,map_dispatch$B);function _TopLevelKnowledgeViewListsSet(t){if(t.knowledge_views.length===0)return o$1("div",{style:{cursor:"progress"},children:t.ready?"Automatically creating a knowledge view...":"Loading..."});const ee=F$1(()=>t.knowledge_views.filter(oe=>oe.base_id===t.chosen_base_id).map(oe=>oe.id),[t.knowledge_views]),te=t.nested_knowledge_view_ids.top_ids.map(oe=>t.knowledge_views_by_id[oe]).filter(is_defined),ne=get_all_parent_knowledge_view_ids(t.nested_knowledge_view_ids.map,t.current_subview_id);return o$1(KnowledgeViewListsSet,{...t,parent_knowledge_view_id:void 0,knowledge_views:te,possible_parent_knowledge_view_ids:ee,upsert_knowledge_view:t.upsert_knowledge_view,current_kv_parent_ids:ne,chosen_base_id:t.chosen_base_id,bases_by_id:t.bases_by_id,update_chosen_base_id:t.update_chosen_base_id})}const TopLevelKnowledgeViewListsSet=connector$V(_TopLevelKnowledgeViewListsSet),map_state$T=t=>{const ee=get_current_knowledge_view_from_state(t);return{ready_for_reading:t.sync.ready_for_reading,knowledge_view:ee,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,knowledge_views:t.derived.knowledge_views,nested_knowledge_view_ids:t.derived.nested_knowledge_view_ids,creation_context:t.creation_context,editing:!t.display_options.consumption_formatting,current_view:t.routing.args.view,current_subview_id:t.routing.args.subview_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,chosen_base_id:t.user_info.chosen_base_id,bases_by_id:t.user_info.bases_by_id}},map_dispatch$A={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view,update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$U=connect(map_state$T,map_dispatch$A);function _KnowledgeViewForm(t){const{knowledge_view:ee,upsert_knowledge_view:te}=t;if(!t.ready_for_reading)return o$1("div",{children:"Loading..."});if(!ee)return o$1("div",{children:"No knowledge view selected"});const ne=F$1(()=>t.knowledge_views.filter(re=>re.base_id===t.chosen_base_id).map(re=>re.id),[t.knowledge_views]),oe=get_all_parent_knowledge_view_ids(t.nested_knowledge_view_ids.map,t.current_subview_id),se={create_item:()=>{throw new Error("Not implemented create knowledge view")},update_item:re=>te({knowledge_view:re}),delete_item:()=>{throw new Error("Not implemented delete knowledge view")}};return factory_get_kv_details({...t,possible_parent_knowledge_view_ids:ne,current_kv_parent_ids:oe,chosen_base_id:t.chosen_base_id,bases_by_id:t.bases_by_id,update_chosen_base_id:t.update_chosen_base_id})(ee,se)}const KnowledgeViewForm=connector$U(_KnowledgeViewForm);function ViewsSidePanel(t){return o$1(Box,{p:1,pt:5,class:"views_side_panel",children:["Current View:",o$1(KnowledgeViewForm,{}),o$1("br",{}),o$1("br",{}),o$1("br",{}),o$1("br",{}),o$1("br",{}),o$1(TopLevelKnowledgeViewListsSet,{})]})}const map_dispatch$z={change_route:ACTIONS.routing.change_route},connector$T=connect(null,map_dispatch$z);function _SearchSidePanel(t){return o$1(WComponentSearchWindow,{on_change:ee=>{ee&&t.change_route({route:"wcomponents",item_id:ee})},on_blur:()=>{t.change_route({route:"wcomponents"})}})}const SearchSidePanel=connector$T(_SearchSidePanel);function SelectionControlSidePanel(t){const ee=get_store();return o$1("div",{className:"side_panel",children:[o$1("p",{className:"section",children:[o$1(Button,{value:"Expand towards causes (backwards)",fullWidth:!0,onClick:()=>conditionally_select_source_causal_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.expand_select_backwards})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Expand towards effects (forwards)",fullWidth:!0,onClick:()=>conditionally_select_forward_causal_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.expand_select_forwards})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Select all components",fullWidth:!0,onClick:()=>conditionally_select_all_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.select_all})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Expand selection (in all directions)",fullWidth:!0,onClick:()=>conditionally_expand_selected_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.expand_select})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Contract selection (in all directions)",fullWidth:!0,onClick:()=>conditionally_decrease_selected_components(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.decrease_select})]}),o$1("p",{className:"section",children:[o$1(Button,{value:"Select components inbetween",fullWidth:!0,onClick:()=>conditionally_select_interconnections(ee)}),o$1(PlainShortcutKeys,{...shortcuts_map.select_interconnections}),o$1("div",{className:"description",children:"Only selects the immediate components inbetween.  e.g. if A ---B--> C ---D--> E, then selecting nodes A and C followed by this command will also select connection B.  But if only node A and node E are selected, then this command will not do anything."})]})]})}const SidePanel$1="",CreateNewWComponent$1="",map_state$S=t=>({current_knowledge_view:get_current_composed_knowledge_view_from_state(t),editing:!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)}),map_dispatch$y={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting},connector$S=connect(map_state$S,map_dispatch$y);function _CreateNewWComponent(t){const{current_knowledge_view:ee,editing:te,base_id:ne}=t;return te?ne===void 0?o$1("div",{class:"create_new_wcomponent",children:"Select a base first."}):ee?o$1("div",{class:"create_new_wcomponent",children:[o$1("h3",{children:"Create new component"}),o$1(ButtonGroup,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:wcomponent_types.map(oe=>o$1(Button$2,{onClick:()=>create_wcomponent_type(ne,oe),children:wcomponent_type_to_text(oe)}))})]}):o$1("div",{class:"create_new_wcomponent",children:[o$1("h3",{children:"Create new component"}),o$1("p",{children:"Please select a knowledge view first"})]}):o$1("div",{class:"create_new_wcomponent",children:o$1(Button,{onClick:()=>t.toggle_consumption_formatting({}),children:"Swap to editing"})})}const CreateNewWComponent=connector$S(_CreateNewWComponent);function create_wcomponent_type(t,ee){create_wcomponent({wcomponent:{base_id:t,type:ee}})}function get_updated_wcomponent(t,ee){const te=ee.type!==void 0&&ee.type!==t.type;return t={...t,...ee},{wcomponent:t,different_type:te}}const ColorPicker$1="",default_color=()=>({r:255,g:255,b:255,a:1});function ColorPicker(t){const[ee,te]=h$1(t.color||default_color());p$1(()=>{te(t.color||default_color())},[color_to_string(t.color)]);const ne=ie=>{const se=get_valid_new_color(ee,ie);te(se)},oe=ie=>{const se=get_valid_new_color(ee,ie);colours_different(ee,se)&&te(se),colours_different(t.color,se)&&t.conditional_on_blur(se)};return o$1("div",{className:"color_picker",children:[o$1(EditableNumber,{placeholder:"r",value:ee.r,allow_undefined:!1,conditional_on_change:ie=>ne({r:ie}),on_blur:ie=>oe({r:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1(EditableNumber,{placeholder:"g",value:ee.g,allow_undefined:!1,conditional_on_change:ie=>ne({g:ie}),on_blur:ie=>oe({g:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1(EditableNumber,{placeholder:"b",value:ee.b,allow_undefined:!1,conditional_on_change:ie=>ne({b:ie}),on_blur:ie=>oe({b:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1(EditableNumber,{placeholder:"a",value:ee.a,allow_undefined:!1,conditional_on_change:ie=>ne({a:ie}),on_blur:ie=>oe({a:ie}),on_blur_type:EditableTextOnBlurType.always,style:{width:65}}),"  ",o$1("div",{className:"color_swatch",style:{backgroundColor:color_to_string(ee)}})]})}function get_valid_new_color(t,ee){const te={...t,...ee};return validate_color(te)}function validate_color(t){let{r:ee,g:te,b:ne,a:oe}=t;return ee=bounded(ee,0,255),te=bounded(te,0,255),ne=bounded(ne,0,255),oe=bounded(oe,0,1),{r:ee,g:te,b:ne,a:oe}}function colours_different(t,ee){return t?color_to_string(t)!==color_to_string(ee):!0}function EditablePercentage(t){const ee=ratio_to_percentage_string(t.value),{conditional_on_change:te,on_blur:ne,on_blur_type:oe=EditableTextOnBlurType.conditional,disabled:ie}=t;if(!te&&!ne||ie){const se="editable_percentage"+(ie?"disabled":""),re=t.value!==void 0;return o$1("div",{className:se,children:[re&&o$1("span",{className:"description_label",children:t.placeholder}),ee||t.placeholder," %"]})}return o$1("div",{className:"editable_percentage",children:[o$1(EditableTextSingleLine,{placeholder:t.placeholder,value:ee,conditional_on_change:se=>{const re=string_to_percentage(se);re!==void 0&&te&&te(re)},on_blur:se=>{const re=string_to_percentage(se);re!==void 0&&ne&&ne(re)},on_blur_type:oe})," %"]})}function string_to_percentage(t){if(!t)return;const ee=parseFloat(t);return Number.isNaN(ee)?0:bounded(ee,0,100)/100}const UncertainDateTimeForm$1="",map_state$R=t=>({show_unused_fields:!t.display_options.consumption_formatting}),connector$R=connect(map_state$R);function _UncertainDateTimeForm(t){const{datetime:ee,on_change:te,show_unused_fields:ne}=t;return o$1("div",{className:"datetimes",children:[ee.min&&o$1("div",{className:"datetime_section",children:o$1("div",{className:"datetime_value",children:o$1(EditableCustomDateTime,{title:"Minimum datetime",value:ee.min,on_change:oe=>te({...ee,min:oe})})})}),(ne||ee.value)&&o$1("div",{className:"datetime_section",children:o$1("div",{className:"datetime_value",children:o$1(EditableCustomDateTime,{title:"Expected datetime",value:ee.value,on_change:oe=>te({...ee,value:oe})})})}),ee.max&&o$1("div",{className:"datetime_section",children:o$1("div",{className:"datetime_value",children:o$1(EditableCustomDateTime,{title:"Maximum datetime",value:ee.max,on_change:oe=>te({...ee,max:oe})})})})]})}const UncertainDateTimeForm=connector$R(_UncertainDateTimeForm),PredictionSummary$1="",map_state$Q=t=>({time_resolution:t.display_options.time_resolution}),connector$Q=connect(map_state$Q);function _PredictionSummary(t){const{value:ee,created_at:te,datetime:ne,probability:oe,conviction:ie,time_resolution:se}=t;return o$1("div",{children:[te&&o$1("div",{style:{display:"inline-flex"},children:["Created:  ",o$1(EditableCustomDateTime,{invariant_value:te,value:void 0})]}),o$1("div",{className:"summary_container",children:[o$1("div",{className:"summary_row",children:[o$1("div",{className:"datetimes",children:uncertain_date_to_string(ne,se)}),ee&&o$1("div",{children:["      ",ee]})]}),o$1("div",{className:"summary_row",children:[o$1("div",{children:[o$1("span",{className:"description_label",children:"Prob"})," ",oe]}),"   ",o$1("div",{children:[o$1("span",{className:"description_label",children:"Confidence"})," ",ie]})]})]})]})}const PredictionSummary=connector$Q(_PredictionSummary);function PredictionViewSummary(t){const{prediction:ee,on_change:te}=t,{datetime:ne,probability:oe,conviction:ie}=ee;return o$1(PredictionSummary,{datetime:ne,probability:o$1(EditablePercentage,{placeholder:"...",value:oe,conditional_on_change:te&&(se=>te({...ee,probability:se}))}),conviction:o$1(EditablePercentage,{placeholder:"...",value:ie,conditional_on_change:te&&(se=>te({...ee,conviction:se}))})})}function PredictionViewDetails(t){const{on_change:ee,prediction:te}=t,{explanation:ne=""}=te,oe=ee?se=>{const re={...te,...se};ee(re)}:void 0,ie=oe?{on_blur:se=>oe({explanation:se}),on_blur_type:EditableTextOnBlurType.conditional}:{};return o$1("div",{children:[o$1("br",{}),o$1(UncertainDateTimeForm,{datetime:te.datetime,on_change:se=>oe&&oe({datetime:se})}),o$1("br",{}),(t.editing||ne)&&o$1("div",{children:o$1(EditableText,{placeholder:"Explanation",value:ne,...ie})})]})}const NewItemForm$1="";function NewItemForm(t){const{new_item:ee,set_new_item:te,item_descriptor:ne,item_props:oe}=t,{crud:ie}=oe,se=F$1(()=>({...ie,update_item:te}),[ie,te]);return ee?o$1(Box,{children:o$1(Dialog,{"aria-labelledby":"new_item_title",open:!0,onClose:()=>te(void 0),fullWidth:!0,maxWidth:"sm",children:[o$1(DialogTitle,{id:"new_item_title",children:["New ",ne]}),o$1(DialogContent,{children:o$1(EditableListEntry,{item:ee,...oe,expanded:!0,crud:se})}),o$1(DialogActions,{children:[o$1(Button,{onClick:()=>{setTimeout(()=>ie.create_item(ee),0)},children:["Add ",ne]}),o$1(Button,{onClick:()=>te(void 0),children:"Cancel"})]})]})}):null}const map_state$P=t=>({created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,creation_context:t.creation_context,editing:!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)}),connector$P=connect(map_state$P);function _PredictionList(t){const[ee,te]=h$1(void 0),{item_descriptor:ne,predictions:oe,update_predictions:ie,created_at_ms:se,sim_ms:re,editing:_e,base_id:ae=-1}=t,ce=F$1(()=>({get_created_at:get_created_at$1,get_custom_created_at:get_custom_created_at$1,get_summary:get_summary$1,get_details:factory_get_details(_e),crud:{create_item:ke=>{ie([...oe,ke]),te(void 0)}}}),[_e,oe,ie]),le=F$1(()=>({get_created_at:get_created_at$1,get_custom_created_at:get_custom_created_at$1,get_summary:get_summary$1,get_details:factory_get_details(_e),crud:{update_item:ke=>{const $e=replace_element(oe,ke,xe=>get_id$2(xe)===get_id$2(ke));ie($e)},delete_item:ke=>{const $e=remove_element(oe,xe=>get_id$2(xe)===get_id$2(ke));ie($e)}},delete_button_text:"Delete "+ne}),[_e,oe,ie,ne]),{invalid_future_items:ue,future_items:de,present_item:me,past_items:pe}=partition_and_prune_items_by_datetimes_and_versions({items:oe,created_at_ms:se,sim_ms:re}),fe=me?[me]:[],ge=factory_render_list_content({items:de,get_id:get_id$2,item_props:le}),he=factory_render_list_content({items:fe,get_id:get_id$2,item_props:le}),be=factory_render_list_content({items:pe,get_id:get_id$2,item_props:le}),ve=_e||de.length>0,ye=_e||fe.length>0,we=_e||pe.length>0;return o$1("div",{children:[_e&&o$1(ListHeaderAddButton,{new_item_descriptor:ne,on_pointer_down_new_list_entry:()=>te(prepare_new_item(ae,t.creation_context))}),o$1(NewItemForm,{new_item:ee,set_new_item:te,item_props:ce,item_descriptor:ne}),ue.length>0&&o$1("div",{children:["Hidden (",ue.length,")"]}),oe.length>0&&o$1("div",{children:[ve&&o$1(ExpandableList,{content:ge,item_descriptor:"",items_descriptor:get_items_descriptor("Future",de.length,_e),disable_collapsed:!0}),(ve||ye)&&o$1("hr",{}),ye&&o$1(ExpandableList,{content:he,item_descriptor:"",items_descriptor:get_items_descriptor("Present",fe.length,_e),disable_collapsed:!0}),ye&&we&&o$1("hr",{}),we&&o$1(ExpandableList,{content:be,item_descriptor:"",items_descriptor:get_items_descriptor("Past",pe.length,_e),disable_collapsed:!0})]})]})}const PredictionList=connector$P(_PredictionList),get_id$2=t=>t.id,get_created_at$1=t=>t.created_at,get_custom_created_at$1=t=>t.custom_created_at;function get_summary$1(t,ee){return o$1(PredictionViewSummary,{prediction:t,on_change:ee.update_item})}function factory_get_details(t){return(ee,te)=>o$1(PredictionViewDetails,{prediction:ee,on_change:te.update_item,editing:t})}function prepare_new_item(t,ee){const te=get_new_created_ats(ee),ne=floor_datetime_to_resolution(te.custom_created_at||te.created_at,"day");return{id:get_new_prediction_id(),...te,base_id:t,datetime:{value:ne},explanation:"",probability:1,conviction:1}}const WComponentFromTo$1="",map_state$O=t=>{var ee;return{any_node:(ee=t.derived.current_composed_knowledge_view)==null?void 0:ee.wc_ids_by_type.any_node,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t),created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$x={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent},connector$O=connect(map_state$O,map_dispatch$x);function _WComponentFromTo(t){const{connection_terminal_description:ee,wcomponent_id:te,connection_terminal_type:ne,any_node:oe,wcomponents_by_id:ie,knowledge_views_by_id:se,wc_id_to_counterfactuals_map:re,on_update_id:_e,on_update_type:ae,set_highlighted_wcomponent:ce}=t,le=te?ie[te]:void 0,ue=get_wcomponent_search_options({wcomponents_by_id:ie,allowed_wcomponent_ids:oe,knowledge_views_by_id:se,wc_id_to_counterfactuals_map:re,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}),de=[{id:"validity",title:"Validity"},{id:"state",title:"State"},{id:"meta",title:"Meta"}];return o$1("div",{title:le&&le.title,className:"wcomponent_from_to",children:[o$1("span",{className:"description_label",children:[ee,"  "]}),o$1(AutocompleteText,{placeholder:ee+"...",selected_option_id:te,options:ue,allow_none:!0,on_change:me=>_e(me),on_mouse_over_option:me=>ce({id:me,highlighted:!0}),on_mouse_leave_option:me=>ce({id:me,highlighted:!1})}),te&&o$1(Link,{route:void 0,sub_route:void 0,item_id:te,args:void 0,children:o$1(ExternalLinkIcon,{})}),ae&&o$1(AutocompleteText,{placeholder:"attribute...",selected_option_id:ne,options:de,allow_none:!1,on_change:me=>ae(me),on_mouse_over_option:me=>ce({id:te,highlighted:!0}),on_mouse_leave_option:me=>ce({id:te,highlighted:!1})})]})}const WComponentFromTo=connector$O(_WComponentFromTo),map_state$N=(t,{wcomponent:ee})=>{const te=get_current_composed_knowledge_view_from_state(t),ne=[];if(te){const{judgement:ie,objective:se}=te.wc_ids_by_type,re=Array.from(set_union(ie,se));get_wcomponents_from_state(t,re).forEach((_e,ae)=>{wcomponent_is_judgement_or_objective(_e,re[ae])&&ne.push(_e)})}const oe=get_wc_id_to_counterfactuals_v2_map$1(t);return{consumption_formatting:t.display_options.consumption_formatting,filtered_wcomponents:ne,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$w={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent},connector$N=connect(map_state$N,map_dispatch$w);function _ChosenObjectivesFormFields(t){const{objective_ids:ee=[]}=t.wcomponent;if(t.consumption_formatting&&ee.length===0)return null;const te=get_wcomponent_search_options({wcomponents:t.filtered_wcomponents,wcomponents_by_id:t.wcomponents_by_id,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:t.wc_id_to_counterfactuals_map,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1("div",{children:[o$1("p",{children:["Objectives",o$1(MultiAutocompleteText,{editing_allowed:t.editing_allowed,placeholder:"Objectives...",selected_option_ids:ee,options:te,allow_none:!0,on_change:ne=>t.upsert_wcomponent({objective_ids:ne}),on_mouse_over_option:ne=>t.set_highlighted_wcomponent({id:ne,highlighted:!0}),on_mouse_leave_option:ne=>t.set_highlighted_wcomponent({id:ne,highlighted:!1})})]}),o$1("hr",{}),o$1("br",{})]})}const ChosenObjectivesFormFields=connector$N(_ChosenObjectivesFormFields),_judgement_operators={"==":!0,"!=":!0,"<":!0,"<=":!0,">":!0,">=":!0},judgement_operators=Object.keys(_judgement_operators),_judgement_trends={improving:!0,worsening:!0,stable:!0,unknown:!0,not_assessed:!0},judgement_trends=Object.keys(_judgement_trends),map_state$M=(t,{wcomponent:ee})=>{const te=ee.judgement_target_wcomponent_id,ne=get_wcomponent_from_state(t,te),oe=get_VAP_set_id_to_counterfactual_v2_map(t,te);return{target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,is_editing:!t.display_options.consumption_formatting}},connector$M=connect(map_state$M);function _JudgementFormFields(t){const{wcomponent:ee,upsert_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:se}=t,{judgement_manual:re,judgement_trend_manual:_e}=ee,ae=re===void 0?void 0:re.toString(),ce=calculate_judgement_value({judgement_wcomponent:ee,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:oe,created_at_ms:ie,sim_ms:se}),ue=get_wcomponent_VAPs_represent(ne,{});let de=[];if(ue===VAPsType.boolean){const me=get_boolean_representation(ne,!0);de=[{id:"True",title:me.true},{id:"False",title:me.false}]}return o$1("p",{children:[o$1(WComponentFromTo,{connection_terminal_description:"Target",wcomponent_id:ne&&ne.id,connection_terminal_type:"meta",on_update_id:me=>{const pe={judgement_target_wcomponent_id:me};!ee.title&&me&&(pe.title=sentence_case(ee.type)+`: @@${me}`),te(pe)}}),(t.is_editing||ae!==void 0)&&o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Manual:   ",o$1(AutocompleteText,{placeholder:"Manual override...",allow_none:!0,selected_option_id:ae,options:manual_options,on_change:me=>{te({judgement_manual:me===void 0?void 0:me==="true"})}})]})}),ae===void 0&&o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Comparator:   ",o$1(AutocompleteText,{extra_styles:{width:30},placeholder:"Operator...",selected_option_id:ee.judgement_operator,options:judgement_operator_options,on_change:me=>te({judgement_operator:me})})," ",ue!==VAPsType.boolean&&o$1(EditableTextSingleLine,{placeholder:"Value...",value:ee.judgement_comparator_value||"",conditional_on_change:me=>{const pe=me.trim();pe!==ee.judgement_comparator_value&&te({judgement_comparator_value:pe})}}),ue===VAPsType.boolean&&o$1(AutocompleteText,{placeholder:"Value...",selected_option_id:ee.judgement_comparator_value,options:de,on_change:me=>{me&&me!==ee.judgement_comparator_value&&te({judgement_comparator_value:me})}})]})}),(t.is_editing||_e!==void 0&&_e!=="not_assessed")&&o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Manual trend:   ",o$1(AutocompleteText,{placeholder:"Manual trend...",allow_none:!0,selected_option_id:_e||"Not assessed",options:manual_trend_options,on_change:me=>{te({judgement_trend_manual:me==="not_assessed"?void 0:me})}})]})}),o$1("p",{children:o$1("div",{style:{display:"inline-flex"},children:["Current value:   ",o$1(JudgementBadge,{judgement:ce,judgement_trend_manual:_e,size:"medium"})]})})]})}const JudgementFormFields=connector$M(_JudgementFormFields),judgement_operator_options=judgement_operators.map(t=>({id:t,title:t})),manual_options=[{id:"true",title:"Good"},{id:"false",title:"Bad"}],manual_trend_options=judgement_trends.map(t=>({id:t,title:sentence_case(t).replaceAll("_"," ")}));function WComponentCausalLinkForm(t){const{wcomponent:ee,from_wcomponent:te,editing:ne,upsert_wcomponent:oe}=t,ie=wcomponent_is_statev2(te),re=get_wcomponent_VAPs_represent(te,{})===VAPsType.number,_e=ne||ee.effect_when_true!==void 0,ae=!re&&ne?te===void 0||ie:ie&&ee.effect_when_false!==void 0;return o$1(BasicCausalLinkForm,{show_primary_effect:_e,show_effect_when_false:ae,VAPs_represent_number:re,effect_when_true:ee.effect_when_true,effect_when_false:ee.effect_when_false,editing:ne,change_effect:oe})}function BasicCausalLinkForm(t){const{show_primary_effect:ee,show_effect_when_false:te,VAPs_represent_number:ne,effect_when_true:oe,effect_when_false:ie,editing:se,change_effect:re}=t;return o$1("p",{style:{display:"flex"},children:[ee&&o$1("div",{style:{flex:1},children:[o$1("span",{className:"description_label",children:ne?"Effect":"Effect when true"}),"   ",o$1(EditableNumber,{placeholder:"...",value:oe,editing_allowed:se,allow_undefined:!0,style:{width:"100px"},on_blur:ae=>re({effect_when_true:ae,effect_when_false:ie}),on_blur_type:EditableTextOnBlurType.conditional})]}),te&&o$1("div",{style:{flex:1},children:[o$1("span",{className:"description_label",children:"Effect when false"}),"   ",o$1(EditableNumber,{placeholder:"...",value:ie,editing_allowed:se,allow_undefined:!0,style:{width:"100px"},on_blur:ae=>re({effect_when_false:ae,effect_when_true:oe}),on_blur_type:EditableTextOnBlurType.conditional})]}),se&&te&&o$1("div",{style:{flex:1,margin:"auto"},children:o$1(Button,{value:"Invert Effect",onClick:()=>{re({effect_when_true:ie,effect_when_false:oe})}})})]})}const map_state$L=t=>{const ee=get_current_knowledge_view_from_state(t),te=get_current_composed_knowledge_view_from_state(t);return{knowledge_view:ee,editing:!t.display_options.consumption_formatting,composed_wc_id_map:te&&te.composed_wc_id_map,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$v={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$L=connect(map_state$L,map_dispatch$v);function _WComponentCounterfactualForm(t){const{wcomponent:ee,upsert_wcomponent:te,wcomponents_by_id:ne,knowledge_views_by_id:oe,composed_wc_id_map:ie,knowledge_view:se}=t;if(!ie)return o$1("div",{children:"Counterfactual form can not render: No current knowledge view"});const re=Object.keys(ie).map(pe=>ne[pe]).filter(is_defined).filter(wcomponent_is_allowed_to_have_state_VAP_sets),_e=get_wcomponent_search_options({wcomponents:re,wcomponents_by_id:ne,knowledge_views_by_id:oe,wc_id_to_counterfactuals_map:void 0,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}),ae=ne[ee.target_wcomponent_id||""];let ce=[],le=[];wcomponent_is_allowed_to_have_state_VAP_sets(ae)&&(ce=ae.values_and_prediction_sets||[],le=ce.map(({id:pe,datetime:fe})=>{const ge=uncertain_date_to_string(fe,"minute");return{id:pe,title:ge}}));const ue=get_wcomponent_VAPs_represent(ae,ne),de=ce.find(({id:pe})=>pe===ee.target_VAP_set_id);let me=!1;return se&&(me=(se.active_counterfactual_v2_ids||[]).includes(ee.id)),o$1("div",{children:[o$1("p",{children:[o$1("span",{className:"description_label",children:"Target component"}),"  ",ee.target_wcomponent_id&&o$1(Link,{route:void 0,sub_route:void 0,item_id:ee.target_wcomponent_id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"  "]}),o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ee.target_wcomponent_id,options:_e,on_change:pe=>te({target_wcomponent_id:pe,target_VAP_set_id:void 0,target_VAP_id:void 0}),on_mouse_over_option:pe=>t.set_highlighted_wcomponent({id:pe,highlighted:!0}),on_mouse_leave_option:pe=>t.set_highlighted_wcomponent({id:pe,highlighted:!1})})})]}),ee.target_wcomponent_id&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Target value and prediction set to override"}),"  ",o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ee.target_VAP_set_id,options:le,on_change:pe=>{te({target_VAP_set_id:pe,target_VAP_id:void 0})}})})]}),ae&&de&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Counterfactual value"}),"  ",convert_VAP_set_to_VAP_visuals({VAP_set:de,VAPs_represent:ue,wcomponent:ae,sort:!1}).map(pe=>{const{VAP_id:fe,value_text:ge}=pe,he=fe===ee.target_VAP_id;return o$1("div",{children:[o$1("input",{type:"radio",disabled:!t.editing,id:fe,value:ge,checked:he,onChange:()=>te({target_VAP_id:fe})}),o$1("label",{for:fe,children:ge})]})})]}),se&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Apply counterfactual in this knowledge view"}),"  ",o$1(EditableCheckbox,{value:me,on_change:()=>{const{id:pe}=ee,fe=toggle_item_in_list(se.active_counterfactual_v2_ids||[],pe),ge={...se,active_counterfactual_v2_ids:fe};t.upsert_knowledge_view({knowledge_view:ge})}}),!de&&me&&o$1("span",{title:"Will not be applied yet, you need to target a component and one of its value sets",children:o$1(default_1$g,{})})]})]})}const WComponentCounterfactualForm=connector$L(_WComponentCounterfactualForm),map_state$K=t=>({creation_context_state:t.creation_context}),connector$K=connect(map_state$K);function _WComponentDateTimeFormField(t){const{wcomponent:ee,creation_context_state:te,upsert_wcomponent:ne}=t,oe=ee.datetime||{};return o$1("p",{children:o$1(UncertainDateTimeForm,{datetime:oe,on_change:ie=>ne({datetime:ie})})})}const WComponentDateTimeFormField=connector$K(_WComponentDateTimeFormField),PredictionBadge$1="",PredictionBadgeConvictionMask="";function PredictionsBadgeConvictionMask(t){const{size:ee,border_width:te,elements_width:ne,conviction:oe}=t,ie=ee/ne;return o$1("g",{className:"conviction_mask",onMouseEnter:se=>se.currentTarget.classList.add("hovered"),onMouseLeave:se=>se.currentTarget.classList.remove("hovered"),ref:se=>{if(!se)return;const re=se.getElementsByClassName("parts")[0];Array.from(re.children).forEach(_e=>{const ae=_e.getAttribute("data-group_id");if(!ae)return;let le=parseInt(ae,10)/100<=oe?"display: none;":"";const ue=130+Math.random()*45;le+=`fill: rgb(${ue},${ue},${ue})`,_e.setAttribute("style",le)})},children:[o$1("rect",{x:0,y:0,width:ee+2,height:ee+2,fill:"rgba(0,0,0,0)"}),o$1("g",{className:"parts",children:mask_data.map(se=>o$1("rect",{"data-group_id":se[2],x:te+se[0]*ie,y:te+se[1]*ie,width:ie,height:ie}))})]})}const mask_data=[[0,9,40],[0,8,30],[0,7,40],[0,6,90],[0,5,10],[0,4,95],[0,3,60],[0,2,60],[0,1,90],[0,0,40],[1,9,20],[1,8,50],[1,7,80],[1,6,60],[1,5,80],[1,4,90],[1,3,90],[1,2,30],[1,1,50],[1,0,30],[2,9,20],[2,8,50],[2,7,80],[2,6,40],[2,5,70],[2,4,20],[2,3,20],[2,2,50],[2,1,60],[2,0,40],[3,9,90],[3,8,50],[3,7,20],[3,6,30],[3,5,60],[3,4,50],[3,3,20],[3,2,2],[3,1,95],[3,0,10],[4,9,80],[4,8,30],[4,7,90],[4,6,60],[4,5,50],[4,4,100],[4,3,40],[4,2,70],[4,1,30],[4,0,98],[5,9,20],[5,8,40],[5,7,70],[5,6,50],[5,5,70],[5,4,90],[5,3,50],[5,2,70],[5,1,10],[5,0,80],[6,9,20],[6,8,5],[6,7,30],[6,6,50],[6,5,70],[6,4,100],[6,3,20],[6,2,90],[6,1,60],[6,0,60],[7,9,30],[7,8,70],[7,7,80],[7,6,70],[7,5,20],[7,4,10],[7,3,30],[7,2,98],[7,1,98],[7,0,90],[8,9,5],[8,8,60],[8,7,95],[8,6,70],[8,5,70],[8,4,80],[8,3,95],[8,2,40],[8,1,95],[8,0,2],[9,9,40],[9,8,40],[9,7,80],[9,6,80],[9,5,90],[9,4,10],[9,3,5],[9,2,60],[9,1,80],[9,0,30]];function calc_new_counterfactual_state(t){let ee,te;const{conviction:ne,probability:oe,counterfactual_conviction:ie,counterfactual_probability:se}=t,re=se===void 0&&ie===void 0;return ne!==1&&(te=1),re&&(oe===1&&ne!==1||oe!==1)?ee=1:se!==0&&(oe===0&&ne!==1||oe!==0)?ee=0:(ee=void 0,te=void 0),{new_counterfactual_probability:ee,new_counterfactual_conviction:te}}const test_calc_new_counterfactual_state=describe("calc_new_counterfactual_state",()=>{let t,ee,te,ne,oe;t=.5,ee=1,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=1,ee=1,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=0,ee=1,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,void 0),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:void 0}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=.5,ee=.5,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,ne=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=1,ee=.5,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,ne=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0),t=0,ee=.5,oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:void 0,counterfactual_conviction:void 0}),te=1,ne=1,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),te=0,test(oe.new_counterfactual_probability,te),test(oe.new_counterfactual_conviction,ne),oe=calc_new_counterfactual_state({probability:t,conviction:ee,counterfactual_probability:te,counterfactual_conviction:ne}),test(oe.new_counterfactual_probability,void 0),test(oe.new_counterfactual_conviction,void 0)},!1);function PredictionBadge(t){const{size:ee,elements_width:te=10}=t,ne=te*te,oe=ee/te,{counterfactual_probability:ie,counterfactual_conviction:se,set_counterfactual:re}=t,_e=is_num(ie)||is_num(se),{probability:ae,conviction:ce}=sanitise_props(t),le=is_num(ie)?ie:ae,ue=is_num(se)?se:ce;function de(){if(!re)return;const he=calc_new_counterfactual_state({probability:ae,conviction:ce,counterfactual_probability:ie,counterfactual_conviction:se});re({probability:he.new_counterfactual_probability,conviction:he.new_counterfactual_conviction})}const me=3,fe=`prediction_badge ${`counterfactual_${_e?"":"in"}active`}`,ge="Visual display of probability and confidence";return o$1("div",{style:{cursor:t.disabled?"not-allowed":"pointer"},title:ge,children:o$1("svg",{width:ee+me*2,height:ee+me*2,onClick:()=>!t.disabled&&de(),className:fe,children:[o$1("rect",{x:0,y:0,width:ee+me*2,height:ee+me*2,className:"outline"}),o$1("g",{children:Array.from(Array(ne)).map((he,be)=>{const ve=be/ne,ye=be%te,we=Math.floor(be/te);return{i:be,i_frac:ve,x:ye,y:we,ys:me+(te-1-ye)*oe,xs:me+we*oe}}).map(he=>{const ye=(he.i_frac<le?0:1)*255;return{...he,fill:`rgb(${ye},${ye},${ye})`}}).map(he=>o$1("rect",{x:he.xs,y:he.ys,width:oe,height:oe,fill:he.fill}))}),o$1(PredictionsBadgeConvictionMask,{size:ee,border_width:me,elements_width:te,conviction:ue})]})})}function sanitise_props({probability:t,conviction:ee}){const te=bounded(t,0,1),ne=bounded(ee,0,1);return te!==t&&console.error(`probability: ${t} not in range 0 to 1`),ne!==ee&&console.error(`conviction: ${ee} not in range 0 to 1`),{probability:te,conviction:ne}}function is_num(t){return Number.isFinite(t)}const map_state$J=t=>({creation_context_state:t.creation_context,editing:!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)}),connector$J=connect(map_state$J);function _WComponentEventAtFormField(t){const{wcomponent:ee,creation_context_state:te,upsert_wcomponent:ne,base_id:oe}=t,ie=ee.event_at&&ee.event_at[0],se=re=>{const _e={event_at:[{probability:1,conviction:1,datetime:{},id:"",base_id:oe||-1,explanation:"",...ie||{...get_new_created_ats(te)},...re}]};ne(_e)};return o$1("p",{children:[o$1(UncertainDateTimeForm,{datetime:ie?ie.datetime:{},on_change:re=>se({datetime:re})}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:[o$1(EditablePercentage,{placeholder:"Probability",value:ie==null?void 0:ie.probability,on_blur:re=>se({probability:re}),on_blur_type:EditableTextOnBlurType.conditional}),o$1(EditablePercentage,{placeholder:"Confidence",value:ie==null?void 0:ie.conviction,on_blur:re=>se({conviction:re}),on_blur_type:EditableTextOnBlurType.conditional}),"  ",ie&&o$1(PredictionBadge,{disabled:!0,size:20,probability:ie.probability,conviction:ie.conviction})]}),o$1("br",{}),o$1("br",{}),t.editing&&o$1(Button,{fullWidth:!0,value:ie?"Clear Event":"Create Default Event",onClick:()=>{ie?ne({event_at:[]}):se({conviction:1,probability:1})}})]})}const WComponentEventAtFormField=connector$J(_WComponentEventAtFormField),map_state$I=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id}),map_dispatch$u={change_route:ACTIONS.routing.change_route},connector$I=connect(map_state$I,map_dispatch$u);function _WComponentBackReferences(t){const{wcomponent_id:ee,wcomponents_by_id:te,knowledge_views_by_id:ne}=t,[oe,ie]=h$1(!1),[se,re]=h$1([]);if(p$1(()=>{let ce=[];oe&&(ce=Object.values(te).filter(le=>wcomponent_is_not_deleted(le)).filter(le=>le.title.includes(ee)||le.description.includes(ee)||(le.label_ids||[]).includes(ee)||(wcomponent_is_goal(le)||wcomponent_is_action(le))&&(le.parent_goal_or_action_ids||[]).includes(ee)||wcomponent_is_judgement_or_objective(le)&&le.judgement_target_wcomponent_id===ee||wcomponent_has_legitimate_non_empty_state_VAP_sets(le)&&le.values_and_prediction_sets.find(ue=>ue.entries.find(de=>(de.explanation||"").includes(ee)))||wcomponent_has_validity_predictions(le)&&le.validity.find(ue=>(ue.explanation||"").includes(ee))||wcomponent_is_plain_connection(le)&&(le.from_id===ee||le.to_id===ee)||wcomponent_is_state_value(le)&&le.attribute_wcomponent_id===ee).filter(le=>le.id!==ee)),re(ce)},[ee,te,oe]),!oe)return o$1("div",{children:o$1(Button,{value:"Show back references",onClick:()=>ie(!0)})});if(se.length===0)return o$1("div",{children:"No back references"});const _e=new Date().getTime(),ae=_e;return o$1("div",{children:["Back references:",se.map(ce=>o$1("div",{children:o$1(Link,{route:void 0,sub_route:void 0,item_id:ce.id,args:void 0,children:o$1(Markdown,{children:get_title$1({wcomponent:ce,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:void 0,created_at_ms:_e,sim_ms:ae})||`No title for component ${ce.id}`})})}))]})}const WComponentBackReferences=connector$I(_WComponentBackReferences),map_state$H=t=>{const ee=get_current_composed_knowledge_view_from_state(t),te=get_current_knowledge_view_from_state(t),ne=ee==null?void 0:ee.composed_datetime_line_config;return{kv:te,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,created_at_ms:t.routing.args.created_at_ms,time_origin_ms:ne==null?void 0:ne.time_origin_ms,time_origin_x:ne==null?void 0:ne.time_origin_x,time_scale:ne==null?void 0:ne.time_scale}},map_dispatch$t={upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$H=connect(map_state$H,map_dispatch$t);function _ButtonSnapXToDatetime(t){const[ee,te]=h$1(void 0),{kv:ne,wcomponent_id:oe,wcomponents_by_id:ie,created_at_ms:se,time_origin_ms:re,time_origin_x:_e,time_scale:ae,upsert_knowledge_view:ce}=t,le=(oe?[oe]:t.wcomponent_ids)||[],{id:ue,wc_id_map:de}=ne||{},me=!ne||!ue||de===void 0||re===void 0||_e===void 0||ae===void 0||!!oe&&calculate_canvas_x_for_wcomponent_temporal_uncertainty({wcomponent_id:oe,wcomponents_by_id:ie,created_at_ms:se,time_origin_ms:re,time_origin_x:_e,time_scale:ae})===void 0,pe=me?re===void 0?"Disabled as time origin not set":_e===void 0?"Disabled as time origin X position is not set":"Diabled":"";let fe="";return ee!==void 0&&(ee?le.length>1&&(fe=`Changed ${ee}`):fe="No changes"),o$1("div",{style:{display:"inline-block"},children:[o$1(Button,{disabled:me,value:"X by time",title:pe,onClick:()=>{if(me)return;const{number_changed:ge,knowledge_view:he}=calulate_new_positions({wcomponent_ids:le,wcomponents_by_id:ie,kv:ne,wc_id_map:de,created_at_ms:se,time_origin_ms:re,time_origin_x:_e,time_scale:ae});ge&&he&&ce({knowledge_view:he}),te(ge),setTimeout(()=>te(void 0),1e3)},is_left:!0}),fe]})}const ButtonSnapXToDatetime=connector$H(_ButtonSnapXToDatetime);function calulate_new_positions(t){const{wcomponent_ids:ee,wcomponents_by_id:te,kv:ne,wc_id_map:oe,created_at_ms:ie,time_origin_ms:se,time_origin_x:re,time_scale:_e}=t;let ae=0;if(!ne||!oe||se===void 0||re===void 0||_e===void 0)return{number_changed:ae,knowledge_view:void 0};const ce={...oe};ee.forEach(ue=>{const de=oe[ue];if(!de)return;const me=calculate_canvas_x_for_wcomponent_temporal_uncertainty({wcomponent_id:ue,wcomponents_by_id:te,created_at_ms:ie,time_origin_ms:se,time_origin_x:re,time_scale:_e});if(me===void 0)return;const pe={...de,left:me};ce[ue]=pe,ae+=1});const le=ae?{...ne,wc_id_map:ce}:void 0;return{number_changed:ae,knowledge_view:le}}const map_state$G=t=>{const ee=get_current_knowledge_view_from_state(t);return{knowledge_view_id:ee==null?void 0:ee.id,kv:ee}},map_dispatch$s={snap_to_grid_knowledge_view_entries:ACTIONS.specialised_object.snap_to_grid_knowledge_view_entries,bulk_add_to_knowledge_view:ACTIONS.specialised_object.bulk_add_to_knowledge_view,change_current_knowledge_view_entries_order:ACTIONS.specialised_object.change_current_knowledge_view_entries_order},connector$G=connect(map_state$G,map_dispatch$s);function _AlignComponentForm(t){const{wcomponent_id:ee,wcomponent_ids:te,knowledge_view_id:ne,kv:oe}=t,ie=(ee?[ee]:te)||[],se=oe&&ee?Object.keys(oe.wc_id_map).findIndex(ce=>ce===ee):void 0,re=oe?Object.keys(oe.wc_id_map).length:void 0,_e=se!==void 0&&se+1===re,ae=se===0;return o$1("div",{children:[o$1("h3",{children:"Align"}),o$1(Button,{disabled:!ne,value:"Snap to grid",onClick:()=>{ne&&t.snap_to_grid_knowledge_view_entries({wcomponent_ids:ie,knowledge_view_id:ne})},is_left:!0})," ",o$1(ButtonSnapXToDatetime,{...t})," ",o$1(Button,{disabled:!ne,value:"Bring here",onClick:()=>{if(!ne)return;const ce=get_store().getState(),le=get_middle_of_screen(ce);t.bulk_add_to_knowledge_view({knowledge_view_id:ne,wcomponent_ids:ie,override_entry:le})},is_left:!0}),o$1("br",{}),o$1("span",{title:_e?"Already at front":"Move to front",children:o$1(Button,{value:"Move to front",disabled:_e,onClick:()=>{t.change_current_knowledge_view_entries_order({wcomponent_ids:ie,order:"front"})},is_left:!0})})," ",o$1("span",{title:ae?"Already at back":"Move to back",children:o$1(Button,{value:"Move to back",disabled:ae,onClick:()=>{t.change_current_knowledge_view_entries_order({wcomponent_ids:ie,order:"back"})},is_left:!0})})]})}const AlignComponentForm=connector$G(_AlignComponentForm),map_state$F=(t,ee)=>{const{wcomponent_id:te}=ee,ne=get_current_knowledge_view_from_state(t),oe=ne&&ne.wc_id_map[te],ie=t.derived.knowledge_views;return{knowledge_view_id:ne&&ne.id,knowledge_view_entry:oe,all_knowledge_views:ie}},connector$F=connect(map_state$F);function _WComponentPresenceInOtherKVs(t){const{knowledge_view_id:ee,wcomponent_id:te,knowledge_view_entry:ne}=t,oe=t.all_knowledge_views.filter(({id:se})=>se!==ee).filter(({wc_id_map:se})=>{const re=se[te];return re&&!re.blocked&&!re.passthrough});if(oe.length===0)return null;const ie=!ne||ne.blocked||ne.passthrough;return o$1("div",{children:[ie?"Present":"Also"," in:",oe.map(se=>{const re=se.wc_id_map[t.wcomponent_id],_e=lefttop_to_xy(re,!0);return o$1("div",{children:o$1(Link,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:se.id,..._e},children:se.title})})})]})}const WComponentPresenceInOtherKVs=connector$F(_WComponentPresenceInOtherKVs);function get_wcomponent_status_in_knowledge_view(t){const{editing_allowed:ee,wcomponent_id:te,knowledge_view:ne,composed_wc_id_maps_object:oe,foundation_composed_wc_id_map:ie}=t,se={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},re=ne.wc_id_map[te],_e=oe.composed_wc_id_map[te],ae=!!(!re||re.blocked||re.passthrough);return se.show_wcomponent_status_in_this_kv_section=!!(ne.id&&ae),se.show_wcomponent_status_in_this_kv_section&&(se.wcomponent_status_in_this_kv_text=(re!=null&&re.blocked?"Deleted from":"Not present in")+" this knowledge view"+(_e&&!_e.blocked?" but is present in a foundational knowledge view":"")),se.show_add_button=se.show_wcomponent_status_in_this_kv_section&&ee,se.show_add_button&&(se.add_button_text=(re!=null&&re.blocked?"Re-add":"Add")+" to current knowledge view"),se.show_remove_button=!!(ee&&re&&!re.passthrough),se.show_remove_button&&(se.remove_button_text="Remove from knowledge view",se.remove_button_tooltip="Remove from current knowledge view ("+ne.title+")",re!=null&&re.blocked&&ie[te]&&(se.remove_button_text="Remove block (allow to show through from foundational knowledge view)",se.remove_button_tooltip="This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view ("+ne.title+")")),se.show_remove_and_block_button=!!(ee&&re&&!re.blocked&&!re.passthrough&&ie[te]),se.show_remove_and_block_button&&(se.remove_and_block_button_text="Remove and Block from knowledge view",se.remove_and_block_button_tooltip="Remove and Block from showing in current knowledge view ("+ne.title+")"),se}const map_state$E=(t,ee)=>{const{wcomponent_id:te}=ee,ne=get_current_knowledge_view_from_state(t),oe=ne&&ne.wc_id_map[te],ie=get_current_composed_knowledge_view_from_state(t),se=ie&&ie.composed_wc_id_map[te],re=get_middle_of_screen(t);return{knowledge_view:ne,composed_knowledge_view_entry:se,knowledge_view_entry:oe,middle_position_left:re.left,middle_position_top:re.top,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponents_by_id:t.specialised_objects.wcomponents_by_id}},map_dispatch$r={upsert_knowledge_view_entry:ACTIONS.specialised_object.upsert_knowledge_view_entry,bulk_remove_from_knowledge_view:ACTIONS.specialised_object.bulk_remove_from_knowledge_view},connector$E=connect(map_state$E,map_dispatch$r);function _WComponentKnowledgeViewForm(t){const{wcomponent_id:ee,knowledge_view:te,composed_knowledge_view_entry:ne,knowledge_view_entry:oe,editing_allowed:ie,knowledge_views_by_id:se,wcomponents_by_id:re}=t;if(!te)return null;const _e=get_foundational_knowledge_views(te,se,!0),ae=get_composed_wc_id_maps_object(_e,re),ce=get_foundational_knowledge_views(te,se,!1),le=get_composed_wc_id_maps_object(ce,re),ue=get_wcomponent_status_in_knowledge_view({editing_allowed:ie,wcomponent_id:ee,knowledge_view:te,composed_wc_id_maps_object:ae,foundation_composed_wc_id_map:le.composed_wc_id_map}),{show_wcomponent_status_in_this_kv_section:de,wcomponent_status_in_this_kv_text:me,show_add_button:pe,add_button_text:fe,show_remove_button:ge,remove_button_text:he,remove_button_tooltip:be,show_remove_and_block_button:ve,remove_and_block_button_text:ye,remove_and_block_button_tooltip:we}=ue;function ke($e,xe={}){const Ce={...ne||{left:t.middle_position_left,top:t.middle_position_top},...xe};t.upsert_knowledge_view_entry({wcomponent_id:ee,knowledge_view_id:$e,entry:Ce})}const Ae=(oe==null?void 0:oe.frame_width)!==void 0&&(oe==null?void 0:oe.frame_height)!==void 0;return o$1("div",{children:[ie&&oe&&!oe.blocked&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Size"}),o$1(Slider,{color:"secondary",defaultValue:1,marks:!0,min:.25,max:2,onChange:($e,xe)=>{const Ce=Array.isArray(xe)?xe[0]:xe;ke(te.id,{s:Ce})},step:.25,value:oe.s?oe.s:1,valueLabelDisplay:"on"})]}),ie&&oe&&!oe.blocked&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Frame"}),o$1("p",{children:o$1(Button,{value:Ae?"Remove Frame":"Add Frame",onClick:()=>{const $e={};Ae?($e.frame_color=void 0,$e.frame_width=void 0,$e.frame_height=void 0):($e.frame_color=$e.frame_color??default_frame_color,$e.frame_width=$e.frame_width??(h_step+grid_small_step)*2,$e.frame_height=$e.frame_height??(v_step+grid_small_step)*2),ke(te.id,$e)}})}),o$1("span",{className:"description_label",children:"Frame Color"}),o$1(ColorPicker,{color:oe.frame_color,conditional_on_blur:$e=>{ke(te.id,{frame_color:$e})}})]}),ie&&o$1("p",{children:[o$1(AlignComponentForm,{wcomponent_id:ee}),o$1("br",{})]}),o$1("div",{style:{display:"inline-flex"},children:[o$1(MoveToWComponentButton,{wcomponent_id:ee,disable_if_not_present:!0}),o$1(Box,{zIndex:10,m:4,class:"node_handle",children:o$1(ExploreButtonHandle,{wcomponent_id:ee,wcomponent_current_kv_entry:ne,is_highlighted:!0})})]}),de&&o$1("div",{children:[me,o$1("br",{}),pe&&o$1(Button,{value:fe,extra_class_names:"left",onClick:()=>ke(te.id,{blocked:void 0,passthrough:void 0})})]}),ge&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:he,tooltip_text:be,on_delete:()=>{t.bulk_remove_from_knowledge_view({wcomponent_ids:[ee],remove_type:"passthrough"})}})}),ve&&o$1("div",{children:o$1(ConfirmatoryDeleteButton,{button_text:ye,tooltip_text:we,on_delete:()=>{t.bulk_remove_from_knowledge_view({wcomponent_ids:[ee],remove_type:"block"})}})}),ie&&o$1("p",{children:["Add to knowledge view",o$1(SelectKnowledgeView,{on_change:$e=>{$e&&ke($e,{blocked:void 0,passthrough:void 0})}})]}),o$1("p",{children:o$1(WComponentPresenceInOtherKVs,{wcomponent_id:ee})}),o$1("p",{children:o$1(WComponentBackReferences,{wcomponent_id:ee})})]})}const WComponentKnowledgeViewForm=connector$E(_WComponentKnowledgeViewForm),map_state$D=t=>({creation_context_state:t.creation_context}),connector$D=connect(map_state$D);function _WComponentImageForm(t){const{wcomponent:ee,upsert_wcomponent:te}=t,ne=ee.summary_image||void 0;return o$1(TextField,{fullWidth:!0,label:"Summary Image URL",onChange:oe=>{var se,re;let ie=(se=oe.target)!=null&&se.value?(re=oe.target)==null?void 0:re.value:null;ie!==void 0&&te({summary_image:ie})},value:ne,variant:"outlined"})}const WComponentImageForm=connector$D(_WComponentImageForm);function make_valid_selector(t){let ee;if(!t)return;const{target_VAP_set_id:te,target_value:ne,target_value_id_type:oe}=t;return te?ne&&oe?ee={target_VAP_set_id:te,target_value:ne,target_value_id_type:oe}:ee={target_VAP_set_id:te}:ne&&oe?ee={target_value:ne,target_value_id_type:oe}:ee=void 0,ee}const map_state$C=(t,ee)=>{const{target_wcomponent_id:te}=ee.wcomponent,ne=t.specialised_objects.wcomponents_by_id[te||""],oe=wcomponent_is_allowed_to_have_state_VAP_sets(ne)&&ne;return{wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:t.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,editing:!t.display_options.consumption_formatting,target_wcomponent:oe,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t)}},map_dispatch$q={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$C=connect(map_state$C,map_dispatch$q);function _WComponentSubStateForm(t){const{wcomponents_by_id:ee,knowledge_views_by_id:te,wcomponent:ne,upsert_wcomponent:oe,target_wcomponent:ie,wc_id_to_counterfactuals_map:se}=t,re=Array.from(t.wcomponent_ids_with_state_VAPs).map(de=>ee[de]).filter(is_defined).filter(wcomponent_is_allowed_to_have_state_VAP_sets),_e=get_wcomponent_search_options({wcomponents:re,wcomponents_by_id:ee,knowledge_views_by_id:te,wc_id_to_counterfactuals_map:se,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms}),ae=ne.selector||{};let ce=[],le=[],ue=[];return ie&&(ce=ie.values_and_prediction_sets||[],ce=prune_items_by_created_at_and_versions_and_sort_by_datetimes(ce,t.created_at_ms),le=ce.map(({id:de,datetime:me})=>{const pe=uncertain_date_to_string(me,"minute");return{id:de,title:pe}}),ue=convert_VAP_sets_to_visual_sub_state_value_possibilities({selector:ne.selector,target_wcomponent:ie})),o$1("div",{children:[o$1("p",{children:[o$1("span",{className:"description_label",children:"Target component"}),"  ",ne.target_wcomponent_id&&o$1(Link,{route:void 0,sub_route:void 0,item_id:ne.target_wcomponent_id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"  "]}),o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ne.target_wcomponent_id,options:_e,on_change:de=>oe({target_wcomponent_id:de,selector:void 0}),on_mouse_over_option:de=>t.set_highlighted_wcomponent({id:de,highlighted:!0}),on_mouse_leave_option:de=>t.set_highlighted_wcomponent({id:de,highlighted:!1})})})]}),ie&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Select value and prediction set timepoint of interest to display"}),"  ",o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:ae.target_VAP_set_id,options:le,on_change:de=>{const me=make_valid_selector({...ae,target_VAP_set_id:de});oe({selector:me})},retain_options_order:!0})})]}),ie&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Select value possibility of interest to limit display by"}),"  ",o$1("div",{children:[o$1("input",{type:"radio",disabled:!t.editing,id:"not_set_target_value",checked:ae.target_value===void 0||ae.target_value_id_type===void 0,onChange:()=>{const de=make_valid_selector({...ae,target_value:void 0,target_value_id_type:void 0});oe({selector:de})}}),o$1("label",{for:"not_set_target_value",children:"Not set"})]}),ue.map(de=>{const{value:me,id:pe,selected:fe}=de;return o$1("div",{children:[o$1("input",{type:"radio",disabled:!t.editing,id:pe,checked:fe||!1,onChange:()=>{const ge=make_valid_selector({...ae,target_value:pe||me,target_value_id_type:pe?"id":"value_string"});oe({selector:ge})}}),o$1("label",{for:pe,children:me})]})})]})]})}const WComponentSubStateForm=connector$C(_WComponentSubStateForm);function WComponentConnectionForm(t){const{wcomponent:ee,editing:te,upsert_wcomponent:ne}=t,{line_behaviour:oe}=ee;return o$1("div",{children:te&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Line style behaviour"}),"  ",o$1(AutocompleteText,{selected_option_id:oe,allow_none:!0,options,on_change:ie=>{ne({line_behaviour:ie})}})]})})}const options=connection_line_behaviours.map(t=>({id:t,title:sentence_case(t)})),_wcomponent_statev2_subtypes={boolean:!0,number:!0,other:!0},wcomponent_statev2_subtypes=Object.keys(_wcomponent_statev2_subtypes),wcomponent_type_options=wcomponent_types.map(t=>({id:t,title:wcomponent_type_to_text(t)})),wcomponent_statev2_subtype_options=wcomponent_statev2_subtypes.map(t=>({id:t,title:t})),map_state$B=t=>{var ee;return{current_kv_id:(ee=get_current_knowledge_view_from_state(t))==null?void 0:ee.id,goal_or_action_wcomponent_ids:t.derived.wcomponent_ids_by_type.goal_or_action,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,is_editing:!t.display_options.consumption_formatting,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},connector$B=connect(map_state$B);function _WComponentParentGoalOrActionForm(t){const{wcomponent:ee,wcomponents_by_id:te,upsert_wcomponent:ne}=t,oe=F$1(()=>{const se=Array.from(t.goal_or_action_wcomponent_ids).map(_e=>te[_e]).filter(is_defined);function re(_e){return _e.id===t.current_kv_id?new Date().getTime():_e.created_at.getTime()}return sort_list(se,re,SortDirection.descending)},[t.goal_or_action_wcomponent_ids,te,t.current_kv_id]),ie=get_wcomponent_search_options({wcomponents:oe,wcomponents_by_id:te,knowledge_views_by_id:t.knowledge_views_by_id,wc_id_to_counterfactuals_map:{},created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Parent Goal (or Action)"}),o$1(MultiAutocompleteText,{placeholder:"Add Label",selected_option_ids:ee.parent_goal_or_action_ids||[],options:ie,allow_none:!0,on_change:se=>{const re=se.filter(_e=>!!_e);ne({parent_goal_or_action_ids:re})}})]})}const WComponentParentGoalOrActionForm=connector$B(_WComponentParentGoalOrActionForm),map_state$A=t=>({current_knowledge_view:get_current_composed_knowledge_view_from_state(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:t.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,editing:!t.display_options.consumption_formatting,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t)}),map_dispatch$p={set_highlighted_wcomponent:ACTIONS.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:ACTIONS.specialised_object.upsert_knowledge_view},connector$A=connect(map_state$A,map_dispatch$p);function _WComponentStateValueForm(t){const{current_knowledge_view:ee,wcomponents_by_id:te,knowledge_views_by_id:ne,wcomponent:oe,upsert_wcomponent:ie,wc_id_to_counterfactuals_map:se}=t,re=Array.from(t.wcomponent_ids_with_state_VAPs).map(ue=>te[ue]).filter(is_defined).filter(wcomponent_is_allowed_to_have_state_VAP_sets),_e=ee==null?void 0:ee.composed_wc_id_map[oe.id];function ae(ue){const de=ee==null?void 0:ee.composed_wc_id_map[ue.id];return square_distance_between_kv_entries(_e,de)}const ce=sort_list(re,ae,SortDirection.ascending),le=get_wcomponent_search_options({wcomponents:ce,wcomponents_by_id:te,knowledge_views_by_id:ne,wc_id_to_counterfactuals_map:se,created_at_ms:t.created_at_ms,sim_ms:t.sim_ms});return o$1("div",{children:o$1("p",{children:[o$1("span",{className:"description_label",children:"Attribute (target) component"}),"  ",oe.attribute_wcomponent_id&&o$1(Link,{route:void 0,sub_route:void 0,item_id:oe.attribute_wcomponent_id,args:void 0,children:[o$1(ExternalLinkIcon,{}),"  "]}),o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{allow_none:!0,selected_option_id:oe.attribute_wcomponent_id,options:le,on_change:ue=>{const de=te[ue||""];let{value_possibilities:me}=oe;if((!me||!Object.keys(me))&&wcomponent_is_statev2(de)){const pe=get_wcomponent_VAPs_represent(de,te),fe=get_possibilities_from_VAP_sets(pe,de.value_possibilities,de.values_and_prediction_sets||[]);me=get_items_by_id(fe,"attribute's possible_values")}ie({attribute_wcomponent_id:ue,value_possibilities:me})},on_mouse_over_option:ue=>t.set_highlighted_wcomponent({id:ue,highlighted:!0}),on_mouse_leave_option:ue=>t.set_highlighted_wcomponent({id:ue,highlighted:!1})})})]})})}const WComponentStateValueForm=connector$A(_WComponentStateValueForm),map_state$z=t=>({consumption_formatting:t.display_options.consumption_formatting}),map_dispatch$o={change_route:ACTIONS.routing.change_route},connector$z=connect(map_state$z,map_dispatch$o);function _WComponentValidityPredictionsForm(t){const{wcomponent:ee}=t,{validity:te=[]}=ee,[ne,oe]=h$1(te.length>0);return t.consumption_formatting&&te.length===0?null:o$1("div",{className:"editable_list_entry padded "+(ne?"expanded":""),children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>oe(!ne),children:[o$1("div",{className:"summary",children:o$1("h4",{style:{display:"inline-block"},children:["Validity Predictions ",!ne&&te.length?`(${te.length})`:""]})}),o$1("div",{className:"expansion_button"})]}),ne&&o$1(PredictionList,{item_descriptor:(wcomponent_is_plain_connection(ee)?"Existence ":"Validity ")+" prediction",predictions:te,update_predictions:ie=>{const se=new Date().getTime()+1;t.change_route({args:{created_at_ms:se,sim_ms:se}}),t.upsert_wcomponent({validity:ie})}})]})}const WComponentValidityPredictionsForm=connector$z(_WComponentValidityPredictionsForm),SIMULATION_JS_RESERVED_WORDS=new Set(["-parent","e","pi","phi","mod","expt","abs","sin","asin","cos","acos","tan","atan","sqrt","log","exp","round","floor","ceiling","RandBeta","RandDist","RandBoolean","Rand","RandNormal","RandExp","RandLognormal","RandBinomial","RandNegativeBinomial","RandGamma","RandPoisson","RandTriangular","Magnitude","Abs","sin","cos","tan","asin","acos","atan","arcsin","arccos","arctan","Sign","Sqrt","Ln","Log","Logit","Expit","Round","Ceiling","Floor","Exp","Sample","IndexOf","Contains","Collapse","Select","Reverse","Reverse","Sort","Sort","Unique","Unique","Union","Intersection","Difference","Factorial","Max","Max","Lookup","Fill","Min","Min","Mean","Mean","Sum","Sum","Product","Product","Median","Median","StdDev","StdDev","Correlation","Keys","Values","Length","Count","Flatten","CDFNormal","PDFNormal","InvNormal","CDFLogNormal","PDFLogNormal","InvLogNormal","CDFt","PDFt","Invt","CDFF","PDFF","InvF","CDFChiSquared","PDFChiSquared","InvChiSquared","CDFExponential","PDFExponential","InvExponential","CDFPoisson","PMFPoisson","SetRandSeed","Alert","Console","Prompt","Confirm","Parse","Split","Join","Trim","Range","Length","IndexOf","Contains","Lowercase","Uppercase","sqrt","sum","ifthenelse","ifthenelse","assert","assert","map","map","map","indexof","filter","map","select","filter","filter","join","repeat","repeat","join","reverse","join","sort","join","unique","unique","join","unique","unique","max","flatten","flatten","min","mean","sum","product","sort","median","mean","stddev","mean","mean","stddev","stddev","sum","count","count","join","flatten","join","flatten","stringbase","vectorbase","Stop","Pause","Time","TimeStep","TimeLength","TimeStart","TimeEnd","Seconds","Minutes","Hours","Days","Weeks","Months","Years","Seasonal","Unitless","RemoveUnits","PastMean","PastMedian","PastValues","PastStdDev","PastCorrelation","PastMax","PastMin","Pulse","Ramp","Step","Delay","Smooth","Delay1","Delay3","Remove","Add","FindAll","ResetTimer","Transition","Value","SetValue","FindIndex","FindState","FindNotState","FindNearby","FindNearest","FindFurthest","Index","Connect","Unconnect","Connected","ConnectionWeight","SetConnectionWeight","Width","Height","Distance","Location","SetLocation","Move","MoveTowards"]);[...SIMULATION_JS_RESERVED_WORDS].forEach(t=>SIMULATION_JS_RESERVED_WORDS.add(t.toLowerCase()));function normalise_calculation_ids(t,ee){let te=t;te=convert_double_at_sign_uuidv4s_into_square_brackets(ee,te);let ne;({hidden_ids:ne,converted_equation:te}=hide_all_square_bracket_ids(te));let oe;return{hidden_curly_bracket_content:oe,converted_equation:te}=hide_all_curly_bracket_content(te),te=wrap_all_non_square_bracket_ids_in_square_brackets(te),te=unhide_all_hidden_curly_bracket_content(oe,te),te=unhide_all_hidden_ids(ne,te),te}function convert_double_at_sign_uuidv4s_into_square_brackets(t,ee){return t.forEach(te=>{const ne=new RegExp(`@@${te}`,"g"),oe=`[${te}]`;ee=ee.replace(ne,oe)}),ee}function hide_all_square_bracket_ids(t){const ee=get_square_bracket_ids_from_text(t);return ee.forEach((te,ne)=>{const oe=new RegExp(`\\[${te}\\]`,"g"),ie=`[hidden_square_bracket_id_${ne}]`;t=t.replace(oe,ie)}),{hidden_ids:ee,converted_equation:t}}function get_square_bracket_ids_from_text(t){return[...t.matchAll(square_bracket_ids_regex)].map(te=>te[1])}function hide_all_curly_bracket_content(t){const ee=get_curly_bracket_content_from_text(t);return ee.forEach((te,ne)=>{te=te.replaceAll("^","\\^");const oe=new RegExp(`\\{${te}\\}`,"g"),ie=`[hidden_curly_bracket_content_${ne}]`;t=t.replace(oe,ie)}),{hidden_curly_bracket_content:ee,converted_equation:t}}function get_curly_bracket_content_from_text(t){return[...t.matchAll(curly_bracket_content_regex)].map(te=>te[1])}function wrap_all_non_square_bracket_ids_in_square_brackets(t){const ee=get_non_square_bracket_ids_from_text(t);return exclude_reserved_simulationjs_words(ee).forEach(ne=>{const oe=new RegExp(`(^|[^\\[])${ne}`,"g"),ie=`$1[${ne}]`;t=t.replace(oe,ie)}),t}function get_non_square_bracket_ids_from_text(t){return[...t.matchAll(non_square_bracket_ids_regex)].map(te=>te[1])}function exclude_reserved_simulationjs_words(t){return t.filter(ee=>!SIMULATION_JS_RESERVED_WORDS.has(ee.toLowerCase()))}function unhide_all_hidden_curly_bracket_content(t,ee){return t.forEach((te,ne)=>{const oe=new RegExp(`\\[hidden_curly_bracket_content_${ne}\\]`,"g"),ie=`{${te}}`;ee=ee.replace(oe,ie)}),ee}function unhide_all_hidden_ids(t,ee){return t.forEach((te,ne)=>{const oe=new RegExp(`\\[hidden_square_bracket_id_${ne}\\]`,"g"),ie=`[${te}]`;ee=ee.replace(oe,ie)}),ee}const thousands_numbers_commas_regex=/.*?\d{1,3}((?:,\d{3})+)/g;function normalise_calculation_numbers(t){let ee=t;return[...ee.matchAll(thousands_numbers_commas_regex)].forEach(ne=>{const oe=ne[0];oe&&(ee=ee.replaceAll(oe,oe.replaceAll(",","")))}),ee}const numbers_with_percentages_regex=/.*?(\d*(?:\.\d+)?(?:e(?:-|\+)\d+)?\s*\%)/g;function convert_percentages(t){let ee=t;return[...ee.matchAll(numbers_with_percentages_regex)].forEach(ne=>{const oe=ne[1];oe&&(ee=ee.replace(oe,"("+oe.replace(/\s*\%/," * 0.01")+")"))}),ee}const currency_symbol_string_map={"£":"CURRENCY_POUND",$:"CURRENCY_DOLLAR","€":"CURRENCY_EURO","¥":"CURRENCY_YUAN_TWO",Ұ:"CURRENCY_YUAN_ONE","₹":"CURRENCY_RUPEE_RX","₨":"CURRENCY_RUPEE_RS","¢":"CURRENCY_GHANA_CEDI","؋":"CURRENCY_AFGHANISTAN_AFGHANI","฿":"CURRENCY_THAILAND_BAHT","៛":"CURRENCY_CAMBODIA_RIEL","₡":"CURRENCY_COSTA_RICA_COLON","₦":"CURRENCY_NIGERIA_NAIRA","₩":"CURRENCY_KOREA_WON","₪":"CURRENCY_ISRAEL_SHEKEL","₫":"CURRENCY_VIET_NAM_DONG","₭":"CURRENCY_LAOS_KIP","₮":"CURRENCY_MONGOLIA_TUGHRIK","₱":"CURRENCY_PESO","₴":"CURRENCY_UKRAINE_HRYVNIA","₼":"CURRENCY_AZERBAIJAN_MANAT","₽":"CURRENCY_RUSSIA_RUBLE","﷼":"CURRENCY_RIAL","B/.":"CURRENCY_PANAMA_BALBOA",ƒ:"CURRENCY_GUILDER",Kč:"CURRENCY_CZECH_REPUBLIC_KORUNA","S/.":"CURRENCY_PERU_SOL",zł:"CURRENCY_POLAND_ZLOTY",ден:"CURRENCY_MACEDONIA_DENAR","Дин.":"CURRENCY_SERBIA_DINAR",лв:"CURRENCY_LEV_TENGE_SOM","₺":"CURRENCY_TURKEY_LIRA"};function hide_currency_symbols(t){let ee=t;return Object.entries(currency_symbol_string_map).forEach(([te,ne])=>{ee=ee.replaceAll(te,ne)}),ee}function unhide_currency_symbols(t){let ee=t;return Object.entries(currency_symbol_string_map).forEach(([te,ne])=>{ee=ee.replaceAll(new RegExp(ne,"ig"),te)}),ee}function apply_units_from_component(t,ee,te){t=t.trim();const ne=t.match(double_at_mentioned_uuids_regex);if(ne&&ne[0]===t){const oe=ne[0].slice(2),ie=te[oe];ee=ie==null?void 0:ie.units}return ee}function perform_calculations(t,ee){const te={};return t.map(oe=>{const ie=new Model({timeStart:2020,timeLength:1,timeUnits:"Years"}),se=get_double_at_mentioned_uuids_from_text(oe.value);let re=normalise_calculation_numbers(oe.value);re=convert_percentages(re),re=hide_currency_symbols(re);let _e=oe.units;_e=apply_units_from_component(re,_e,ee),_e=hide_currency_symbols(_e||""),re=normalise_calculation_ids(re,se);const ae={name:oe.name,value:re};_e!==void 0&&(ae.units=_e);const ce=ie.Variable(ae);prepare_other_components(ie,ce,te,se,ee);const le=run_model(ie,oe.units,ce);return te[oe.name]=le,le}).map(oe=>(oe.units=unhide_currency_symbols(oe.units),oe.error&&(oe.error=unhide_currency_symbols(oe.error)),oe))}function prepare_other_components(t,ee,te,ne,oe){const ie={};Object.entries(te).forEach(([re,_e])=>{if(_e.value!==void 0){const ae=t.Variable({name:re,value:_e.value,units:_e.units});ie[re]=ae}});const se=new Date().getTime();ne.forEach(re=>{const _e=oe[re];if(!_e)return;const ae=get_wcomponent_state_value_and_probabilities({wcomponent:_e,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:se,sim_ms:se}).most_probable_VAP_set_values;if(ae.length===0)return;const ce=ae[0].parsed_value;if(ce==null||typeof ce=="boolean")return;const le=t.Variable({name:re,value:ce,units:""});ie[re]=le}),Object.values(ie).forEach(re=>{t.Link(re,ee)})}function run_model(t,ee,te,ne=!1){let oe,ie="",se=te._node.getAttribute("Units");try{oe=t.simulate()._data.data[0][te._node.id]}catch(_e){const ae=_e,ce=typeof ae.message=="string"&&ae.message.startsWith("Wrong units generated for")&&ae.message.match(/and got (.+?)\.(?:$| Either)/);if(!ee&&ce&&!ne){se=ce[1],te.units=se;const le=run_model(t,ee,te,!0);({value:oe,units:se}=le),le.error&&(ie=le.error)}else ie=`${ae.message||"Unknown calculation error"}`}const re={value:oe,error:ie,units:se};return re.error||delete re.error,re.units==="Unitless"&&(re.units=""),re}function WarningTriangleV2(t){const{warning:ee,label:te="",always_display:ne=!1}=t;return o$1(Typography,{noWrap:!0,variant:"caption",title:ee,"aria-label":ee,style:{display:ee||ne?"inline":"none"},children:[o$1(default_1$g,{}),o$1("span",{style:{position:"relative",top:-7},children:te})]})}function format_number_to_significant_figures(t,ee){if(t===0)return"0";const te=Math.floor(Math.log10(Math.abs(t))),ne=te+1-ee,ie=(Math.round(t/Math.pow(10,ne))*Math.pow(10,ne)).toString();if(ne>=0)return ie;{const re=ie.indexOf(".")!==-1;let _e=ie+(re?"":".");const ae=(Math.abs(t)>=1?_e.length:_e.length+te)-1-(t<0?1:0);let ce=ee-ae;ce=Math.max(0,ce),_e+="0".repeat(ce);const le=ee+(te<0?-te:0)+1+(t<0?1:0);return _e=_e.slice(0,le),_e}}function str_enum(t){return t.reduce((ee,te)=>(ee[te]=te,ee),Object.create(null))}const NUMBER_DISPLAY_TYPES=str_enum(["bare","simple","scaled","percentage","abbreviated_scaled","scientific"]);function format_number_to_string(t,ee,te){let ne;if(ee=Math.round(ee),ee=ee<1?1:ee,te===NUMBER_DISPLAY_TYPES.bare)ne=round_to_max_significant_figures(t,ee).toString();else if(te===NUMBER_DISPLAY_TYPES.simple){const oe=round_to_max_significant_figures(t,ee);ne=Math.abs(oe)<1?oe.toString():oe.toLocaleString()}else if(te===NUMBER_DISPLAY_TYPES.scaled)ne=scale_number(t,ee);else if(te===NUMBER_DISPLAY_TYPES.percentage)ne=round_to_max_significant_figures(t*100,ee).toString()+"%";else if(te===NUMBER_DISPLAY_TYPES.abbreviated_scaled)ne=abbreviate_number(t,ee);else if(te===NUMBER_DISPLAY_TYPES.scientific){const oe=minimise_significant_figures(t,ee);ne=t.toExponential(oe-1)}else throw new Error(`Unimplemented display type ${te}`);return ne=ne.replace("e+","e").trim(),ne}function round_to_max_significant_figures(t,ee){if(t===0)return 0;const te=Math.pow(10,ee-Math.floor(Math.log10(Math.abs(t)))-1);return Math.round(t*te)/te}function scale_number(t,ee){const te=["","thousand","million","billion","trillion"];let ne=0;for(;Math.abs(t)>=1e3&&ne<te.length-1;)t/=1e3,ne++;const oe=minimise_significant_figures(t,ee);return format_number_to_significant_figures(t,oe)+" "+te[ne]}function abbreviate_number(t,ee){const te=["","k","m","bn","tn"];let ne=0;for(;Math.abs(t)>=1e3&&ne<te.length-1;)t/=1e3,ne++;const oe=minimise_significant_figures(t,ee);return format_number_to_significant_figures(t,oe)+" "+te[ne]}function minimise_significant_figures(t,ee){let te=ee;for(;te>1&&Number.parseFloat(t.toPrecision(te-1))===t;)--te;return te}function get_valid_calculation_name_id(t,ee=""){const te=ee.toUpperCase(),ne=get_disallowed_ids(t);if(ee&&!ne.has(te))return ee;let oe=name_id_string_to_num(ee||"A"),ie=num_to_name_id_string(oe);for(;ne.has(ie);)oe=increase_candidate_name_id_num(oe),ie=num_to_name_id_string(oe);return ee&&(ie=match_case(ie,ee)),ie}function get_disallowed_ids(t){return new Set([...SIMULATION_JS_RESERVED_WORDS,...t].map(te=>te.toUpperCase().replaceAll(/\s*/g,"")))}function name_id_string_to_num(t){return t=t.toUpperCase(),t.split("").map(ee=>ee.charCodeAt(0)).filter(ee=>ee>=65&&ee<=90)}function num_to_name_id_string(t){return t.map(ee=>String.fromCharCode(ee)).join("")}function increase_candidate_name_id_num(t){let ee=!1;for(let te=t.length-1;te>=0;--te)if(t[te]=t[te]+1,t[te]>90)t[te]=65,ee=!0;else{ee=!1;break}return ee&&t.push(65),t}function match_case(t,ee){return t.split("").map((te,ne)=>{const oe=ee.charCodeAt(ne);return oe>=97&&oe<=122&&(te=te.toLowerCase()),te}).join("")}function make_calculation_safe_for_rich_text(t){return t.replaceAll("*","\\*")}const d$3="M19 5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 14h-14v-5h14z m0 -12v5h-14v-5h1v-2h12v2z m-3 -2h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function AddRowAbove(t){return o$1(CommonIcon,{...t,d:d$3})}const d$2="M19 2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 7h-14v-5h14z m0 7h-1v2h-12v-2h-1v-5h14z m-3 0h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function AddRowBelow(t){return o$1(CommonIcon,{...t,d:d$2})}function EditableCalculationRowOptions(t){const[ee,te]=h$1(!1);return o$1(k$1,{children:[o$1(Tooltip,{title:"Add above",children:o$1(IconButton,{onClick:()=>t.update_calculations("add_above"),size:"large",children:o$1(AddRowAbove,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),o$1(Tooltip,{title:"Add below",children:o$1(IconButton,{onClick:()=>t.update_calculations("add_below"),size:"large",children:o$1(AddRowBelow,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),o$1(Tooltip,{title:"Move up",children:o$1(IconButton,{onClick:()=>t.update_calculations("move_up"),size:"large",disabled:t.disallowed_commands.has("move_up"),children:o$1(ArrowUpward$1,{})})}),o$1(Tooltip,{title:"Move down",children:o$1(IconButton,{onClick:()=>t.update_calculations("move_down"),size:"large",disabled:t.disallowed_commands.has("move_down"),children:o$1(ArrowDownward$1,{})})}),!ee&&o$1(IconButton,{onClick:()=>te(!0),size:"large",children:o$1(DeleteIcon,{})}),ee&&o$1(ConfirmatoryButton,{on_click:t.delete_calculation,button_text:"",button_icon:o$1(DeleteIcon,{}),ready_to_progress:!0,on_cancel:()=>te(!1)})]})}function EditableCalculationRowResultsFormatting(t){const{result:ee,default_significant_figures:te,temp_result_sig_figs:ne,set_temp_result_sig_figs:oe,result_display_type:ie,update_calculation:se}=t,re=get_number_display_options(ee,ne??te);return o$1("div",{style:{display:"flex"},children:[o$1("div",{"data-tooltip":"Significant figures","data-tooltip_left_-10":!0,"data-tooltip_bottom_-60":!0,children:o$1(EditableNumber,{size:"small",style:{marginLeft:5,marginTop:5,width:"80px"},placeholder:"Sig. figs",value:ne,allow_undefined:!0,conditional_on_change:_e=>{_e=sanitise_significant_figures_value(_e),oe(_e)},on_blur_type:EditableTextOnBlurType.always,on_blur:_e=>{_e=sanitise_significant_figures_value(_e),oe(_e??te),se({result_sig_figs:_e})}})}),o$1("div",{"data-tooltip":"Display type","data-tooltip_left_0":!0,"data-tooltip_bottom_-60":!0,style:{marginLeft:"10px",width:"120px"},children:[o$1("div",{className:"description_label",children:"Format"}),o$1(AutocompleteText,{selected_option_id:ie,options:re,retain_options_order:!0,on_change:_e=>{const ae=re.find(le=>le.id===_e),ce=ae==null?void 0:ae.result_display_type;se({result_display_type:ce})}})]})]})}function sanitise_significant_figures_value(t){if(t!==void 0)return Math.max(Math.round(t),0)}function get_number_display_options(t,ee){t=t??1000.23;const te={bare:{id:"bare",order:0,result_display_type:"bare",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.bare)},simple:{id:"simple",order:1,result_display_type:"simple",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.simple)},scaled:{id:"scaled",order:2,result_display_type:"scaled",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.scaled)},percentage:{id:"percentage",order:4,result_display_type:"percentage",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.percentage)},abbreviated_scaled:{id:"abbreviated_scaled",order:3,result_display_type:"abbreviated_scaled",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.abbreviated_scaled)},scientific:{id:"scientific",order:5,result_display_type:"scientific",title:format_number_to_string(t,ee,NUMBER_DISPLAY_TYPES.scientific)}},ne={...te};return te.abbreviated_scaled.title===te.scaled.title&&delete ne.abbreviated_scaled,te.scaled.title===te.simple.title&&delete ne.scaled,te.simple.title===te.bare.title&&delete ne.simple,Object.values(ne).sort((ie,se)=>ie.order-se.order)}const DEFAULT_SIGNIFICANT_FIGURES=2;function get_default_significant_figures(t){const ee=parseInt(t,10);return number_value_is_year(ee)?4:DEFAULT_SIGNIFICANT_FIGURES}function get_default_result_display_type(t){const ee=parseInt(t,10);return number_value_is_year(ee)?NUMBER_DISPLAY_TYPES.bare:t.trim().match(/\d+\.?\d*\s*\%/)?NUMBER_DISPLAY_TYPES.percentage:NUMBER_DISPLAY_TYPES.simple}function number_value_is_year(t){return Number.isSafeInteger(t)&&t>=1900&&t<=2200}function EditableCalculationRow(t){const{calculation:ee,calculation_result:te,editing:ne,existing_calculation_name_ids:oe,show_options:ie,set_show_options:se}=t,re=get_default_significant_figures(ee.value),{result_sig_figs:_e=re}=ee,[ae,ce]=h$1(_e),le=get_default_result_display_type(ee.value),{result_display_type:ue=le}=ee;if(!ne&&!ee.value&&!ee.units)return null;let de=o$1("div",{});if(te!==void 0&&te.value!==void 0){const fe=format_number_to_string(te.value,ae??re,ue);de=o$1("div",{children:[" = ",fe,te.units&&o$1("span",{style:{fontSize:"14px"},children:[" ",te.units]}),ee.result_description&&o$1("span",{style:{fontSize:"14px"},children:[" ",o$1(RichMarkDown,{text:ee.result_description})]})]})}const me=ne||should_show_calc_value(ee.value),pe={width:"100%",display:"flex"};return o$1(Box,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",marginBottom:ne?"18px":void 0,flexDirection:ne?"column":"row",style:{display:"flex"},className:"form_section "+(ie?"":"hidden_border"),children:[o$1("div",{style:{...pe,maxHeight:te!=null&&te.error?100:0,transition:"max-height 1s ease 0s"},children:o$1(WarningTriangleV2,{warning:(te==null?void 0:te.error)||"",always_display:!0})}),o$1("div",{style:{width:"100%",display:"flex"},children:[o$1(EditableTextSingleLine,{size:"small",placeholder:"",hide_label:!0,value:ee.name,on_blur:fe=>{const ge=oe.filter(be=>be!==ee.name),he=get_valid_calculation_name_id(ge,fe);t.update_calculation({...ee,name:he})},on_blur_type:EditableTextOnBlurType.conditional}),me&&o$1(k$1,{children:[" = ",o$1(EditableTextSingleLine,{placeholder:"Calculation",hide_label:!0,value:ne?ee.value:make_calculation_safe_for_rich_text(ee.value),on_blur:fe=>t.update_calculation({...ee,value:fe}),on_blur_type:EditableTextOnBlurType.conditional})," "]}),ne&&o$1(EditableTextSingleLine,{placeholder:"Units",hide_label:!0,value:ee.units||"",on_blur:fe=>t.update_calculation({...ee,units:fe||void 0}),on_blur_type:EditableTextOnBlurType.conditional}),!ne&&de]}),ne&&o$1("div",{style:{...pe,marginTop:void 0},children:[de,o$1(IconButton,{onClick:()=>se(!ie),size:"small",style:{marginLeft:"auto"},children:o$1(SettingsIcon,{})})]}),t.editing&&ie&&o$1(EditableCalculationRowResultsFormatting,{result:te==null?void 0:te.value,default_significant_figures:re,temp_result_sig_figs:ae,set_temp_result_sig_figs:ce,result_display_type:ue,update_calculation:fe=>{t.update_calculation({...ee,...fe})}}),t.editing&&ie&&o$1("div",{style:{...pe,marginLeft:10,marginTop:20},children:o$1("div",{style:{display:"flex"},children:o$1(EditableTextSingleLine,{size:"small",placeholder:"Description",value:ee.result_description||"",on_blur_type:EditableTextOnBlurType.conditional,on_blur:fe=>{const ge=fe||void 0;t.update_calculation({...ee,result_description:ge})}})})}),t.editing&&ie&&o$1("div",{style:{...pe,justifyContent:"flex-end"},children:o$1(EditableCalculationRowOptions,{delete_calculation:()=>t.update_calculation(null),disallowed_commands:t.disallowed_commands,update_calculations:t.update_calculations})})]})}const CALULATION_SIGNS=/.*[\^*\/+\-()].*/g;function should_show_calc_value(t){return t=t.replaceAll(double_at_mentioned_uuids_regex,""),!!t.match(CALULATION_SIGNS)}const map_state$y=t=>({editing:!t.display_options.consumption_formatting,wcomponents_by_id:t.derived.composed_wcomponents_by_id}),map_dispatch$n={},connector$y=connect(map_state$y,map_dispatch$n);function _WComponentCalculatonsForm(t){const{wcomponent:ee,wcomponents_by_id:te}=t,{calculations:ne=[]}=ee;ne.forEach((le,ue)=>le.id=le.id??ue);const[oe,ie]=h$1(ne.length>0),se={};ne.forEach(le=>se[le.id]=!1);const[re,_e]=h$1(se),ae=perform_calculations(ne,te),ce=ne.map(({name:le})=>le);return o$1("div",{className:"editable_list_entry padded "+(oe?"expanded":""),children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>ie(!oe),children:[o$1("div",{className:"summary",children:[o$1("h4",{style:{display:"inline-block"},children:["Calculations ",!oe&&ne.length?`(${ne.length})`:""]}),o$1("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:o$1(WarningTriangleV2,{warning:"",label:""})})]}),o$1("div",{className:"expansion_button"})]}),oe&&o$1("div",{children:[o$1(Box,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:ne.map((le,ue)=>o$1(EditableCalculationRow,{editing:t.editing,show_options:re[le.id]||!1,set_show_options:de=>{const me={...re,[le.id]:de};_e(me)},calculation:le,calculation_result:ae[ue],existing_calculation_name_ids:ce,update_calculation:de=>{const pe=[...ne.slice(0,ue),de,...ne.slice(ue+1)].filter(ge=>!!ge),fe=pe.length?pe:void 0;t.upsert_wcomponent({calculations:fe})},disallowed_commands:(()=>{const de=new Set;return ue===0&&de.add("move_up"),ue===ne.length-1&&de.add("move_down"),de})(),update_calculations:de=>{if(de==="move_up"){const me=ue-1;if(!index_is_in_bounds(ne,me))return;const pe=swap_elements(ne,ue,me);t.upsert_wcomponent({calculations:pe})}else if(de==="move_down"){const me=ue+1;if(!index_is_in_bounds(ne,me))return;const pe=swap_elements(ne,ue,me);t.upsert_wcomponent({calculations:pe})}else if(de==="add_above"){const me=prepare_new_calculation(ne),pe=insert_element_at_index(ne,me,ue);t.upsert_wcomponent({calculations:pe})}else if(de==="add_below"){const me=prepare_new_calculation(ne),pe=insert_element_at_index(ne,me,ue+1);t.upsert_wcomponent({calculations:pe})}}},le.id))}),t.editing&&o$1(Button,{value:"Add calculation",fullWidth:!0,onClick:()=>{const le=prepare_new_calculation(ne),ue=[...ne,le];t.upsert_wcomponent({calculations:ue})}})]})]})}const WComponentCalculatonsForm=connector$y(_WComponentCalculatonsForm);function prepare_new_calculation(t){let ee=-1;t.forEach(oe=>ee=Math.max(ee,oe.id)),++ee;const te=get_valid_calculation_name_id(t.map(({name:oe})=>oe));return{id:ee,name:te,value:""}}function get_value_possibilities_by_value(t,ee){const te={};return Object.values(t||{}).forEach(ne=>{const oe=ee?ne.value.toLowerCase():ne.value;te[oe]=ne}),te}function update_VAPSets_with_possibilities(t,ee){if(t===void 0)return;const te=ee||{},ne=get_value_possibilities_by_value(te,!1);return t.map(oe=>({...oe,entries:oe.entries.map(ie=>{let{value_id:se,value:re,description:_e}=ie,ae=te[se||""];return ae||(se=void 0,ae=ne[ie.value]),ae&&(se=ae.id,re=ae.value,_e=ae.description),{...ie,value_id:se,value:re,description:_e}})}))}const test_update_VAPSets_with_possibilities=describe("update_VAPSets_with_possibilities",()=>{var re,_e,ae,ce,le,ue,de,me,pe,fe,ge,he,be,ve,ye,we,ke,Ae,$e,xe,Ce,Se,Ie,Pe;const t="val_prob_id_123",ee="val_prob_id_456",te="value abc",ne="value def456",oe={[t]:{id:t,value:te,description:"description abc",order:0},[ee]:{id:ee,value:ne,description:"description def456",order:1}},ie=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...prepare_new_VAP(),value_id:t,value:"old abc value",description:"old abc description"},{...prepare_new_VAP(),value_id:"defunct_id",value:te,description:"old abc description"},{...prepare_new_VAP(),value_id:ee,value:te,description:""}]}];let se=update_VAPSets_with_possibilities(void 0,void 0);test(se,void 0,"Undefined initial VAPs returns undefined"),se=update_VAPSets_with_possibilities(void 0,oe),test(se,void 0,"Undefined initial VAPs returns undefined"),se=update_VAPSets_with_possibilities([],oe),test(se,[],"Empty initial VAPs returns empty"),se=update_VAPSets_with_possibilities(ie,void 0),test(se==null?void 0:se.length,ie.length,"Undefined value_possibilities returns all VAPs"),se&&(test((_e=(re=se[0])==null?void 0:re.entries[0])==null?void 0:_e.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),test((ce=(ae=se[0])==null?void 0:ae.entries[1])==null?void 0:ce.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),test((ue=(le=se[0])==null?void 0:le.entries[2])==null?void 0:ue.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids")),console.log("Updates VAPs in VAP Set with value_possibilities ..."),se=update_VAPSets_with_possibilities(ie,oe),test(Array.isArray(se),!0,"Returns an array"),se&&(test((me=(de=se[0])==null?void 0:de.entries[0])==null?void 0:me.value,(pe=oe[t])==null?void 0:pe.value,"Updates value"),test((ge=(fe=se[0])==null?void 0:fe.entries[0])==null?void 0:ge.description,(he=oe[t])==null?void 0:he.description,"Updates description"),test((ve=(be=se[0])==null?void 0:be.entries[1])==null?void 0:ve.value_id,t,"Updates id based on matched value"),test((we=(ye=se[0])==null?void 0:ye.entries[1])==null?void 0:we.description,(ke=oe[t])==null?void 0:ke.description,"Updates description based on matched value/id"),test(($e=(Ae=se[0])==null?void 0:Ae.entries[2])==null?void 0:$e.value_id,ee,"Does not update id based on matched value if ID valid"),test((Ce=(xe=se[0])==null?void 0:xe.entries[2])==null?void 0:Ce.value,ne,"Updates value"),test((Ie=(Se=se[0])==null?void 0:Se.entries[2])==null?void 0:Ie.description,(Pe=oe[ee])==null?void 0:Pe.description,"Updates description"))},!1);function ValuePossibilityComponent(t){const{editing:ee,value_possibility:te,count_of_value_possibilities:ne,update_value_possibility:oe}=t,[ie,se]=h$1(te.value);p$1(()=>se(te.value),[te.value]);const _e=(ne[ie.toLowerCase()]||0)>1?`Current value "${ie}" is already present in other possible values.`:"";return o$1(Box,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",style:{display:"flex"},children:[o$1(Box,{style:{width:"100%"},children:[o$1(WarningTriangleV2,{warning:_e,label:"Duplicate"}),o$1(Typography,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:o$1(EditableTextSingleLine,{placeholder:"Possible value",hide_label:!0,value:te.value,conditional_on_change:ae=>se(ae),on_blur:ae=>{oe({...te,value:ae})},on_blur_type:EditableTextOnBlurType.conditional})})]}),VALUE_POSSIBILITY_IDS_to_text[te.id]&&o$1(Box,{style:{width:100,color:"#cb4",cursor:"pointer"},title:"Using interoperable ID",children:VALUE_POSSIBILITY_IDS_to_text[te.id]}),ee&&o$1(IconButton,{onClick:()=>oe(void 0),size:"large",children:o$1(default_1$a,{})})]},t.value_possibility.id)}function prepare_new_value_possibility(t){const ee=get_max_value_possibilities_order(t);return{id:v4(),value:"",description:"",order:ee+1}}function WComponentValuePossibilitiesForm(t){const[ee,te]=h$1(!1);if(t.VAPs_represent===VAPsType.undefined)return null;const ne=value_possibilities_as_list(t.value_possibilities),{count_of_value_possibilities:oe,max_count:ie}=get_count_of_value_possibilities(ne),se=ie>1?"Duplicate value possibilities present":"",re=`editable_list_entry padded ${ee?"expanded":""}`,{attribute_wcomponent:_e}=t;return o$1("div",{className:re,children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>te(!ee),children:[o$1("div",{className:"summary",children:[o$1("h4",{style:{display:"inline-block"},children:["Possible Values ",!ee&&ne.length?`(${ne.length})`:""]}),o$1("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:o$1(WarningTriangleV2,{warning:se,label:""})})]}),o$1("div",{className:"expansion_button"})]}),ee&&o$1("div",{children:[o$1(Box,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:ne.map(ae=>o$1(ValuePossibilityComponent,{editing:t.editing,value_possibility:ae,count_of_value_possibilities:oe,update_value_possibility:ce=>{const le={...t.value_possibilities};ce?le[ce.id]=ce:delete le[ae.id];const ue=Object.keys(le).length>0;t.update_value_possibilities(ue?le:void 0)}}))}),t.editing&&o$1(Button,{value:"New possibility",fullWidth:!0,onClick:()=>{const ae=prepare_new_value_possibility(t.value_possibilities),ce={...t.value_possibilities,[ae.id]:ae};t.update_value_possibilities(ce)}}),t.editing&&o$1(Button,{value:"Use defaults",fullWidth:!0,onClick:()=>{const ae=get_possibilities_from_VAP_sets(t.VAPs_represent,void 0,t.values_and_prediction_sets),ce=get_items_by_id(ae,"default_possible_values");t.update_value_possibilities(ce)}}),t.editing&&_e&&wcomponent_is_statev2(_e)&&o$1(Button,{value:"Use attribute's possibilities",fullWidth:!0,onClick:()=>{const ae=get_possibilities_from_VAP_sets(t.VAPs_represent,_e.value_possibilities,_e.values_and_prediction_sets||[]),ce=get_items_by_id(ae,"attribute's possible_values");t.update_value_possibilities(ce)}})]})]})}function get_count_of_value_possibilities(t){const ee={};let te=0;return t.forEach(({value:ne})=>{ne=ne.toLowerCase();const oe=(ee[ne]||0)+1;ee[ne]=oe,te=Math.max(te,oe)}),{count_of_value_possibilities:ee,max_count:te}}function value_possibilities_as_list(t){return Object.values(t||{}).sort((ee,te)=>ee.order<te.order?-1:1)}const map_state$x=(t,ee)=>({created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,creation_context:t.creation_context,editing:ee.editing_allowed??!t.display_options.consumption_formatting,current_created_at_ms:t.routing.args.created_at_ms}),map_dispatch$m={change_route:ACTIONS.routing.change_route},connector$x=connect(map_state$x,map_dispatch$m);function _EasyActionValueAndPredictionSets(t){var Ae;const{existing_value_possibilities:ee,values_and_prediction_sets:te,VAPs_represent:ne,base_id:oe,editing:ie,current_created_at_ms:se,sim_ms:re,creation_context:_e,update_VAPSets_and_value_possibilities:ae,change_route:ce}=t;if(!ie||ne!==VAPsType.action)return null;const{latest:le}=group_versions_by_id(te),de=sort_by_uncertain_event_datetimes(le)[0],me=(Ae=de==null?void 0:de.entries.find($e=>$e.probability===1))==null?void 0:Ae.value_id,pe=me===ACTION_VALUE_POSSIBILITY_ID.action_potential,fe=me===ACTION_VALUE_POSSIBILITY_ID.action_paused,ge=me===ACTION_VALUE_POSSIBILITY_ID.action_in_progress,he=me===ACTION_VALUE_POSSIBILITY_ID.action_completed,be=!de||pe||fe,ve=he,ye=ge,we=!de||ge;function ke($e){const xe=set_action_VAP_set_state({existing_value_possibilities:ee,orig_values_and_prediction_sets:te,base_id:oe,creation_context:_e,action_value_possibility_id:$e});handle_update_VAP_sets({existing_value_possibilities:ee,new_values_and_prediction_sets:xe,orig_values_and_prediction_sets:te,current_created_at_ms:se,sim_ms:re,update_VAPSets_and_value_possibilities:ae,change_route:ce})}return o$1("div",{children:[(be||ve)&&o$1(Button,{value:ve?"Restart (In Progress)":"In Progress",fullWidth:!0,color:"secondary",onClick:()=>ke(ACTION_VALUE_POSSIBILITY_ID.action_in_progress)}),ye&&o$1(Button,{value:"Pause",fullWidth:!0,color:"secondary",onClick:()=>ke(ACTION_VALUE_POSSIBILITY_ID.action_paused)}),we&&o$1(Button,{value:"Completed",fullWidth:!0,color:"secondary",onClick:()=>ke(ACTION_VALUE_POSSIBILITY_ID.action_completed)})]})}const EasyActionValueAndPredictionSets=connector$x(_EasyActionValueAndPredictionSets);function get_probable_VAP_set_values_for_display(t,ee){const te=get_VAPs_ordered_by_prob(t.entries,ee),ne=te[0];return ee===VAPsType.boolean&&ne?ne.probability>.5?"True":"False":te.filter(({probability:ie})=>ie>0).map(ie=>ie.value).join(", ")||"-"}function get_VAP_set_probable_percentages_for_display(t,ee){const te=get_VAPs_ordered_by_prob(t.entries,ee),ne=te[0];return ee===VAPsType.boolean&&ne?ratio_to_percentage_string(ne.probability):te.filter(({probability:ie})=>ie>0).map(ie=>ratio_to_percentage_string(ie.probability)).join(", ")}function get_VAP_set_conviction(t,ee){const te=get_VAPs_ordered_by_prob(t.entries,ee),ne=te[0];if(ee===VAPsType.boolean&&ne)return ratio_to_percentage_string(ne.conviction);const oe=te.filter(({probability:re})=>re>0),ie=new Set;oe.forEach(({conviction:re})=>ie.add(re));const se=ie.size<=1;return oe.slice(0,se?1:void 0).map(re=>ratio_to_percentage_string(re.conviction)).join(", ")}const ValueAndPredictions$1="";var LinkOff={},_interopRequireDefault$9=interopRequireDefaultExports;Object.defineProperty(LinkOff,"__esModule",{value:!0});var default_1$9=LinkOff.default=void 0,_createSvgIcon$9=_interopRequireDefault$9(requireCreateSvgIcon()),_jsxRuntime$9=requireJsxRuntime(),_default$9=(0,_createSvgIcon$9.default)((0,_jsxRuntime$9.jsx)("path",{d:"M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5zm-1 4h-2.19l2 2H16zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3 2 4.27z"}),"LinkOff");default_1$9=LinkOff.default=_default$9;const ValuePossibilityLink$1="",d$1="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM19 12h-2v3h-3v2h3v3h2v-3h3v-2h-3z";function AddLinkIcon(t){return o$1(CommonIcon,{...t,d:d$1})}const d="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1z M16 18.17 14.33 16.5l-1.42 1.41L16 21 21.0 15.8l-1.41-1.41z";function LinkWorkingIcon(t){return o$1(CommonIcon,{...t,d})}function ValuePossibilityLink(t){const{editing:ee,VAP:te,value_possibilities:ne,update_VAP:oe}=t,ie=F$1(()=>get_value_possibilities_by_value(t.value_possibilities,!0),[t.value_possibilities]);if(ne===void 0)return o$1("span",{title:"Need to first add value possibilities to link to.",className:"possible_value_link disabled",children:o$1(default_1$9,{})});if(!!ne[te.value_id||""])return o$1("span",{title:"Linked to possible value.  Click to unlink.",className:"possible_value_link "+(ee?"clickable":"disabled"),onClick:()=>{const _e={...te};delete _e.value_id,oe(_e)},children:[o$1(LinkWorkingIcon,{className:"hide_on_hover"}),o$1(default_1$9,{className:"show_on_hover"})]});const re=ie[te.value.toLowerCase()];return re?o$1("span",{title:"Linkable to value possibility.  Click to link.",className:"possible_value_link "+(ee?"clickable":"disabled"),onClick:()=>{const ae=ne[re.id].description||te.description,ce={...te,value_id:re.id,description:ae};oe(ce)},children:o$1(AddLinkIcon,{})}):o$1("span",{title:"No matching value possibility to link to.",className:"possible_value_link disabled",children:o$1(default_1$9,{})})}const map_state$w=t=>({editing:!t.display_options.consumption_formatting}),connector$w=connect(map_state$w);function _ValueAndPredictions(t){const{editing:ee,value_possibilities:te,VAPs_represent:ne}=t,oe=t.values_and_predictions,ie=ne===VAPsType.boolean&&oe.length>=1?"only_one_VAP":"",se=ne===VAPsType.number,re={get_summary:get_summary({value_possibilities:te,VAPs_represent:ne,editing:ee}),get_details:get_details(ne,ee),extra_class_names:"value_and_prediction",crud:{update_item:ae=>{const ce=get_id$1(ae),le=replace_element(oe,ae,ue=>get_id$1(ue)===ce);t.update_values_and_predictions(le)},delete_item:ae=>{const ce=get_id$1(ae),le=remove_element(oe,ue=>get_id$1(ue)===ce);t.update_values_and_predictions(le)}},delete_button_text:"Delete Value & Prediction",hide_expansion_button:ae=>!ee&&!ae.description&&!ae.source&&(!se||!ae.min&&!ae.max),calc_initial_custom_expansion_state:ae=>!!(ae.description||ae.source||se&&(ae.min||ae.max))},_e="Value and prediction";return o$1("div",{className:`value_and_predictions ${ie}`,children:[o$1(ListHeader,{items_descriptor:get_items_descriptor(_e,oe.length),other_content:()=>!ee||ne===VAPsType.boolean?null:o$1(ListHeaderAddButton,{new_item_descriptor:_e,on_pointer_down_new_list_entry:()=>{const ae=[...oe,prepare_new_VAP()];t.update_values_and_predictions(ae)}})}),factory_render_list_content({items:oe,get_id:get_id$1,item_props:re,debug_item_descriptor:_e})({expanded_item_rows:!1,expanded_items:!0,disable_partial_collapsed:!1})]})}const ValueAndPredictions=connector$w(_ValueAndPredictions),get_id$1=t=>t.id,get_summary=t=>(ee,te,ne)=>{const{value_possibilities:oe,VAPs_represent:ie,editing:se}=t,{probability:re,relative_probability:_e,conviction:ae,min:ce,value:le,max:ue}=ee,de=ie===VAPsType.boolean,me=ie===VAPsType.number,pe=_e!==void 0,fe=pe&&!de,ge=!pe||de;return o$1("div",{className:"value_and_prediction_summary",children:[o$1("br",{}),o$1("div",{className:"temporal_uncertainty",children:[me&&(se&&ne||ce)&&o$1("div",{children:[o$1(InvalidNumberWarning,{value:ce}),o$1(EditableTextSingleLine,{placeholder:"Min",value:ce||"",modify_value_pre_on_blur:he=>he.trim(),on_blur:he=>te.update_item({...ee,min:he}),on_blur_type:EditableTextOnBlurType.conditional}),o$1("br",{})]},"min"),(se||le)&&o$1("div",{style:{position:"relative"},children:[me&&o$1(InvalidNumberWarning,{value:le}),o$1(EditableTextSingleLine,{disabled:de,placeholder:"Value",value:de?re>.5?"True":"False":le,modify_value_pre_on_blur:he=>he.trim(),on_blur:he=>te.update_item({...ee,value:he}),on_blur_type:EditableTextOnBlurType.conditional}),!me&&!de&&o$1("div",{style:{position:"absolute",right:"-25px",top:"15px"},children:o$1(ValuePossibilityLink,{editing:se,VAP:ee,value_possibilities:oe,update_VAP:he=>te.update_item(he)})}),o$1("br",{})]},"value"),me&&(se&&ne||ue)&&o$1("div",{children:[o$1(InvalidNumberWarning,{value:ue}),o$1(EditableTextSingleLine,{placeholder:"Max",value:ue||"",modify_value_pre_on_blur:he=>he.trim(),on_blur:he=>te.update_item({...ee,max:he}),on_blur_type:EditableTextOnBlurType.conditional}),o$1("br",{})]},"max")]}),o$1("div",{className:"predictions",children:[de&&o$1("div",{className:fe?"disabled":"",children:o$1(EditablePercentage,{disabled:fe,placeholder:"Probability",value:re,on_blur:he=>{te.update_item({...ee,probability:he})},on_blur_type:EditableTextOnBlurType.conditional})}),de&&o$1("div",{children:o$1(EditablePercentage,{placeholder:"Confidence",value:ae,on_blur:he=>te.update_item({...ee,conviction:he}),on_blur_type:EditableTextOnBlurType.conditional})}),!de&&_e!==void 0&&o$1("div",{className:ge?"disabled":"",children:o$1(EditableNumber,{disabled:ge,placeholder:"Relative probability",size:"medium",value:de?void 0:_e,allow_undefined:!0,on_blur:he=>{he=de?void 0:he||0,te.update_item({...ee,relative_probability:he})},on_blur_type:EditableTextOnBlurType.conditional})}),"  ",o$1(PredictionBadge,{disabled:!0,size:20,probability:re,conviction:ae})]})]})},get_details=(t,ee)=>(te,ne)=>t===VAPsType.boolean?o$1("div",{children:[o$1("div",{className:"description_label",children:"Description"}),"Boolean value of this state, i.e. either true (100%), false (0%) or somewhere in between."]}):!ee&&!te.description&&!te.source?o$1(k$1,{}):o$1("div",{children:[(ee||te.description)&&o$1(EditableText,{placeholder:"Description",value:te.description,on_blur:oe=>ne.update_item({...te,description:oe.trim()}),on_blur_type:EditableTextOnBlurType.conditional}),ee&&o$1("br",{}),(ee||te.source)&&o$1(EditableTextSingleLine,{placeholder:"Source",size:"small",value:te.source||"",on_blur:oe=>ne.update_item({...te,source:oe?oe.trim():void 0}),on_blur_type:EditableTextOnBlurType.conditional}),ee&&o$1("br",{})]});function InvalidNumberWarning(t){const ee=is_string_valid_number(t.value||"");return o$1("div",{style:{maxHeight:ee?0:100,overflow:"hidden",transition:"max-height 1s ease 0s"},children:o$1(WarningTriangleV2,{warning:"Number is invalid"})})}const get_summary_for_single_VAP_set=(t,ee)=>(te,ne)=>{let oe=get_VAPs_from_set(te,t);te={...te,entries:oe};const ie=get_probable_VAP_set_values_for_display(te,t),se=get_VAP_set_probable_percentages_for_display(te,t)+"%",re=get_VAP_set_conviction(te,t)+"%";return o$1(PredictionSummary,{created_at:ee?te.custom_created_at||te.created_at:void 0,value:ie,datetime:te.datetime,probability:se,conviction:re})},get_details_for_single_VAP_set=(t,ee)=>(te,ne)=>{const oe=get_VAPs_from_set(te,ee);return o$1("div",{className:"VAP_set_details",children:[o$1("br",{}),o$1(UncertainDateTimeForm,{datetime:te.datetime,on_change:ie=>ne.update_item({...te,datetime:ie})}),o$1("div",{children:[o$1("br",{}),o$1(ValueAndPredictions,{value_possibilities:t,VAPs_represent:ee,values_and_predictions:oe,update_values_and_predictions:ie=>{const se=merge_entries(ie,te,ee),re=set_VAP_probabilities(se,ee),_e={...te,entries:re};ne.update_item(_e)}}),o$1("br",{})]}),o$1("br",{})]})},get_details2_for_single_VAP_set=(t,ee)=>(te,ne)=>{const oe=te.shared_entry_values||{},ie=te.entries.map(({explanation:ce})=>ce.trim()).filter(ce=>ce).join(`

`),se=oe.explanation||ie||"",re=oe.conviction||1,_e=t!==VAPsType.boolean,ae=!!(ee||se);return o$1("div",{className:"shared_VAP_set_details",children:[_e&&o$1("div",{children:o$1(EditablePercentage,{disabled:!1,placeholder:"Confidence",value:re,on_blur:ce=>{const le={...te.shared_entry_values,conviction:ce},ue=te.entries.map(de=>({...de,conviction:ce}));ne.update_item({...te,entries:ue,shared_entry_values:le})},on_blur_type:EditableTextOnBlurType.conditional})}),ae&&o$1(EditableText,{placeholder:"Explanation",value:se,on_blur:ce=>{const le={...te.shared_entry_values,explanation:ce};ne.update_item({...te,shared_entry_values:le})},on_blur_type:EditableTextOnBlurType.conditional}),o$1("br",{})]})};function get_VAPs_from_set(t,ee){let te=t.entries;return ee===VAPsType.boolean&&te.length!==1&&(te=te.slice(0,1)),te}function merge_entries(t,ee,te){return te===VAPsType.boolean&&(t=t.concat(ee.entries.slice(1))),t}function SimplifiedUncertainDatetimeForm(t){const{VAP_set:ee,on_change:te}=t;if(!ee.entries[0])return null;const oe=get_uncertain_datetime(ee.datetime),ie=oe===void 0;return o$1("div",{children:[oe?date2str_auto({date:oe,time_resolution:void 0}):"Is Eternal",o$1("br",{}),ie&&o$1(Button,{value:"Set to 'From today'",onClick:()=>te({...ee,datetime:{value:get_today_date()}})}),!ie&&o$1(Button,{value:"Set to Eternal",onClick:()=>te({...ee,datetime:{}})}),o$1("br",{}),o$1("br",{})]})}const new_value_and_prediction_set__jsx_factory=(t,ee)=>{const te=Object.keys(ee||{}).length>0,ne=t===VAPsType.other&&te,oe=t===VAPsType.boolean||t===VAPsType.action||ne,[ie,se]=h$1(!oe);return(re,_e)=>{const{update_item:ae}=_e;return o$1("div",{children:[!ie&&t===VAPsType.boolean&&o$1(SimplifiedBooleanForm,{VAP_set:re,on_change:ae}),!ie&&t===VAPsType.action&&o$1(SimplifiedActionForm,{possible_value_possibilities:ee,VAP_set:re,on_change:ae}),!ie&&ne&&o$1(SimplifiedOtherForm,{possible_value_possibilities:ee,VAP_set:re,on_change:ae}),!ie&&o$1("div",{children:[o$1("span",{className:"description_label",children:"Datetime"}),o$1(SimplifiedUncertainDatetimeForm,{VAP_set:re,on_change:ae})]}),o$1(Button,{value:(ie?"Hide":"Show")+" advanced options",onClick:()=>se(!ie)}),ie&&o$1("div",{children:[o$1("br",{}),o$1("br",{}),o$1("hr",{}),get_summary_for_single_VAP_set(t,!1)(re,_e),get_details_for_single_VAP_set(ee,t)(re,_e),get_details2_for_single_VAP_set(t,!0)(re,_e)]})]})}};function SimplifiedBooleanForm(t){const{VAP_set:ee,on_change:te}=t,ne=ee.entries[0];if(!ne)return null;const oe=!!ne&&ne.probability===1&&ne.conviction===1,ie=!!ne&&ne.probability===0&&ne.conviction===1;return o$1("div",{children:[oe&&"True",ie&&"False",o$1("br",{}),!oe&&o$1(Button,{value:"Set to True",onClick:()=>{te({...ee,entries:[{...ne,probability:1,conviction:1}]})}}),!ie&&o$1(Button,{value:"Set to False",onClick:()=>{te({...ee,entries:[{...ne,probability:0,conviction:1}]})}}),o$1("br",{}),o$1("br",{})]})}function SimplifiedActionForm(t){return o$1(SimplifiedFormHeader,{...t,title:"Set action status to:"})}function SimplifiedOtherForm(t){return o$1(SimplifiedFormHeader,{...t,title:"Set value to:"})}function SimplifiedFormHeader(t){const{title:ee,possible_value_possibilities:te,VAP_set:ne,on_change:oe}=t,ie=get_VAP_set_certain_selected_value_id(ne),se=value_possibility_options(te);return o$1("div",{children:[ee,o$1(AutocompleteText,{selected_option_id:ie,options:se,allow_none:!0,on_change:re=>{if(!re)return;const _e=update_VAP_set_VAP_probabilities(ne,re);oe({...ne,entries:_e})}}),o$1("br",{}),o$1("br",{})]})}function value_possibility_options(t){return t===void 0?[]:Object.values(t).map(({id:ee,value:te})=>({id:ee,title:sentence_case(te)}))}function get_VAP_set_certain_selected_value_id(t){var oe,ie;let ee;const te=((oe=t.shared_entry_values)==null?void 0:oe.conviction)||0,ne=((ie=t.shared_entry_values)==null?void 0:ie.probability)||0;return t.entries.forEach(se=>{Math.max(te,se.conviction)===1&&Math.max(ne,se.probability)===1&&(ee=se.value_id)}),ee}const map_state$v=t=>({creation_context:t.creation_context,editing:!t.display_options.consumption_formatting}),connector$v=connect(map_state$v);function _ValueAndPredictionSetOlderVersions(t){const{editing:ee,value_possibilities:te,VAPs_represent:ne,older_VAP_sets:oe,create_item:ie,update_item:se,delete_item:re}=t,_e="Older version",ae=F$1(()=>()=>{const le=create_new_VAP_set_version(t.current_VAP_set,t.creation_context);ie(le)},[t.current_VAP_set,t.creation_context,ie]),ce=F$1(()=>factory_render_list_content({items:oe,get_id,debug_item_descriptor:_e,item_props:{get_created_at,get_custom_created_at,get_summary:get_summary_for_single_VAP_set(ne,!0),get_details:get_details_for_single_VAP_set(te,ne),get_details2:get_details2_for_single_VAP_set(ne,ee),extra_class_names:"value_and_prediction_set",crud:{create_item:ie,update_item:se,delete_item:re},delete_button_text:"Delete Older Set of Value & Predictions"}}),[oe,_e,ne,ee,ie,se,re]);return o$1(ExpandableListWithAddButton,{items_count:oe.length,item_descriptor:_e,new_item_descriptor:"Version",content:ce,on_click_new_item:ae})}const ValueAndPredictionSetOlderVersions=connector$v(_ValueAndPredictionSetOlderVersions),get_id=t=>t.id,get_created_at=t=>t.created_at,get_custom_created_at=t=>t.custom_created_at;function ValueAndPredictionSetsComponent(t){const[ee,te]=h$1(void 0),{wcomponent_id:ne,VAPs_represent:oe,update_values_and_predictions:ie,existing_value_possibilities:se,values_and_prediction_sets:re,invalid_future_items:_e,future_items:ae,present_item:ce,past_items:le,previous_versions_by_id:ue,editing:de}=t,me=ce?[ce]:[],pe=factory_render_VAP_set_list_content({existing_value_possibilities:se,subset_VAP_sets:ae,previous_versions_by_id:ue,all_VAP_sets:re,update_values_and_predictions:ie,wcomponent_id:ne,VAPs_represent:oe,tense:Tense.future,editing:de}),fe=factory_render_VAP_set_list_content({existing_value_possibilities:se,subset_VAP_sets:me,previous_versions_by_id:ue,all_VAP_sets:re,update_values_and_predictions:ie,wcomponent_id:ne,VAPs_represent:oe,tense:Tense.present,editing:de}),ge=factory_render_VAP_set_list_content({existing_value_possibilities:se,subset_VAP_sets:le,previous_versions_by_id:ue,all_VAP_sets:re,update_values_and_predictions:ie,wcomponent_id:ne,VAPs_represent:oe,tense:Tense.past,editing:de}),be={get_created_at:get_actual_created_at_datetime,get_custom_created_at:get_actual_custom_created_at_datetime,get_summary:new_value_and_prediction_set__jsx_factory(oe,se),get_details:()=>o$1("div",{}),get_details2:()=>o$1("div",{}),extra_class_names:"value_and_prediction_set new",crud:{create_item:Ae=>{const $e=[...re,Ae];ie($e),te(void 0)},update_item:te}},ve="Value Prediction",ye=de||ae.length>0,we=de||me.length>0,ke=de||le.length>0;return o$1("div",{className:"value_and_prediction_sets",children:[de&&o$1(ListHeaderAddButton,{new_item_descriptor:ve,on_pointer_down_new_list_entry:()=>{const Ae=prepare_new_VAP_set(oe,se,re,t.base_id,t.creation_context);te(Ae)}}),o$1(NewItemForm,{new_item:ee,set_new_item:te,item_props:be,item_descriptor:ve}),_e.length>0&&o$1("div",{children:["Hidden (",_e.length,") ",o$1(ActiveCreatedAtFilterWarning,{})]}),ye&&o$1(ExpandableList,{content:pe,item_descriptor:"",items_descriptor:count_and_versions("Future",ae,ue,de),items_descriptor_title:count_and_versions_title("Future",ae,ue),disable_collapsed:!0}),(ye||we)&&o$1("hr",{}),we&&o$1(ExpandableList,{content:fe,item_descriptor:"",items_descriptor:count_and_versions("Present",me,ue,de),items_descriptor_title:count_and_versions_title("Present",me,ue),disable_collapsed:!0}),we&&ke&&o$1("hr",{}),ke&&o$1(ExpandableList,{content:ge,item_descriptor:"",items_descriptor:count_and_versions("Past",le,ue,de),items_descriptor_title:count_and_versions_title("Past",le,ue),disable_collapsed:!0})]})}function count_and_versions(t,ee,te,ne){if(!ne)return t;let oe=0;return ee.forEach(({id:ie})=>oe+=(te[ie]||[]).length),oe===0?get_items_descriptor(t,ee.length,ne):`${t} (${ee.length}+)`}function count_and_versions_title(t,ee,te){let ne=0;return ee.forEach(({id:oe})=>ne+=(te[oe]||[]).length),ne===0?`${ee.length} ${t} items`:`${ee.length} ${t} items with ${ne} older versions`}function factory_render_VAP_set_list_content(t){const{existing_value_possibilities:ee,subset_VAP_sets:te,all_VAP_sets:ne,previous_versions_by_id:oe,update_values_and_predictions:ie,VAPs_represent:se,tense:re,editing:_e}=t;return ce=>{const{disable_partial_collapsed:le,expanded_items:ue,expanded_item_rows:de}=ce,me={create_item:pe=>{const fe=[...ne,pe];ie(fe)},update_item:pe=>{const fe=predicate_by_id_and_created_at(pe),ge=replace_element(ne,pe,fe);ie(ge)},delete_item:pe=>{const fe=predicate_by_id_and_created_at(pe),ge=remove_element(ne,fe);ie(ge)}};return o$1("div",{style:{display:ue?"":"none",cursor:"initial"},onClick:pe=>pe.stopPropagation(),children:te.map(pe=>o$1("div",{children:[o$1("hr",{className:"entries_horizontal_dividers"}),o$1(EditableListEntry,{item:pe,get_created_at:get_actual_created_at_datetime,get_custom_created_at:get_actual_custom_created_at_datetime,get_summary:get_summary_for_single_VAP_set(se,!1),get_details:get_details_for_single_VAP_set(ee,se),get_details2:get_details2_for_single_VAP_set(se,_e),get_details3:get_details3(ee,se,oe),extra_class_names:`value_and_prediction_set ${re===Tense.future?"future":re===Tense.present?"present":"past"}`,expanded:de,crud:me,delete_button_text:"Delete Set of Value & Predictions"})]},pe.id))})}}const get_actual_created_at_datetime=t=>t.created_at,get_actual_custom_created_at_datetime=t=>t.custom_created_at,predicate_by_id_and_created_at=t=>ee=>t.id===ee.id&&t.created_at.getTime()===ee.created_at.getTime(),get_details3=(t,ee,te)=>(ne,oe)=>o$1(Box,{className:"VAP_set_details",children:[o$1("br",{}),o$1(ValueAndPredictionSetOlderVersions,{value_possibilities:t,VAPs_represent:ee,current_VAP_set:ne,older_VAP_sets:te[ne.id]||[],create_item:oe.create_item,update_item:oe.update_item,delete_item:oe.delete_item}),o$1("br",{}),o$1("br",{})]}),map_state$u=(t,ee)=>({current_created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms,creation_context:t.creation_context,editing:ee.editing_allowed??!t.display_options.consumption_formatting,base_id:selector_chosen_base_id(t)||-1}),map_dispatch$l={change_route:ACTIONS.routing.change_route},connector$u=connect(map_state$u,map_dispatch$l);function _ValueAndPredictionSets(t){const{wcomponent_id:ee,existing_value_possibilities:te,values_and_prediction_sets:ne,VAPs_represent:oe,base_id:ie,current_created_at_ms:se,sim_ms:re,update_VAPSets_and_value_possibilities:_e,change_route:ae}=t,{invalid_future_items:ce,past_items:le,present_item:ue,future_items:de,previous_versions_by_id:me}=partition_and_prune_items_by_datetimes_and_versions({items:ne,created_at_ms:t.current_created_at_ms,sim_ms:re});return o$1(ValueAndPredictionSetsComponent,{wcomponent_id:ee,VAPs_represent:oe,update_values_and_predictions:pe=>{handle_update_VAP_sets({existing_value_possibilities:te,new_values_and_prediction_sets:pe,orig_values_and_prediction_sets:ne,current_created_at_ms:se,sim_ms:re,update_VAPSets_and_value_possibilities:_e,change_route:ae})},existing_value_possibilities:t.existing_value_possibilities,values_and_prediction_sets:ne,invalid_future_items:ce,past_items:le,present_item:ue,future_items:de,previous_versions_by_id:me,base_id:ie,creation_context:t.creation_context,editing:t.editing})}const ValueAndPredictionSets=connector$u(_ValueAndPredictionSets),map_state$t=t=>({wcomponents_by_id:t.derived.composed_wcomponents_by_id}),map_dispatch$k={},connector$t=connect(map_state$t,map_dispatch$k);function _WComponentValueAndPredictionsForm(t){const{editing_allowed:ee,wcomponent:te,upsert_wcomponent:ne,VAPs_represent:oe,orig_values_and_prediction_sets:ie,orig_value_possibilities:se}=t,re=ie.length>0||ee&&oe===VAPsType.action,[_e,ae]=h$1(re),ce=wcomponent_is_statev2(te)&&te.units,le=t.editing_allowed&&(oe===VAPsType.number||!!ce)||oe===VAPsType.number&&!!ce;return o$1("div",{className:"editable_list_entry padded "+(_e?"expanded":""),children:[o$1("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>ae(!_e),children:[o$1("div",{className:"summary",children:o$1("h4",{style:{display:"inline-block"},children:["Value Predictions ",!_e&&ie.length?`(${ie.length})`:""]})}),o$1("div",{className:"expansion_button"})]}),wcomponent_is_statev2(te)&&le&&o$1(EditableTextSingleLine,{style:{padding:"10px 0px"},size:"small",placeholder:"Units",hide_label:!1,value:te.units||"",on_blur:ue=>t.upsert_wcomponent({units:ue||void 0}),on_blur_type:EditableTextOnBlurType.conditional}),_e&&o$1("div",{children:[oe===VAPsType.undefined&&o$1("div",{children:te.type==="state_value"?"Set subtype of target 'state' component to show Value Predictions on this 'state value' component":"Set subtype to show Value Predictions"}),oe===VAPsType.action&&o$1(EasyActionValueAndPredictionSets,{VAPs_represent:oe,base_id:te.base_id,existing_value_possibilities:se,values_and_prediction_sets:ie,update_VAPSets_and_value_possibilities:({value_possibilities:ue,values_and_prediction_sets:de})=>{ne({value_possibilities:ue,values_and_prediction_sets:de})},editing_allowed:ee}),oe!==VAPsType.undefined&&o$1(ValueAndPredictionSets,{wcomponent_id:te.id,VAPs_represent:oe,existing_value_possibilities:se,values_and_prediction_sets:ie,update_VAPSets_and_value_possibilities:({value_possibilities:ue,values_and_prediction_sets:de})=>{ne({value_possibilities:ue,values_and_prediction_sets:de})},editing_allowed:ee})]})]})}const WComponentValueAndPredictionsForm=connector$t(_WComponentValueAndPredictionsForm),map_state$s=t=>({wcomponents_by_id:t.specialised_objects.wcomponents_by_id}),map_dispatch$j={},connector$s=connect(map_state$s,map_dispatch$j);function _WComponentStateForm(t){var _e;const{editing_allowed:ee,wcomponent:te,upsert_wcomponent:ne,wcomponents_by_id:oe}=t,ie=get_wcomponent_VAPs_represent(te,oe),se=te.values_and_prediction_sets,re=te.value_possibilities;return o$1(k$1,{children:[wcomponent_is_statev2(te)&&(ee||(((_e=te.calculations)==null?void 0:_e.length)||0)>0)&&o$1(WComponentCalculatonsForm,{wcomponent:te,upsert_wcomponent:ne}),se!==void 0&&(ee||se.length>0)&&o$1(WComponentValueAndPredictionsForm,{editing_allowed:ee,wcomponent:te,upsert_wcomponent:ne,VAPs_represent:ie,orig_values_and_prediction_sets:se,orig_value_possibilities:re}),ie!==VAPsType.undefined&&se!==void 0&&(ee||Object.keys(re||{}).length>0)&&o$1(WComponentValuePossibilitiesForm,{editing:ee,attribute_wcomponent:oe[wcomponent_is_state_value(te)&&te.attribute_wcomponent_id||""],VAPs_represent:ie,value_possibilities:re,values_and_prediction_sets:se,update_value_possibilities:ae=>{const ce=update_VAPSets_with_possibilities(se,ae);ne({value_possibilities:ae,values_and_prediction_sets:ce})}})]})}const WComponentStateForm=connector$s(_WComponentStateForm),map_state$r=(t,{wcomponent:ee})=>{let te,ne;wcomponent_is_plain_connection(ee)&&(te=get_wcomponent_from_state(t,ee.from_id),ne=get_wcomponent_from_state(t,ee.to_id));const oe=get_wc_id_to_counterfactuals_v2_map$1(t),ie=!t.display_options.consumption_formatting,se=(t.user_info.bases_by_id||{})[ee.base_id],re=!!(se!=null&&se.can_edit);return{ready:t.sync.ready_for_reading,base_id:selector_chosen_base_id(t),wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:oe,from_wcomponent:te,to_wcomponent:ne,derived_composed_wcomponents_by_id:t.derived.composed_wcomponents_by_id,derived_composed_wcomponent:t.derived.composed_wcomponents_by_id[ee.id],is_in_editing_mode:ie,allowed_to_edit:re,editing_allowed:ie&&re,base_for_wcomponent:se,created_at_ms:t.routing.args.created_at_ms,sim_ms:t.routing.args.sim_ms}},map_dispatch$i={upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent,delete_wcomponent:ACTIONS.specialised_object.delete_wcomponent,update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$r=connect(map_state$r,map_dispatch$i);function _WComponentForm(t){var $e,xe,Ce;const{wcomponent:ee,ready:te,base_id:ne,wcomponents_by_id:oe,knowledge_views_by_id:ie,wc_id_to_counterfactuals_map:se,from_wcomponent:re,to_wcomponent:_e,derived_composed_wcomponents_by_id:ae,derived_composed_wcomponent:ce,editing_allowed:le,created_at_ms:ue,sim_ms:de}=t,me=ee.id,[pe,fe]=h$1(me);if(!te)return o$1("div",{children:"Loading..."});if(!ce)return o$1("div",{children:"Loading..."});if(ne===void 0)return o$1("div",{children:"Choose a base first."});const ge=se&&(($e=se[me])==null?void 0:$e.VAP_sets),he=_$d(!0);if(p$1(()=>fe(me),[me]),pe!==me)return he.current=!0,null;const be=he.current;he.current=!1;const ve=Se=>{const Ie=get_updated_wcomponent(ee,Se).wcomponent;t.upsert_wcomponent({wcomponent:Ie})};let ye,we=!1;wcomponent_is_allowed_to_have_state_VAP_sets(ee)&&(ye=get_wcomponent_state_UI_value({wcomponent:ce,VAP_set_id_to_counterfactual_v2_map:ge,created_at_ms:ue,sim_ms:de}),we=(((xe=ee.values_and_prediction_sets)==null?void 0:xe.length)||0)>0);const ke=get_title$1({text_type:le?RichTextType.raw:RichTextType.rich,wcomponent:ce,wcomponents_by_id:ae,knowledge_views_by_id:ie,wc_id_to_counterfactuals_map:se,created_at_ms:ue,sim_ms:de}),Ae=Se=>ve({title:Se});return o$1(Box,{children:[t.is_in_editing_mode&&!t.allowed_to_edit&&o$1("div",{children:[o$1(WarningTriangle,{message:""}),"  Not allow to edit.  Ask base owner to give you edit permissions."]}),t.wcomponent_from_different_base&&o$1("div",{style:{cursor:"pointer"},onClick:()=>t.update_chosen_base_id({base_id:ee.base_id}),title:`Click to change to base ${ee.base_id}`,children:[o$1(WarningTriangle,{message:""}),'  Is part of base "',(Ce=t.base_for_wcomponent)==null?void 0:Ce.title,'"']}),o$1(FormControl,{variant:"standard",fullWidth:!0,margin:"normal",style:{fontWeight:600,fontSize:22},children:o$1(EditableText,{editing_allowed:le,placeholder:ee.type==="action"?"Passive imperative title...":ee.type==="relation_link"?"Verb...":"Title...",value:ke,on_blur:Ae,on_blur_type:EditableTextOnBlurType.conditional,force_focus_on_first_render:be,hide_label:!0,spellcheck:!0})}),(ye==null?void 0:ye.is_defined)&&o$1("span",{children:[o$1("span",{className:"description_label",children:"Value "}),o$1(DisplayValue,{UI_value:ye})]}),(le||ee.type!=="statev2"||we)&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:o$1(AutocompleteText,{editing_allowed:le,placeholder:"Type: ",selected_option_id:ee.type,options:wcomponent_type_options,on_change:Se=>{if(!Se)return;const Pe={...prepare_new_contextless_wcomponent_object({type:Se,base_id:ee.base_id}),...ee};Pe.type=Se,ve(Pe)}})}),wcomponent_is_statev2(ee)&&(le||ee.subtype)&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Subtype"})," ",o$1("div",{style:{width:"60%",display:"inline-block"},children:o$1(AutocompleteText,{editing_allowed:le,placeholder:"Subtype...",selected_option_id:ee.subtype,options:wcomponent_statev2_subtype_options,allow_none:!0,on_change:Se=>ve({subtype:Se})})})]}),(le||ee.description)&&o$1(FormControl,{variant:"standard",fullWidth:!0,margin:"normal",children:o$1(EditableText,{editing_allowed:le,placeholder:"Description...",value:ee.description,on_blur:Se=>ve({description:Se}),on_blur_type:EditableTextOnBlurType.conditional,hide_label:!0})}),wcomponent_is_state_value(ee)&&o$1(WComponentStateValueForm,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_sub_state(ee)&&o$1(WComponentSubStateForm,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_counterfactual_v2(ee)&&o$1(WComponentCounterfactualForm,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_plain_connection(ee)&&o$1("div",{children:[o$1("p",{children:o$1(WComponentFromTo,{connection_terminal_description:"From",wcomponent_id:re&&re.id,connection_terminal_type:ee.from_type,on_update_id:Se=>ve({from_id:Se}),on_update_type:Se=>ve({from_type:Se})})}),o$1("p",{children:o$1(WComponentFromTo,{connection_terminal_description:"To",wcomponent_id:_e&&_e.id,connection_terminal_type:ee.to_type,on_update_id:Se=>ve({to_id:Se}),on_update_type:Se=>ve({to_type:Se})})}),le&&o$1("p",{style:{display:"flex",alignItems:"center",flexDirection:"column"},children:o$1(Button,{value:"Reverse Direction",onClick:()=>{ve({to_id:ee.from_id,from_id:ee.to_id})}})})]}),wcomponent_is_causal_link(ee)&&o$1(WComponentCausalLinkForm,{wcomponent:ee,from_wcomponent:re,editing:le,upsert_wcomponent:ve}),wcomponent_is_plain_connection(ee)&&o$1(WComponentConnectionForm,{wcomponent:ee,editing:le,upsert_wcomponent:ve}),wcomponent_is_judgement_or_objective(ee)&&o$1(JudgementFormFields,{wcomponent:ee,upsert_wcomponent:ve}),(wcomponent_is_goal(ee)||wcomponent_is_action(ee))&&o$1(WComponentParentGoalOrActionForm,{wcomponent:ee,upsert_wcomponent:ve}),(le||ee.label_ids&&ee.label_ids.length>0)&&o$1(FormControl,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[o$1(FormLabel,{component:"legend",children:"Labels"}),o$1(LabelsEditor,{label_ids:ee.label_ids,on_change:Se=>ve({label_ids:Se})})]}),wcomponent_is_event(ee)&&o$1(WComponentEventAtFormField,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_prioritisation(ee)&&o$1(WComponentDateTimeFormField,{wcomponent:ee,upsert_wcomponent:ve}),wcomponent_is_allowed_to_have_state_VAP_sets(ee)&&o$1(WComponentStateForm,{editing_allowed:le,wcomponent:ee,upsert_wcomponent:ve}),wcomponent_has_objectives(ee)&&o$1(ChosenObjectivesFormFields,{editing_allowed:le,wcomponent:ee,upsert_wcomponent:ve}),wcomponent_can_have_validity_predictions(ee)&&o$1(WComponentValidityPredictionsForm,{editing_allowed:le,wcomponent:ee,upsert_wcomponent:ve}),wcomponent_has_existence_predictions(ee)&&ee.existence.length&&o$1("div",{children:[o$1("p",{style:{color:"red"},children:o$1(PredictionList,{item_descriptor:"(Deprecated, please delete) Existence prediction",predictions:wcomponent_has_existence_predictions(ee)?ee.existence:[],update_predictions:Se=>ve({existence:Se.length?Se:void 0})})}),o$1("hr",{})]}),o$1("br",{}),o$1("br",{}),o$1(FormControl,{variant:"standard",fullWidth:!0,children:[o$1(EditableCustomDateTime,{editing_allowed:le,title:"Created at",invariant_value:ee.created_at,value:ee.custom_created_at,on_change:Se=>{ve({custom_created_at:Se})}}),o$1("br",{})]}),le&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Label color"}),o$1(ColorPicker,{color:ee.label_color,conditional_on_blur:Se=>ve({label_color:Se})})]}),le&&o$1(WComponentImageForm,{wcomponent:ee,upsert_wcomponent:ve}),!le&&ee.summary_image&&o$1("p",{children:o$1("a",{href:ee.summary_image,target:"_blank",children:[o$1(ExternalLinkIcon,{}),"Open image"]})}),le&&o$1("p",{children:[o$1("span",{className:"description_label",children:"Hide node title"}),o$1(EditableCheckbox,{value:ee.hide_title,on_change:Se=>ve({hide_title:Se})}),o$1("span",{className:"description_label",children:"Hide node state"}),o$1(EditableCheckbox,{value:ee.hide_state,on_change:Se=>ve({hide_state:Se})}),o$1("hr",{})]}),o$1(WComponentKnowledgeViewForm,{wcomponent_id:ee.id,editing_allowed:le}),o$1("br",{}),o$1("br",{}),le&&wcomponent_is_not_deleted(ee)&&o$1("div",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Soft Delete (can undo)",tooltip_text:"Remove from all knowledge views",on_delete:()=>t.delete_wcomponent({wcomponent_id:me})})}),le&&wcomponent_is_deleted(ee)&&o$1("div",{children:o$1(Button,{title:"Undo delete",onClick:()=>ve({deleted_at:void 0}),children:"Restore"})}),o$1("br",{})]})}const WComponentForm=connector$r(_WComponentForm);function EditablePosition(t){const[ee,te]=h$1(0),[ne,oe]=h$1(0),ie=se=>{t.on_update({change_left:se.change_left?round_coordinate_small_step(se.change_left):0,change_top:se.change_top?round_coordinate_small_step(se.change_top):0})};return o$1("div",{children:[o$1("p",{style:{fontSize:10,color:"#888"},children:["Increments of ",grid_small_step," pixels"]}),"Move right: ",o$1(EditableNumber,{placeholder:"Right",value:ee,allow_undefined:!1,on_blur:se=>te(round_coordinate_small_step(se)),on_blur_type:EditableTextOnBlurType.conditional}),o$1("input",{type:"button",value:"Move",disabled:ee===0,onClick:()=>ie({change_left:ee})}),"  ",o$1("input",{type:"button",value:"←",onClick:()=>ie({change_left:-grid_small_step})}),o$1("input",{type:"button",value:"←←",onClick:()=>ie({change_left:-h_step})}),o$1("input",{type:"button",value:"→→",onClick:()=>ie({change_left:h_step})}),o$1("input",{type:"button",value:"→",onClick:()=>ie({change_left:grid_small_step})}),o$1("br",{}),o$1("br",{}),"Move up: ",o$1(EditableNumber,{placeholder:"Up",value:-ne,allow_undefined:!1,on_blur:se=>oe(round_coordinate_small_step(-se)),on_blur_type:EditableTextOnBlurType.conditional}),o$1("input",{type:"button",value:"Move",disabled:ne===0,onClick:()=>ie({change_top:ne})}),"  ",o$1("input",{type:"button",value:"↑",onClick:()=>ie({change_top:-grid_small_step})}),o$1("input",{type:"button",value:"↑↑",onClick:()=>ie({change_top:-v_step})}),o$1("input",{type:"button",value:"↓↓",onClick:()=>ie({change_top:v_step})}),o$1("input",{type:"button",value:"↓",onClick:()=>ie({change_top:grid_small_step})})]})}const map_state$q=t=>{const ee=get_current_composed_knowledge_view_from_state(t),{selected_wcomponent_ids_set:te}=t.meta_wcomponents,{wcomponents_by_id:ne}=t.specialised_objects;return{ready:t.sync.ready_for_reading,selected_wcomponent_ids_set:te,wcomponents_by_id:ne,knowledge_view_id:ee==null?void 0:ee.id,composed_wc_id_map:ee==null?void 0:ee.composed_wc_id_map,editing:!t.display_options.consumption_formatting}},map_dispatch$h={bulk_edit_knowledge_view_entries:ACTIONS.specialised_object.bulk_edit_knowledge_view_entries,bulk_add_to_knowledge_view:ACTIONS.specialised_object.bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view:ACTIONS.specialised_object.bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries:ACTIONS.specialised_object.snap_to_grid_knowledge_view_entries,bulk_edit_wcomponents:ACTIONS.specialised_object.bulk_edit_wcomponents,upsert_wcomponent:ACTIONS.specialised_object.upsert_wcomponent},connector$q=connect(map_state$q,map_dispatch$h);function _WComponentMultipleForm(t){if(!t.ready)return o$1("div",{children:"Loading..."});const{selected_wcomponent_ids_set:ee,composed_wc_id_map:te,knowledge_view_id:ne,wcomponents_by_id:oe,editing:ie,bulk_edit_knowledge_view_entries:se,bulk_add_to_knowledge_view:re,bulk_remove_from_knowledge_view:_e,snap_to_grid_knowledge_view_entries:ae,bulk_edit_wcomponents:ce,upsert_wcomponent:le}=t,ue=get_wcomponents_from_ids(oe,ee).filter(is_defined),de=Array.from(ee),me=calc_all_wcomponent_ids_present_in_current_kv(de,te),pe=new Set,fe=[];let ge,he;ue.forEach(ve=>{(ve.label_ids||[]).forEach(ye=>pe.add(ye)),wcomponent_is_causal_link(ve)&&(fe.push(ve.id),ge=ve.effect_when_true,he=ve.effect_when_false)});const be=Array.from(pe).sort();return de.length===0?o$1("div",{children:o$1("h2",{children:"No selected components"})}):o$1("div",{children:[o$1("h2",{children:[ie?"Bulk editing":"Viewing"," ",de.length," components"]}),ie&&o$1("p",{children:[o$1("h3",{children:"Position"}),o$1(EditablePosition,{on_update:ve=>{se({wcomponent_ids:de,...ve})}})]}),ie&&o$1("p",{children:o$1(AlignComponentForm,{wcomponent_ids:de})}),(ie||be.length>0)&&o$1("p",{children:[o$1("h3",{children:"Labels"}),o$1(LabelsEditor,{label_ids:be,on_change:ve=>{const ye=new Set(ve),we=new Set(be.filter(Ae=>!ye.has(Ae))),ke=new Set(ve.filter(Ae=>!pe.has(Ae)));ce({wcomponent_ids:de,change:{},remove_label_ids:we,add_label_ids:ke})}})]}),ie&&fe.length>0&&o$1("p",{children:["Causal Connection Values",o$1(BasicCausalLinkForm,{show_primary_effect:!0,show_effect_when_false:!0,VAPs_represent_number:!0,effect_when_true:ge,effect_when_false:he,editing:ie,change_effect:ve=>ce({wcomponent_ids:fe,change:ve})})]}),ie&&o$1("p",{children:["Component types",o$1(AutocompleteText,{placeholder:"Type: ",selected_option_id:void 0,allow_none:!0,options:wcomponent_type_options,on_change:ve=>{ve&&ue.forEach(ye=>{const ke={...prepare_new_contextless_wcomponent_object({base_id:ye.base_id,type:ve}),...ye};ke.type=ve,le({wcomponent:ke})})}})]}),ie&&o$1("p",{children:[o$1("h3",{children:"Created at"}),o$1(EditableCustomDateTime,{value:void 0,on_change:ve=>ce({wcomponent_ids:de,change:{custom_created_at:ve}})})]}),ie&&o$1("p",{children:[o$1("h3",{children:"Add to knowledge view"}),me?"":o$1("span",{children:[o$1(WarningTriangle,{message:"Not all components present in current view so will be added to center of view."}),"Not all components present in current view so will be added to center of view."]}),o$1(SelectKnowledgeView,{on_change:ve=>{if(!ve)return;const ye=get_store().getState(),we=get_middle_of_screen(ye);re({wcomponent_ids:de,knowledge_view_id:ve,default_entry:we})}})]}),ie&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Delete from knowledge view",tooltip_text:"Delete from knowledge view",on_delete:()=>{_e({wcomponent_ids:de,remove_type:"passthrough"})}})}),ie&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Delete and Block from knowledge view",tooltip_text:"Delete and Block from showing in current knowledge view",on_delete:()=>{_e({wcomponent_ids:de,remove_type:"block"})}})})]})}const WComponentMultipleForm=connector$q(_WComponentMultipleForm);function calc_all_wcomponent_ids_present_in_current_kv(t,ee){return ee?t.find(te=>!ee[te])===void 0:!1}const map_state$p=(t,ee)=>{const te=get_current_knowledge_view_from_state(t),ne=te&&te.wc_id_map[ee.wcomponent_id];return{knowledge_view_title:te&&te.title,knowledge_view_entry:ne,editing:!t.display_options.consumption_formatting}},map_dispatch$g={bulk_remove_from_knowledge_view:ACTIONS.specialised_object.bulk_remove_from_knowledge_view},connector$p=connect(map_state$p,map_dispatch$g);function _NotFoundWComponentKnowledgeViewForm(t){const{wcomponent_id:ee,knowledge_view_title:te,knowledge_view_entry:ne,editing:oe}=t;return o$1("div",{children:[o$1(WComponentKnowledgeViewForm,{wcomponent_id:ee,editing_allowed:oe}),oe&&ne&&!ne.passthrough&&o$1("p",{children:o$1(ConfirmatoryDeleteButton,{button_text:"Delete from knowledge view",tooltip_text:"Delete from current knowledge view ("+te+")",on_delete:()=>{t.bulk_remove_from_knowledge_view({wcomponent_ids:[ee],remove_type:"passthrough"})}})}),o$1("p",{children:o$1(WComponentPresenceInOtherKVs,{wcomponent_id:ee})})]})}const NotFoundWComponentKnowledgeViewForm=connector$p(_NotFoundWComponentKnowledgeViewForm),map_state$o=t=>({}),map_dispatch$f={change_route:ACTIONS.routing.change_route},connector$o=connect(map_state$o,map_dispatch$f);function _ListOrphanedWComponents(t){const[ee,te]=h$1(void 0),ne=F$1(()=>()=>{const ie=get_store().getState(),{wcomponents_by_id:se,knowledge_views_by_id:re}=ie.specialised_objects,_e=new Set;Object.values(re).forEach(le=>{Object.entries(le.wc_id_map).filter(([ue,de])=>!de.blocked&&!de.passthrough).forEach(([ue,de])=>_e.add(ue))});const ae=Object.values(se).filter(le=>wcomponent_is_not_deleted(le)&&!_e.has(le.id)),ce=sort_list(ae,le=>(le.modified_at||le.created_at).getTime(),SortDirection.descending);te(ce)},[]);return o$1("div",{children:[o$1("h3",{style:{marginTop:30,marginBottom:0},children:"Orphaned Components"}),o$1("span",{className:"description_label",children:"Show all components in this knowledge base which are not in one or more knowledge views in this base."}),o$1(ButtonGroup,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:o$1(Button$2,{onClick:()=>ne(),children:"Find orphan components"})}),ee&&ee.length>0&&o$1("table",{children:o$1("tbody",{style:{cursor:"pointer"},children:ee.map(oe=>o$1("tr",{onClick:()=>t.change_route({item_id:oe.id}),children:[o$1("td",{children:oe.type}),o$1("td",{children:o$1(RichMarkDown,{text:oe.title})})]}))})}),ee&&ee.length===0&&o$1("p",{children:"No orphaned components found."})]})}const ListOrphanedWComponents=connector$o(_ListOrphanedWComponents),map_state$n=t=>{const{ready_for_reading:ee}=t.sync,{bases_by_id:te,chosen_base_id:ne}=t.user_info,{sub_route:oe,item_id:ie}=t.routing,se=get_wcomponent_from_state(t,ie),re=t.meta_wcomponents.selected_wcomponent_ids_list;return{bases_by_id:te,chosen_base_id:ne,ready_for_reading:ee,sub_route:oe,item_id:ie,wcomponent:se,selected_ids:re,editing:!t.display_options.consumption_formatting,wcomponent_ids_searched_for_in_any_base:t.sync.wcomponent_ids_searched_for_in_any_base}},map_dispatch$e={clear_selected_wcomponents:ACTIONS.meta_wcomponents.clear_selected_wcomponents,set_or_toggle_display_select_storage:ACTIONS.controls.set_or_toggle_display_select_storage,request_searching_for_wcomponents_by_id_in_any_base:ACTIONS.sync.request_searching_for_wcomponents_by_id_in_any_base},connector$n=connect(map_state$n,map_dispatch$e);function _WComponentsSidePanel(t){const{ready_for_reading:ee,item_id:te}=t,ne=te?!t.wcomponent_ids_searched_for_in_any_base.has(te):!1,oe=t.wcomponent,ie=t.bases_by_id&&!t.chosen_base_id?0:ee?t.sub_route==="wcomponents_edit_multiple"?2:te===null?3:4:1;if(p$1(()=>{oe||ie===4&&te&&t.request_searching_for_wcomponents_by_id_in_any_base({ids:[te]})},[ee,ie,te,oe,ne]),ie===0)return o$1("div",{children:o$1(Button,{value:"Choose a base to view",onClick:()=>t.set_or_toggle_display_select_storage(!0)})});if(ie===1)return o$1("div",{children:"Loading..."});if(ie===2)return o$1("div",{children:o$1(WComponentMultipleForm,{})});if(ie===3)return o$1("div",{children:[t.selected_ids.length>0&&o$1("p",{children:[o$1("div",{style:{display:"inline-flex"},children:[o$1(LinkButton,{name:`View ${t.selected_ids.length} component(s) already selected`,route:"wcomponents",sub_route:t.selected_ids.length>1?"wcomponents_edit_multiple":void 0,item_id:t.selected_ids.length===1?t.selected_ids[0]:void 0,args:void 0})," ",o$1(Button,{value:"Clear selection",onClick:()=>t.clear_selected_wcomponents({}),is_left:!0})]}),o$1("br",{}),o$1("br",{}),o$1("hr",{})]}),o$1(CreateNewWComponent,{}),o$1(ListOrphanedWComponents,{})]});if(oe){const se=!!t.wcomponent&&t.wcomponent.base_id!==t.chosen_base_id;return o$1(WComponentForm,{wcomponent:oe,wcomponent_from_different_base:se})}return o$1("div",{children:["Component not found for id: ",te,o$1("br",{}),o$1("br",{}),ne&&o$1("div",{children:"Searching in other bases..."}),!ne&&o$1("div",{children:["Not found in other bases (that you have access to).",t.editing&&te&&o$1(NotFoundWComponentKnowledgeViewForm,{wcomponent_id:te})]})]})}const WComponentsSidePanel=connector$n(_WComponentsSidePanel),map_state$m=t=>({route:t.routing.route}),connector$m=connect(map_state$m);function _SidePanel(t){return o$1("div",{children:[t.route==="filter"&&o$1(FiltersSidePanel,{}),t.route==="select"&&o$1(SelectionControlSidePanel,{}),t.route==="display"&&o$1(DisplayOptionsSidePanel,{}),t.route==="creation_context"&&o$1(CreationContextSidePanel,{}),t.route==="views"&&o$1(ViewsSidePanel,{}),t.route==="wcomponents"&&o$1(WComponentsSidePanel,{}),t.route==="about"&&o$1(AboutSidePanel,{}),t.route==="search"&&o$1(SearchSidePanel,{})]})}const SidePanel=connector$m(_SidePanel),map_state$l=t=>{const ee=t.routing.args.subview_id;return{ready_for_reading:t.sync.ready_for_reading,presenting:t.display_options.consumption_formatting,view:t.routing.args.view,kv_id:ee,nested_kv_ids_map:t.derived.nested_knowledge_view_ids}},map_dispatch$d={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting,change_route:ACTIONS.routing.change_route},connector$l=connect(map_state$l,map_dispatch$d);function _ViewsBreadcrumb(t){if(!t.ready_for_reading)return null;const{kv_id:ee,nested_kv_ids_map:te}=t;let ne=te.map[ee];const oe=[];let ie=OPTION_NONE_ID;for(;ne;){const re=ne.child_ids.map(_e=>te.map[_e]).filter(is_defined);if(re.length){const _e=re.map(calc_if_is_hidden);oe.unshift({options:_e,selected_id:ie,parent_id:ne.id})}ie=ne.id,ne=ne.parent_id!==void 0?te.map[ne.parent_id]:void 0}const se=te.top_ids.map(re=>te.map[re]).filter(is_defined).map(calc_if_is_hidden);return oe.unshift({options:se,selected_id:ie,parent_id:void 0}),o$1(Breadcrumbs,{style:{marginTop:"8px"},children:[o$1(Box,{children:o$1(Select,{variant:"standard",label:o$1(Typography,{noWrap:!0,children:"View Type:"}),name:"select_view",value:t.view,children:view_options.map(re=>o$1(MenuItem,{value:re.id,selected:re.id===t.view,onPointerDown:_e=>{_e.stopImmediatePropagation(),t.change_route({args:{view:re.id}})},children:re.title}))})}),oe.map(re=>o$1(Box,{children:o$1(AutocompleteText,{allow_none:re.parent_id!==void 0,selected_option_id:re.selected_id,options:re.options,on_change:_e=>t.change_route({args:{subview_id:_e||re.parent_id}}),on_choose_same:_e=>t.change_route({args:{subview_id:_e||re.parent_id}}),editing_allowed:!0,threshold_minimum_score:!1,retain_options_order:!0})}))]})}const ViewsBreadcrumb=connector$l(_ViewsBreadcrumb),view_options=[{id:"knowledge",title:"Knowledge"},{id:"priorities",title:"Priorities"},{id:"priorities_list",title:"Priorities list"},{id:"actions_list",title:"Actions list"}];function calc_if_is_hidden(t){const ee=t.sort_type==="hidden"||t.sort_type==="archived"||t.sort_type==="errored",te=t.sort_type==="errored"?pink:void 0;return{id:t.id,title:t.title,is_hidden:ee,color:te}}const pink={r:231,g:190,b:201,a:1};var Edit={},_interopRequireDefault$8=interopRequireDefaultExports;Object.defineProperty(Edit,"__esModule",{value:!0});var default_1$8=Edit.default=void 0,_createSvgIcon$8=_interopRequireDefault$8(requireCreateSvgIcon()),_jsxRuntime$8=requireJsxRuntime(),_default$8=(0,_createSvgIcon$8.default)((0,_jsxRuntime$8.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"}),"Edit");default_1$8=Edit.default=_default$8;var PresentToAll={},_interopRequireDefault$7=interopRequireDefaultExports;Object.defineProperty(PresentToAll,"__esModule",{value:!0});var default_1$7=PresentToAll.default=void 0,_createSvgIcon$7=_interopRequireDefault$7(requireCreateSvgIcon()),_jsxRuntime$7=requireJsxRuntime(),_default$7=(0,_createSvgIcon$7.default)((0,_jsxRuntime$7.jsx)("path",{d:"M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16.02H3V4.98h18v14.04zM10 12H8l4-4 4 4h-2v4h-4v-4z"}),"PresentToAll");default_1$7=PresentToAll.default=_default$7;const map_state$k=t=>{const ee=selector_current_user_access_level(t);return{presenting:t.display_options.consumption_formatting,access_level:ee}},map_dispatch$c={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting,change_route:ACTIONS.routing.change_route},connector$k=connect(map_state$k,map_dispatch$c);function _ViewOptions(t){const{access_level:ee}=t,te=ee==="viewer"||ee==="none",ne=!t.presenting,[oe,ie]=h$1(void 0),se=_$d(!1);p$1(()=>{ee!==void 0&&(se.current||(se.current=!0,ie(te)))},[ee]);const re=te?"No editing rights":"",_e=te?t.presenting?"rgba(183, 28, 26, 0.5)":"rgba(183, 28, 26)":"",ae=invert_disabled_appearance();return o$1(ButtonGroup,{size:"small",value:t.presenting?"presenting":"editing",children:[o$1(Tooltip,{title:re,"aria-label":re,children:o$1(IconButton,{className:ae.inverse_disabled,disabled:ne,component:ne?"div":void 0,onClick:ne?void 0:t.toggle_consumption_formatting,value:"editing",size:"large",children:o$1(default_1$8,{style:{color:_e}})})}),o$1(IconButton,{className:ae.inverse_disabled,disabled:t.presenting,onClick:t.toggle_consumption_formatting,value:"presenting",size:"large",children:o$1(default_1$7,{})})]})}const ViewOptions=connector$k(_ViewOptions);var PermDataSetting={},_interopRequireDefault$6=interopRequireDefaultExports;Object.defineProperty(PermDataSetting,"__esModule",{value:!0});var default_1$6=PermDataSetting.default=void 0,_createSvgIcon$6=_interopRequireDefault$6(requireCreateSvgIcon()),_jsxRuntime$6=requireJsxRuntime(),_default$6=(0,_createSvgIcon$6.default)((0,_jsxRuntime$6.jsx)("path",{d:"M18.99 11.5c.34 0 .67.03 1 .07L20 0 0 20h11.56c-.04-.33-.07-.66-.07-1 0-4.14 3.36-7.5 7.5-7.5zm3.71 7.99c.02-.16.04-.32.04-.49 0-.17-.01-.33-.04-.49l1.06-.83c.09-.08.12-.21.06-.32l-1-1.73c-.06-.11-.19-.15-.31-.11l-1.24.5c-.26-.2-.54-.37-.85-.49l-.19-1.32c-.01-.12-.12-.21-.24-.21h-2c-.12 0-.23.09-.25.21l-.19 1.32c-.3.13-.59.29-.85.49l-1.24-.5c-.11-.04-.24 0-.31.11l-1 1.73c-.06.11-.04.24.06.32l1.06.83c-.02.16-.03.32-.03.49 0 .17.01.33.03.49l-1.06.83c-.09.08-.12.21-.06.32l1 1.73c.06.11.19.15.31.11l1.24-.5c.26.2.54.37.85.49l.19 1.32c.02.12.12.21.25.21h2c.12 0 .23-.09.25-.21l.19-1.32c.3-.13.59-.29.84-.49l1.25.5c.11.04.24 0 .31-.11l1-1.73c.06-.11.03-.24-.06-.32l-1.07-.83zm-3.71 1.01c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"}),"PermDataSetting");default_1$6=PermDataSetting.default=_default$6;const StorageInfo$1="",common="",StorageOption$1="";function get_user_name_for_display(t){var ie;const{users_by_id:ee,current_user_id:te,other_user_id:ne}=t;let oe=((ie=ee[ne])==null?void 0:ie.name)||"";return te?oe=te===ne?"me":oe||"(someone else)":oe=oe||"Someone",o$1("span",{title:ne,children:oe})}function StorageOption(t){const{user:ee,users_by_id:te,base:ne,selected:oe,on_click:ie,on_click_edit:se}=t,{title:re,public_read:_e,access_level:ae}=ne,ce=ae==="owner"?"Editor (Owner)":ae==="editor"?"Editor":ae==="viewer"?"Viewer":ne.public_read?"Viewer (public access)":"?";return o$1("tr",{className:"base_option "+(oe?"selected":""),onClick:ie,children:[o$1("td",{className:"narrow",children:o$1("input",{type:"radio",checked:oe,style:{cursor:"pointer"}})}),o$1("td",{children:re||"(No title)"}),o$1("td",{children:_e&&"(Public)"}),o$1("td",{children:get_user_name_for_display({users_by_id:te,current_user_id:ee==null?void 0:ee.id,other_user_id:ne.owner_user_id})}),o$1("td",{children:ce}),o$1("td",{className:"narrow edit_title",onClick:ne.can_edit?le=>{le.stopImmediatePropagation(),se()}:void 0,children:ne.can_edit&&o$1(default_1$8,{})})]})}var Sync={},_interopRequireDefault$5=interopRequireDefaultExports;Object.defineProperty(Sync,"__esModule",{value:!0});var default_1$5=Sync.default=void 0,_createSvgIcon$5=_interopRequireDefault$5(requireCreateSvgIcon()),_jsxRuntime$5=requireJsxRuntime(),_default$5=(0,_createSvgIcon$5.default)((0,_jsxRuntime$5.jsx)("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"}),"Sync");default_1$5=Sync.default=_default$5;var SyncProblem={},_interopRequireDefault$4=interopRequireDefaultExports;Object.defineProperty(SyncProblem,"__esModule",{value:!0});var default_1$4=SyncProblem.default=void 0,_createSvgIcon$4=_interopRequireDefault$4(requireCreateSvgIcon()),_jsxRuntime$4=requireJsxRuntime(),_default$4=(0,_createSvgIcon$4.default)((0,_jsxRuntime$4.jsx)("path",{d:"M3 12c0 2.21.91 4.2 2.36 5.64L3 20h6v-6l-2.24 2.24C5.68 15.15 5 13.66 5 12c0-2.61 1.67-4.83 4-5.65V4.26C5.55 5.15 3 8.27 3 12zm8 5h2v-2h-2v2zM21 4h-6v6l2.24-2.24C18.32 8.85 19 10.34 19 12c0 2.61-1.67 4.83-4 5.65v2.09c3.45-.89 6-4.01 6-7.74 0-2.21-.91-4.2-2.36-5.64L21 4zm-10 9h2V7h-2v6z"}),"SyncProblem");default_1$4=SyncProblem.default=_default$4;function SyncButton(t){const{state:ee,text:te="Refresh",title:ne="Refresh",on_click:oe,style:ie}=t,se=ee==="error";return o$1("span",{title:ne,onClick:oe,style:ie,children:[te,!se&&o$1(default_1$5,{className:ee==="in_progress"?"animate spinning":""}),se&&o$1(default_1$4,{})]})}function DisplaySupabaseSessionError(t){const{error:ee}=t;return ee===null?null:(ee==null?void 0:ee.message.includes("Thanks for registering"))&&(ee==null?void 0:ee.status)===400?o$1("div",{children:"Please check your email"}):o$1("div",{children:["Error : ",ee.message||ee]})}function DisplaySupabasePostgrestError(t){const{error:ee}=t;if(!ee)return null;const te=ee.message||ee||"An error occured";let ne=`${te}`;return ne==="[object Object]"&&(ne=JSON.stringify(te)),o$1("div",{children:["Error: ",ne]})}const map_state$j=t=>({user:t.user_info.user,users_by_id:t.user_info.users_by_id,chosen_base_id:t.user_info.chosen_base_id,bases_by_id:t.user_info.bases_by_id}),map_dispatch$b={update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$j=connect(map_state$j,map_dispatch$b);function _AvailableBases(t){const{on_choose:ee,on_click_edit:te,user:ne,users_by_id:oe,chosen_base_id:ie,bases_by_id:se,update_chosen_base_id:re}=t,[_e,ae]=h$1("initial"),[ce,le]=h$1(void 0);if(!oe)return"Loading users...";if(!se)return"Loading bases...";const ue=sort_list(Object.values(se),de=>de.inserted_at.getTime(),SortDirection.descending);return ue.length===0?null:o$1("div",{style:{margin:10},children:[o$1(SyncButton,{state:_e,title:"Refresh sharing options",on_click:async()=>{ae("in_progress");const de=await refresh_bases_for_current_user();ae(de.error?"error":"success"),le(de.error)},style:{float:"right"}}),o$1("h4",{children:"Select a base"}),o$1(DisplaySupabasePostgrestError,{error:ce}),o$1("table",{children:[o$1("thead",{children:o$1("tr",{children:[o$1("th",{}),o$1("th",{children:"Knowledge Base Title"}),o$1("th",{}),o$1("th",{children:"Owner"}),o$1("th",{children:"Access"}),o$1("th",{})]})}),o$1("tbody",{children:ue.map(de=>o$1(StorageOption,{user:ne,users_by_id:oe,base:de,selected:de.id===ie,on_click:()=>{re({base_id:de.id}),ee&&ee()},on_click_edit:()=>te(de.id)}))})]})]})}const AvailableBases=connector$j(_AvailableBases);function BaseFormEditFields(t){const{base:ee,on_save_or_exit:te,user:ne}=t,[oe,ie]=h$1(ee);p$1(()=>ie(ee),[ee]);const[se,re]=h$1(void 0),_e=ee.owner_user_id===ne.id,ae=JSON.stringify(ee)!==JSON.stringify(oe),ce=!!oe.title;function le(ue,de){let me=ue.currentTarget.value;de&&(me=me.trim()),ie({...oe,title:me})}return _e?o$1("div",{children:[o$1("h4",{children:"Edit base"}),"Title   ",o$1("input",{type:"text",placeholder:"title",value:oe.title,onChange:ue=>le(ue,!1),onBlur:ue=>le(ue,!0)}),o$1("br",{}),o$1("br",{}),"Visibility   ",o$1("input",{type:"button",onClick:()=>{ie({...oe,public_read:!oe.public_read})},value:oe.public_read?"Make private":"Publish (make public)"}),o$1("br",{}),o$1("br",{}),"Default view   ",o$1(SelectKnowledgeView,{selected_option_id:oe.default_knowledge_view_id,on_change:ue=>{ie({...oe,default_knowledge_view_id:ue})},editing_allowed:!0}),o$1("br",{}),o$1("br",{}),o$1("div",{children:[ae&&ce&&o$1("input",{type:"button",disabled:!ae||!ce,onClick:async()=>{const ue=await modify_base(oe);if(ue.error)return re(ue.error);re(void 0),pub_sub.user.pub("stale_bases",!1)},value:"Save changes"}),"  ",o$1("input",{type:"button",onClick:te,value:ae?"Cancel":"Back"}),o$1("br",{}),o$1(DisplaySupabasePostgrestError,{error:se})]}),o$1("br",{}),o$1("hr",{})]}):null}const BaseFormEditSharing$1="";async function get_access_controls_for_base(t){const ee=get_supabase(),{data:te,error:ne}=await ee.from("access_controls").select("*").eq("base_id",t);return{access_controls:te&&te.map(ie=>({...ie,inserted_at:new Date(ie.inserted_at),updated_at:new Date(ie.updated_at)}))||void 0,error:ne}}async function update_access_control(t){const ee={base_id:t.base_id,user_id:t.other_user_id,access_level:t.grant};return await get_supabase().from("access_controls").upsert(ee)}function SelectAccessLevelDropDown(t){const ee=["editor","viewer","none"];return o$1(Select,{variant:"standard",disabled:t.disabled,value:t.current_level,title:t.title||"Select access level",onChange:te=>{const ne=te.currentTarget.getAttribute("data-value");t.on_change(ne)},children:ee.map(te=>o$1(MenuItem,{value:te,children:sentence_case(te)}))})}function AccessControlEntry(t){const{access_control:ee,base_id:te,users_by_id:ne,current_user_id:oe,is_owner:ie,on_update:se}=t,{user_id:re,access_level:_e}=ee,ae=ce=>update_access_control({base_id:te,other_user_id:re,grant:ce}).then(se);return o$1("tr",{children:[o$1("td",{children:get_user_name_for_display({users_by_id:ne,current_user_id:oe,other_user_id:re})}),o$1("td",{children:o$1(SelectAccessLevelDropDown,{disabled:!ie,current_level:_e,title:ie?"Select access level":"Only owners can edit access levels",on_change:ae})}),o$1("br",{})]})}function AddAccessControlEntry(t){const[ee,te]=h$1(""),[ne,oe]=h$1("editor"),[ie,se]=h$1("initial"),re=ie==="in_progress",_e=ie==="success",[ae,ce]=h$1(null),{base_id:le}=t;return o$1("div",{children:["Share with new user: ",o$1("br",{}),o$1("input",{type:"text",placeholder:"User's ID or email",value:ee,disabled:re,style:{minWidth:200},onKeyUp:ue=>te(ue.currentTarget.value),onChange:ue=>te(ue.currentTarget.value),onBlur:ue=>te(ue.currentTarget.value)}),"  ",o$1(SelectAccessLevelDropDown,{current_level:ne,on_change:oe}),o$1("br",{}),re&&o$1("span",{children:"Adding..."}),_e&&o$1("span",{children:"Added."}),o$1(DisplaySupabasePostgrestError,{error:ae}),o$1("br",{}),ee&&o$1("input",{type:"button",onClick:async()=>{se("in_progress");const de=await get_supabase().rpc("invite_user_to_base",{base_id:le,email_or_uid:ee,access_level:ne}),{status:me,error:pe}=de;ce(pe),se(pe?"error":"success"),pe||(te(""),t.on_add_or_exit(!0))},value:"Add user",disabled:!ee}),"  ",o$1("input",{type:"button",onClick:()=>t.on_add_or_exit(!1),value:"Back"})]})}const map_state$i=t=>({users_by_id:t.user_info.users_by_id}),connector$i=connect(map_state$i);function _BaseFormEditSharing(t){const{user:ee,base:te,on_save_or_exit:ne,users_by_id:oe}=t,[ie,se]=h$1("initial"),[re,_e]=h$1(void 0),[ae,ce]=h$1(void 0),le=te.owner_user_id===ee.id;function ue(){se("in_progress"),get_access_controls_for_base(te.id).then(de=>{se(de.error?"error":"success"),_e(de.access_controls),ce(de.error||void 0),!de.error&&pub_sub.user.pub("stale_users_by_id",!1)})}return p$1(()=>ue(),[]),oe?o$1("div",{children:[o$1(SyncButton,{state:ie,title:"Refresh sharing options",on_click:()=>ue(),style:{float:"right"}}),o$1("h4",{children:"Sharing options"}),o$1(DisplaySupabasePostgrestError,{error:ae}),re&&o$1("div",{children:[re.length===0&&"Not shared with anyone yet",re.length>0&&o$1("table",{className:"access_controls_table",children:o$1("tbody",{children:re.map(de=>o$1(AccessControlEntry,{access_control:de,base_id:te.id,users_by_id:oe,current_user_id:ee.id,is_owner:le,on_update:me=>{ce(me.error||void 0),me.error||ue()}}))})}),o$1("br",{})]}),!le&&o$1("div",{children:"Sharing with new users (Only owners can do this for now)"}),le&&o$1(AddAccessControlEntry,{base_id:te.id,on_add_or_exit:de=>{de?ue():ne()}})]}):o$1("div",{children:"Fetching users..."})}const BaseFormEditSharing=connector$i(_BaseFormEditSharing),map_state$h=t=>({user:t.user_info.user}),connector$h=connect(map_state$h);function _BaseForm(t){const{base:ee,on_save_or_exit:te,user:ne}=t;return ne?o$1("div",{style:{margin:10},children:[o$1(BaseFormEditFields,{user:ne,base:ee,on_save_or_exit:te}),o$1(BaseFormEditSharing,{user:ne,base:ee,on_save_or_exit:te})]}):"Please sign in"}const BaseForm=connector$h(_BaseForm),map_state$g=t=>({user:t.user_info.user,users_by_id:t.user_info.users_by_id,bases_by_id:t.user_info.bases_by_id}),map_dispatch$a={update_chosen_base_id:ACTIONS.user_info.update_chosen_base_id},connector$g=connect(map_state$g,map_dispatch$a);function _StorageOptionsForm(t){const{on_close:ee,user:te,users_by_id:ne,bases_by_id:oe,update_chosen_base_id:ie}=t,[se,re]=h$1(""),[_e,ae]=h$1("initial"),[ce,le]=h$1(void 0),[ue,de]=h$1(void 0);if(!ne)return"Loading users...";if(!oe)return"Loading bases...";const me=te==null?void 0:te.id,pe=Object.keys(oe).length,fe=me===void 0?void 0:async function(){ae("in_progress");const ge=await create_a_base({owner_user_id:me,title:se.trim()});ae(ge.error?"error":"success"),de(ge.base),ge.error||(pub_sub.user.pub("stale_bases",!1),re(""))};return ce!==void 0?o$1("div",{style:{margin:10},children:o$1(BaseForm,{base:oe[ce],on_save_or_exit:()=>le(void 0)})}):o$1("div",{style:{margin:10},children:[o$1(AvailableBases,{on_choose:ee,on_click_edit:ge=>le(ge)}),pe>0&&fe&&o$1("hr",{}),fe&&o$1("div",{children:[o$1("h4",{children:["Create ",pe?"a new":"your first"," base"]}),o$1("input",{type:"text",value:se,onKeyUp:ge=>re(ge.currentTarget.value),onChange:ge=>re(ge.currentTarget.value),onBlur:ge=>re(ge.currentTarget.value)}),o$1("br",{}),o$1("input",{type:"button",disabled:!fe||!se.trim()||_e==="in_progress",onClick:fe,value:"Create new base"}),"  ",async_status_to_text(_e),"  ",ue&&o$1("input",{type:"button",onClick:()=>{ie({base_id:ue.id}),ee&&ee()},value:"Select new base"})]})]})}const StorageOptionsForm=connector$g(_StorageOptionsForm);function async_status_to_text(t){return t==="initial"?"":t==="in_progress"?"Creating...":t==="success"?"Created.":"Error"}function SelectStorage(t){const{on_close:ee}=t;return o$1(Modal,{title:o$1("div",{style:{margin:10},children:o$1("h2",{style:{display:"inline"},children:"Knowledge Bases"})}),size:"medium",on_close:ee&&(te=>{te==null||te.stopImmediatePropagation(),ee()}),child:o$1(StorageOptionsForm,{on_close:ee})})}const map_state$f=t=>({base_name:selector_chosen_base_name(t),needs_to_create_a_base:selector_needs_to_create_a_base(t),display_select_storage:t.controls.display_select_storage}),map_dispatch$9={set_or_toggle_display_select_storage:ACTIONS.controls.set_or_toggle_display_select_storage},connector$f=connect(map_state$f,map_dispatch$9);function _StorageInfo(t){const{needs_to_create_a_base:ee,display_select_storage:te,set_or_toggle_display_select_storage:ne}=t;return p$1(()=>{ee&&ne(!0)},[ee]),o$1(Typography,{component:"span",children:[o$1(Button$2,{id:"storage_info_button",color:"primary",disableElevation:!0,onClick:()=>ne(!0),size:"small",endIcon:o$1(default_1$6,{titleAccess:"Create and Select Knowledge Bases"}),style:{textTransform:"none"},variant:"contained",children:o$1("span",{class:"storage_name",children:t.base_name||"Choose store"})}),te&&o$1(SelectStorage,{on_close:ee?void 0:()=>ne(!1)})]})}const StorageInfo=connector$f(_StorageInfo);var AccountCircle={},_interopRequireDefault$3=interopRequireDefaultExports;Object.defineProperty(AccountCircle,"__esModule",{value:!0});var default_1$3=AccountCircle.default=void 0,_createSvgIcon$3=_interopRequireDefault$3(requireCreateSvgIcon()),_jsxRuntime$3=requireJsxRuntime(),_default$3=(0,_createSvgIcon$3.default)((0,_jsxRuntime$3.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"}),"AccountCircle");default_1$3=AccountCircle.default=_default$3;const no_user_name="(No user name)";var ExitToApp={},_interopRequireDefault$2=interopRequireDefaultExports;Object.defineProperty(ExitToApp,"__esModule",{value:!0});var default_1$2=ExitToApp.default=void 0,_createSvgIcon$2=_interopRequireDefault$2(requireCreateSvgIcon()),_jsxRuntime$2=requireJsxRuntime(),_default$2=(0,_createSvgIcon$2.default)((0,_jsxRuntime$2.jsx)("path",{d:"M10.09 15.59 11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"ExitToApp");default_1$2=ExitToApp.default=_default$2;const map_state$e=t=>{const{need_to_handle_password_recovery:ee}=t.user_info;return{user:t.user_info.user,need_to_handle_password_recovery:ee}},map_dispatch$8={set_user:ACTIONS.user_info.set_user,set_need_to_handle_password_recovery:ACTIONS.user_info.set_need_to_handle_password_recovery},connector$e=connect(map_state$e,map_dispatch$8);function _UserAccountInfoChangePasswordForm(t){const{on_close:ee,user:te,set_user:ne,need_to_handle_password_recovery:oe,set_need_to_handle_password_recovery:ie}=t,[se,re]=h$1(""),[_e,ae]=h$1(null);if(!te)return null;async function ce(){const ue=get_supabase(),de=te==null?void 0:te.email,me=await ue.auth.update({email:de,password:se});ae(me.error),me.error||(ne({user:me.user||void 0}),ie(!1),ee())}const le=use_styles$5();return o$1(FormGroup,{className:"section",children:[oe&&o$1("p",{children:"Please set a new password."}),o$1(Box,{className:le.root,children:[o$1(FormControl,{variant:"standard",children:o$1(TextField,{inputProps:{type:"password"},onBlur:ue=>re(ue.currentTarget.value),onChange:ue=>re(ue.currentTarget.value),onKeyUp:ue=>re(ue.currentTarget.value),label:"password",size:"small",value:se,variant:"outlined"})}),o$1(Box,{className:le.update_button_container,children:o$1(Button$2,{className:le.update_button,disabled:!(te!=null&&te.email)||!se,onClick:ce,variant:"contained",children:"Update password"})}),o$1(Box,{children:!oe&&o$1(Button$2,{variant:"contained",onClick:()=>{ee(),ae(null)},children:"Cancel"})})]}),o$1(DisplaySupabaseSessionError,{error:_e})]})}const use_styles$5=makeStyles(t=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),UserAccountInfoChangePasswordForm=connector$e(_UserAccountInfoChangePasswordForm),map_state$d=t=>{const{user:ee,users_by_id:te}=t.user_info;return{user:ee,users_by_id:te,need_to_set_user_name:selector_need_to_set_user_name(t)}},map_dispatch$7={},connector$d=connect(map_state$d,map_dispatch$7);function _UserAccountInfoChangeUsernameForm(t){const{on_close:ee,user:te,need_to_set_user_name:ne}=t,[oe,ie]=h$1(""),se=(t.users_by_id||{})[(te==null?void 0:te.id)||""],re=(se==null?void 0:se.name)||"";p$1(()=>ie(re),[re]);const[_e,ae]=h$1("initial"),ce=_e==="in_progress",[le,ue]=h$1(null);if(!te)return null;const{id:de}=te;async function me(){var ve;const fe=get_supabase();ae("in_progress");const{data:ge,error:he}=await fe.from("users").upsert({id:de,name:oe}).eq("id",de);ue(he),((ge&&((ve=ge[0])==null?void 0:ve.name))??void 0)&&pub_sub.user.pub("stale_users_by_id",!1),ae(he?"error":"success")}const pe=use_styles$4();return o$1(FormGroup,{className:"section",children:[o$1(Box,{className:pe.root,children:[o$1(FormControl,{variant:"standard",children:o$1(TextField,{disabled:ce,onChange:fe=>{ie(fe.currentTarget.value)},onBlur:fe=>{ie(fe.currentTarget.value)},placeholder:"Username",size:"small",value:oe,variant:"outlined"})}),o$1(Box,{className:pe.update_button_container,children:o$1(Button$2,{className:pe.update_button,disabled:!oe||ce,onClick:me,variant:"contained",children:[ne?"Set":"Change"," username"]})}),o$1(Box,{children:!ne&&o$1(Button$2,{variant:"contained",onClick:()=>{ee(),ue(null)},children:"Close"})})]}),ce&&"Saving...",_e==="success"&&"Saved.",o$1(DisplaySupabasePostgrestError,{error:le})]})}const use_styles$4=makeStyles(t=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},username_input:{borderTopRightRadius:0,borderBottomRightRadius:0},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),UserAccountInfoChangeUsernameForm=connector$d(_UserAccountInfoChangeUsernameForm),map_state$c=t=>{const{need_to_handle_password_recovery:ee}=t.user_info;return{user:t.user_info.user,user_name:selector_user_name(t),need_to_set_user_name:selector_need_to_set_user_name(t),need_to_handle_password_recovery:ee}},map_dispatch$6={set_user:ACTIONS.user_info.set_user},connector$c=connect(map_state$c,map_dispatch$6),use_styles$3=makeStyles(t=>({root:{margin:5},section:{display:"flex",justifyContent:"space-between",alignItems:"center"},logout_section:{flexBasis:"100%"},button:{marginBottom:5},label:{marginBottom:10}}));function _UserAccountInfoForm(t){const{user:ee,user_name:te,need_to_set_user_name:ne,need_to_handle_password_recovery:oe,set_user:ie}=t,[se,re]=h$1("initial"),[_e,ae]=h$1(null);if(console.log("user account info form need_to_set_user_name",ne,"form_state",se),p$1(()=>{ne&&re("updating_username")},[ne,se]),!ee)return null;if(se==="updating_password"||oe)return o$1(UserAccountInfoChangePasswordForm,{on_close:()=>re("initial")});if(se==="updating_username")return o$1(UserAccountInfoChangeUsernameForm,{on_close:()=>re("initial")});const ce=use_styles$3();return o$1(Box,{className:ce.root,children:[o$1(Box,{className:`${ce.section} ${ce.logout_section} section`,children:[o$1("p",{children:["Logged in with",o$1("strong",{children:[" ",ee.email," "]})]}),o$1(Box,{children:o$1(Button$2,{onClick:()=>save_and_optionally_signout(!0),variant:"contained",endIcon:o$1(default_1$2,{}),children:"Log out"})})]}),o$1(Box,{className:`${ce.section} section`,display:"flex",justifyContent:"space-between",children:[o$1(Typography,{component:"p",children:["User name ",o$1("strong",{children:te?`: ${te}`:""}),o$1("br",{}),o$1("small",{children:["user id:   ",ee.id]})]}),o$1(Box,{children:[o$1(Button$2,{className:ce.button,variant:"contained",onClick:()=>re("updating_username"),children:[ne?"Set":"Change"," username"]}),o$1("br",{}),o$1(Button$2,{variant:"contained",onClick:()=>re("updating_password"),children:"Change password"})]})]}),o$1(DisplaySupabaseSessionError,{error:_e})]})}const UserAccountInfoForm=connector$c(_UserAccountInfoForm);function UserAccountInfo(t){const{on_close:ee}=t;return o$1(Modal,{title:o$1("div",{style:{margin:10,textAlign:"center"},children:o$1("h2",{children:"User Account"})}),size:"medium",on_close:ee?te=>{te==null||te.stopImmediatePropagation(),ee()}:void 0,child:o$1("div",{style:{textAlign:"center"},children:o$1(UserAccountInfoForm,{on_close:ee})})})}const UserSigninRegisterForm$1="",map_state$b=t=>({}),map_dispatch$5={set_user:ACTIONS.user_info.set_user},connector$b=connect(map_state$b,map_dispatch$5);function _UserSigninRegisterForm(t){const{set_user:ee}=t,te=get_supabase(),[ne,oe]=h$1("initial"),[ie,se]=h$1(""),[re,_e]=h$1(""),[ae,ce]=h$1(null),[le,ue]=h$1(!1),[de,me]=h$1(!1);function pe(ve){se(ve),ue(!1)}function fe(ve){_e(ve),me(!1)}async function ge(){if(!ie||!re){ie||ue(!0),re||me(!0);return}const{user:ve,error:ye}=await te.auth.signUp({email:ie,password:re},{redirectTo:"https://datacurator.org/app/"});ce(ye),ye||oe("registered")}async function he(){if(!ie||!re){ie||ue(!0),re||me(!0);return}const{user:ve,error:ye}=await te.auth.signIn({email:ie,password:re});ce(ye),ee({user:ve||void 0})}async function be(){if(!ie){ue(!0),me(!1);return}const{data:ve,error:ye}=await te.auth.api.resetPasswordForEmail(ie);ce(ye),ye||oe("reset_password")}return ne==="initial"?o$1("div",{className:"section",children:[o$1("form",{children:[o$1("br",{}),o$1("br",{}),o$1("input",{type:"email",placeholder:"email",value:ie,onKeyUp:ve=>pe(ve.currentTarget.value),onChange:ve=>pe(ve.currentTarget.value),onBlur:ve=>pe(ve.currentTarget.value)}),o$1("div",{className:"error_form_input_empty "+(le?"":"inactive"),children:"Email required"}),o$1("br",{}),o$1("input",{type:"password",placeholder:"password",value:re,onKeyUp:ve=>fe(ve.currentTarget.value),onChange:ve=>fe(ve.currentTarget.value),onBlur:ve=>fe(ve.currentTarget.value)}),o$1("div",{className:"error_form_input_empty "+(de?"":"inactive"),children:"Password required"})]}),o$1("div",{children:[o$1("br",{}),o$1("input",{type:"button",onClick:he,value:"Signin"}),"  ",o$1("input",{type:"button",onClick:ge,value:"Register"}),o$1("br",{}),o$1("br",{}),o$1("input",{type:"button",onClick:be,value:"Forgot password?"}),o$1("br",{}),o$1("br",{})]}),o$1(DisplaySupabaseSessionError,{error:ae}),o$1("br",{})]}):ne==="reset_password"?o$1("div",{className:"section",children:[o$1("h3",{children:"Password reset"}),o$1("br",{}),!ae&&"Please check your email",o$1(DisplaySupabaseSessionError,{error:ae})]}):o$1("div",{className:"section",children:[o$1("h3",{children:"Registered"}),o$1("br",{}),"Please check your email"]})}const UserSigninRegisterForm=connector$b(_UserSigninRegisterForm);function UserSigninRegister(t){return o$1(Modal,{title:o$1("div",{style:{margin:10,textAlign:"center"},children:o$1("h2",{children:"Signin / Register"})}),size:"medium",on_close:t.on_close,child:o$1("div",{style:{textAlign:"center"},children:o$1(UserSigninRegisterForm,{})})})}const map_state$a=t=>({user:t.user_info.user,bases_by_id:t.user_info.bases_by_id,users_by_id:t.user_info.users_by_id,chosen_base_id:t.user_info.chosen_base_id,user_name:selector_user_name(t),need_to_set_user_name:selector_need_to_set_user_name(t)}),map_dispatch$4={},connector$a=connect(map_state$a,map_dispatch$4);function _UserInfo(t){const{user:ee,bases_by_id:te,users_by_id:ne,chosen_base_id:oe,user_name:ie,need_to_set_user_name:se}=t,re=!ne,[_e,ae]=h$1("hidden"),ce=_$d(ee),le=ie||no_user_name;return p$1(()=>{const ue=!ce.current&&ee;ce.current=ee;const de=te&&oe?!te[oe]:!1;ae(!ee&&de?"signin":re?"loading":se?"account_info":ue?"hidden":_e)},[ee,te,oe,re,se]),o$1("div",{children:[o$1(Button$2,{color:"primary",endIcon:o$1(default_1$3,{}),fullWidth:!0,disableElevation:!0,onClick:()=>ae(ee?"account_info":"signin"),size:"small",style:{textTransform:"none"},variant:"contained",children:o$1(Typography,{noWrap:!0,children:ee?le:re?"Loading":"Sign in"})}),_e==="signin"&&o$1(UserSigninRegister,{on_close:()=>ae("hidden")}),_e==="account_info"&&o$1(UserAccountInfo,{on_close:se?void 0:()=>ae("hidden")})]})}const UserInfo=connector$a(_UserInfo);var Save={},_interopRequireDefault$1=interopRequireDefaultExports;Object.defineProperty(Save,"__esModule",{value:!0});var default_1$1=Save.default=void 0,_createSvgIcon$1=_interopRequireDefault$1(requireCreateSvgIcon()),_jsxRuntime$1=requireJsxRuntime(),_default$1=(0,_createSvgIcon$1.default)((0,_jsxRuntime$1.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"}),"Save");default_1$1=Save.default=_default$1;const map_state$9=t=>({sync_state_specialised_objects:t.sync.specialised_objects,sync_state_bases:t.sync.bases,ready_for_writing:t.sync.ready_for_writing}),map_dispatch$3={update_sync_status:ACTIONS.sync.update_sync_status},connector$9=connect(map_state$9,map_dispatch$3);function _SyncInfo(t){const{sync_state_specialised_objects:ee,sync_state_bases:te,ready_for_writing:ne}=t,oe=ee.status==="FAILED"||te.status==="FAILED",ie=ee.status==="LOADING"||te.status==="LOADING",se=ee.status==="SAVING"||te.status==="SAVING",re=[ee.error_message,te.error_message].filter(is_defined).join(", "),_e=ie||se,ae=use_styles$2();let ce=sentence_case(ee.status||"");return te.status&&te.status!=="LOADED"&&te.status!=="SAVED"&&(ce+=te.status!==ee.status&&", "+sentence_case(te.status)||""),ce?o$1(Typography,{component:"span",children:o$1(Button$2,{className:ae.button,size:"small",disabled:!ne,onClick:async le=>{le.currentTarget.blur();const ue=get_store();await save_state(ue,!0)},startIcon:oe?o$1(default_1$4,{color:"error"}):o$1(default_1$1,{className:_e?"animate spinning":""}),title:oe?re:ce,children:[o$1(Typography,{className:`${ae.animate} ${ae.initially_shown} show`,color:oe?"error":"initial",component:"span",noWrap:!0,children:oe?"Failed!":ce}),o$1(Typography,{className:`${ae.animate} ${ae.initially_hidden} hide`,color:"initial",component:"span",noWrap:!0,children:oe?"Retry Now":"Save Now"}),o$1(Typography,{component:"span",children:" "})]})}):null}const SyncInfo=connector$9(_SyncInfo),use_styles$2=makeStyles(t=>({button:{textTransform:"none","&:hover .show":{fontSize:0},"&:focus .show":{fontSize:0},"&:hover .hide":{fontSize:"initial"},"&:focus .hide":{fontSize:"initial"}},animate:{transitionProperty:"all",transitionDuration:"0.23s"},initially_hidden:{fontSize:0},initially_shown:{fontSize:"initial"}})),HelpMenu$1="",map_state$8=t=>({show:t.display_options.show_help_menu}),map_dispatch$2={set_show_help_menu:ACTIONS.display.set_show_help_menu},connector$8=connect(map_state$8,map_dispatch$2);function _HelpMenu(t){const[ee,te]=h$1("kbd-shortcuts"),ne=oe=>(ie,se)=>{te(se?oe:!1)};return t.show?o$1(Modal,{size:"medium",title:"",on_close:()=>t.set_show_help_menu({show:!1}),child:o$1(Box,{p:10,children:[o$1(Typography,{component:"h1",variant:"h5",children:"Tips for using DataCurator"}),o$1(Accordion,{expanded:ee==="kbd-shortcuts",onChange:ne("kbd-shortcuts"),expandIcon:o$1(default_1$i,{}),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:"Commands / shortcuts"})}),o$1(AccordionDetails,{children:o$1(Box,{children:["These shortcuts only work when you are not editing a text field.  Some may only work when you are on the Map (Knowledge) canvas view.",shortcuts_list.map(oe=>o$1(ShortcutCommand,{...oe}))]})})]}),o$1(Accordion,{expanded:ee==="linking-tips",onChange:ne("linking-tips"),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:" Tips on Linking"})}),o$1(AccordionDetails,{children:o$1(Box,{children:tips_on_linking.map(oe=>o$1(Typography,{component:"p",paragraph:!0,children:oe}))})})]}),o$1(Accordion,{expanded:ee==="general-tips",onChange:ne("general-tips"),expandIcon:o$1(default_1$i,{}),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:"General tips"})}),o$1(AccordionDetails,{children:o$1(Box,{children:general_tips.map(oe=>o$1(Typography,{component:"p",paragraph:!0,children:oe}))})})]}),o$1(Accordion,{expanded:ee==="detailed-tips",onChange:ne("detailed-tips"),expandIcon:o$1(default_1$i,{}),children:[o$1(AccordionSummary,{children:o$1(Typography,{component:"h2",variant:"h6",children:"Detailed tips"})}),o$1(AccordionDetails,{children:o$1(Box,{children:detailed_tips.map(oe=>o$1(Typography,{component:"p",paragraph:!0,children:oe}))})})]})]})}):null}const HelpMenu=connector$8(_HelpMenu),tips_on_linking=[`Type "@@" in any text field to access a menu to link to any other component.
    This will insert the id of that component, e.g.  @@12345678-abcd-4123-abcd-1234567890ab.`,`Follow "@@some-id" with .url, .title and .description to get the attributes
    of that component e.g. "@@12345678-abcd-4123-abcd-1234567890ab.title".  Or if it has an
    associated knowledge view then add .map to go to that knowledge view.`,o$1("span",{children:["Markdown is available so you can use things like ",o$1("b",{children:"**some text**"}),'to make it bold once it is rendered during presentation mode. Other Markdown syntax like "1. some text" will give you numbered lists. See the full ',o$1("a",{href:"https: //www.markdownguide.org/basic-syntax/",children:"Markdown guide here"})]})],general_tips=[o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:'"Should" word usage'}),'If you find yourself writing states with "should", e.g. "People ',o$1("b",{children:"should"}),' listen more and be less reductionist" then you might consider separating this out into its 4 separate parts and phrasing as the positive or desired state.  Specifically:',o$1("ol",{children:[o$1("li",{children:`the attribute, e.g.: "People listen more and be less reductionist".  Note it is usually easier to express this as the desired state of the attribute instead of the pure attribute itself which is usually longer and less easy to work with: "People's ability to listen and what degree of complexity they can hold in their minds about different subjects".`}),o$1("li",{children:'the current value, e.g.: "False"'}),o$1("li",{children:"the other possibilities.  If the value is a boolean i.e. True/False then this can be skipped otherwise if it is a number or other type of value then add the other different possible values."}),o$1("li",{children:"the judgement or objective about the desired value, e.g.: create a judgement or objective node, target your state node, and choose the desired value via the comparator"})]})]}),o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:'"Action" node type versus "State"'}),"The action and state node types are very similar.  The former can be used to draw attention to the areas where you or a team member can have an effect on the project.  You can use actions to represent the activity of third party actors but this usually draws unwarranted attention to these components."]})],detailed_tips=[o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:"State subtypes"}),"There are three State subtypes:",o$1("ol",{children:[o$1("li",{children:"boolean, e.g. True / False"}),o$1("li",{children:"number"}),o$1("li",{children:"other"})]}),"Often you can represent the same attribute in different ways and this will depend on what level of detail is salient to the conversation / the model of the scenario you are interested in.",o$1("ol",{children:[o$1("li",{children:'a boolean, with title "The medical response was fast" or "The medical response time was adequate"'}),o$1("li",{children:'"other" with title "The medical response", with values of "Very slow", "Slow", "Medium", "Fast", "Very fast" etc.'}),o$1("li",{children:'"number" with title "The medical response speed", where the value perhaps represents the time in minutes until aid was first administered.'})]})]}),o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:"Multidimensional states"}),'Often there can be attributes / concepts which have two dimensions to them which are salient together, e.g. "The medical response was fast and effective".  These can be modelled using states with titles and subtypes in many ways, for example:',o$1("ol",{children:[o$1("li",{children:'a boolean, with title "The medical response was (adequately) fast and effective"'}),o$1("li",{children:'"number" with title "The medical response speed and effectiveness", where the value is derived from some formula to calculate a single number based of the two attributes of speed and effectiveness.'})]}),'If the concept later needs to be analysed / comprehended / explored in greater detail it can be decomposed.  Either it could be change to a subtype of "other" with title "The medical response speed and effectiveness", with values of "fast and effective", "fast but ineffective", "slow but effective", "slow and ineffective".  Or replaced by two new seperate states, one for "Medical response speed" and one for "Medical response effectiveness".  In the latter case deleting the first node from the knowledge views would be best.  In the former case, ',o$1("a",{href:"https: //github.com/centerofci/data-curator2/issues/36",children:"versioning the whole component"})," would make this easier from a user's perspective."]}),o$1("div",{children:[o$1(Typography,{component:"h3",variant:"h6",children:"Temporal uncertainty"}),o$1("p",{children:'Part of making predictions is knowing when some event may occur.  For this we have a very simple "Temporal Uncertainty" form that has three fields: Min, Expected and Max datetime.'}),o$1("p",{children:"It's important to note that this represents a single event and not a distribution of similar events.  It is also not directly the uncertain temporal range a state might exist over.  i.e. the min is the earliest when the event can occur.  This is easier to understand if you talk about the max value.  The max is the latest the event can occur.  This means the state (associate with state transition events) will occur from the max of an event marking its existence but might occur earlier: up to an including the min datetime of the event."}),o$1("p",{children:"A concrete example: you will switch on the light in 1 minute (min), likely in 5 minutes (expected) or at most in 10 minutes (max).  But this does not mean the room will be lit from 1 minutes time to 10 minutes time."}),o$1("p",{children:"The current form is also woefully simplistic for a lot of the uncertain temporal distributions you have inside your head, use almost all the time, use seamlessly, unconsciously, and yet are vital to coordinated effective collaboration, for (complex) interventions."}),o$1("p",{children:"For example: when are you going to get funding for project X, when will have a hire for position Y, when will your change job, when will you next go shopping (if it's not raining AND someone else not gone yet AND time after 7 am AND time less 10 am then ...)."})]})];var Close={},_interopRequireDefault=interopRequireDefaultExports;Object.defineProperty(Close,"__esModule",{value:!0});var default_1=Close.default=void 0,_createSvgIcon=_interopRequireDefault(requireCreateSvgIcon()),_jsxRuntime=requireJsxRuntime(),_default=(0,_createSvgIcon.default)((0,_jsxRuntime.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");default_1=Close.default=_default;const map_state$7=t=>({display_side_panel:t.controls.display_side_panel}),map_dispatch$1={set_or_toggle_display_side_panel:ACTIONS.controls.set_or_toggle_display_side_panel},connector$7=connect(map_state$7,map_dispatch$1);function _SidePanelOrMenuButton(t){return o$1(IconButton,{"aria-label":"open side panel",color:"inherit",edge:"end",onClick:t.set_or_toggle_display_side_panel,size:"small",children:t.display_side_panel?o$1(default_1,{}):o$1(default_1$c,{})})}const SidePanelOrMenuButton=connector$7(_SidePanelOrMenuButton);function ActiveUserWidget(){return use_styles$1(),h$1(!1),null}withStyles(t=>({badge:{top:2,right:"-0.42em",zIndex:1}}))(Badge);const use_styles$1=makeStyles(t=>({button:{display:"inline-block",marginRight:"1em",border:`1px ${t.palette.divider} solid`},icon:{position:"relative",zIndex:10}})),ALIAS=Symbol.for("yaml.alias"),DOC=Symbol.for("yaml.document"),MAP=Symbol.for("yaml.map"),PAIR=Symbol.for("yaml.pair"),SCALAR$1=Symbol.for("yaml.scalar"),SEQ=Symbol.for("yaml.seq"),NODE_TYPE=Symbol.for("yaml.node.type"),isAlias=t=>!!t&&typeof t=="object"&&t[NODE_TYPE]===ALIAS,isDocument=t=>!!t&&typeof t=="object"&&t[NODE_TYPE]===DOC,isMap=t=>!!t&&typeof t=="object"&&t[NODE_TYPE]===MAP,isPair=t=>!!t&&typeof t=="object"&&t[NODE_TYPE]===PAIR,isScalar=t=>!!t&&typeof t=="object"&&t[NODE_TYPE]===SCALAR$1,isSeq=t=>!!t&&typeof t=="object"&&t[NODE_TYPE]===SEQ;function isCollection(t){if(t&&typeof t=="object")switch(t[NODE_TYPE]){case MAP:case SEQ:return!0}return!1}function isNode(t){if(t&&typeof t=="object")switch(t[NODE_TYPE]){case ALIAS:case MAP:case SCALAR$1:case SEQ:return!0}return!1}const hasAnchor=t=>(isScalar(t)||isCollection(t))&&!!t.anchor,BREAK=Symbol("break visit"),SKIP=Symbol("skip children"),REMOVE=Symbol("remove node");function visit(t,ee){const te=initVisitor(ee);isDocument(t)?visit_(null,t.contents,te,Object.freeze([t]))===REMOVE&&(t.contents=null):visit_(null,t,te,Object.freeze([]))}visit.BREAK=BREAK;visit.SKIP=SKIP;visit.REMOVE=REMOVE;function visit_(t,ee,te,ne){const oe=callVisitor(t,ee,te,ne);if(isNode(oe)||isPair(oe))return replaceNode(t,ne,oe),visit_(t,oe,te,ne);if(typeof oe!="symbol"){if(isCollection(ee)){ne=Object.freeze(ne.concat(ee));for(let ie=0;ie<ee.items.length;++ie){const se=visit_(ie,ee.items[ie],te,ne);if(typeof se=="number")ie=se-1;else{if(se===BREAK)return BREAK;se===REMOVE&&(ee.items.splice(ie,1),ie-=1)}}}else if(isPair(ee)){ne=Object.freeze(ne.concat(ee));const ie=visit_("key",ee.key,te,ne);if(ie===BREAK)return BREAK;ie===REMOVE&&(ee.key=null);const se=visit_("value",ee.value,te,ne);if(se===BREAK)return BREAK;se===REMOVE&&(ee.value=null)}}return oe}function initVisitor(t){return typeof t=="object"&&(t.Collection||t.Node||t.Value)?Object.assign({Alias:t.Node,Map:t.Node,Scalar:t.Node,Seq:t.Node},t.Value&&{Map:t.Value,Scalar:t.Value,Seq:t.Value},t.Collection&&{Map:t.Collection,Seq:t.Collection},t):t}function callVisitor(t,ee,te,ne){var oe,ie,se,re,_e;if(typeof te=="function")return te(t,ee,ne);if(isMap(ee))return(oe=te.Map)==null?void 0:oe.call(te,t,ee,ne);if(isSeq(ee))return(ie=te.Seq)==null?void 0:ie.call(te,t,ee,ne);if(isPair(ee))return(se=te.Pair)==null?void 0:se.call(te,t,ee,ne);if(isScalar(ee))return(re=te.Scalar)==null?void 0:re.call(te,t,ee,ne);if(isAlias(ee))return(_e=te.Alias)==null?void 0:_e.call(te,t,ee,ne)}function replaceNode(t,ee,te){const ne=ee[ee.length-1];if(isCollection(ne))ne.items[t]=te;else if(isPair(ne))t==="key"?ne.key=te:ne.value=te;else if(isDocument(ne))ne.contents=te;else{const oe=isAlias(ne)?"alias":"scalar";throw new Error(`Cannot replace node with ${oe} parent`)}}const escapeChars={"!":"%21",",":"%2C","[":"%5B","]":"%5D","{":"%7B","}":"%7D"},escapeTagName=t=>t.replace(/[!,[\]{}]/g,ee=>escapeChars[ee]);class Directives{constructor(ee,te){this.docStart=null,this.docEnd=!1,this.yaml=Object.assign({},Directives.defaultYaml,ee),this.tags=Object.assign({},Directives.defaultTags,te)}clone(){const ee=new Directives(this.yaml,this.tags);return ee.docStart=this.docStart,ee}atDocument(){const ee=new Directives(this.yaml,this.tags);switch(this.yaml.version){case"1.1":this.atNextDocument=!0;break;case"1.2":this.atNextDocument=!1,this.yaml={explicit:Directives.defaultYaml.explicit,version:"1.2"},this.tags=Object.assign({},Directives.defaultTags);break}return ee}add(ee,te){this.atNextDocument&&(this.yaml={explicit:Directives.defaultYaml.explicit,version:"1.1"},this.tags=Object.assign({},Directives.defaultTags),this.atNextDocument=!1);const ne=ee.trim().split(/[ \t]+/),oe=ne.shift();switch(oe){case"%TAG":{if(ne.length!==2&&(te(0,"%TAG directive should contain exactly two parts"),ne.length<2))return!1;const[ie,se]=ne;return this.tags[ie]=se,!0}case"%YAML":{if(this.yaml.explicit=!0,ne.length!==1)return te(0,"%YAML directive should contain exactly one part"),!1;const[ie]=ne;if(ie==="1.1"||ie==="1.2")return this.yaml.version=ie,!0;{const se=/^\d+\.\d+$/.test(ie);return te(6,`Unsupported YAML version ${ie}`,se),!1}}default:return te(0,`Unknown directive ${oe}`,!0),!1}}tagName(ee,te){if(ee==="!")return"!";if(ee[0]!=="!")return te(`Not a valid tag: ${ee}`),null;if(ee[1]==="<"){const se=ee.slice(2,-1);return se==="!"||se==="!!"?(te(`Verbatim tags aren't resolved, so ${ee} is invalid.`),null):(ee[ee.length-1]!==">"&&te("Verbatim tags must end with a >"),se)}const[,ne,oe]=ee.match(/^(.*!)([^!]*)$/);oe||te(`The ${ee} tag has no suffix`);const ie=this.tags[ne];return ie?ie+decodeURIComponent(oe):ne==="!"?ee:(te(`Could not resolve tag: ${ee}`),null)}tagString(ee){for(const[te,ne]of Object.entries(this.tags))if(ee.startsWith(ne))return te+escapeTagName(ee.substring(ne.length));return ee[0]==="!"?ee:`!<${ee}>`}toString(ee){const te=this.yaml.explicit?[`%YAML ${this.yaml.version||"1.2"}`]:[],ne=Object.entries(this.tags);let oe;if(ee&&ne.length>0&&isNode(ee.contents)){const ie={};visit(ee.contents,(se,re)=>{isNode(re)&&re.tag&&(ie[re.tag]=!0)}),oe=Object.keys(ie)}else oe=[];for(const[ie,se]of ne)ie==="!!"&&se==="tag:yaml.org,2002:"||(!ee||oe.some(re=>re.startsWith(se)))&&te.push(`%TAG ${ie} ${se}`);return te.join(`
`)}}Directives.defaultYaml={explicit:!1,version:"1.2"};Directives.defaultTags={"!!":"tag:yaml.org,2002:"};function anchorIsValid(t){if(/[\x00-\x19\s,[\]{}]/.test(t)){const te=`Anchor must not contain whitespace or control characters: ${JSON.stringify(t)}`;throw new Error(te)}return!0}function anchorNames(t){const ee=new Set;return visit(t,{Value(te,ne){ne.anchor&&ee.add(ne.anchor)}}),ee}function findNewAnchor(t,ee){for(let te=1;;++te){const ne=`${t}${te}`;if(!ee.has(ne))return ne}}function createNodeAnchors(t,ee){const te=[],ne=new Map;let oe=null;return{onAnchor:ie=>{te.push(ie),oe||(oe=anchorNames(t));const se=findNewAnchor(ee,oe);return oe.add(se),se},setAnchors:()=>{for(const ie of te){const se=ne.get(ie);if(typeof se=="object"&&se.anchor&&(isScalar(se.node)||isCollection(se.node)))se.node.anchor=se.anchor;else{const re=new Error("Failed to resolve repeated object (this should not happen)");throw re.source=ie,re}}},sourceObjects:ne}}function applyReviver(t,ee,te,ne){if(ne&&typeof ne=="object")if(Array.isArray(ne))for(let oe=0,ie=ne.length;oe<ie;++oe){const se=ne[oe],re=applyReviver(t,ne,String(oe),se);re===void 0?delete ne[oe]:re!==se&&(ne[oe]=re)}else if(ne instanceof Map)for(const oe of Array.from(ne.keys())){const ie=ne.get(oe),se=applyReviver(t,ne,oe,ie);se===void 0?ne.delete(oe):se!==ie&&ne.set(oe,se)}else if(ne instanceof Set)for(const oe of Array.from(ne)){const ie=applyReviver(t,ne,oe,oe);ie===void 0?ne.delete(oe):ie!==oe&&(ne.delete(oe),ne.add(ie))}else for(const[oe,ie]of Object.entries(ne)){const se=applyReviver(t,ne,oe,ie);se===void 0?delete ne[oe]:se!==ie&&(ne[oe]=se)}return t.call(ee,te,ne)}function toJS(t,ee,te){if(Array.isArray(t))return t.map((ne,oe)=>toJS(ne,String(oe),te));if(t&&typeof t.toJSON=="function"){if(!te||!hasAnchor(t))return t.toJSON(ee,te);const ne={aliasCount:0,count:1,res:void 0};te.anchors.set(t,ne),te.onCreate=ie=>{ne.res=ie,delete te.onCreate};const oe=t.toJSON(ee,te);return te.onCreate&&te.onCreate(oe),oe}return typeof t=="bigint"&&!(te!=null&&te.keep)?Number(t):t}class NodeBase{constructor(ee){Object.defineProperty(this,NODE_TYPE,{value:ee})}clone(){const ee=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return this.range&&(ee.range=this.range.slice()),ee}toJS(ee,{mapAsMap:te,maxAliasCount:ne,onAnchor:oe,reviver:ie}={}){if(!isDocument(ee))throw new TypeError("A document argument is required");const se={anchors:new Map,doc:ee,keep:!0,mapAsMap:te===!0,mapKeyWarned:!1,maxAliasCount:typeof ne=="number"?ne:100},re=toJS(this,"",se);if(typeof oe=="function")for(const{count:_e,res:ae}of se.anchors.values())oe(ae,_e);return typeof ie=="function"?applyReviver(ie,{"":re},"",re):re}}class Alias extends NodeBase{constructor(ee){super(ALIAS),this.source=ee,Object.defineProperty(this,"tag",{set(){throw new Error("Alias nodes cannot have tags")}})}resolve(ee){let te;return visit(ee,{Node:(ne,oe)=>{if(oe===this)return visit.BREAK;oe.anchor===this.source&&(te=oe)}}),te}toJSON(ee,te){if(!te)return{source:this.source};const{anchors:ne,doc:oe,maxAliasCount:ie}=te,se=this.resolve(oe);if(!se){const _e=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new ReferenceError(_e)}let re=ne.get(se);if(re||(toJS(se,null,te),re=ne.get(se)),!re||re.res===void 0){const _e="This should not happen: Alias anchor was not resolved?";throw new ReferenceError(_e)}if(ie>=0&&(re.count+=1,re.aliasCount===0&&(re.aliasCount=getAliasCount(oe,se,ne)),re.count*re.aliasCount>ie)){const _e="Excessive alias count indicates a resource exhaustion attack";throw new ReferenceError(_e)}return re.res}toString(ee,te,ne){const oe=`*${this.source}`;if(ee){if(anchorIsValid(this.source),ee.options.verifyAliasOrder&&!ee.anchors.has(this.source)){const ie=`Unresolved alias (the anchor must be set before the alias): ${this.source}`;throw new Error(ie)}if(ee.implicitKey)return`${oe} `}return oe}}function getAliasCount(t,ee,te){if(isAlias(ee)){const ne=ee.resolve(t),oe=te&&ne&&te.get(ne);return oe?oe.count*oe.aliasCount:0}else if(isCollection(ee)){let ne=0;for(const oe of ee.items){const ie=getAliasCount(t,oe,te);ie>ne&&(ne=ie)}return ne}else if(isPair(ee)){const ne=getAliasCount(t,ee.key,te),oe=getAliasCount(t,ee.value,te);return Math.max(ne,oe)}return 1}const isScalarValue=t=>!t||typeof t!="function"&&typeof t!="object";class Scalar extends NodeBase{constructor(ee){super(SCALAR$1),this.value=ee}toJSON(ee,te){return te!=null&&te.keep?this.value:toJS(this.value,ee,te)}toString(){return String(this.value)}}Scalar.BLOCK_FOLDED="BLOCK_FOLDED";Scalar.BLOCK_LITERAL="BLOCK_LITERAL";Scalar.PLAIN="PLAIN";Scalar.QUOTE_DOUBLE="QUOTE_DOUBLE";Scalar.QUOTE_SINGLE="QUOTE_SINGLE";const defaultTagPrefix="tag:yaml.org,2002:";function findTagObject(t,ee,te){if(ee){const ne=te.filter(ie=>ie.tag===ee),oe=ne.find(ie=>!ie.format)??ne[0];if(!oe)throw new Error(`Tag ${ee} not found`);return oe}return te.find(ne=>{var oe;return((oe=ne.identify)==null?void 0:oe.call(ne,t))&&!ne.format})}function createNode(t,ee,te){var le,ue,de;if(isDocument(t)&&(t=t.contents),isNode(t))return t;if(isPair(t)){const me=(ue=(le=te.schema[MAP]).createNode)==null?void 0:ue.call(le,te.schema,null,te);return me.items.push(t),me}(t instanceof String||t instanceof Number||t instanceof Boolean||typeof BigInt<"u"&&t instanceof BigInt)&&(t=t.valueOf());const{aliasDuplicateObjects:ne,onAnchor:oe,onTagObj:ie,schema:se,sourceObjects:re}=te;let _e;if(ne&&t&&typeof t=="object"){if(_e=re.get(t),_e)return _e.anchor||(_e.anchor=oe(t)),new Alias(_e.anchor);_e={anchor:null,node:null},re.set(t,_e)}ee!=null&&ee.startsWith("!!")&&(ee=defaultTagPrefix+ee.slice(2));let ae=findTagObject(t,ee,se.tags);if(!ae){if(t&&typeof t.toJSON=="function"&&(t=t.toJSON()),!t||typeof t!="object"){const me=new Scalar(t);return _e&&(_e.node=me),me}ae=t instanceof Map?se[MAP]:Symbol.iterator in Object(t)?se[SEQ]:se[MAP]}ie&&(ie(ae),delete te.onTagObj);const ce=ae!=null&&ae.createNode?ae.createNode(te.schema,t,te):typeof((de=ae==null?void 0:ae.nodeClass)==null?void 0:de.from)=="function"?ae.nodeClass.from(te.schema,t,te):new Scalar(t);return ee?ce.tag=ee:ae.default||(ce.tag=ae.tag),_e&&(_e.node=ce),ce}function collectionFromPath(t,ee,te){let ne=te;for(let oe=ee.length-1;oe>=0;--oe){const ie=ee[oe];if(typeof ie=="number"&&Number.isInteger(ie)&&ie>=0){const se=[];se[ie]=ne,ne=se}else ne=new Map([[ie,ne]])}return createNode(ne,void 0,{aliasDuplicateObjects:!1,keepUndefined:!1,onAnchor:()=>{throw new Error("This should not happen, please report a bug.")},schema:t,sourceObjects:new Map})}const isEmptyPath=t=>t==null||typeof t=="object"&&!!t[Symbol.iterator]().next().done;class Collection extends NodeBase{constructor(ee,te){super(ee),Object.defineProperty(this,"schema",{value:te,configurable:!0,enumerable:!1,writable:!0})}clone(ee){const te=Object.create(Object.getPrototypeOf(this),Object.getOwnPropertyDescriptors(this));return ee&&(te.schema=ee),te.items=te.items.map(ne=>isNode(ne)||isPair(ne)?ne.clone(ee):ne),this.range&&(te.range=this.range.slice()),te}addIn(ee,te){if(isEmptyPath(ee))this.add(te);else{const[ne,...oe]=ee,ie=this.get(ne,!0);if(isCollection(ie))ie.addIn(oe,te);else if(ie===void 0&&this.schema)this.set(ne,collectionFromPath(this.schema,oe,te));else throw new Error(`Expected YAML collection at ${ne}. Remaining path: ${oe}`)}}deleteIn(ee){const[te,...ne]=ee;if(ne.length===0)return this.delete(te);const oe=this.get(te,!0);if(isCollection(oe))return oe.deleteIn(ne);throw new Error(`Expected YAML collection at ${te}. Remaining path: ${ne}`)}getIn(ee,te){const[ne,...oe]=ee,ie=this.get(ne,!0);return oe.length===0?!te&&isScalar(ie)?ie.value:ie:isCollection(ie)?ie.getIn(oe,te):void 0}hasAllNullValues(ee){return this.items.every(te=>{if(!isPair(te))return!1;const ne=te.value;return ne==null||ee&&isScalar(ne)&&ne.value==null&&!ne.commentBefore&&!ne.comment&&!ne.tag})}hasIn(ee){const[te,...ne]=ee;if(ne.length===0)return this.has(te);const oe=this.get(te,!0);return isCollection(oe)?oe.hasIn(ne):!1}setIn(ee,te){const[ne,...oe]=ee;if(oe.length===0)this.set(ne,te);else{const ie=this.get(ne,!0);if(isCollection(ie))ie.setIn(oe,te);else if(ie===void 0&&this.schema)this.set(ne,collectionFromPath(this.schema,oe,te));else throw new Error(`Expected YAML collection at ${ne}. Remaining path: ${oe}`)}}}Collection.maxFlowStringSingleLineLength=60;const stringifyComment=t=>t.replace(/^(?!$)(?: $)?/gm,"#");function indentComment(t,ee){return/^\n+$/.test(t)?t.substring(1):ee?t.replace(/^(?! *$)/gm,ee):t}const lineComment=(t,ee,te)=>t.endsWith(`
`)?indentComment(te,ee):te.includes(`
`)?`
`+indentComment(te,ee):(t.endsWith(" ")?"":" ")+te,FOLD_FLOW="flow",FOLD_BLOCK="block",FOLD_QUOTED="quoted";function foldFlowLines(t,ee,te="flow",{indentAtStart:ne,lineWidth:oe=80,minContentWidth:ie=20,onFold:se,onOverflow:re}={}){if(!oe||oe<0)return t;const _e=Math.max(1+ie,1+oe-ee.length);if(t.length<=_e)return t;const ae=[],ce={};let le=oe-ee.length;typeof ne=="number"&&(ne>oe-Math.max(2,ie)?ae.push(0):le=oe-ne);let ue,de,me=!1,pe=-1,fe=-1,ge=-1;te===FOLD_BLOCK&&(pe=consumeMoreIndentedLines(t,pe),pe!==-1&&(le=pe+_e));for(let be;be=t[pe+=1];){if(te===FOLD_QUOTED&&be==="\\"){switch(fe=pe,t[pe+1]){case"x":pe+=3;break;case"u":pe+=5;break;case"U":pe+=9;break;default:pe+=1}ge=pe}if(be===`
`)te===FOLD_BLOCK&&(pe=consumeMoreIndentedLines(t,pe)),le=pe+_e,ue=void 0;else{if(be===" "&&de&&de!==" "&&de!==`
`&&de!=="	"){const ve=t[pe+1];ve&&ve!==" "&&ve!==`
`&&ve!=="	"&&(ue=pe)}if(pe>=le)if(ue)ae.push(ue),le=ue+_e,ue=void 0;else if(te===FOLD_QUOTED){for(;de===" "||de==="	";)de=be,be=t[pe+=1],me=!0;const ve=pe>ge+1?pe-2:fe-1;if(ce[ve])return t;ae.push(ve),ce[ve]=!0,le=ve+_e,ue=void 0}else me=!0}de=be}if(me&&re&&re(),ae.length===0)return t;se&&se();let he=t.slice(0,ae[0]);for(let be=0;be<ae.length;++be){const ve=ae[be],ye=ae[be+1]||t.length;ve===0?he=`
${ee}${t.slice(0,ye)}`:(te===FOLD_QUOTED&&ce[ve]&&(he+=`${t[ve]}\\`),he+=`
${ee}${t.slice(ve+1,ye)}`)}return he}function consumeMoreIndentedLines(t,ee){let te=t[ee+1];for(;te===" "||te==="	";){do te=t[ee+=1];while(te&&te!==`
`);te=t[ee+1]}return ee}const getFoldOptions=(t,ee)=>({indentAtStart:ee?t.indent.length:t.indentAtStart,lineWidth:t.options.lineWidth,minContentWidth:t.options.minContentWidth}),containsDocumentMarker=t=>/^(%|---|\.\.\.)/m.test(t);function lineLengthOverLimit(t,ee,te){if(!ee||ee<0)return!1;const ne=ee-te,oe=t.length;if(oe<=ne)return!1;for(let ie=0,se=0;ie<oe;++ie)if(t[ie]===`
`){if(ie-se>ne)return!0;if(se=ie+1,oe-se<=ne)return!1}return!0}function doubleQuotedString(t,ee){const te=JSON.stringify(t);if(ee.options.doubleQuotedAsJSON)return te;const{implicitKey:ne}=ee,oe=ee.options.doubleQuotedMinMultiLineLength,ie=ee.indent||(containsDocumentMarker(t)?"  ":"");let se="",re=0;for(let _e=0,ae=te[_e];ae;ae=te[++_e])if(ae===" "&&te[_e+1]==="\\"&&te[_e+2]==="n"&&(se+=te.slice(re,_e)+"\\ ",_e+=1,re=_e,ae="\\"),ae==="\\")switch(te[_e+1]){case"u":{se+=te.slice(re,_e);const ce=te.substr(_e+2,4);switch(ce){case"0000":se+="\\0";break;case"0007":se+="\\a";break;case"000b":se+="\\v";break;case"001b":se+="\\e";break;case"0085":se+="\\N";break;case"00a0":se+="\\_";break;case"2028":se+="\\L";break;case"2029":se+="\\P";break;default:ce.substr(0,2)==="00"?se+="\\x"+ce.substr(2):se+=te.substr(_e,6)}_e+=5,re=_e+1}break;case"n":if(ne||te[_e+2]==='"'||te.length<oe)_e+=1;else{for(se+=te.slice(re,_e)+`

`;te[_e+2]==="\\"&&te[_e+3]==="n"&&te[_e+4]!=='"';)se+=`
`,_e+=2;se+=ie,te[_e+2]===" "&&(se+="\\"),_e+=1,re=_e+1}break;default:_e+=1}return se=re?se+te.slice(re):te,ne?se:foldFlowLines(se,ie,FOLD_QUOTED,getFoldOptions(ee,!1))}function singleQuotedString(t,ee){if(ee.options.singleQuote===!1||ee.implicitKey&&t.includes(`
`)||/[ \t]\n|\n[ \t]/.test(t))return doubleQuotedString(t,ee);const te=ee.indent||(containsDocumentMarker(t)?"  ":""),ne="'"+t.replace(/'/g,"''").replace(/\n+/g,`$&
${te}`)+"'";return ee.implicitKey?ne:foldFlowLines(ne,te,FOLD_FLOW,getFoldOptions(ee,!1))}function quotedString(t,ee){const{singleQuote:te}=ee.options;let ne;if(te===!1)ne=doubleQuotedString;else{const oe=t.includes('"'),ie=t.includes("'");oe&&!ie?ne=singleQuotedString:ie&&!oe?ne=doubleQuotedString:ne=te?singleQuotedString:doubleQuotedString}return ne(t,ee)}let blockEndNewlines;try{blockEndNewlines=new RegExp(`(^|(?<!
))
+(?!
|$)`,"g")}catch{blockEndNewlines=/\n+(?!\n|$)/g}function blockString({comment:t,type:ee,value:te},ne,oe,ie){const{blockQuote:se,commentString:re,lineWidth:_e}=ne.options;if(!se||/\n[\t ]+$/.test(te)||/^\s*$/.test(te))return quotedString(te,ne);const ae=ne.indent||(ne.forceBlockIndent||containsDocumentMarker(te)?"  ":""),ce=se==="literal"?!0:se==="folded"||ee===Scalar.BLOCK_FOLDED?!1:ee===Scalar.BLOCK_LITERAL?!0:!lineLengthOverLimit(te,_e,ae.length);if(!te)return ce?`|
`:`>
`;let le,ue;for(ue=te.length;ue>0;--ue){const we=te[ue-1];if(we!==`
`&&we!=="	"&&we!==" ")break}let de=te.substring(ue);const me=de.indexOf(`
`);me===-1?le="-":te===de||me!==de.length-1?(le="+",ie&&ie()):le="",de&&(te=te.slice(0,-de.length),de[de.length-1]===`
`&&(de=de.slice(0,-1)),de=de.replace(blockEndNewlines,`$&${ae}`));let pe=!1,fe,ge=-1;for(fe=0;fe<te.length;++fe){const we=te[fe];if(we===" ")pe=!0;else if(we===`
`)ge=fe;else break}let he=te.substring(0,ge<fe?ge+1:fe);he&&(te=te.substring(he.length),he=he.replace(/\n+/g,`$&${ae}`));let ve=(ce?"|":">")+(pe?ae?"2":"1":"")+le;if(t&&(ve+=" "+re(t.replace(/ ?[\r\n]+/g," ")),oe&&oe()),ce)return te=te.replace(/\n+/g,`$&${ae}`),`${ve}
${ae}${he}${te}${de}`;te=te.replace(/\n+/g,`
$&`).replace(/(?:^|\n)([\t ].*)(?:([\n\t ]*)\n(?![\n\t ]))?/g,"$1$2").replace(/\n+/g,`$&${ae}`);const ye=foldFlowLines(`${he}${te}${de}`,ae,FOLD_BLOCK,getFoldOptions(ne,!0));return`${ve}
${ae}${ye}`}function plainString(t,ee,te,ne){const{type:oe,value:ie}=t,{actualString:se,implicitKey:re,indent:_e,indentStep:ae,inFlow:ce}=ee;if(re&&/[\n[\]{},]/.test(ie)||ce&&/[[\]{},]/.test(ie))return quotedString(ie,ee);if(!ie||/^[\n\t ,[\]{}#&*!|>'"%@`]|^[?-]$|^[?-][ \t]|[\n:][ \t]|[ \t]\n|[\n\t ]#|[\n\t :]$/.test(ie))return re||ce||!ie.includes(`
`)?quotedString(ie,ee):blockString(t,ee,te,ne);if(!re&&!ce&&oe!==Scalar.PLAIN&&ie.includes(`
`))return blockString(t,ee,te,ne);if(containsDocumentMarker(ie)){if(_e==="")return ee.forceBlockIndent=!0,blockString(t,ee,te,ne);if(re&&_e===ae)return quotedString(ie,ee)}const le=ie.replace(/\n+/g,`$&
${_e}`);if(se){const ue=pe=>{var fe;return pe.default&&pe.tag!=="tag:yaml.org,2002:str"&&((fe=pe.test)==null?void 0:fe.test(le))},{compat:de,tags:me}=ee.doc.schema;if(me.some(ue)||de!=null&&de.some(ue))return quotedString(ie,ee)}return re?le:foldFlowLines(le,_e,FOLD_FLOW,getFoldOptions(ee,!1))}function stringifyString(t,ee,te,ne){const{implicitKey:oe,inFlow:ie}=ee,se=typeof t.value=="string"?t:Object.assign({},t,{value:String(t.value)});let{type:re}=t;re!==Scalar.QUOTE_DOUBLE&&/[\x00-\x08\x0b-\x1f\x7f-\x9f\u{D800}-\u{DFFF}]/u.test(se.value)&&(re=Scalar.QUOTE_DOUBLE);const _e=ce=>{switch(ce){case Scalar.BLOCK_FOLDED:case Scalar.BLOCK_LITERAL:return oe||ie?quotedString(se.value,ee):blockString(se,ee,te,ne);case Scalar.QUOTE_DOUBLE:return doubleQuotedString(se.value,ee);case Scalar.QUOTE_SINGLE:return singleQuotedString(se.value,ee);case Scalar.PLAIN:return plainString(se,ee,te,ne);default:return null}};let ae=_e(re);if(ae===null){const{defaultKeyType:ce,defaultStringType:le}=ee.options,ue=oe&&ce||le;if(ae=_e(ue),ae===null)throw new Error(`Unsupported default string type ${ue}`)}return ae}function createStringifyContext(t,ee){const te=Object.assign({blockQuote:!0,commentString:stringifyComment,defaultKeyType:null,defaultStringType:"PLAIN",directives:null,doubleQuotedAsJSON:!1,doubleQuotedMinMultiLineLength:40,falseStr:"false",flowCollectionPadding:!0,indentSeq:!0,lineWidth:80,minContentWidth:20,nullStr:"null",simpleKeys:!1,singleQuote:null,trueStr:"true",verifyAliasOrder:!0},t.schema.toStringOptions,ee);let ne;switch(te.collectionStyle){case"block":ne=!1;break;case"flow":ne=!0;break;default:ne=null}return{anchors:new Set,doc:t,flowCollectionPadding:te.flowCollectionPadding?" ":"",indent:"",indentStep:typeof te.indent=="number"?" ".repeat(te.indent):"  ",inFlow:ne,options:te}}function getTagObject(t,ee){var oe;if(ee.tag){const ie=t.filter(se=>se.tag===ee.tag);if(ie.length>0)return ie.find(se=>se.format===ee.format)??ie[0]}let te,ne;if(isScalar(ee)){ne=ee.value;const ie=t.filter(se=>{var re;return(re=se.identify)==null?void 0:re.call(se,ne)});te=ie.find(se=>se.format===ee.format)??ie.find(se=>!se.format)}else ne=ee,te=t.find(ie=>ie.nodeClass&&ne instanceof ie.nodeClass);if(!te){const ie=((oe=ne==null?void 0:ne.constructor)==null?void 0:oe.name)??typeof ne;throw new Error(`Tag not resolved for ${ie} value`)}return te}function stringifyProps(t,ee,{anchors:te,doc:ne}){if(!ne.directives)return"";const oe=[],ie=(isScalar(t)||isCollection(t))&&t.anchor;ie&&anchorIsValid(ie)&&(te.add(ie),oe.push(`&${ie}`));const se=t.tag?t.tag:ee.default?null:ee.tag;return se&&oe.push(ne.directives.tagString(se)),oe.join(" ")}function stringify(t,ee,te,ne){var _e;if(isPair(t))return t.toString(ee,te,ne);if(isAlias(t)){if(ee.doc.directives)return t.toString(ee);if((_e=ee.resolvedAliases)!=null&&_e.has(t))throw new TypeError("Cannot stringify circular structure without alias nodes");ee.resolvedAliases?ee.resolvedAliases.add(t):ee.resolvedAliases=new Set([t]),t=t.resolve(ee.doc)}let oe;const ie=isNode(t)?t:ee.doc.createNode(t,{onTagObj:ae=>oe=ae});oe||(oe=getTagObject(ee.doc.schema.tags,ie));const se=stringifyProps(ie,oe,ee);se.length>0&&(ee.indentAtStart=(ee.indentAtStart??0)+se.length+1);const re=typeof oe.stringify=="function"?oe.stringify(ie,ee,te,ne):isScalar(ie)?stringifyString(ie,ee,te,ne):ie.toString(ee,te,ne);return se?isScalar(ie)||re[0]==="{"||re[0]==="["?`${se} ${re}`:`${se}
${ee.indent}${re}`:re}function stringifyPair({key:t,value:ee},te,ne,oe){const{allNullValues:ie,doc:se,indent:re,indentStep:_e,options:{commentString:ae,indentSeq:ce,simpleKeys:le}}=te;let ue=isNode(t)&&t.comment||null;if(le){if(ue)throw new Error("With simple keys, key nodes cannot have comments");if(isCollection(t)){const ke="With simple keys, collection cannot be used as a key value";throw new Error(ke)}}let de=!le&&(!t||ue&&ee==null&&!te.inFlow||isCollection(t)||(isScalar(t)?t.type===Scalar.BLOCK_FOLDED||t.type===Scalar.BLOCK_LITERAL:typeof t=="object"));te=Object.assign({},te,{allNullValues:!1,implicitKey:!de&&(le||!ie),indent:re+_e});let me=!1,pe=!1,fe=stringify(t,te,()=>me=!0,()=>pe=!0);if(!de&&!te.inFlow&&fe.length>1024){if(le)throw new Error("With simple keys, single line scalar must not span more than 1024 characters");de=!0}if(te.inFlow){if(ie||ee==null)return me&&ne&&ne(),fe===""?"?":de?`? ${fe}`:fe}else if(ie&&!le||ee==null&&de)return fe=`? ${fe}`,ue&&!me?fe+=lineComment(fe,te.indent,ae(ue)):pe&&oe&&oe(),fe;me&&(ue=null),de?(ue&&(fe+=lineComment(fe,te.indent,ae(ue))),fe=`? ${fe}
${re}:`):(fe=`${fe}:`,ue&&(fe+=lineComment(fe,te.indent,ae(ue))));let ge,he,be;isNode(ee)?(ge=!!ee.spaceBefore,he=ee.commentBefore,be=ee.comment):(ge=!1,he=null,be=null,ee&&typeof ee=="object"&&(ee=se.createNode(ee))),te.implicitKey=!1,!de&&!ue&&isScalar(ee)&&(te.indentAtStart=fe.length+1),pe=!1,!ce&&_e.length>=2&&!te.inFlow&&!de&&isSeq(ee)&&!ee.flow&&!ee.tag&&!ee.anchor&&(te.indent=te.indent.substring(2));let ve=!1;const ye=stringify(ee,te,()=>ve=!0,()=>pe=!0);let we=" ";if(ue||ge||he){if(we=ge?`
`:"",he){const ke=ae(he);we+=`
${indentComment(ke,te.indent)}`}ye===""&&!te.inFlow?we===`
`&&(we=`

`):we+=`
${te.indent}`}else if(!de&&isCollection(ee)){const ke=ye[0],Ae=ye.indexOf(`
`),$e=Ae!==-1,xe=te.inFlow??ee.flow??ee.items.length===0;if($e||!xe){let Ce=!1;if($e&&(ke==="&"||ke==="!")){let Se=ye.indexOf(" ");ke==="&"&&Se!==-1&&Se<Ae&&ye[Se+1]==="!"&&(Se=ye.indexOf(" ",Se+1)),(Se===-1||Ae<Se)&&(Ce=!0)}Ce||(we=`
${te.indent}`)}}else(ye===""||ye[0]===`
`)&&(we="");return fe+=we+ye,te.inFlow?ve&&ne&&ne():be&&!ve?fe+=lineComment(fe,te.indent,ae(be)):pe&&oe&&oe(),fe}function warn(t,ee){(t==="debug"||t==="warn")&&(typeof process<"u"&&process.emitWarning?process.emitWarning(ee):console.warn(ee))}const MERGE_KEY="<<";function addPairToJSMap(t,ee,{key:te,value:ne}){if(t!=null&&t.doc.schema.merge&&isMergeKey(te))if(ne=isAlias(ne)?ne.resolve(t.doc):ne,isSeq(ne))for(const oe of ne.items)mergeToJSMap(t,ee,oe);else if(Array.isArray(ne))for(const oe of ne)mergeToJSMap(t,ee,oe);else mergeToJSMap(t,ee,ne);else{const oe=toJS(te,"",t);if(ee instanceof Map)ee.set(oe,toJS(ne,oe,t));else if(ee instanceof Set)ee.add(oe);else{const ie=stringifyKey(te,oe,t),se=toJS(ne,ie,t);ie in ee?Object.defineProperty(ee,ie,{value:se,writable:!0,enumerable:!0,configurable:!0}):ee[ie]=se}}return ee}const isMergeKey=t=>t===MERGE_KEY||isScalar(t)&&t.value===MERGE_KEY&&(!t.type||t.type===Scalar.PLAIN);function mergeToJSMap(t,ee,te){const ne=t&&isAlias(te)?te.resolve(t.doc):te;if(!isMap(ne))throw new Error("Merge sources must be maps or map aliases");const oe=ne.toJSON(null,t,Map);for(const[ie,se]of oe)ee instanceof Map?ee.has(ie)||ee.set(ie,se):ee instanceof Set?ee.add(ie):Object.prototype.hasOwnProperty.call(ee,ie)||Object.defineProperty(ee,ie,{value:se,writable:!0,enumerable:!0,configurable:!0});return ee}function stringifyKey(t,ee,te){if(ee===null)return"";if(typeof ee!="object")return String(ee);if(isNode(t)&&te&&te.doc){const ne=createStringifyContext(te.doc,{});ne.anchors=new Set;for(const ie of te.anchors.keys())ne.anchors.add(ie.anchor);ne.inFlow=!0,ne.inStringifyKey=!0;const oe=t.toString(ne);if(!te.mapKeyWarned){let ie=JSON.stringify(oe);ie.length>40&&(ie=ie.substring(0,36)+'..."'),warn(te.doc.options.logLevel,`Keys with collection values will be stringified due to JS Object restrictions: ${ie}. Set mapAsMap: true to use object keys.`),te.mapKeyWarned=!0}return oe}return JSON.stringify(ee)}function createPair(t,ee,te){const ne=createNode(t,void 0,te),oe=createNode(ee,void 0,te);return new Pair(ne,oe)}class Pair{constructor(ee,te=null){Object.defineProperty(this,NODE_TYPE,{value:PAIR}),this.key=ee,this.value=te}clone(ee){let{key:te,value:ne}=this;return isNode(te)&&(te=te.clone(ee)),isNode(ne)&&(ne=ne.clone(ee)),new Pair(te,ne)}toJSON(ee,te){const ne=te!=null&&te.mapAsMap?new Map:{};return addPairToJSMap(te,ne,this)}toString(ee,te,ne){return ee!=null&&ee.doc?stringifyPair(this,ee,te,ne):JSON.stringify(this)}}function stringifyCollection(t,ee,te){return(ee.inFlow??t.flow?stringifyFlowCollection:stringifyBlockCollection)(t,ee,te)}function stringifyBlockCollection({comment:t,items:ee},te,{blockItemPrefix:ne,flowChars:oe,itemIndent:ie,onChompKeep:se,onComment:re}){const{indent:_e,options:{commentString:ae}}=te,ce=Object.assign({},te,{indent:ie,type:null});let le=!1;const ue=[];for(let me=0;me<ee.length;++me){const pe=ee[me];let fe=null;if(isNode(pe))!le&&pe.spaceBefore&&ue.push(""),addCommentBefore(te,ue,pe.commentBefore,le),pe.comment&&(fe=pe.comment);else if(isPair(pe)){const he=isNode(pe.key)?pe.key:null;he&&(!le&&he.spaceBefore&&ue.push(""),addCommentBefore(te,ue,he.commentBefore,le))}le=!1;let ge=stringify(pe,ce,()=>fe=null,()=>le=!0);fe&&(ge+=lineComment(ge,ie,ae(fe))),le&&fe&&(le=!1),ue.push(ne+ge)}let de;if(ue.length===0)de=oe.start+oe.end;else{de=ue[0];for(let me=1;me<ue.length;++me){const pe=ue[me];de+=pe?`
${_e}${pe}`:`
`}}return t?(de+=`
`+indentComment(ae(t),_e),re&&re()):le&&se&&se(),de}function stringifyFlowCollection({comment:t,items:ee},te,{flowChars:ne,itemIndent:oe,onComment:ie}){const{indent:se,indentStep:re,flowCollectionPadding:_e,options:{commentString:ae}}=te;oe+=re;const ce=Object.assign({},te,{indent:oe,inFlow:!0,type:null});let le=!1,ue=0;const de=[];for(let ge=0;ge<ee.length;++ge){const he=ee[ge];let be=null;if(isNode(he))he.spaceBefore&&de.push(""),addCommentBefore(te,de,he.commentBefore,!1),he.comment&&(be=he.comment);else if(isPair(he)){const ye=isNode(he.key)?he.key:null;ye&&(ye.spaceBefore&&de.push(""),addCommentBefore(te,de,ye.commentBefore,!1),ye.comment&&(le=!0));const we=isNode(he.value)?he.value:null;we?(we.comment&&(be=we.comment),we.commentBefore&&(le=!0)):he.value==null&&ye&&ye.comment&&(be=ye.comment)}be&&(le=!0);let ve=stringify(he,ce,()=>be=null);ge<ee.length-1&&(ve+=","),be&&(ve+=lineComment(ve,oe,ae(be))),!le&&(de.length>ue||ve.includes(`
`))&&(le=!0),de.push(ve),ue=de.length}let me;const{start:pe,end:fe}=ne;if(de.length===0)me=pe+fe;else if(le||(le=de.reduce((he,be)=>he+be.length+2,2)>Collection.maxFlowStringSingleLineLength),le){me=pe;for(const ge of de)me+=ge?`
${re}${se}${ge}`:`
`;me+=`
${se}${fe}`}else me=`${pe}${_e}${de.join(" ")}${_e}${fe}`;return t&&(me+=lineComment(me,se,ae(t)),ie&&ie()),me}function addCommentBefore({indent:t,options:{commentString:ee}},te,ne,oe){if(ne&&oe&&(ne=ne.replace(/^\n+/,"")),ne){const ie=indentComment(ee(ne),t);te.push(ie.trimStart())}}function findPair(t,ee){const te=isScalar(ee)?ee.value:ee;for(const ne of t)if(isPair(ne)&&(ne.key===ee||ne.key===te||isScalar(ne.key)&&ne.key.value===te))return ne}class YAMLMap extends Collection{static get tagName(){return"tag:yaml.org,2002:map"}constructor(ee){super(MAP,ee),this.items=[]}static from(ee,te,ne){const{keepUndefined:oe,replacer:ie}=ne,se=new this(ee),re=(_e,ae)=>{if(typeof ie=="function")ae=ie.call(te,_e,ae);else if(Array.isArray(ie)&&!ie.includes(_e))return;(ae!==void 0||oe)&&se.items.push(createPair(_e,ae,ne))};if(te instanceof Map)for(const[_e,ae]of te)re(_e,ae);else if(te&&typeof te=="object")for(const _e of Object.keys(te))re(_e,te[_e]);return typeof ee.sortMapEntries=="function"&&se.items.sort(ee.sortMapEntries),se}add(ee,te){var se;let ne;isPair(ee)?ne=ee:!ee||typeof ee!="object"||!("key"in ee)?ne=new Pair(ee,ee==null?void 0:ee.value):ne=new Pair(ee.key,ee.value);const oe=findPair(this.items,ne.key),ie=(se=this.schema)==null?void 0:se.sortMapEntries;if(oe){if(!te)throw new Error(`Key ${ne.key} already set`);isScalar(oe.value)&&isScalarValue(ne.value)?oe.value.value=ne.value:oe.value=ne.value}else if(ie){const re=this.items.findIndex(_e=>ie(ne,_e)<0);re===-1?this.items.push(ne):this.items.splice(re,0,ne)}else this.items.push(ne)}delete(ee){const te=findPair(this.items,ee);return te?this.items.splice(this.items.indexOf(te),1).length>0:!1}get(ee,te){const ne=findPair(this.items,ee),oe=ne==null?void 0:ne.value;return(!te&&isScalar(oe)?oe.value:oe)??void 0}has(ee){return!!findPair(this.items,ee)}set(ee,te){this.add(new Pair(ee,te),!0)}toJSON(ee,te,ne){const oe=ne?new ne:te!=null&&te.mapAsMap?new Map:{};te!=null&&te.onCreate&&te.onCreate(oe);for(const ie of this.items)addPairToJSMap(te,oe,ie);return oe}toString(ee,te,ne){if(!ee)return JSON.stringify(this);for(const oe of this.items)if(!isPair(oe))throw new Error(`Map items must all be pairs; found ${JSON.stringify(oe)} instead`);return!ee.allNullValues&&this.hasAllNullValues(!1)&&(ee=Object.assign({},ee,{allNullValues:!0})),stringifyCollection(this,ee,{blockItemPrefix:"",flowChars:{start:"{",end:"}"},itemIndent:ee.indent||"",onChompKeep:ne,onComment:te})}}const map={collection:"map",default:!0,nodeClass:YAMLMap,tag:"tag:yaml.org,2002:map",resolve(t,ee){return isMap(t)||ee("Expected a mapping for this tag"),t},createNode:(t,ee,te)=>YAMLMap.from(t,ee,te)};class YAMLSeq extends Collection{static get tagName(){return"tag:yaml.org,2002:seq"}constructor(ee){super(SEQ,ee),this.items=[]}add(ee){this.items.push(ee)}delete(ee){const te=asItemIndex(ee);return typeof te!="number"?!1:this.items.splice(te,1).length>0}get(ee,te){const ne=asItemIndex(ee);if(typeof ne!="number")return;const oe=this.items[ne];return!te&&isScalar(oe)?oe.value:oe}has(ee){const te=asItemIndex(ee);return typeof te=="number"&&te<this.items.length}set(ee,te){const ne=asItemIndex(ee);if(typeof ne!="number")throw new Error(`Expected a valid index, not ${ee}.`);const oe=this.items[ne];isScalar(oe)&&isScalarValue(te)?oe.value=te:this.items[ne]=te}toJSON(ee,te){const ne=[];te!=null&&te.onCreate&&te.onCreate(ne);let oe=0;for(const ie of this.items)ne.push(toJS(ie,String(oe++),te));return ne}toString(ee,te,ne){return ee?stringifyCollection(this,ee,{blockItemPrefix:"- ",flowChars:{start:"[",end:"]"},itemIndent:(ee.indent||"")+"  ",onChompKeep:ne,onComment:te}):JSON.stringify(this)}static from(ee,te,ne){const{replacer:oe}=ne,ie=new this(ee);if(te&&Symbol.iterator in Object(te)){let se=0;for(let re of te){if(typeof oe=="function"){const _e=te instanceof Set?re:String(se++);re=oe.call(te,_e,re)}ie.items.push(createNode(re,void 0,ne))}}return ie}}function asItemIndex(t){let ee=isScalar(t)?t.value:t;return ee&&typeof ee=="string"&&(ee=Number(ee)),typeof ee=="number"&&Number.isInteger(ee)&&ee>=0?ee:null}const seq={collection:"seq",default:!0,nodeClass:YAMLSeq,tag:"tag:yaml.org,2002:seq",resolve(t,ee){return isSeq(t)||ee("Expected a sequence for this tag"),t},createNode:(t,ee,te)=>YAMLSeq.from(t,ee,te)},string={identify:t=>typeof t=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:t=>t,stringify(t,ee,te,ne){return ee=Object.assign({actualString:!0},ee),stringifyString(t,ee,te,ne)}},nullTag={identify:t=>t==null,createNode:()=>new Scalar(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^(?:~|[Nn]ull|NULL)?$/,resolve:()=>new Scalar(null),stringify:({source:t},ee)=>typeof t=="string"&&nullTag.test.test(t)?t:ee.options.nullStr},boolTag={identify:t=>typeof t=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:[Tt]rue|TRUE|[Ff]alse|FALSE)$/,resolve:t=>new Scalar(t[0]==="t"||t[0]==="T"),stringify({source:t,value:ee},te){if(t&&boolTag.test.test(t)){const ne=t[0]==="t"||t[0]==="T";if(ee===ne)return t}return ee?te.options.trueStr:te.options.falseStr}};function stringifyNumber({format:t,minFractionDigits:ee,tag:te,value:ne}){if(typeof ne=="bigint")return String(ne);const oe=typeof ne=="number"?ne:Number(ne);if(!isFinite(oe))return isNaN(oe)?".nan":oe<0?"-.inf":".inf";let ie=JSON.stringify(ne);if(!t&&ee&&(!te||te==="tag:yaml.org,2002:float")&&/^\d/.test(ie)){let se=ie.indexOf(".");se<0&&(se=ie.length,ie+=".");let re=ee-(ie.length-se-1);for(;re-- >0;)ie+="0"}return ie}const floatNaN$1={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^(?:[-+]?\.(?:inf|Inf|INF|nan|NaN|NAN))$/,resolve:t=>t.slice(-3).toLowerCase()==="nan"?NaN:t[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:stringifyNumber},floatExp$1={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:\.[0-9]+|[0-9]+(?:\.[0-9]*)?)[eE][-+]?[0-9]+$/,resolve:t=>parseFloat(t),stringify(t){const ee=Number(t.value);return isFinite(ee)?ee.toExponential():stringifyNumber(t)}},float$1={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:\.[0-9]+|[0-9]+\.[0-9]*)$/,resolve(t){const ee=new Scalar(parseFloat(t)),te=t.indexOf(".");return te!==-1&&t[t.length-1]==="0"&&(ee.minFractionDigits=t.length-te-1),ee},stringify:stringifyNumber},intIdentify$2=t=>typeof t=="bigint"||Number.isInteger(t),intResolve$1=(t,ee,te,{intAsBigInt:ne})=>ne?BigInt(t):parseInt(t.substring(ee),te);function intStringify$1(t,ee,te){const{value:ne}=t;return intIdentify$2(ne)&&ne>=0?te+ne.toString(ee):stringifyNumber(t)}const intOct$1={identify:t=>intIdentify$2(t)&&t>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^0o[0-7]+$/,resolve:(t,ee,te)=>intResolve$1(t,2,8,te),stringify:t=>intStringify$1(t,8,"0o")},int$1={identify:intIdentify$2,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9]+$/,resolve:(t,ee,te)=>intResolve$1(t,0,10,te),stringify:stringifyNumber},intHex$1={identify:t=>intIdentify$2(t)&&t>=0,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^0x[0-9a-fA-F]+$/,resolve:(t,ee,te)=>intResolve$1(t,2,16,te),stringify:t=>intStringify$1(t,16,"0x")},schema$2=[map,seq,string,nullTag,boolTag,intOct$1,int$1,intHex$1,floatNaN$1,floatExp$1,float$1];function intIdentify$1(t){return typeof t=="bigint"||Number.isInteger(t)}const stringifyJSON=({value:t})=>JSON.stringify(t),jsonScalars=[{identify:t=>typeof t=="string",default:!0,tag:"tag:yaml.org,2002:str",resolve:t=>t,stringify:stringifyJSON},{identify:t=>t==null,createNode:()=>new Scalar(null),default:!0,tag:"tag:yaml.org,2002:null",test:/^null$/,resolve:()=>null,stringify:stringifyJSON},{identify:t=>typeof t=="boolean",default:!0,tag:"tag:yaml.org,2002:bool",test:/^true|false$/,resolve:t=>t==="true",stringify:stringifyJSON},{identify:intIdentify$1,default:!0,tag:"tag:yaml.org,2002:int",test:/^-?(?:0|[1-9][0-9]*)$/,resolve:(t,ee,{intAsBigInt:te})=>te?BigInt(t):parseInt(t,10),stringify:({value:t})=>intIdentify$1(t)?t.toString():JSON.stringify(t)},{identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^-?(?:0|[1-9][0-9]*)(?:\.[0-9]*)?(?:[eE][-+]?[0-9]+)?$/,resolve:t=>parseFloat(t),stringify:stringifyJSON}],jsonError={default:!0,tag:"",test:/^/,resolve(t,ee){return ee(`Unresolved plain scalar ${JSON.stringify(t)}`),t}},schema$1=[map,seq].concat(jsonScalars,jsonError),binary={identify:t=>t instanceof Uint8Array,default:!1,tag:"tag:yaml.org,2002:binary",resolve(t,ee){if(typeof Buffer=="function")return Buffer.from(t,"base64");if(typeof atob=="function"){const te=atob(t.replace(/[\n\r]/g,"")),ne=new Uint8Array(te.length);for(let oe=0;oe<te.length;++oe)ne[oe]=te.charCodeAt(oe);return ne}else return ee("This environment does not support reading binary tags; either Buffer or atob is required"),t},stringify({comment:t,type:ee,value:te},ne,oe,ie){const se=te;let re;if(typeof Buffer=="function")re=se instanceof Buffer?se.toString("base64"):Buffer.from(se.buffer).toString("base64");else if(typeof btoa=="function"){let _e="";for(let ae=0;ae<se.length;++ae)_e+=String.fromCharCode(se[ae]);re=btoa(_e)}else throw new Error("This environment does not support writing binary tags; either Buffer or btoa is required");if(ee||(ee=Scalar.BLOCK_LITERAL),ee!==Scalar.QUOTE_DOUBLE){const _e=Math.max(ne.options.lineWidth-ne.indent.length,ne.options.minContentWidth),ae=Math.ceil(re.length/_e),ce=new Array(ae);for(let le=0,ue=0;le<ae;++le,ue+=_e)ce[le]=re.substr(ue,_e);re=ce.join(ee===Scalar.BLOCK_LITERAL?`
`:" ")}return stringifyString({comment:t,type:ee,value:re},ne,oe,ie)}};function resolvePairs(t,ee){if(isSeq(t))for(let te=0;te<t.items.length;++te){let ne=t.items[te];if(!isPair(ne)){if(isMap(ne)){ne.items.length>1&&ee("Each pair must have its own sequence indicator");const oe=ne.items[0]||new Pair(new Scalar(null));if(ne.commentBefore&&(oe.key.commentBefore=oe.key.commentBefore?`${ne.commentBefore}
${oe.key.commentBefore}`:ne.commentBefore),ne.comment){const ie=oe.value??oe.key;ie.comment=ie.comment?`${ne.comment}
${ie.comment}`:ne.comment}ne=oe}t.items[te]=isPair(ne)?ne:new Pair(ne)}}else ee("Expected a sequence for this tag");return t}function createPairs(t,ee,te){const{replacer:ne}=te,oe=new YAMLSeq(t);oe.tag="tag:yaml.org,2002:pairs";let ie=0;if(ee&&Symbol.iterator in Object(ee))for(let se of ee){typeof ne=="function"&&(se=ne.call(ee,String(ie++),se));let re,_e;if(Array.isArray(se))if(se.length===2)re=se[0],_e=se[1];else throw new TypeError(`Expected [key, value] tuple: ${se}`);else if(se&&se instanceof Object){const ae=Object.keys(se);if(ae.length===1)re=ae[0],_e=se[re];else throw new TypeError(`Expected { key: value } tuple: ${se}`)}else re=se;oe.items.push(createPair(re,_e,te))}return oe}const pairs={collection:"seq",default:!1,tag:"tag:yaml.org,2002:pairs",resolve:resolvePairs,createNode:createPairs};class YAMLOMap extends YAMLSeq{constructor(){super(),this.add=YAMLMap.prototype.add.bind(this),this.delete=YAMLMap.prototype.delete.bind(this),this.get=YAMLMap.prototype.get.bind(this),this.has=YAMLMap.prototype.has.bind(this),this.set=YAMLMap.prototype.set.bind(this),this.tag=YAMLOMap.tag}toJSON(ee,te){if(!te)return super.toJSON(ee);const ne=new Map;te!=null&&te.onCreate&&te.onCreate(ne);for(const oe of this.items){let ie,se;if(isPair(oe)?(ie=toJS(oe.key,"",te),se=toJS(oe.value,ie,te)):ie=toJS(oe,"",te),ne.has(ie))throw new Error("Ordered maps must not include duplicate keys");ne.set(ie,se)}return ne}static from(ee,te,ne){const oe=createPairs(ee,te,ne),ie=new this;return ie.items=oe.items,ie}}YAMLOMap.tag="tag:yaml.org,2002:omap";const omap={collection:"seq",identify:t=>t instanceof Map,nodeClass:YAMLOMap,default:!1,tag:"tag:yaml.org,2002:omap",resolve(t,ee){const te=resolvePairs(t,ee),ne=[];for(const{key:oe}of te.items)isScalar(oe)&&(ne.includes(oe.value)?ee(`Ordered maps must not include duplicate keys: ${oe.value}`):ne.push(oe.value));return Object.assign(new YAMLOMap,te)},createNode:(t,ee,te)=>YAMLOMap.from(t,ee,te)};function boolStringify({value:t,source:ee},te){return ee&&(t?trueTag:falseTag).test.test(ee)?ee:t?te.options.trueStr:te.options.falseStr}const trueTag={identify:t=>t===!0,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:Y|y|[Yy]es|YES|[Tt]rue|TRUE|[Oo]n|ON)$/,resolve:()=>new Scalar(!0),stringify:boolStringify},falseTag={identify:t=>t===!1,default:!0,tag:"tag:yaml.org,2002:bool",test:/^(?:N|n|[Nn]o|NO|[Ff]alse|FALSE|[Oo]ff|OFF)$/i,resolve:()=>new Scalar(!1),stringify:boolStringify},floatNaN={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?\.(?:inf|Inf|INF|nan|NaN|NAN)$/,resolve:t=>t.slice(-3).toLowerCase()==="nan"?NaN:t[0]==="-"?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY,stringify:stringifyNumber},floatExp={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"EXP",test:/^[-+]?(?:[0-9][0-9_]*)?(?:\.[0-9_]*)?[eE][-+]?[0-9]+$/,resolve:t=>parseFloat(t.replace(/_/g,"")),stringify(t){const ee=Number(t.value);return isFinite(ee)?ee.toExponential():stringifyNumber(t)}},float={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",test:/^[-+]?(?:[0-9][0-9_]*)?\.[0-9_]*$/,resolve(t){const ee=new Scalar(parseFloat(t.replace(/_/g,""))),te=t.indexOf(".");if(te!==-1){const ne=t.substring(te+1).replace(/_/g,"");ne[ne.length-1]==="0"&&(ee.minFractionDigits=ne.length)}return ee},stringify:stringifyNumber},intIdentify=t=>typeof t=="bigint"||Number.isInteger(t);function intResolve(t,ee,te,{intAsBigInt:ne}){const oe=t[0];if((oe==="-"||oe==="+")&&(ee+=1),t=t.substring(ee).replace(/_/g,""),ne){switch(te){case 2:t=`0b${t}`;break;case 8:t=`0o${t}`;break;case 16:t=`0x${t}`;break}const se=BigInt(t);return oe==="-"?BigInt(-1)*se:se}const ie=parseInt(t,te);return oe==="-"?-1*ie:ie}function intStringify(t,ee,te){const{value:ne}=t;if(intIdentify(ne)){const oe=ne.toString(ee);return ne<0?"-"+te+oe.substr(1):te+oe}return stringifyNumber(t)}const intBin={identify:intIdentify,default:!0,tag:"tag:yaml.org,2002:int",format:"BIN",test:/^[-+]?0b[0-1_]+$/,resolve:(t,ee,te)=>intResolve(t,2,2,te),stringify:t=>intStringify(t,2,"0b")},intOct={identify:intIdentify,default:!0,tag:"tag:yaml.org,2002:int",format:"OCT",test:/^[-+]?0[0-7_]+$/,resolve:(t,ee,te)=>intResolve(t,1,8,te),stringify:t=>intStringify(t,8,"0")},int={identify:intIdentify,default:!0,tag:"tag:yaml.org,2002:int",test:/^[-+]?[0-9][0-9_]*$/,resolve:(t,ee,te)=>intResolve(t,0,10,te),stringify:stringifyNumber},intHex={identify:intIdentify,default:!0,tag:"tag:yaml.org,2002:int",format:"HEX",test:/^[-+]?0x[0-9a-fA-F_]+$/,resolve:(t,ee,te)=>intResolve(t,2,16,te),stringify:t=>intStringify(t,16,"0x")};class YAMLSet extends YAMLMap{constructor(ee){super(ee),this.tag=YAMLSet.tag}add(ee){let te;isPair(ee)?te=ee:ee&&typeof ee=="object"&&"key"in ee&&"value"in ee&&ee.value===null?te=new Pair(ee.key,null):te=new Pair(ee,null),findPair(this.items,te.key)||this.items.push(te)}get(ee,te){const ne=findPair(this.items,ee);return!te&&isPair(ne)?isScalar(ne.key)?ne.key.value:ne.key:ne}set(ee,te){if(typeof te!="boolean")throw new Error(`Expected boolean value for set(key, value) in a YAML set, not ${typeof te}`);const ne=findPair(this.items,ee);ne&&!te?this.items.splice(this.items.indexOf(ne),1):!ne&&te&&this.items.push(new Pair(ee))}toJSON(ee,te){return super.toJSON(ee,te,Set)}toString(ee,te,ne){if(!ee)return JSON.stringify(this);if(this.hasAllNullValues(!0))return super.toString(Object.assign({},ee,{allNullValues:!0}),te,ne);throw new Error("Set items must all have null values")}static from(ee,te,ne){const{replacer:oe}=ne,ie=new this(ee);if(te&&Symbol.iterator in Object(te))for(let se of te)typeof oe=="function"&&(se=oe.call(te,se,se)),ie.items.push(createPair(se,null,ne));return ie}}YAMLSet.tag="tag:yaml.org,2002:set";const set={collection:"map",identify:t=>t instanceof Set,nodeClass:YAMLSet,default:!1,tag:"tag:yaml.org,2002:set",createNode:(t,ee,te)=>YAMLSet.from(t,ee,te),resolve(t,ee){if(isMap(t)){if(t.hasAllNullValues(!0))return Object.assign(new YAMLSet,t);ee("Set items must all have null values")}else ee("Expected a mapping for this tag");return t}};function parseSexagesimal(t,ee){const te=t[0],ne=te==="-"||te==="+"?t.substring(1):t,oe=se=>ee?BigInt(se):Number(se),ie=ne.replace(/_/g,"").split(":").reduce((se,re)=>se*oe(60)+oe(re),oe(0));return te==="-"?oe(-1)*ie:ie}function stringifySexagesimal(t){let{value:ee}=t,te=se=>se;if(typeof ee=="bigint")te=se=>BigInt(se);else if(isNaN(ee)||!isFinite(ee))return stringifyNumber(t);let ne="";ee<0&&(ne="-",ee*=te(-1));const oe=te(60),ie=[ee%oe];return ee<60?ie.unshift(0):(ee=(ee-ie[0])/oe,ie.unshift(ee%oe),ee>=60&&(ee=(ee-ie[0])/oe,ie.unshift(ee))),ne+ie.map(se=>String(se).padStart(2,"0")).join(":").replace(/000000\d*$/,"")}const intTime={identify:t=>typeof t=="bigint"||Number.isInteger(t),default:!0,tag:"tag:yaml.org,2002:int",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+$/,resolve:(t,ee,{intAsBigInt:te})=>parseSexagesimal(t,te),stringify:stringifySexagesimal},floatTime={identify:t=>typeof t=="number",default:!0,tag:"tag:yaml.org,2002:float",format:"TIME",test:/^[-+]?[0-9][0-9_]*(?::[0-5]?[0-9])+\.[0-9_]*$/,resolve:t=>parseSexagesimal(t,!1),stringify:stringifySexagesimal},timestamp={identify:t=>t instanceof Date,default:!0,tag:"tag:yaml.org,2002:timestamp",test:RegExp("^([0-9]{4})-([0-9]{1,2})-([0-9]{1,2})(?:(?:t|T|[ \\t]+)([0-9]{1,2}):([0-9]{1,2}):([0-9]{1,2}(\\.[0-9]+)?)(?:[ \\t]*(Z|[-+][012]?[0-9](?::[0-9]{2})?))?)?$"),resolve(t){const ee=t.match(timestamp.test);if(!ee)throw new Error("!!timestamp expects a date, starting with yyyy-mm-dd");const[,te,ne,oe,ie,se,re]=ee.map(Number),_e=ee[7]?Number((ee[7]+"00").substr(1,3)):0;let ae=Date.UTC(te,ne-1,oe,ie||0,se||0,re||0,_e);const ce=ee[8];if(ce&&ce!=="Z"){let le=parseSexagesimal(ce,!1);Math.abs(le)<30&&(le*=60),ae-=6e4*le}return new Date(ae)},stringify:({value:t})=>t.toISOString().replace(/((T00:00)?:00)?\.000Z$/,"")},schema=[map,seq,string,nullTag,trueTag,falseTag,intBin,intOct,int,intHex,floatNaN,floatExp,float,binary,omap,pairs,set,intTime,floatTime,timestamp],schemas=new Map([["core",schema$2],["failsafe",[map,seq,string]],["json",schema$1],["yaml11",schema],["yaml-1.1",schema]]),tagsByName={binary,bool:boolTag,float:float$1,floatExp:floatExp$1,floatNaN:floatNaN$1,floatTime,int:int$1,intHex:intHex$1,intOct:intOct$1,intTime,map,null:nullTag,omap,pairs,seq,set,timestamp},coreKnownTags={"tag:yaml.org,2002:binary":binary,"tag:yaml.org,2002:omap":omap,"tag:yaml.org,2002:pairs":pairs,"tag:yaml.org,2002:set":set,"tag:yaml.org,2002:timestamp":timestamp};function getTags(t,ee){let te=schemas.get(ee);if(!te)if(Array.isArray(t))te=[];else{const ne=Array.from(schemas.keys()).filter(oe=>oe!=="yaml11").map(oe=>JSON.stringify(oe)).join(", ");throw new Error(`Unknown schema "${ee}"; use one of ${ne} or define customTags array`)}if(Array.isArray(t))for(const ne of t)te=te.concat(ne);else typeof t=="function"&&(te=t(te.slice()));return te.map(ne=>{if(typeof ne!="string")return ne;const oe=tagsByName[ne];if(oe)return oe;const ie=Object.keys(tagsByName).map(se=>JSON.stringify(se)).join(", ");throw new Error(`Unknown custom tag "${ne}"; use one of ${ie}`)})}const sortMapEntriesByKey=(t,ee)=>t.key<ee.key?-1:t.key>ee.key?1:0;class Schema{constructor({compat:ee,customTags:te,merge:ne,resolveKnownTags:oe,schema:ie,sortMapEntries:se,toStringDefaults:re}){this.compat=Array.isArray(ee)?getTags(ee,"compat"):ee?getTags(null,ee):null,this.merge=!!ne,this.name=typeof ie=="string"&&ie||"core",this.knownTags=oe?coreKnownTags:{},this.tags=getTags(te,this.name),this.toStringOptions=re??null,Object.defineProperty(this,MAP,{value:map}),Object.defineProperty(this,SCALAR$1,{value:string}),Object.defineProperty(this,SEQ,{value:seq}),this.sortMapEntries=typeof se=="function"?se:se===!0?sortMapEntriesByKey:null}clone(){const ee=Object.create(Schema.prototype,Object.getOwnPropertyDescriptors(this));return ee.tags=this.tags.slice(),ee}}function stringifyDocument(t,ee){var _e;const te=[];let ne=ee.directives===!0;if(ee.directives!==!1&&t.directives){const ae=t.directives.toString(t);ae?(te.push(ae),ne=!0):t.directives.docStart&&(ne=!0)}ne&&te.push("---");const oe=createStringifyContext(t,ee),{commentString:ie}=oe.options;if(t.commentBefore){te.length!==1&&te.unshift("");const ae=ie(t.commentBefore);te.unshift(indentComment(ae,""))}let se=!1,re=null;if(t.contents){if(isNode(t.contents)){if(t.contents.spaceBefore&&ne&&te.push(""),t.contents.commentBefore){const le=ie(t.contents.commentBefore);te.push(indentComment(le,""))}oe.forceBlockIndent=!!t.comment,re=t.contents.comment}const ae=re?void 0:()=>se=!0;let ce=stringify(t.contents,oe,()=>re=null,ae);re&&(ce+=lineComment(ce,"",ie(re))),(ce[0]==="|"||ce[0]===">")&&te[te.length-1]==="---"?te[te.length-1]=`--- ${ce}`:te.push(ce)}else te.push(stringify(t.contents,oe));if((_e=t.directives)!=null&&_e.docEnd)if(t.comment){const ae=ie(t.comment);ae.includes(`
`)?(te.push("..."),te.push(indentComment(ae,""))):te.push(`... ${ae}`)}else te.push("...");else{let ae=t.comment;ae&&se&&(ae=ae.replace(/^\n+/,"")),ae&&((!se||re)&&te[te.length-1]!==""&&te.push(""),te.push(indentComment(ie(ae),"")))}return te.join(`
`)+`
`}class Document{constructor(ee,te,ne){this.commentBefore=null,this.comment=null,this.errors=[],this.warnings=[],Object.defineProperty(this,NODE_TYPE,{value:DOC});let oe=null;typeof te=="function"||Array.isArray(te)?oe=te:ne===void 0&&te&&(ne=te,te=void 0);const ie=Object.assign({intAsBigInt:!1,keepSourceTokens:!1,logLevel:"warn",prettyErrors:!0,strict:!0,uniqueKeys:!0,version:"1.2"},ne);this.options=ie;let{version:se}=ie;ne!=null&&ne._directives?(this.directives=ne._directives.atDocument(),this.directives.yaml.explicit&&(se=this.directives.yaml.version)):this.directives=new Directives({version:se}),this.setSchema(se,ne),this.contents=ee===void 0?null:this.createNode(ee,oe,ne)}clone(){const ee=Object.create(Document.prototype,{[NODE_TYPE]:{value:DOC}});return ee.commentBefore=this.commentBefore,ee.comment=this.comment,ee.errors=this.errors.slice(),ee.warnings=this.warnings.slice(),ee.options=Object.assign({},this.options),this.directives&&(ee.directives=this.directives.clone()),ee.schema=this.schema.clone(),ee.contents=isNode(this.contents)?this.contents.clone(ee.schema):this.contents,this.range&&(ee.range=this.range.slice()),ee}add(ee){assertCollection(this.contents)&&this.contents.add(ee)}addIn(ee,te){assertCollection(this.contents)&&this.contents.addIn(ee,te)}createAlias(ee,te){if(!ee.anchor){const ne=anchorNames(this);ee.anchor=!te||ne.has(te)?findNewAnchor(te||"a",ne):te}return new Alias(ee.anchor)}createNode(ee,te,ne){let oe;if(typeof te=="function")ee=te.call({"":ee},"",ee),oe=te;else if(Array.isArray(te)){const fe=he=>typeof he=="number"||he instanceof String||he instanceof Number,ge=te.filter(fe).map(String);ge.length>0&&(te=te.concat(ge)),oe=te}else ne===void 0&&te&&(ne=te,te=void 0);const{aliasDuplicateObjects:ie,anchorPrefix:se,flow:re,keepUndefined:_e,onTagObj:ae,tag:ce}=ne??{},{onAnchor:le,setAnchors:ue,sourceObjects:de}=createNodeAnchors(this,se||"a"),me={aliasDuplicateObjects:ie??!0,keepUndefined:_e??!1,onAnchor:le,onTagObj:ae,replacer:oe,schema:this.schema,sourceObjects:de},pe=createNode(ee,ce,me);return re&&isCollection(pe)&&(pe.flow=!0),ue(),pe}createPair(ee,te,ne={}){const oe=this.createNode(ee,null,ne),ie=this.createNode(te,null,ne);return new Pair(oe,ie)}delete(ee){return assertCollection(this.contents)?this.contents.delete(ee):!1}deleteIn(ee){return isEmptyPath(ee)?this.contents==null?!1:(this.contents=null,!0):assertCollection(this.contents)?this.contents.deleteIn(ee):!1}get(ee,te){return isCollection(this.contents)?this.contents.get(ee,te):void 0}getIn(ee,te){return isEmptyPath(ee)?!te&&isScalar(this.contents)?this.contents.value:this.contents:isCollection(this.contents)?this.contents.getIn(ee,te):void 0}has(ee){return isCollection(this.contents)?this.contents.has(ee):!1}hasIn(ee){return isEmptyPath(ee)?this.contents!==void 0:isCollection(this.contents)?this.contents.hasIn(ee):!1}set(ee,te){this.contents==null?this.contents=collectionFromPath(this.schema,[ee],te):assertCollection(this.contents)&&this.contents.set(ee,te)}setIn(ee,te){isEmptyPath(ee)?this.contents=te:this.contents==null?this.contents=collectionFromPath(this.schema,Array.from(ee),te):assertCollection(this.contents)&&this.contents.setIn(ee,te)}setSchema(ee,te={}){typeof ee=="number"&&(ee=String(ee));let ne;switch(ee){case"1.1":this.directives?this.directives.yaml.version="1.1":this.directives=new Directives({version:"1.1"}),ne={merge:!0,resolveKnownTags:!1,schema:"yaml-1.1"};break;case"1.2":case"next":this.directives?this.directives.yaml.version=ee:this.directives=new Directives({version:ee}),ne={merge:!1,resolveKnownTags:!0,schema:"core"};break;case null:this.directives&&delete this.directives,ne=null;break;default:{const oe=JSON.stringify(ee);throw new Error(`Expected '1.1', '1.2' or null as first argument, but found: ${oe}`)}}if(te.schema instanceof Object)this.schema=te.schema;else if(ne)this.schema=new Schema(Object.assign(ne,te));else throw new Error("With a null YAML version, the { schema: Schema } option is required")}toJS({json:ee,jsonArg:te,mapAsMap:ne,maxAliasCount:oe,onAnchor:ie,reviver:se}={}){const re={anchors:new Map,doc:this,keep:!ee,mapAsMap:ne===!0,mapKeyWarned:!1,maxAliasCount:typeof oe=="number"?oe:100},_e=toJS(this.contents,te??"",re);if(typeof ie=="function")for(const{count:ae,res:ce}of re.anchors.values())ie(ce,ae);return typeof se=="function"?applyReviver(se,{"":_e},"",_e):_e}toJSON(ee,te){return this.toJS({json:!0,jsonArg:ee,mapAsMap:!1,onAnchor:te})}toString(ee={}){if(this.errors.length>0)throw new Error("Document with errors cannot be stringified");if("indent"in ee&&(!Number.isInteger(ee.indent)||Number(ee.indent)<=0)){const te=JSON.stringify(ee.indent);throw new Error(`"indent" option must be a positive integer, not ${te}`)}return stringifyDocument(this,ee)}}function assertCollection(t){if(isCollection(t))return!0;throw new Error("Expected a YAML collection as document contents")}class YAMLError extends Error{constructor(ee,te,ne,oe){super(),this.name=ee,this.code=ne,this.message=oe,this.pos=te}}class YAMLParseError extends YAMLError{constructor(ee,te,ne){super("YAMLParseError",ee,te,ne)}}class YAMLWarning extends YAMLError{constructor(ee,te,ne){super("YAMLWarning",ee,te,ne)}}const prettifyError=(t,ee)=>te=>{if(te.pos[0]===-1)return;te.linePos=te.pos.map(re=>ee.linePos(re));const{line:ne,col:oe}=te.linePos[0];te.message+=` at line ${ne}, column ${oe}`;let ie=oe-1,se=t.substring(ee.lineStarts[ne-1],ee.lineStarts[ne]).replace(/[\n\r]+$/,"");if(ie>=60&&se.length>80){const re=Math.min(ie-39,se.length-79);se="…"+se.substring(re),ie-=re-1}if(se.length>80&&(se=se.substring(0,79)+"…"),ne>1&&/^ *$/.test(se.substring(0,ie))){let re=t.substring(ee.lineStarts[ne-2],ee.lineStarts[ne-1]);re.length>80&&(re=re.substring(0,79)+`…
`),se=re+se}if(/[^ ]/.test(se)){let re=1;const _e=te.linePos[1];_e&&_e.line===ne&&_e.col>oe&&(re=Math.max(1,Math.min(_e.col-oe,80-ie)));const ae=" ".repeat(ie)+"^".repeat(re);te.message+=`:

${se}
${ae}
`}};function resolveProps(t,{flow:ee,indicator:te,next:ne,offset:oe,onError:ie,startOnNewline:se}){let re=!1,_e=se,ae=se,ce="",le="",ue=!1,de=!1,me=!1,pe=null,fe=null,ge=null,he=null,be=null;for(const we of t)switch(me&&(we.type!=="space"&&we.type!=="newline"&&we.type!=="comma"&&ie(we.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),me=!1),we.type){case"space":!ee&&_e&&te!=="doc-start"&&we.source[0]==="	"&&ie(we,"TAB_AS_INDENT","Tabs are not allowed as indentation"),ae=!0;break;case"comment":{ae||ie(we,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const ke=we.source.substring(1)||" ";ce?ce+=le+ke:ce=ke,le="",_e=!1;break}case"newline":_e?ce?ce+=we.source:re=!0:le+=we.source,_e=!0,ue=!0,(pe||fe)&&(de=!0),ae=!0;break;case"anchor":pe&&ie(we,"MULTIPLE_ANCHORS","A node can have at most one anchor"),we.source.endsWith(":")&&ie(we.offset+we.source.length-1,"BAD_ALIAS","Anchor ending in : is ambiguous",!0),pe=we,be===null&&(be=we.offset),_e=!1,ae=!1,me=!0;break;case"tag":{fe&&ie(we,"MULTIPLE_TAGS","A node can have at most one tag"),fe=we,be===null&&(be=we.offset),_e=!1,ae=!1,me=!0;break}case te:(pe||fe)&&ie(we,"BAD_PROP_ORDER",`Anchors and tags must be after the ${we.source} indicator`),he&&ie(we,"UNEXPECTED_TOKEN",`Unexpected ${we.source} in ${ee??"collection"}`),he=we,_e=!1,ae=!1;break;case"comma":if(ee){ge&&ie(we,"UNEXPECTED_TOKEN",`Unexpected , in ${ee}`),ge=we,_e=!1,ae=!1;break}default:ie(we,"UNEXPECTED_TOKEN",`Unexpected ${we.type} token`),_e=!1,ae=!1}const ve=t[t.length-1],ye=ve?ve.offset+ve.source.length:oe;return me&&ne&&ne.type!=="space"&&ne.type!=="newline"&&ne.type!=="comma"&&(ne.type!=="scalar"||ne.source!=="")&&ie(ne.offset,"MISSING_CHAR","Tags and anchors must be separated from the next token by white space"),{comma:ge,found:he,spaceBefore:re,comment:ce,hasNewline:ue,hasNewlineAfterProp:de,anchor:pe,tag:fe,end:ye,start:be??ye}}function containsNewline(t){if(!t)return null;switch(t.type){case"alias":case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":if(t.source.includes(`
`))return!0;if(t.end){for(const ee of t.end)if(ee.type==="newline")return!0}return!1;case"flow-collection":for(const ee of t.items){for(const te of ee.start)if(te.type==="newline")return!0;if(ee.sep){for(const te of ee.sep)if(te.type==="newline")return!0}if(containsNewline(ee.key)||containsNewline(ee.value))return!0}return!1;default:return!0}}function flowIndentCheck(t,ee,te){if((ee==null?void 0:ee.type)==="flow-collection"){const ne=ee.end[0];ne.indent===t&&(ne.source==="]"||ne.source==="}")&&containsNewline(ee)&&te(ne,"BAD_INDENT","Flow end indicator should be more indented than parent",!0)}}function mapIncludes(t,ee,te){const{uniqueKeys:ne}=t.options;if(ne===!1)return!1;const oe=typeof ne=="function"?ne:(ie,se)=>ie===se||isScalar(ie)&&isScalar(se)&&ie.value===se.value&&!(ie.value==="<<"&&t.schema.merge);return ee.some(ie=>oe(ie.key,te))}const startColMsg="All mapping items must start at the same column";function resolveBlockMap({composeNode:t,composeEmptyNode:ee},te,ne,oe,ie){var ce;const se=(ie==null?void 0:ie.nodeClass)??YAMLMap,re=new se(te.schema);te.atRoot&&(te.atRoot=!1);let _e=ne.offset,ae=null;for(const le of ne.items){const{start:ue,key:de,sep:me,value:pe}=le,fe=resolveProps(ue,{indicator:"explicit-key-ind",next:de??(me==null?void 0:me[0]),offset:_e,onError:oe,startOnNewline:!0}),ge=!fe.found;if(ge){if(de&&(de.type==="block-seq"?oe(_e,"BLOCK_AS_IMPLICIT_KEY","A block sequence may not be used as an implicit map key"):"indent"in de&&de.indent!==ne.indent&&oe(_e,"BAD_INDENT",startColMsg)),!fe.anchor&&!fe.tag&&!me){ae=fe.end,fe.comment&&(re.comment?re.comment+=`
`+fe.comment:re.comment=fe.comment);continue}(fe.hasNewlineAfterProp||containsNewline(de))&&oe(de??ue[ue.length-1],"MULTILINE_IMPLICIT_KEY","Implicit keys need to be on a single line")}else((ce=fe.found)==null?void 0:ce.indent)!==ne.indent&&oe(_e,"BAD_INDENT",startColMsg);const he=fe.end,be=de?t(te,de,fe,oe):ee(te,he,ue,null,fe,oe);te.schema.compat&&flowIndentCheck(ne.indent,de,oe),mapIncludes(te,re.items,be)&&oe(he,"DUPLICATE_KEY","Map keys must be unique");const ve=resolveProps(me??[],{indicator:"map-value-ind",next:pe,offset:be.range[2],onError:oe,startOnNewline:!de||de.type==="block-scalar"});if(_e=ve.end,ve.found){ge&&((pe==null?void 0:pe.type)==="block-map"&&!ve.hasNewline&&oe(_e,"BLOCK_AS_IMPLICIT_KEY","Nested mappings are not allowed in compact mappings"),te.options.strict&&fe.start<ve.found.offset-1024&&oe(be.range,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit block mapping key"));const ye=pe?t(te,pe,ve,oe):ee(te,_e,me,null,ve,oe);te.schema.compat&&flowIndentCheck(ne.indent,pe,oe),_e=ye.range[2];const we=new Pair(be,ye);te.options.keepSourceTokens&&(we.srcToken=le),re.items.push(we)}else{ge&&oe(be.range,"MISSING_CHAR","Implicit map keys need to be followed by map values"),ve.comment&&(be.comment?be.comment+=`
`+ve.comment:be.comment=ve.comment);const ye=new Pair(be);te.options.keepSourceTokens&&(ye.srcToken=le),re.items.push(ye)}}return ae&&ae<_e&&oe(ae,"IMPOSSIBLE","Map comment with trailing content"),re.range=[ne.offset,_e,ae??_e],re}function resolveBlockSeq({composeNode:t,composeEmptyNode:ee},te,ne,oe,ie){const se=(ie==null?void 0:ie.nodeClass)??YAMLSeq,re=new se(te.schema);te.atRoot&&(te.atRoot=!1);let _e=ne.offset,ae=null;for(const{start:ce,value:le}of ne.items){const ue=resolveProps(ce,{indicator:"seq-item-ind",next:le,offset:_e,onError:oe,startOnNewline:!0});if(!ue.found)if(ue.anchor||ue.tag||le)le&&le.type==="block-seq"?oe(ue.end,"BAD_INDENT","All sequence items must start at the same column"):oe(_e,"MISSING_CHAR","Sequence item without - indicator");else{ae=ue.end,ue.comment&&(re.comment=ue.comment);continue}const de=le?t(te,le,ue,oe):ee(te,ue.end,ce,null,ue,oe);te.schema.compat&&flowIndentCheck(ne.indent,le,oe),_e=de.range[2],re.items.push(de)}return re.range=[ne.offset,_e,ae??_e],re}function resolveEnd(t,ee,te,ne){let oe="";if(t){let ie=!1,se="";for(const re of t){const{source:_e,type:ae}=re;switch(ae){case"space":ie=!0;break;case"comment":{te&&!ie&&ne(re,"MISSING_CHAR","Comments must be separated from other tokens by white space characters");const ce=_e.substring(1)||" ";oe?oe+=se+ce:oe=ce,se="";break}case"newline":oe&&(se+=_e),ie=!0;break;default:ne(re,"UNEXPECTED_TOKEN",`Unexpected ${ae} at node end`)}ee+=_e.length}}return{comment:oe,offset:ee}}const blockMsg="Block collections are not allowed within flow collections",isBlock=t=>t&&(t.type==="block-map"||t.type==="block-seq");function resolveFlowCollection({composeNode:t,composeEmptyNode:ee},te,ne,oe,ie){const se=ne.start.source==="{",re=se?"flow map":"flow sequence",_e=(ie==null?void 0:ie.nodeClass)??(se?YAMLMap:YAMLSeq),ae=new _e(te.schema);ae.flow=!0;const ce=te.atRoot;ce&&(te.atRoot=!1);let le=ne.offset+ne.start.source.length;for(let fe=0;fe<ne.items.length;++fe){const ge=ne.items[fe],{start:he,key:be,sep:ve,value:ye}=ge,we=resolveProps(he,{flow:re,indicator:"explicit-key-ind",next:be??(ve==null?void 0:ve[0]),offset:le,onError:oe,startOnNewline:!1});if(!we.found){if(!we.anchor&&!we.tag&&!ve&&!ye){fe===0&&we.comma?oe(we.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${re}`):fe<ne.items.length-1&&oe(we.start,"UNEXPECTED_TOKEN",`Unexpected empty item in ${re}`),we.comment&&(ae.comment?ae.comment+=`
`+we.comment:ae.comment=we.comment),le=we.end;continue}!se&&te.options.strict&&containsNewline(be)&&oe(be,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line")}if(fe===0)we.comma&&oe(we.comma,"UNEXPECTED_TOKEN",`Unexpected , in ${re}`);else if(we.comma||oe(we.start,"MISSING_CHAR",`Missing , between ${re} items`),we.comment){let ke="";e:for(const Ae of he)switch(Ae.type){case"comma":case"space":break;case"comment":ke=Ae.source.substring(1);break e;default:break e}if(ke){let Ae=ae.items[ae.items.length-1];isPair(Ae)&&(Ae=Ae.value??Ae.key),Ae.comment?Ae.comment+=`
`+ke:Ae.comment=ke,we.comment=we.comment.substring(ke.length+1)}}if(!se&&!ve&&!we.found){const ke=ye?t(te,ye,we,oe):ee(te,we.end,ve,null,we,oe);ae.items.push(ke),le=ke.range[2],isBlock(ye)&&oe(ke.range,"BLOCK_IN_FLOW",blockMsg)}else{const ke=we.end,Ae=be?t(te,be,we,oe):ee(te,ke,he,null,we,oe);isBlock(be)&&oe(Ae.range,"BLOCK_IN_FLOW",blockMsg);const $e=resolveProps(ve??[],{flow:re,indicator:"map-value-ind",next:ye,offset:Ae.range[2],onError:oe,startOnNewline:!1});if($e.found){if(!se&&!we.found&&te.options.strict){if(ve)for(const Se of ve){if(Se===$e.found)break;if(Se.type==="newline"){oe(Se,"MULTILINE_IMPLICIT_KEY","Implicit keys of flow sequence pairs need to be on a single line");break}}we.start<$e.found.offset-1024&&oe($e.found,"KEY_OVER_1024_CHARS","The : indicator must be at most 1024 chars after the start of an implicit flow sequence key")}}else ye&&("source"in ye&&ye.source&&ye.source[0]===":"?oe(ye,"MISSING_CHAR",`Missing space after : in ${re}`):oe($e.start,"MISSING_CHAR",`Missing , or : between ${re} items`));const xe=ye?t(te,ye,$e,oe):$e.found?ee(te,$e.end,ve,null,$e,oe):null;xe?isBlock(ye)&&oe(xe.range,"BLOCK_IN_FLOW",blockMsg):$e.comment&&(Ae.comment?Ae.comment+=`
`+$e.comment:Ae.comment=$e.comment);const Ce=new Pair(Ae,xe);if(te.options.keepSourceTokens&&(Ce.srcToken=ge),se){const Se=ae;mapIncludes(te,Se.items,Ae)&&oe(ke,"DUPLICATE_KEY","Map keys must be unique"),Se.items.push(Ce)}else{const Se=new YAMLMap(te.schema);Se.flow=!0,Se.items.push(Ce),ae.items.push(Se)}le=xe?xe.range[2]:$e.end}}const ue=se?"}":"]",[de,...me]=ne.end;let pe=le;if(de&&de.source===ue)pe=de.offset+de.source.length;else{const fe=re[0].toUpperCase()+re.substring(1),ge=ce?`${fe} must end with a ${ue}`:`${fe} in block collection must be sufficiently indented and end with a ${ue}`;oe(le,ce?"MISSING_CHAR":"BAD_INDENT",ge),de&&de.source.length!==1&&me.unshift(de)}if(me.length>0){const fe=resolveEnd(me,pe,te.options.strict,oe);fe.comment&&(ae.comment?ae.comment+=`
`+fe.comment:ae.comment=fe.comment),ae.range=[ne.offset,pe,fe.offset]}else ae.range=[ne.offset,pe,pe];return ae}function resolveCollection(t,ee,te,ne,oe,ie){const se=te.type==="block-map"?resolveBlockMap(t,ee,te,ne,ie):te.type==="block-seq"?resolveBlockSeq(t,ee,te,ne,ie):resolveFlowCollection(t,ee,te,ne,ie),re=se.constructor;return oe==="!"||oe===re.tagName?(se.tag=re.tagName,se):(oe&&(se.tag=oe),se)}function composeCollection(t,ee,te,ne,oe){var le;const ie=ne?ee.directives.tagName(ne.source,ue=>oe(ne,"TAG_RESOLVE_FAILED",ue)):null,se=te.type==="block-map"?"map":te.type==="block-seq"?"seq":te.start.source==="{"?"map":"seq";if(!ne||!ie||ie==="!"||ie===YAMLMap.tagName&&se==="map"||ie===YAMLSeq.tagName&&se==="seq"||!se)return resolveCollection(t,ee,te,oe,ie);let re=ee.schema.tags.find(ue=>ue.tag===ie&&ue.collection===se);if(!re){const ue=ee.schema.knownTags[ie];if(ue&&ue.collection===se)ee.schema.tags.push(Object.assign({},ue,{default:!1})),re=ue;else return ue!=null&&ue.collection?oe(ne,"BAD_COLLECTION_TYPE",`${ue.tag} used for ${se} collection, but expects ${ue.collection}`,!0):oe(ne,"TAG_RESOLVE_FAILED",`Unresolved tag: ${ie}`,!0),resolveCollection(t,ee,te,oe,ie)}const _e=resolveCollection(t,ee,te,oe,ie,re),ae=((le=re.resolve)==null?void 0:le.call(re,_e,ue=>oe(ne,"TAG_RESOLVE_FAILED",ue),ee.options))??_e,ce=isNode(ae)?ae:new Scalar(ae);return ce.range=_e.range,ce.tag=ie,re!=null&&re.format&&(ce.format=re.format),ce}function resolveBlockScalar(t,ee,te){const ne=t.offset,oe=parseBlockScalarHeader(t,ee,te);if(!oe)return{value:"",type:null,comment:"",range:[ne,ne,ne]};const ie=oe.mode===">"?Scalar.BLOCK_FOLDED:Scalar.BLOCK_LITERAL,se=t.source?splitLines(t.source):[];let re=se.length;for(let pe=se.length-1;pe>=0;--pe){const fe=se[pe][1];if(fe===""||fe==="\r")re=pe;else break}if(re===0){const pe=oe.chomp==="+"&&se.length>0?`
`.repeat(Math.max(1,se.length-1)):"";let fe=ne+oe.length;return t.source&&(fe+=t.source.length),{value:pe,type:ie,comment:oe.comment,range:[ne,fe,fe]}}let _e=t.indent+oe.indent,ae=t.offset+oe.length,ce=0;for(let pe=0;pe<re;++pe){const[fe,ge]=se[pe];if(ge===""||ge==="\r")oe.indent===0&&fe.length>_e&&(_e=fe.length);else{if(fe.length<_e){const he="Block scalars with more-indented leading empty lines must use an explicit indentation indicator";te(ae+fe.length,"MISSING_CHAR",he)}oe.indent===0&&(_e=fe.length),ce=pe;break}ae+=fe.length+ge.length+1}for(let pe=se.length-1;pe>=re;--pe)se[pe][0].length>_e&&(re=pe+1);let le="",ue="",de=!1;for(let pe=0;pe<ce;++pe)le+=se[pe][0].slice(_e)+`
`;for(let pe=ce;pe<re;++pe){let[fe,ge]=se[pe];ae+=fe.length+ge.length+1;const he=ge[ge.length-1]==="\r";if(he&&(ge=ge.slice(0,-1)),ge&&fe.length<_e){const ve=`Block scalar lines must not be less indented than their ${oe.indent?"explicit indentation indicator":"first line"}`;te(ae-ge.length-(he?2:1),"BAD_INDENT",ve),fe=""}ie===Scalar.BLOCK_LITERAL?(le+=ue+fe.slice(_e)+ge,ue=`
`):fe.length>_e||ge[0]==="	"?(ue===" "?ue=`
`:!de&&ue===`
`&&(ue=`

`),le+=ue+fe.slice(_e)+ge,ue=`
`,de=!0):ge===""?ue===`
`?le+=`
`:ue=`
`:(le+=ue+ge,ue=" ",de=!1)}switch(oe.chomp){case"-":break;case"+":for(let pe=re;pe<se.length;++pe)le+=`
`+se[pe][0].slice(_e);le[le.length-1]!==`
`&&(le+=`
`);break;default:le+=`
`}const me=ne+oe.length+t.source.length;return{value:le,type:ie,comment:oe.comment,range:[ne,me,me]}}function parseBlockScalarHeader({offset:t,props:ee},te,ne){if(ee[0].type!=="block-scalar-header")return ne(ee[0],"IMPOSSIBLE","Block scalar header not found"),null;const{source:oe}=ee[0],ie=oe[0];let se=0,re="",_e=-1;for(let ue=1;ue<oe.length;++ue){const de=oe[ue];if(!re&&(de==="-"||de==="+"))re=de;else{const me=Number(de);!se&&me?se=me:_e===-1&&(_e=t+ue)}}_e!==-1&&ne(_e,"UNEXPECTED_TOKEN",`Block scalar header includes extra characters: ${oe}`);let ae=!1,ce="",le=oe.length;for(let ue=1;ue<ee.length;++ue){const de=ee[ue];switch(de.type){case"space":ae=!0;case"newline":le+=de.source.length;break;case"comment":te&&!ae&&ne(de,"MISSING_CHAR","Comments must be separated from other tokens by white space characters"),le+=de.source.length,ce=de.source.substring(1);break;case"error":ne(de,"UNEXPECTED_TOKEN",de.message),le+=de.source.length;break;default:{const me=`Unexpected token in block scalar header: ${de.type}`;ne(de,"UNEXPECTED_TOKEN",me);const pe=de.source;pe&&typeof pe=="string"&&(le+=pe.length)}}}return{mode:ie,indent:se,chomp:re,comment:ce,length:le}}function splitLines(t){const ee=t.split(/\n( *)/),te=ee[0],ne=te.match(/^( *)/),ie=[ne!=null&&ne[1]?[ne[1],te.slice(ne[1].length)]:["",te]];for(let se=1;se<ee.length;se+=2)ie.push([ee[se],ee[se+1]]);return ie}function resolveFlowScalar(t,ee,te){const{offset:ne,type:oe,source:ie,end:se}=t;let re,_e;const ae=(ue,de,me)=>te(ne+ue,de,me);switch(oe){case"scalar":re=Scalar.PLAIN,_e=plainValue(ie,ae);break;case"single-quoted-scalar":re=Scalar.QUOTE_SINGLE,_e=singleQuotedValue(ie,ae);break;case"double-quoted-scalar":re=Scalar.QUOTE_DOUBLE,_e=doubleQuotedValue(ie,ae);break;default:return te(t,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${oe}`),{value:"",type:null,comment:"",range:[ne,ne+ie.length,ne+ie.length]}}const ce=ne+ie.length,le=resolveEnd(se,ce,ee,te);return{value:_e,type:re,comment:le.comment,range:[ne,ce,le.offset]}}function plainValue(t,ee){let te="";switch(t[0]){case"	":te="a tab character";break;case",":te="flow indicator character ,";break;case"%":te="directive indicator character %";break;case"|":case">":{te=`block scalar indicator ${t[0]}`;break}case"@":case"`":{te=`reserved character ${t[0]}`;break}}return te&&ee(0,"BAD_SCALAR_START",`Plain value cannot start with ${te}`),foldLines(t)}function singleQuotedValue(t,ee){return(t[t.length-1]!=="'"||t.length===1)&&ee(t.length,"MISSING_CHAR","Missing closing 'quote"),foldLines(t.slice(1,-1)).replace(/''/g,"'")}function foldLines(t){let ee,te;try{ee=new RegExp(`(.*?)(?<![ 	])[ 	]*\r?
`,"sy"),te=new RegExp(`[ 	]*(.*?)(?:(?<![ 	])[ 	]*)?\r?
`,"sy")}catch{ee=/(.*?)[ \t]*\r?\n/sy,te=/[ \t]*(.*?)[ \t]*\r?\n/sy}let ne=ee.exec(t);if(!ne)return t;let oe=ne[1],ie=" ",se=ee.lastIndex;for(te.lastIndex=se;ne=te.exec(t);)ne[1]===""?ie===`
`?oe+=ie:ie=`
`:(oe+=ie+ne[1],ie=" "),se=te.lastIndex;const re=/[ \t]*(.*)/sy;return re.lastIndex=se,ne=re.exec(t),oe+ie+((ne==null?void 0:ne[1])??"")}function doubleQuotedValue(t,ee){let te="";for(let ne=1;ne<t.length-1;++ne){const oe=t[ne];if(!(oe==="\r"&&t[ne+1]===`
`))if(oe===`
`){const{fold:ie,offset:se}=foldNewline(t,ne);te+=ie,ne=se}else if(oe==="\\"){let ie=t[++ne];const se=escapeCodes[ie];if(se)te+=se;else if(ie===`
`)for(ie=t[ne+1];ie===" "||ie==="	";)ie=t[++ne+1];else if(ie==="\r"&&t[ne+1]===`
`)for(ie=t[++ne+1];ie===" "||ie==="	";)ie=t[++ne+1];else if(ie==="x"||ie==="u"||ie==="U"){const re={x:2,u:4,U:8}[ie];te+=parseCharCode(t,ne+1,re,ee),ne+=re}else{const re=t.substr(ne-1,2);ee(ne-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${re}`),te+=re}}else if(oe===" "||oe==="	"){const ie=ne;let se=t[ne+1];for(;se===" "||se==="	";)se=t[++ne+1];se!==`
`&&!(se==="\r"&&t[ne+2]===`
`)&&(te+=ne>ie?t.slice(ie,ne+1):oe)}else te+=oe}return(t[t.length-1]!=='"'||t.length===1)&&ee(t.length,"MISSING_CHAR",'Missing closing "quote'),te}function foldNewline(t,ee){let te="",ne=t[ee+1];for(;(ne===" "||ne==="	"||ne===`
`||ne==="\r")&&!(ne==="\r"&&t[ee+2]!==`
`);)ne===`
`&&(te+=`
`),ee+=1,ne=t[ee+1];return te||(te=" "),{fold:te,offset:ee}}const escapeCodes={0:"\0",a:"\x07",b:"\b",e:"\x1B",f:"\f",n:`
`,r:"\r",t:"	",v:"\v",N:"",_:" ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","	":"	"};function parseCharCode(t,ee,te,ne){const oe=t.substr(ee,te),se=oe.length===te&&/^[0-9a-fA-F]+$/.test(oe)?parseInt(oe,16):NaN;if(isNaN(se)){const re=t.substr(ee-2,te+2);return ne(ee-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${re}`),re}return String.fromCodePoint(se)}function composeScalar(t,ee,te,ne){const{value:oe,type:ie,comment:se,range:re}=ee.type==="block-scalar"?resolveBlockScalar(ee,t.options.strict,ne):resolveFlowScalar(ee,t.options.strict,ne),_e=te?t.directives.tagName(te.source,le=>ne(te,"TAG_RESOLVE_FAILED",le)):null,ae=te&&_e?findScalarTagByName(t.schema,oe,_e,te,ne):ee.type==="scalar"?findScalarTagByTest(t,oe,ee,ne):t.schema[SCALAR$1];let ce;try{const le=ae.resolve(oe,ue=>ne(te??ee,"TAG_RESOLVE_FAILED",ue),t.options);ce=isScalar(le)?le:new Scalar(le)}catch(le){const ue=le instanceof Error?le.message:String(le);ne(te??ee,"TAG_RESOLVE_FAILED",ue),ce=new Scalar(oe)}return ce.range=re,ce.source=oe,ie&&(ce.type=ie),_e&&(ce.tag=_e),ae.format&&(ce.format=ae.format),se&&(ce.comment=se),ce}function findScalarTagByName(t,ee,te,ne,oe){var re;if(te==="!")return t[SCALAR$1];const ie=[];for(const _e of t.tags)if(!_e.collection&&_e.tag===te)if(_e.default&&_e.test)ie.push(_e);else return _e;for(const _e of ie)if((re=_e.test)!=null&&re.test(ee))return _e;const se=t.knownTags[te];return se&&!se.collection?(t.tags.push(Object.assign({},se,{default:!1,test:void 0})),se):(oe(ne,"TAG_RESOLVE_FAILED",`Unresolved tag: ${te}`,te!=="tag:yaml.org,2002:str"),t[SCALAR$1])}function findScalarTagByTest({directives:t,schema:ee},te,ne,oe){const ie=ee.tags.find(se=>{var re;return se.default&&((re=se.test)==null?void 0:re.test(te))})||ee[SCALAR$1];if(ee.compat){const se=ee.compat.find(re=>{var _e;return re.default&&((_e=re.test)==null?void 0:_e.test(te))})??ee[SCALAR$1];if(ie.tag!==se.tag){const re=t.tagString(ie.tag),_e=t.tagString(se.tag),ae=`Value may be parsed as either ${re} or ${_e}`;oe(ne,"TAG_RESOLVE_FAILED",ae,!0)}}return ie}function emptyScalarPosition(t,ee,te){if(ee){te===null&&(te=ee.length);for(let ne=te-1;ne>=0;--ne){let oe=ee[ne];switch(oe.type){case"space":case"comment":case"newline":t-=oe.source.length;continue}for(oe=ee[++ne];(oe==null?void 0:oe.type)==="space";)t+=oe.source.length,oe=ee[++ne];break}}return t}const CN={composeNode,composeEmptyNode};function composeNode(t,ee,te,ne){const{spaceBefore:oe,comment:ie,anchor:se,tag:re}=te;let _e,ae=!0;switch(ee.type){case"alias":_e=composeAlias(t,ee,ne),(se||re)&&ne(ee,"ALIAS_PROPS","An alias node must not specify any properties");break;case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"block-scalar":_e=composeScalar(t,ee,re,ne),se&&(_e.anchor=se.source.substring(1));break;case"block-map":case"block-seq":case"flow-collection":_e=composeCollection(CN,t,ee,re,ne),se&&(_e.anchor=se.source.substring(1));break;default:{const ce=ee.type==="error"?ee.message:`Unsupported token (type: ${ee.type})`;ne(ee,"UNEXPECTED_TOKEN",ce),_e=composeEmptyNode(t,ee.offset,void 0,null,te,ne),ae=!1}}return se&&_e.anchor===""&&ne(se,"BAD_ALIAS","Anchor cannot be an empty string"),oe&&(_e.spaceBefore=!0),ie&&(ee.type==="scalar"&&ee.source===""?_e.comment=ie:_e.commentBefore=ie),t.options.keepSourceTokens&&ae&&(_e.srcToken=ee),_e}function composeEmptyNode(t,ee,te,ne,{spaceBefore:oe,comment:ie,anchor:se,tag:re,end:_e},ae){const ce={type:"scalar",offset:emptyScalarPosition(ee,te,ne),indent:-1,source:""},le=composeScalar(t,ce,re,ae);return se&&(le.anchor=se.source.substring(1),le.anchor===""&&ae(se,"BAD_ALIAS","Anchor cannot be an empty string")),oe&&(le.spaceBefore=!0),ie&&(le.comment=ie,le.range[2]=_e),le}function composeAlias({options:t},{offset:ee,source:te,end:ne},oe){const ie=new Alias(te.substring(1));ie.source===""&&oe(ee,"BAD_ALIAS","Alias cannot be an empty string"),ie.source.endsWith(":")&&oe(ee+te.length-1,"BAD_ALIAS","Alias ending in : is ambiguous",!0);const se=ee+te.length,re=resolveEnd(ne,se,t.strict,oe);return ie.range=[ee,se,re.offset],re.comment&&(ie.comment=re.comment),ie}function composeDoc(t,ee,{offset:te,start:ne,value:oe,end:ie},se){const re=Object.assign({_directives:ee},t),_e=new Document(void 0,re),ae={atRoot:!0,directives:_e.directives,options:_e.options,schema:_e.schema},ce=resolveProps(ne,{indicator:"doc-start",next:oe??(ie==null?void 0:ie[0]),offset:te,onError:se,startOnNewline:!0});ce.found&&(_e.directives.docStart=!0,oe&&(oe.type==="block-map"||oe.type==="block-seq")&&!ce.hasNewline&&se(ce.end,"MISSING_CHAR","Block collection cannot start on same line with directives-end marker")),_e.contents=oe?composeNode(ae,oe,ce,se):composeEmptyNode(ae,ce.end,ne,null,ce,se);const le=_e.contents.range[2],ue=resolveEnd(ie,le,!1,se);return ue.comment&&(_e.comment=ue.comment),_e.range=[te,le,ue.offset],_e}function getErrorPos(t){if(typeof t=="number")return[t,t+1];if(Array.isArray(t))return t.length===2?t:[t[0],t[1]];const{offset:ee,source:te}=t;return[ee,ee+(typeof te=="string"?te.length:1)]}function parsePrelude(t){var oe;let ee="",te=!1,ne=!1;for(let ie=0;ie<t.length;++ie){const se=t[ie];switch(se[0]){case"#":ee+=(ee===""?"":ne?`

`:`
`)+(se.substring(1)||" "),te=!0,ne=!1;break;case"%":((oe=t[ie+1])==null?void 0:oe[0])!=="#"&&(ie+=1),te=!1;break;default:te||(ne=!0),te=!1}}return{comment:ee,afterEmptyLine:ne}}class Composer{constructor(ee={}){this.doc=null,this.atDirectives=!1,this.prelude=[],this.errors=[],this.warnings=[],this.onError=(te,ne,oe,ie)=>{const se=getErrorPos(te);ie?this.warnings.push(new YAMLWarning(se,ne,oe)):this.errors.push(new YAMLParseError(se,ne,oe))},this.directives=new Directives({version:ee.version||"1.2"}),this.options=ee}decorate(ee,te){const{comment:ne,afterEmptyLine:oe}=parsePrelude(this.prelude);if(ne){const ie=ee.contents;if(te)ee.comment=ee.comment?`${ee.comment}
${ne}`:ne;else if(oe||ee.directives.docStart||!ie)ee.commentBefore=ne;else if(isCollection(ie)&&!ie.flow&&ie.items.length>0){let se=ie.items[0];isPair(se)&&(se=se.key);const re=se.commentBefore;se.commentBefore=re?`${ne}
${re}`:ne}else{const se=ie.commentBefore;ie.commentBefore=se?`${ne}
${se}`:ne}}te?(Array.prototype.push.apply(ee.errors,this.errors),Array.prototype.push.apply(ee.warnings,this.warnings)):(ee.errors=this.errors,ee.warnings=this.warnings),this.prelude=[],this.errors=[],this.warnings=[]}streamInfo(){return{comment:parsePrelude(this.prelude).comment,directives:this.directives,errors:this.errors,warnings:this.warnings}}*compose(ee,te=!1,ne=-1){for(const oe of ee)yield*this.next(oe);yield*this.end(te,ne)}*next(ee){switch(ee.type){case"directive":this.directives.add(ee.source,(te,ne,oe)=>{const ie=getErrorPos(ee);ie[0]+=te,this.onError(ie,"BAD_DIRECTIVE",ne,oe)}),this.prelude.push(ee.source),this.atDirectives=!0;break;case"document":{const te=composeDoc(this.options,this.directives,ee,this.onError);this.atDirectives&&!te.directives.docStart&&this.onError(ee,"MISSING_CHAR","Missing directives-end/doc-start indicator line"),this.decorate(te,!1),this.doc&&(yield this.doc),this.doc=te,this.atDirectives=!1;break}case"byte-order-mark":case"space":break;case"comment":case"newline":this.prelude.push(ee.source);break;case"error":{const te=ee.source?`${ee.message}: ${JSON.stringify(ee.source)}`:ee.message,ne=new YAMLParseError(getErrorPos(ee),"UNEXPECTED_TOKEN",te);this.atDirectives||!this.doc?this.errors.push(ne):this.doc.errors.push(ne);break}case"doc-end":{if(!this.doc){const ne="Unexpected doc-end without preceding document";this.errors.push(new YAMLParseError(getErrorPos(ee),"UNEXPECTED_TOKEN",ne));break}this.doc.directives.docEnd=!0;const te=resolveEnd(ee.end,ee.offset+ee.source.length,this.doc.options.strict,this.onError);if(this.decorate(this.doc,!0),te.comment){const ne=this.doc.comment;this.doc.comment=ne?`${ne}
${te.comment}`:te.comment}this.doc.range[2]=te.offset;break}default:this.errors.push(new YAMLParseError(getErrorPos(ee),"UNEXPECTED_TOKEN",`Unsupported token ${ee.type}`))}}*end(ee=!1,te=-1){if(this.doc)this.decorate(this.doc,!0),yield this.doc,this.doc=null;else if(ee){const ne=Object.assign({_directives:this.directives},this.options),oe=new Document(void 0,ne);this.atDirectives&&this.onError(te,"MISSING_CHAR","Missing directives-end indicator line"),oe.range=[0,te,te],this.decorate(oe,!1),yield oe}}}const BOM="\uFEFF",DOCUMENT="",FLOW_END="",SCALAR="";function tokenType(t){switch(t){case BOM:return"byte-order-mark";case DOCUMENT:return"doc-mode";case FLOW_END:return"flow-error-end";case SCALAR:return"scalar";case"---":return"doc-start";case"...":return"doc-end";case"":case`
`:case`\r
`:return"newline";case"-":return"seq-item-ind";case"?":return"explicit-key-ind";case":":return"map-value-ind";case"{":return"flow-map-start";case"}":return"flow-map-end";case"[":return"flow-seq-start";case"]":return"flow-seq-end";case",":return"comma"}switch(t[0]){case" ":case"	":return"space";case"#":return"comment";case"%":return"directive-line";case"*":return"alias";case"&":return"anchor";case"!":return"tag";case"'":return"single-quoted-scalar";case'"':return"double-quoted-scalar";case"|":case">":return"block-scalar-header"}return null}function isEmpty(t){switch(t){case void 0:case" ":case`
`:case"\r":case"	":return!0;default:return!1}}const hexDigits="0123456789ABCDEFabcdef".split(""),tagChars="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()".split(""),invalidFlowScalarChars=",[]{}".split(""),invalidAnchorChars=` ,[]{}
\r	`.split(""),isNotAnchorChar=t=>!t||invalidAnchorChars.includes(t);class Lexer{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(ee,te=!1){ee&&(this.buffer=this.buffer?this.buffer+ee:ee,this.lineEndPos=null),this.atEnd=!te;let ne=this.next??"stream";for(;ne&&(te||this.hasChars(1));)ne=yield*this.parseNext(ne)}atLineEnd(){let ee=this.pos,te=this.buffer[ee];for(;te===" "||te==="	";)te=this.buffer[++ee];return!te||te==="#"||te===`
`?!0:te==="\r"?this.buffer[ee+1]===`
`:!1}charAt(ee){return this.buffer[this.pos+ee]}continueScalar(ee){let te=this.buffer[ee];if(this.indentNext>0){let ne=0;for(;te===" ";)te=this.buffer[++ne+ee];if(te==="\r"){const oe=this.buffer[ne+ee+1];if(oe===`
`||!oe&&!this.atEnd)return ee+ne+1}return te===`
`||ne>=this.indentNext||!te&&!this.atEnd?ee+ne:-1}if(te==="-"||te==="."){const ne=this.buffer.substr(ee,3);if((ne==="---"||ne==="...")&&isEmpty(this.buffer[ee+3]))return-1}return ee}getLine(){let ee=this.lineEndPos;return(typeof ee!="number"||ee!==-1&&ee<this.pos)&&(ee=this.buffer.indexOf(`
`,this.pos),this.lineEndPos=ee),ee===-1?this.atEnd?this.buffer.substring(this.pos):null:(this.buffer[ee-1]==="\r"&&(ee-=1),this.buffer.substring(this.pos,ee))}hasChars(ee){return this.pos+ee<=this.buffer.length}setNext(ee){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=ee,null}peek(ee){return this.buffer.substr(this.pos,ee)}*parseNext(ee){switch(ee){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let ee=this.getLine();if(ee===null)return this.setNext("stream");if(ee[0]===BOM&&(yield*this.pushCount(1),ee=ee.substring(1)),ee[0]==="%"){let te=ee.length;const ne=ee.indexOf("#");if(ne!==-1){const ie=ee[ne-1];(ie===" "||ie==="	")&&(te=ne-1)}for(;;){const ie=ee[te-1];if(ie===" "||ie==="	")te-=1;else break}const oe=(yield*this.pushCount(te))+(yield*this.pushSpaces(!0));return yield*this.pushCount(ee.length-oe),this.pushNewline(),"stream"}if(this.atLineEnd()){const te=yield*this.pushSpaces(!0);return yield*this.pushCount(ee.length-te),yield*this.pushNewline(),"stream"}return yield DOCUMENT,yield*this.parseLineStart()}*parseLineStart(){const ee=this.charAt(0);if(!ee&&!this.atEnd)return this.setNext("line-start");if(ee==="-"||ee==="."){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const te=this.peek(3);if(te==="---"&&isEmpty(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,"doc";if(te==="..."&&isEmpty(this.charAt(3)))return yield*this.pushCount(3),"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!isEmpty(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[ee,te]=this.peek(2);if(!te&&!this.atEnd)return this.setNext("block-start");if((ee==="-"||ee==="?"||ee===":")&&isEmpty(te)){const ne=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=ne,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const ee=this.getLine();if(ee===null)return this.setNext("doc");let te=yield*this.pushIndicators();switch(ee[te]){case"#":yield*this.pushCount(ee.length-te);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(isNotAnchorChar),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return te+=yield*this.parseBlockScalarHeader(),te+=yield*this.pushSpaces(!0),yield*this.pushCount(ee.length-te),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let ee,te,ne=-1;do ee=yield*this.pushNewline(),ee>0?(te=yield*this.pushSpaces(!1),this.indentValue=ne=te):te=0,te+=yield*this.pushSpaces(!0);while(ee+te>0);const oe=this.getLine();if(oe===null)return this.setNext("flow");if((ne!==-1&&ne<this.indentNext&&oe[0]!=="#"||ne===0&&(oe.startsWith("---")||oe.startsWith("..."))&&isEmpty(oe[3]))&&!(ne===this.indentNext-1&&this.flowLevel===1&&(oe[0]==="]"||oe[0]==="}")))return this.flowLevel=0,yield FLOW_END,yield*this.parseLineStart();let ie=0;for(;oe[ie]===",";)ie+=yield*this.pushCount(1),ie+=yield*this.pushSpaces(!0),this.flowKey=!1;switch(ie+=yield*this.pushIndicators(),oe[ie]){case void 0:return"flow";case"#":return yield*this.pushCount(oe.length-ie),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(isNotAnchorChar),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const se=this.charAt(1);if(this.flowKey||isEmpty(se)||se===",")return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const ee=this.charAt(0);let te=this.buffer.indexOf(ee,this.pos+1);if(ee==="'")for(;te!==-1&&this.buffer[te+1]==="'";)te=this.buffer.indexOf("'",te+2);else for(;te!==-1;){let ie=0;for(;this.buffer[te-1-ie]==="\\";)ie+=1;if(ie%2===0)break;te=this.buffer.indexOf('"',te+1)}const ne=this.buffer.substring(0,te);let oe=ne.indexOf(`
`,this.pos);if(oe!==-1){for(;oe!==-1;){const ie=this.continueScalar(oe+1);if(ie===-1)break;oe=ne.indexOf(`
`,ie)}oe!==-1&&(te=oe-(ne[oe-1]==="\r"?2:1))}if(te===-1){if(!this.atEnd)return this.setNext("quoted-scalar");te=this.buffer.length}return yield*this.pushToIndex(te+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let ee=this.pos;for(;;){const te=this.buffer[++ee];if(te==="+")this.blockScalarKeep=!0;else if(te>"0"&&te<="9")this.blockScalarIndent=Number(te)-1;else if(te!=="-")break}return yield*this.pushUntil(te=>isEmpty(te)||te==="#")}*parseBlockScalar(){let ee=this.pos-1,te=0,ne;e:for(let oe=this.pos;ne=this.buffer[oe];++oe)switch(ne){case" ":te+=1;break;case`
`:ee=oe,te=0;break;case"\r":{const ie=this.buffer[oe+1];if(!ie&&!this.atEnd)return this.setNext("block-scalar");if(ie===`
`)break}default:break e}if(!ne&&!this.atEnd)return this.setNext("block-scalar");if(te>=this.indentNext){this.blockScalarIndent===-1?this.indentNext=te:this.indentNext+=this.blockScalarIndent;do{const oe=this.continueScalar(ee+1);if(oe===-1)break;ee=this.buffer.indexOf(`
`,oe)}while(ee!==-1);if(ee===-1){if(!this.atEnd)return this.setNext("block-scalar");ee=this.buffer.length}}if(!this.blockScalarKeep)do{let oe=ee-1,ie=this.buffer[oe];ie==="\r"&&(ie=this.buffer[--oe]);const se=oe;for(;ie===" "||ie==="	";)ie=this.buffer[--oe];if(ie===`
`&&oe>=this.pos&&oe+1+te>se)ee=oe;else break}while(!0);return yield SCALAR,yield*this.pushToIndex(ee+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const ee=this.flowLevel>0;let te=this.pos-1,ne=this.pos-1,oe;for(;oe=this.buffer[++ne];)if(oe===":"){const ie=this.buffer[ne+1];if(isEmpty(ie)||ee&&ie===",")break;te=ne}else if(isEmpty(oe)){let ie=this.buffer[ne+1];if(oe==="\r"&&(ie===`
`?(ne+=1,oe=`
`,ie=this.buffer[ne+1]):te=ne),ie==="#"||ee&&invalidFlowScalarChars.includes(ie))break;if(oe===`
`){const se=this.continueScalar(ne+1);if(se===-1)break;ne=Math.max(ne,se-2)}}else{if(ee&&invalidFlowScalarChars.includes(oe))break;te=ne}return!oe&&!this.atEnd?this.setNext("plain-scalar"):(yield SCALAR,yield*this.pushToIndex(te+1,!0),ee?"flow":"doc")}*pushCount(ee){return ee>0?(yield this.buffer.substr(this.pos,ee),this.pos+=ee,ee):0}*pushToIndex(ee,te){const ne=this.buffer.slice(this.pos,ee);return ne?(yield ne,this.pos+=ne.length,ne.length):(te&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(isNotAnchorChar))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const ee=this.flowLevel>0,te=this.charAt(1);if(isEmpty(te)||ee&&invalidFlowScalarChars.includes(te))return ee?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if(this.charAt(1)==="<"){let ee=this.pos+2,te=this.buffer[ee];for(;!isEmpty(te)&&te!==">";)te=this.buffer[++ee];return yield*this.pushToIndex(te===">"?ee+1:ee,!1)}else{let ee=this.pos+1,te=this.buffer[ee];for(;te;)if(tagChars.includes(te))te=this.buffer[++ee];else if(te==="%"&&hexDigits.includes(this.buffer[ee+1])&&hexDigits.includes(this.buffer[ee+2]))te=this.buffer[ee+=3];else break;return yield*this.pushToIndex(ee,!1)}}*pushNewline(){const ee=this.buffer[this.pos];return ee===`
`?yield*this.pushCount(1):ee==="\r"&&this.charAt(1)===`
`?yield*this.pushCount(2):0}*pushSpaces(ee){let te=this.pos-1,ne;do ne=this.buffer[++te];while(ne===" "||ee&&ne==="	");const oe=te-this.pos;return oe>0&&(yield this.buffer.substr(this.pos,oe),this.pos=te),oe}*pushUntil(ee){let te=this.pos,ne=this.buffer[te];for(;!ee(ne);)ne=this.buffer[++te];return yield*this.pushToIndex(te,!1)}}class LineCounter{constructor(){this.lineStarts=[],this.addNewLine=ee=>this.lineStarts.push(ee),this.linePos=ee=>{let te=0,ne=this.lineStarts.length;for(;te<ne;){const ie=te+ne>>1;this.lineStarts[ie]<ee?te=ie+1:ne=ie}if(this.lineStarts[te]===ee)return{line:te+1,col:1};if(te===0)return{line:0,col:ee};const oe=this.lineStarts[te-1];return{line:te,col:ee-oe+1}}}}function includesToken(t,ee){for(let te=0;te<t.length;++te)if(t[te].type===ee)return!0;return!1}function findNonEmptyIndex(t){for(let ee=0;ee<t.length;++ee)switch(t[ee].type){case"space":case"comment":case"newline":break;default:return ee}return-1}function isFlowToken(t){switch(t==null?void 0:t.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":case"flow-collection":return!0;default:return!1}}function getPrevProps(t){switch(t.type){case"document":return t.start;case"block-map":{const ee=t.items[t.items.length-1];return ee.sep??ee.start}case"block-seq":return t.items[t.items.length-1].start;default:return[]}}function getFirstKeyStartProps(t){var te;if(t.length===0)return[];let ee=t.length;e:for(;--ee>=0;)switch(t[ee].type){case"doc-start":case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":case"newline":break e}for(;((te=t[++ee])==null?void 0:te.type)==="space";);return t.splice(ee,t.length)}function fixFlowSeqItems(t){if(t.start.type==="flow-seq-start")for(const ee of t.items)ee.sep&&!ee.value&&!includesToken(ee.start,"explicit-key-ind")&&!includesToken(ee.sep,"map-value-ind")&&(ee.key&&(ee.value=ee.key),delete ee.key,isFlowToken(ee.value)?ee.value.end?Array.prototype.push.apply(ee.value.end,ee.sep):ee.value.end=ee.sep:Array.prototype.push.apply(ee.start,ee.sep),delete ee.sep)}class Parser{constructor(ee){this.atNewLine=!0,this.atScalar=!1,this.indent=0,this.offset=0,this.onKeyLine=!1,this.stack=[],this.source="",this.type="",this.lexer=new Lexer,this.onNewLine=ee}*parse(ee,te=!1){this.onNewLine&&this.offset===0&&this.onNewLine(0);for(const ne of this.lexer.lex(ee,te))yield*this.next(ne);te||(yield*this.end())}*next(ee){if(this.source=ee,this.atScalar){this.atScalar=!1,yield*this.step(),this.offset+=ee.length;return}const te=tokenType(ee);if(te)if(te==="scalar")this.atNewLine=!1,this.atScalar=!0,this.type="scalar";else{switch(this.type=te,yield*this.step(),te){case"newline":this.atNewLine=!0,this.indent=0,this.onNewLine&&this.onNewLine(this.offset+ee.length);break;case"space":this.atNewLine&&ee[0]===" "&&(this.indent+=ee.length);break;case"explicit-key-ind":case"map-value-ind":case"seq-item-ind":this.atNewLine&&(this.indent+=ee.length);break;case"doc-mode":case"flow-error-end":return;default:this.atNewLine=!1}this.offset+=ee.length}else{const ne=`Not a YAML token: ${ee}`;yield*this.pop({type:"error",offset:this.offset,message:ne,source:ee}),this.offset+=ee.length}}*end(){for(;this.stack.length>0;)yield*this.pop()}get sourceToken(){return{type:this.type,offset:this.offset,indent:this.indent,source:this.source}}*step(){const ee=this.peek(1);if(this.type==="doc-end"&&(!ee||ee.type!=="doc-end")){for(;this.stack.length>0;)yield*this.pop();this.stack.push({type:"doc-end",offset:this.offset,source:this.source});return}if(!ee)return yield*this.stream();switch(ee.type){case"document":return yield*this.document(ee);case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return yield*this.scalar(ee);case"block-scalar":return yield*this.blockScalar(ee);case"block-map":return yield*this.blockMap(ee);case"block-seq":return yield*this.blockSequence(ee);case"flow-collection":return yield*this.flowCollection(ee);case"doc-end":return yield*this.documentEnd(ee)}yield*this.pop()}peek(ee){return this.stack[this.stack.length-ee]}*pop(ee){const te=ee??this.stack.pop();if(te)if(this.stack.length===0)yield te;else{const ne=this.peek(1);switch(te.type==="block-scalar"?te.indent="indent"in ne?ne.indent:0:te.type==="flow-collection"&&ne.type==="document"&&(te.indent=0),te.type==="flow-collection"&&fixFlowSeqItems(te),ne.type){case"document":ne.value=te;break;case"block-scalar":ne.props.push(te);break;case"block-map":{const oe=ne.items[ne.items.length-1];if(oe.value){ne.items.push({start:[],key:te,sep:[]}),this.onKeyLine=!0;return}else if(oe.sep)oe.value=te;else{Object.assign(oe,{key:te,sep:[]}),this.onKeyLine=!includesToken(oe.start,"explicit-key-ind");return}break}case"block-seq":{const oe=ne.items[ne.items.length-1];oe.value?ne.items.push({start:[],value:te}):oe.value=te;break}case"flow-collection":{const oe=ne.items[ne.items.length-1];!oe||oe.value?ne.items.push({start:[],key:te,sep:[]}):oe.sep?oe.value=te:Object.assign(oe,{key:te,sep:[]});return}default:yield*this.pop(),yield*this.pop(te)}if((ne.type==="document"||ne.type==="block-map"||ne.type==="block-seq")&&(te.type==="block-map"||te.type==="block-seq")){const oe=te.items[te.items.length-1];oe&&!oe.sep&&!oe.value&&oe.start.length>0&&findNonEmptyIndex(oe.start)===-1&&(te.indent===0||oe.start.every(ie=>ie.type!=="comment"||ie.indent<te.indent))&&(ne.type==="document"?ne.end=oe.start:ne.items.push({start:oe.start}),te.items.splice(-1,1))}}else{const ne="Tried to pop an empty stack";yield{type:"error",offset:this.offset,source:"",message:ne}}}*stream(){switch(this.type){case"directive-line":yield{type:"directive",offset:this.offset,source:this.source};return;case"byte-order-mark":case"space":case"comment":case"newline":yield this.sourceToken;return;case"doc-mode":case"doc-start":{const ee={type:"document",offset:this.offset,start:[]};this.type==="doc-start"&&ee.start.push(this.sourceToken),this.stack.push(ee);return}}yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML stream`,source:this.source}}*document(ee){if(ee.value)return yield*this.lineEnd(ee);switch(this.type){case"doc-start":{findNonEmptyIndex(ee.start)!==-1?(yield*this.pop(),yield*this.step()):ee.start.push(this.sourceToken);return}case"anchor":case"tag":case"space":case"comment":case"newline":ee.start.push(this.sourceToken);return}const te=this.startBlockValue(ee);te?this.stack.push(te):yield{type:"error",offset:this.offset,message:`Unexpected ${this.type} token in YAML document`,source:this.source}}*scalar(ee){if(this.type==="map-value-ind"){const te=getPrevProps(this.peek(2)),ne=getFirstKeyStartProps(te);let oe;ee.end?(oe=ee.end,oe.push(this.sourceToken),delete ee.end):oe=[this.sourceToken];const ie={type:"block-map",offset:ee.offset,indent:ee.indent,items:[{start:ne,key:ee,sep:oe}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=ie}else yield*this.lineEnd(ee)}*blockScalar(ee){switch(this.type){case"space":case"comment":case"newline":ee.props.push(this.sourceToken);return;case"scalar":if(ee.source=this.source,this.atNewLine=!0,this.indent=0,this.onNewLine){let te=this.source.indexOf(`
`)+1;for(;te!==0;)this.onNewLine(this.offset+te),te=this.source.indexOf(`
`,te)+1}yield*this.pop();break;default:yield*this.pop(),yield*this.step()}}*blockMap(ee){var ne;const te=ee.items[ee.items.length-1];switch(this.type){case"newline":if(this.onKeyLine=!1,te.value){const oe="end"in te.value?te.value.end:void 0,ie=Array.isArray(oe)?oe[oe.length-1]:void 0;(ie==null?void 0:ie.type)==="comment"?oe==null||oe.push(this.sourceToken):ee.items.push({start:[this.sourceToken]})}else te.sep?te.sep.push(this.sourceToken):te.start.push(this.sourceToken);return;case"space":case"comment":if(te.value)ee.items.push({start:[this.sourceToken]});else if(te.sep)te.sep.push(this.sourceToken);else{if(this.atIndentedComment(te.start,ee.indent)){const oe=ee.items[ee.items.length-2],ie=(ne=oe==null?void 0:oe.value)==null?void 0:ne.end;if(Array.isArray(ie)){Array.prototype.push.apply(ie,te.start),ie.push(this.sourceToken),ee.items.pop();return}}te.start.push(this.sourceToken)}return}if(this.indent>=ee.indent){const oe=!this.onKeyLine&&this.indent===ee.indent&&te.sep;let ie=[];if(oe&&te.sep&&!te.value){const se=[];for(let re=0;re<te.sep.length;++re){const _e=te.sep[re];switch(_e.type){case"newline":se.push(re);break;case"space":break;case"comment":_e.indent>ee.indent&&(se.length=0);break;default:se.length=0}}se.length>=2&&(ie=te.sep.splice(se[1]))}switch(this.type){case"anchor":case"tag":oe||te.value?(ie.push(this.sourceToken),ee.items.push({start:ie}),this.onKeyLine=!0):te.sep?te.sep.push(this.sourceToken):te.start.push(this.sourceToken);return;case"explicit-key-ind":!te.sep&&!includesToken(te.start,"explicit-key-ind")?te.start.push(this.sourceToken):oe||te.value?(ie.push(this.sourceToken),ee.items.push({start:ie})):this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]}),this.onKeyLine=!0;return;case"map-value-ind":if(includesToken(te.start,"explicit-key-ind"))if(te.sep)if(te.value)ee.items.push({start:[],key:null,sep:[this.sourceToken]});else if(includesToken(te.sep,"map-value-ind"))this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:ie,key:null,sep:[this.sourceToken]}]});else if(isFlowToken(te.key)&&!includesToken(te.sep,"newline")){const se=getFirstKeyStartProps(te.start),re=te.key,_e=te.sep;_e.push(this.sourceToken),delete te.key,delete te.sep,this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:se,key:re,sep:_e}]})}else ie.length>0?te.sep=te.sep.concat(ie,this.sourceToken):te.sep.push(this.sourceToken);else if(includesToken(te.start,"newline"))Object.assign(te,{key:null,sep:[this.sourceToken]});else{const se=getFirstKeyStartProps(te.start);this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:se,key:null,sep:[this.sourceToken]}]})}else te.sep?te.value||oe?ee.items.push({start:ie,key:null,sep:[this.sourceToken]}):includesToken(te.sep,"map-value-ind")?this.stack.push({type:"block-map",offset:this.offset,indent:this.indent,items:[{start:[],key:null,sep:[this.sourceToken]}]}):te.sep.push(this.sourceToken):Object.assign(te,{key:null,sep:[this.sourceToken]});this.onKeyLine=!0;return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const se=this.flowScalar(this.type);oe||te.value?(ee.items.push({start:ie,key:se,sep:[]}),this.onKeyLine=!0):te.sep?this.stack.push(se):(Object.assign(te,{key:se,sep:[]}),this.onKeyLine=!0);return}default:{const se=this.startBlockValue(ee);if(se){oe&&se.type!=="block-seq"&&includesToken(te.start,"explicit-key-ind")&&ee.items.push({start:ie}),this.stack.push(se);return}}}}yield*this.pop(),yield*this.step()}*blockSequence(ee){var ne;const te=ee.items[ee.items.length-1];switch(this.type){case"newline":if(te.value){const oe="end"in te.value?te.value.end:void 0,ie=Array.isArray(oe)?oe[oe.length-1]:void 0;(ie==null?void 0:ie.type)==="comment"?oe==null||oe.push(this.sourceToken):ee.items.push({start:[this.sourceToken]})}else te.start.push(this.sourceToken);return;case"space":case"comment":if(te.value)ee.items.push({start:[this.sourceToken]});else{if(this.atIndentedComment(te.start,ee.indent)){const oe=ee.items[ee.items.length-2],ie=(ne=oe==null?void 0:oe.value)==null?void 0:ne.end;if(Array.isArray(ie)){Array.prototype.push.apply(ie,te.start),ie.push(this.sourceToken),ee.items.pop();return}}te.start.push(this.sourceToken)}return;case"anchor":case"tag":if(te.value||this.indent<=ee.indent)break;te.start.push(this.sourceToken);return;case"seq-item-ind":if(this.indent!==ee.indent)break;te.value||includesToken(te.start,"seq-item-ind")?ee.items.push({start:[this.sourceToken]}):te.start.push(this.sourceToken);return}if(this.indent>ee.indent){const oe=this.startBlockValue(ee);if(oe){this.stack.push(oe);return}}yield*this.pop(),yield*this.step()}*flowCollection(ee){const te=ee.items[ee.items.length-1];if(this.type==="flow-error-end"){let ne;do yield*this.pop(),ne=this.peek(1);while(ne&&ne.type==="flow-collection")}else if(ee.end.length===0){switch(this.type){case"comma":case"explicit-key-ind":!te||te.sep?ee.items.push({start:[this.sourceToken]}):te.start.push(this.sourceToken);return;case"map-value-ind":!te||te.value?ee.items.push({start:[],key:null,sep:[this.sourceToken]}):te.sep?te.sep.push(this.sourceToken):Object.assign(te,{key:null,sep:[this.sourceToken]});return;case"space":case"comment":case"newline":case"anchor":case"tag":!te||te.value?ee.items.push({start:[this.sourceToken]}):te.sep?te.sep.push(this.sourceToken):te.start.push(this.sourceToken);return;case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":{const oe=this.flowScalar(this.type);!te||te.value?ee.items.push({start:[],key:oe,sep:[]}):te.sep?this.stack.push(oe):Object.assign(te,{key:oe,sep:[]});return}case"flow-map-end":case"flow-seq-end":ee.end.push(this.sourceToken);return}const ne=this.startBlockValue(ee);ne?this.stack.push(ne):(yield*this.pop(),yield*this.step())}else{const ne=this.peek(2);if(ne.type==="block-map"&&(this.type==="map-value-ind"&&ne.indent===ee.indent||this.type==="newline"&&!ne.items[ne.items.length-1].sep))yield*this.pop(),yield*this.step();else if(this.type==="map-value-ind"&&ne.type!=="flow-collection"){const oe=getPrevProps(ne),ie=getFirstKeyStartProps(oe);fixFlowSeqItems(ee);const se=ee.end.splice(1,ee.end.length);se.push(this.sourceToken);const re={type:"block-map",offset:ee.offset,indent:ee.indent,items:[{start:ie,key:ee,sep:se}]};this.onKeyLine=!0,this.stack[this.stack.length-1]=re}else yield*this.lineEnd(ee)}}flowScalar(ee){if(this.onNewLine){let te=this.source.indexOf(`
`)+1;for(;te!==0;)this.onNewLine(this.offset+te),te=this.source.indexOf(`
`,te)+1}return{type:ee,offset:this.offset,indent:this.indent,source:this.source}}startBlockValue(ee){switch(this.type){case"alias":case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return this.flowScalar(this.type);case"block-scalar-header":return{type:"block-scalar",offset:this.offset,indent:this.indent,props:[this.sourceToken],source:""};case"flow-map-start":case"flow-seq-start":return{type:"flow-collection",offset:this.offset,indent:this.indent,start:this.sourceToken,items:[],end:[]};case"seq-item-ind":return{type:"block-seq",offset:this.offset,indent:this.indent,items:[{start:[this.sourceToken]}]};case"explicit-key-ind":{this.onKeyLine=!0;const te=getPrevProps(ee),ne=getFirstKeyStartProps(te);return ne.push(this.sourceToken),{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:ne}]}}case"map-value-ind":{this.onKeyLine=!0;const te=getPrevProps(ee),ne=getFirstKeyStartProps(te);return{type:"block-map",offset:this.offset,indent:this.indent,items:[{start:ne,key:null,sep:[this.sourceToken]}]}}}return null}atIndentedComment(ee,te){return this.type!=="comment"||this.indent<=te?!1:ee.every(ne=>ne.type==="newline"||ne.type==="space")}*documentEnd(ee){this.type!=="doc-mode"&&(ee.end?ee.end.push(this.sourceToken):ee.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop()))}*lineEnd(ee){switch(this.type){case"comma":case"doc-start":case"doc-end":case"flow-seq-end":case"flow-map-end":case"map-value-ind":yield*this.pop(),yield*this.step();break;case"newline":this.onKeyLine=!1;case"space":case"comment":default:ee.end?ee.end.push(this.sourceToken):ee.end=[this.sourceToken],this.type==="newline"&&(yield*this.pop())}}}function parseOptions(t){const ee=t.prettyErrors!==!1;return{lineCounter:t.lineCounter||ee&&new LineCounter||null,prettyErrors:ee}}function parseDocument(t,ee={}){const{lineCounter:te,prettyErrors:ne}=parseOptions(ee),oe=new Parser(te==null?void 0:te.addNewLine),ie=new Composer(ee);let se=null;for(const re of ie.compose(oe.parse(t),!0,t.length))if(!se)se=re;else if(se.options.logLevel!=="silent"){se.errors.push(new YAMLParseError(re.range.slice(0,2),"MULTIPLE_DOCS","Source contains multiple documents; please use YAML.parseAllDocuments()"));break}return ne&&te&&(se.errors.forEach(prettifyError(t,te)),se.warnings.forEach(prettifyError(t,te))),se}function parse(t,ee,te){let ne;typeof ee=="function"?ne=ee:te===void 0&&ee&&typeof ee=="object"&&(te=ee);const oe=parseDocument(t,te);if(!oe)return null;if(oe.warnings.forEach(ie=>warn(oe.options.logLevel,ie)),oe.errors.length>0){if(oe.options.logLevel!=="silent")throw oe.errors[0];oe.errors=[]}return oe.toJS(Object.assign({reviver:ne},te))}function uuid_v4_for_tests(t){if(!Number.isInteger(t))throw new Error("uuid_v4_for_tests id must be an integer");if(t<0||t>10)throw new Error("uuid_v4_for_tests id must be 0-9 inclusive");return`${t}0000000-0000-4000-a000-000000000000`}const CalculationObjectError={empty_calculation:"Empty calculation",calculation_missing_value:"Calculation missing value attribute"};function get_plain_calculation_object_from_str(t){t=t.trim();let ee=Number.NaN,te,ne=[];do{if(!t){ne=[CalculationObjectError.empty_calculation];break}let oe;try{oe=parse(t,{intAsBigInt:!1})}catch(se){let re=se.message;re=re.replaceAll("@@","\\@\\@"),re=re.replaceAll(/^(?<replace>(?:\s\s)+)(?<post>\s?\^)/gm,(..._e)=>{const{replace:ae,post:ce}=_e[5];return("&nbsp; ".repeat(ae.length/2)+ce).replace("  "," &nbsp;")}),re=re.replaceAll(`

`,`
`),se.message=re,ne=[se];break}const ie=oe.value;(typeof ie=="number"||typeof ie=="string")&&(ee=ie),typeof oe.name=="string"&&(te=oe.name),Number.isNaN(ee)&&ne.push(CalculationObjectError.calculation_missing_value)}while(!1);return ne.length?{valid:!1,errors:ne}:{valid:!0,value:ee,name:te}}const run_get_plain_calculation_object_from_str_tests=describe("running tests of get_plain_calculation_object_from_str",()=>{let t="  ",ee=get_plain_calculation_object_from_str(t);test(ee,{valid:!1,errors:["Empty calculation"]},"Should find an invalid calculation object when empty string"),t="value: 10",ee=get_plain_calculation_object_from_str(t),test(ee,{valid:!0,value:10},"Should find a number value"),t=`value:
 10
`,ee=get_plain_calculation_object_from_str(t),test(ee,{valid:!0,value:10},"Should find a number value when on new line"),t=`value: >
 10
`,ee=get_plain_calculation_object_from_str(t),test(ee,{valid:!0,value:`10
`},"Should find a number value as a string when in a block");const te=uuid_v4_for_tests(1);t=`
value: @@${te}
`,ee=get_plain_calculation_object_from_str(t),test(ee,{valid:!1,errors:[{code:"BAD_SCALAR_START",linePos:[{col:8,line:1},{col:9,line:1}],message:`Plain value cannot start with reserved character @ at line 1, column 8:
value: \\@\\@10000000-0000-4000-a000-000000000000
&nbsp; &nbsp; &nbsp; &nbsp;^
`,name:"YAMLParseError",pos:[7,8]}]},"Will error on finding an unquoted uuid id"),t=`
value: "@@${te}"
`,ee=get_plain_calculation_object_from_str(t),test(ee,{valid:!0,value:`@@${te}`},"Will find an uuid id"),t=`
name: A
value: 33
`,ee=get_plain_calculation_object_from_str(t),test(ee,{valid:!0,value:33,name:"A"},"Will find a name and value")},!1);function parse_calculation_equations(t){return t.map(parse_calculation_equation)}function parse_calculation_equation(t){return t.valid?{...t,needs_computing:!1}:t}const run_parse_calculation_equations_tests=describe.skip("parse_calculation_equations",()=>{let t=[],ee=[],te=[];t=[{valid:!0,value:123,value_str:"123",name:""}],te=[{valid:!0,value:123,value_str:"123",name:"",needs_computing:!1}],ee=parse_calculation_equations(t),test(ee,te,"Should determine it does not need computing"),t=[{valid:!0,value:Number.NaN,value_str:"A * B",name:""}],te=[{valid:!0,value:Number.NaN,value_str:"A * B",name:"",needs_computing:!0}],ee=parse_calculation_equations(t),test(ee,te,"Should mark value as needs computing")},!1),calculation_block_regex=/\$\$\!(.*?)\$\$\!/gs;function get_calculation_strs_from_text(t){return[...t.matchAll(calculation_block_regex)].map(te=>te[1])}const test_get_calculation_strs_from_text=describe("get_calculation_strs_from_text",()=>{const t="@@"+uuid_v4_for_tests(1);let ee=get_calculation_strs_from_text("");test(ee,[],"Should find no calculations when empty string"),ee=get_calculation_strs_from_text(`
asd1 ${t}
$!
asd2
`),test(ee,[],"Should not find any calculations when incomplete $$! is present"),ee=get_calculation_strs_from_text(`
asd1 ${t}
$$!
asd2
`),test(ee,[],"Should not find any calculations when unmatched $$! is present"),ee=get_calculation_strs_from_text(`
asd1 ${t}

$$! asd2 $$!

$$!
    asd3
$$!
`),test(ee,[" asd2 ",`
    asd3
`],"Should find calculations on single and multiple lines"),ee=get_calculation_strs_from_text(`
asd1 ${t}
 $$! asd2 ${t} $$!

 $$!
 asd3
 $$!
`),test(ee,[` asd2 ${t} `,`
 asd3
 `],"Should find calculations when indented $$! is present")},!1);function get_referenced_values(t,ee){if(!t.valid)return t;let te,ne="";if(typeof t.name=="string"&&(ne=`${t.name} = `),typeof t.value=="number")te=t.value,ne+=te.toString();else{const oe={wcomponents_by_id:ee.wcomponents_by_id,depth_limit:1,render_links:!0,root_url:"",get_title:ie=>get_wcomponent_state_UI_value({wcomponent:ie,VAP_set_id_to_counterfactual_v2_map:void 0,created_at_ms:ee.created_at_ms,sim_ms:ee.sim_ms}).values_string+" "+ee.get_title(ie)};te=Number.NaN,ne+=replace_normal_ids(t.value,0,oe)}return{valid:!0,name:t.name||"",value:te,value_str:ne}}function replace_calculations_with_results(t,ee){return get_calculation_strs_from_text(t).map(get_plain_calculation_object_from_str).map(se=>get_referenced_values(se,ee)).map(format_calculations_for_presentation).forEach((se,re)=>{const _e=new RegExp("\\$\\$\\!.*?\\$\\$\\!","s");t=t.replace(_e,se)}),t=apply_markdown_tweaks(t),t}function format_calculations_for_presentation(t){return t.valid?t.value_str:"<code>"+(t.errors.join(", ")||"error")+"</code>"}function apply_markdown_tweaks(t){return t=t.replaceAll(/<\/code>(\s*)<code>/gm,(...ee)=>{const te=ee[1].split("").filter(oe=>oe===`
`).length,ne=Math.max(te,0);return te?"</code>"+"<br />".repeat(ne)+"<code>":ee[0]}),t=t.replaceAll(/<\/code>( *)<code>/gm,(...ee)=>{const te=ee[1].length,ne=Math.ceil(Math.max(te,0)/2);return"</code>"+"&nbsp; ".repeat(ne)+"<code>"}),t}function run_replace_calculations_with_results_tests(){console.group("running tests of replace_calculations_with_results");const t=new Date("2023-08-17 17:40").getTime(),ee=new Date("2023-08-17 17:40").getTime(),te={use_creation_context:!1,creation_context:{label_ids:[]}},ne=uuid_v4_for_tests(1),oe=prepare_new_VAP_set(VAPsType.number,{},[],-1,te);oe.created_at=new Date(t-1),oe.datetime.value=new Date(ee-1),oe.entries[0].value="27000000";const se={wcomponents_by_id:{[ne]:prepare_new_wcomponent_object({base_id:-1,id:ne,title:"UK Homes",type:"statev2",values_and_prediction_sets:[oe]},te)},depth_limit:2,render_links:!0,root_url:"",get_title:ce=>ce.title,created_at_ms:t,sim_ms:ee};let re="",_e="",ae="";re="",_e=replace_calculations_with_results(re,se),test(_e,"","Should find no calculations in an empty string"),re=`
$$!
$$!
`,ae=`
<code>Empty calculation</code>
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should error on finding no value in a calculations"),re=`
$$!
`,ae=`
$$!
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should find no calculations with unmatched calculation $$!"),re=`
$$!
calculation_of_something: A * B
$$!
`,ae=`
<code>Calculation missing value attribute</code>
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should error when calculation block is missing value"),re=`
$$!
calculation_of_something: A * B
$$!

$$!
calculation_of_something: A * B
$$!
`,ae=`
<code>Calculation missing value attribute</code><br /><br /><code>Calculation missing value attribute</code>
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should insert breaks between calculations that error (and are therefore represented by code blocks)"),re=`
$$!
calculation_of_something: A * B
$$! $$!
calculation_of_something: A * B
$$!
`,ae=`
<code>Calculation missing value attribute</code>&nbsp; <code>Calculation missing value attribute</code>
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should insert two spaces (including one &nbsp;) between calculations that have a space between them and that also error (and are therefore represented by code blocks)"),re=`
$$!
value: 123
$$!
`,ae=`
123
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should replace $$! and content between with calculation text"),re=`
$$!
value: "@@${ne}"
$$!
`,ae=`
[27000000 UK Homes](#wcomponents/${ne})
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should replace an id of a component whose state is a numeric value with its value, and component title "),re=`
$$!
name: A
value: "@@${ne}"
$$!
`,ae=`
A = [27000000 UK Homes](#wcomponents/${ne})
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should prepend the name and an equals sign"),re=`
$$!
name: C
value: A
$$!
`,ae=`
C = A
`,_e=replace_calculations_with_results(re,se),test(_e,ae,"Should reproduce equations when names not found"),re=`
$$!
name: A
value: 123
$$!

$$!
value: 0.01
$$!

$$!
value: A * B
$$!
`,ae=`
A = 123

0.01

A * B = <Some warning symbol with a message something like: "Missing value 'B'" >
`,_e=replace_calculations_with_results(re,se),test.skip(_e,ae,"Should partially populate equations when not all names are found"),re=`
$$!
name: A
value: 123
$$!

$$!
name: B
value: 0.01
$$!

$$!
value: A * B
$$!
`,ae=`
A = 123

B = 0.01

A * B = 123 * 0.01 = 1.23
`,_e=replace_calculations_with_results(re,se),test.skip(_e,ae,"Should populate equations when all names are found and calculate result"),console.groupEnd()}const run_get_rich_text_tests=describe("run_get_rich_text_tests",()=>{let t;describe("replace_ids_in_text",()=>{const ee=uuid_v4_for_tests(1),te=uuid_v4_for_tests(2),ne=uuid_v4_for_tests(3),ie=new Date("2021-05-12").getTime(),se={use_creation_context:!1,creation_context:{label_ids:[]}},re={[ee]:prepare_new_wcomponent_object({base_id:-1,id:ee,title:`@@${ne} was told @@${te} is here`},se),[te]:prepare_new_wcomponent_object({base_id:-1,id:te,title:"Person A"},se),[ne]:prepare_new_wcomponent_object({base_id:-1,id:ne,title:"Person B"},se)},_e={},ae={text_type:RichTextType.rich,wcomponents_by_id:re,knowledge_views_by_id:_e,wc_id_to_counterfactuals_map:void 0,created_at_ms:ie,sim_ms:ie};t=replace_ids_in_text({...ae,text_type:RichTextType.raw,text:`Yesterday @@${ee} today`}),test(t,`Yesterday @@${ee} today`,"Should not replace ids when text_type is RichTextType.raw"),t=replace_ids_in_text({...ae,text_type:RichTextType.plain,text:`Yesterday @@${ee} today`}),test(t,"Yesterday Person B was told Person A is here today","Should replace ids with only text and no links when text_type is RichTextType.plain"),t=replace_ids_in_text({...ae,text_type:RichTextType.rich,text:`Yesterday @@${ee} today`}),test(t,`Yesterday [Person B was told Person A is here](#wcomponents/${ee}) today`,"Should replace ids with text and links when text_type is RichTextType.rich.  And should not render lower depth links so as not to have nested broken links.")}),describe("get_title",()=>{const ee=new Date("2021-05-12"),te=ee.getTime(),ne={use_creation_context:!1,creation_context:{label_ids:[]}},oe=xe=>{const Ce={id:"vps"+xe.id,created_at:ee,base_id:-1,datetime:{},entries:[{id:"VAP"+xe.id,explanation:"",probability:1,conviction:1,value:"",description:""}]};return prepare_new_wcomponent_object({...xe,base_id:-1,type:"statev2",subtype:"boolean",values_and_prediction_sets:[Ce]},ne)},ie=uuid_v4_for_tests(1),se=uuid_v4_for_tests(2),re=uuid_v4_for_tests(3),_e=uuid_v4_for_tests(4),ae=uuid_v4_for_tests(5),ce=uuid_v4_for_tests(6),le=uuid_v4_for_tests(7),ue=uuid_v4_for_tests(8),de=uuid_v4_for_tests(9),me=oe({id:ie,title:"aaa"}),pe=oe({id:se,title:`bbb @@${ie}`}),fe=oe({id:re,title:"ccc ${value}"}),ge=oe({id:_e,title:`ddd @@${re}`}),he=oe({id:ae,title:`eee \${value} @@${_e}`}),be=oe({id:ce,title:`fff @@${ae}`}),ve=oe({id:le,title:`ggg @@${ce}`}),ye=oe({id:ue,title:`Recursive @@${ue}`}),we=oe({id:de,title:`Recursive @@${de}.title`}),ke={[me.id]:me,[pe.id]:pe,[fe.id]:fe,[ge.id]:ge,[he.id]:he,[be.id]:be,[ve.id]:ve,[ye.id]:ye,[we.id]:we},Ae={};function $e(xe){const{id:Ce,text_type:Se,wc_id_to_counterfactuals_map:Ie}=xe;return get_title$1({text_type:Se,wcomponents_by_id:ke,knowledge_views_by_id:Ae,wcomponent:ke[Ce],wc_id_to_counterfactuals_map:Ie,created_at_ms:te,sim_ms:te})}describe("get_title",()=>{const xe={[me.id]:"aaa",[pe.id]:`bbb @@${ie}`,[fe.id]:"ccc ${value}",[ge.id]:`ddd @@${re}`,[he.id]:`eee \${value} @@${_e}`},Ce={[me.id]:"aaa",[pe.id]:"bbb aaa",[fe.id]:"ccc True",[ge.id]:"ddd ccc True",[he.id]:"eee True ddd ccc True"},Se={[me.id]:"aaa",[pe.id]:`bbb [aaa](#wcomponents/${ie})`,[fe.id]:"ccc True",[ge.id]:`ddd [ccc True](#wcomponents/${re})`,[he.id]:`eee True [ddd ccc True](#wcomponents/${_e})`};Object.entries(xe).forEach(([Ie,Pe])=>{t=$e({id:Ie,text_type:RichTextType.raw}),test(t,Pe)}),Object.entries(Ce).forEach(([Ie,Pe])=>{t=$e({id:Ie,text_type:RichTextType.plain}),test(t,Pe)}),Object.entries(Se).forEach(([Ie,Pe])=>{t=$e({id:Ie,text_type:RichTextType.rich}),test(t,Pe)})}),describe("depth_limit",()=>{t=$e({id:ve.id,text_type:RichTextType.rich}),test(t,`ggg [fff eee True ddd @@${re}](#wcomponents/${ce})`,"Should stop recursively rendering ids when a depth limit is reached"),t=$e({id:ye.id,text_type:RichTextType.rich}),test(t,"Recursive [Recursive Recursive Recursive @@80000000-0000-4000-a000-000000000000](#wcomponents/80000000-0000-4000-a000-000000000000)","Should handle recursion for normal recursive titles."),t=$e({id:we.id,text_type:RichTextType.rich}),test(!0,!0,"Should handle recursion for '.title' functional ids of recursive titles.")}),describe("counterfactuals",()=>{const xe={[fe.id]:"ccc False",[ge.id]:`ddd [ccc False](#wcomponents/${re})`,[he.id]:`eee True [ddd ccc False](#wcomponents/${_e})`},Ce={[fe.id]:{VAP_sets:{[`vps${re}`]:[{id:"wc999000",type:"counterfactualv2",created_at:ee,base_id:-1,title:"",description:"",target_wcomponent_id:fe.id,target_VAP_set_id:`vps${re}`,target_VAP_id:VAP_visual_false_id}]}}};Object.entries(xe).forEach(([Se,Ie])=>{t=$e({id:Se,text_type:RichTextType.rich,wc_id_to_counterfactuals_map:Ce}),test(t,Ie,"Should override values correctly using counterfactualv2 value")})})}),describe.skip("replace_ids_in_text -> replace_calculations_with_results",()=>{const ee=uuid_v4_for_tests(1),ne=new Date("2023-08-14").getTime(),oe={use_creation_context:!1,creation_context:{label_ids:[]}},ie={[ee]:prepare_new_wcomponent_object({base_id:-1,id:ee,title:"UK Homes"},oe)},se={},re={text_type:RichTextType.rich,wcomponents_by_id:ie,knowledge_views_by_id:se,wc_id_to_counterfactuals_map:void 0,created_at_ms:ne,sim_ms:ne};let ae=replace_ids_in_text({...re,text:`
    $$!
    value: 123
    $$!
    `});test(ae,`
123
`,"Should replace calculation with string value")})},!1),run_replace_normal_ids_tests=describe("replace_normal_ids",()=>{let t="",ee="",te="";const ne=uuid_v4_for_tests(1),oe=uuid_v4_for_tests(9),ie={use_creation_context:!1,creation_context:{label_ids:[]}},se={[ne]:prepare_new_wcomponent_object({base_id:-1,id:ne,title:"Title 1"},ie)};let re;describe("render_links: true",()=>{re={wcomponents_by_id:se,depth_limit:2,render_links:!0,root_url:"http://datacurator.org",get_title:_e=>_e.title},t="",te="",ee=replace_normal_ids(t,1,re),test(ee,te,"Should handle replacing ids in empty string"),t=`Some text
    with an @@id in
    it: @@${ne}.
    `,te=`Some text
    with an @@id in
    it: [Title 1](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).
    `,ee=replace_normal_ids(t,1,re),test(ee,te,"Should replace id with component title"),t=`An @@id to a component that's not found: @@${oe}.`,te="An @@id to a component that's not found: ✗[@@90000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/90000000-0000-4000-a000-000000000000) (not found).",ee=replace_normal_ids(t,1,re),test(ee,te,"Should handle missing components"),t=`Out of depth @@${ne}.`,te="Out of depth [@@10000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).",ee=replace_normal_ids(t,2,re),test(ee,te,"Should not replace with component title when depth is exceeded")}),describe("render_links: false",()=>{re={wcomponents_by_id:se,depth_limit:2,render_links:!1,root_url:"http://datacurator.org",get_title:_e=>_e.title},t=`Some @@id: @@${ne}.`,te="Some @@id: Title 1.",ee=replace_normal_ids(t,1,re),test(ee,te,"Should replace id with component title but no link when render_links is false"),t=`An @@id to a component that's not found: @@${oe}.`,te="An @@id to a component that's not found: ✗@@90000000-0000-4000-a000-000000000000 (not found).",ee=replace_normal_ids(t,1,re),test(ee,te,"Should handle missing components but not add link when render_links is false"),t=`Out of depth @@${ne}.`,te="Out of depth @@10000000-0000-4000-a000-000000000000.",ee=replace_normal_ids(t,2,re),test(ee,te,"Should not replace with component title when depth is exceeded and not add link when render_links is false")})},!1),test_get_ids_from_text=describe("get_ids_from_text",()=>{let t=[];t=get_double_at_mentioned_uuids_from_text(""),test(t,[],"Should find no IDs in empty string"),t=get_double_at_mentioned_uuids_from_text("asd @@wc123 asd name@example.com #label dfg @@345 sf"),test(t,[],'Should not find old ids of "wc123", "345"');const ee=uuid_v4_for_tests(1),te=uuid_v4_for_tests(2);t=get_double_at_mentioned_uuids_from_text(`asd @@${ee} asd name@example.com #label dfg @@${te} sf`),test(t,[ee,te],"Should find uuid ids")},!1),run_perform_calculations_test=describe("perform_calculations",()=>{let t,ee,te,ne;t=[],ee={},ne=[],te=perform_calculations(t,ee),test(te,ne,"No calculations should return no results"),t=[{id:0,name:"A",value:"3"},{id:1,name:"B",value:"4"},{id:2,name:"C",value:"[A] + B"}],te=perform_calculations(t,ee),ne=[{value:3,units:""},{value:4,units:""},{value:7,units:""}],test(te,ne,"3 simple calculations should return 3 results"),t=[{id:0,name:"A",value:"3 + 1"},{id:1,name:"C",value:"A + some_undeclared_variable"},{id:2,name:"D",value:"5 + 1"}],te=perform_calculations(t,ee),ne=[{value:3+1,units:""},{value:void 0,error:"The primitive [some_undeclared_variable] could not be found.",units:""},{value:5+1,units:""}],test(te,ne,"Failure to find a value should still perform other valid calculations"),t=[{id:0,name:"A",value:"1 + 1"},{id:1,name:"A",value:"A * 2"},{id:2,name:"A",value:"A * 2"}],te=perform_calculations(t,ee),ne=[{value:1+1,units:""},{value:4,units:""},{value:8,units:""}],test(te,ne,"Can cope with self reference"),t=[{id:0,name:" A ",value:"1 + 1"},{id:1,name:"B",value:"[ A ] * 2"}],te=perform_calculations(t,ee),ne=[{value:1+1,units:""},{value:4,units:""}],test(te,ne,"Can cope with references with spaces");const oe=uuid_v4_for_tests(1),ie=0;let se;describe("Can use wcomponent values",()=>{se=prepare_new_VAP_set(VAPsType.number,void 0,[],ie,{}),se.entries[0].value="12.3";const re=prepare_new_contextless_wcomponent_object({base_id:ie,id:oe,title:"Some state component",type:"statev2",values_and_prediction_sets:[se],units:"seconds"});ee={[oe]:re},t=[{id:0,name:"A",value:`@@${oe}`,units:"meters"}],te=perform_calculations(t,ee),ne=[{value:12.3,units:"seconds"}],test(te,ne,"Can access a wcomponent's value and overrides any units given in calculation with wcomponent's units"),t=[{id:0,name:"A",value:`@@${oe} * 10`,units:"meters"}],te=perform_calculations(t,ee),ne=[{value:123,units:"meters"}],test(te,ne,"Can reference wcomponent values in a calculation and uses units given, overriding components units"),t=[{id:0,name:"A",value:`{@@${oe} meters}`}],te=perform_calculations(t,ee),ne=[{value:12.3,units:"meters"}],test.skip(te,ne,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Calculations can reference wcomponent values and assign units~~"),t=[{id:0,name:"A",value:`@@${oe}.value`,units:"meters"}],te=perform_calculations(t,ee),ne=[{value:void 0,units:"meters",error:"Object function not used on object"}],test(te,ne,'Can not currently access the ".value" of a component in an equation')}),describe("Can use wcomponent boolean values",()=>{se=prepare_new_VAP_set(VAPsType.boolean,void 0,[],ie,{}),test(se.entries[1].value_id,VALUE_POSSIBILITY_IDS.boolean_false,"Test is setting the correct VAP set entry"),se.entries[1].probability=1,ee={[oe]:prepare_new_contextless_wcomponent_object({base_id:ie,id:oe,type:"statev2",values_and_prediction_sets:[se]})},t=[{id:0,name:"A",value:`IfThenElse(@@${oe}, 15, 10)`}],te=perform_calculations(t,ee),ne=[{value:10,units:""}],test(te,ne,"Can use wcomponent boolean values")}),describe("Can use values with units",()=>{t=[{id:0,name:"A",value:"{2 Meters} + {10 Centimeters}",units:"Meters"}],te=perform_calculations(t,ee),ne=[{value:2.1,units:"Meters"}],test(te,ne,"Computes correct value and includes units in result")}),describe("Can use values without units being initially defined",()=>{t=[{id:0,name:"A",value:"{2 Meters}"}],te=perform_calculations(t,ee),ne=[{value:2,units:"Meters"}],test(te,ne,"Computes correct units")}),describe("Can use values with units initially being undefined",()=>{t=[{id:0,name:"A",value:"{2 Meters}",units:void 0}],te=perform_calculations(t,ee),ne=[{value:2,units:"Meters"}],test(te,ne,"Computes correct units")}),describe("Does not compute units if some are already specified",()=>{t=[{id:0,name:"A",value:"{2 Meters}",units:"kg"}],te=perform_calculations(t,ee),ne=[{value:void 0,units:"kg",error:"Wrong units generated for [A]. Expected Kg, and got Meters."}],test(te,ne,"Computes correct units")}),describe(`Sets units to "" if 'Unitless' is specified`,()=>{t=[{id:0,name:"A",value:"2",units:"Unitless"}],te=perform_calculations(t,ee),ne=[{value:2,units:""}],test(te,ne,'Computes correct units of "" when "Unitless" is specified'),t=[{id:0,name:"A",value:"{2 Meters}",units:"Unitless"}],te=perform_calculations(t,ee),ne=[{value:void 0,units:"",error:"Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."}],test(te,ne,'Computes correct units of "" when "Unitless" is specified as the units even though it conflicts with units given in calculation')}),describe("Can process numbers with thousands comma seperators",()=>{t=[{id:0,name:"A",value:"1,200,300e4 / {4,001,000e3 km}",units:"1/km"}],te=perform_calculations(t,ee),ne=[{value:3,units:"1/km"}],test(te,ne,"Can compute numbers with thousands commas")}),describe("Can process numbers with compound units",()=>{t=[{id:0,name:"A",value:"{7 Widgets/Years^2}*{10 Years}",units:"Widgets/Years"}],te=perform_calculations(t,ee),ne=[{value:70,units:"Widgets/Years"}],test(te,ne,"Widgets/Years^2  *  Years")}),describe("hide_currency_symbols",()=>{t=[{id:0,name:"A",value:"{90 £ / year}",units:""},{id:1,name:"B",value:"{10 £ / year}",units:""},{id:2,name:"C",value:"A+B",units:""}],te=perform_calculations(t,ee),ne=[{value:90,units:"£/(Year)"},{value:10,units:"£/(Year)"},{value:100,units:"£/(Year)"}],test(te,ne,"Handles currency symbols specified inside curly braces"),t=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"£ / year"},{id:2,name:"C",value:"A+B",units:"£ / year"}],te=perform_calculations(t,ee),ne=[{value:90,units:"£ / year"},{value:10,units:"£ / year"},{value:100,units:"£ / year"}],test(te,ne,"Handles currency symbols specified inside units field, and preserves them precisely"),t=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"$ / year"},{id:2,name:"C",value:"A+B",units:"£ / year"}],te=perform_calculations(t,ee),ne=[{value:90,units:"£ / year"},{value:10,units:"$ / year"},{value:void 0,units:"£ / year",error:"Incompatible units for the addition of £/(Year) and $/(Year)."}],test(te,ne,"Correctly formats currency symbols in error messages")}),describe("Handles reserved words correctly",()=>{t=[{id:0,name:"A",value:"0.5 * (180 / Pi)"}],te=perform_calculations(t,ee),ne=[{value:28.6478897565412,units:""}],test(te,ne,'Can run calculations using reserved word "Pi"')})},!1),run_normalise_calculation_ids_tests=describe("normalise_calculation_ids",()=>{const t=uuid_v4_for_tests(1);let ee="",te="",ne="";ee="[A] + 3",te="[A] + 3",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Original square bracket IDs ignored"),ee="[A] + B",te="[A] + [B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Non square bracket id put into square brackets"),ee="A + [B]",te="[A] + [B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Beginning with non square bracket id put into square brackets"),ee="A-B",te="[A]-[B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Non square bracket ids with no spaces and a negation sign between are put into square brackets"),ee=`[A] + @@${t}`,te=`[A] + [${t}]`,ne=normalise_calculation_ids(ee,[t]),test(ne,te,"@@ uuid id put into square brackets"),ee="B + B",te="[B] + [B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Repeated non square bracket id dealt with correctly"),ee="sin(1) + B",te="sin(1) + [B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Simulation.js functions not processed into square brackets"),ee="A>B",te="[A]>[B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Simulation.js equality signs not processed into square brackets"),ee="[Some agent].FindAll([Some state]) + B",te="[Some agent].FindAll([Some state]) + [B]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Simulation.js agent functions not processed into square brackets"),ee="[ Some variable ] + [ another variable ]",te="[ Some variable ] + [ another variable ]",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Existing square bracket id with spaces is not altered"),ee="{4 miles} / {6.4e3 meters}",te="{4 miles} / {6.4e3 meters}",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Units inside curly braces are left unaltered"),ee="{7 Widgets/Years^2}",te="{7 Widgets/Years^2}",ne=normalise_calculation_ids(ee,[]),test(ne,te,"Compound units and those raised to power inside curly braces are left unaltered"),ee=`{@@${t} meters}`,te=`{[${t}] meters}`,ne=normalise_calculation_ids(ee,[t]),test.skip(ne,te,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Double @ reference uuids and their units are preserved in curly braces~~")},!1),run_normalise_calculation_numbers_tests=describe("normalise_calculation_numbers",()=>{const t=uuid_v4_for_tests(1);let ee="",te="",ne="";ee=`B + [A] @@${t} + 3.1 + {4.2 km}`,te=`B + [A] @@${t} + 3.1 + {4.2 km}`,ne=normalise_calculation_numbers(ee),test(ne,te,"Non and square bracket IDs, @@uuids, decimal numbers, and curly bracket numbers with units are left unchanged"),ee="3,200 + 1,800.0",te="3200 + 1800.0",ne=normalise_calculation_numbers(ee),test(ne,te,"Thousands commas are removed from numbers"),ee="3,20 + 1,80.0",te="3,20 + 1,80.0",ne=normalise_calculation_numbers(ee),test(ne,te,"Non-thousands commas are ignored"),ee="1,200,300 10,300,400 100,200,300",te="1200300 10300400 100200300",ne=normalise_calculation_numbers(ee),test(ne,te,"Thousands commas are removed from millions")},!1),run_number_to_string_test=describe("run_number_to_string_test",()=>{let t="";t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.bare),test(t,"1300","bare number"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.simple),test(t,"1,300","simple number"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"1.3 thousand","scaled number"),t=format_number_to_string(.1264,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"13%","number as percentage"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"1.3 k","abbreviated scaled number"),t=format_number_to_string(1264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1.3e3","scientific number"),t=format_number_to_string(.1264,-.2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1e-1","Copes with significant_figures that are fractional and or < 1"),t=format_number_to_string(27e6,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"27 million","27 million"),t=format_number_to_string(27e7,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"270 million","270 million"),t=format_number_to_string(27e8,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"2.7 billion","2.7 billion"),describe("negative numbers",()=>{t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.bare),test(t,"-1300","bare number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.simple),test(t,"-1,300","simple number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"-1.3 thousand","scaled number"),t=format_number_to_string(-.1264,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"-13%","percentage number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"-1.3 k","abbreviated scaled number"),t=format_number_to_string(-1264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"-1.3e3","scientific number")}),describe("less than 1 numbers",()=>{t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.bare),test(t,"0.0013","bare number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.simple),test(t,"0.0013","simple number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"0.0013","scaled number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"0.13%","percentage number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"0.0013","abbreviated scaled number"),t=format_number_to_string(.001264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1.3e-3","scientific number"),t=format_number_to_string(-.001264,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"-1.3e-3","0> num >-1 scientific number")}),describe("no unnecessary significant figures",()=>{t=format_number_to_string(1,2,NUMBER_DISPLAY_TYPES.bare),test(t,"1","bare number"),t=format_number_to_string(1,2,NUMBER_DISPLAY_TYPES.simple),test(t,"1","simple number"),t=format_number_to_string(1e3,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"1 thousand","scaled number"),t=format_number_to_string(10,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"1000%","percentage number"),t=format_number_to_string(1e3,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"1 k","abbreviated scaled number"),t=format_number_to_string(1e3,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"1e3","scientific number")}),describe("handles 0",()=>{t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.bare),test(t,"0","bare number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.simple),test(t,"0","simple number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.scaled),test(t,"0","scaled number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.percentage),test(t,"0%","percentage number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.abbreviated_scaled),test(t,"0","abbreviated scaled number"),t=format_number_to_string(0,2,NUMBER_DISPLAY_TYPES.scientific),test(t,"0e0","scientific number")})},!1),run_convert_percentages_tests=describe("convert_percentages",()=>{let t="",ee="",te="";t="90 %",ee="(90 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbol to numbers"),t="90 % / 10%",ee="(90 * 0.01) / (10 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbols without spaces to numbers"),t="90.123 %",ee="(90.123 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbols with decimal places"),t=".123 %",ee="(.123 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert percentage symbols with decimal point and no leading digit"),t="90.123 % - -90.123 %",ee="(90.123 * 0.01) - -(90.123 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert negative or positive percentage symbols"),t="9.1e+1 % - 9.1e-1 %",ee="(9.1e+1 * 0.01) - (9.1e-1 * 0.01)",te=convert_percentages(t),test(te,ee,"Convert scientific notation percentage symbols")},!1),run_number_to_significant_figures_test=describe("run_number_to_significant_figures_test",()=>{let t="";t=format_number_to_significant_figures(0,2),test(t,"0","Zero"),describe("Positive numbers",()=>{t=format_number_to_significant_figures(27e5,2),test(t,"2700000","2.7 million to 2 sf"),t=format_number_to_significant_figures(27e6,2),test(t,"27000000","27 million to 2 sf"),t=format_number_to_significant_figures(27e7,2),test(t,"270000000","270 million to 2 sf"),t=format_number_to_significant_figures(2700000002e-1,2),test(t,"270000000","270.2 million to 2 sf")}),describe("Positive with decimals numbers",()=>{t=format_number_to_significant_figures(27,5),test(t,"27.000","27 to 5 sf"),t=format_number_to_significant_figures(2700000002e-1,10),test(t,"270000000.2","270.2 million to 10 sf"),t=format_number_to_significant_figures(2700000002e-1,11),test(t,"270000000.20","270.2 million to 11 sf")}),describe("Negative numbers",()=>{t=format_number_to_significant_figures(-27,5),test(t,"-27.000","-27 to 5 sf"),t=format_number_to_significant_figures(-2700000002e-1,11),test(t,"-270000000.20","-270.2 million to 11 sf"),t=format_number_to_significant_figures(-2700000002e-1,2),test(t,"-270000000","-270.2 million to 2 sf")}),describe("Small numbers",()=>{t=format_number_to_significant_figures(1236e-7,3),test(t,"0.000124","0.0001236 to 3 sf"),t=format_number_to_significant_figures(1236e-7,5),test(t,"0.00012360","0.0001236 to 5 sf"),t=format_number_to_significant_figures(-1236e-7,3),test(t,"-0.000124","-0.0001236 to 3 sf"),t=format_number_to_significant_figures(-1236e-7,5),test(t,"-0.00012360","-0.0001236 to 5 sf")}),describe("Floating point precision numbers",()=>{t=format_number_to_significant_figures(.01264,2),test(t,"0.013","0.01264 to 2 sf, tests when floating point precision results in 0.013000000000000001"),t=format_number_to_significant_figures(17.955*100,7),test(t,"1795.500","17.955*100 to 7 sf, tests when floating point precision results in 1795.4999999999998")})},!1);function get_angle_from_start_connector(t,ee){const te=angle_of_normal_to_connection_with_direction[ee];return t+=1e-4,get_angle_from_connector({connection_angle:t,angle_of_normal_to_connector_surface:te,offset_direction:-1})}function get_angle_from_end_connector(t,ee){const te=angle_of_normal_to_connection_with_direction[ee];return t+=Math.PI,get_angle_from_connector({connection_angle:t,angle_of_normal_to_connector_surface:te,offset_direction:1})}const angle_of_normal_to_connection_location={left:rads._180,top:rads._90,right:0,bottom:-rads._90},angle_of_normal_to_connection_with_direction={from:angle_of_normal_to_connection_location.right,to:angle_of_normal_to_connection_location.left},max_connection_angle_from_normal=rads._50;function get_angle_from_connector(t){const ee=normalise_angle_between_neg_Pi_and_Pi(t.connection_angle-t.angle_of_normal_to_connector_surface),ne=bounded(ee,-max_connection_angle_from_normal,max_connection_angle_from_normal);return bounded(ne,-max_connection_angle_from_normal,max_connection_angle_from_normal)+t.angle_of_normal_to_connector_surface}const test_get_angle=describe.skip("get_angle (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{const te=[{ex:10,ey:0},{ex:10,ey:-10},{ex:0,ey:-10},{ex:-10,ey:-10},{ex:-10,ey:0},{ex:-10,ey:10},{ex:0,ey:10},{ex:10,ey:10}],ne=["0.00","-0.79","-1.57","-2.36","3.14","2.36","1.57","0.79"];te.forEach(({ex:se,ey:re},_e)=>{const ae=get_angle(0,0,se,re).toFixed(2);test(ae,ne[_e])});const oe=["-0.79","-0.87","-0.87","-0.87","0.09","0.09","0.09","0.00"];te.forEach(({ex:se,ey:re},_e)=>{const ae=get_angle(0,0,se,re),ce=get_angle_from_start_connector(ae,"from").toFixed(2);test(ce,oe[_e])});const ie=["3.93","3.14","3.05","3.05","4.01","4.01","4.01","4.01"];te.forEach(({ex:se,ey:re},_e)=>{const ae=get_angle(0,0,se,re),ce=get_angle_from_end_connector(ae,"to").toFixed(2);test(ce,ie[_e])})},!1);var _listCacheClear,hasRequired_listCacheClear;function require_listCacheClear(){if(hasRequired_listCacheClear)return _listCacheClear;hasRequired_listCacheClear=1;function t(){this.__data__=[],this.size=0}return _listCacheClear=t,_listCacheClear}var eq_1,hasRequiredEq;function requireEq(){if(hasRequiredEq)return eq_1;hasRequiredEq=1;function t(ee,te){return ee===te||ee!==ee&&te!==te}return eq_1=t,eq_1}var _assocIndexOf,hasRequired_assocIndexOf;function require_assocIndexOf(){if(hasRequired_assocIndexOf)return _assocIndexOf;hasRequired_assocIndexOf=1;var t=requireEq();function ee(te,ne){for(var oe=te.length;oe--;)if(t(te[oe][0],ne))return oe;return-1}return _assocIndexOf=ee,_assocIndexOf}var _listCacheDelete,hasRequired_listCacheDelete;function require_listCacheDelete(){if(hasRequired_listCacheDelete)return _listCacheDelete;hasRequired_listCacheDelete=1;var t=require_assocIndexOf(),ee=Array.prototype,te=ee.splice;function ne(oe){var ie=this.__data__,se=t(ie,oe);if(se<0)return!1;var re=ie.length-1;return se==re?ie.pop():te.call(ie,se,1),--this.size,!0}return _listCacheDelete=ne,_listCacheDelete}var _listCacheGet,hasRequired_listCacheGet;function require_listCacheGet(){if(hasRequired_listCacheGet)return _listCacheGet;hasRequired_listCacheGet=1;var t=require_assocIndexOf();function ee(te){var ne=this.__data__,oe=t(ne,te);return oe<0?void 0:ne[oe][1]}return _listCacheGet=ee,_listCacheGet}var _listCacheHas,hasRequired_listCacheHas;function require_listCacheHas(){if(hasRequired_listCacheHas)return _listCacheHas;hasRequired_listCacheHas=1;var t=require_assocIndexOf();function ee(te){return t(this.__data__,te)>-1}return _listCacheHas=ee,_listCacheHas}var _listCacheSet,hasRequired_listCacheSet;function require_listCacheSet(){if(hasRequired_listCacheSet)return _listCacheSet;hasRequired_listCacheSet=1;var t=require_assocIndexOf();function ee(te,ne){var oe=this.__data__,ie=t(oe,te);return ie<0?(++this.size,oe.push([te,ne])):oe[ie][1]=ne,this}return _listCacheSet=ee,_listCacheSet}var _ListCache,hasRequired_ListCache;function require_ListCache(){if(hasRequired_ListCache)return _ListCache;hasRequired_ListCache=1;var t=require_listCacheClear(),ee=require_listCacheDelete(),te=require_listCacheGet(),ne=require_listCacheHas(),oe=require_listCacheSet();function ie(se){var re=-1,_e=se==null?0:se.length;for(this.clear();++re<_e;){var ae=se[re];this.set(ae[0],ae[1])}}return ie.prototype.clear=t,ie.prototype.delete=ee,ie.prototype.get=te,ie.prototype.has=ne,ie.prototype.set=oe,_ListCache=ie,_ListCache}var _stackClear,hasRequired_stackClear;function require_stackClear(){if(hasRequired_stackClear)return _stackClear;hasRequired_stackClear=1;var t=require_ListCache();function ee(){this.__data__=new t,this.size=0}return _stackClear=ee,_stackClear}var _stackDelete,hasRequired_stackDelete;function require_stackDelete(){if(hasRequired_stackDelete)return _stackDelete;hasRequired_stackDelete=1;function t(ee){var te=this.__data__,ne=te.delete(ee);return this.size=te.size,ne}return _stackDelete=t,_stackDelete}var _stackGet,hasRequired_stackGet;function require_stackGet(){if(hasRequired_stackGet)return _stackGet;hasRequired_stackGet=1;function t(ee){return this.__data__.get(ee)}return _stackGet=t,_stackGet}var _stackHas,hasRequired_stackHas;function require_stackHas(){if(hasRequired_stackHas)return _stackHas;hasRequired_stackHas=1;function t(ee){return this.__data__.has(ee)}return _stackHas=t,_stackHas}var _freeGlobal,hasRequired_freeGlobal;function require_freeGlobal(){if(hasRequired_freeGlobal)return _freeGlobal;hasRequired_freeGlobal=1;var t=typeof commonjsGlobal=="object"&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal;return _freeGlobal=t,_freeGlobal}var _root,hasRequired_root;function require_root(){if(hasRequired_root)return _root;hasRequired_root=1;var t=require_freeGlobal(),ee=typeof self=="object"&&self&&self.Object===Object&&self,te=t||ee||Function("return this")();return _root=te,_root}var _Symbol,hasRequired_Symbol;function require_Symbol(){if(hasRequired_Symbol)return _Symbol;hasRequired_Symbol=1;var t=require_root(),ee=t.Symbol;return _Symbol=ee,_Symbol}var _getRawTag,hasRequired_getRawTag;function require_getRawTag(){if(hasRequired_getRawTag)return _getRawTag;hasRequired_getRawTag=1;var t=require_Symbol(),ee=Object.prototype,te=ee.hasOwnProperty,ne=ee.toString,oe=t?t.toStringTag:void 0;function ie(se){var re=te.call(se,oe),_e=se[oe];try{se[oe]=void 0;var ae=!0}catch{}var ce=ne.call(se);return ae&&(re?se[oe]=_e:delete se[oe]),ce}return _getRawTag=ie,_getRawTag}var _objectToString,hasRequired_objectToString;function require_objectToString(){if(hasRequired_objectToString)return _objectToString;hasRequired_objectToString=1;var t=Object.prototype,ee=t.toString;function te(ne){return ee.call(ne)}return _objectToString=te,_objectToString}var _baseGetTag,hasRequired_baseGetTag;function require_baseGetTag(){if(hasRequired_baseGetTag)return _baseGetTag;hasRequired_baseGetTag=1;var t=require_Symbol(),ee=require_getRawTag(),te=require_objectToString(),ne="[object Null]",oe="[object Undefined]",ie=t?t.toStringTag:void 0;function se(re){return re==null?re===void 0?oe:ne:ie&&ie in Object(re)?ee(re):te(re)}return _baseGetTag=se,_baseGetTag}var isObject_1,hasRequiredIsObject;function requireIsObject(){if(hasRequiredIsObject)return isObject_1;hasRequiredIsObject=1;function t(ee){var te=typeof ee;return ee!=null&&(te=="object"||te=="function")}return isObject_1=t,isObject_1}var isFunction_1,hasRequiredIsFunction;function requireIsFunction(){if(hasRequiredIsFunction)return isFunction_1;hasRequiredIsFunction=1;var t=require_baseGetTag(),ee=requireIsObject(),te="[object AsyncFunction]",ne="[object Function]",oe="[object GeneratorFunction]",ie="[object Proxy]";function se(re){if(!ee(re))return!1;var _e=t(re);return _e==ne||_e==oe||_e==te||_e==ie}return isFunction_1=se,isFunction_1}var _coreJsData,hasRequired_coreJsData;function require_coreJsData(){if(hasRequired_coreJsData)return _coreJsData;hasRequired_coreJsData=1;var t=require_root(),ee=t["__core-js_shared__"];return _coreJsData=ee,_coreJsData}var _isMasked,hasRequired_isMasked;function require_isMasked(){if(hasRequired_isMasked)return _isMasked;hasRequired_isMasked=1;var t=require_coreJsData(),ee=function(){var ne=/[^.]+$/.exec(t&&t.keys&&t.keys.IE_PROTO||"");return ne?"Symbol(src)_1."+ne:""}();function te(ne){return!!ee&&ee in ne}return _isMasked=te,_isMasked}var _toSource,hasRequired_toSource;function require_toSource(){if(hasRequired_toSource)return _toSource;hasRequired_toSource=1;var t=Function.prototype,ee=t.toString;function te(ne){if(ne!=null){try{return ee.call(ne)}catch{}try{return ne+""}catch{}}return""}return _toSource=te,_toSource}var _baseIsNative,hasRequired_baseIsNative;function require_baseIsNative(){if(hasRequired_baseIsNative)return _baseIsNative;hasRequired_baseIsNative=1;var t=requireIsFunction(),ee=require_isMasked(),te=requireIsObject(),ne=require_toSource(),oe=/[\\^$.*+?()[\]{}|]/g,ie=/^\[object .+?Constructor\]$/,se=Function.prototype,re=Object.prototype,_e=se.toString,ae=re.hasOwnProperty,ce=RegExp("^"+_e.call(ae).replace(oe,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function le(ue){if(!te(ue)||ee(ue))return!1;var de=t(ue)?ce:ie;return de.test(ne(ue))}return _baseIsNative=le,_baseIsNative}var _getValue,hasRequired_getValue;function require_getValue(){if(hasRequired_getValue)return _getValue;hasRequired_getValue=1;function t(ee,te){return ee==null?void 0:ee[te]}return _getValue=t,_getValue}var _getNative,hasRequired_getNative;function require_getNative(){if(hasRequired_getNative)return _getNative;hasRequired_getNative=1;var t=require_baseIsNative(),ee=require_getValue();function te(ne,oe){var ie=ee(ne,oe);return t(ie)?ie:void 0}return _getNative=te,_getNative}var _Map,hasRequired_Map;function require_Map(){if(hasRequired_Map)return _Map;hasRequired_Map=1;var t=require_getNative(),ee=require_root(),te=t(ee,"Map");return _Map=te,_Map}var _nativeCreate,hasRequired_nativeCreate;function require_nativeCreate(){if(hasRequired_nativeCreate)return _nativeCreate;hasRequired_nativeCreate=1;var t=require_getNative(),ee=t(Object,"create");return _nativeCreate=ee,_nativeCreate}var _hashClear,hasRequired_hashClear;function require_hashClear(){if(hasRequired_hashClear)return _hashClear;hasRequired_hashClear=1;var t=require_nativeCreate();function ee(){this.__data__=t?t(null):{},this.size=0}return _hashClear=ee,_hashClear}var _hashDelete,hasRequired_hashDelete;function require_hashDelete(){if(hasRequired_hashDelete)return _hashDelete;hasRequired_hashDelete=1;function t(ee){var te=this.has(ee)&&delete this.__data__[ee];return this.size-=te?1:0,te}return _hashDelete=t,_hashDelete}var _hashGet,hasRequired_hashGet;function require_hashGet(){if(hasRequired_hashGet)return _hashGet;hasRequired_hashGet=1;var t=require_nativeCreate(),ee="__lodash_hash_undefined__",te=Object.prototype,ne=te.hasOwnProperty;function oe(ie){var se=this.__data__;if(t){var re=se[ie];return re===ee?void 0:re}return ne.call(se,ie)?se[ie]:void 0}return _hashGet=oe,_hashGet}var _hashHas,hasRequired_hashHas;function require_hashHas(){if(hasRequired_hashHas)return _hashHas;hasRequired_hashHas=1;var t=require_nativeCreate(),ee=Object.prototype,te=ee.hasOwnProperty;function ne(oe){var ie=this.__data__;return t?ie[oe]!==void 0:te.call(ie,oe)}return _hashHas=ne,_hashHas}var _hashSet,hasRequired_hashSet;function require_hashSet(){if(hasRequired_hashSet)return _hashSet;hasRequired_hashSet=1;var t=require_nativeCreate(),ee="__lodash_hash_undefined__";function te(ne,oe){var ie=this.__data__;return this.size+=this.has(ne)?0:1,ie[ne]=t&&oe===void 0?ee:oe,this}return _hashSet=te,_hashSet}var _Hash,hasRequired_Hash;function require_Hash(){if(hasRequired_Hash)return _Hash;hasRequired_Hash=1;var t=require_hashClear(),ee=require_hashDelete(),te=require_hashGet(),ne=require_hashHas(),oe=require_hashSet();function ie(se){var re=-1,_e=se==null?0:se.length;for(this.clear();++re<_e;){var ae=se[re];this.set(ae[0],ae[1])}}return ie.prototype.clear=t,ie.prototype.delete=ee,ie.prototype.get=te,ie.prototype.has=ne,ie.prototype.set=oe,_Hash=ie,_Hash}var _mapCacheClear,hasRequired_mapCacheClear;function require_mapCacheClear(){if(hasRequired_mapCacheClear)return _mapCacheClear;hasRequired_mapCacheClear=1;var t=require_Hash(),ee=require_ListCache(),te=require_Map();function ne(){this.size=0,this.__data__={hash:new t,map:new(te||ee),string:new t}}return _mapCacheClear=ne,_mapCacheClear}var _isKeyable,hasRequired_isKeyable;function require_isKeyable(){if(hasRequired_isKeyable)return _isKeyable;hasRequired_isKeyable=1;function t(ee){var te=typeof ee;return te=="string"||te=="number"||te=="symbol"||te=="boolean"?ee!=="__proto__":ee===null}return _isKeyable=t,_isKeyable}var _getMapData,hasRequired_getMapData;function require_getMapData(){if(hasRequired_getMapData)return _getMapData;hasRequired_getMapData=1;var t=require_isKeyable();function ee(te,ne){var oe=te.__data__;return t(ne)?oe[typeof ne=="string"?"string":"hash"]:oe.map}return _getMapData=ee,_getMapData}var _mapCacheDelete,hasRequired_mapCacheDelete;function require_mapCacheDelete(){if(hasRequired_mapCacheDelete)return _mapCacheDelete;hasRequired_mapCacheDelete=1;var t=require_getMapData();function ee(te){var ne=t(this,te).delete(te);return this.size-=ne?1:0,ne}return _mapCacheDelete=ee,_mapCacheDelete}var _mapCacheGet,hasRequired_mapCacheGet;function require_mapCacheGet(){if(hasRequired_mapCacheGet)return _mapCacheGet;hasRequired_mapCacheGet=1;var t=require_getMapData();function ee(te){return t(this,te).get(te)}return _mapCacheGet=ee,_mapCacheGet}var _mapCacheHas,hasRequired_mapCacheHas;function require_mapCacheHas(){if(hasRequired_mapCacheHas)return _mapCacheHas;hasRequired_mapCacheHas=1;var t=require_getMapData();function ee(te){return t(this,te).has(te)}return _mapCacheHas=ee,_mapCacheHas}var _mapCacheSet,hasRequired_mapCacheSet;function require_mapCacheSet(){if(hasRequired_mapCacheSet)return _mapCacheSet;hasRequired_mapCacheSet=1;var t=require_getMapData();function ee(te,ne){var oe=t(this,te),ie=oe.size;return oe.set(te,ne),this.size+=oe.size==ie?0:1,this}return _mapCacheSet=ee,_mapCacheSet}var _MapCache,hasRequired_MapCache;function require_MapCache(){if(hasRequired_MapCache)return _MapCache;hasRequired_MapCache=1;var t=require_mapCacheClear(),ee=require_mapCacheDelete(),te=require_mapCacheGet(),ne=require_mapCacheHas(),oe=require_mapCacheSet();function ie(se){var re=-1,_e=se==null?0:se.length;for(this.clear();++re<_e;){var ae=se[re];this.set(ae[0],ae[1])}}return ie.prototype.clear=t,ie.prototype.delete=ee,ie.prototype.get=te,ie.prototype.has=ne,ie.prototype.set=oe,_MapCache=ie,_MapCache}var _stackSet,hasRequired_stackSet;function require_stackSet(){if(hasRequired_stackSet)return _stackSet;hasRequired_stackSet=1;var t=require_ListCache(),ee=require_Map(),te=require_MapCache(),ne=200;function oe(ie,se){var re=this.__data__;if(re instanceof t){var _e=re.__data__;if(!ee||_e.length<ne-1)return _e.push([ie,se]),this.size=++re.size,this;re=this.__data__=new te(_e)}return re.set(ie,se),this.size=re.size,this}return _stackSet=oe,_stackSet}var _Stack,hasRequired_Stack;function require_Stack(){if(hasRequired_Stack)return _Stack;hasRequired_Stack=1;var t=require_ListCache(),ee=require_stackClear(),te=require_stackDelete(),ne=require_stackGet(),oe=require_stackHas(),ie=require_stackSet();function se(re){var _e=this.__data__=new t(re);this.size=_e.size}return se.prototype.clear=ee,se.prototype.delete=te,se.prototype.get=ne,se.prototype.has=oe,se.prototype.set=ie,_Stack=se,_Stack}var _arrayEach,hasRequired_arrayEach;function require_arrayEach(){if(hasRequired_arrayEach)return _arrayEach;hasRequired_arrayEach=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length;++ne<oe&&te(ee[ne],ne,ee)!==!1;);return ee}return _arrayEach=t,_arrayEach}var _defineProperty,hasRequired_defineProperty;function require_defineProperty(){if(hasRequired_defineProperty)return _defineProperty;hasRequired_defineProperty=1;var t=require_getNative(),ee=function(){try{var te=t(Object,"defineProperty");return te({},"",{}),te}catch{}}();return _defineProperty=ee,_defineProperty}var _baseAssignValue,hasRequired_baseAssignValue;function require_baseAssignValue(){if(hasRequired_baseAssignValue)return _baseAssignValue;hasRequired_baseAssignValue=1;var t=require_defineProperty();function ee(te,ne,oe){ne=="__proto__"&&t?t(te,ne,{configurable:!0,enumerable:!0,value:oe,writable:!0}):te[ne]=oe}return _baseAssignValue=ee,_baseAssignValue}var _assignValue,hasRequired_assignValue;function require_assignValue(){if(hasRequired_assignValue)return _assignValue;hasRequired_assignValue=1;var t=require_baseAssignValue(),ee=requireEq(),te=Object.prototype,ne=te.hasOwnProperty;function oe(ie,se,re){var _e=ie[se];(!(ne.call(ie,se)&&ee(_e,re))||re===void 0&&!(se in ie))&&t(ie,se,re)}return _assignValue=oe,_assignValue}var _copyObject,hasRequired_copyObject;function require_copyObject(){if(hasRequired_copyObject)return _copyObject;hasRequired_copyObject=1;var t=require_assignValue(),ee=require_baseAssignValue();function te(ne,oe,ie,se){var re=!ie;ie||(ie={});for(var _e=-1,ae=oe.length;++_e<ae;){var ce=oe[_e],le=se?se(ie[ce],ne[ce],ce,ie,ne):void 0;le===void 0&&(le=ne[ce]),re?ee(ie,ce,le):t(ie,ce,le)}return ie}return _copyObject=te,_copyObject}var _baseTimes,hasRequired_baseTimes;function require_baseTimes(){if(hasRequired_baseTimes)return _baseTimes;hasRequired_baseTimes=1;function t(ee,te){for(var ne=-1,oe=Array(ee);++ne<ee;)oe[ne]=te(ne);return oe}return _baseTimes=t,_baseTimes}var isObjectLike_1,hasRequiredIsObjectLike;function requireIsObjectLike(){if(hasRequiredIsObjectLike)return isObjectLike_1;hasRequiredIsObjectLike=1;function t(ee){return ee!=null&&typeof ee=="object"}return isObjectLike_1=t,isObjectLike_1}var _baseIsArguments,hasRequired_baseIsArguments;function require_baseIsArguments(){if(hasRequired_baseIsArguments)return _baseIsArguments;hasRequired_baseIsArguments=1;var t=require_baseGetTag(),ee=requireIsObjectLike(),te="[object Arguments]";function ne(oe){return ee(oe)&&t(oe)==te}return _baseIsArguments=ne,_baseIsArguments}var isArguments_1,hasRequiredIsArguments;function requireIsArguments(){if(hasRequiredIsArguments)return isArguments_1;hasRequiredIsArguments=1;var t=require_baseIsArguments(),ee=requireIsObjectLike(),te=Object.prototype,ne=te.hasOwnProperty,oe=te.propertyIsEnumerable,ie=t(function(){return arguments}())?t:function(se){return ee(se)&&ne.call(se,"callee")&&!oe.call(se,"callee")};return isArguments_1=ie,isArguments_1}var isArray_1,hasRequiredIsArray;function requireIsArray(){if(hasRequiredIsArray)return isArray_1;hasRequiredIsArray=1;var t=Array.isArray;return isArray_1=t,isArray_1}var isBuffer={exports:{}},stubFalse_1,hasRequiredStubFalse;function requireStubFalse(){if(hasRequiredStubFalse)return stubFalse_1;hasRequiredStubFalse=1;function t(){return!1}return stubFalse_1=t,stubFalse_1}isBuffer.exports;var hasRequiredIsBuffer;function requireIsBuffer(){return hasRequiredIsBuffer||(hasRequiredIsBuffer=1,function(t,ee){var te=require_root(),ne=requireStubFalse(),oe=ee&&!ee.nodeType&&ee,ie=oe&&!0&&t&&!t.nodeType&&t,se=ie&&ie.exports===oe,re=se?te.Buffer:void 0,_e=re?re.isBuffer:void 0,ae=_e||ne;t.exports=ae}(isBuffer,isBuffer.exports)),isBuffer.exports}var _isIndex,hasRequired_isIndex;function require_isIndex(){if(hasRequired_isIndex)return _isIndex;hasRequired_isIndex=1;var t=9007199254740991,ee=/^(?:0|[1-9]\d*)$/;function te(ne,oe){var ie=typeof ne;return oe=oe??t,!!oe&&(ie=="number"||ie!="symbol"&&ee.test(ne))&&ne>-1&&ne%1==0&&ne<oe}return _isIndex=te,_isIndex}var isLength_1,hasRequiredIsLength;function requireIsLength(){if(hasRequiredIsLength)return isLength_1;hasRequiredIsLength=1;var t=9007199254740991;function ee(te){return typeof te=="number"&&te>-1&&te%1==0&&te<=t}return isLength_1=ee,isLength_1}var _baseIsTypedArray,hasRequired_baseIsTypedArray;function require_baseIsTypedArray(){if(hasRequired_baseIsTypedArray)return _baseIsTypedArray;hasRequired_baseIsTypedArray=1;var t=require_baseGetTag(),ee=requireIsLength(),te=requireIsObjectLike(),ne="[object Arguments]",oe="[object Array]",ie="[object Boolean]",se="[object Date]",re="[object Error]",_e="[object Function]",ae="[object Map]",ce="[object Number]",le="[object Object]",ue="[object RegExp]",de="[object Set]",me="[object String]",pe="[object WeakMap]",fe="[object ArrayBuffer]",ge="[object DataView]",he="[object Float32Array]",be="[object Float64Array]",ve="[object Int8Array]",ye="[object Int16Array]",we="[object Int32Array]",ke="[object Uint8Array]",Ae="[object Uint8ClampedArray]",$e="[object Uint16Array]",xe="[object Uint32Array]",Ce={};Ce[he]=Ce[be]=Ce[ve]=Ce[ye]=Ce[we]=Ce[ke]=Ce[Ae]=Ce[$e]=Ce[xe]=!0,Ce[ne]=Ce[oe]=Ce[fe]=Ce[ie]=Ce[ge]=Ce[se]=Ce[re]=Ce[_e]=Ce[ae]=Ce[ce]=Ce[le]=Ce[ue]=Ce[de]=Ce[me]=Ce[pe]=!1;function Se(Ie){return te(Ie)&&ee(Ie.length)&&!!Ce[t(Ie)]}return _baseIsTypedArray=Se,_baseIsTypedArray}var _baseUnary,hasRequired_baseUnary;function require_baseUnary(){if(hasRequired_baseUnary)return _baseUnary;hasRequired_baseUnary=1;function t(ee){return function(te){return ee(te)}}return _baseUnary=t,_baseUnary}var _nodeUtil={exports:{}};_nodeUtil.exports;var hasRequired_nodeUtil;function require_nodeUtil(){return hasRequired_nodeUtil||(hasRequired_nodeUtil=1,function(t,ee){var te=require_freeGlobal(),ne=ee&&!ee.nodeType&&ee,oe=ne&&!0&&t&&!t.nodeType&&t,ie=oe&&oe.exports===ne,se=ie&&te.process,re=function(){try{var _e=oe&&oe.require&&oe.require("util").types;return _e||se&&se.binding&&se.binding("util")}catch{}}();t.exports=re}(_nodeUtil,_nodeUtil.exports)),_nodeUtil.exports}var isTypedArray_1,hasRequiredIsTypedArray;function requireIsTypedArray(){if(hasRequiredIsTypedArray)return isTypedArray_1;hasRequiredIsTypedArray=1;var t=require_baseIsTypedArray(),ee=require_baseUnary(),te=require_nodeUtil(),ne=te&&te.isTypedArray,oe=ne?ee(ne):t;return isTypedArray_1=oe,isTypedArray_1}var _arrayLikeKeys,hasRequired_arrayLikeKeys;function require_arrayLikeKeys(){if(hasRequired_arrayLikeKeys)return _arrayLikeKeys;hasRequired_arrayLikeKeys=1;var t=require_baseTimes(),ee=requireIsArguments(),te=requireIsArray(),ne=requireIsBuffer(),oe=require_isIndex(),ie=requireIsTypedArray(),se=Object.prototype,re=se.hasOwnProperty;function _e(ae,ce){var le=te(ae),ue=!le&&ee(ae),de=!le&&!ue&&ne(ae),me=!le&&!ue&&!de&&ie(ae),pe=le||ue||de||me,fe=pe?t(ae.length,String):[],ge=fe.length;for(var he in ae)(ce||re.call(ae,he))&&!(pe&&(he=="length"||de&&(he=="offset"||he=="parent")||me&&(he=="buffer"||he=="byteLength"||he=="byteOffset")||oe(he,ge)))&&fe.push(he);return fe}return _arrayLikeKeys=_e,_arrayLikeKeys}var _isPrototype,hasRequired_isPrototype;function require_isPrototype(){if(hasRequired_isPrototype)return _isPrototype;hasRequired_isPrototype=1;var t=Object.prototype;function ee(te){var ne=te&&te.constructor,oe=typeof ne=="function"&&ne.prototype||t;return te===oe}return _isPrototype=ee,_isPrototype}var _overArg,hasRequired_overArg;function require_overArg(){if(hasRequired_overArg)return _overArg;hasRequired_overArg=1;function t(ee,te){return function(ne){return ee(te(ne))}}return _overArg=t,_overArg}var _nativeKeys,hasRequired_nativeKeys;function require_nativeKeys(){if(hasRequired_nativeKeys)return _nativeKeys;hasRequired_nativeKeys=1;var t=require_overArg(),ee=t(Object.keys,Object);return _nativeKeys=ee,_nativeKeys}var _baseKeys,hasRequired_baseKeys;function require_baseKeys(){if(hasRequired_baseKeys)return _baseKeys;hasRequired_baseKeys=1;var t=require_isPrototype(),ee=require_nativeKeys(),te=Object.prototype,ne=te.hasOwnProperty;function oe(ie){if(!t(ie))return ee(ie);var se=[];for(var re in Object(ie))ne.call(ie,re)&&re!="constructor"&&se.push(re);return se}return _baseKeys=oe,_baseKeys}var isArrayLike_1,hasRequiredIsArrayLike;function requireIsArrayLike(){if(hasRequiredIsArrayLike)return isArrayLike_1;hasRequiredIsArrayLike=1;var t=requireIsFunction(),ee=requireIsLength();function te(ne){return ne!=null&&ee(ne.length)&&!t(ne)}return isArrayLike_1=te,isArrayLike_1}var keys_1,hasRequiredKeys;function requireKeys(){if(hasRequiredKeys)return keys_1;hasRequiredKeys=1;var t=require_arrayLikeKeys(),ee=require_baseKeys(),te=requireIsArrayLike();function ne(oe){return te(oe)?t(oe):ee(oe)}return keys_1=ne,keys_1}var _baseAssign,hasRequired_baseAssign;function require_baseAssign(){if(hasRequired_baseAssign)return _baseAssign;hasRequired_baseAssign=1;var t=require_copyObject(),ee=requireKeys();function te(ne,oe){return ne&&t(oe,ee(oe),ne)}return _baseAssign=te,_baseAssign}var _nativeKeysIn,hasRequired_nativeKeysIn;function require_nativeKeysIn(){if(hasRequired_nativeKeysIn)return _nativeKeysIn;hasRequired_nativeKeysIn=1;function t(ee){var te=[];if(ee!=null)for(var ne in Object(ee))te.push(ne);return te}return _nativeKeysIn=t,_nativeKeysIn}var _baseKeysIn,hasRequired_baseKeysIn;function require_baseKeysIn(){if(hasRequired_baseKeysIn)return _baseKeysIn;hasRequired_baseKeysIn=1;var t=requireIsObject(),ee=require_isPrototype(),te=require_nativeKeysIn(),ne=Object.prototype,oe=ne.hasOwnProperty;function ie(se){if(!t(se))return te(se);var re=ee(se),_e=[];for(var ae in se)ae=="constructor"&&(re||!oe.call(se,ae))||_e.push(ae);return _e}return _baseKeysIn=ie,_baseKeysIn}var keysIn_1,hasRequiredKeysIn;function requireKeysIn(){if(hasRequiredKeysIn)return keysIn_1;hasRequiredKeysIn=1;var t=require_arrayLikeKeys(),ee=require_baseKeysIn(),te=requireIsArrayLike();function ne(oe){return te(oe)?t(oe,!0):ee(oe)}return keysIn_1=ne,keysIn_1}var _baseAssignIn,hasRequired_baseAssignIn;function require_baseAssignIn(){if(hasRequired_baseAssignIn)return _baseAssignIn;hasRequired_baseAssignIn=1;var t=require_copyObject(),ee=requireKeysIn();function te(ne,oe){return ne&&t(oe,ee(oe),ne)}return _baseAssignIn=te,_baseAssignIn}var _cloneBuffer={exports:{}};_cloneBuffer.exports;var hasRequired_cloneBuffer;function require_cloneBuffer(){return hasRequired_cloneBuffer||(hasRequired_cloneBuffer=1,function(t,ee){var te=require_root(),ne=ee&&!ee.nodeType&&ee,oe=ne&&!0&&t&&!t.nodeType&&t,ie=oe&&oe.exports===ne,se=ie?te.Buffer:void 0,re=se?se.allocUnsafe:void 0;function _e(ae,ce){if(ce)return ae.slice();var le=ae.length,ue=re?re(le):new ae.constructor(le);return ae.copy(ue),ue}t.exports=_e}(_cloneBuffer,_cloneBuffer.exports)),_cloneBuffer.exports}var _copyArray,hasRequired_copyArray;function require_copyArray(){if(hasRequired_copyArray)return _copyArray;hasRequired_copyArray=1;function t(ee,te){var ne=-1,oe=ee.length;for(te||(te=Array(oe));++ne<oe;)te[ne]=ee[ne];return te}return _copyArray=t,_copyArray}var _arrayFilter,hasRequired_arrayFilter;function require_arrayFilter(){if(hasRequired_arrayFilter)return _arrayFilter;hasRequired_arrayFilter=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length,ie=0,se=[];++ne<oe;){var re=ee[ne];te(re,ne,ee)&&(se[ie++]=re)}return se}return _arrayFilter=t,_arrayFilter}var stubArray_1,hasRequiredStubArray;function requireStubArray(){if(hasRequiredStubArray)return stubArray_1;hasRequiredStubArray=1;function t(){return[]}return stubArray_1=t,stubArray_1}var _getSymbols,hasRequired_getSymbols;function require_getSymbols(){if(hasRequired_getSymbols)return _getSymbols;hasRequired_getSymbols=1;var t=require_arrayFilter(),ee=requireStubArray(),te=Object.prototype,ne=te.propertyIsEnumerable,oe=Object.getOwnPropertySymbols,ie=oe?function(se){return se==null?[]:(se=Object(se),t(oe(se),function(re){return ne.call(se,re)}))}:ee;return _getSymbols=ie,_getSymbols}var _copySymbols,hasRequired_copySymbols;function require_copySymbols(){if(hasRequired_copySymbols)return _copySymbols;hasRequired_copySymbols=1;var t=require_copyObject(),ee=require_getSymbols();function te(ne,oe){return t(ne,ee(ne),oe)}return _copySymbols=te,_copySymbols}var _arrayPush,hasRequired_arrayPush;function require_arrayPush(){if(hasRequired_arrayPush)return _arrayPush;hasRequired_arrayPush=1;function t(ee,te){for(var ne=-1,oe=te.length,ie=ee.length;++ne<oe;)ee[ie+ne]=te[ne];return ee}return _arrayPush=t,_arrayPush}var _getPrototype,hasRequired_getPrototype;function require_getPrototype(){if(hasRequired_getPrototype)return _getPrototype;hasRequired_getPrototype=1;var t=require_overArg(),ee=t(Object.getPrototypeOf,Object);return _getPrototype=ee,_getPrototype}var _getSymbolsIn,hasRequired_getSymbolsIn;function require_getSymbolsIn(){if(hasRequired_getSymbolsIn)return _getSymbolsIn;hasRequired_getSymbolsIn=1;var t=require_arrayPush(),ee=require_getPrototype(),te=require_getSymbols(),ne=requireStubArray(),oe=Object.getOwnPropertySymbols,ie=oe?function(se){for(var re=[];se;)t(re,te(se)),se=ee(se);return re}:ne;return _getSymbolsIn=ie,_getSymbolsIn}var _copySymbolsIn,hasRequired_copySymbolsIn;function require_copySymbolsIn(){if(hasRequired_copySymbolsIn)return _copySymbolsIn;hasRequired_copySymbolsIn=1;var t=require_copyObject(),ee=require_getSymbolsIn();function te(ne,oe){return t(ne,ee(ne),oe)}return _copySymbolsIn=te,_copySymbolsIn}var _baseGetAllKeys,hasRequired_baseGetAllKeys;function require_baseGetAllKeys(){if(hasRequired_baseGetAllKeys)return _baseGetAllKeys;hasRequired_baseGetAllKeys=1;var t=require_arrayPush(),ee=requireIsArray();function te(ne,oe,ie){var se=oe(ne);return ee(ne)?se:t(se,ie(ne))}return _baseGetAllKeys=te,_baseGetAllKeys}var _getAllKeys,hasRequired_getAllKeys;function require_getAllKeys(){if(hasRequired_getAllKeys)return _getAllKeys;hasRequired_getAllKeys=1;var t=require_baseGetAllKeys(),ee=require_getSymbols(),te=requireKeys();function ne(oe){return t(oe,te,ee)}return _getAllKeys=ne,_getAllKeys}var _getAllKeysIn,hasRequired_getAllKeysIn;function require_getAllKeysIn(){if(hasRequired_getAllKeysIn)return _getAllKeysIn;hasRequired_getAllKeysIn=1;var t=require_baseGetAllKeys(),ee=require_getSymbolsIn(),te=requireKeysIn();function ne(oe){return t(oe,te,ee)}return _getAllKeysIn=ne,_getAllKeysIn}var _DataView,hasRequired_DataView;function require_DataView(){if(hasRequired_DataView)return _DataView;hasRequired_DataView=1;var t=require_getNative(),ee=require_root(),te=t(ee,"DataView");return _DataView=te,_DataView}var _Promise,hasRequired_Promise;function require_Promise(){if(hasRequired_Promise)return _Promise;hasRequired_Promise=1;var t=require_getNative(),ee=require_root(),te=t(ee,"Promise");return _Promise=te,_Promise}var _Set,hasRequired_Set;function require_Set(){if(hasRequired_Set)return _Set;hasRequired_Set=1;var t=require_getNative(),ee=require_root(),te=t(ee,"Set");return _Set=te,_Set}var _WeakMap,hasRequired_WeakMap;function require_WeakMap(){if(hasRequired_WeakMap)return _WeakMap;hasRequired_WeakMap=1;var t=require_getNative(),ee=require_root(),te=t(ee,"WeakMap");return _WeakMap=te,_WeakMap}var _getTag,hasRequired_getTag;function require_getTag(){if(hasRequired_getTag)return _getTag;hasRequired_getTag=1;var t=require_DataView(),ee=require_Map(),te=require_Promise(),ne=require_Set(),oe=require_WeakMap(),ie=require_baseGetTag(),se=require_toSource(),re="[object Map]",_e="[object Object]",ae="[object Promise]",ce="[object Set]",le="[object WeakMap]",ue="[object DataView]",de=se(t),me=se(ee),pe=se(te),fe=se(ne),ge=se(oe),he=ie;return(t&&he(new t(new ArrayBuffer(1)))!=ue||ee&&he(new ee)!=re||te&&he(te.resolve())!=ae||ne&&he(new ne)!=ce||oe&&he(new oe)!=le)&&(he=function(be){var ve=ie(be),ye=ve==_e?be.constructor:void 0,we=ye?se(ye):"";if(we)switch(we){case de:return ue;case me:return re;case pe:return ae;case fe:return ce;case ge:return le}return ve}),_getTag=he,_getTag}var _initCloneArray,hasRequired_initCloneArray;function require_initCloneArray(){if(hasRequired_initCloneArray)return _initCloneArray;hasRequired_initCloneArray=1;var t=Object.prototype,ee=t.hasOwnProperty;function te(ne){var oe=ne.length,ie=new ne.constructor(oe);return oe&&typeof ne[0]=="string"&&ee.call(ne,"index")&&(ie.index=ne.index,ie.input=ne.input),ie}return _initCloneArray=te,_initCloneArray}var _Uint8Array,hasRequired_Uint8Array;function require_Uint8Array(){if(hasRequired_Uint8Array)return _Uint8Array;hasRequired_Uint8Array=1;var t=require_root(),ee=t.Uint8Array;return _Uint8Array=ee,_Uint8Array}var _cloneArrayBuffer,hasRequired_cloneArrayBuffer;function require_cloneArrayBuffer(){if(hasRequired_cloneArrayBuffer)return _cloneArrayBuffer;hasRequired_cloneArrayBuffer=1;var t=require_Uint8Array();function ee(te){var ne=new te.constructor(te.byteLength);return new t(ne).set(new t(te)),ne}return _cloneArrayBuffer=ee,_cloneArrayBuffer}var _cloneDataView,hasRequired_cloneDataView;function require_cloneDataView(){if(hasRequired_cloneDataView)return _cloneDataView;hasRequired_cloneDataView=1;var t=require_cloneArrayBuffer();function ee(te,ne){var oe=ne?t(te.buffer):te.buffer;return new te.constructor(oe,te.byteOffset,te.byteLength)}return _cloneDataView=ee,_cloneDataView}var _cloneRegExp,hasRequired_cloneRegExp;function require_cloneRegExp(){if(hasRequired_cloneRegExp)return _cloneRegExp;hasRequired_cloneRegExp=1;var t=/\w*$/;function ee(te){var ne=new te.constructor(te.source,t.exec(te));return ne.lastIndex=te.lastIndex,ne}return _cloneRegExp=ee,_cloneRegExp}var _cloneSymbol,hasRequired_cloneSymbol;function require_cloneSymbol(){if(hasRequired_cloneSymbol)return _cloneSymbol;hasRequired_cloneSymbol=1;var t=require_Symbol(),ee=t?t.prototype:void 0,te=ee?ee.valueOf:void 0;function ne(oe){return te?Object(te.call(oe)):{}}return _cloneSymbol=ne,_cloneSymbol}var _cloneTypedArray,hasRequired_cloneTypedArray;function require_cloneTypedArray(){if(hasRequired_cloneTypedArray)return _cloneTypedArray;hasRequired_cloneTypedArray=1;var t=require_cloneArrayBuffer();function ee(te,ne){var oe=ne?t(te.buffer):te.buffer;return new te.constructor(oe,te.byteOffset,te.length)}return _cloneTypedArray=ee,_cloneTypedArray}var _initCloneByTag,hasRequired_initCloneByTag;function require_initCloneByTag(){if(hasRequired_initCloneByTag)return _initCloneByTag;hasRequired_initCloneByTag=1;var t=require_cloneArrayBuffer(),ee=require_cloneDataView(),te=require_cloneRegExp(),ne=require_cloneSymbol(),oe=require_cloneTypedArray(),ie="[object Boolean]",se="[object Date]",re="[object Map]",_e="[object Number]",ae="[object RegExp]",ce="[object Set]",le="[object String]",ue="[object Symbol]",de="[object ArrayBuffer]",me="[object DataView]",pe="[object Float32Array]",fe="[object Float64Array]",ge="[object Int8Array]",he="[object Int16Array]",be="[object Int32Array]",ve="[object Uint8Array]",ye="[object Uint8ClampedArray]",we="[object Uint16Array]",ke="[object Uint32Array]";function Ae($e,xe,Ce){var Se=$e.constructor;switch(xe){case de:return t($e);case ie:case se:return new Se(+$e);case me:return ee($e,Ce);case pe:case fe:case ge:case he:case be:case ve:case ye:case we:case ke:return oe($e,Ce);case re:return new Se;case _e:case le:return new Se($e);case ae:return te($e);case ce:return new Se;case ue:return ne($e)}}return _initCloneByTag=Ae,_initCloneByTag}var _baseCreate,hasRequired_baseCreate;function require_baseCreate(){if(hasRequired_baseCreate)return _baseCreate;hasRequired_baseCreate=1;var t=requireIsObject(),ee=Object.create,te=function(){function ne(){}return function(oe){if(!t(oe))return{};if(ee)return ee(oe);ne.prototype=oe;var ie=new ne;return ne.prototype=void 0,ie}}();return _baseCreate=te,_baseCreate}var _initCloneObject,hasRequired_initCloneObject;function require_initCloneObject(){if(hasRequired_initCloneObject)return _initCloneObject;hasRequired_initCloneObject=1;var t=require_baseCreate(),ee=require_getPrototype(),te=require_isPrototype();function ne(oe){return typeof oe.constructor=="function"&&!te(oe)?t(ee(oe)):{}}return _initCloneObject=ne,_initCloneObject}var _baseIsMap,hasRequired_baseIsMap;function require_baseIsMap(){if(hasRequired_baseIsMap)return _baseIsMap;hasRequired_baseIsMap=1;var t=require_getTag(),ee=requireIsObjectLike(),te="[object Map]";function ne(oe){return ee(oe)&&t(oe)==te}return _baseIsMap=ne,_baseIsMap}var isMap_1,hasRequiredIsMap;function requireIsMap(){if(hasRequiredIsMap)return isMap_1;hasRequiredIsMap=1;var t=require_baseIsMap(),ee=require_baseUnary(),te=require_nodeUtil(),ne=te&&te.isMap,oe=ne?ee(ne):t;return isMap_1=oe,isMap_1}var _baseIsSet,hasRequired_baseIsSet;function require_baseIsSet(){if(hasRequired_baseIsSet)return _baseIsSet;hasRequired_baseIsSet=1;var t=require_getTag(),ee=requireIsObjectLike(),te="[object Set]";function ne(oe){return ee(oe)&&t(oe)==te}return _baseIsSet=ne,_baseIsSet}var isSet_1,hasRequiredIsSet;function requireIsSet(){if(hasRequiredIsSet)return isSet_1;hasRequiredIsSet=1;var t=require_baseIsSet(),ee=require_baseUnary(),te=require_nodeUtil(),ne=te&&te.isSet,oe=ne?ee(ne):t;return isSet_1=oe,isSet_1}var _baseClone,hasRequired_baseClone;function require_baseClone(){if(hasRequired_baseClone)return _baseClone;hasRequired_baseClone=1;var t=require_Stack(),ee=require_arrayEach(),te=require_assignValue(),ne=require_baseAssign(),oe=require_baseAssignIn(),ie=require_cloneBuffer(),se=require_copyArray(),re=require_copySymbols(),_e=require_copySymbolsIn(),ae=require_getAllKeys(),ce=require_getAllKeysIn(),le=require_getTag(),ue=require_initCloneArray(),de=require_initCloneByTag(),me=require_initCloneObject(),pe=requireIsArray(),fe=requireIsBuffer(),ge=requireIsMap(),he=requireIsObject(),be=requireIsSet(),ve=requireKeys(),ye=requireKeysIn(),we=1,ke=2,Ae=4,$e="[object Arguments]",xe="[object Array]",Ce="[object Boolean]",Se="[object Date]",Ie="[object Error]",Pe="[object Function]",Re="[object GeneratorFunction]",De="[object Map]",Ve="[object Number]",Le="[object Object]",je="[object RegExp]",He="[object Set]",Ye="[object String]",Ue="[object Symbol]",Te="[object WeakMap]",Ee="[object ArrayBuffer]",Be="[object DataView]",ze="[object Float32Array]",Ut="[object Float64Array]",Xe="[object Int8Array]",Qe="[object Int16Array]",Qt="[object Int32Array]",Wt="[object Uint8Array]",en="[object Uint8ClampedArray]",Fe="[object Uint16Array]",We="[object Uint32Array]",Ne={};Ne[$e]=Ne[xe]=Ne[Ee]=Ne[Be]=Ne[Ce]=Ne[Se]=Ne[ze]=Ne[Ut]=Ne[Xe]=Ne[Qe]=Ne[Qt]=Ne[De]=Ne[Ve]=Ne[Le]=Ne[je]=Ne[He]=Ne[Ye]=Ne[Ue]=Ne[Wt]=Ne[en]=Ne[Fe]=Ne[We]=!0,Ne[Ie]=Ne[Pe]=Ne[Te]=!1;function Kt(qe,Ze,qt,_n,Yt,Ge){var Me,Jt=Ze&we,Xt=Ze&ke,an=Ze&Ae;if(qt&&(Me=Yt?qt(qe,_n,Yt,Ge):qt(qe)),Me!==void 0)return Me;if(!he(qe))return qe;var tn=pe(qe);if(tn){if(Me=ue(qe),!Jt)return se(qe,Me)}else{var Vt=le(qe),nn=Vt==Pe||Vt==Re;if(fe(qe))return ie(qe,Jt);if(Vt==Le||Vt==$e||nn&&!Yt){if(Me=Xt||nn?{}:me(qe),!Jt)return Xt?_e(qe,oe(Me,qe)):re(qe,ne(Me,qe))}else{if(!Ne[Vt])return Yt?qe:{};Me=de(qe,Vt,Jt)}}Ge||(Ge=new t);var on=Ge.get(qe);if(on)return on;Ge.set(qe,Me),be(qe)?qe.forEach(function(Ke){Me.add(Kt(Ke,Ze,qt,Ke,qe,Ge))}):ge(qe)&&qe.forEach(function(Ke,Je){Me.set(Je,Kt(Ke,Ze,qt,Je,qe,Ge))});var cn=an?Xt?ce:ae:Xt?ye:ve,rn=tn?void 0:cn(qe);return ee(rn||qe,function(Ke,Je){rn&&(Je=Ke,Ke=qe[Je]),te(Me,Je,Kt(Ke,Ze,qt,Je,qe,Ge))}),Me}return _baseClone=Kt,_baseClone}var clone_1,hasRequiredClone;function requireClone(){if(hasRequiredClone)return clone_1;hasRequiredClone=1;var t=require_baseClone(),ee=4;function te(ne){return t(ne,ee)}return clone_1=te,clone_1}var constant_1,hasRequiredConstant;function requireConstant(){if(hasRequiredConstant)return constant_1;hasRequiredConstant=1;function t(ee){return function(){return ee}}return constant_1=t,constant_1}var _createBaseFor,hasRequired_createBaseFor;function require_createBaseFor(){if(hasRequired_createBaseFor)return _createBaseFor;hasRequired_createBaseFor=1;function t(ee){return function(te,ne,oe){for(var ie=-1,se=Object(te),re=oe(te),_e=re.length;_e--;){var ae=re[ee?_e:++ie];if(ne(se[ae],ae,se)===!1)break}return te}}return _createBaseFor=t,_createBaseFor}var _baseFor,hasRequired_baseFor;function require_baseFor(){if(hasRequired_baseFor)return _baseFor;hasRequired_baseFor=1;var t=require_createBaseFor(),ee=t();return _baseFor=ee,_baseFor}var _baseForOwn,hasRequired_baseForOwn;function require_baseForOwn(){if(hasRequired_baseForOwn)return _baseForOwn;hasRequired_baseForOwn=1;var t=require_baseFor(),ee=requireKeys();function te(ne,oe){return ne&&t(ne,oe,ee)}return _baseForOwn=te,_baseForOwn}var _createBaseEach,hasRequired_createBaseEach;function require_createBaseEach(){if(hasRequired_createBaseEach)return _createBaseEach;hasRequired_createBaseEach=1;var t=requireIsArrayLike();function ee(te,ne){return function(oe,ie){if(oe==null)return oe;if(!t(oe))return te(oe,ie);for(var se=oe.length,re=ne?se:-1,_e=Object(oe);(ne?re--:++re<se)&&ie(_e[re],re,_e)!==!1;);return oe}}return _createBaseEach=ee,_createBaseEach}var _baseEach,hasRequired_baseEach;function require_baseEach(){if(hasRequired_baseEach)return _baseEach;hasRequired_baseEach=1;var t=require_baseForOwn(),ee=require_createBaseEach(),te=ee(t);return _baseEach=te,_baseEach}var identity_1,hasRequiredIdentity;function requireIdentity(){if(hasRequiredIdentity)return identity_1;hasRequiredIdentity=1;function t(ee){return ee}return identity_1=t,identity_1}var _castFunction,hasRequired_castFunction;function require_castFunction(){if(hasRequired_castFunction)return _castFunction;hasRequired_castFunction=1;var t=requireIdentity();function ee(te){return typeof te=="function"?te:t}return _castFunction=ee,_castFunction}var forEach_1,hasRequiredForEach;function requireForEach(){if(hasRequiredForEach)return forEach_1;hasRequiredForEach=1;var t=require_arrayEach(),ee=require_baseEach(),te=require_castFunction(),ne=requireIsArray();function oe(ie,se){var re=ne(ie)?t:ee;return re(ie,te(se))}return forEach_1=oe,forEach_1}var each,hasRequiredEach;function requireEach(){return hasRequiredEach||(hasRequiredEach=1,each=requireForEach()),each}var _baseFilter,hasRequired_baseFilter;function require_baseFilter(){if(hasRequired_baseFilter)return _baseFilter;hasRequired_baseFilter=1;var t=require_baseEach();function ee(te,ne){var oe=[];return t(te,function(ie,se,re){ne(ie,se,re)&&oe.push(ie)}),oe}return _baseFilter=ee,_baseFilter}var _setCacheAdd,hasRequired_setCacheAdd;function require_setCacheAdd(){if(hasRequired_setCacheAdd)return _setCacheAdd;hasRequired_setCacheAdd=1;var t="__lodash_hash_undefined__";function ee(te){return this.__data__.set(te,t),this}return _setCacheAdd=ee,_setCacheAdd}var _setCacheHas,hasRequired_setCacheHas;function require_setCacheHas(){if(hasRequired_setCacheHas)return _setCacheHas;hasRequired_setCacheHas=1;function t(ee){return this.__data__.has(ee)}return _setCacheHas=t,_setCacheHas}var _SetCache,hasRequired_SetCache;function require_SetCache(){if(hasRequired_SetCache)return _SetCache;hasRequired_SetCache=1;var t=require_MapCache(),ee=require_setCacheAdd(),te=require_setCacheHas();function ne(oe){var ie=-1,se=oe==null?0:oe.length;for(this.__data__=new t;++ie<se;)this.add(oe[ie])}return ne.prototype.add=ne.prototype.push=ee,ne.prototype.has=te,_SetCache=ne,_SetCache}var _arraySome,hasRequired_arraySome;function require_arraySome(){if(hasRequired_arraySome)return _arraySome;hasRequired_arraySome=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length;++ne<oe;)if(te(ee[ne],ne,ee))return!0;return!1}return _arraySome=t,_arraySome}var _cacheHas,hasRequired_cacheHas;function require_cacheHas(){if(hasRequired_cacheHas)return _cacheHas;hasRequired_cacheHas=1;function t(ee,te){return ee.has(te)}return _cacheHas=t,_cacheHas}var _equalArrays,hasRequired_equalArrays;function require_equalArrays(){if(hasRequired_equalArrays)return _equalArrays;hasRequired_equalArrays=1;var t=require_SetCache(),ee=require_arraySome(),te=require_cacheHas(),ne=1,oe=2;function ie(se,re,_e,ae,ce,le){var ue=_e&ne,de=se.length,me=re.length;if(de!=me&&!(ue&&me>de))return!1;var pe=le.get(se),fe=le.get(re);if(pe&&fe)return pe==re&&fe==se;var ge=-1,he=!0,be=_e&oe?new t:void 0;for(le.set(se,re),le.set(re,se);++ge<de;){var ve=se[ge],ye=re[ge];if(ae)var we=ue?ae(ye,ve,ge,re,se,le):ae(ve,ye,ge,se,re,le);if(we!==void 0){if(we)continue;he=!1;break}if(be){if(!ee(re,function(ke,Ae){if(!te(be,Ae)&&(ve===ke||ce(ve,ke,_e,ae,le)))return be.push(Ae)})){he=!1;break}}else if(!(ve===ye||ce(ve,ye,_e,ae,le))){he=!1;break}}return le.delete(se),le.delete(re),he}return _equalArrays=ie,_equalArrays}var _mapToArray,hasRequired_mapToArray;function require_mapToArray(){if(hasRequired_mapToArray)return _mapToArray;hasRequired_mapToArray=1;function t(ee){var te=-1,ne=Array(ee.size);return ee.forEach(function(oe,ie){ne[++te]=[ie,oe]}),ne}return _mapToArray=t,_mapToArray}var _setToArray,hasRequired_setToArray;function require_setToArray(){if(hasRequired_setToArray)return _setToArray;hasRequired_setToArray=1;function t(ee){var te=-1,ne=Array(ee.size);return ee.forEach(function(oe){ne[++te]=oe}),ne}return _setToArray=t,_setToArray}var _equalByTag,hasRequired_equalByTag;function require_equalByTag(){if(hasRequired_equalByTag)return _equalByTag;hasRequired_equalByTag=1;var t=require_Symbol(),ee=require_Uint8Array(),te=requireEq(),ne=require_equalArrays(),oe=require_mapToArray(),ie=require_setToArray(),se=1,re=2,_e="[object Boolean]",ae="[object Date]",ce="[object Error]",le="[object Map]",ue="[object Number]",de="[object RegExp]",me="[object Set]",pe="[object String]",fe="[object Symbol]",ge="[object ArrayBuffer]",he="[object DataView]",be=t?t.prototype:void 0,ve=be?be.valueOf:void 0;function ye(we,ke,Ae,$e,xe,Ce,Se){switch(Ae){case he:if(we.byteLength!=ke.byteLength||we.byteOffset!=ke.byteOffset)return!1;we=we.buffer,ke=ke.buffer;case ge:return!(we.byteLength!=ke.byteLength||!Ce(new ee(we),new ee(ke)));case _e:case ae:case ue:return te(+we,+ke);case ce:return we.name==ke.name&&we.message==ke.message;case de:case pe:return we==ke+"";case le:var Ie=oe;case me:var Pe=$e&se;if(Ie||(Ie=ie),we.size!=ke.size&&!Pe)return!1;var Re=Se.get(we);if(Re)return Re==ke;$e|=re,Se.set(we,ke);var De=ne(Ie(we),Ie(ke),$e,xe,Ce,Se);return Se.delete(we),De;case fe:if(ve)return ve.call(we)==ve.call(ke)}return!1}return _equalByTag=ye,_equalByTag}var _equalObjects,hasRequired_equalObjects;function require_equalObjects(){if(hasRequired_equalObjects)return _equalObjects;hasRequired_equalObjects=1;var t=require_getAllKeys(),ee=1,te=Object.prototype,ne=te.hasOwnProperty;function oe(ie,se,re,_e,ae,ce){var le=re&ee,ue=t(ie),de=ue.length,me=t(se),pe=me.length;if(de!=pe&&!le)return!1;for(var fe=de;fe--;){var ge=ue[fe];if(!(le?ge in se:ne.call(se,ge)))return!1}var he=ce.get(ie),be=ce.get(se);if(he&&be)return he==se&&be==ie;var ve=!0;ce.set(ie,se),ce.set(se,ie);for(var ye=le;++fe<de;){ge=ue[fe];var we=ie[ge],ke=se[ge];if(_e)var Ae=le?_e(ke,we,ge,se,ie,ce):_e(we,ke,ge,ie,se,ce);if(!(Ae===void 0?we===ke||ae(we,ke,re,_e,ce):Ae)){ve=!1;break}ye||(ye=ge=="constructor")}if(ve&&!ye){var $e=ie.constructor,xe=se.constructor;$e!=xe&&"constructor"in ie&&"constructor"in se&&!(typeof $e=="function"&&$e instanceof $e&&typeof xe=="function"&&xe instanceof xe)&&(ve=!1)}return ce.delete(ie),ce.delete(se),ve}return _equalObjects=oe,_equalObjects}var _baseIsEqualDeep,hasRequired_baseIsEqualDeep;function require_baseIsEqualDeep(){if(hasRequired_baseIsEqualDeep)return _baseIsEqualDeep;hasRequired_baseIsEqualDeep=1;var t=require_Stack(),ee=require_equalArrays(),te=require_equalByTag(),ne=require_equalObjects(),oe=require_getTag(),ie=requireIsArray(),se=requireIsBuffer(),re=requireIsTypedArray(),_e=1,ae="[object Arguments]",ce="[object Array]",le="[object Object]",ue=Object.prototype,de=ue.hasOwnProperty;function me(pe,fe,ge,he,be,ve){var ye=ie(pe),we=ie(fe),ke=ye?ce:oe(pe),Ae=we?ce:oe(fe);ke=ke==ae?le:ke,Ae=Ae==ae?le:Ae;var $e=ke==le,xe=Ae==le,Ce=ke==Ae;if(Ce&&se(pe)){if(!se(fe))return!1;ye=!0,$e=!1}if(Ce&&!$e)return ve||(ve=new t),ye||re(pe)?ee(pe,fe,ge,he,be,ve):te(pe,fe,ke,ge,he,be,ve);if(!(ge&_e)){var Se=$e&&de.call(pe,"__wrapped__"),Ie=xe&&de.call(fe,"__wrapped__");if(Se||Ie){var Pe=Se?pe.value():pe,Re=Ie?fe.value():fe;return ve||(ve=new t),be(Pe,Re,ge,he,ve)}}return Ce?(ve||(ve=new t),ne(pe,fe,ge,he,be,ve)):!1}return _baseIsEqualDeep=me,_baseIsEqualDeep}var _baseIsEqual,hasRequired_baseIsEqual;function require_baseIsEqual(){if(hasRequired_baseIsEqual)return _baseIsEqual;hasRequired_baseIsEqual=1;var t=require_baseIsEqualDeep(),ee=requireIsObjectLike();function te(ne,oe,ie,se,re){return ne===oe?!0:ne==null||oe==null||!ee(ne)&&!ee(oe)?ne!==ne&&oe!==oe:t(ne,oe,ie,se,te,re)}return _baseIsEqual=te,_baseIsEqual}var _baseIsMatch,hasRequired_baseIsMatch;function require_baseIsMatch(){if(hasRequired_baseIsMatch)return _baseIsMatch;hasRequired_baseIsMatch=1;var t=require_Stack(),ee=require_baseIsEqual(),te=1,ne=2;function oe(ie,se,re,_e){var ae=re.length,ce=ae,le=!_e;if(ie==null)return!ce;for(ie=Object(ie);ae--;){var ue=re[ae];if(le&&ue[2]?ue[1]!==ie[ue[0]]:!(ue[0]in ie))return!1}for(;++ae<ce;){ue=re[ae];var de=ue[0],me=ie[de],pe=ue[1];if(le&&ue[2]){if(me===void 0&&!(de in ie))return!1}else{var fe=new t;if(_e)var ge=_e(me,pe,de,ie,se,fe);if(!(ge===void 0?ee(pe,me,te|ne,_e,fe):ge))return!1}}return!0}return _baseIsMatch=oe,_baseIsMatch}var _isStrictComparable,hasRequired_isStrictComparable;function require_isStrictComparable(){if(hasRequired_isStrictComparable)return _isStrictComparable;hasRequired_isStrictComparable=1;var t=requireIsObject();function ee(te){return te===te&&!t(te)}return _isStrictComparable=ee,_isStrictComparable}var _getMatchData,hasRequired_getMatchData;function require_getMatchData(){if(hasRequired_getMatchData)return _getMatchData;hasRequired_getMatchData=1;var t=require_isStrictComparable(),ee=requireKeys();function te(ne){for(var oe=ee(ne),ie=oe.length;ie--;){var se=oe[ie],re=ne[se];oe[ie]=[se,re,t(re)]}return oe}return _getMatchData=te,_getMatchData}var _matchesStrictComparable,hasRequired_matchesStrictComparable;function require_matchesStrictComparable(){if(hasRequired_matchesStrictComparable)return _matchesStrictComparable;hasRequired_matchesStrictComparable=1;function t(ee,te){return function(ne){return ne==null?!1:ne[ee]===te&&(te!==void 0||ee in Object(ne))}}return _matchesStrictComparable=t,_matchesStrictComparable}var _baseMatches,hasRequired_baseMatches;function require_baseMatches(){if(hasRequired_baseMatches)return _baseMatches;hasRequired_baseMatches=1;var t=require_baseIsMatch(),ee=require_getMatchData(),te=require_matchesStrictComparable();function ne(oe){var ie=ee(oe);return ie.length==1&&ie[0][2]?te(ie[0][0],ie[0][1]):function(se){return se===oe||t(se,oe,ie)}}return _baseMatches=ne,_baseMatches}var isSymbol_1,hasRequiredIsSymbol;function requireIsSymbol(){if(hasRequiredIsSymbol)return isSymbol_1;hasRequiredIsSymbol=1;var t=require_baseGetTag(),ee=requireIsObjectLike(),te="[object Symbol]";function ne(oe){return typeof oe=="symbol"||ee(oe)&&t(oe)==te}return isSymbol_1=ne,isSymbol_1}var _isKey,hasRequired_isKey;function require_isKey(){if(hasRequired_isKey)return _isKey;hasRequired_isKey=1;var t=requireIsArray(),ee=requireIsSymbol(),te=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ne=/^\w*$/;function oe(ie,se){if(t(ie))return!1;var re=typeof ie;return re=="number"||re=="symbol"||re=="boolean"||ie==null||ee(ie)?!0:ne.test(ie)||!te.test(ie)||se!=null&&ie in Object(se)}return _isKey=oe,_isKey}var memoize_1,hasRequiredMemoize;function requireMemoize(){if(hasRequiredMemoize)return memoize_1;hasRequiredMemoize=1;var t=require_MapCache(),ee="Expected a function";function te(ne,oe){if(typeof ne!="function"||oe!=null&&typeof oe!="function")throw new TypeError(ee);var ie=function(){var se=arguments,re=oe?oe.apply(this,se):se[0],_e=ie.cache;if(_e.has(re))return _e.get(re);var ae=ne.apply(this,se);return ie.cache=_e.set(re,ae)||_e,ae};return ie.cache=new(te.Cache||t),ie}return te.Cache=t,memoize_1=te,memoize_1}var _memoizeCapped,hasRequired_memoizeCapped;function require_memoizeCapped(){if(hasRequired_memoizeCapped)return _memoizeCapped;hasRequired_memoizeCapped=1;var t=requireMemoize(),ee=500;function te(ne){var oe=t(ne,function(se){return ie.size===ee&&ie.clear(),se}),ie=oe.cache;return oe}return _memoizeCapped=te,_memoizeCapped}var _stringToPath,hasRequired_stringToPath;function require_stringToPath(){if(hasRequired_stringToPath)return _stringToPath;hasRequired_stringToPath=1;var t=require_memoizeCapped(),ee=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,te=/\\(\\)?/g,ne=t(function(oe){var ie=[];return oe.charCodeAt(0)===46&&ie.push(""),oe.replace(ee,function(se,re,_e,ae){ie.push(_e?ae.replace(te,"$1"):re||se)}),ie});return _stringToPath=ne,_stringToPath}var _arrayMap,hasRequired_arrayMap;function require_arrayMap(){if(hasRequired_arrayMap)return _arrayMap;hasRequired_arrayMap=1;function t(ee,te){for(var ne=-1,oe=ee==null?0:ee.length,ie=Array(oe);++ne<oe;)ie[ne]=te(ee[ne],ne,ee);return ie}return _arrayMap=t,_arrayMap}var _baseToString,hasRequired_baseToString;function require_baseToString(){if(hasRequired_baseToString)return _baseToString;hasRequired_baseToString=1;var t=require_Symbol(),ee=require_arrayMap(),te=requireIsArray(),ne=requireIsSymbol(),oe=1/0,ie=t?t.prototype:void 0,se=ie?ie.toString:void 0;function re(_e){if(typeof _e=="string")return _e;if(te(_e))return ee(_e,re)+"";if(ne(_e))return se?se.call(_e):"";var ae=_e+"";return ae=="0"&&1/_e==-oe?"-0":ae}return _baseToString=re,_baseToString}var toString_1,hasRequiredToString;function requireToString(){if(hasRequiredToString)return toString_1;hasRequiredToString=1;var t=require_baseToString();function ee(te){return te==null?"":t(te)}return toString_1=ee,toString_1}var _castPath,hasRequired_castPath;function require_castPath(){if(hasRequired_castPath)return _castPath;hasRequired_castPath=1;var t=requireIsArray(),ee=require_isKey(),te=require_stringToPath(),ne=requireToString();function oe(ie,se){return t(ie)?ie:ee(ie,se)?[ie]:te(ne(ie))}return _castPath=oe,_castPath}var _toKey,hasRequired_toKey;function require_toKey(){if(hasRequired_toKey)return _toKey;hasRequired_toKey=1;var t=requireIsSymbol(),ee=1/0;function te(ne){if(typeof ne=="string"||t(ne))return ne;var oe=ne+"";return oe=="0"&&1/ne==-ee?"-0":oe}return _toKey=te,_toKey}var _baseGet,hasRequired_baseGet;function require_baseGet(){if(hasRequired_baseGet)return _baseGet;hasRequired_baseGet=1;var t=require_castPath(),ee=require_toKey();function te(ne,oe){oe=t(oe,ne);for(var ie=0,se=oe.length;ne!=null&&ie<se;)ne=ne[ee(oe[ie++])];return ie&&ie==se?ne:void 0}return _baseGet=te,_baseGet}var get_1,hasRequiredGet;function requireGet(){if(hasRequiredGet)return get_1;hasRequiredGet=1;var t=require_baseGet();function ee(te,ne,oe){var ie=te==null?void 0:t(te,ne);return ie===void 0?oe:ie}return get_1=ee,get_1}var _baseHasIn,hasRequired_baseHasIn;function require_baseHasIn(){if(hasRequired_baseHasIn)return _baseHasIn;hasRequired_baseHasIn=1;function t(ee,te){return ee!=null&&te in Object(ee)}return _baseHasIn=t,_baseHasIn}var _hasPath,hasRequired_hasPath;function require_hasPath(){if(hasRequired_hasPath)return _hasPath;hasRequired_hasPath=1;var t=require_castPath(),ee=requireIsArguments(),te=requireIsArray(),ne=require_isIndex(),oe=requireIsLength(),ie=require_toKey();function se(re,_e,ae){_e=t(_e,re);for(var ce=-1,le=_e.length,ue=!1;++ce<le;){var de=ie(_e[ce]);if(!(ue=re!=null&&ae(re,de)))break;re=re[de]}return ue||++ce!=le?ue:(le=re==null?0:re.length,!!le&&oe(le)&&ne(de,le)&&(te(re)||ee(re)))}return _hasPath=se,_hasPath}var hasIn_1,hasRequiredHasIn;function requireHasIn(){if(hasRequiredHasIn)return hasIn_1;hasRequiredHasIn=1;var t=require_baseHasIn(),ee=require_hasPath();function te(ne,oe){return ne!=null&&ee(ne,oe,t)}return hasIn_1=te,hasIn_1}var _baseMatchesProperty,hasRequired_baseMatchesProperty;function require_baseMatchesProperty(){if(hasRequired_baseMatchesProperty)return _baseMatchesProperty;hasRequired_baseMatchesProperty=1;var t=require_baseIsEqual(),ee=requireGet(),te=requireHasIn(),ne=require_isKey(),oe=require_isStrictComparable(),ie=require_matchesStrictComparable(),se=require_toKey(),re=1,_e=2;function ae(ce,le){return ne(ce)&&oe(le)?ie(se(ce),le):function(ue){var de=ee(ue,ce);return de===void 0&&de===le?te(ue,ce):t(le,de,re|_e)}}return _baseMatchesProperty=ae,_baseMatchesProperty}var _baseProperty,hasRequired_baseProperty;function require_baseProperty(){if(hasRequired_baseProperty)return _baseProperty;hasRequired_baseProperty=1;function t(ee){return function(te){return te==null?void 0:te[ee]}}return _baseProperty=t,_baseProperty}var _basePropertyDeep,hasRequired_basePropertyDeep;function require_basePropertyDeep(){if(hasRequired_basePropertyDeep)return _basePropertyDeep;hasRequired_basePropertyDeep=1;var t=require_baseGet();function ee(te){return function(ne){return t(ne,te)}}return _basePropertyDeep=ee,_basePropertyDeep}var property_1,hasRequiredProperty;function requireProperty(){if(hasRequiredProperty)return property_1;hasRequiredProperty=1;var t=require_baseProperty(),ee=require_basePropertyDeep(),te=require_isKey(),ne=require_toKey();function oe(ie){return te(ie)?t(ne(ie)):ee(ie)}return property_1=oe,property_1}var _baseIteratee,hasRequired_baseIteratee;function require_baseIteratee(){if(hasRequired_baseIteratee)return _baseIteratee;hasRequired_baseIteratee=1;var t=require_baseMatches(),ee=require_baseMatchesProperty(),te=requireIdentity(),ne=requireIsArray(),oe=requireProperty();function ie(se){return typeof se=="function"?se:se==null?te:typeof se=="object"?ne(se)?ee(se[0],se[1]):t(se):oe(se)}return _baseIteratee=ie,_baseIteratee}var filter_1,hasRequiredFilter;function requireFilter(){if(hasRequiredFilter)return filter_1;hasRequiredFilter=1;var t=require_arrayFilter(),ee=require_baseFilter(),te=require_baseIteratee(),ne=requireIsArray();function oe(ie,se){var re=ne(ie)?t:ee;return re(ie,te(se,3))}return filter_1=oe,filter_1}var _baseHas,hasRequired_baseHas;function require_baseHas(){if(hasRequired_baseHas)return _baseHas;hasRequired_baseHas=1;var t=Object.prototype,ee=t.hasOwnProperty;function te(ne,oe){return ne!=null&&ee.call(ne,oe)}return _baseHas=te,_baseHas}var has_1,hasRequiredHas;function requireHas(){if(hasRequiredHas)return has_1;hasRequiredHas=1;var t=require_baseHas(),ee=require_hasPath();function te(ne,oe){return ne!=null&&ee(ne,oe,t)}return has_1=te,has_1}var isEmpty_1,hasRequiredIsEmpty;function requireIsEmpty(){if(hasRequiredIsEmpty)return isEmpty_1;hasRequiredIsEmpty=1;var t=require_baseKeys(),ee=require_getTag(),te=requireIsArguments(),ne=requireIsArray(),oe=requireIsArrayLike(),ie=requireIsBuffer(),se=require_isPrototype(),re=requireIsTypedArray(),_e="[object Map]",ae="[object Set]",ce=Object.prototype,le=ce.hasOwnProperty;function ue(de){if(de==null)return!0;if(oe(de)&&(ne(de)||typeof de=="string"||typeof de.splice=="function"||ie(de)||re(de)||te(de)))return!de.length;var me=ee(de);if(me==_e||me==ae)return!de.size;if(se(de))return!t(de).length;for(var pe in de)if(le.call(de,pe))return!1;return!0}return isEmpty_1=ue,isEmpty_1}var isUndefined_1,hasRequiredIsUndefined;function requireIsUndefined(){if(hasRequiredIsUndefined)return isUndefined_1;hasRequiredIsUndefined=1;function t(ee){return ee===void 0}return isUndefined_1=t,isUndefined_1}var _baseMap,hasRequired_baseMap;function require_baseMap(){if(hasRequired_baseMap)return _baseMap;hasRequired_baseMap=1;var t=require_baseEach(),ee=requireIsArrayLike();function te(ne,oe){var ie=-1,se=ee(ne)?Array(ne.length):[];return t(ne,function(re,_e,ae){se[++ie]=oe(re,_e,ae)}),se}return _baseMap=te,_baseMap}var map_1,hasRequiredMap;function requireMap(){if(hasRequiredMap)return map_1;hasRequiredMap=1;var t=require_arrayMap(),ee=require_baseIteratee(),te=require_baseMap(),ne=requireIsArray();function oe(ie,se){var re=ne(ie)?t:te;return re(ie,ee(se,3))}return map_1=oe,map_1}var _arrayReduce,hasRequired_arrayReduce;function require_arrayReduce(){if(hasRequired_arrayReduce)return _arrayReduce;hasRequired_arrayReduce=1;function t(ee,te,ne,oe){var ie=-1,se=ee==null?0:ee.length;for(oe&&se&&(ne=ee[++ie]);++ie<se;)ne=te(ne,ee[ie],ie,ee);return ne}return _arrayReduce=t,_arrayReduce}var _baseReduce,hasRequired_baseReduce;function require_baseReduce(){if(hasRequired_baseReduce)return _baseReduce;hasRequired_baseReduce=1;function t(ee,te,ne,oe,ie){return ie(ee,function(se,re,_e){ne=oe?(oe=!1,se):te(ne,se,re,_e)}),ne}return _baseReduce=t,_baseReduce}var reduce_1,hasRequiredReduce;function requireReduce(){if(hasRequiredReduce)return reduce_1;hasRequiredReduce=1;var t=require_arrayReduce(),ee=require_baseEach(),te=require_baseIteratee(),ne=require_baseReduce(),oe=requireIsArray();function ie(se,re,_e){var ae=oe(se)?t:ne,ce=arguments.length<3;return ae(se,te(re,4),_e,ce,ee)}return reduce_1=ie,reduce_1}var isString_1,hasRequiredIsString;function requireIsString(){if(hasRequiredIsString)return isString_1;hasRequiredIsString=1;var t=require_baseGetTag(),ee=requireIsArray(),te=requireIsObjectLike(),ne="[object String]";function oe(ie){return typeof ie=="string"||!ee(ie)&&te(ie)&&t(ie)==ne}return isString_1=oe,isString_1}var _asciiSize,hasRequired_asciiSize;function require_asciiSize(){if(hasRequired_asciiSize)return _asciiSize;hasRequired_asciiSize=1;var t=require_baseProperty(),ee=t("length");return _asciiSize=ee,_asciiSize}var _hasUnicode,hasRequired_hasUnicode;function require_hasUnicode(){if(hasRequired_hasUnicode)return _hasUnicode;hasRequired_hasUnicode=1;var t="\\ud800-\\udfff",ee="\\u0300-\\u036f",te="\\ufe20-\\ufe2f",ne="\\u20d0-\\u20ff",oe=ee+te+ne,ie="\\ufe0e\\ufe0f",se="\\u200d",re=RegExp("["+se+t+oe+ie+"]");function _e(ae){return re.test(ae)}return _hasUnicode=_e,_hasUnicode}var _unicodeSize,hasRequired_unicodeSize;function require_unicodeSize(){if(hasRequired_unicodeSize)return _unicodeSize;hasRequired_unicodeSize=1;var t="\\ud800-\\udfff",ee="\\u0300-\\u036f",te="\\ufe20-\\ufe2f",ne="\\u20d0-\\u20ff",oe=ee+te+ne,ie="\\ufe0e\\ufe0f",se="["+t+"]",re="["+oe+"]",_e="\\ud83c[\\udffb-\\udfff]",ae="(?:"+re+"|"+_e+")",ce="[^"+t+"]",le="(?:\\ud83c[\\udde6-\\uddff]){2}",ue="[\\ud800-\\udbff][\\udc00-\\udfff]",de="\\u200d",me=ae+"?",pe="["+ie+"]?",fe="(?:"+de+"(?:"+[ce,le,ue].join("|")+")"+pe+me+")*",ge=pe+me+fe,he="(?:"+[ce+re+"?",re,le,ue,se].join("|")+")",be=RegExp(_e+"(?="+_e+")|"+he+ge,"g");function ve(ye){for(var we=be.lastIndex=0;be.test(ye);)++we;return we}return _unicodeSize=ve,_unicodeSize}var _stringSize,hasRequired_stringSize;function require_stringSize(){if(hasRequired_stringSize)return _stringSize;hasRequired_stringSize=1;var t=require_asciiSize(),ee=require_hasUnicode(),te=require_unicodeSize();function ne(oe){return ee(oe)?te(oe):t(oe)}return _stringSize=ne,_stringSize}var size_1,hasRequiredSize;function requireSize(){if(hasRequiredSize)return size_1;hasRequiredSize=1;var t=require_baseKeys(),ee=require_getTag(),te=requireIsArrayLike(),ne=requireIsString(),oe=require_stringSize(),ie="[object Map]",se="[object Set]";function re(_e){if(_e==null)return 0;if(te(_e))return ne(_e)?oe(_e):_e.length;var ae=ee(_e);return ae==ie||ae==se?_e.size:t(_e).length}return size_1=re,size_1}var transform_1,hasRequiredTransform;function requireTransform(){if(hasRequiredTransform)return transform_1;hasRequiredTransform=1;var t=require_arrayEach(),ee=require_baseCreate(),te=require_baseForOwn(),ne=require_baseIteratee(),oe=require_getPrototype(),ie=requireIsArray(),se=requireIsBuffer(),re=requireIsFunction(),_e=requireIsObject(),ae=requireIsTypedArray();function ce(le,ue,de){var me=ie(le),pe=me||se(le)||ae(le);if(ue=ne(ue,4),de==null){var fe=le&&le.constructor;pe?de=me?new fe:[]:_e(le)?de=re(fe)?ee(oe(le)):{}:de={}}return(pe?t:te)(le,function(ge,he,be){return ue(de,ge,he,be)}),de}return transform_1=ce,transform_1}var _isFlattenable,hasRequired_isFlattenable;function require_isFlattenable(){if(hasRequired_isFlattenable)return _isFlattenable;hasRequired_isFlattenable=1;var t=require_Symbol(),ee=requireIsArguments(),te=requireIsArray(),ne=t?t.isConcatSpreadable:void 0;function oe(ie){return te(ie)||ee(ie)||!!(ne&&ie&&ie[ne])}return _isFlattenable=oe,_isFlattenable}var _baseFlatten,hasRequired_baseFlatten;function require_baseFlatten(){if(hasRequired_baseFlatten)return _baseFlatten;hasRequired_baseFlatten=1;var t=require_arrayPush(),ee=require_isFlattenable();function te(ne,oe,ie,se,re){var _e=-1,ae=ne.length;for(ie||(ie=ee),re||(re=[]);++_e<ae;){var ce=ne[_e];oe>0&&ie(ce)?oe>1?te(ce,oe-1,ie,se,re):t(re,ce):se||(re[re.length]=ce)}return re}return _baseFlatten=te,_baseFlatten}var _apply,hasRequired_apply;function require_apply(){if(hasRequired_apply)return _apply;hasRequired_apply=1;function t(ee,te,ne){switch(ne.length){case 0:return ee.call(te);case 1:return ee.call(te,ne[0]);case 2:return ee.call(te,ne[0],ne[1]);case 3:return ee.call(te,ne[0],ne[1],ne[2])}return ee.apply(te,ne)}return _apply=t,_apply}var _overRest,hasRequired_overRest;function require_overRest(){if(hasRequired_overRest)return _overRest;hasRequired_overRest=1;var t=require_apply(),ee=Math.max;function te(ne,oe,ie){return oe=ee(oe===void 0?ne.length-1:oe,0),function(){for(var se=arguments,re=-1,_e=ee(se.length-oe,0),ae=Array(_e);++re<_e;)ae[re]=se[oe+re];re=-1;for(var ce=Array(oe+1);++re<oe;)ce[re]=se[re];return ce[oe]=ie(ae),t(ne,this,ce)}}return _overRest=te,_overRest}var _baseSetToString,hasRequired_baseSetToString;function require_baseSetToString(){if(hasRequired_baseSetToString)return _baseSetToString;hasRequired_baseSetToString=1;var t=requireConstant(),ee=require_defineProperty(),te=requireIdentity(),ne=ee?function(oe,ie){return ee(oe,"toString",{configurable:!0,enumerable:!1,value:t(ie),writable:!0})}:te;return _baseSetToString=ne,_baseSetToString}var _shortOut,hasRequired_shortOut;function require_shortOut(){if(hasRequired_shortOut)return _shortOut;hasRequired_shortOut=1;var t=800,ee=16,te=Date.now;function ne(oe){var ie=0,se=0;return function(){var re=te(),_e=ee-(re-se);if(se=re,_e>0){if(++ie>=t)return arguments[0]}else ie=0;return oe.apply(void 0,arguments)}}return _shortOut=ne,_shortOut}var _setToString,hasRequired_setToString;function require_setToString(){if(hasRequired_setToString)return _setToString;hasRequired_setToString=1;var t=require_baseSetToString(),ee=require_shortOut(),te=ee(t);return _setToString=te,_setToString}var _baseRest,hasRequired_baseRest;function require_baseRest(){if(hasRequired_baseRest)return _baseRest;hasRequired_baseRest=1;var t=requireIdentity(),ee=require_overRest(),te=require_setToString();function ne(oe,ie){return te(ee(oe,ie,t),oe+"")}return _baseRest=ne,_baseRest}var _baseFindIndex,hasRequired_baseFindIndex;function require_baseFindIndex(){if(hasRequired_baseFindIndex)return _baseFindIndex;hasRequired_baseFindIndex=1;function t(ee,te,ne,oe){for(var ie=ee.length,se=ne+(oe?1:-1);oe?se--:++se<ie;)if(te(ee[se],se,ee))return se;return-1}return _baseFindIndex=t,_baseFindIndex}var _baseIsNaN,hasRequired_baseIsNaN;function require_baseIsNaN(){if(hasRequired_baseIsNaN)return _baseIsNaN;hasRequired_baseIsNaN=1;function t(ee){return ee!==ee}return _baseIsNaN=t,_baseIsNaN}var _strictIndexOf,hasRequired_strictIndexOf;function require_strictIndexOf(){if(hasRequired_strictIndexOf)return _strictIndexOf;hasRequired_strictIndexOf=1;function t(ee,te,ne){for(var oe=ne-1,ie=ee.length;++oe<ie;)if(ee[oe]===te)return oe;return-1}return _strictIndexOf=t,_strictIndexOf}var _baseIndexOf,hasRequired_baseIndexOf;function require_baseIndexOf(){if(hasRequired_baseIndexOf)return _baseIndexOf;hasRequired_baseIndexOf=1;var t=require_baseFindIndex(),ee=require_baseIsNaN(),te=require_strictIndexOf();function ne(oe,ie,se){return ie===ie?te(oe,ie,se):t(oe,ee,se)}return _baseIndexOf=ne,_baseIndexOf}var _arrayIncludes,hasRequired_arrayIncludes;function require_arrayIncludes(){if(hasRequired_arrayIncludes)return _arrayIncludes;hasRequired_arrayIncludes=1;var t=require_baseIndexOf();function ee(te,ne){var oe=te==null?0:te.length;return!!oe&&t(te,ne,0)>-1}return _arrayIncludes=ee,_arrayIncludes}var _arrayIncludesWith,hasRequired_arrayIncludesWith;function require_arrayIncludesWith(){if(hasRequired_arrayIncludesWith)return _arrayIncludesWith;hasRequired_arrayIncludesWith=1;function t(ee,te,ne){for(var oe=-1,ie=ee==null?0:ee.length;++oe<ie;)if(ne(te,ee[oe]))return!0;return!1}return _arrayIncludesWith=t,_arrayIncludesWith}var noop_1,hasRequiredNoop;function requireNoop(){if(hasRequiredNoop)return noop_1;hasRequiredNoop=1;function t(){}return noop_1=t,noop_1}var _createSet,hasRequired_createSet;function require_createSet(){if(hasRequired_createSet)return _createSet;hasRequired_createSet=1;var t=require_Set(),ee=requireNoop(),te=require_setToArray(),ne=1/0,oe=t&&1/te(new t([,-0]))[1]==ne?function(ie){return new t(ie)}:ee;return _createSet=oe,_createSet}var _baseUniq,hasRequired_baseUniq;function require_baseUniq(){if(hasRequired_baseUniq)return _baseUniq;hasRequired_baseUniq=1;var t=require_SetCache(),ee=require_arrayIncludes(),te=require_arrayIncludesWith(),ne=require_cacheHas(),oe=require_createSet(),ie=require_setToArray(),se=200;function re(_e,ae,ce){var le=-1,ue=ee,de=_e.length,me=!0,pe=[],fe=pe;if(ce)me=!1,ue=te;else if(de>=se){var ge=ae?null:oe(_e);if(ge)return ie(ge);me=!1,ue=ne,fe=new t}else fe=ae?[]:pe;e:for(;++le<de;){var he=_e[le],be=ae?ae(he):he;if(he=ce||he!==0?he:0,me&&be===be){for(var ve=fe.length;ve--;)if(fe[ve]===be)continue e;ae&&fe.push(be),pe.push(he)}else ue(fe,be,ce)||(fe!==pe&&fe.push(be),pe.push(he))}return pe}return _baseUniq=re,_baseUniq}var isArrayLikeObject_1,hasRequiredIsArrayLikeObject;function requireIsArrayLikeObject(){if(hasRequiredIsArrayLikeObject)return isArrayLikeObject_1;hasRequiredIsArrayLikeObject=1;var t=requireIsArrayLike(),ee=requireIsObjectLike();function te(ne){return ee(ne)&&t(ne)}return isArrayLikeObject_1=te,isArrayLikeObject_1}var union_1,hasRequiredUnion;function requireUnion(){if(hasRequiredUnion)return union_1;hasRequiredUnion=1;var t=require_baseFlatten(),ee=require_baseRest(),te=require_baseUniq(),ne=requireIsArrayLikeObject(),oe=ee(function(ie){return te(t(ie,1,ne,!0))});return union_1=oe,union_1}var _baseValues,hasRequired_baseValues;function require_baseValues(){if(hasRequired_baseValues)return _baseValues;hasRequired_baseValues=1;var t=require_arrayMap();function ee(te,ne){return t(ne,function(oe){return te[oe]})}return _baseValues=ee,_baseValues}var values_1,hasRequiredValues;function requireValues(){if(hasRequiredValues)return values_1;hasRequiredValues=1;var t=require_baseValues(),ee=requireKeys();function te(ne){return ne==null?[]:t(ne,ee(ne))}return values_1=te,values_1}var lodash;if(typeof commonjsRequire=="function")try{lodash={clone:requireClone(),constant:requireConstant(),each:requireEach(),filter:requireFilter(),has:requireHas(),isArray:requireIsArray(),isEmpty:requireIsEmpty(),isFunction:requireIsFunction(),isUndefined:requireIsUndefined(),keys:requireKeys(),map:requireMap(),reduce:requireReduce(),size:requireSize(),transform:requireTransform(),union:requireUnion(),values:requireValues()}}catch{}lodash||(lodash=window._);var lodash_1=lodash,_$b=lodash_1,graph=Graph$2,DEFAULT_EDGE_NAME="\0",GRAPH_NODE="\0",EDGE_KEY_DELIM="";function Graph$2(t){this._isDirected=_$b.has(t,"directed")?t.directed:!0,this._isMultigraph=_$b.has(t,"multigraph")?t.multigraph:!1,this._isCompound=_$b.has(t,"compound")?t.compound:!1,this._label=void 0,this._defaultNodeLabelFn=_$b.constant(void 0),this._defaultEdgeLabelFn=_$b.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[GRAPH_NODE]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}Graph$2.prototype._nodeCount=0;Graph$2.prototype._edgeCount=0;Graph$2.prototype.isDirected=function(){return this._isDirected};Graph$2.prototype.isMultigraph=function(){return this._isMultigraph};Graph$2.prototype.isCompound=function(){return this._isCompound};Graph$2.prototype.setGraph=function(t){return this._label=t,this};Graph$2.prototype.graph=function(){return this._label};Graph$2.prototype.setDefaultNodeLabel=function(t){return _$b.isFunction(t)||(t=_$b.constant(t)),this._defaultNodeLabelFn=t,this};Graph$2.prototype.nodeCount=function(){return this._nodeCount};Graph$2.prototype.nodes=function(){return _$b.keys(this._nodes)};Graph$2.prototype.sources=function(){var t=this;return _$b.filter(this.nodes(),function(ee){return _$b.isEmpty(t._in[ee])})};Graph$2.prototype.sinks=function(){var t=this;return _$b.filter(this.nodes(),function(ee){return _$b.isEmpty(t._out[ee])})};Graph$2.prototype.setNodes=function(t,ee){var te=arguments,ne=this;return _$b.each(t,function(oe){te.length>1?ne.setNode(oe,ee):ne.setNode(oe)}),this};Graph$2.prototype.setNode=function(t,ee){return _$b.has(this._nodes,t)?(arguments.length>1&&(this._nodes[t]=ee),this):(this._nodes[t]=arguments.length>1?ee:this._defaultNodeLabelFn(t),this._isCompound&&(this._parent[t]=GRAPH_NODE,this._children[t]={},this._children[GRAPH_NODE][t]=!0),this._in[t]={},this._preds[t]={},this._out[t]={},this._sucs[t]={},++this._nodeCount,this)};Graph$2.prototype.node=function(t){return this._nodes[t]};Graph$2.prototype.hasNode=function(t){return _$b.has(this._nodes,t)};Graph$2.prototype.removeNode=function(t){var ee=this;if(_$b.has(this._nodes,t)){var te=function(ne){ee.removeEdge(ee._edgeObjs[ne])};delete this._nodes[t],this._isCompound&&(this._removeFromParentsChildList(t),delete this._parent[t],_$b.each(this.children(t),function(ne){ee.setParent(ne)}),delete this._children[t]),_$b.each(_$b.keys(this._in[t]),te),delete this._in[t],delete this._preds[t],_$b.each(_$b.keys(this._out[t]),te),delete this._out[t],delete this._sucs[t],--this._nodeCount}return this};Graph$2.prototype.setParent=function(t,ee){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(_$b.isUndefined(ee))ee=GRAPH_NODE;else{ee+="";for(var te=ee;!_$b.isUndefined(te);te=this.parent(te))if(te===t)throw new Error("Setting "+ee+" as parent of "+t+" would create a cycle");this.setNode(ee)}return this.setNode(t),this._removeFromParentsChildList(t),this._parent[t]=ee,this._children[ee][t]=!0,this};Graph$2.prototype._removeFromParentsChildList=function(t){delete this._children[this._parent[t]][t]};Graph$2.prototype.parent=function(t){if(this._isCompound){var ee=this._parent[t];if(ee!==GRAPH_NODE)return ee}};Graph$2.prototype.children=function(t){if(_$b.isUndefined(t)&&(t=GRAPH_NODE),this._isCompound){var ee=this._children[t];if(ee)return _$b.keys(ee)}else{if(t===GRAPH_NODE)return this.nodes();if(this.hasNode(t))return[]}};Graph$2.prototype.predecessors=function(t){var ee=this._preds[t];if(ee)return _$b.keys(ee)};Graph$2.prototype.successors=function(t){var ee=this._sucs[t];if(ee)return _$b.keys(ee)};Graph$2.prototype.neighbors=function(t){var ee=this.predecessors(t);if(ee)return _$b.union(ee,this.successors(t))};Graph$2.prototype.isLeaf=function(t){var ee;return this.isDirected()?ee=this.successors(t):ee=this.neighbors(t),ee.length===0};Graph$2.prototype.filterNodes=function(t){var ee=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});ee.setGraph(this.graph());var te=this;_$b.each(this._nodes,function(ie,se){t(se)&&ee.setNode(se,ie)}),_$b.each(this._edgeObjs,function(ie){ee.hasNode(ie.v)&&ee.hasNode(ie.w)&&ee.setEdge(ie,te.edge(ie))});var ne={};function oe(ie){var se=te.parent(ie);return se===void 0||ee.hasNode(se)?(ne[ie]=se,se):se in ne?ne[se]:oe(se)}return this._isCompound&&_$b.each(ee.nodes(),function(ie){ee.setParent(ie,oe(ie))}),ee};Graph$2.prototype.setDefaultEdgeLabel=function(t){return _$b.isFunction(t)||(t=_$b.constant(t)),this._defaultEdgeLabelFn=t,this};Graph$2.prototype.edgeCount=function(){return this._edgeCount};Graph$2.prototype.edges=function(){return _$b.values(this._edgeObjs)};Graph$2.prototype.setPath=function(t,ee){var te=this,ne=arguments;return _$b.reduce(t,function(oe,ie){return ne.length>1?te.setEdge(oe,ie,ee):te.setEdge(oe,ie),ie}),this};Graph$2.prototype.setEdge=function(){var t,ee,te,ne,oe=!1,ie=arguments[0];typeof ie=="object"&&ie!==null&&"v"in ie?(t=ie.v,ee=ie.w,te=ie.name,arguments.length===2&&(ne=arguments[1],oe=!0)):(t=ie,ee=arguments[1],te=arguments[3],arguments.length>2&&(ne=arguments[2],oe=!0)),t=""+t,ee=""+ee,_$b.isUndefined(te)||(te=""+te);var se=edgeArgsToId(this._isDirected,t,ee,te);if(_$b.has(this._edgeLabels,se))return oe&&(this._edgeLabels[se]=ne),this;if(!_$b.isUndefined(te)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(t),this.setNode(ee),this._edgeLabels[se]=oe?ne:this._defaultEdgeLabelFn(t,ee,te);var re=edgeArgsToObj(this._isDirected,t,ee,te);return t=re.v,ee=re.w,Object.freeze(re),this._edgeObjs[se]=re,incrementOrInitEntry(this._preds[ee],t),incrementOrInitEntry(this._sucs[t],ee),this._in[ee][se]=re,this._out[t][se]=re,this._edgeCount++,this};Graph$2.prototype.edge=function(t,ee,te){var ne=arguments.length===1?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,t,ee,te);return this._edgeLabels[ne]};Graph$2.prototype.hasEdge=function(t,ee,te){var ne=arguments.length===1?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,t,ee,te);return _$b.has(this._edgeLabels,ne)};Graph$2.prototype.removeEdge=function(t,ee,te){var ne=arguments.length===1?edgeObjToId(this._isDirected,arguments[0]):edgeArgsToId(this._isDirected,t,ee,te),oe=this._edgeObjs[ne];return oe&&(t=oe.v,ee=oe.w,delete this._edgeLabels[ne],delete this._edgeObjs[ne],decrementOrRemoveEntry(this._preds[ee],t),decrementOrRemoveEntry(this._sucs[t],ee),delete this._in[ee][ne],delete this._out[t][ne],this._edgeCount--),this};Graph$2.prototype.inEdges=function(t,ee){var te=this._in[t];if(te){var ne=_$b.values(te);return ee?_$b.filter(ne,function(oe){return oe.v===ee}):ne}};Graph$2.prototype.outEdges=function(t,ee){var te=this._out[t];if(te){var ne=_$b.values(te);return ee?_$b.filter(ne,function(oe){return oe.w===ee}):ne}};Graph$2.prototype.nodeEdges=function(t,ee){var te=this.inEdges(t,ee);if(te)return te.concat(this.outEdges(t,ee))};function incrementOrInitEntry(t,ee){t[ee]?t[ee]++:t[ee]=1}function decrementOrRemoveEntry(t,ee){--t[ee]||delete t[ee]}function edgeArgsToId(t,ee,te,ne){var oe=""+ee,ie=""+te;if(!t&&oe>ie){var se=oe;oe=ie,ie=se}return oe+EDGE_KEY_DELIM+ie+EDGE_KEY_DELIM+(_$b.isUndefined(ne)?DEFAULT_EDGE_NAME:ne)}function edgeArgsToObj(t,ee,te,ne){var oe=""+ee,ie=""+te;if(!t&&oe>ie){var se=oe;oe=ie,ie=se}var re={v:oe,w:ie};return ne&&(re.name=ne),re}function edgeObjToId(t,ee){return edgeArgsToId(t,ee.v,ee.w,ee.name)}var version="2.1.8",lib$1={Graph:graph,version},_$a=lodash_1,Graph$1=graph,json={write,read};function write(t){var ee={options:{directed:t.isDirected(),multigraph:t.isMultigraph(),compound:t.isCompound()},nodes:writeNodes(t),edges:writeEdges(t)};return _$a.isUndefined(t.graph())||(ee.value=_$a.clone(t.graph())),ee}function writeNodes(t){return _$a.map(t.nodes(),function(ee){var te=t.node(ee),ne=t.parent(ee),oe={v:ee};return _$a.isUndefined(te)||(oe.value=te),_$a.isUndefined(ne)||(oe.parent=ne),oe})}function writeEdges(t){return _$a.map(t.edges(),function(ee){var te=t.edge(ee),ne={v:ee.v,w:ee.w};return _$a.isUndefined(ee.name)||(ne.name=ee.name),_$a.isUndefined(te)||(ne.value=te),ne})}function read(t){var ee=new Graph$1(t.options).setGraph(t.value);return _$a.each(t.nodes,function(te){ee.setNode(te.v,te.value),te.parent&&ee.setParent(te.v,te.parent)}),_$a.each(t.edges,function(te){ee.setEdge({v:te.v,w:te.w,name:te.name},te.value)}),ee}var _$9=lodash_1,components_1=components;function components(t){var ee={},te=[],ne;function oe(ie){_$9.has(ee,ie)||(ee[ie]=!0,ne.push(ie),_$9.each(t.successors(ie),oe),_$9.each(t.predecessors(ie),oe))}return _$9.each(t.nodes(),function(ie){ne=[],oe(ie),ne.length&&te.push(ne)}),te}var _$8=lodash_1,priorityQueue=PriorityQueue$2;function PriorityQueue$2(){this._arr=[],this._keyIndices={}}PriorityQueue$2.prototype.size=function(){return this._arr.length};PriorityQueue$2.prototype.keys=function(){return this._arr.map(function(t){return t.key})};PriorityQueue$2.prototype.has=function(t){return _$8.has(this._keyIndices,t)};PriorityQueue$2.prototype.priority=function(t){var ee=this._keyIndices[t];if(ee!==void 0)return this._arr[ee].priority};PriorityQueue$2.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key};PriorityQueue$2.prototype.add=function(t,ee){var te=this._keyIndices;if(t=String(t),!_$8.has(te,t)){var ne=this._arr,oe=ne.length;return te[t]=oe,ne.push({key:t,priority:ee}),this._decrease(oe),!0}return!1};PriorityQueue$2.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var t=this._arr.pop();return delete this._keyIndices[t.key],this._heapify(0),t.key};PriorityQueue$2.prototype.decrease=function(t,ee){var te=this._keyIndices[t];if(ee>this._arr[te].priority)throw new Error("New priority is greater than current priority. Key: "+t+" Old: "+this._arr[te].priority+" New: "+ee);this._arr[te].priority=ee,this._decrease(te)};PriorityQueue$2.prototype._heapify=function(t){var ee=this._arr,te=2*t,ne=te+1,oe=t;te<ee.length&&(oe=ee[te].priority<ee[oe].priority?te:oe,ne<ee.length&&(oe=ee[ne].priority<ee[oe].priority?ne:oe),oe!==t&&(this._swap(t,oe),this._heapify(oe)))};PriorityQueue$2.prototype._decrease=function(t){for(var ee=this._arr,te=ee[t].priority,ne;t!==0&&(ne=t>>1,!(ee[ne].priority<te));)this._swap(t,ne),t=ne};PriorityQueue$2.prototype._swap=function(t,ee){var te=this._arr,ne=this._keyIndices,oe=te[t],ie=te[ee];te[t]=ie,te[ee]=oe,ne[ie.key]=t,ne[oe.key]=ee};var _$7=lodash_1,PriorityQueue$1=priorityQueue,dijkstra_1=dijkstra$1,DEFAULT_WEIGHT_FUNC$1=_$7.constant(1);function dijkstra$1(t,ee,te,ne){return runDijkstra(t,String(ee),te||DEFAULT_WEIGHT_FUNC$1,ne||function(oe){return t.outEdges(oe)})}function runDijkstra(t,ee,te,ne){var oe={},ie=new PriorityQueue$1,se,re,_e=function(ae){var ce=ae.v!==se?ae.v:ae.w,le=oe[ce],ue=te(ae),de=re.distance+ue;if(ue<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+ae+" Weight: "+ue);de<le.distance&&(le.distance=de,le.predecessor=se,ie.decrease(ce,de))};for(t.nodes().forEach(function(ae){var ce=ae===ee?0:Number.POSITIVE_INFINITY;oe[ae]={distance:ce},ie.add(ae,ce)});ie.size()>0&&(se=ie.removeMin(),re=oe[se],re.distance!==Number.POSITIVE_INFINITY);)ne(se).forEach(_e);return oe}var dijkstra=dijkstra_1,_$6=lodash_1,dijkstraAll_1=dijkstraAll;function dijkstraAll(t,ee,te){return _$6.transform(t.nodes(),function(ne,oe){ne[oe]=dijkstra(t,oe,ee,te)},{})}var _$5=lodash_1,tarjan_1=tarjan$1;function tarjan$1(t){var ee=0,te=[],ne={},oe=[];function ie(se){var re=ne[se]={onStack:!0,lowlink:ee,index:ee++};if(te.push(se),t.successors(se).forEach(function(ce){_$5.has(ne,ce)?ne[ce].onStack&&(re.lowlink=Math.min(re.lowlink,ne[ce].index)):(ie(ce),re.lowlink=Math.min(re.lowlink,ne[ce].lowlink))}),re.lowlink===re.index){var _e=[],ae;do ae=te.pop(),ne[ae].onStack=!1,_e.push(ae);while(se!==ae);oe.push(_e)}}return t.nodes().forEach(function(se){_$5.has(ne,se)||ie(se)}),oe}var _$4=lodash_1,tarjan=tarjan_1,findCycles_1=findCycles;function findCycles(t){return _$4.filter(tarjan(t),function(ee){return ee.length>1||ee.length===1&&t.hasEdge(ee[0],ee[0])})}var _$3=lodash_1,floydWarshall_1=floydWarshall,DEFAULT_WEIGHT_FUNC=_$3.constant(1);function floydWarshall(t,ee,te){return runFloydWarshall(t,ee||DEFAULT_WEIGHT_FUNC,te||function(ne){return t.outEdges(ne)})}function runFloydWarshall(t,ee,te){var ne={},oe=t.nodes();return oe.forEach(function(ie){ne[ie]={},ne[ie][ie]={distance:0},oe.forEach(function(se){ie!==se&&(ne[ie][se]={distance:Number.POSITIVE_INFINITY})}),te(ie).forEach(function(se){var re=se.v===ie?se.w:se.v,_e=ee(se);ne[ie][re]={distance:_e,predecessor:ie}})}),oe.forEach(function(ie){var se=ne[ie];oe.forEach(function(re){var _e=ne[re];oe.forEach(function(ae){var ce=_e[ie],le=se[ae],ue=_e[ae],de=ce.distance+le.distance;de<ue.distance&&(ue.distance=de,ue.predecessor=le.predecessor)})})}),ne}var _$2=lodash_1,topsort_1=topsort$1;topsort$1.CycleException=CycleException;function topsort$1(t){var ee={},te={},ne=[];function oe(ie){if(_$2.has(te,ie))throw new CycleException;_$2.has(ee,ie)||(te[ie]=!0,ee[ie]=!0,_$2.each(t.predecessors(ie),oe),delete te[ie],ne.push(ie))}if(_$2.each(t.sinks(),oe),_$2.size(ee)!==t.nodeCount())throw new CycleException;return ne}function CycleException(){}CycleException.prototype=new Error;var topsort=topsort_1,isAcyclic_1=isAcyclic;function isAcyclic(t){try{topsort(t)}catch(ee){if(ee instanceof topsort.CycleException)return!1;throw ee}return!0}var _$1=lodash_1,dfs_1=dfs$2;function dfs$2(t,ee,te){_$1.isArray(ee)||(ee=[ee]);var ne=(t.isDirected()?t.successors:t.neighbors).bind(t),oe=[],ie={};return _$1.each(ee,function(se){if(!t.hasNode(se))throw new Error("Graph does not have node: "+se);doDfs(t,se,te==="post",ie,ne,oe)}),oe}function doDfs(t,ee,te,ne,oe,ie){_$1.has(ne,ee)||(ne[ee]=!0,te||ie.push(ee),_$1.each(oe(ee),function(se){doDfs(t,se,te,ne,oe,ie)}),te&&ie.push(ee))}var dfs$1=dfs_1,postorder_1=postorder;function postorder(t,ee){return dfs$1(t,ee,"post")}var dfs=dfs_1,preorder_1=preorder;function preorder(t,ee){return dfs(t,ee,"pre")}var _=lodash_1,Graph=graph,PriorityQueue=priorityQueue,prim_1=prim;function prim(t,ee){var te=new Graph,ne={},oe=new PriorityQueue,ie;function se(_e){var ae=_e.v===ie?_e.w:_e.v,ce=oe.priority(ae);if(ce!==void 0){var le=ee(_e);le<ce&&(ne[ae]=ie,oe.decrease(ae,le))}}if(t.nodeCount()===0)return te;_.each(t.nodes(),function(_e){oe.add(_e,Number.POSITIVE_INFINITY),te.setNode(_e)}),oe.decrease(t.nodes()[0],0);for(var re=!1;oe.size()>0;){if(ie=oe.removeMin(),_.has(ne,ie))te.setEdge(ie,ne[ie]);else{if(re)throw new Error("Input graph is not connected: "+t);re=!0}t.nodeEdges(ie).forEach(se)}return te}var alg$1={components:components_1,dijkstra:dijkstra_1,dijkstraAll:dijkstraAll_1,findCycles:findCycles_1,floydWarshall:floydWarshall_1,isAcyclic:isAcyclic_1,postorder:postorder_1,preorder:preorder_1,prim:prim_1,tarjan:tarjan_1,topsort:topsort_1},lib=lib$1,graphlib={Graph:lib.Graph,json,alg:alg$1,version:lib.version};const index=getDefaultExportFromCjs(graphlib),GraphLib=_mergeNamespaces({__proto__:null,default:index},[graphlib]),alg=(index||GraphLib).alg;function make_graph(t){const{items:ee,get_id:te,get_head_ids:ne,get_tail_ids:oe}=t,ie=new graphlib.Graph;ee.forEach(re=>ie.setNode(te(re),re));const se=re=>ie.hasNode(re);return ee.forEach(re=>{const _e=te(re);ne(re).filter(se).forEach(ae=>ie.setEdge(_e,ae)),oe(re).filter(se).forEach(ae=>ie.setEdge(ae,_e))}),ie}function find_leaf_group_ids(t){const{graph:ee}=t,te=get_graph_groups({graph:ee}),ne=[];return te.forEach(oe=>{find_leaf_ids(oe).forEach(se=>{const re=[se,...find_all_predecessor_ids(ee,se)];ne.push(re)})}),ne}function get_graph_groups(t){const{graph:ee}=t;return alg.components(ee).map(ne=>{const oe=new graphlib.Graph;return ne.forEach(ie=>{oe.setNode(ie,ee.node(ie)),(ee.nodeEdges(ie)||[]).forEach(re=>oe.setEdge(re))}),oe})}function find_leaf_ids(t){return t.nodes().filter(te=>(t.successors(te)||[]).length===0)}function find_leaf_ids_for_id(t,ee){const te=find_leaf_ids(t),ne=alg.dijkstra(t,ee);return te.filter(oe=>ne[oe].distance<Number.POSITIVE_INFINITY)}function find_all_predecessor_ids(t,ee,te=!1){const ne=t.predecessors(ee)||[],oe=new Set;let ie=ne.pop()||"";for(;ie;){if(!oe.has(ie)&&(te||ie!==ee)){oe.add(ie);const se=t.predecessors(ie)||[];ne.push(...se)}ie=ne.pop()||""}return Array.from(oe)}const test_graph_related_functions=describe("graph related functions",()=>{const t=ge=>ge.id,ee=ge=>ge.head_ids,te=ge=>ge.tail_ids,ne=ge=>make_graph({items:ge,get_id:t,get_head_ids:ee,get_tail_ids:te});function oe(ge,he,be){test(ge.node(he),be.item);const ve=ge.outEdges(he)||[];test(ve.map(we=>we.w),be.head_ids);const ye=ge.inEdges(he)||[];test(ye.map(we=>we.v),be.tail_ids)}function ie(){const ge=[{id:"1",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function se(){const ge=[{id:"1",head_ids:["2","4"],tail_ids:[]},{id:"2",head_ids:["1","3"],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function re(){const ge=[{id:"1",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:[],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:["5"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function _e(){const ge=[{id:"1",head_ids:[],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["4"],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:["5"],tail_ids:[]},{id:"7",head_ids:["6"],tail_ids:[]},{id:"8",head_ids:["10"],tail_ids:[]},{id:"9",head_ids:["8"],tail_ids:[]},{id:"10",head_ids:["9"],tail_ids:[]},{id:"11",head_ids:["12","13"],tail_ids:["12","13"]},{id:"12",head_ids:["11","13"],tail_ids:["11","13"]},{id:"13",head_ids:["12","11"],tail_ids:["12","11"]},{id:"14",head_ids:["14"],tail_ids:["14"]},{id:"15",head_ids:[],tail_ids:["16"]},{id:"16",head_ids:[],tail_ids:[]},{id:"17",head_ids:["16"],tail_ids:[]},{id:"15b",head_ids:[],tail_ids:[]},{id:"16b",head_ids:["15b"],tail_ids:["17b"]},{id:"17b",head_ids:[],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function ae(){const ge=[{id:"4",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["2","1","4","7"],tail_ids:[]},{id:"1",head_ids:["5","6","9"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:[],tail_ids:[]},{id:"7",head_ids:["8"],tail_ids:[]},{id:"8",head_ids:["7"],tail_ids:[]},{id:"9",head_ids:["5"],tail_ids:[]}],he=ne(ge);return{items:ge,graph:he}}function ce(){const ge=[{id:"1",head_ids:["2"],tail_ids:["3"]}],he=ne(ge);return{items:ge,graph:he}}const le=ie(),ue=_e(),de=se(),me=re(),pe=ae(),fe=ce();describe("graph",()=>{oe(le.graph,"0",{item:void 0,head_ids:[],tail_ids:[]}),oe(le.graph,"1",{item:le.items[0],head_ids:[],tail_ids:[]}),oe(ue.graph,"1",{item:ue.items[0],head_ids:[],tail_ids:[]}),oe(ue.graph,"2",{item:ue.items[1],head_ids:["3"],tail_ids:[]}),oe(ue.graph,"3",{item:ue.items[2],head_ids:["4"],tail_ids:["2"]}),oe(ue.graph,"4",{item:ue.items[3],head_ids:[],tail_ids:["3"]}),oe(ue.graph,"5",{item:ue.items[4],head_ids:[],tail_ids:["6"]}),oe(ue.graph,"6",{item:ue.items[5],head_ids:["5"],tail_ids:["7"]}),oe(ue.graph,"7",{item:ue.items[6],head_ids:["6"],tail_ids:[]}),oe(ue.graph,"8",{item:ue.items[7],head_ids:["10"],tail_ids:["9"]}),oe(ue.graph,"9",{item:ue.items[8],head_ids:["8"],tail_ids:["10"]}),oe(ue.graph,"10",{item:ue.items[9],head_ids:["9"],tail_ids:["8"]}),oe(ue.graph,"11",{item:ue.items[10],head_ids:["12","13"],tail_ids:["12","13"]}),oe(ue.graph,"12",{item:ue.items[11],head_ids:["11","13"],tail_ids:["11","13"]}),oe(ue.graph,"13",{item:ue.items[12],head_ids:["11","12"],tail_ids:["11","12"]}),oe(ue.graph,"14",{item:ue.items[13],head_ids:["14"],tail_ids:["14"]}),oe(ue.graph,"15",{item:ue.items[14],head_ids:[],tail_ids:["16"]}),oe(ue.graph,"16",{item:ue.items[15],head_ids:["15"],tail_ids:["17"]}),oe(ue.graph,"17",{item:ue.items[16],head_ids:["16"],tail_ids:[]}),oe(ue.graph,"15b",{item:ue.items[17],head_ids:[],tail_ids:["16b"]}),oe(ue.graph,"16b",{item:ue.items[18],head_ids:["15b"],tail_ids:["17b"]}),oe(ue.graph,"17b",{item:ue.items[19],head_ids:["16b"],tail_ids:[]}),oe(fe.graph,"1",{item:fe.items[0],head_ids:[],tail_ids:[]})}),describe("find_leaf_ids",()=>{test(find_leaf_ids(de.graph),["3","4"]),test(find_leaf_ids(me.graph),["2","3","5"]),test(find_leaf_ids(pe.graph),["5","6"])}),describe("find_leaf_ids_for_id",()=>{test(find_leaf_ids_for_id(pe.graph,"12"),[]),test(find_leaf_ids_for_id(pe.graph,"1"),["5","6"]),test(find_leaf_ids_for_id(pe.graph,"2"),["5","6"]),test(find_leaf_ids_for_id(pe.graph,"7"),[])}),describe("find_leaf_group_ids",()=>{test(find_leaf_group_ids(le),[["1"]]),test(find_leaf_group_ids(de),[["3","2","1"],["4","1","2"]])}),describe("find_all_predecessor_ids",()=>{test(find_all_predecessor_ids(le.graph,"1"),[]),test(find_all_predecessor_ids(de.graph,"1"),["2"]),test(find_all_predecessor_ids(de.graph,"2"),["1"]),test(find_all_predecessor_ids(de.graph,"3"),["2","1"]),test(find_all_predecessor_ids(de.graph,"4"),["1","2"]),test(find_all_predecessor_ids(pe.graph,"2"),["4","3"]),test(find_all_predecessor_ids(pe.graph,"8"),["7","3","2","4"]),test(find_all_predecessor_ids(pe.graph,"5"),["9","1","3","2","4"])})},!1),wcomponent_id=uuid_v4_for_tests(1);function test_helper__make_knowledge_view$1(t,ee,te){const oe={id:ee,foundation_knowledge_view_ids:te?[te]:void 0,wc_id_map:{},title:"",description:"",sort_type:"normal",created_at:new Date("2023-03-22 15:15:00"),base_id:1,goal_ids:[]};return t&&(oe.wc_id_map[wcomponent_id]=t),oe}const run_get_composed_wc_id_maps_object_tests=describe("get_composed_wc_id_maps_object",()=>{const t=new Date("2023-03-22 15:15:00");let ee,te;ee=get_composed_wc_id_maps_object([],{}),te={composed_wc_id_map:{},composed_blocked_wc_id_map:{}},test(ee,te);const ne=[{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, defined in foundation, ",test_description_part2:"should return entry in foundation"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"missing in current, blocked in foundation, ",test_description_part2:"should return entry in blocked"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, missing in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, defined in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, passthrough in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, blocked in foundation, ",test_description_part2:"should return entry in current not foundation and NOT show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, defined in foundation, ",test_description_part2:"should return (passthrough) entry from foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"passthrough entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, missing in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, defined in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"}];ne.forEach(oe=>{const ie=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_foundation_kv,"kv1"),se=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_current_kv,"kv2","kv1");ee=get_composed_wc_id_maps_object([ie,se],{}),test(ee.composed_wc_id_map[wcomponent_id],oe.expected_result_in_composed_wc_id_map,"composed_wc_id_map "+oe.test_description+oe.test_description_part2),test(ee.composed_blocked_wc_id_map[wcomponent_id],oe.expected_result_in_composed_blocked_wc_id_map,"composed_blocked_wc_id_map "+oe.test_description+oe.test_description_part2)}),describe("deleted wcomponent",()=>{ne.forEach(oe=>{const ie=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_foundation_kv,"kv1"),se=test_helper__make_knowledge_view$1(oe.kv_wc_entry_in_current_kv,"kv2","kv1");ee=get_composed_wc_id_maps_object([ie,se],{[wcomponent_id]:{id:wcomponent_id,deleted_at:t,type:"statev2",title:"",description:"",created_at:t,base_id:1}}),test(ee.composed_wc_id_map[wcomponent_id],void 0,"composed_wc_id_map "+oe.test_description+"should not return any entry"),test(ee.composed_blocked_wc_id_map[wcomponent_id],void 0,"composed_blocked_wc_id_map "+oe.test_description+"should not return any entry")})})},!1),test_refresh_bases_for_current_user=describe("refresh_bases_for_current_user",()=>{const t=new Date,ee=new Date,te="123",ne="987",oe={id:1,inserted_at:t,updated_at:ee,owner_user_id:te,public_read:!1,title:"owned by this user",access_level:"owner",can_edit:!0},ie={id:2,inserted_at:t,updated_at:ee,owner_user_id:ne,public_read:!1,title:"editable by this user",access_level:"editor",can_edit:!0},se={id:3,inserted_at:t,updated_at:ee,owner_user_id:ne,public_read:!1,title:"viewable by this user",access_level:"viewer",can_edit:!1},re={id:3,inserted_at:t,updated_at:ee,owner_user_id:ne,public_read:!0,title:"public viewable by this user",access_level:"viewer",can_edit:!1},_e=[oe,ie,se,re];function ae(le){return selector_needs_to_create_a_base({user_info:le})}let ce={user:{id:te},chosen_base_id:void 0,bases_by_id:void 0};test(ae(ce),!1),[oe,ie].forEach(le=>{ce=user_info_reducer({user_info:ce},ACTIONS.user_info.update_bases({bases:[le]})).user_info,test(ce.chosen_base_id,le.id),test(ae(ce),!1)}),ce=user_info_reducer({user_info:ce},ACTIONS.user_info.update_bases({bases:[se,re]})).user_info,test(ce.chosen_base_id,void 0),test(ae(ce),!0),ce=user_info_reducer({user_info:{user:{id:te},chosen_base_id:100,bases_by_id:void 0}},ACTIONS.user_info.update_bases({bases:[se,re]})).user_info,test(ce.chosen_base_id,void 0),test(ae(ce),!0),[oe,ie].forEach(le=>{ce=user_info_reducer({user_info:{user:{id:te},chosen_base_id:100,bases_by_id:void 0}},ACTIONS.user_info.update_bases({bases:[]})).user_info,test(ce.chosen_base_id,void 0),test(ae(ce),!0)}),_e.forEach(({id:le})=>{ce=user_info_reducer({user_info:{user:{id:te},chosen_base_id:le,bases_by_id:void 0}},ACTIONS.user_info.update_bases({bases:_e})).user_info,test(ce.chosen_base_id,le),test(ae(ce),!1)})},!1),regexp_unquoted=/(?:^)([^",\n\r]*),?/g,regexp_quoted=/(?:^)"([^"]+|"")*",?/g,regexp_new_line=/(?:^)([\n\r]+)/g;function csv_to_array(t){const ee=[];let te,ne,oe,ie,se=[],re=!1,_e=!0,ae=2;do{if(re=!1,_e&&(_e=!1,ae=2,se=[],ee.push(se)),te=t.match(regexp_unquoted),ne=t.match(regexp_quoted),ne&&ne.length){ie=ne[0],re=ie.endsWith(",");const ce=(re?ie.slice(1,-2):ie.slice(1,-1)).replace(/""/g,'"');se.push(ce),t=t.slice(ie.length),re||(ae-=1)}else if(te.length){ie=te[0],re=ie.endsWith(",");const ce=re?ie.slice(0,-1):ie;se.push(ce),t=t.slice(ie.length),re||(ae-=1)}oe=t.match(regexp_new_line),!re&&oe&&oe.length&&(_e=!0,ae=2,t=t.slice(oe[0].length)),t===""&&(ae-=1)}while(ae>0);return ee}const test_csv_to_array=describe("csv_to_array",()=>{test(csv_to_array(""),[[""]]),test(csv_to_array(","),[["",""]]),test(csv_to_array("a"),[["a"]]),test(csv_to_array("a,"),[["a",""]]),test(csv_to_array(",a"),[["","a"]]),test(csv_to_array(",a,"),[["","a",""]]),test(csv_to_array("a,a"),[["a","a"]]),test(csv_to_array("a,a,"),[["a","a",""]]),test(csv_to_array(",a,a"),[["","a","a"]]),test(csv_to_array(",a,a,"),[["","a","a",""]]),test(csv_to_array(`
`),[[""],[""]]),test(csv_to_array(`a
a`),[["a"],["a"]]),test(csv_to_array(`,
,`),[["",""],["",""]]),test(csv_to_array(`a,
a,`),[["a",""],["a",""]]),test(csv_to_array(`,a
,a`),[["","a"],["","a"]]),test(csv_to_array(`,a,
,a,`),[["","a",""],["","a",""]]),test(csv_to_array('""'),[[""]]),test(csv_to_array('"",'),[["",""]]),test(csv_to_array(',""'),[["",""]]),test(csv_to_array(',"",'),[["","",""]]),test(csv_to_array('","'),[[","]]),test(csv_to_array('",",'),[[",",""]]),test(csv_to_array(',","'),[["",","]]),test(csv_to_array(',",",'),[["",",",""]]),test(csv_to_array('"",""'),[["",""]]),test(csv_to_array('"a"'),[["a"]]),test(csv_to_array('"a",'),[["a",""]]),test(csv_to_array(',"a"'),[["","a"]]),test(csv_to_array(',"a",'),[["","a",""]]),test(csv_to_array('"a","a"'),[["a","a"]]),test(csv_to_array('"a","a",'),[["a","a",""]]),test(csv_to_array(',"a","a"'),[["","a","a"]]),test(csv_to_array(',"a","a",'),[["","a","a",""]]),test(csv_to_array('""""'),[['"']]),test(csv_to_array('"""",'),[['"',""]]),test(csv_to_array(',""""'),[["",'"']]),test(csv_to_array(',"""",'),[["",'"',""]]),test(csv_to_array('"""a"""'),[['"a"']]),test(csv_to_array('"""a""","""a"""'),[['"a"','"a"']]),test(csv_to_array('""""""'),[['""']]),test(csv_to_array('"a""a"'),[['a"a']]),test(csv_to_array('"a"",""a"'),[['a","a']]),test(csv_to_array(`""
`),[[""],[""]])},!1),test_get_wcomponent_state_value_and_probabilities=describe("get_wcomponent_state_value_and_probabilities",()=>{const t=new Date("2021-05-01 00:00"),ee=new Date("2021-05-01 00:01"),te=new Date("2021-05-01 00:02");function ne(ke,Ae){const $e={};let xe=0;return(ke||[]).forEach(Ce=>{Ae.forEach(Se=>{if(Ce.VAP_set_id!==Se.id)return;const Ie=$e[Se.id]||[];Ie.push({base_id:-1,id:`cf${xe++}`,created_at:ee,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:Se.id,target_VAP_id:Ce.VAP_id}),$e[Se.id]=Ie})}),$e}function oe(ke,Ae,$e){const{counterfactuals_data:xe,datetime:Ce={}}=$e||{},Se=Ae.map((Pe,Re)=>({base_id:-1,id:`vps${Re}`,created_at:ee,version:1,datetime:Ce,entries:Pe}));ke={...ke,values_and_prediction_sets:Se};const Ie=ne(xe,Se);return get_wcomponent_state_value_and_probabilities({wcomponent:ke,VAP_set_id_to_counterfactual_v2_map:Ie,created_at_ms:ee.getTime(),sim_ms:ee.getTime()})}const ie={base_id:-1,id:"",created_at:ee,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]},se={...ie,subtype:"boolean"};let re;const ae={...{id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},id:"VAP100",value:"A100",probability:1,conviction:1},ce={...ae,id:"VAP80",value:"A80",probability:.8},le={...ae,id:"VAP20",value:"A20",probability:.2},ue={...ae,id:"VAP0",value:"A0",probability:0},de={...ae,id:"VAP100c50",value:"A100c50",conviction:.5},me={...ae,id:"VAP100c0",value:"A100c0",conviction:0},pe=[],fe=[ae],ge=[le,ce],he=[ae,ue],be=[ue],ve=[le],ye=[de],we=[me];re=oe(ie,[]),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0},"No VAP (value and prediction) defined"),re=oe(ie,[pe]),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1},"No value defined in VAP (value and prediction)"),re=oe(ie,[fe]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1},"Single with certainty"),re=oe(ie,[ge]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A80",certainty:.8,conviction:1,probability:.8},{parsed_value:"A20",certainty:.2,conviction:1,probability:.2}],any_uncertainty:!0,counterfactual_applied:!1},"Multiple with both uncertain"),re=oe(ie,[he]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1},"Multiple with one uncertain"),re=oe(ie,[fe,fe]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[fe,fe,fe]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[ge,ge]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A80",certainty:.8,conviction:1,probability:.8},{parsed_value:"A20",certainty:.2,conviction:1,probability:.2}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(se,[fe]),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[be]),test(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1},"Should return no value when no chance"),re=oe(se,[be]),test(re,{most_probable_VAP_set_values:[{parsed_value:!1,certainty:0,conviction:1,probability:0}],any_uncertainty:!1,counterfactual_applied:!1},"Should return a value with probability of 0 when no chance of a boolean value"),describe('uncertainty for "boolean" subtype',()=>{re=oe(se,[ve]),test(re,{most_probable_VAP_set_values:[{parsed_value:!1,certainty:.2,conviction:1,probability:.2}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(se,[ye]),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:.5,conviction:.5,probability:1}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(se,[we]),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:0,conviction:0,probability:1}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(se,[fe,we]),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1})}),describe('uncertainty for "other" subtype',()=>{re=oe(ie,[ve]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A20",certainty:.2,conviction:1,probability:.2}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(ie,[ye]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100c50",certainty:.5,conviction:.5,probability:1}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(ie,[we]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100c0",certainty:0,conviction:0,probability:1}],any_uncertainty:!0,counterfactual_applied:!1}),re=oe(ie,[fe,we]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1})}),describe("counterfactuals",()=>{re=oe(ie,[fe],{counterfactuals_data:[{VAP_set_id:"vps0",VAP_id:fe[0].id}]}),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"No op counterfactual is applied to something already with certainty of 1"),re=oe(ie,[[ce]],{counterfactuals_data:[{VAP_set_id:"vps0",VAP_id:ce.id}]}),test(re,{most_probable_VAP_set_values:[{parsed_value:"A80",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP that had certainty of < 1"),re=oe(ie,[[ce,le]],{counterfactuals_data:[{VAP_set_id:"vps0",VAP_id:le.id}]}),test(re,{most_probable_VAP_set_values:[{parsed_value:"A20",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP set with two VAPs that had certainty of < 1"),re=oe(ie,[[ae,ue]],{counterfactuals_data:[{VAP_set_id:"vps0",VAP_id:ue.id}]}),test(re,{most_probable_VAP_set_values:[{parsed_value:"A0",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactuals to force one option possibility over another that was certain"),re=oe(ie,[[ae,ue]]),test.skip(re,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["123"]},"Skipping because counterfactuals version 2 only works to force things to be true, not to be false.  For forcing something to be true, then you can use a StateValue component instead.")}),describe("StateValue replacing VAPSets",()=>{const ke={...ie,_derived__using_value_from_wcomponent_id:"abc123"};re=oe(ke,[[ae]]),test(re,{most_probable_VAP_set_values:[{parsed_value:"A100",certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),describe.skip("TODO fix these another time.  values before, at, after a datetime.min, datetime.value, datetime.max",()=>{re=oe(ie,[[ae]],{datetime:{min:te}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{min:ee}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{min:t}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{value:te}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{value:ee}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{value:t}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{max:te}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{max:ee}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1}),re=oe(ie,[[ae]],{datetime:{max:t}}),test(re,{most_probable_VAP_set_values:[{parsed_value:!0,certainty:1,conviction:1,probability:1}],any_uncertainty:!1,counterfactual_applied:!1})})},!1),run_currency_symbol_functions_tests=describe("currency symbols",()=>{const t=Object.keys(currency_symbol_string_map).join(""),ee=Object.values(currency_symbol_string_map).join("");describe("hide_currency_symbols",()=>{let te="",ne="",oe="";te=`${t}90 ${t} / year`,ne=`${ee}90 ${ee} / year`,oe=hide_currency_symbols(te),test(oe,ne,"Convert currency symbols to ascii strings")}),describe("unhide_currency_symbols",()=>{let te="",ne="",oe="";te=`${ee}90 ${ee} / year`,ne=`${t}90 ${t} / year`,oe=unhide_currency_symbols(te),test(oe,ne,"Converts currency ascii strings back to symbols"),te="Currency_pound90 Currency_pound / year",ne="£90 £ / year",oe=unhide_currency_symbols(te),test(oe,ne,"Copes with Simulation.JS changing capitalisation of unit words")})},!1),test_get_wcomponent_state_UI_value=describe("get_wcomponent_state_UI_value",()=>{const t=new Date("2021-05-01 00:01");function ee(me,pe){const fe={};return me.forEach(ge=>{pe.forEach(he=>{if(ge.VAP_set_id!==he.id)return;const be=fe[he.id]||[];be.push({base_id:-1,id:"",created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:he.id,target_VAP_id:ge.VAP_id}),fe[he.id]=be})}),fe}function te(me,pe,fe){const{counterfactuals_data:ge=[],datetime:he={}}=fe||{},be=pe.map((ye,we)=>({base_id:-1,id:`vps${we}`,created_at:t,version:1,datetime:he,entries:ye}));me={...me,values_and_prediction_sets:be};const ve=ee(ge,be);return get_wcomponent_state_UI_value({wcomponent:me,VAP_set_id_to_counterfactual_v2_map:ve,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const ne={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]};let oe;const se={...{id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},id:"VAP100",value:"A100",probability:1,conviction:1},re={...se,id:"VAP80",value:"A80",probability:.8},_e={...se,id:"VAP20",value:"A20",probability:.2},ae={...se,id:"VAP0",value:"A0",probability:0};({...se},{...se});const ce=[],le=[se],ue=[_e,re],de=[se,ae];describe("Basic tests of get_wcomponent_state_UI_value",()=>{oe=te(ne,[]),test(oe,{values_string:"not defined",is_defined:!1,counterfactual_applied:void 0,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"No VAP (value and prediction) defined"),oe=te(ne,[ce]),test(oe,{values_string:"not defined",is_defined:!1,counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"No value defined in VAP (value and prediction)"),oe=te(ne,[le]),test(oe,{values_string:"A100",is_defined:!0,counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single with certainty"),oe=te(ne,[ue]),test(oe,{values_string:"A80, A20",is_defined:!0,counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"Multiple with both uncertain"),oe=te(ne,[de]),test(oe,{values_string:"A100",is_defined:!0,counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Multiple with one uncertain")}),describe.skip("TODO: implement these other tests",()=>{}),describe("StateValue replacing VAPSets",()=>{const me={...ne,_derived__using_value_from_wcomponent_id:"abc123"};oe=te(me,[[se]]),test(oe,{values_string:"A100",is_defined:!0,counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")})},!1),test_tidy_wcomponent=describe("tidy_wcomponent",()=>{const ee=new Date("2021-05-12"),te=new Date("2021-05-13"),ne={use_creation_context:!1,creation_context:{label_ids:[]}};let oe,ie,se,re,_e={};const ae=-1;oe=prepare_new_wcomponent_object({base_id:ae,type:"statev2",subtype:"other"},ne),oe.values_and_prediction_sets=[{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),id:"vps2",created_at:te,custom_created_at:void 0},{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),id:"vps1",created_at:ee,custom_created_at:void 0}],se=tidy_wcomponent(oe,_e),test(se.values_and_prediction_sets.map(({id:le})=>le),["vps1","vps2"],"",!1),oe=prepare_new_wcomponent_object({base_id:ae,type:"statev2",subtype:"other"},ne),ie=[{...prepare_new_VAP(),id:"VAP1",relative_probability:5},{...prepare_new_VAP(),id:"VAP2",relative_probability:0}],oe.values_and_prediction_sets=[{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),entries:ie}],se=tidy_wcomponent(oe,_e),test(se.values_and_prediction_sets[0].entries.map(({probability:le})=>le),[1,0],"",!1),oe={...oe,subtype:"boolean"},se=tidy_wcomponent(oe,_e),re=se.values_and_prediction_sets[0].entries,test(re.map(({relative_probability:le})=>le),[5,0],"",!1),test(re.map(({probability:le})=>le),[1,0],"",!1),ie=[{...prepare_new_VAP(),id:"VAP1",relative_probability:5,probability:0},{...prepare_new_VAP(),id:"VAP2",relative_probability:0,probability:1}];let ce=[{...prepare_new_VAP_set(VAPsType.undefined,{},[],ae,ne),entries:ie}];oe={...oe,subtype:"boolean",values_and_prediction_sets:ce},se=tidy_wcomponent(oe,_e),re=se.values_and_prediction_sets[0].entries,test(re.map(({relative_probability:le})=>le),[5,0],"",!1),test(re.map(({probability:le})=>le),[0,1],"",!1),describe("Ensuring _derived__using_value_from_wcomponent_id is not saved",()=>{const le=console.error;let ue="";console.error=de=>{ue=de},oe={...oe,_derived__using_value_from_wcomponent_id:"123"},se=tidy_wcomponent(oe,_e),console.error=le,test(ue.length>0,!0,"Should log an error to the console when wcomponent with _derived__using_value_from_wcomponent_id is tidied before attempting to be saved"),test(se._derived__using_value_from_wcomponent_id,void 0,"Should delete wcomponent._derived__using_value_from_wcomponent_id")})},!1),test_get_composed_wcomponents_by_id=describe("get_composed_wcomponents_by_id",()=>{const t=new Date("2023-10-05"),ee=new Date("2023-10-06"),te=new Date("2023-10-07"),ne=uuid_v4_for_tests(1),oe=uuid_v4_for_tests(2),ie=uuid_v4_for_tests(3);let se,re,_e,ae,ce,le;function ue(pe){return prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",...pe})}function de(pe){return prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",...pe})}function me(pe,fe,ge){let he=get_starting_state$1(!1);const be=get_new_knowledge_view_object({base_id:-1,id:ie,title:"Test KV",sort_type:"priority"},{});return he=root_reducer$1(he,ACTIONS.specialised_object.upsert_knowledge_view({knowledge_view:be})),he=root_reducer$1(he,ACTIONS.routing.change_route({args:{view:"knowledge",subview_id:be.id}})),he=root_reducer$1(he,ACTIONS.specialised_object.upsert_wcomponent({wcomponent:pe,add_to_knowledge_view:{id:be.id,position:{left:0,top:0}}})),he=root_reducer$1(he,ACTIONS.specialised_object.upsert_wcomponent({wcomponent:fe,add_to_knowledge_view:{id:be.id,position:{left:300,top:0}}})),ge&&(he=root_reducer$1(he,ACTIONS.routing.change_route({args:{created_at_datetime:ge}}))),he}re=ue({id:oe,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:ee,entries:[],datetime:{}}]}),_e=de({id:ne,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:ee,entries:[],datetime:{}}],attribute_wcomponent_id:re.id}),describe("state_value VAPs should be composed into statev2 wcomponent",()=>{var pe;se=me(re,_e,te),ae=se.derived.composed_wcomponents_by_id,ce=ae[re.id],le=(ce==null?void 0:ce.values_and_prediction_sets)||[],test((pe=le[0])==null?void 0:pe.id,"vps22222","The composed wcomponent should have VAP sets from the state value component that targets it"),test(ce==null?void 0:ce._derived__using_value_from_wcomponent_id,_e.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set to the state_value's ID")}),describe("Components created after current created_at datetime are still present in composed_wcomponents_by_id",()=>{se=me(re,_e,t),ae=se.derived.composed_wcomponents_by_id,test(re.created_at.getTime()>se.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_statev2 wcomponent based on its created_at"),test(_e.created_at.getTime()>se.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_state_value wcomponent based on its created_at"),test(new Set(Object.keys(ae)),new Set([ne,oe]),"derived.composed_wcomponents_by_id should still contain the components when the created_at filter is set to before the created_at of the two components")}),describe("state_value created after statev2 and filtered out by created_at datetime",()=>{var pe;re=ue({id:oe,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:ee,entries:[],datetime:{}}]}),_e=de({id:ne,created_at:te,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:te,entries:[],datetime:{}}],attribute_wcomponent_id:re.id}),se=me(re,_e,ee),ae=se.derived.composed_wcomponents_by_id,ce=ae[re.id],le=(ce==null?void 0:ce.values_and_prediction_sets)||[],test((pe=le[0])==null?void 0:pe.id,"vps1","The composed wcomponent should have VAP sets from the original statev2 component as the state_value that targets it should be filtered out based on created_at time"),test(ce==null?void 0:ce._derived__using_value_from_wcomponent_id,void 0,"The composed wcomponent should NOT have _derived__using_value_from_wcomponent_id set")}),describe("state_value VAPs filtered out by created_at datetime",()=>{re=ue({id:oe,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:ee,entries:[],datetime:{}}]}),_e=de({id:ne,created_at:ee,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:te,entries:[],datetime:{}}],attribute_wcomponent_id:re.id}),se=me(re,_e,ee),ae=se.derived.composed_wcomponents_by_id,ce=ae[re.id],le=(ce==null?void 0:ce.values_and_prediction_sets)||[],test(le.length,0,"The composed wcomponent should have VAP sets from the state_value component that targets it but these VAPs should be filtered out based on created_at time"),test(ce==null?void 0:ce._derived__using_value_from_wcomponent_id,_e.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set")})},!1),run_remove_rich_text_tests=describe("remove_rich_text",()=>{let t,ee,te;t="Something [linked](http://example.com).",ee=remove_rich_text(t),te="Something linked.",test(ee,te,"Should remove links in middle"),t="[Linked](http://example.com) here.",ee=remove_rich_text(t),te="Linked here.",test(ee,te,"Should remove links at start"),t="[Linked](http://example.com) here and [here](https://other.example.com)",ee=remove_rich_text(t),te="Linked here and here",test(ee,te,"Should remove multiple links at start"),t="<auto generated>Text with <auto generated> in it <auto generated>",ee=remove_rich_text(t),te="Text with  in it ",test(ee,te,"Should remove <auto generated> tags"),t="Italicised <i>text<i/>",ee=remove_rich_text(t),te="Italicised text",test(ee,te,"Should remove tags")},!1),run_apply_units_from_component_tests=describe("apply_units_from_component",()=>{let t,ee,te,ne,oe;const ie=uuid_v4_for_tests(1),se=uuid_v4_for_tests(2),_e=prepare_new_contextless_wcomponent_object({base_id:0,id:ie,title:"Some state component",type:"statev2",units:"seconds"});te={[ie]:_e},ee=`@@${ie}`,t="",oe="seconds",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Can access a wcomponent's value and uses its units when no units given by calculation"),ee=`  @@${ie}  `,t="",oe="seconds",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Uses a wcomponent's units, even with surrounding whitespace"),ee=`@@${ie}`,t="Unitless",oe="seconds",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Silently uses a wcomponent's units even when units given by calculation"),ee=`@@${ie} + 1`,t="meters",oe="meters",ne=apply_units_from_component(ee,t,te),test(ne,oe,"Ignores component units if calculation value is not just a @@uuid"),ee=`@@${se}`,t="meters",oe=void 0,ne=apply_units_from_component(ee,t,te),test(ne,oe,"Defaults units to undefined when component can not be found, even if calculation has units given")},!1),run_get_valid_calculation_name_id_tests=describe("get_valid_calculation_name_id",()=>{let t,ee,te,ne;ee=[],t=void 0,te="A",ne=get_valid_calculation_name_id(ee,t),test(ne,te,"Without any other IDs"),ee=["A"],t=void 0,te="B",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With an existing ID of "A"'),ee=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],t=void 0,te="AA",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With existing IDs of "A" up to "Z"'),ee=["A","B"],t="a",te="c",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With existing IDs of "A" and "B", and given a  lower case "a"'),ee=["food"],t="Food",te="Fooe",ne=get_valid_calculation_name_id(ee,t),test(ne,te,'With an existing ID of "food" and given "Food"')},!1),run_make_calculation_safe_for_rich_text_tests=describe("make_calculation_safe_for_rich_text",()=>{let t,ee,te;t="A * B * C",te="A \\* B \\* C",ee=make_calculation_safe_for_rich_text(t),test(ee,te,"Should escape *")},!1),run_get_wcomponent_VAPs_represent_tests=describe("get_wcomponent_VAPs_represent",()=>{const t=uuid_v4_for_tests(1),ee=uuid_v4_for_tests(2);let te,ne,oe,ie,se,re;te=void 0,oe={},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,"Should return undefined for undefined WComponent"),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:void 0}),oe={},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return undefined for WComponent.type of "statev2" and subtype of undefined'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"boolean"}),oe={},ie=void 0,se=VAPsType.boolean,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return boolean for WComponent.type of "statev2" and subtype of boolean'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"number"}),oe={},ie=void 0,se=VAPsType.number,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return number for WComponent.type of "statev2" and subtype of number'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"other"}),oe={},ie=void 0,se=VAPsType.other,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return other for WComponent.type of "statev2" and subtype of other'),describe("state_value",()=>{ne=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"number"}),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:ne.id}),oe={[ne.id]:ne},ie=void 0,se=VAPsType.number,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return number for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of number'),ne=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"boolean"}),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:ne.id}),oe={[ne.id]:ne},ie=void 0,se=VAPsType.boolean,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return boolean for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of boolean'),ne=prepare_new_contextless_wcomponent_object({base_id:-1,type:"statev2",subtype:"other"}),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:ne.id}),oe={[ne.id]:ne},ie=void 0,se=VAPsType.other,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return other for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of other'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"state_value",attribute_wcomponent_id:"some unknown uuid"}),oe={},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return undefined for WComponent.type of "state_value" targeting an unknown stateV2 wcomponent'),describe("protected from recursion",()=>{te=prepare_new_contextless_wcomponent_object({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:t}),oe={[te.id]:te},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return undefined for WComponent.type of "state_value" targeting itself (accidentally)'),ne=prepare_new_contextless_wcomponent_object({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:ee}),te=prepare_new_contextless_wcomponent_object({base_id:-1,id:ee,type:"state_value",attribute_wcomponent_id:t}),oe={[ne.id]:ne,[te.id]:te},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return undefined for two WComponent.type of "state_value" targeting each other with infinite recursion')})}),describe("other types",()=>{te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"action"}),oe={},ie=void 0,se=VAPsType.action,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return action for WComponent.type of "action"'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"process"}),oe={},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return undefined for WComponent.type of "process"'),te=prepare_new_contextless_wcomponent_object({base_id:-1,type:"causal_link"}),oe={},ie=void 0,se=VAPsType.undefined,re=get_wcomponent_VAPs_represent(te,oe,ie),test(re,se,'Should return undefined for WComponent.type of "causal_link"')})},!1),run_specialised_objects_accessors_tests=describe("specialised_objects accessors tests",()=>{describe("get_current_temporal_value_certainty_from_wcomponent",()=>{const t=new Date("2023-10-09"),ee=new Date("2023-10-10");let te,ne,oe,ie;function se(re,_e){const ae=prepare_new_contextless_wcomponent_object({base_id:-1,created_at:t,type:"statev2",values_and_prediction_sets:re}),ce={[ae.id]:ae};return get_current_temporal_value_certainty_from_wcomponent(ae.id,ce,_e)}ne=t.getTime(),oe=se(void 0,ne),ie=void 0,test(oe,ie,"No VAP sets should result in undefined value"),ne=t.getTime(),oe=se([],ne),ie=void 0,test(oe,ie,"Empty VAP sets should result in undefined value"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}],oe=se(te,ne),ie={certainty:void 0,temporal_uncertainty:{}},test(oe,ie,"VAP sets with one VAPset should result in that VAP set's empty datetime being returned"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{value:ee}}],oe=se(te,ne),ie={certainty:void 0,temporal_uncertainty:{value:ee}},test(oe,ie,"VAP sets with one VAPset should result in that VAP set's datetime and value being returned"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:ee,datetime:{},entries:[]}],oe=se(te,ne),ie=void 0,test.skip(oe,ie,"VAP sets with one VAPset created after current created_at should return undefined"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,datetime:{value:ee},entries:[{id:"",description:"",value:"",explanation:"",probability:1,conviction:1}]}],oe=se(te,ne),ie={certainty:1,temporal_uncertainty:{value:ee}},test(oe,ie,"VAP sets with one VAPset with an 100% probable & confident (conviction) entry should be 100% certain"),ne=t.getTime(),te=[{base_id:-1,id:"vps1",created_at:t,datetime:{value:ee},entries:[{id:"",description:"",value:"",explanation:"",probability:.5,conviction:.5},{id:"",description:"",value:"",explanation:"",probability:.9,conviction:.9}]}],oe=se(te,ne),ie={certainty:.81,temporal_uncertainty:{value:ee}},test(oe,ie,"VAP sets with one VAPset with two entries should take highest certainty")})},!1),run_EditableCalculationRow_tests=describe("EditableCalculationRow support functions",()=>{describe("should_show_calc_value",()=>{let t,ee;t="A * B",ee=should_show_calc_value(t),test(ee,!0,"Should return true for A * B"),t="A * B",ee=should_show_calc_value(t),test(ee,!0,"Should return true for A * B when called a second time")})},!1),run_list_function_tests=describe("list functions",()=>{describe("index_is_in_bounds",()=>{test(index_is_in_bounds([],0),!1,"empty list, any number"),test(index_is_in_bounds(["A"],-1),!1,"list with one element, index -1"),test(index_is_in_bounds(["A"],0),!0,"list with one element, index 0"),test(index_is_in_bounds(["A"],1),!1,"list with one element, index 1"),test(index_is_in_bounds(["A","B"],1),!0,"list with two elements, index 1"),test(index_is_in_bounds(["A","B"],2),!1,"list with two elements, index 2")}),describe("swap_elements",()=>{test(swap_elements([],0,0),[],"empty list, any indices, should be noop"),test(swap_elements(["A","B"],-1,0),["A","B"],"invalid first index of -1, should be noop"),test(swap_elements(["A","B"],2,0),["A","B"],"invalid first index of 2, should be noop"),test(swap_elements(["A","B"],0,-1),["A","B"],"invalid second index of -1, should be noop"),test(swap_elements(["A","B"],0,2),["A","B"],"invalid second index of 2, should be noop"),test(swap_elements(["A","B"],0,1),["B","A"],"should swap"),test(swap_elements(["A","B"],1,0),["B","A"],"should swap"),test(swap_elements(["A","B"],1,1),["A","B"],"should handle noop")}),describe("insert_element_at_index",()=>{test(insert_element_at_index([],"A",0),["A"],"insertion works at index 0"),test(insert_element_at_index([],"A",-2),["A"],"insertion works at any negative index"),test(insert_element_at_index([],"A",2),["A"],"insertion works at any positive index"),test(insert_element_at_index(["A","B","C"],"D",0),["D","A","B","C"],"insertion works at index 0"),test(insert_element_at_index(["A","B","C"],"D",-2),["D","A","B","C"],"insertion works at any negative index"),test(insert_element_at_index(["A","B","C"],"D",2),["A","B","D","C"],"insertion works at an positive index that is in the list"),test(insert_element_at_index(["A","B","C"],"D",3),["A","B","C","D"],"insertion works at an positive index that is the length of the list"),test(insert_element_at_index(["A","B","C"],"D",4),["A","B","C","D"],"insertion works at any positive index that is > list length")})},!1),run_get_default_formatting_function_tests=describe("get default formatting function",()=>{const t=[{calc_value:"  81.2  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when valid number with decimal space",expected_result_display_type:NUMBER_DISPLAY_TYPES.simple,test_description__result_display_type:"Should assign simple type when only valid number"},{calc_value:"  1899  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (1899) outside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.simple,test_description__result_display_type:"Should assign simple type when integer number (1899) outside of 1900-2200"},{calc_value:"  1900  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (1900) inside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.bare,test_description__result_display_type:"Should assign simple type when integer number (1900) inside of 1900-2200"},{calc_value:"  2200  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (2200) inside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.bare,test_description__result_display_type:"Should assign simple type when integer number (2200) inside of 1900-2200"},{calc_value:"  2201  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (2201) outside of 1900-2200",expected_result_display_type:NUMBER_DISPLAY_TYPES.simple,test_description__result_display_type:"Should assign simple type when integer number (2201) outside of 1900-2200"},{calc_value:"  81.2 %  ",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:NUMBER_DISPLAY_TYPES.percentage,test_description__result_display_type:"Should assign percentage type when % included with valid number containing spaces and decimal"},{calc_value:"83%",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:NUMBER_DISPLAY_TYPES.percentage,test_description__result_display_type:"Should assign percentage type when % included with simple valid number without spaces or decimal"}];describe("get_default_significant_figures",()=>{let ee;t.forEach(te=>{ee=get_default_significant_figures(te.calc_value),test(ee,te.expected_sig_figs,te.test_description__sig_figs)})}),describe("get_default_result_display_type",()=>{let ee;t.forEach(te=>{ee=get_default_result_display_type(te.calc_value),test(ee,te.expected_result_display_type,te.test_description__result_display_type)})})},!1);function test_helper__make_knowledge_view(t,ee,te){const ne=new Date("2023-03-22 15:15:00");return{id:ee,foundation_knowledge_view_ids:te?[te]:void 0,wc_id_map:t,title:"some title of "+ee,description:"",sort_type:"normal",created_at:ne,base_id:1,goal_ids:[]}}const run_get_wcomponent_status_in_knowledge_view_tests=describe("get_UI_data__wcomponent_add_or_for_knowledge_view",()=>{describe("simple single knowledge view with no foundation",()=>{const t=test_helper__make_knowledge_view({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0}},"kv1"),ee={[t.id]:t},te=get_foundational_knowledge_views(t,ee,!0),ne=get_composed_wc_id_maps_object(te,{}),oe=get_foundational_knowledge_views(t,ee,!1),ie=get_composed_wc_id_maps_object(oe,{});test(ne,{composed_wc_id_map:{wc2:{left:20,top:0}},composed_blocked_wc_id_map:{wc4:{left:40,top:0,blocked:!0}}},"Sanity check (no1) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),test(ie,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}},"Sanity check (no2) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function _e(le,ue){return get_wcomponent_status_in_knowledge_view({editing_allowed:le,wcomponent_id:ue,knowledge_view:t,composed_wc_id_maps_object:ne,foundation_composed_wc_id_map:ie.composed_wc_id_map})}let ae,ce;describe("editing_allowed is true",()=>{ae=_e(!0,"wc1"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent not yet added to knowledge view"),ae=_e(!0,"wc2"),ce={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},test(ae,ce,"with normal wcomponent entry in knowledge view"),ae=_e(!0,"wc3"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent removed from this knowledge view"),ae=_e(!0,"wc4"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},test(ae,ce,"with wcomponent blocked from this knowledge view")}),describe("editing_allowed is false",()=>{ae=_e(!1,"wc1"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent not yet added to knowledge view"),ae=_e(!1,"wc2"),ce={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with normal wcomponent entry in knowledge view"),ae=_e(!1,"wc3"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent removed from this knowledge view"),ae=_e(!1,"wc4"),ce={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ae,ce,"with wcomponent blocked from this knowledge view")})}),describe("knowledge view with single knowledge view foundation",()=>{const t=test_helper__make_knowledge_view({wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222},wc9:{left:90,top:222,passthrough:!0},wc10:{left:100,top:222,passthrough:!0},wc11:{left:110,top:222,passthrough:!0},wc12:{left:120,top:222,passthrough:!0},wc13:{left:130,top:222,blocked:!0},wc14:{left:140,top:222,blocked:!0},wc15:{left:150,top:222,blocked:!0},wc16:{left:160,top:222,blocked:!0}},"kv1"),ee=test_helper__make_knowledge_view({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0},wc6:{left:60,top:0},wc7:{left:70,top:0,passthrough:!0},wc8:{left:80,top:0,blocked:!0},wc10:{left:100,top:0},wc11:{left:110,top:0,passthrough:!0},wc12:{left:120,top:0,blocked:!0},wc14:{left:140,top:0},wc15:{left:150,top:0,passthrough:!0},wc16:{left:160,top:0,blocked:!0}},"kv2",t.id),te={[t.id]:t,[ee.id]:ee},ne=get_foundational_knowledge_views(ee,te,!0),oe=get_composed_wc_id_maps_object(ne,{}),ie=get_foundational_knowledge_views(ee,te,!1),se=get_composed_wc_id_maps_object(ie,{});test(oe,{composed_wc_id_map:{wc2:{left:20,top:0},wc5:{left:50,top:222},wc6:{left:60,top:0},wc7:{left:70,top:222},wc10:{left:100,top:0},wc14:{left:140,top:0}},composed_blocked_wc_id_map:{wc4:{blocked:!0,left:40,top:0},wc8:{blocked:!0,left:80,top:0},wc12:{blocked:!0,left:120,top:0},wc13:{blocked:!0,left:130,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:0}}},"Sanity check (no3) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),test(se,{composed_wc_id_map:{wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222}},composed_blocked_wc_id_map:{wc13:{blocked:!0,left:130,top:222},wc14:{blocked:!0,left:140,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:222}}},"Sanity check (no4) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function ae(ue,de){return get_wcomponent_status_in_knowledge_view({editing_allowed:ue,wcomponent_id:de,knowledge_view:ee,composed_wc_id_maps_object:oe,foundation_composed_wc_id_map:se.composed_wc_id_map})}let ce,le;describe("editing_allowed is true",()=>{describe("with wcomponent not yet added to foundational knowledge view",()=>{ce=ae(!0,"wc1"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc2"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc3"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc4"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with wcomponent blocked from this top/current/child knowledge view")}),describe("with wcomponent added to foundational knowledge view",()=>{ce=ae(!0,"wc5"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc6"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!0,remove_and_block_button_text:"Remove and Block from knowledge view",remove_and_block_button_tooltip:"Remove and Block from showing in current knowledge view (some title of kv2)"},test(ce,le,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc7"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc8"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove block (allow to show through from foundational knowledge view)",remove_button_tooltip:"This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with wcomponent blocked from this top/current/child knowledge view")}),describe("with wcomponent removed from foundational knowledge view",()=>{ce=ae(!0,"wc9"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc10"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc11"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc12"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with wcomponent blocked from this top/current/child knowledge view")}),describe("with wcomponent removed and blocked in foundational knowledge view",()=>{ce=ae(!0,"wc13"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent not yet added to top/current/child knowledge view"),ce=ae(!0,"wc14"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with normal wcomponent entry in top/current/child knowledge view"),ce=ae(!0,"wc15"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"and with wcomponent removed from this top/current/child knowledge view"),ce=ae(!0,"wc16"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},test(ce,le,"and with wcomponent blocked from this top/current/child knowledge view")})}),describe("editing_allowed is false",()=>{describe("with wcomponent not yet added to foundational knowledge view",()=>{ce=ae(!1,"wc1"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent blocked from this knowledge view")}),describe("with wcomponent added to foundational knowledge view",()=>{ce=ae(!1,"wc1"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent blocked from this knowledge view")}),describe("with wcomponent removed from foundational knowledge view",()=>{ce=ae(!1,"wc1"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent blocked from this knowledge view")}),describe("with wcomponent removed and blocked in foundational knowledge view",()=>{ce=ae(!1,"wc1"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent not yet added to knowledge view"),ce=ae(!1,"wc2"),le={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with normal wcomponent entry in knowledge view"),ce=ae(!1,"wc3"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent removed from this knowledge view"),ce=ae(!1,"wc4"),le={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},test(ce,le,"with wcomponent blocked from this knowledge view")})})})},!1),run_parse_value_tests=describe("parse_value",()=>{describe("parse_VAP_value",()=>{let t;describe('VAPsType "number"',()=>{const ee=te=>parse_VAP_value({value:te,id:"",description:"",explanation:"",probability:1,conviction:1},VAPsType.number);t=ee(""),test(t,null,"Should parse empty string as valid but null"),t=ee("   "),test(t,null,"Should parse string of spaces as valid but null"),t=ee("123"),test(t,123,"Should parse valid number"),t=ee("  123  "),test(t,123,"Should parse valid number with whitespace"),t=ee("123abc"),test(Number.isNaN(t),!0,"Should parse number with prepended invalid characters as invalid NaN"),t=ee("abc123"),test(Number.isNaN(t),!0,"Should parse number with appended invalid characters as invalid NaN"),t=ee("123%"),test(t,1.23,"Should parse number with prepended %"),t=ee("123 %"),test(t,1.23,"Should parse number with prepended whitespace %"),t=ee("123%%"),test(Number.isNaN(t),!0,"Should parse number with appended % and further invalid characters as invalid NaN"),t=ee("1e-3%"),test(t,1e-5,"Should parse negative exponent number with appended %"),t=ee(".3 e 2 %"),test(t,.3,"Should parse fractional number with exponent with appended % and interspersed whitespace")})}),describe("is_string_valid_number",()=>{test(is_string_valid_number(""),!0,"empty string is valid number"),test(is_string_valid_number("   "),!0,"string of spaces is valid number"),test(is_string_valid_number("123"),!0,"valid number"),test(is_string_valid_number("  123  "),!0,"valid number with whitespace"),test(is_string_valid_number("123abc"),!1,"number with prepended invalid characters"),test(is_string_valid_number("abc123"),!1,"number with appended invalid characters"),test(is_string_valid_number("123%"),!0,"number with prepended % (valid)"),test(is_string_valid_number("123 %"),!0,"number with prepended whitespace % (valid)"),test(is_string_valid_number("123%%"),!1,"number with appended % and further invalid characters"),test(is_string_valid_number("1e-3%"),!0,"negative exponent number with appended % (valid)"),test(is_string_valid_number(".3 e 2 %"),!0,"fractional number with exponent with appended % and interspersed whitespace (valid)")})},!1);function run_all_tests(){run_get_rich_text_tests(),run_remove_rich_text_tests(),run_replace_calculations_with_results_tests(),run_replace_normal_ids_tests(),test_get_ids_from_text(),run_get_plain_calculation_object_from_str_tests(),run_add_newlines_to_markdown_tests(),run_parse_calculation_equations_tests(),run_normalise_calculation_numbers_tests(),run_normalise_calculation_ids_tests(),run_apply_units_from_component_tests(),run_perform_calculations_test(),run_number_to_significant_figures_test(),run_number_to_string_test(),run_convert_percentages_tests(),run_currency_symbol_functions_tests(),run_get_valid_calculation_name_id_tests(),run_make_calculation_safe_for_rich_text_tests(),run_get_wcomponent_VAPs_represent_tests(),run_specialised_objects_accessors_tests(),run_EditableCalculationRow_tests(),run_list_function_tests(),run_get_default_formatting_function_tests(),run_get_composed_wc_id_maps_object_tests(),run_get_wcomponent_status_in_knowledge_view_tests(),run_parse_value_tests(),test_get_calculation_strs_from_text(),test_calculate_new_zoom_xy(),test_get_angle(),test_correct_datetime_for_local_time_zone(),test_handle_on_blur(),test_calc_ids_to_move_and_conflicts_functions(),test_cloneable_generator_factory(),test_get_actions_parent_ids(),test_graph_related_functions(),test_get_tense_of_uncertain_datetime(),test_partition_sorted_items_by_datetimes(),test_sort_by_uncertain_event_datetimes(),test_partition_items_by_created_at_datetime(),test_calc_new_counterfactual_state(),test_calc_if_wcomponent_should_exclude_because_label_or_type(),test_merge_routing_state(),test_routing_state_to_string(),test_tidy_wcomponent(),test_merge_knowledge_views(),test_merge_wcomponent(),test_refresh_bases_for_current_user(),test_array_functions(),test_binary_search_functions(),test_csv_to_array(),test_prepare_new_VAP_set(),test_update_VAPSets_with_possibilities(),test_default_possible_values(),test_get_possibilities_from_VAP_sets(),test_get_wcomponent_state_value_and_probabilities(),test_get_wcomponent_state_UI_value(),test_get_composed_wcomponents_by_id()}function setup_tests_for_browser(){window.run_tests=run_all_tests}const map_state$6=t=>({display_side_panel:t.controls.display_side_panel,animate_connections:t.display_options.animate_connections,network_functional:t.sync.network_functional,network_function_last_checked:t.sync.network_function_last_checked}),connector$6=connect(map_state$6);function App(t){return p$1(()=>{t.network_functional||setTimeout(()=>check_and_handle_connection_and_session(get_store()),1e3)},[t.network_functional,t.network_function_last_checked]),o$1(StyledEngineProvider,{injectFirst:!0,children:o$1(ThemeProvider,{theme:DefaultTheme,children:[o$1(CssBaseline,{}),o$1(StyledApp,{...t})]})})}const App$1=connector$6(App);function StyledApp(t){const ee=use_styles();return o$1(k$1,{children:[!t.network_functional&&o$1(Modal,{title:"",size:"small",child:o$1(Box,{children:[o$1(Typography,{id:"modal-modal-title",variant:"h6",component:"h2",children:"Reconnecting..."}),o$1(Typography,{id:"modal-modal-description",sx:{mt:2},children:["Last attempt: ",date_to_string({date:t.network_function_last_checked,time_resolution:"second"})]})]})}),o$1(Box,{id:"app",className:ee.root,children:[o$1(AppBar,{elevation:1,id:"header",position:"fixed",className:"app_header "+ee.app_bar,children:o$1(Toolbar,{variant:"dense",className:ee.toolbar,children:[o$1(Box,{className:`${ee.toolbar_section} ${ee.grow} ${ee.small_full_width}`,children:[o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(ViewOptions,{})}),o$1(Box,{className:`${ee.toolbar_item} ${ee.grow}`,children:o$1(ViewsBreadcrumb,{})})]}),o$1(Box,{className:`${ee.toolbar_section} ${ee.small_full_width}`,justifyContent:"flex-end",children:[o$1(Box,{className:`${ee.toolbar_item}`,children:[o$1(ActiveCreatedAtFilterWarning,{}),o$1(ActiveFilterWarning,{}),o$1(ActiveCreationContextWarning,{})]}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(ActiveUserWidget,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(SyncInfo,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(StorageInfo,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(UserInfo,{})}),o$1(Box,{className:`${ee.toolbar_item}`,children:o$1(SidePanelOrMenuButton,{})})]})]})}),o$1(Box,{id:"app_content",component:"div",className:clsx(ee.content,{[ee.content_with_open_side_panel]:t.display_side_panel,animate_connections:t.animate_connections}),children:o$1(MainAreaRouter,{})}),o$1(Drawer,{anchor:"right",className:ee.drawer,open:t.display_side_panel,variant:"persistent",children:o$1(Box,{component:"aside",className:ee.side_panel,id:"side_panel",children:o$1(Box,{id:"side_panel_content",className:ee.side_panel_content,children:[o$1(AppMenuItemsContainer,{}),o$1(SidePanel,{})]})})}),o$1(Box,{className:ee.help_popup,children:o$1(HelpMenu,{})})]})]})}const use_styles=makeStyles(t=>({root:{width:"100%",height:"100%",overflow:"hidden",display:"flex"},app_bar:{transition:t.transitions.create(["all"],{easing:t.transitions.easing.sharp,duration:t.transitions.duration.leavingScreen}),zIndex:t.zIndex.drawer+1},app_bar_with_open_side_panel:{},content:{width:"100%",flexGrow:1,display:"flex",marginRight:-SIDE_PANEL_WIDTH,transition:t.transitions.create(["margin"],{easing:t.transitions.easing.sharp,duration:t.transitions.duration.leavingScreen})},content_with_open_side_panel:{marginRight:0,transition:t.transitions.create(["margin"],{easing:t.transitions.easing.easeOut,duration:t.transitions.duration.enteringScreen})},drawer:{width:SIDE_PANEL_WIDTH,flexShrink:0},side_panel:{backgroundColor:t.palette.background.paper,width:SIDE_PANEL_WIDTH,position:"relative",paddingTop:50},side_panel_content:{marginTop:10,padding:10},sidebar_toolbar:{flexGrow:1,justifyContent:"flex-end"},toolbar:{flexGrow:1,justifyContent:"space-between",flexWrap:"wrap",[t.breakpoints.up("md")]:{flexWrap:"nowrap"}},toolbar_section:{display:"inherit",flexGrow:0,flexShrink:1,flexBasis:"auto",marginRight:5,"&:last-child":{marginRight:0},"&:empty":{display:"none"}},toolbar_item:{marginRight:5,"&:last-child":{marginRight:0}},help_popup:{position:"relative",zIndex:t.zIndex.drawer+1},small_full_width:{[t.breakpoints.down("md")]:{flexGrow:0,flexShrink:1,flexBasis:"100%",margin:0}},grow:{flexGrow:1},hide:{display:"none"},warning_icon:{color:t.palette.warning.main}}));setup_tests_for_browser();const probabilities=[{min:0,max:0,lambda:.2,k:.4,reverse:!1,text:"No chance"},{min:0,max:5,lambda:.2,k:.4,reverse:!1,text:"Remote chance"},{min:5,max:20,lambda:.5,k:2.8,reverse:!1,text:"Highly unlikely"},{min:20,max:35,lambda:1.5,k:1.9,reverse:!1,text:"Unlikely"},{min:35,max:50,lambda:1.8,k:3.3,reverse:!1,text:"Realistic probability"},{min:50,max:75,lambda:1.8,k:2.6,reverse:!0,text:"Likely or probable"},{min:75,max:95,lambda:1.1,k:1.6,reverse:!0,text:"Highly likely"},{min:95,max:100,lambda:.2,k:.4,reverse:!0,text:"Almost certain"},{min:100,max:100,lambda:.2,k:.4,reverse:!0,text:"Certain"}].map(t=>({...t,mean:Math.round((t.max+t.min)/2)})).map(t=>Object.freeze(t)),probabilities_plus_anchors=probabilities.map(({mean:t})=>t).concat([25,50,75]).sort((t,ee)=>t<ee?-1:1);function probability_is_in_range(t){const{min:ee,max:te,probability:ne}=t;return ee<=ne&&(ne<te||ne===0&&te===0||ne===100&&ee===100)}function get_probability_option(t){return probabilities.find(({min:ee,max:te})=>probability_is_in_range({min:ee,max:te,probability:t}))}function ProbablitySelection(t){const{probability:ee,set_probability:te}=t;return o$1("div",{children:[o$1("input",{type:"range",min:0,max:100,value:ee,onChange:ne=>te(parseFloat(ne.currentTarget.value)),list:"tickmarks_probability"}),o$1("datalist",{id:"tickmarks_probability",children:probabilities_plus_anchors.map(ne=>o$1("option",{value:ne,children:ne}))}),probabilities.map(({text:ne,min:oe,max:ie,mean:se})=>{const re=probability_is_in_range({min:oe,max:ie,probability:ee});return o$1("span",{style:{backgroundColor:re?"blue":"",color:re?"white":"",border:"thin solid #aaa",borderRadius:3,margin:"2px 4px",padding:"2px 4px",cursor:"pointer"},onClick:()=>te(se),children:[" ",ne," "]})})]})}function ProbabilityGraph(t){const{calc_x:ee,reverse:te,size:ne=400}=t,oe=.02,ie=4,se=ne/ie,re=ie/oe,_e=ce=>te?ne-ce:ce,ae=Array.from(Array(re)).map((ce,le)=>le*oe).map(ce=>({x1:_e(ce*se),y1:ne-ee(ce),x2:_e((ce+oe)*se),y2:ne-ee(ce+oe)}));return o$1("svg",{width:ne+1,height:ne,style:{margin:5},children:[o$1("line",{x1:1,y1:ne,x2:1,y2:0,stroke:"black"}),Array.from(Array(9)).map((ce,le)=>{const ue=ne*((le+1)/10);return o$1("line",{x1:ue,y1:ne,x2:ue,y2:0,stroke:"#bbb"})}),o$1("line",{x1:ne*.5,y1:ne,x2:ne*.5,y2:0,stroke:"#555"}),o$1("line",{x1:ne,y1:ne,x2:ne,y2:0,stroke:"black"}),o$1("g",{children:ae.map(({x1:ce,y1:le,x2:ue,y2:de})=>o$1("line",{x1:ce,y1:le,x2:ue,y2:de,stroke:"black"}))})]})}function factory_scaled_weibull(t){const{lambda:ee,k:te,scale:ne}=t;return oe=>te/ee*(oe/ee)**(te-1)*Math.exp(-((oe/ee)**te))*ne}const PredictionsGraph="";function WeibullGraphMaker(){const[t,ee]=h$1(1),[te,ne]=h$1(1),[oe,ie]=h$1(1),[se,re]=h$1(!1);function _e(le){ee(le);const ue=get_probability_option(le);ue&&(ne(ue.lambda),ie(ue.k),re(ue.reverse))}const ae=100,ce=factory_scaled_weibull({lambda:te,k:oe,scale:ae});return o$1("div",{children:["Probability: ",t,"%",o$1(ProbabilityGraph,{calc_x:ce,size:ae*4,reverse:se}),o$1("br",{}),o$1(ProbablitySelection,{probability:t,set_probability:_e}),o$1("br",{}),o$1("br",{}),"Lambda: ",te,o$1("input",{type:"range",value:te,max:10,step:.1,onChange:le=>ne(parseFloat(le.currentTarget.value.slice(0,4)))}),"k: ",oe,o$1("input",{type:"range",value:oe,max:10,step:.1,onChange:le=>ie(parseFloat(le.currentTarget.value.slice(0,4)))}),o$1("br",{}),o$1("hr",{}),o$1("br",{})]})}function DemoPredictionsGraph(){return o$1(WeibullGraphMaker,{})}function DemoPredictionsBadge(){const[t,ee]=h$1(1),[te,ne]=h$1(1),[oe,ie]=h$1(50),[se,re]=h$1(void 0),[_e,ae]=h$1(void 0);function ce(le){re(le.probability),ae(le.conviction)}return o$1("div",{children:[o$1("br",{}),"   ",o$1(PredictionBadge,{size:oe,probability:t/100,conviction:te/100,counterfactual_probability:se,counterfactual_conviction:_e,set_counterfactual:ce}),o$1("br",{}),o$1("br",{}),"Probability: ",t,"%",o$1(ProbablitySelection,{probability:t,set_probability:ee}),o$1("br",{}),"Confidence: ",te,"%",o$1(ProbablitySelection,{probability:te,set_probability:ne}),o$1("br",{}),"Size: ",oe,o$1("input",{type:"range",min:1,max:100,value:oe,onChange:le=>ie(parseInt(le.currentTarget.value,10))})]})}const SandBox$1="";function SandBox(){return o$1("div",{children:"..."})}const map_state$5=t=>({editing:!t.display_options.consumption_formatting}),map_dispatch={toggle_consumption_formatting:ACTIONS.display.toggle_consumption_formatting},connector$5=connect(map_state$5,map_dispatch);function _SandboxEditableCustomDateTime(t){const ee=get_today_str(),[te,ne]=h$1(new Date(ee));return p$1(()=>{t.editing||t.toggle_consumption_formatting({})},[]),o$1("div",{children:["EditableCustomDateTime",o$1(EditableCustomDateTime,{value:te,on_change:oe=>oe&&ne(oe)})]})}const SandboxEditableCustomDateTime=connector$5(_SandboxEditableCustomDateTime),map_state$4=(t,{judgement:ee})=>{const te=ee.judgement_target_wcomponent_id,ne=t.specialised_objects.wcomponents_by_id[te];return{wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_views_by_id:t.specialised_objects.knowledge_views_by_id,target_wcomponent:ne,wc_id_to_counterfactuals_map:get_wc_id_to_counterfactuals_v2_map$1(t)}},connector$4=connect(map_state$4),_ProjectJudgementEntry=t=>{var ce;if(!t.target_wcomponent)return o$1("div",{children:["Can not find judgement's target wcomponent of id: ",t.judgement.judgement_target_wcomponent_id]});const{knowledge_view:ee,judgement:te,target_wcomponent:ne,wc_id_to_counterfactuals_map:oe,wcomponents_by_id:ie,knowledge_views_by_id:se,created_at_ms:re,sim_ms:_e}=t,ae=oe&&((ce=oe[ne.id])==null?void 0:ce.VAP_sets);return o$1("div",{style:{display:"flex",flexDirection:"row",flexBasis:"100",padding:"3px 5px",margin:2,borderBottom:"thin solid #aaa"},children:[o$1("div",{style:{flex:"5",cursor:"pointer"},onClick:()=>{const le=ne.id,ue=get_url_for_wcomponent({knowledge_view:ee,wcomponent_id:le});window.location.href=ue},children:o$1(RichMarkDown,{text:get_title$1({wcomponents_by_id:ie,knowledge_views_by_id:se,wcomponent:ne,wc_id_to_counterfactuals_map:oe,created_at_ms:re,sim_ms:_e})})}),o$1("div",{style:{flex:"1",textAlign:"right"},children:get_wcomponent_state_UI_value({wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:ae,created_at_ms:re,sim_ms:_e}).values_string}),o$1("div",{style:{flex:"1"},children:[" ",te.judgement_operator," ",te.judgement_comparator_value]}),o$1("a",{style:{flex:"4",cursor:"pointer",display:"flex",textDecoration:"inherit",color:"inherit"},href:(()=>{const le=te.id;return get_url_for_wcomponent({knowledge_view:ee,wcomponent_id:le})})(),children:[o$1(JudgementBadge,{judgement:calculate_judgement_value({judgement_wcomponent:te,target_wcomponent:ne,VAP_set_id_to_counterfactual_v2_map:ae,created_at_ms:re,sim_ms:_e}),judgement_trend_manual:te.judgement_trend_manual,size:"medium"}),o$1(RichMarkDown,{text:get_title$1({wcomponents_by_id:ie,knowledge_views_by_id:se,wcomponent:te,wc_id_to_counterfactuals_map:void 0,created_at_ms:re,sim_ms:_e})})]})]})},ProjectJudgementEntry=connector$4(_ProjectJudgementEntry);function get_url_for_wcomponent(t){const ee=t.knowledge_view.wc_id_map[t.wcomponent_id],te=lefttop_to_xy({...ee,zoom:100},!0),ne=te&&te.x||0,oe=te&&te.y||0;return`/app${format_wcomponent_url("",t.wcomponent_id)}&x=${ne}&y=${oe}&zoom=100&view=knowledge&subview_id=${t.knowledge_view.id}`}const map_state$3=(t,{knowledge_view_id:ee})=>({judgements:t.derived.wcomponent_ids_by_type.judgement,wcomponents_by_id:t.specialised_objects.wcomponents_by_id,knowledge_view:t.specialised_objects.knowledge_views_by_id[ee]}),connector$3=connect(map_state$3),_ProjectDashboard=t=>{const{knowledge_view:ee}=t;if(!ee)return o$1("div",{children:["Can not find Knowledge view of id: ",t.knowledge_view_id]});const ne=Object.keys(ee.wc_id_map).filter(ie=>t.judgements.has(ie)).map(ie=>t.wcomponents_by_id[ie]).filter(ie=>!!ie).sort((ie,se)=>ie.judgement_target_wcomponent_id<se.judgement_target_wcomponent_id?-1:ie.judgement_target_wcomponent_id>se.judgement_target_wcomponent_id?1:0),oe=new Date().getTime();return o$1("div",{style:{display:"flex",flexDirection:"column"},children:ne.map(ie=>o$1(ProjectJudgementEntry,{knowledge_view:ee,judgement:ie,created_at_ms:oe,sim_ms:oe}))})},ProjectDashboard=connector$3(_ProjectDashboard),map_state$2=t=>({knowledge_views:t.derived.knowledge_views}),connector$2=connect(map_state$2),_DemoProjectDashboard=t=>{const[ee,te]=h$1(void 0);return o$1("div",{children:["DemoProjectDashboard",t.knowledge_views.map(ne=>o$1("div",{onClick:()=>te(ne.id),style:{fontWeight:ne.id===ee?"bold":"initial",cursor:"pointer"},children:ne.title})),ee&&o$1("div",{children:[o$1("hr",{}),o$1(ProjectDashboard,{knowledge_view_id:ee})]})]})},DemoProjectDashboard=connector$2(_DemoProjectDashboard);function sandbox_code(){const t=new Date("2021-01-01"),ee={use_creation_context:!0,creation_context:{custom_created_at:t,label_ids:[]}},te=prepare_new_VAP_set(VAPsType.undefined,{},[],-1,ee);te.entries[0].value="thing",te.entries[0].probability=.6,te.shared_entry_values={conviction:.4};const ne={type:"statev2",subtype:"boolean",id:"wc11",created_at:t,base_id:-1,title:"wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title wc11 title ",description:"wc11 description",values_and_prediction_sets:[te]},oe={type:"judgement",id:"wc12",created_at:t,base_id:-1,title:"wc12 title",description:"wc12 description",judgement_target_wcomponent_id:ne.id,judgement_operator:"==",judgement_comparator_value:"True"},ie={...oe,id:"wc13",judgement_operator:"!="},se=prepare_new_VAP_set(VAPsType.undefined,{},[],-1,ee);se.entries[0].probability=0;const re={...ne,id:"wc14",created_at:t,base_id:-1,title:"wc14 title ${value}",description:"wc14 description",values_and_prediction_sets:[se]},_e=[ne,oe,ie,re],ae={id:"kv10",title:"kv10 title",description:"kv10 description",wc_id_map:{[ne.id]:{left:400,top:100},[re.id]:{left:700,top:100}},created_at:t,base_id:-1,goal_ids:[],sort_type:"normal"};return{wcomponents:_e,wc11:ne,kv10:ae}}function SandboxWComponentCanvasNode(){const{wcomponents:t,wc11:ee,kv10:te}=sandbox_code();let ne=get_starting_state$1(!1);ne={...ne,routing:{route:"wcomponents",sub_route:null,item_id:ee.id,args:{...ne.routing.args,view:"knowledge",subview_id:te.id}}};const oe=get_store({load_state_from_storage:!1,override_preloaded_state:ne});return oe.dispatch(ACTIONS.specialised_object.replace_all_specialised_objects({specialised_objects:{wcomponents:t,knowledge_views:[te]}})),o$1(Provider,{store:oe,children:o$1(WComponentCanvasNodes,{wcomponents:t})})}const map_state$1=t=>({rich_text_formatting:t.display_options.consumption_formatting}),connector$1=connect(map_state$1);function _WComponentCanvasNodes(t){return o$1("div",{children:["WComponentCanvasNodes ",""+t.rich_text_formatting,t.wcomponents.map(({id:ee})=>o$1(WComponentCanvasNode,{id:ee}))]})}const WComponentCanvasNodes=connector$1(_WComponentCanvasNodes),map_state=t=>({}),connector=connect(map_state);function _SandBoxConnected(t){const[ee,te]=h$1("testing 123");return o$1("div",{children:o$1(EditableTextSingleLine,{placeholder:"1",force_focus_on_first_render:!0,value:ee,on_blur:te,on_blur_type:EditableTextOnBlurType.conditional})})}const SandBoxConnected=connector(_SandBoxConnected);let is_supabase_recovery_email=document.location.hash.includes("type=recovery");const supabase=get_supabase(),supabase_auth_state_change={subscribers:[]};supabase.auth.onAuthStateChange(()=>{supabase_auth_state_change.subscribers.forEach(t=>t())});window.supabase=supabase;function SandBoxSupabase(){const[t,ee]=h$1(supabase.auth.user()),[te,ne]=h$1(""),[oe,ie]=h$1(""),[se,re]=h$1(null),[_e,ae]=h$1(!1),[ce,le]=h$1(!1),[ue,de]=h$1(is_supabase_recovery_email),[me,pe]=h$1(!1),[fe,ge]=h$1(null),[he,be]=h$1(void 0),[ve,ye]=h$1(void 0);p$1(()=>{var Te;if(!he)return ye(void 0);if(!ve||!he.find(({id:Ee})=>Ee===ve))return ye((Te=he.filter(Ee=>Ee.owner_user_id===(t==null?void 0:t.id))[0])==null?void 0:Te.id)},[he]);const we=he==null?void 0:he.find(({id:Te})=>Te===ve),[ke,Ae]=h$1({}),[$e,xe]=h$1(void 0),Ce=Te=>{xe(Te&&sort_list(Te,Ee=>Ee.inserted_at.getTime(),SortDirection.ascending))};p$1(()=>{ve?get_access_controls({base_id:ve,set_postgrest_error:ge,set_access_controls:Ce}):Ce(void 0)},[ve]);const[Se,Ie]=h$1(void 0),Pe=Se&&Se[0],Re=!!t&&t.id===(we==null?void 0:we.owner_user_id);p$1(()=>{const Te=async()=>{const Be=supabase.auth.user();ee(Be),ne((Be==null?void 0:Be.email)||te);const{data:ze,error:Ut}=await supabase.from("users").select("*");ge(Ut);const Xe={};(ze||[]).forEach(Qe=>Xe[Qe.id]=Qe),Ae(Xe)};return Te(),supabase_auth_state_change.subscribers.push(Te),()=>{const{subscribers:Be}=supabase_auth_state_change;supabase_auth_state_change.subscribers=Be.filter(ze=>ze!==Te)}},[]);async function De(){pe(!0);const{user:Te,error:Ee}=await supabase.auth.signUp({email:te,password:oe});pe(!1),re(Ee),ae(!0)}async function Ve(){pe(!0);const{user:Te,error:Ee}=await supabase.auth.signIn({email:te,password:oe});pe(!1),re(Ee),ee(Te)}async function Le(){pe(!0);const{data:Te,error:Ee}=await supabase.auth.api.resetPasswordForEmail(te);pe(!1),re(Ee),le(!Ee)}async function je(){const Te=t==null?void 0:t.email;pe(!0);const Ee=await supabase.auth.update({email:Te,password:oe});pe(!1),re(Ee.error),ee(Ee.user),de(!!Ee.error),is_supabase_recovery_email=!1}async function He(){pe(!0);const{error:Te}=await supabase.auth.signOut();pe(!1),re(Te),ee(supabase.auth.user()),ie("")}const Ye="d9e6dde1-15e7-4bdf-a6ca-3cc769c131ee";if(ce)return o$1("div",{children:[o$1("h3",{children:"Password reset"}),o$1("br",{}),!se&&"Please check your email",o$1(DisplaySupabaseSessionError,{error:se})]});if(!t||ue)return o$1("div",{children:[ue?"Reset password":"Signin / Register",o$1("br",{}),o$1("form",{children:[o$1("input",{type:"email",placeholder:"email",value:te,disabled:ue,onKeyUp:Te=>ne(Te.currentTarget.value),onChange:Te=>ne(Te.currentTarget.value),onBlur:Te=>ne(Te.currentTarget.value)}),o$1("br",{}),o$1("input",{type:"password",placeholder:"password",value:oe,onKeyUp:Te=>ie(Te.currentTarget.value),onChange:Te=>ie(Te.currentTarget.value),onBlur:Te=>ie(Te.currentTarget.value)}),o$1("br",{})]}),ue&&o$1("div",{children:[me&&o$1(default_1$5,{className:"animate spinning"}),o$1("input",{type:"button",value:"Update password",disabled:me||!(t!=null&&t.email)||!oe,onClick:je}),o$1("br",{}),!is_supabase_recovery_email&&o$1("input",{type:"button",onClick:()=>de(!1),value:"Cancel"}),o$1("br",{})]}),!ue&&o$1("div",{children:[me&&o$1(default_1$5,{className:"animate spinning"}),o$1("input",{type:"button",value:"Signin",disabled:me||!te||!oe,onClick:Ve}),o$1("input",{type:"button",value:"Register",disabled:me||!te||!oe,onClick:De}),o$1("br",{}),o$1("input",{type:"button",value:"Forgot password?",disabled:me||!te,onClick:Le}),o$1("br",{})]}),o$1(DisplaySupabaseSessionError,{error:se})]});if(_e)return o$1("div",{children:[o$1("h3",{children:"Registered"}),o$1("br",{}),"Please check your email"]});const Ue=t.id;return o$1("div",{children:["Logged in with ",t.email," ",t.id,o$1("br",{}),me&&o$1(default_1$5,{className:"animate spinning"}),o$1("input",{type:"button",value:"Log out",disabled:me,onClick:He}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>de(!0),value:"Change password"}),o$1("br",{}),o$1(Username,{user:t,users_by_id:ke,set_postgrest_error:ge}),o$1("br",{}),o$1(DisplaySupabaseSessionError,{error:se}),o$1("br",{}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>get_all_bases2({set_postgrest_error:ge,set_bases:be,user_id:Ue}),value:"Get all bases"}),o$1("input",{type:"button",onClick:()=>get_or_create_an_owned_base({user_id:Ue,set_postgrest_error:ge,set_current_base_id:ye}),value:"Get a base (optionally create)"}),o$1("br",{}),o$1("br",{}),o$1(DisplaySupabasePostgrestError,{error:fe}),o$1("h3",{children:"Bases"}),o$1("br",{}),he&&o$1("div",{children:[he.length," bases ",o$1("br",{}),he.map(Te=>{const{access_level:Ee}=Te,Be=Ee==="editor"?"Editor":Ee==="viewer"?"Viewer":Te.public_read?"Viewer (public access)":"?";return o$1("div",{style:{fontWeight:Te.id===(we==null?void 0:we.id)?"bold":void 0},children:[o$1("input",{type:"radio",checked:Te.id===(we==null?void 0:we.id),onClick:()=>ye(Te.id)}),"  ",Te.public_read?"Public":"Private","   title: ",Te.title,"   owned by: ",get_user_name_for_display({users_by_id:ke,current_user_id:Ue,other_user_id:Te.owner_user_id}),"   id: ",Te.id,"  ",Te.owner_user_id!==t.id&&o$1("span",{children:["access: ",Be,"  "]})]})})]}),we&&o$1("div",{children:[o$1("hr",{}),o$1("br",{}),o$1("h3",{children:"Base modification"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Te={...we,title:"Title changed"};modify_base_wrapper({base:Te,set_postgrest_error:ge,set_bases:be,user_id:Ue})},value:"Modify base (change title)"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Te={...we,title:"Primary"};modify_base_wrapper({base:Te,set_postgrest_error:ge,set_bases:be,user_id:Ue})},value:"Modify base (reset title)"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Te={...we,owner_user_id:Ye};modify_base_wrapper({base:Te,set_postgrest_error:ge,set_bases:be,user_id:Ue})},value:"Modify base (change owner to user_1 -- should FAIL if different user)"}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>{const Te={...we,public_read:!we.public_read};modify_base_wrapper({base:Te,set_postgrest_error:ge,set_bases:be,user_id:Ue})},value:"Modify base (toggle public read)"}),o$1("br",{})]}),we&&ve&&o$1("div",{children:[o$1("hr",{}),o$1("br",{}),o$1("h3",{children:"Base sharing"}),o$1("br",{}),we.public_read?"Is PUBLIC":"Is private (not public)",o$1("br",{}),o$1("br",{}),o$1("input",{type:"button",onClick:()=>get_access_controls({base_id:ve,set_postgrest_error:ge,set_access_controls:Ce}),value:"Refresh sharing info"}),o$1("br",{}),$e&&o$1("div",{children:[$e.length," access controls",$e.map(Te=>o$1("div",{children:o$1(AccessControlEntry,{access_control:Te,base_id:ve,users_by_id:ke,current_user_id:t==null?void 0:t.id,is_owner:Re,on_update:Ee=>on_update_access_control({base_id:ve,res:Ee,set_postgrest_error:ge,set_access_controls:Ce})})})),o$1("br",{}),"Id or email address of user's account:",o$1(AddAccessControlEntry,{base_id:ve,on_add_or_exit:Te=>{Te&&get_access_controls({base_id:ve,set_postgrest_error:ge,set_access_controls:Ce})}})]})]}),ve!==void 0&&o$1("div",{children:[o$1("hr",{}),o$1("br",{}),o$1("h3",{children:"Knowledge Views"}),o$1("br",{}),o$1("input",{type:"button",onClick:async()=>{const{error:Te,items:Ee}=await supabase_get_knowledge_views({supabase,base_id:ve});ge(Te||null),Ie(Ee)},value:`Get knowledge views for base ${ve}`}),o$1("input",{type:"button",onClick:async()=>{const{error:Te,items:Ee}=await supabase_get_knowledge_views({supabase,all_bases:!0});ge(Te||null),Ie(Ee)},value:"Get all knowledge views"}),o$1("input",{type:"button",onClick:()=>create_knowledge_views({base_id:ve,set_postgrest_error:ge,set_knowledge_views:Ie}),value:`Create knowledge view in base ${ve}`})]}),Se&&o$1("div",{children:[Se.length," knowledge views",Se.map(Te=>o$1("div",{children:[o$1("b",{children:"base_id"}),": ",Te.base_id,"  ",o$1("b",{children:"id"}),": ",Te.id,"  ",o$1("b",{children:"title"}),": ",Te.title,"  ",o$1("b",{children:"description"}),": ",Te.description,"  ",o$1("b",{children:"wc_id_map ids"}),": ",JSON.stringify(Object.keys(Te.wc_id_map||{})),"  ",o$1("b",{children:"json"}),": ",JSON.stringify({...Te,base_id:void 0,id:void 0,title:void 0,description:void 0}),"  ",o$1("hr",{})]}))]}),Se&&Pe&&o$1("div",{children:o$1("input",{type:"button",onClick:()=>modify_knowledge_view({knowledge_view:Pe,current_knowledge_views:Se,set_postgrest_error:ge,set_knowledge_views:Ie}),value:"Modify a knowledge view (set random title) then fetch all for all bases"})})]})}function Username(t){var ce;const[ee,te]=h$1(""),[ne,oe]=h$1(!1),{user:ie,users_by_id:se,set_postgrest_error:re}=t,_e=((ce=se[ie.id])==null?void 0:ce.name)||"";p$1(()=>{ee!==_e&&te(_e)},[_e]);async function ae(le){var pe;oe(!0);const{id:ue}=ie,{data:de,error:me}=await supabase.from("users").upsert({id:ue,name:le}).eq("id",ue);re(me),te(de&&((pe=de[0])==null?void 0:pe.name)||""),oe(!1)}return o$1("div",{children:[ne?"Saving":"Your"," user name:",o$1("input",{type:"text",placeholder:"username",value:ee,disabled:ne,onKeyUp:le=>te(le.currentTarget.value),onChange:le=>te(le.currentTarget.value),onBlur:async le=>{te(le.currentTarget.value),ae(le.currentTarget.value)}}),o$1("br",{})]})}async function get_or_create_an_owned_base(t){const{base:ee,error:te}=await get_an_owned_base_optionally_create(t.user_id);t.set_postgrest_error(te),t.set_current_base_id(ee==null?void 0:ee.id)}async function get_an_owned_base_optionally_create(t){const ee=await get_an_owned_base(t);if(ee.error||ee.base)return ee;const te=await create_a_base({owner_user_id:t});return te.error?te:await get_an_owned_base(t)}async function get_an_owned_base(t){const ee=get_supabase(),{data:te,error:ne}=await ee.from("bases").select("*").eq("owner_user_id",t).order("inserted_at",{ascending:!0});return{base:te&&te[0]||void 0,error:ne}}async function get_all_bases2(t){const ee=await get_all_bases(t.user_id);t.set_postgrest_error(ee.error),t.set_bases(ee.data)}async function modify_base_wrapper(t){const{base:ee,set_postgrest_error:te,set_bases:ne}=t,oe=await modify_base(ee);te(oe.error),oe.error||await get_all_bases2({set_postgrest_error:te,set_bases:ne,user_id:t.user_id})}async function get_access_controls(t){const ee=await get_access_controls_for_base(t.base_id);t.set_postgrest_error(ee.error),t.set_access_controls(ee.access_controls)}async function on_update_access_control(t){t.set_postgrest_error(t.res.error),t.res.error||await get_access_controls(t)}async function create_knowledge_views(t){const te=generate_default_data(t.base_id).knowledge_views[0],{data:ne,error:oe}=await supabase.from("knowledge_views").insert(knowledge_view_app_to_supabase(te,t.base_id));t.set_postgrest_error(oe);const ie=(ne||[]).map(knowledge_view_supabase_to_app);t.set_knowledge_views(ie)}async function modify_knowledge_view(t){const{knowledge_view:ee,current_knowledge_views:te,set_postgrest_error:ne,set_knowledge_views:oe}=t,ie={...ee,title:"Some new title "+Math.random()},se=knowledge_view_app_to_supabase(ie),re=await supabase.rpc("update_knowledge_view",{item:se});let _e=re.error;if(re.status===404&&(_e={message:"Not Found",details:"",hint:"",code:"404"}),ne(_e),_e)return;const ae=re.data;if(!ae)return;const ce=knowledge_view_supabase_to_app(ae),le=replace_element(te,ce,ue=>ue.id===ee.id);oe(le)}function generate_default_data(t){const ee=prepare_new_contextless_wcomponent_object({base_id:t,title:"wc1"}),te=[ee];return{knowledge_views:[get_new_knowledge_view_object({id:v4(),base_id:t,title:"kv1",wc_id_map:{[ee.id]:{left:0,top:0}}})],wcomponents:te}}function DevLandingPage(){return o$1(Container,{maxWidth:"md",children:o$1("ul",{children:[o$1("li",{children:o$1("a",{href:"/production_landing_page/",children:"Landing page"})}),o$1("li",{children:o$1("a",{href:"/app/",children:"app"})}),o$1("li",{children:o$1("a",{href:"/sim/",children:"Sim"})}),o$1("li",{children:o$1("a",{href:"/data/",children:"Data"})}),o$1("li",{children:o$1("a",{href:"/project_dashboard",children:"Project dashboard"})}),o$1("li",{children:o$1("a",{href:"/prob_graph",children:"Probability graph"})}),o$1("li",{children:o$1("a",{href:"/prob_badge",children:"Probability badge"})}),o$1("li",{children:o$1("a",{href:"/sandbox/editable_custom_datetime",children:"Sandbox - EditableCustomDateTime"})}),o$1("li",{children:o$1("a",{href:"/sandbox/canvas_nodes",children:"Sandbox - WComponentNode"})}),o$1("li",{children:o$1("a",{href:"/sandbox/circular_connections",children:"Sandbox - Circular Connections"})}),o$1("li",{children:o$1("a",{href:"/sandbox/supabase",children:"Sandbox - Supabase"})}),o$1("li",{children:o$1("a",{href:"/sandbox/connected",children:"Sandbox - Connected"})}),o$1("li",{children:o$1("a",{href:"/sandbox",children:"Sandbox"})})]})})}const ScenarioGroupRunResult="";function ScenarioGroupRunResultComponent(t){const{scenario_group_run_result:ee}=t,te=as_percent(ee.total_completed/ee.total_to_run),ne=te===100,oe="scenario_group_run_result "+(ne?" complete ":" incomplete "),ie=F$1(()=>{if(!ne)return"Pending...";const{total_to_run:se}=ee;let re=0,_e=0,ae=0,ce=0;ee.results.forEach(fe=>{re+=fe.sim_time_seconds,_e+=fe.result.all_companies_solvent?1:0,ae+=fe.result.customer_demand_fulfilled_percentage,ce+=fe.result.total_company_profit});const le=round_number(re/se/(3600*24),1),ue=as_percent(_e/se),de=round_number(ae/se,1),me=round_number(ce/se,1);return`Mean --- Run time (days) ${le} --- Solvent: ${ue}% --- Demand met: ${de}% --- Company profit ${me}$`},[ne]);return o$1("div",{className:oe,children:[date2str_auto({date:ee.started,time_resolution:"second"}),"  ",te,"%    ",ie]})}function as_percent(t){return Math.round(t*100)}let scenario_group_run=0;const beer_game_simulator={schedule_sim:(t,ee,te)=>{let ne=[];const oe={id:`${++scenario_group_run}`,started:new Date,...t,total_completed:0,results:ne};te(oe),run_sims(oe,ee,se=>{ne=[...ne,se],te({...oe,total_completed:ne.length,results:ne})})}};async function run_sims(t,ee,te){const{total_to_run:ne,max_sim_time_seconds:oe}=t;for(let ie=0;ie<ne;++ie){const se=run_simulation__beer_game(oe,ee);te(se)}}function run_simulation__beer_game(t,ee){var pe;const ne=t/86400,oe=get_new_actor_customers(ee),ie=get_new_actor_retailer(ee),se=get_new_actor_wholesaler(ee),re=get_new_actor_distributor(ee),_e=get_new_actor_manufacturer(ee);let ae="time_limit",ce={},le=0;for(;le<ne&&ae!=="end_condition";++le){let fe=0;console.group(`day: ${le}`);do{++fe;const ge=ce[le]||[];delete ce[le];const he=[...oe.process(le,fe,ge),...ie.process(le,fe,ge),...se.process(le,fe,ge),...re.process(le,fe,ge),..._e.process(le,fe,ge)];if(ce=add_messages_by_delivery_day(ce,le,he),console.log("iteration",fe,"current_messages",ge,"all_new_messages",he,"existing_messages_by_day",ce),ie.get_end_condition_met()||se.get_end_condition_met()||re.get_end_condition_met()||_e.get_end_condition_met()){ae="end_condition";break}}while((pe=ce[le])!=null&&pe.length);console.groupEnd()}const ue=ie.get_is_solvent()&&se.get_is_solvent()&&re.get_is_solvent()&&_e.get_is_solvent(),de=ie.get_company_profit()+se.get_company_profit()+re.get_company_profit()+_e.get_company_profit();return{started:new Date,sim_time_seconds:le*86400,status:"complete",stop_reason:ae,result:{total_customer_demand:oe.get_total_customer_demand(),customer_demand_fulfilled_percentage:oe.get_customer_demand_fulfilled_percentage(),all_companies_solvent:ue,total_company_profit:de}}}function add_messages_by_delivery_day(t,ee,te){return validate_new_messages(te),t={...t},te.forEach(ne=>{const oe=ee+ne.delivery_delay_days;let ie=t[oe]||[];ie=[...ie,ne],t[oe]=ie}),t}function validate_new_messages(t){if(t.find(te=>te.delivery_delay_days<0))throw new Error("Invalid message")}function factory_is_a_message(t){return function(ee){return ee.type===t}}const accept_demand_from_map={retailer:"consumer",wholesaler:"retailer",distributor:"wholesaler",manufacturer:"distributor"},accept_product_from_map={consumer:"retailer",retailer:"wholesaler",wholesaler:"distributor",distributor:"manufacturer",manufacturer:void 0},is_a_product_demand_message=factory_is_a_message("product_demand"),is_a_product_demand_fulfilment_message=factory_is_a_message("product_demand_fulfilment");function get_new_actor_customers(t){const{consumers_initial_demand:ee,consumers_demand_increase_delay_days:te,consumers_increased_demand:ne}=t,oe=accept_product_from_map.consumer;let ie=0,se=0;return{process:(re,_e,ae)=>{const ce=[];if(_e===1){const le=re<te?ee:ne;ie+=le;const ue={type:"product_demand",origin:"consumer",delivery_delay_days:0,demand:le};console.log(`consumer demanded ${le}`),ce.push(ue)}return ae.forEach(le=>{is_a_product_demand_fulfilment_message(le)&&le.origin===oe&&(se+=le.demand_fulfilled,console.log(`consumer recieved ${le.demand_fulfilled}`))}),ce},get_end_condition_met:()=>!1,get_total_customer_demand:()=>ie,get_customer_demand_fulfilled_percentage:()=>se/ie*100}}function get_common_business_starting_state(t){const ee=t.retailer_initial_balance,te=t.retailer_initial_stock,ne=t.retailer_storage,oe=Math.round(ne*.8),se={balance:ee,stock:te,storage:ne,pending_delivery:0,stock_to_dispatch:0,target_stock_level:oe,spoiled_stock:0};function re(_e){if(_e<0)throw new Error(`val: ${_e} < 0`);return _e}return{get_balance:()=>se.balance,set_balance:_e=>se.balance=_e,get_stock:()=>se.stock,set_stock:_e=>{se.stock=re(_e);const ae=se.stock-se.storage;ae>0&&(se.spoiled_stock+=ae,se.stock=se.storage)},get_storage:()=>se.storage,get_pending_delivery:()=>se.pending_delivery,set_pending_delivery:_e=>se.pending_delivery=re(_e),get_stock_to_dispatch:()=>se.stock_to_dispatch,set_stock_to_dispatch:_e=>se.stock_to_dispatch=re(_e),get_target_stock_level:()=>se.target_stock_level,is_solvent:()=>se.balance>=0,get_profit:()=>se.balance-ee,get_spoiled_stock:()=>se.spoiled_stock}}function common_business_message_processor(t,ee,te,ne){const oe=[],ie=accept_demand_from_map[t],se=accept_product_from_map[t];return ne.forEach(re=>{if(is_a_product_demand_message(re)&&re.origin===ie){const _e=dispatch_stock(t,ee,re.demand,te);oe.push(_e)}if(is_a_product_demand_fulfilment_message(re)&&re.origin===se){const _e=ee.get_stock(),ae=_e+re.demand_fulfilled;console.log(`${t} got delivery ${_e} -> ${ae}`),ee.set_stock(ae)}}),oe}function dispatch_stock(t,ee,te,ne){if(te<=0)throw new Error("Demand must be greater than 0 to dispatch");const oe=ee.get_stock(),ie=Math.min(te,oe);ee.set_stock(oe-ie);const se=te-ie,re=ee.get_stock_to_dispatch();ee.set_stock_to_dispatch(re+se);const _e=t==="retailer"?0:ne.transport_time_in_days,ae=get_price_of_sellers_product(t,ne),ce=ee.get_balance(),le=ie*ae,ue=ce+le;return ee.set_balance(ue),console.log(`${t} got demand ${te}, fulfilled: ${ie} for ${le}$ now has ${ue}$`),{type:"product_demand_fulfilment",origin:t,delivery_delay_days:_e,demand_fulfilled:ie}}function get_price_of_sellers_product(t,ee){const te=t==="retailer"?ee.retailer_initial_price:t==="wholesaler"?ee.wholesaler_initial_price:t==="distributor"?ee.distributor_initial_price:t==="manufacturer"?ee.manufacturer_initial_price:0;if(te<0)throw new Error("Price should always be >= 0");return te}function common_business_day_processor(t,ee,te,ne,oe,ie){const se=[],re=ee.get_stock_to_dispatch();if(re&&ee.get_stock()){const _e=Math.min(re,ee.get_stock());ee.set_stock_to_dispatch(re-_e);const ae=dispatch_stock(t,ee,_e,te);console.log(`^^ ${t} shipped late product ^^`),se.push(ae)}if(oe===1&&ne%te.days_between_stock_take===0){const _e=ee.get_pending_delivery(),ae=(ee.get_target_stock_level()-(ee.get_stock()+_e))*te.demand_signal_multiplier,ce=accept_product_from_map[t],le=get_price_of_sellers_product(ce,te),ue=ae*le,de=ee.get_balance(),me=ue<=de?ae:Math.floor(de/le),pe=de-me*le;if(ee.set_balance(pe),me>0){if(t!=="manufacturer"){const fe={type:"product_demand",origin:t,delivery_delay_days:0,demand:me};ee.set_pending_delivery(_e+me),se.push(fe)}ie&&ie(me)}}return se}function get_new_actor_retailer(t){const ee="retailer",te=get_common_business_starting_state(t);return{process:(ne,oe,ie)=>{let se=common_business_message_processor(ee,te,t,ie);const re=common_business_day_processor(ee,te,t,ne,oe);return se=se.concat(re),se},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}function get_new_actor_wholesaler(t){const ee="wholesaler",te=get_common_business_starting_state(t);return{process:(ne,oe,ie)=>{let se=common_business_message_processor(ee,te,t,ie);const re=common_business_day_processor(ee,te,t,ne,oe);return se=se.concat(re),se},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}function get_new_actor_distributor(t){const ee="distributor",te=get_common_business_starting_state(t);return{process:(ne,oe,ie)=>{let se=common_business_message_processor(ee,te,t,ie);const re=common_business_day_processor(ee,te,t,ne,oe);return se=se.concat(re),se},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}function get_new_actor_manufacturer(t){const ee="manufacturer",te=get_common_business_starting_state(t),ne={};return{process:(oe,ie,se)=>{if(ie===1){const ce=te.get_stock(),le=ce+(ne[oe]||0);le>ce&&console.log("Manufactuer made new_stock ",ce,le),te.set_stock(le)}let re=common_business_message_processor(ee,te,t,se);const ae=common_business_day_processor(ee,te,t,oe,ie,ce=>{const le=oe+t.manufacturing_delay_in_days;if(ne[le])throw new Error(`Already making goods for day: ${le}`);ce&&console.log("Manufactuer scheduling to make new_stock ",ce),ne[le]=ce});return re=re.concat(ae),re},get_end_condition_met:()=>!te.is_solvent(),get_is_solvent:()=>te.is_solvent(),get_company_profit:()=>te.get_profit()}}const SimulationScenarioSummary$1="";function SimulationScenarioSummary(t){const{scenario_kv_id:ee,knowledge_views_by_id:te,wcomponents_by_id:ne,created_at_ms:oe,sim_ms:ie}=t,se=te[ee],[re,_e]=h$1([]),ae=Se=>{const Ie=upsert_entry(re,Se,Pe=>Pe.id===Se.id);_e(Ie)};if(!se)return o$1("div",{children:["Unknown scenario knowledge view for id: ",ee]});const ce=F$1(()=>calculate_composed_knowledge_view({knowledge_view:se,knowledge_views_by_id:te,wcomponents_by_id:ne}),[se,te,ne]),le={attribute_to_wc_id_map:t.simulation.attribute_to_wc_id_map,wcomponents_by_id:ne,composed_kv:ce,created_at_ms:oe,sim_ms:ie},ue=get_attribute_initial_number("consumers_initial_demand",le),de=get_attribute_initial_number("consumers_demand_increase_delay_days",le),me=get_attribute_initial_number("consumers_increased_demand",le);if(!ue)return o$1("div",{children:[se.title," missing consumers_initial_demand attribute"]});if(!de)return o$1("div",{children:[se.title," missing consumers_demand_increase_delay_days attribute"]});if(!me)return o$1("div",{children:[se.title," missing consumers_increased_demand attribute"]});const pe=get_attribute_initial_number("retailer_initial_price",le),fe=get_attribute_initial_number("retailer_initial_balance",le),ge=get_attribute_initial_number("retailer_initial_stock",le),he=get_attribute_initial_number("retailer_storage",le);if(!pe)return o$1("div",{children:[se.title," missing retailer_initial_price attribute"]});if(!fe)return o$1("div",{children:[se.title," missing retailer_initial_balance attribute"]});if(!ge)return o$1("div",{children:[se.title," missing retailer_initial_stock attribute"]});if(!he)return o$1("div",{children:[se.title," missing retailer_storage attribute"]});const be=get_attribute_initial_number("wholesaler_initial_price",le);if(!be)return o$1("div",{children:[se.title," missing wholesaler_initial_price attribute"]});const ve=get_attribute_initial_number("distributor_initial_price",le);if(!ve)return o$1("div",{children:[se.title," missing distributor_initial_price attribute"]});const ye=get_attribute_initial_number("manufacturer_initial_price",le),we=get_attribute_initial_number("manufacturing_delay_in_days",le);if(!ye)return o$1("div",{children:[se.title," missing manufacturer_initial_price attribute"]});if(!we)return o$1("div",{children:[se.title," missing manufacturing_delay_in_days attribute"]});const ke=get_attribute_initial_number("demand_signal_multiplier",le);if(!ke)return o$1("div",{children:[se.title," missing demand_signal_multiplier attribute"]});const Ae=get_attribute_initial_number("days_between_stock_take",le);if(!Ae)return o$1("div",{children:[se.title," missing days_between_stock_take attribute"]});const $e=get_attribute_initial_number("transport_time_in_days",le);if(!$e)return o$1("div",{children:[se.title," missing transport_time_in_days attribute"]});const xe={total_to_run:1,max_sim_time_seconds:3600*24*365},Ce={consumers_initial_demand:ue.parsed_value,consumers_demand_increase_delay_days:de.parsed_value,consumers_increased_demand:me.parsed_value,retailer_initial_price:pe.parsed_value,retailer_initial_balance:fe.parsed_value,retailer_initial_stock:ge.parsed_value,retailer_storage:he.parsed_value,wholesaler_initial_price:be.parsed_value,distributor_initial_price:ve.parsed_value,manufacturer_initial_price:ye.parsed_value,manufacturing_delay_in_days:we.parsed_value,demand_signal_multiplier:ke.parsed_value,days_between_stock_take:Ae.parsed_value,transport_time_in_days:$e.parsed_value};return o$1("div",{className:"scenario_summary",children:[se.title,o$1("div",{className:"simulation_run",children:[o$1(Button,{value:"Run",onClick:()=>{beer_game_simulator.schedule_sim(xe,Ce,ae)}}),o$1(Button,{value:"Run x100",onClick:()=>{beer_game_simulator.schedule_sim({...xe,total_to_run:100},Ce,ae)}})]}),o$1("br",{}),"retailer_initial_stock: ",ge==null?void 0:ge.parsed_value,"  retailer_storage: ",he==null?void 0:he.parsed_value,"  demand_signal_multiplier: ",ke==null?void 0:ke.parsed_value,o$1("br",{}),re.map(Se=>o$1(ScenarioGroupRunResultComponent,{scenario_group_run_result:Se},Se.started.getTime()))]})}function get_attribute_initial_number(t,ee){const te=get_attribute_initial_value(t,ee);if(!te)return te;const{parsed_value:ne}=te;return Number.isFinite(ne)?{...te,parsed_value:ne}:!1}function get_attribute_initial_value(t,ee){var de;const{attribute_to_wc_id_map:te,wcomponents_by_id:ne,composed_kv:oe,created_at_ms:ie,sim_ms:se}=ee,re=te[t]||"",_e=ne[re];if(!_e)return!1;const ce=(de=oe.wc_id_to_active_counterfactuals_v2_map[_e.id])==null?void 0:de.VAP_sets;return get_wcomponent_state_value_and_probabilities({wcomponent:_e,VAP_set_id_to_counterfactual_v2_map:ce,created_at_ms:ie,sim_ms:se}).most_probable_VAP_set_values[0]}function SimulationSummary(t){const{foundational_knowledge_view_id:ee,scenario_knowledge_view_ids:te}=t.simulation,{knowledge_views_by_id:ne,wcomponents_by_id:oe}=t,ie=ne[ee];if(!ie)return o$1("div",{children:["Unknown simulation base knowledge view for id: ",ee]});const se=new Date().getTime(),re=se;return o$1("div",{children:[o$1("h4",{children:ie.title}),o$1("i",{children:"Scenarios"}),te.map(_e=>o$1(SimulationScenarioSummary,{simulation:t.simulation,scenario_kv_id:_e,knowledge_views_by_id:ne,wcomponents_by_id:oe,created_at_ms:se,sim_ms:re},_e))]})}async function get_simulations(){return[{foundational_knowledge_view_id:"01ee3824-9445-4059-8714-912a011962bf",scenario_knowledge_view_ids:["fa166715-c167-4efc-bc25-12fad9f531f1","2b56dbff-d82a-4fab-9082-68237b5cf6b3","219fdd22-4175-4aad-bb06-3fca7ad4d206"],attribute_to_wc_id_map:{consumers_initial_demand:"af4290c5-75c5-4716-88da-43c7d99b7f9f",consumers_demand_increase_delay_days:"73ac5288-da5d-49a9-b859-f0e58dca4de7",consumers_increased_demand:"994983bc-5a16-49f9-bba3-c7eca7e54847",retailer_initial_price:"a853ddc2-14ed-432f-9093-217bb4fbda3c",retailer_initial_balance:"dbe718aa-6591-4417-ac84-300105662b2c",retailer_initial_stock:"a349eb23-6b0c-4ad5-8908-655ce465a898",retailer_storage:"99842a46-a7a2-443d-b8f6-9821d350ab5e",wholesaler_initial_price:"4f0b8a29-8423-42b9-b124-edd3af00fd6b",distributor_initial_price:"ac7aad82-f16d-4e9c-9997-8d4381da6673",manufacturer_initial_price:"44bc6ef5-438f-4522-9972-b27a5908f5bc",manufacturing_delay_in_days:"54e9e4a5-35a5-4d49-81be-85cbe399e867",demand_signal_multiplier:"0e05530e-aef4-4e86-8feb-0a67073e9b51",days_between_stock_take:"10061767-0f73-486c-86da-411a05232edf",transport_time_in_days:"25aaa820-a4b6-4ba5-988e-9d74a05bea08"}}]}const base_id=16,initial_data={};function SimHome(){const[t,ee]=h$1(initial_data),[te,ne]=h$1({}),[oe,ie]=h$1([]);return p$1(()=>{supabase_load_data(!0,base_id).then(se=>{ee(get_items_by_id(se.knowledge_views,"")),ne(get_items_by_id(se.wcomponents,""))}),get_simulations().then(se=>ie(se))},[]),t===initial_data?o$1("div",{children:[o$1("h2",{children:"Simulations"}),"Loading..."]}):o$1("div",{children:[o$1("h2",{children:"Simulations"}),oe.map(se=>o$1(SimulationSummary,{simulation:se,knowledge_views_by_id:t,wcomponents_by_id:te}))]})}function get_current_kv(t=!1){const te=get_state().derived.current_composed_knowledge_view;if(t&&!te)throw new Error("Lacking current_composed_knowledge_view");return te}function get_wcomponents_by_id(){return get_state().specialised_objects.wcomponents_by_id}function get_connection_map(t={}){const ee=get_current_kv(!0),te=get_wcomponents_by_id(),{causal_only:ne=!0}=t,oe=new Set(Object.keys(ee.composed_visible_wc_id_map)),re=Array.from(ne?ee.wc_ids_by_type.causal_link:ee.wc_ids_by_type.any_link).filter(ce=>oe.has(ce)).map(ce=>te[ce]).filter(wcomponent_is_plain_connection).filter(ce=>ce.from_id&&ce.to_id).filter(ce=>te[ce.from_id]&&te[ce.to_id]),_e=new Set,ae={};return re.forEach(ce=>{_e.add(ce.from_id),_e.add(ce.to_id);const le=ae[ce.from_id]||{};ae[ce.from_id]=le;const ue=le[ce.to_id]||[];le[ce.to_id]=ue;let de=1;wcomponent_is_causal_link(ce)&&(de=ce.effect_when_true??1),ue.push(de)}),{node_ids_connections_map:ae,node_ids:_e}}function get_connection_matrix(t={}){const{node_ids_connections_map:ee,node_ids:te}=get_connection_map(t),ne=[],oe=[""];return ne.push(oe),Array.from(te).forEach(ie=>oe.push(ie)),Array.from(te).forEach(ie=>{const se=[ie];Array.from(te).forEach(re=>{const _e=(ee[re]||{})[ie]||[];se.push(_e)}),ne.push(se)}),ne}function get_component_id_to_label_ids_map(){const t=get_current_kv(!0),ee=get_wcomponents_by_id(),ne=Object.keys(t.composed_visible_wc_id_map).map(ie=>ee[ie]).filter(is_defined),oe={};return ne.forEach(ie=>{!ie.label_ids||ie.label_ids.length===0||(oe[ie.id]=ie.label_ids)}),oe}function get_component_id_to_label_names_map(){const t=get_wcomponents_by_id(),ee=get_component_id_to_label_ids_map(),te={},ne={};return Object.entries(ee).forEach(([oe,ie])=>{const se=ie.map(re=>{const _e=t[re];if(!_e)return"";const ae=te[re]||_e.title;return te[re]=ae,ae});ne[oe]=se}),ne}function convert_matrix_component_ids(t,ee){return t.map(ne=>ne.map(oe=>typeof oe!="string"?oe:oe?ee(oe):""))}function matrix_component_ids_to_labels(t,ee){const te={},ne={};return convert_matrix_component_ids(ee,ie=>{let se=te[ie]||"";if(!se){se=(t[ie]||[]).join(",");const _e=(ne[se]||0)+1;ne[se]=_e,se+=`_${_e}`,te[ie]=se}return se})}function matrix_component_ids_to_titles(t,ee){return convert_matrix_component_ids(ee,ne=>{var oe;return((oe=t[ne])==null?void 0:oe.title)||""})}function matrix_to_csv(t){const ee=[];return t.forEach(te=>{const ne=[];te.forEach(oe=>{typeof oe=="string"?ne.push(oe):oe.length===0?ne.push(""):oe.length===1?ne.push((oe[0]||0).toString()):ne.push(JSON.stringify(oe))}),ee.push(ne.join(",")+`
`)}),ee.join("")}function get_current_visible_graph(){return{get_connection_map,get_connection_matrix,get_component_id_to_label_names_map}}function get_current_wcomponent(){const t=get_state(),ee=t.routing.item_id||"";return t.specialised_objects.wcomponents_by_id[ee]}function get_selected_wcomponents(){const t=get_state();return t.meta_wcomponents.selected_wcomponent_ids_list.map(ee=>get_wcomponent_from_state(t,ee)).filter(is_a_wcomponent)}function get_action_wcomponent_elapsed_minutes(t,ee){let te=0;return wcomponent_is_action(t)&&get_action_active_date_ranges(t).forEach(({start:oe,stop:ie})=>te+=ie.getTime()-oe.getTime()),te=Math.round(te/1e3),ee?seconds_to_string(te):round_seconds_to_minutes(te)}function round_seconds_to_minutes(t){return Number.parseFloat((t/60).toFixed(2))}function seconds_to_string(t){const ee=t%60;t=Math.round((t-ee)/60);const te=t%60;t=Math.round((t-te)/60);const ne=t%24;t=Math.round((t-ne)/24);let oe="";return t&&(oe+=`${t} days`),(t||ne)&&(oe+=` ${ne} hours`),(t||ne||te)&&(oe+=` ${te} minutes`),oe+=` ${ee} seconds`,oe=oe.trim(),oe}function get_selected_wcomponents_elapsed_minutes(t){const te=get_selected_wcomponents().map(ne=>get_action_wcomponent_elapsed_minutes(ne,!1)).reduce((ne,oe)=>ne+oe,0)*60;return t?seconds_to_string(te):round_seconds_to_minutes(te)}function setup_console_api(){const t={get_current_visible_graph,matrix_component_ids_to_labels,matrix_component_ids_to_titles,matrix_to_csv,get_current_kv,get_wcomponents_by_id,create_wcomponent,get_current_wcomponent,get_selected_wcomponents,get_action_wcomponent_elapsed_minutes,get_selected_wcomponents_elapsed_minutes};window.console_api=t}function get_state(){return window.debug_state}const origin_left=500,origin_top=300,origin={left:origin_left,top:origin_top};function SandboxCircularConnections(){const[t,ee]=h$1(700),[te,ne]=h$1(100),[oe,ie]=h$1(0),se=oe===0||oe===1,re=oe===0||oe===2,_e={left:t,top:te};return o$1("div",{style:{width:"100%",height:"100%"},onMouseMove:ae=>{ee(ae.x),ne(ae.y)},onClick:()=>ie((oe+1)%3),children:[o$1(ConnectableCanvasNode,{node_main_content:o$1("div",{style:{height:100},children:"Node 1"}),terminals:[],position:origin}),o$1(ConnectableCanvasNode,{node_main_content:o$1("div",{style:{height:100},children:"Node 2"}),terminals:[],position:_e}),o$1("svg",{width:1300,height:1e3,style:{zIndex:1e3,position:"absolute"},children:[se&&o$1("g",{children:[o$1(CanvasConnnection,{from_node_position:origin,from_connection_type:{direction:"from",attribute:"state"},to_node_position:_e,to_connection_type:{direction:"to",attribute:"state"},circular_links:!0,should_animate:!1}),o$1(CanvasConnnection,{from_node_position:_e,from_connection_type:{direction:"from",attribute:"state"},to_node_position:origin,to_connection_type:{direction:"to",attribute:"state"},circular_links:!0,should_animate:!1})]}),re&&o$1("g",{children:[o$1(CanvasConnnection,{from_node_position:origin,from_connection_type:{direction:"from",attribute:"state"},to_node_position:_e,to_connection_type:{direction:"to",attribute:"state"},circular_links:!1,should_animate:!1}),o$1(CanvasConnnection,{from_node_position:_e,from_connection_type:{direction:"from",attribute:"state"},to_node_position:origin,to_connection_type:{direction:"to",attribute:"state"},circular_links:!1,should_animate:!1})]})]})]})}const TableDisplayMultiDimensionalData$1="";function TableDisplayMultiDimensionalData(t){return o$1("table",{class:"multi_dimensional_data_table",children:[o$1("thead",{}),o$1("tbody",{children:t.data.map(ee=>o$1("tr",{children:ee.map(te=>o$1("td",{children:te}))}))})]})}function MultidimensionalDataForm(t){const[ee,te]=h$1(""),[ne,oe]=h$1(void 0),[ie,se]=h$1("number"),[re,_e]=h$1([]);return o$1("div",{children:["Title ",o$1("input",{type:"text",value:ee,style:{width:250},onChange:ae=>te(ae.currentTarget.value)}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Type   ",o$1(AutocompleteText,{editing_allowed:!0,selected_option_id:ie,options:wcomponent_statev2_subtype_options,allow_none:!1,on_change:ae=>ae&&se(ae)})]}),o$1("br",{}),o$1("br",{}),o$1("div",{style:{display:"inline-flex"},children:["Date (Optional)   ",o$1("input",{type:"date",value:ne==null?void 0:ne.toISOString(),onChange:ae=>{oe(ae.currentTarget.valueAsDate||void 0)}})]}),o$1("br",{}),o$1("br",{}),"Input ",o$1("textarea",{value:"",rows:1,onChange:ae=>{const ce=ae.currentTarget.value;_e(ce.split(`
`).map(le=>le.split("	")))}}),o$1("br",{}),o$1("input",{type:"button",value:"Add",onChange:ae=>{const ce={id:Math.random().toString(),base_id:-1,type:"multidimensional_state",title:ee,description:"",created_at:new Date},le={id:ce.id,schema_version:1,author_id:"abc",data_type:ie,schema_description:"",schema:{dimensions:[]},dimension_data:{},data:[]};t.add_multidimensional_state(ce),t.add_multidimensional_state_data(le)}}),o$1("br",{}),"Parsed value:",o$1(TableDisplayMultiDimensionalData,{data:re})]})}function get_starting_state(t){return{multidimensional_states:[],multidimensional_state_datas:[]}}function load_local_data(){const t=localStorage.getItem("x_data_app")||"{}";return{...get_starting_state(),...JSON.parse(t)}}function save_local_data(t){t={...load_local_data(),...t},localStorage.saveItem("x_data_app",JSON.stringify(t))}function GenericData(){const[t,ee]=h$1({}),{multidimensional_states:te,multidimensional_state_datas:ne}=load_local_data(),oe=se=>{save_local_data({multidimensional_states:se}),ee({})},ie=se=>{save_local_data({multidimensional_state_datas:se}),ee({})};return o$1("div",{children:["GenericData",o$1(MultidimensionalDataForm,{add_multidimensional_state:se=>{oe([...te,se])},add_multidimensional_state_data:se=>{ie([...ne,se])}}),o$1("hr",{}),te.map(se=>o$1("div",{children:se.title}))]})}function DataApp(){const[t,ee]=h$1("generic_data"),te=t==="generic_data";return o$1("div",{children:[o$1("div",{children:o$1("button",{onClick:()=>ee("generic_data"),style:{backgroundColor:te?"white":""},children:"Data"})}),o$1("br",{}),te&&o$1(GenericData,{})]})}const root_reducer=(t,ee)=>t;let cached_store;function get_data_app_store(t={}){const{use_cache:ee=!0,override_preloaded_state:te={},load_state_from_storage:ne=!1}=t;if(cached_store&&ee)return cached_store;const oe={...get_starting_state(),...te},ie=createStore(root_reducer,oe);return ie.load_state_from_storage=ne,cached_store=ie,ie}const root=document.getElementById("root");if(root)if(root.innerText="",window.location.pathname===""||window.location.pathname==="/")D$1(o$1(DevLandingPage,{}),root);else if(window.location.pathname==="/project_dashboard")D$1(o$1(Provider,{store:get_store({load_state_from_storage:!0}),children:o$1(DemoProjectDashboard,{})}),root);else if(window.location.pathname==="/prob_graph")D$1(o$1(DemoPredictionsGraph,{}),root);else if(window.location.pathname==="/prob_badge")D$1(o$1(DemoPredictionsBadge,{}),root);else if(window.location.pathname==="/sandbox/editable_custom_datetime")D$1(o$1(Provider,{store:get_store({load_state_from_storage:!1}),children:o$1(SandboxEditableCustomDateTime,{})}),root);else if(window.location.pathname==="/sandbox/canvas_nodes")D$1(o$1(SandboxWComponentCanvasNode,{}),root);else if(window.location.pathname==="/sandbox/circular_connections")D$1(o$1(SandboxCircularConnections,{}),root);else if(window.location.pathname==="/sandbox/connected")D$1(o$1(Provider,{store:get_store({load_state_from_storage:!1}),children:o$1(SandBoxConnected,{})}),root);else if(window.location.pathname==="/sandbox/supabase")D$1(o$1(SandBoxSupabase,{}),root);else if(window.location.pathname==="/sandbox")D$1(o$1(SandBox,{}),root);else if(window.location.pathname==="/app/"||window.location.pathname==="/app"){const t=get_store({load_state_from_storage:!0});D$1(o$1(Provider,{store:t,children:o$1(App$1,{})}),root)}else if(window.location.pathname==="/privacy-policy")D$1(o$1("div",{children:"Will render public/privacy-policy.html"}),root);else if(window.location.pathname==="/privacy-policy/")D$1(o$1("div",{children:"Will need to remove trailing / and link to privacy-policy or privacy-policy.html to render correctly"}),root);else if(window.location.pathname==="/terms-and-conditions")D$1(o$1("div",{children:"Will render public/terms-and-conditions.html"}),root);else if(window.location.pathname==="/terms-and-conditions/")D$1(o$1("div",{children:"Will need to remove trailing / and link to terms-and-conditions or terms-and-conditions.html to render correctly"}),root);else if(window.location.pathname==="/sim/"||window.location.pathname==="/sim")D$1(o$1(SimHome,{}),root);else if(window.location.pathname==="/data/"||window.location.pathname==="/data"){const t=get_data_app_store({load_state_from_storage:!1});D$1(o$1(Provider,{store:t,children:o$1(DataApp,{})}),root)}else root.innerText="Unknown path: "+window.location.pathname;set_window_title();setup_window_on_focus_listener();setup_console_api();
