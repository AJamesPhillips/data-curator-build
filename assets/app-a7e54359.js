var Z1=Object.defineProperty;var Q1=(e,t,n)=>t in e?Z1(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var ye=(e,t,n)=>(Q1(e,typeof t!="symbol"?t+"":t,n),n);import{g as Ce,s as kv,A as ek,a as Pn,p as Nn,t as xv,r as Z,W as tk,D as Av}from"./set_window_title-8034a9c4.js";import{o as _,b as xe,H as nk,c as En,i as Q,r as ee,a as re,y as ik,B as E,A as qi,d as Vi,e as Fi,F as it,f as ci,R as wu,g as Pi,h as Ni,S as Wc,T as Hc,j as Me,I as pe,k as ok,l as sk,D as bu,n as Sv,M as os,p as rk,m as Pt,q as In,s as Cv,t as _k,u as $v,v as ak,w as ck,x as lk,z as dk,E as uk,G as pk,J as mk,K as fk,L as hk,N as jv,O as Tv,P as vk,Q as gk,U as wk,V as bk,W as yk}from"./common_style_libraries-365b79f7.js";import{m as kk,M as xk,n as j,h as I,b as Ie,p as _e,o as To,r as Ak,t as Sk,s as Pv,c as yu,u as Ck,F as z,v as Nv,d as Re,w as Ev,D as $k,P as jk}from"./common_libraries-d67d20a8.js";function Tk(e,t){for(var n=0;n<t.length;n++){const i=t[n];if(typeof i!="string"&&!Array.isArray(i)){for(const o in i)if(o!=="default"&&!(o in e)){const s=Object.getOwnPropertyDescriptor(i,o);s&&Object.defineProperty(e,o,s.get?s:{enumerable:!0,get:()=>i[o]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}function kt(e,t={}){const n=t.sort_items??!1,i=t.render_undefined??!1,o=typeof t.space=="number"?Array(t.space+1).join(" "):t.space||"",s=typeof t.cycles=="boolean"?t.cycles:!1,r=t.replacer||((l,d)=>Pk(d)?d.toISOString():d instanceof Set?Array.from(d).sort():d),a=t.comparison_function&&function(l){return function(d,u){return t.comparison_function({key:d,value:l[d]},{key:u,value:l[u]})}},c=[];return function l(d,u,f,m){const h=o?`
`+new Array(m+1).join(o):"",v=o?": ":":";if(f=r.call(d,u,f),f===void 0)return i?"undefined":void 0;if(typeof f!="object"||f===null)return JSON.stringify(f);if(Array.isArray(f)){const w=[];for(let k=0;k<f.length;k++){const y=l(f,k,f[k],m+1)||JSON.stringify(null);w.push(h+o+y)}return"["+w.join(",")+h+"]"}if(c.indexOf(f)!==-1){if(s)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}else c.push(f);let g=Object.keys(f);n&&(g=g.sort(a&&a(f)));const b=[];return g.forEach(w=>{const k=l(f,w,f[w],m+1);if(!k)return;const y=JSON.stringify(w)+v+k;b.push(h+o+y)}),c.splice(c.indexOf(f),1),"{"+b.join(",")+h+"}"}({"":e},"",e,0)}function Pk(e){return Object.prototype.toString.call(e)==="[object Date]"}let dt={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0};const ku={get:()=>dt,reset:()=>{dt={describe_run:0,describe_skipped:0,test_run:0,test_passed:0,test_failed:[],test_skipped:0}},print:()=>{const e=dt;console.log(`
describe: ${e.describe_run+e.describe_skipped}
tests: ${e.test_run+e.test_skipped}`);const t=e.describe_skipped+e.test_skipped;console.log(`%cskipped: ${t}`,`color:${t?"tan":"LightGrey"};font-weight:bold;`),e.test_failed.length&&console.error("failed: "+e.test_failed.join(`
failed: `)),console.log(`%cpassed: ${e.test_passed}${e.test_failed.length?`
failed: ${e.test_failed.length}`:""}
    `,`color:${e.test_failed.length?"red":"green"};font-weight:bold;`)}},ul=!0,Nk=(e,t,n="",i=ul)=>{dt.test_run+=1;const o={render_undefined:!0,sort_items:i},s=kt(e,o),r=kt(t,o);if(s===r){dt.test_passed+=1;const c=n.split(`
`).filter(l=>l.trim())[0];console.log(`pass:  ${c}`)}else{const c=`${n} "${s}" !== "${r}"`;Zi(c,e,t,i)}};function Zi(e,t,n,i=ul){dt.test_failed.push(e),console.error(`fail:  ${e}`);const o={render_undefined:!0,sort_items:i};try{if((t==null?void 0:t.constructor)===Object&&(n==null?void 0:n.constructor)===Object){const s=[...new Set([...Object.keys(t),...Object.keys(n)])];s.sort(),s.forEach(r=>{const[a,c]=[t,n],l=a[r],d=c[r],u=kt(l,o),f=kt(d,o);if(!(u===f))console.debug(`Test failure: different values for key "${r}", got: '${u}', but expected: '${f}'`);else if(u==="undefined"){const h=r in a,v=r in c;h!==v&&console.debug(`Test failure: key "${r}", got: ${h?"present":"not present"}, but expected: ${v?"present":"not present"}`)}})}}catch(s){console.debug("error in providing debugging for test failure",s)}}const p=Nk;p.skip=(e,t,n="",i=ul)=>{dt.test_skipped+=1,console.warn("skipping  "+n)};const Ek=async(e,t)=>{let n;if(Iv(t))n=async()=>{dt.describe_run+=1,console.group(e);try{await t()}catch(i){Zi(`error in test: ${i}`,null,null)}console.groupEnd()},await n();else{const i=t;n=()=>{dt.describe_run+=1,console.group(e);try{i()}catch(o){Zi(`error in test: ${o}`,null,null)}console.groupEnd()},n()}return n},A=Ek;A.skip=(e,t)=>{function n(){dt.describe_skipped+=1,console.warn("skipping  "+e)}return n};A.delay=(e,t)=>{let n;if(Iv(t))n=async()=>{dt.describe_run+=1,console.group(e);try{await t()}catch(i){Zi(`error in test: ${i}`,null,null)}console.groupEnd()};else{const i=t;n=()=>{dt.describe_run+=1,console.group(e);try{i()}catch(o){Zi(`error in test: ${o}`,null,null)}console.groupEnd()}}return n};function Iv(e){return e.constructor.name==="AsyncFunction"}function ie(e){if(!Number.isInteger(e))throw new Error("uuid_v4_for_tests id must be an integer");if(e<0)throw new Error("uuid_v4_for_tests id must be >=0");return`${e}0000000-0000-4000-a000-000000000000`}const Ik={0:"Jan",1:"Feb",2:"Mar",3:"Apr",4:"May",5:"Jun",6:"Jul",7:"Aug",8:"Sep",9:"Oct",10:"Nov",11:"Dec"};function Ct(e,t){const n={M:e.getMonth()+1,d:e.getDate(),h:e.getHours(),m:e.getMinutes(),s:e.getSeconds()};return t=t.replace(/MMM/g,function(i){return Ik[e.getMonth()]||""}),t=t.replace(/(M+|d+|h+|m+|s+)/g,function(i){return((i.length>1?"0":"")+n[i.slice(-1)]).slice(-2)}),t.replace(/(y+)/g,function(i){return e.getFullYear().toString().slice(-i.length)})}function io(e){const{date:t,time_resolution:n="minute",trim_midnight:i=!0}=e,s=Ct(t,n==="day"?"yyyy-MM-dd":n==="hour"?"yyyy-MM-dd hh:00":n==="minute"?"yyyy-MM-dd hh:mm":"yyyy-MM-dd hh:mm:ss");return i?s.replace(" 00:00",""):s}function ss(e=!0){return Ct(new Date,"yyyy-MM-dd")+(e?" 00:00":"")}function Rk(){return new Date(ss())}const Us=24*3600*1e3,xu=new Date().getTimezoneOffset()*6e4;function*Dk(e,t){const n=Math.floor((e.getTime()-xu)/Us),i=Math.ceil((t.getTime()-xu)/Us);let o=n;for(;o<i;)yield new Date(o*Us),++o}function Ok(e,t){const n="yyyy-MM-dd";return[...Dk(e,t)].map(i=>Ct(i,n))}function Mk(e,t){return Rv(new Date(e),t).getTime()}function Rv(e,t){const n=io({date:e,time_resolution:t});return new Date(n)}function bi(e){const t=new Date;let n;if(e){const{use_creation_context:i,creation_context:o}=e;n=i?o&&o.custom_created_at:void 0}return{created_at:t,custom_created_at:n}}var Po,qk=new Uint8Array(16);function Vk(){if(!Po&&(Po=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!Po))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Po(qk)}const Fk=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function zk(e){return typeof e=="string"&&Fk.test(e)}var je=[];for(var Ws=0;Ws<256;++Ws)je.push((Ws+256).toString(16).substr(1));function Lk(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=(je[e[t+0]]+je[e[t+1]]+je[e[t+2]]+je[e[t+3]]+"-"+je[e[t+4]]+je[e[t+5]]+"-"+je[e[t+6]]+je[e[t+7]]+"-"+je[e[t+8]]+je[e[t+9]]+"-"+je[e[t+10]]+je[e[t+11]]+je[e[t+12]]+je[e[t+13]]+je[e[t+14]]+je[e[t+15]]).toLowerCase();if(!zk(n))throw TypeError("Stringified UUID is invalid");return n}function pl(e,t,n){e=e||{};var i=e.random||(e.rng||Vk)();if(i[6]=i[6]&15|64,i[8]=i[8]&63|128,t){n=n||0;for(var o=0;o<16;++o)t[n+o]=i[o];return t}return Lk(i)}function oo(){return pl()}const Bk=()=>oo(),Uk=()=>"pr"+oo(),Wk=()=>"vps"+oo(),Hk=()=>"VAP"+oo(),Gk=()=>oo(),Kk=new RegExp(/^[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i),Dv=e=>!!e&&Kk.test(e),Yk=["meta","validity","state"],Jk=["right","left"];var ml=(e=>(e.curve="curve",e.straight="straight",e.angular="angular",e))(ml||{});const Xk=["curve","straight","angular"];function Ov(e){return!!e}function fl(e){return rt("event",e)}function Ze(e){return rt("statev2",e)}function vt(e,t=""){return rt("state_value",e,t)}function Mv(e){return rt("process",e)}function rt(e,t,n=""){let i=!1;return n=typeof n=="string"?n:"",t?t.type!==e?n&&console.error(`wcomponent with id "${n}" is not a ${e}`):i=!0:n&&console.error(`wcomponent with id "${n}" does not exist`),i}function Le(e,t=""){return rt("action",e,t)}function _n(e,t=""){return rt("goal",e,t)}function Ho(e,t=""){return Le(e,void 0)||_n(e,t)}function hl(e,t=""){return rt("prioritisation",e,t)}function an(e){return rt("causal_link",e)}function Zk(e){return rt("relation_link",e)}function we(e){return an(e)||Zk(e)}function li(e){return e==="causal_link"||e==="relation_link"}function Qk(e){return fl(e)||Ze(e)||Mv(e)||Le(e)||_n(e)||so(e)||vt(e)||vl(e)||hl(e)}function pt(e,t=""){return rt("judgement",e,void 0)||rt("objective",e,t)}function so(e,t=""){return rt("sub_state",e,t)}function vl(e,t=""){return rt("counterfactualv2",e,t)}function e2(e){return we(e)}function gl(e){return e.event_at!==void 0}function wl(e){return e?e.deleted_at!==void 0:void 0}function ro(e){return e?e.deleted_at===void 0:void 0}function yi(e){const{validity:t}=e;return t!==void 0&&t.length>0}const t2=new Set(["prioritisation","counterfactualv2","sub_state"]);function qv(e){return!t2.has(e.type)}function Rn(e){return e.values_and_prediction_sets!==void 0}function n2(e){return(e==null?void 0:e.value_possibilities)!==void 0}function Ge(e){return Ze(e)||vt(e)||Le(e)}function ki(e){return Rn(e)&&e.values_and_prediction_sets.length>0&&Ge(e)}function i2(e){return e.calculations!==void 0}function o2(e){return Ze(e)||Le(e)}function q(e){const t={id:Bk(),created_at:new Date,base_id:e.base_id,title:"",description:"",type:"process"},n=e.custom_created_at||e.created_at||t.custom_created_at||t.created_at;let i;if(e.type==="causal_link"||e.type==="relation_link"){let o={...t,from_id:"",to_id:"",from_type:"state",to_type:"state",...e,type:e.type};an(o)&&(o={effect_string:"1",effect_when_true:1,effect_when_false:void 0,values_and_prediction_sets:[],...o}),i=o}else e.type==="judgement"||e.type==="objective"?i={...t,judgement_target_wcomponent_id:"",judgement_operator:"==",judgement_comparator_value:"True",judgement_manual:void 0,...e,type:e.type}:e.type==="statev2"?i={...t,subtype:void 0,values_and_prediction_sets:[],...e,type:e.type}:e.type==="prioritisation"?i={...t,title:io({date:n,time_resolution:"day"}),goals:{},datetime:{value:n},...e,type:e.type}:e.type==="goal"?i={...t,objective_ids:[],...e,type:e.type}:e.type==="action"?i={...t,values_and_prediction_sets:[],reason_for_status:"",depends_on_action_ids:[],...e,type:e.type}:i={...t,...e,type:e.type||"process"};return i}function qt(e,t){let n={...q(e),...bi(t)};return n=s2(n,t),n}function s2(e,t){const n=t.creation_context,i=t.use_creation_context&&n&&n.label_ids||[],o=e.label_ids||[],s=new Set(o);return i.forEach(r=>s.has(r)?"":o.push(r)),{...e,label_ids:o}}const zi=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})$/gi,r2=/^([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,Vv=/([0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})/gi,Fv=/@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}/gi,_2=/(.*)(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})(.*)/gi,a2=/^\s*(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\s*$/gi;function Jn(e,t=!1){return t?!!e.match(r2):!!e.match(zi)}const c2=/.*?(@@\w*\d+)\.([\w]+)/g,l2=/.*?(@@[0-9A-F]{8}-[0-9A-F]{4}-4[0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12})\.([\w]+)/gi;function bn(e){return(e.match(Fv)||[]).map(n=>n.slice(2))}function Au(e){return e.match(Vv)||[]}function Xn(e,t,n){e=e.trim();const i=e.match(Fv);if(i&&i[0]===e){const o=i[0].slice(2),s=n[o];t=s==null?void 0:s.units}return t}const d2=A.delay("apply_units_from_component",()=>{let e,t,n,i,o;const s=ie(1),r=ie(2),c=q({base_id:0,id:s,title:"Some state component",type:"statev2",units:"seconds"});n={[s]:c},t=`@@${s}`,e="",o="seconds",i=Xn(t,e,n),p(i,o,"Can access a wcomponent's value and uses its units when no units given by calculation"),t=`  @@${s}  `,e="",o="seconds",i=Xn(t,e,n),p(i,o,"Uses a wcomponent's units, even with surrounding whitespace"),t=`@@${s}`,e="Unitless",o="seconds",i=Xn(t,e,n),p(i,o,"Silently uses a wcomponent's units even when units given by calculation"),t=`@@${s} + 1`,e="meters",o="meters",i=Xn(t,e,n),p(i,o,"Ignores component units if calculation value is not just a @@uuid"),t=`@@${r}`,e="meters",o=void 0,i=Xn(t,e,n),p(i,o,"Defaults units to undefined when component can not be found, even if calculation has units given")}),u2=/.*?(\d*(?:\.\d+)?(?:e(?:-|\+)\d+)?\s*\%)/g;function pn(e){let t=e;return[...t.matchAll(u2)].forEach(i=>{const o=i[1];o&&(t=t.replace(o,"("+o.replace(/\s*\%/," * 0.01")+")"))}),t}const p2=A.delay("convert_percentages",()=>{let e="",t="",n="";e="90 %",t="(90 * 0.01)",n=pn(e),p(n,t,"Convert percentage symbol to numbers"),e="90 % / 10%",t="(90 * 0.01) / (10 * 0.01)",n=pn(e),p(n,t,"Convert percentage symbols without spaces to numbers"),e="90.123 %",t="(90.123 * 0.01)",n=pn(e),p(n,t,"Convert percentage symbols with decimal places"),e=".123 %",t="(.123 * 0.01)",n=pn(e),p(n,t,"Convert percentage symbols with decimal point and no leading digit"),e="90.123 % - -90.123 %",t="(90.123 * 0.01) - -(90.123 * 0.01)",n=pn(e),p(n,t,"Convert negative or positive percentage symbols"),e="9.1e+1 % - 9.1e-1 %",t="(9.1e+1 * 0.01) - (9.1e-1 * 0.01)",n=pn(e),p(n,t,"Convert scientific notation percentage symbols")}),Go={"£":"CURRENCY_POUND",$:"CURRENCY_DOLLAR","€":"CURRENCY_EURO","¥":"CURRENCY_YUAN_TWO",Ұ:"CURRENCY_YUAN_ONE","₹":"CURRENCY_RUPEE_RX","₨":"CURRENCY_RUPEE_RS","¢":"CURRENCY_GHANA_CEDI","؋":"CURRENCY_AFGHANISTAN_AFGHANI","฿":"CURRENCY_THAILAND_BAHT","៛":"CURRENCY_CAMBODIA_RIEL","₡":"CURRENCY_COSTA_RICA_COLON","₦":"CURRENCY_NIGERIA_NAIRA","₩":"CURRENCY_KOREA_WON","₪":"CURRENCY_ISRAEL_SHEKEL","₫":"CURRENCY_VIET_NAM_DONG","₭":"CURRENCY_LAOS_KIP","₮":"CURRENCY_MONGOLIA_TUGHRIK","₱":"CURRENCY_PESO","₴":"CURRENCY_UKRAINE_HRYVNIA","₼":"CURRENCY_AZERBAIJAN_MANAT","₽":"CURRENCY_RUSSIA_RUBLE","﷼":"CURRENCY_RIAL","B/.":"CURRENCY_PANAMA_BALBOA",ƒ:"CURRENCY_GUILDER",Kč:"CURRENCY_CZECH_REPUBLIC_KORUNA","S/.":"CURRENCY_PERU_SOL",zł:"CURRENCY_POLAND_ZLOTY",ден:"CURRENCY_MACEDONIA_DENAR","Дин.":"CURRENCY_SERBIA_DINAR",лв:"CURRENCY_LEV_TENGE_SOM","₺":"CURRENCY_TURKEY_LIRA"};function Gc(e){let t=e;return Object.entries(Go).forEach(([n,i])=>{t=t.replaceAll(n,i)}),t}function Ko(e){let t=e;return Object.entries(Go).forEach(([n,i])=>{t=t.replaceAll(new RegExp(i,"ig"),n)}),t}const m2=A.delay("currency symbols",()=>{const e=Object.keys(Go).join(""),t=Object.values(Go).join("");A("hide_currency_symbols",()=>{let n="",i="",o="";n=`${e}90 ${e} / year`,i=`${t}90 ${t} / year`,o=Gc(n),p(o,i,"Convert currency symbols to ascii strings")}),A("unhide_currency_symbols",()=>{let n="",i="",o="";n=`${t}90 ${t} / year`,i=`${e}90 ${e} / year`,o=Ko(n),p(o,i,"Converts currency ascii strings back to symbols"),n="Currency_pound90 Currency_pound / year",i="£90 £ / year",o=Ko(n),p(o,i,"Copes with Simulation.JS changing capitalisation of unit words")})}),Kc=new Set(["-parent","e","pi","phi","mod","expt","abs","sin","asin","cos","acos","tan","atan","sqrt","log","exp","round","floor","ceiling","RandBeta","RandDist","RandBoolean","Rand","RandNormal","RandExp","RandLognormal","RandBinomial","RandNegativeBinomial","RandGamma","RandPoisson","RandTriangular","Magnitude","Abs","sin","cos","tan","asin","acos","atan","arcsin","arccos","arctan","Sign","Sqrt","Ln","Log","Logit","Expit","Round","Ceiling","Floor","Exp","Sample","IndexOf","Contains","Collapse","Select","Reverse","Reverse","Sort","Sort","Unique","Unique","Union","Intersection","Difference","Factorial","Max","Max","Lookup","Fill","Min","Min","Mean","Mean","Sum","Sum","Product","Product","Median","Median","StdDev","StdDev","Correlation","Keys","Values","Length","Count","Flatten","CDFNormal","PDFNormal","InvNormal","CDFLogNormal","PDFLogNormal","InvLogNormal","CDFt","PDFt","Invt","CDFF","PDFF","InvF","CDFChiSquared","PDFChiSquared","InvChiSquared","CDFExponential","PDFExponential","InvExponential","CDFPoisson","PMFPoisson","SetRandSeed","Alert","Console","Prompt","Confirm","Parse","Split","Join","Trim","Range","Length","IndexOf","Contains","Lowercase","Uppercase","sqrt","sum","ifthenelse","ifthenelse","assert","assert","map","map","map","indexof","filter","map","select","filter","filter","join","repeat","repeat","join","reverse","join","sort","join","unique","unique","join","unique","unique","max","flatten","flatten","min","mean","sum","product","sort","median","mean","stddev","mean","mean","stddev","stddev","sum","count","count","join","flatten","join","flatten","stringbase","vectorbase","Stop","Pause","Time","TimeStep","TimeLength","TimeStart","TimeEnd","Seconds","Minutes","Hours","Days","Weeks","Months","Years","Seasonal","Unitless","RemoveUnits","PastMean","PastMedian","PastValues","PastStdDev","PastCorrelation","PastMax","PastMin","Pulse","Ramp","Step","Delay","Smooth","Delay1","Delay3","Remove","Add","FindAll","ResetTimer","Transition","Value","SetValue","FindIndex","FindState","FindNotState","FindNearby","FindNearest","FindFurthest","Index","Connect","Unconnect","Connected","ConnectionWeight","SetConnectionWeight","Width","Height","Distance","Location","SetLocation","Move","MoveTowards"]);[...Kc].forEach(e=>Kc.add(e.toLowerCase()));function Ue(e,t){let n=e;return n=f2(t,n),n}function f2(e,t){return e.forEach(n=>{const i=new RegExp(`@@${n}`,"g"),o=`[${n}]`;t=t.replace(i,o)}),t}const h2=A.delay("normalise_calculation_ids",()=>{const e=ie(1);let t="",n="",i="";t="[A] + 3",n="[A] + 3",i=Ue(t,[]),p(i,n,"Original square bracket IDs ignored"),t="[A] + B",n="[A] + [B]",i=Ue(t,[]);const o="Skipping for now as auto wrapping in square brackets is error prone and invalidates a lot of the SimulationJS keywords, syntax, language constructs.";p.skip(i,n,`${o} Non square bracket id put into square brackets`),t="A + [B]",n="[A] + [B]",i=Ue(t,[]),p.skip(i,n,`${o} Beginning with non square bracket id put into square brackets`),t="A-B",n="[A]-[B]",i=Ue(t,[]),p.skip(i,n,`${o} Non square bracket ids with no spaces and a negation sign between are put into square brackets`),t=`[A] + @@${e}`,n=`[A] + [${e}]`,i=Ue(t,[e]),p(i,n,"@@ uuid id put into square brackets"),t="B + B",n="[B] + [B]",i=Ue(t,[]),p.skip(i,n,`${o} Repeated non square bracket id dealt with correctly`),t="sin(1) + B",n="sin(1) + [B]",i=Ue(t,[]),p.skip(i,n,`${o} Simulation.js functions not processed into square brackets`),t="A>B",n="[A]>[B]",i=Ue(t,[]),p.skip(i,n,`${o} Simulation.js equality signs not processed into square brackets`),t="[Some agent].FindAll([Some state]) + B",n="[Some agent].FindAll([Some state]) + [B]",i=Ue(t,[]),p.skip(i,n,`${o} Simulation.js agent functions not processed into square brackets`),t="[ Some variable ] + [ another variable ]",n="[ Some variable ] + [ another variable ]",i=Ue(t,[]),p(i,n,"Existing square bracket id with spaces is not altered"),t="{4 miles} / {6.4e3 meters}",n="{4 miles} / {6.4e3 meters}",i=Ue(t,[]),p(i,n,"Units inside curly braces are left unaltered"),t="{7 Widgets/Years^2}",n="{7 Widgets/Years^2}",i=Ue(t,[]),p(i,n,"Compound units and those raised to power inside curly braces are left unaltered"),t=`{@@${e} meters}`,n=`{[${e}] meters}`,i=Ue(t,[e]),p.skip(i,n,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Double @ reference uuids and their units are preserved in curly braces~~"),t=`x <- 2
    If x > 10 Then
      'Big'
    Else
      'Small'
    End If`,n=t,i=Ue(t,[]),p(i,n,"Should not wrap variables, key words, or literal strings in square brackets")}),v2=/.*?\d{1,3}((?:,\d{3})+)/g;function Zn(e){let t=e;return[...t.matchAll(v2)].forEach(i=>{const o=i[0];o&&(t=t.replaceAll(o,o.replaceAll(",","")))}),t}const g2=A.delay("normalise_calculation_numbers",()=>{const e=ie(1);let t="",n="",i="";t=`B + [A] @@${e} + 3.1 + {4.2 km}`,n=`B + [A] @@${e} + 3.1 + {4.2 km}`,i=Zn(t),p(i,n,"Non and square bracket IDs, @@uuids, decimal numbers, and curly bracket numbers with units are left unchanged"),t="3,200 + 1,800.0",n="3200 + 1800.0",i=Zn(t),p(i,n,"Thousands commas are removed from numbers"),t="3,20 + 1,80.0",n="3,20 + 1,80.0",i=Zn(t),p(i,n,"Non-thousands commas are ignored"),t="1,200,300 10,300,400 100,200,300",n="1200300 10300400 100200300",i=Zn(t),p(i,n,"Thousands commas are removed from millions"),t="1,200,300,400 10,200,300,400 100,200,300,400",n="1200300400 10200300400 100200300400",i=Zn(t),p(i,n,"Thousands commas are removed from billions")});var N=(e=>(e[e.boolean=0]="boolean",e[e.number=1]="number",e[e.other=2]="other",e[e.action=3]="action",e[e.undefined=4]="undefined",e))(N||{});function qe(){return{id:Hk(),explanation:"",probability:0,conviction:1,value:"",description:""}}function bl(e,t){const n=e.length>1;let i=0;return e=e.map(o=>{const s=n?o.relative_probability===void 0?o.probability:o.relative_probability:void 0;return s!==void 0&&(i+=s),{...o,relative_probability:s}}),t!==N.boolean&&(i=i||1,e=e.map(o=>{const r=(o.relative_probability===void 0?1:o.relative_probability)/i;return{...o,probability:r}})),e}const zv=["potential","in progress","paused","completed","failed","rejected"];new Set(zv);var ge=(e=>(e.action_potential="action__value_possibility__potential_id",e.action_in_progress="action__value_possibility__in_progress_id",e.action_paused="action__value_possibility__paused_id",e.action_completed="action__value_possibility__completed_id",e.action_failed="action__value_possibility__failed_id",e.action_rejected="action__value_possibility__rejected_id",e))(ge||{});const ve={uncertainty:"value_possibility_uncertainty_id__undefined__",boolean_true:"value_possibility_true_id",boolean_false:"value_possibility_false_id",...ge},w2=["action__value_possibility__potential_id","action__value_possibility__in_progress_id","action__value_possibility__paused_id","action__value_possibility__completed_id","action__value_possibility__failed_id","action__value_possibility__rejected_id"],Yc={[ve.uncertainty]:"Uncertainty",[ve.boolean_true]:"True",[ve.boolean_false]:"False",[ve.action_potential]:"Potential",[ve.action_in_progress]:"In Progress",[ve.action_paused]:"Paused",[ve.action_completed]:"Completed",[ve.action_failed]:"Failed",[ve.action_rejected]:"Rejected"};function yl(e,t){return t===N.boolean?e.probability>.5:t===N.number?Lv(e.value):e.value}function Pe(e){return!Number.isNaN(Lv(e))}function Lv(e){if(e=e.trim(),e==="")return null;const t=e.split(",");for(let s=1;s<t.length;++s){let r=t[s]||"";if(r=r.split(/[^\d]/)[0]||"",r.length!==3)return Number.NaN}e=t.join("");const n=e.match(/^(-?[0-9]*\.?[0-9]*)\s*(?:(e)\s*(-?[0-9]+))?\s*(%)?$/);let i=NaN,o=!0;for(;o&&n;){const[,s,r,a,c]=n;if(!s||(i=parseFloat(s),Number.isNaN(i)))break;r&&a&&(i=i*10**parseInt(a)),c&&(i=i/100),o=!1}return i}function b2(e,t){let n=yl(e,t);return t===N.boolean&&(n=e.value_id===ve.boolean_true),n}function Qn(e,t){return e===N.boolean?t=[{value:"True",id:ve.boolean_true,order:0},{value:"False",id:ve.boolean_false,order:1}]:e===N.action?t=w2.map((n,i)=>({id:n,value:Yc[n]||"?",order:i})):t.length===0&&(e===N.number?["1"]:[""]).forEach((n,i)=>{t.push({value:n,order:i})}),t}const y2=A.delay("default_possible_values",()=>{const e=[{id:"730a7cb4-7523-45f7-bfde-a00d0acb9f65",value:"",description:"",order:0},{id:"724c4da6-f4ee-4680-a493-556ee241f29d",value:"",description:"",order:1}];let t=Qn(N.boolean,e);p.skip(t.length,1,"If boolean and given more than one value possibility, it should be reduced back to 1"),t=Qn(N.boolean,[]),p(t.length,2,"If boolean and no value possibilities, it should create 2"),t=Qn(N.action,[]),p(t.length,zv.length,"If action and no value possibilities, it should create the set"),t=Qn(N.other,[]),p(t.length,1,"If other and no value possibilities, it should create an empty value"),t=Qn(N.number,[]),p(t.length,1,"If other and no value possibilities, it should create an empty value")});function kl(e){let t=-1;if(e){let n;Array.isArray(e)?n=e:n=Object.values(e),n.forEach(({order:i=-1})=>t=Math.max(t,i))}return t}function k2(e){let t=kl(e);return e.map(i=>{const o=i.id||pl(),s=i.order??++t;return{description:"",...i,id:o,order:s}})}function yn(e,t,n){const i=x2(e,t,n);return k2(i)}function x2(e,t,n){const i=Object.values(t||{}).map(s=>({...s,id:void 0,value_id:s.id}));n.forEach(s=>{s.entries.forEach(({value_id:r,value:a})=>{i.push({value_id:r,value:a})})});const o=Bv(i,t);return Qn(e,o)}function Bv(e,t={}){let n=[];const i=new Set;let o=0;return e.forEach(({value_id:s})=>{const r=t[s||""];!r||i.has(r.value)||(n.push(r),o=Math.max(o,r.order),i.add(r.value))}),e.forEach(({value:s,value_id:r})=>{i.has(s)||(n.push({value:s,id:r,order:++o}),i.add(s))}),e.length===0&&(n=Object.values(t)),n.sort((s,r)=>(s.order??0)<(r.order??0)?-1:1)}const A2=A.delay("get_possibilities_from_VAP_sets",()=>{var s,r,a,c,l,d,u;const e=N.number,t="val_prob_id_123",n=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...qe(),value_id:t,value:"abc",description:""},{...qe(),value_id:void 0,value:"duplicated",description:""},{...qe(),value_id:void 0,value:"duplicated",description:""}]}];let i=yn(e,void 0,n);p(i.length,2,"Should get possibilities for all unique values and remove duplicates"),p((s=i[0])==null?void 0:s.value,"abc"),p.skip(((r=i[0])==null?void 0:r.id)!==t,!0,"Should set a new ID"),p((a=i[1])==null?void 0:a.value,"duplicated"),p(((c=i[1])==null?void 0:c.id)!==void 0,!0,"Should set a new ID if original is undefined");let o={[t]:{id:t,value:"new abc",description:"",order:1}};i=yn(e,o,n),p((l=i[0])==null?void 0:l.value,"new abc"),p((d=i[0])==null?void 0:d.id,t,"Should reuse existing ID"),p((u=i[1])==null?void 0:u.order,2,"Should increment off maximum order")});function Ee(e,t,n,i,o){const s=bi(o),r=S2(e,t,n),a=e===N.action?{value:new Date}:n.length>0?{value:new Date}:{};return{id:Wk(),...s,base_id:i,datetime:a,entries:r}}function S2(e,t,n){const o=yn(e,t,n).map(r=>({...qe(),value:r.value,value_id:r.id,description:r.description||""}));return bl(o,e)}function C2(e,t){return{...e,...bi(t),entries:e.entries.map(i=>({...i,explanation:""})),shared_entry_values:{...e.shared_entry_values,explanation:void 0}}}const $2=A.delay("prepare_new_VAP_set",()=>{const e=[{...Ee(N.other,void 0,[],1,{}),entries:[{...qe(),value_id:"1",value:"a"},{...qe(),value_id:"2",value:"b"}]},{...Ee(N.other,void 0,[],1,{}),entries:[{...qe(),value_id:"1",value:"a"},{...qe(),value_id:"2",value:"b"}]}],t={1:{id:"1",value:"a",description:"",order:0},2:{id:"2",value:"b",description:"",order:1}};let n=Ee(N.other,t,e,1,{});p(n.entries.length,2,"If there are only two unique possibilities, only return 2 VAPs")}),Uv="toggle_linked_datetime_sliders",j2=()=>({type:Uv}),T2=e=>e.type===Uv,Wv="set_display_time_sliders",P2=e=>({type:Wv,display_time_sliders:e}),N2=e=>e.type===Wv,Hv="toggle_display_time_sliders",E2=()=>({type:Hv}),I2=e=>e.type===Hv,Gv="set_or_toggle_display_side_panel",R2=e=>(typeof e!="boolean"&&(e=void 0),{type:Gv,display_side_panel:e}),D2=e=>e.type===Gv,Kv="set_or_toggle_display_select_storage",O2=e=>(typeof e!="boolean"&&(e=void 0),{type:Kv,display_select_storage:e}),M2=e=>e.type===Kv,q2={toggle_linked_datetime_sliders:j2,set_display_time_sliders:P2,toggle_display_time_sliders:E2,set_or_toggle_display_side_panel:R2,set_or_toggle_display_select_storage:O2},Yv="toggle_use_creation_context",V2=()=>({type:Yv}),F2=e=>e.type===Yv,Jv="set_custom_created_at",z2=e=>({type:Jv,...e}),L2=e=>e.type===Jv,Xv="set_label_ids",B2=e=>({type:Xv,...e}),U2=e=>e.type===Xv,Zv="set_replace_text",W2=e=>({type:Zv,...e}),H2=e=>e.type===Zv,G2={toggle_use_creation_context:V2,set_custom_created_at:z2,set_label_ids:B2,set_replace_text:W2},Qv="toggle_consumption_formatting",K2=e=>({type:Qv,...e}),Y2=e=>e.type===Qv,eg="set_or_toggle_focused_mode",J2=e=>({type:eg,focused_mode:e}),X2=e=>e.type===eg,tg="set_time_resolution",Z2=e=>({type:tg,...e}),Q2=e=>e.type===tg,ng="set_validity_filter",ex=e=>({type:ng,...e}),tx=e=>e.type===ng,ig="set_certainty_formatting",nx=e=>({type:ig,...e}),ix=e=>e.type===ig,og="set_display_by_simulated_time",ox=e=>({type:og,display_by_simulated_time:e}),sx=e=>e.type===og,sg="set_display_time_marks",rx=e=>({type:sg,display_time_marks:e}),_x=e=>e.type===sg,rg="set_or_toggle_animate_connections",ax=e=>({type:rg,animate_connections:e}),cx=e=>e.type===rg,_g="set_or_toggle_circular_links",lx=e=>({type:_g,circular_links:e}),dx=e=>e.type===_g,ag="set_show_help_menu",ux=e=>({type:ag,...e}),px=e=>e.type===ag,cg="set_or_toggle_show_large_grid",mx=e=>({type:cg,show_large_grid:e}),fx=e=>e.type===cg,lg="set_or_toggle_enable_angular_connections",hx=e=>({type:lg,enable_angular_connections:e}),vx=e=>e.type===lg,gx={toggle_consumption_formatting:K2,set_or_toggle_focused_mode:J2,set_time_resolution:Z2,set_validity_filter:ex,set_certainty_formatting:nx,set_display_by_simulated_time:ox,set_display_time_marks:rx,set_or_toggle_animate_connections:ax,set_or_toggle_circular_links:lx,set_show_help_menu:ux,set_or_toggle_show_large_grid:mx,set_or_toggle_enable_angular_connections:hx},dg="set_apply_filter",wx=e=>({type:dg,apply_filter:e}),bx=e=>e.type===dg,ug="set_filters",yx=e=>({type:ug,...e}),kx=e=>e.type===ug,xx={set_apply_filter:wx,set_filters:yx},pg="key_down",Ax=e=>({type:pg,...e}),Sx=e=>e.type===pg,mg="key_up",Cx=e=>({type:mg,...e}),$x=e=>e.type===mg,fg="clear_all_keys",jx=()=>({type:fg}),Tx=e=>e.type===fg,Px={key_down:Ax,key_up:Cx,clear_all_keys:jx},hg="set_action_ids_to_show",Nx=e=>({type:hg,...e}),Ex=e=>e.type===hg,Ix={set_action_ids_to_show:Nx},vg="change_route",Rx=e=>{const t=e.args;return t&&(t.x=Hs(t.x),t.y=Hs(t.y),t.zoom=Hs(t.zoom)),{type:vg,...e}};function Hs(e){return e===void 0?e:Math.round(e)}const gg=e=>e.type===vg,Dx={change_route:Rx};function Ft(e,t,n){return e[t]===n?e:{...e,[t]:n}}function D(e,t,n,i){const o=Ft(e[t],n,i);return Ft(e,t,o)}function rs(e,t,n,i,o){const s=Ft(e[t][n],i,o),r=Ft(e[t],n,s);return Ft(e,t,r)}function wg(e,t,n,i,o,s){const r=Ft(e[t][n][i],o,s),a=Ft(e[t][n],i,r),c=Ft(e[t],n,a);return Ft(e,t,c)}function Su(e,t){return e?Ox(e,t||""):new Date}function Ox(e,t){const n=new Date(e+" "+t);return Number.isNaN(n.getTime())?new Date:n}function bg(e){return e.ms===void 0?{ms:e.datetime.getTime(),datetime:e.datetime}:{ms:e.ms,datetime:new Date(e.ms)}}function Cu(e,t,n=console.warn){return t===void 0?e?e.getTime():void 0:(e!==void 0&&n("do not set both new_ms and new_datetime"),t)}const Mx=(e,t)=>{if(qx(t)){const{ms:n,datetime:i}=bg(t),o={...e.routing.args,created_at_datetime:i,created_at_ms:n};e.controls.linked_datetime_sliders&&(o.sim_datetime=i,o.sim_ms=n),e=D(e,"routing","args",o)}return e},yg="change_display_at_created_datetime",kg=e=>({type:yg,...e}),qx=e=>e.type===yg,Vx={change_display_at_created_datetime:kg},Fx=3600*1e3;function zx(e){setTimeout(()=>{e.dispatch(kg({datetime:new Date}))},Fx)}const Lx=(e,t)=>{if(Ux(t)){const{ms:n,datetime:i}=bg(t),o={...e.routing.args,sim_datetime:i,sim_ms:n};e.controls.linked_datetime_sliders&&(o.created_at_datetime=i,o.created_at_ms=n),e=D(e,"routing","args",o)}return e},xg="change_display_at_sim_datetime",Bx=e=>({type:xg,...e}),Ux=e=>e.type===xg,Wx={change_display_at_sim_datetime:Bx},Hx=(e,t)=>(Yx(t)&&(e=D(e,"search","search_fields",t.search_fields)),Xx(t)&&(e=D(e,"search","search_type",t.search_type)),e),xl="update_search_fields",Gx="update_search_type",Kx=e=>({type:xl,...e}),Yx=e=>e.type===xl,Jx=e=>({type:xl,...e}),Xx=e=>e.type===Gx,Zx={update_search_fields:Kx,update_search_type:Jx};function Ag(e,t={},n={},i={},o={},s={},r={},a={},c={}){return{...e,...t,...n,...i,...o,...s,...r,...a,...c}}const Sg="bulk_edit_knowledge_view_entries",Qx=e=>({type:Sg,...e}),eA=e=>e.type===Sg,Cg="bulk_update_knowledge_view_entries",tA=e=>({type:Cg,...e}),nA=e=>e.type===Cg,$g="snap_to_grid_knowledge_view_entries",iA=e=>({type:$g,...e}),oA=e=>e.type===$g,jg="change_current_knowledge_view_entries_order",sA=e=>({type:jg,...e}),rA=e=>e.type===jg,Tg="bulk_add_to_knowledge_view",_A=e=>({type:Tg,...e}),aA=e=>e.type===Tg,Pg="bulk_remove_from_knowledge_view",cA=e=>({type:Pg,...e}),lA=e=>e.type===Pg,dA={bulk_edit_knowledge_view_entries:Qx,bulk_update_knowledge_view_entries:tA,bulk_add_to_knowledge_view:_A,bulk_remove_from_knowledge_view:cA,snap_to_grid_knowledge_view_entries:iA,change_current_knowledge_view_entries_order:sA},Ng="upsert_knowledge_view_entry",uA=e=>({type:Ng,...e}),pA=e=>e.type===Ng,Eg="upsert_knowledge_view",mA=e=>({type:Eg,...e}),Ig=e=>e.type===Eg,fA={upsert_knowledge_view_entry:uA,upsert_knowledge_view:mA,...dA};function ut(e){return e&&(e.min||e.value||e.max)}function Al(e){return ut(e)===void 0}var ce=(e=>(e[e.ascending=0]="ascending",e[e.descending=1]="descending",e))(ce||{});function ue(e,t,n){const i=hA(n);return e.map((o,s)=>({item:o,key_value:t(o,s)})).sort(i).map(({item:o})=>o)}function hA(e){const t=e===0,n=t?-1:1,i=t?1:-1;return(o,s)=>o.key_value<s.key_value?n:o.key_value>s.key_value?i:0}function vA(e){return e.custom_created_at||e.created_at}function Ae(e){return vA(e).getTime()}function Sl(e){return ut(e.datetime)}function gA(e){const t=Sl(e);return t===void 0?void 0:t.getTime()}function _o(e){const{items:t,created_at_ms:n}=e,i=[],o=[];return t.forEach(s=>{Ae(s)>n?i.push(s):o.push(s)}),{invalid_future_items:i,current_items:o}}const wA=A.delay("partition_items_by_created_at_datetime",()=>{function e(m){const h=_o(m);return{invalid_future_items:h.invalid_future_items.map(({id:v})=>v),current_items:h.current_items.map(({id:v})=>v)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime(),u={base_id:-1,id:"1",created_at:s},f={base_id:-1,id:"2",created_at:a};t=[],n=e({items:t,created_at_ms:d}),p(n,{invalid_future_items:[],current_items:[]}),t=[u,f],n=e({items:t,created_at_ms:d}),p(n,{invalid_future_items:[],current_items:[u.id,f.id]}),n=e({items:t,created_at_ms:c}),p(n,{invalid_future_items:[],current_items:[u.id,f.id]}),n=e({items:t,created_at_ms:r}),p(n,{invalid_future_items:[f.id],current_items:[u.id]}),n=e({items:t,created_at_ms:o}),p(n,{invalid_future_items:[u.id,f.id],current_items:[]})});function ao(e){const t={};e.forEach(o=>{const s=t[o.id]||[];s.push(o),t[o.id]=s});const n={};return{latest:Object.values(t).map(o=>{const s=ue(o,Ae,ce.descending),r=s[0];return n[r.id]=s.slice(1),r}),previous_versions_by_id:n}}function me(e,t){return t?e.specialised_objects.wcomponents_by_id[t]:void 0}function Rg(e,t){return t=t||[],t=t instanceof Set?Array.from(t):t,t.map(n=>e[n])}function kn(e,t){return t=t||[],t=t instanceof Set?Array.from(t):t,t.map(n=>me(e,n))}function ne(e){return e.derived.current_composed_knowledge_view}function Be(e){return e.specialised_objects.knowledge_views_by_id[e.routing.args.subview_id]}function bA(e,t){const n=Be(e);if(!n)return!1;const i=n.wc_id_map[t];return!!i&&!i.passthrough}function di(e,t){return e.specialised_objects.knowledge_views_by_id[t]}function Dg(e,t){const n=new Set(e.map(r=>r.id));e=e.filter(r=>r.base_id===t);const i=new Set(e.map(r=>r.id)),o={top_ids:[],map:{}},s=[];return e.forEach(r=>{const{parent_knowledge_view_id:a,title:c,sort_type:l="normal"}=r;a?s.push({...r,parent_knowledge_view_id:a}):(o.top_ids.push(r.id),o.map[r.id]={id:r.id,title:c,sort_type:l,parent_id:void 0,child_ids:[]})}),Og(n,i,s,o,t),o}function Og(e,t,n,i,o){if(n.length===0)return;const s=[];if(n.forEach(r=>{const a=i.map[r.parent_knowledge_view_id];if(a){const{id:c,title:l,sort_type:d="normal"}=r;a.child_ids.push(c),i.map[c]={id:c,title:l,sort_type:d,parent_id:a.id,child_ids:[]}}else s.push(r)}),n.length===s.length){const r=s.filter(a=>a.base_id===o);r.length&&console.warn(`Maybe broken knowledge view tree.  Look in "Views" for:
 * ${r.map(a=>`${a.title} ${a.id}`).join(`
 * `)}`),s.forEach(({id:a,title:c,parent_knowledge_view_id:l})=>{i.top_ids.push(a);const d=t.has(l),u=!e.has(l),f=!d&&!u;i.map[a]={id:a,title:c,sort_type:"errored",parent_id:void 0,child_ids:[],ERROR_is_circular:d,ERROR_parent_kv_missing:u,ERROR_parent_from_diff_base:f}})}else Og(e,t,s,i,o)}function yA(e){e.top_ids=$u(e.top_ids,e.map),Object.values(e.map).forEach(t=>{t.child_ids=$u(t.child_ids,e.map)})}const kA={priority:"0",normal:"1",hidden:"2",archived:"3",errored:"4"};function $u(e,t){return ue(e,n=>{const i=t[n];return kA[i.sort_type]+i.title.toLowerCase()},ce.ascending)}function xA(e,t){return!!t[e]}function AA(e,t,n){const i=Cl(e,t,n);return ut(i==null?void 0:i.temporal_uncertainty)}function Cl(e,t,n){const i=t[e];if(fl(i)){const{event_at:o=[]}=i,s=o[0];if(!s)return;const r=s.datetime,a=s.probability*s.conviction;return{temporal_uncertainty:r,certainty:a}}else if(so(i)){const{target_wcomponent_id:o,selector:s}=i,r=t[o||""],a=Ge(r)&&r;if(!a||!s)return;const{target_VAP_set_id:c}=s;if(!c)return;let{values_and_prediction_sets:l}=a;l=l.filter(({id:u})=>u===c),l=_o({items:l,created_at_ms:n}).current_items,l=ue(l,Ae,ce.descending);const d=l[0];return ju(d)}else if(i&&ki(i)){const o=Mg(i);if(o)return ju(o)}}function Mg(e){let t=e.values_and_prediction_sets||[];t=ao(t).latest;const n=t[0];if(n&&t.length===1)return n;const i=t.filter(s=>!Al(s.datetime)),o=i[0];return o&&i.length===1?o:!1}function ju(e){var i;if(!e)return;let t;const n=(i=e.shared_entry_values)==null?void 0:i.conviction;return e.entries.forEach(o=>{const s=o.probability*(n!==void 0?n:o.conviction);t=Math.max(t||0,s)}),{temporal_uncertainty:e.datetime,certainty:t}}const SA=(e,t)=>{if($A(t)){const{id:n,highlighted:i}=t;let o=new Set(e.meta_wcomponents.highlighted_wcomponent_ids);n===void 0?o=new Set:i?o.add(n):o.delete(n),e=D(e,"meta_wcomponents","highlighted_wcomponent_ids",o);let{neighbour_ids_of_highlighted_wcomponent:s}=e.meta_wcomponents;if(e.display_options.focused_mode){const a=ne(e);if(a&&(s=new Set,n!==void 0&&t.highlighted)){const c=a.wc_id_connections_map[n];c&&(s=new Set(c),e.derived.wcomponent_ids_by_type.any_node.has(n)&&c.forEach(l=>{const d=a.wc_id_connections_map[l];d&&d.forEach(u=>s.add(u))}))}}else s.size&&(s=new Set);e=D(e,"meta_wcomponents","neighbour_ids_of_highlighted_wcomponent",s)}return e},qg="set_highlighted_wcomponent",CA=e=>({type:qg,id:e.id,highlighted:e.highlighted}),$A=e=>e.type===qg,jA={set_highlighted_wcomponent:CA},Vg="replace_all_specialised_objects",TA=e=>({type:Vg,...e}),Fg=e=>e.type===Vg,zg="clear_from_mem_all_specialised_objects",PA=()=>({type:zg}),Lg=e=>e.type===zg,NA={replace_all_specialised_objects:TA,clear_from_mem_all_specialised_objects:PA},Bg="bulk_edit_wcomponents",EA=e=>({type:Bg,...e}),IA=e=>e.type===Bg,RA={bulk_edit_wcomponents:EA},Ug="upsert_wcomponent",DA=e=>({type:Ug,...e}),_s=e=>e.type===Ug,Wg="delete_wcomponent",OA=e=>({type:Wg,...e}),MA=e=>e.type===Wg,Hg="add_wcomponents_to_store",qA=e=>({type:Hg,...e}),VA=e=>e.type===Hg,FA={upsert_wcomponent:DA,delete_wcomponent:OA,add_wcomponents_to_store:qA,...RA},zA=Ag(jA,NA,FA,fA),Gg="set_find_all_causal_paths_wcomponent_ids",LA=e=>({type:Gg,...e}),BA=e=>e.type===Gg,UA={set_find_all_causal_paths_wcomponent_ids:LA},Kg="clicked_wcomponent",WA=e=>({type:Kg,...e}),HA=e=>e.type===Kg,Yg="clear_selected_wcomponents",GA=()=>({type:Yg}),KA=e=>e.type===Yg,Jg="set_selected_wcomponents",YA=e=>({type:Jg,...e}),JA=e=>e.type===Jg,Xg="pointerupdown_on_connection_terminal",XA=e=>({type:Xg,...e}),Zg=e=>e.type===Xg,ZA=e=>Zg(e)&&e.up_down==="up",QA=e=>Zg(e)&&e.up_down==="down",Qg="pointerupdown_on_component",eS=e=>({type:Qg,...e}),ew=e=>e.type===Qg,tS=e=>ew(e)&&e.up_down==="up",nS=e=>ew(e)&&e.up_down==="down",tw="clear_pointerupdown_on_connection_terminal",iS=()=>({type:tw}),oS=e=>e.type===tw,nw="set_wcomponent_ids_to_move",sS=e=>({type:nw,...e}),rS=e=>e.type===nw,_S={clicked_wcomponent:WA,clear_selected_wcomponents:GA,set_selected_wcomponents:YA,pointerupdown_on_connection_terminal:XA,pointerupdown_on_component:eS,clear_pointerupdown_on_connection_terminal:iS,set_wcomponent_ids_to_move:sS},iw="set_frame_is_resizing",aS=e=>({type:iw,...e}),cS=e=>e.type===iw,lS=Ag({set_frame_is_resizing:aS},_S,UA),ow="update_sync_status",dS=e=>({type:ow,...e}),uS=e=>e.type===ow,sw="debug_refresh_all_specialised_object_ids_pending_save",pS=()=>({type:sw}),mS=e=>e.type===sw,rw="update_specialised_object_sync_info",fS=e=>({type:rw,...e}),_w=e=>e.type===rw,aw="update_network_status",hS=e=>({type:aw,...e}),vS=e=>e.type===aw,cw="request_searching_for_wcomponents_by_id_in_any_base",gS=e=>({type:cw,...e}),wS=e=>e.type===cw,lw="searching_for_wcomponents_by_id_in_any_base",bS=()=>({type:lw}),yS=e=>e.type===lw,dw="searched_for_wcomponents_by_id_in_any_base",kS=e=>({type:dw,...e}),xS=e=>e.type===dw,AS={update_sync_status:dS,debug_refresh_all_specialised_object_ids_pending_save:pS,update_specialised_object_sync_info:fS,update_network_status:hS,request_searching_for_wcomponents_by_id_in_any_base:gS,searching_for_wcomponents_by_id_in_any_base:bS,searched_for_wcomponents_by_id_in_any_base:kS},uw="set_user",SS=e=>({type:uw,...e}),CS=e=>e.type===uw,pw="set_need_to_handle_password_recovery",$S=e=>({type:pw,need_to_handle_password_recovery:e}),jS=e=>e.type===pw,mw="set_users",TS=e=>({type:mw,...e}),PS=e=>e.type===mw,fw="update_chosen_base_id",NS=e=>({type:fw,...e}),ES=e=>e.type===fw,hw="update_bases",IS=e=>({type:hw,...e}),RS=e=>e.type===hw,DS={set_user:SS,set_need_to_handle_password_recovery:$S,set_users:TS,update_chosen_base_id:NS,update_bases:IS},x={controls:q2,creation_context:G2,filter_context:xx,display:gx,sync:AS,routing:Dx,global_keys:Px,display_at_created_datetime:Vx,display_at_sim_datetime:Wx,search:Zx,specialised_object:zA,meta_wcomponents:lS,user_info:DS,view_priorities:Ix},nn={debug:e=>{console.debug(e)},log:e=>{console.log(e)},info:e=>{console.info(e)},warn:e=>{console.warn(e)},error:e=>{console.error(e)}};function vw(e){const{wcomponent_ids:t,knowledge_view_ids:n}=e.sync.specialised_object_ids_pending_save;return t.size+n.size>0}function OS(e){const{wcomponent_ids:t,knowledge_view_ids:n}=e.sync.specialised_object_ids_pending_save,o=t.values().next();if(!o.done)return{id:o.value,object_type:"wcomponent"};const r=n.values().next();if(!r.done)return{id:r.value,object_type:"knowledge_view"}}function MS(e){const{user:t,users_by_id:n}=e.user_info;return t&&n?n[t.id]:void 0}function as(e){const t=MS(e);return t==null?void 0:t.name}function $l(e){const{user:t,users_by_id:n}=e.user_info;return t&&n&&!as(e)}function co(e,t=""){const{bases_by_id:n,chosen_base_id:i}=e.user_info,o=n&&n[i||""];function s(r){t&&console.error(r+t)}return n||s("No state.user_info.bases_by_id present"),i===void 0&&s("No state.user_info.chosen_base_id present"),o===void 0&&s("No chosen_base present"),o}function qS(e){const t=co(e),n=_t(e);return t?t.title:n===void 0?"Not set":`Unknown Store: ${n}`}function gw(e){const{user:t,bases_by_id:n}=e.user_info;if(t&&n)return Object.values(n).filter(i=>i.can_edit)}function VS(e){const t=gw(e);return t===void 0?void 0:t.length>0}function _t(e){return e.user_info.chosen_base_id}function ww(e){const{bases_by_id:t}=e.user_info;return t===void 0?!1:VS(e)===!1&&co(e)===void 0}function FS(e){const t=co(e);return t==null?void 0:t.access_level}function We(e,t){return{id:Gk(),...bi(t),title:"",description:"",wc_id_map:{},goal_ids:[],sort_type:"normal",...e}}function zS(e){const t=e.store||Se(),n=_t(t.getState()),i={...e.knowledge_view,base_id:n},o=We(i,e.creation_context);t.dispatch(x.specialised_object.upsert_knowledge_view({knowledge_view:o}))}function Tu(e,t){t.dispatch(x.routing.change_route({route:"wcomponents",args:{subview_id:e}}))}function bw(e){const{last_source_of_truth_value:t,current_value:n,source_of_truth_value:i,get_custom_field_merger:o}=e;let s={...i},r=!1,a=[];return LS(n,t,i).forEach(l=>{const u=(o(l)||BS(l))(e);r=r||u.needs_save,u.unresolvable_conflict&&a.push(l),s[l]=u.value}),{value:s,needs_save:r,unresolvable_conflicted_fields:a}}function LS(...e){const t=new Set;return e.forEach(n=>{Object.keys(n).forEach(i=>{t.add(i)})}),Array.from(t)}function BS(e){const t=new Set(["needs_save","saving"]),n=new Set(["id","created_at","modified_at"]);function i(o){const s=o.source_of_truth_value[e],r=o.current_value[e];let a=!1,c=!1;return t.has(e)?{needs_save:a,unresolvable_conflict:c,value:r}:n.has(e)?{needs_save:a,unresolvable_conflict:c,value:s}:yw(e)(o)}return i}function yw(e){function t(i,o){return JSON.stringify(i)===JSON.stringify(o)}function n(i){const o=i.source_of_truth_value[e],s=i.current_value[e],r=i.last_source_of_truth_value[e];let a=!1,c=!1,l;return i.update_successful||t(o,r)?(l=s,a=!t(s,o)):(l=o,t(s,r)||(c=!t(s,o),c&&console.debug("unresolvable_conflict with field: ",e,"last_source_of_truth_field_value",r,"source_of_truth_field_value",o,"current_field_value",s))),{needs_save:a,unresolvable_conflict:c,value:l}}return n}function mn(e){return bw({...e,get_custom_field_merger:US})}function US(e){if(e!=="wc_id_map")return;function t(n,i){return JSON.stringify(n)===JSON.stringify(i)}return n=>{const i=n.source_of_truth_value.wc_id_map,o=n.current_value.wc_id_map,s=n.last_source_of_truth_value.wc_id_map;let r=!1,a=!1,c;return n.update_successful||t(i,s)?(c=o,r=!t(o,i)):(c=i,t(o,s)||Array.from(new Set(Object.keys(o).concat(Object.keys(i)))).forEach(d=>{const u=yw(d)({source_of_truth_value:i,current_value:o,last_source_of_truth_value:s,update_successful:n.update_successful});c[d]=u.value,u.unresolvable_conflict&&console.debug("unresolvable_conflict in wc_id_map with wc_id: ",d,"last_source_of_truth_value",s[d],"source_of_truth_value",i[d],"current_value",o[d]),r=r||u.needs_save,a=a||u.unresolvable_conflict})),{needs_save:r,unresolvable_conflict:a,value:c}}}const WS=A.delay("merge knowledge view functions",()=>{const e=new Date("2021-01-01"),t=new Date("2021-02-02");function n(o,s=!0){if(!o&&s)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return o?o.getTime():void 0}const i=o=>({left:o,top:o});A("should handle adding entry on client",()=>{const o=We({wc_id_map:{},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(1)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(1)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!0});p(n(a.value.modified_at),n(t)),p(a.value.wc_id_map,{0:i(1)}),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,[])}),A("should handle adding entries on client and remote",()=>{const o=We({wc_id_map:{},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(1)},needs_save:!0,saving:!0},r={...o,wc_id_map:{2:i(3)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.wc_id_map,{0:i(1),2:i(3)}),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,[])}),A("should handle nonconflicting changing different entries on client and remote",()=>{const o=We({wc_id_map:{0:i(1),2:i(3)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(4),2:i(3)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(1),2:i(5)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.wc_id_map,{0:i(4),2:i(5)}),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,[])}),A("should handle conflict changing same entries on client and remote",()=>{const o=We({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(3)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.wc_id_map,{0:i(2)}),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,["wc_id_map"])}),A("should handle resolveable conflict changing same entries on client and remote",()=>{const o=We({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(2)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.wc_id_map,{0:i(2)}),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,[])}),A("should handle non and conflict changes and second client change",()=>{const o=We({wc_id_map:{0:i(1)},modified_at:e,base_id:0}),s={...o,wc_id_map:{0:i(4),1:i(10)},needs_save:!0,saving:!0},r={...o,wc_id_map:{0:i(2)},modified_at:t},a=mn({last_source_of_truth_value:o,current_value:s,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.wc_id_map,{0:i(2),1:i(10)}),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,["wc_id_map"])})});function wt(e){return bw({...e,get_custom_field_merger:HS})}function HS(e){}const GS=A.delay("merge_wcomponent",()=>{const e=new Date("2021-01-01"),t=new Date("2021-02-02");function n(i,o=!0){if(!i&&o)throw new Error("Datetime is undefined.  Set warn_when_undefined = false?");return i?i.getTime():void 0}A("should handle update on client",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TB",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});p(n(a.value.modified_at),n(t)),p(a.value.title,"TB"),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,[])}),A("should handle nonconflicting updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TA",description:"DX",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.title,"TB"),p(a.value.description,"DX"),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,[])}),A("should handle conflicting updates",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TB",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TX",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.title,"TX"),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,["title"])}),A("should handle multiple updates on client",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TB",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});p(n(a.value.modified_at),n(t)),p(a.value.title,"TC"),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,[])}),A("should handle nonconflicting updates with multiple client updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TA",description:"DX",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.title,"TC"),p(a.value.description,"DX"),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,[])}),A("should handle conflicting updates with multiple client updates",()=>{const i=q({base_id:-1,title:"TA",modified_at:e}),o={...i,title:"TC",needs_save:!0,saving:!0},s={...i,title:"TB"},r={...i,title:"TX",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.title,"TX"),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,["title"])}),A("should handle non and conflicting updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TB",description:"DB",needs_save:!0,saving:!0},s={...i,title:"TB",description:"DB"},r={...i,title:"TA",description:"DX",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.title,"TB"),p(a.value.description,"DX"),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,["description"])}),A("should handle non and conflicting updates with multiple client updates",()=>{const i=q({base_id:-1,title:"TA",description:"DA",modified_at:e}),o={...i,title:"TC",description:"DC",needs_save:!0,saving:!0},s={...i,title:"TB",description:"DB"},r={...i,title:"TA",description:"DX",modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!1});p(n(a.value.modified_at),n(t)),p(a.value.title,"TC"),p(a.value.description,"DX"),p(a.needs_save,!0),p(a.unresolvable_conflicted_fields,["description"])}),A("should handle different custom created at",()=>{const i=q({base_id:-1,custom_created_at:new Date("2021"),modified_at:e}),o={...i,custom_created_at:new Date("2015"),needs_save:!0,saving:!0},s={...i,custom_created_at:new Date("2015")},r={...i,custom_created_at:new Date("2015"),modified_at:t},a=wt({last_source_of_truth_value:i,current_value:o,source_of_truth_value:r,update_successful:!0});p(n(a.value.modified_at),n(t)),p(new Date("2021"),new Date("2021")),p(a.value.custom_created_at,new Date("2015")),p(a.needs_save,!1),p(a.unresolvable_conflicted_fields,[])})});function KS(e,t){return e.sync.last_source_of_truth_specialised_objects_by_id.wcomponents[t||""]}function YS(e,t){return e.sync.last_source_of_truth_specialised_objects_by_id.knowledge_views[t||""]}const be=e=>e!==void 0;function lo(e){return e={...e},delete e.needs_save,delete e.saving,e}function Qi(e){return{...e,created_at:new Date(e.created_at),custom_created_at:Gi(e.custom_created_at),modified_at:Gi(e.modified_at),datetime:JS(e.datetime)}}const Gi=e=>e===void 0?void 0:new Date(e);function JS(e){if(e)return{...e,value:Gi(e.value),min:Gi(e.min),max:Gi(e.max)}}function jl(e,t,n=!1){e=lo(e);let i=e.wc_id_map;return n&&(i=XS(i)),e={...e,...Qi(e),wc_id_map:i,sort_type:e.sort_type||"normal"},e=ZS(e),e=QS(e),e}function XS(e){const t={...e};return Object.entries(t).forEach(([n,i])=>{i.passthrough&&delete t[n]}),t}function ZS(e){const t=e.goal_ids||[];return{...e,goal_ids:t}}function QS(e){const{wc_id_map:t}=e,n={...t};return Object.values(n).forEach(i=>{i.deleted&&(delete i.deleted,i.blocked=!0)}),{...e,wc_id_map:n}}async function kw(e){const t=e.converter_app_to_supabase(e.item),n=await e.supabase.from(e.table).insert(t).eq("id",t.id).select(),o=(n.data||[]).map(e.converter_supabase_to_app)[0];return{status:n.status,item:o,error:n.error||void 0}}const e3=1e3;async function cs(e){const t=e.offset||0,n=e.specific_ids?100:e3,i=t+n-1;let o=e.supabase.from(e.table).select().order("id",{ascending:!0});if(e.base_id!==void 0&&(o=o.eq("base_id",e.base_id)),e.specific_ids===void 0)o=o.range(t,i);else{const l=e.specific_ids.slice(t,i+1);o=o.in("id",l)}const s=await o;let r=s.error||void 0,a=(s.data||[]).map(l=>e.converter(l));const c=e.specific_ids&&t+n<e.specific_ids.length;if(!r&&(a.length===n||c)){const l=await cs({...e,offset:t+n});l.error?r=l.error:a=a.concat(l.value)}return{error:r,value:a}}function xw(e,t){if(t=e.base_id??t,t===void 0)throw new Error("Must provide base_id for app_item_to_supabase");const n=lo(e);return delete n.base_id,{id:e.id,modified_at:e.modified_at?e.modified_at.toISOString():void 0,base_id:t,json:n,title:e.title}}function Aw(e){let{json:t}=e;const{id:n,base_id:i,modified_at:o}=e,s=o?new Date(o+"Z"):void 0;return delete t.base_id,t={...t,id:n,base_id:i,modified_at:s},t}const Sw="knowledge_views";function Cw(e){return cs({...e,table:Sw,converter:Tl,specific_ids:e.ids})}async function t3(e){const t=e.wcomponents_from_other_bases.filter(r=>ro(r)),n=Array.from(new Set(t.map(r=>r.id))),i=new Set(e.knowledge_views.map(r=>r.id)),o=e.knowledge_views.map(r=>r.parent_knowledge_view_id).filter(be).filter(r=>!i.has(r));let s=n.concat(o);return e.knowledge_views.map(r=>r.foundation_knowledge_view_ids).forEach(r=>{r==null||r.filter(a=>!i.has(a)).forEach(a=>s.push(a))}),s=Array.from(new Set(s)),await Cw({supabase:e.supabase,ids:s,all_bases:!0})}async function n3(e){return e.knowledge_view.modified_at?o3(e):i3(e)}async function i3(e){return kw({supabase:e.supabase,table:Sw,item:e.knowledge_view,converter_app_to_supabase:$w,converter_supabase_to_app:Tl})}async function o3(e){const t=$w(e.knowledge_view),n=await e.supabase.rpc("update_knowledge_view",{item:t});if(n.status===401)return{status:n.status,error:{message:"JWT expired"},item:void 0};let i,o=n.error||void 0;try{let s=n.data;n.status===409&&(s=JSON.parse(n.error.details)),i=Tl(s)}catch(s){console.error("Exception whilst handling rpc update_knowledge_view response",s),o=s}return{status:n.status,error:o,item:i}}function $w(e,t){return xw(e,t)}function Tl(e){let t=Aw(e);return t=jl(t),t}function Pl(e){if(e=lo(e),e=s3(e),e=r3(e),e=_3(e),e={...Qi(e)},yi(e)&&(e.validity=e.validity.map(a3)),Rn(e)){const t=e.values_and_prediction_sets;e.values_and_prediction_sets=t&&t.map(c3)}return gl(e)&&(e.event_at=e.event_at.map(Qi)),we(e)&&(e.from_type=Pu(e.from_type),e.to_type=Pu(e.to_type),e.from_type=Nu(e.from_type),e.to_type=Nu(e.to_type)),e}function Pu(e){return e==="meta-effector"||e==="meta-effected"?"meta":e==="effector"||e==="effected"?"state":e||"state"}function Nu(e){return e==="value"?"state":e||"state"}function s3(e){return!Mv(e)||!e.is_action?e:{...e,is_action:void 0,type:"action"}}function r3(e){if(Le(e)){const t=e.depends_on_action_ids||[];e={...e,depends_on_action_ids:t}}return e}function _3(e){if(_n(e)){const t=e.objective_ids||[];e={...e,objective_ids:t}}return e}const a3=e=>Qi(e),c3=e=>Qi(e),Nl="wcomponents";function l3(e){return cs({...e,table:Nl,converter:ls,specific_ids:e.ids})}async function jw(e){const t=await cs({supabase:e.supabase,all_bases:!0,base_id:void 0,specific_ids:e.ids,table:Nl,converter:ls});return{error:t.error,wcomponents:t.value}}async function d3(e){const t=new Set(e.wcomponents.map(s=>s.id)),n=new Set;function i(s,r){s.forEach(a=>{if(!Jn(a)){console.trace(`Found invalid UUID "${a}".  Source of ids: "${r}"`);return}t.has(a)||n.add(a)})}e.knowledge_views.forEach(s=>{i(Object.keys(s.wc_id_map),`wc_id_map of knowledge view "${s.id}"`)}),e.wcomponents.forEach(s=>{const r=`wcomponent "${s.id}"`;i(s.label_ids||[],r);let a=bn(s.title);i(a,r),a=bn(s.description),i(a,r),Le(s)&&i(s.parent_goal_or_action_ids||[],r)});const o=Array.from(n);return await jw({supabase:e.supabase,ids:o})}async function u3(e){return e.wcomponent.modified_at?m3(e):p3(e)}async function p3(e){return kw({supabase:e.supabase,table:Nl,item:e.wcomponent,converter_app_to_supabase:Tw,converter_supabase_to_app:ls})}async function m3(e){const t=Tw(e.wcomponent),n=await e.supabase.rpc("update_wcomponent",{item:t});if(n.status===401)return{status:n.status,error:{message:"JWT expired"},item:void 0};let i,o=n.error||void 0;try{let s=n.data;n.status===409&&(s=JSON.parse(n.error.details)),i=ls(s)}catch(s){console.error("Exception whilst handling rpc update_wcomponent response",s),o=s}return{status:n.status,error:o,item:i}}function Tw(e,t){return{...xw(e,t),type:e.type,attribute_id:vt(e)?e.attribute_wcomponent_id:void 0}}function ls(e){let t=Aw(e);return t=Pl(t),t}function Pw(e){if(e){if("type"in e&&typeof e.type=="string")return e.type+": "+(e.message||"<no message>");if(`${e}`.includes("[object"))return JSON.stringify(e)}return`${e}`}let Ei=0;async function Nw(e,t=!1){const n=e.getState();if(!n.sync.ready_for_writing){const s=new Error(`Inconsistent state violation.  Save state called whilst state.sync.status: "${n.sync.specialised_objects.status}", ready_for_writing: ${n.sync.ready_for_writing}`);return nn.error(s),Promise.reject(s)}const i=OS(n);if(!i){const{wcomponent_ids:s,knowledge_view_ids:r}=n.sync.specialised_object_ids_pending_save,a=JSON.stringify(Array.from(s)),c=JSON.stringify(Array.from(r));if(e.dispatch(x.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})),t)return console.log(`No ids need to be saved: "${a}", "${c}"`),Promise.resolve();const l=new Error(`Inconsistent state violation.  No ids need to be saved: "${a}", "${c}"`);return nn.error(l),Promise.reject(l)}e.dispatch(x.sync.update_sync_status({status:"SAVING",data_type:"specialised_objects"}));let o;i.object_type==="knowledge_view"?o=f3(i.id,e):o=h3(i.id,e);try{Ei+=1,await o&&(Ei=0),Ei<10?e.dispatch(x.sync.update_sync_status({status:"SAVED",data_type:"specialised_objects"})):e.dispatch(x.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:"Try manually saving or refresh the page.  Failing that contact the team.",attempt:Ei}))}catch(s){nn.error(`Got error saving ${i.object_type} ${i.id}.  Error: ${s instanceof Error?s.message:s}`),e.dispatch(x.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:`${s}`,attempt:Ei}))}return Promise.resolve()}async function f3(e,t){const n="knowledge_view",i=di(t.getState(),e),o=Ew(e,t,n,i);if(o.error)return o.error;const s=o.initial_item,r=Ce(),a=await n3({supabase:r,knowledge_view:s}),c=Iw(e,t,n,a);if(c.error)return c.error;const{create_successful:l,update_successful:d,latest_source_of_truth_value:u}=c,f=YS(t.getState(),e),m=di(t.getState(),e);t.dispatch(x.specialised_object.upsert_knowledge_view({knowledge_view:u,is_source_of_truth:!0}));const h=Rw({object_type:n,initial_item:s,last_source_of_truth_value:f,current_value:m});if(h.error)return h.error;if(h.merge_args){const v=mn({...h.merge_args,source_of_truth_value:u,update_successful:d});v.needs_save&&t.dispatch(x.specialised_object.upsert_knowledge_view({knowledge_view:{...v.value},is_source_of_truth:!1})),v.unresolvable_conflicted_fields.length}return Promise.resolve(l||d)}async function h3(e,t){const n="wcomponent",i=me(t.getState(),e),o=Ew(e,t,n,i);if(o.error)return o.error;const s=o.initial_item,r=Ce(),a=await u3({supabase:r,wcomponent:s}),c=Iw(e,t,n,a);if(c.error)return c.error;const{create_successful:l,update_successful:d,latest_source_of_truth_value:u}=c,f=KS(t.getState(),e),m=me(t.getState(),e);t.dispatch(x.specialised_object.upsert_wcomponent({wcomponent:u,is_source_of_truth:!0}));const h=Rw({object_type:n,initial_item:s,last_source_of_truth_value:f,current_value:m});if(h.error)return h.error;if(h.merge_args){const v=wt({...h.merge_args,source_of_truth_value:u,update_successful:d});v.needs_save&&t.dispatch(x.specialised_object.upsert_wcomponent({wcomponent:{...v.value},is_source_of_truth:!1})),v.unresolvable_conflicted_fields.length}return Promise.resolve(l||d)}function Ew(e,t,n,i){return i?(t.dispatch(x.sync.update_specialised_object_sync_info({id:i.id,object_type:n,saving:!0})),{error:void 0,initial_item:i}):(t.dispatch(x.sync.debug_refresh_all_specialised_object_ids_pending_save()),{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${n}" but no item for id: "${e}".  Updating all specialised_object_ids_pending_save.`)),initial_item:void 0})}function Iw(e,t,n,i){const o=i.status===201,s=i.status===200;if(!o&&!s&&i.status!==409){const a=Pw(i.error);return{error:Promise.reject(new Error(`save_"${n}" got "${i.status}" error: "${a}"`)),create_successful:o,update_successful:s,latest_source_of_truth_value:void 0}}const r=i.item;return r?{error:void 0,create_successful:o,update_successful:s,latest_source_of_truth_value:r}:{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${n}" got "${i.status}" but no latest_source_of_truth_value item.  Error: "${JSON.stringify(i.error)}".`)),create_successful:o,update_successful:s,latest_source_of_truth_value:r}}function Rw(e){const{object_type:t,initial_item:n,last_source_of_truth_value:i,current_value:o}=e;return i?o?{error:void 0,merge_args:{last_source_of_truth_value:i,current_value:o}}:{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${t}" found "${t}" last_source_of_truth_value but no current_value for id "${n.id}".`)),merge_args:void 0}:n.modified_at?{error:Promise.reject(new Error(`Inconsistent state violation.  save_"${t}" found no last_source_of_truth_value "${t}" for id: "${n.id}" but "${t}" had a modified_at already set`)),merge_args:void 0}:{error:void 0,merge_args:void 0}}async function Dw(e){if(!v3(e,!0))return Promise.resolve();await Nw(e)}function v3(e,t){if(!e.load_state_from_storage)return!1;const n=e.getState(),{ready_for_writing:i,specialised_objects:o}=n.sync;return!(!i||t&&o.status==="FAILED"||t&&!vw(n))}async function Ow(e){const t=Se(),n=Ce();try{await Dw(t)}catch(i){nn.debug(`Error saving state before signout ${i}`)}try{if(e){nn.debug("Signing out with supabase.auth.signOut()");const{error:i}=await n.auth.signOut();localStorage.clear()}}catch(i){nn.debug(`Error signing out ${i}`)}window.location.reload()}const Mw=[];function g3(){window.addEventListener("focus",function(){Mw.forEach(e=>e())},!1)}function w3(e){Mw.push(e)}let Eu=!1;function b3(e){if(Eu){console.error("Already run register_window_focus_session_check");return}Eu=!0,w3(()=>{qw(e)})}async function qw(e){if(!e.load_state_from_storage)return;const t=Ce(),n=await y3(e,t);k3(n,e)}async function y3(e,t){var n,i,o;if(!e.getState().user_info.user)return console.log("User not signed in once yet."),0;try{console.log("On window focus event, checking connection and session with supabase.auth.getSession()");const s=await t.auth.getSession();if(((n=s.error)==null?void 0:n.message)==="Not logged in."||((i=s.error)==null?void 0:i.status)===401)return 1;if(((o=s.error)==null?void 0:o.message)==="Network request failed")return console.log("Network error"),2;if(s.error){debugger;return console.log("Unexpected error whilst check_connection_and_session",s.error),3}else return 4}catch(s){return console.error("Unexpected exception whilst check_connection_and_session",s),3}}function k3(e,t){if(e===0)return;if(e===1){nn.info("User not logged in.  Reloading page."),window.location.reload();return}else if(e===3){Ow(!1);return}let n=!0;switch(e){case 2:n=!1;break}t.dispatch(x.sync.update_network_status({network_functional:n,last_checked:new Date}))}function x3(e){let t="";e.subscribe(()=>{const n=e.getState(),i=Be(n);if(i&&i.title!==t){t=i.title;const o=(t?t+" | ":"")+ek.NAME;kv(o)}})}function A3(e){S3(e)}function S3(e){e.subscribe(()=>{const t=e.getState();t.routing.route,C3(t)&&e.dispatch(x.controls.set_or_toggle_display_side_panel(!0))})}function C3(e){return e.last_action?!e.controls.display_side_panel&&gg(e.last_action)&&e.last_action.route!==void 0&&(e.last_action.route==="search"||e.last_action.route==="filter"):!1}function Jc(e,t){let n;const i=()=>{n&&(clearTimeout(n),n=void 0)};let o;return{throttled:(...a)=>{i(),o=a,n=setTimeout(()=>{e(...a),o=void 0},t)},cancel:i,flush:()=>{i(),o&&(e(...o),o=void 0)}}}function Vw(e,t){let n;const i=()=>{n&&(clearTimeout(n),n=void 0)};let o={args:void 0},s;const r=(...l)=>(o.args=l,n||(n=setTimeout(()=>{e(...o.args),o.args=void 0,n=void 0},t),s=performance.now()+t),s);let a;return{throttled:r,cancel:i,flush:()=>(a||(a=new Promise(l=>{setTimeout(()=>{if(i(),a=void 0,o.args){const d=o.args;o.args=void 0,l(e(...d))}l(void 0)},0)})),a)}}function El(e={}){const t={};function n(s,r){const a=e[s];if(a){const d=a(r);if(!d.continue)return;r=d.message}const c=t[s];(c===void 0?[]:c).forEach(d=>{setTimeout(()=>d(r),0)})}function i(s,r){const a=t[s],c=a===void 0?[]:a;return c.push(r),t[s]=c,o(s,r)}function o(s,r){return()=>{const a=t[s],l=(a===void 0?[]:a).filter(d=>d!==r);t[s]=l}}return{pub:n,sub:i}}const Il=El({canvas_node_drag_relative_position:$3});let dn;function $3(e){const t=(dn==null?void 0:dn.left)!==e.left||(dn==null?void 0:dn.top)!==e.top;return dn=e,{continue:t,message:e}}function j3(e){Il.pub("throttled_canvas_node_drag_relative_position",e)}const T3=Vw(j3,30);Il.sub("canvas_node_drag_relative_position",T3.throttled);const P3=El(),N3=El(),H={canvas:Il,global_keys:P3,user:N3};function E3(e,t){t.ctrl_key&&t.key==="f"&&(t.event.preventDefault(),e.dispatch(x.routing.change_route({route:"search"})))}const Rl=uo(e=>Object.keys(e.composed_visible_wc_id_map)),Fw=uo((e,t)=>{const n=[...t],i=new Set(n),{wc_id_connections_map:o,composed_visible_wc_id_map:s}=e;return t.forEach(r=>{const a=o[r];a&&a.forEach(c=>{i.has(c)||s[r]&&(n.push(c),i.add(c))})}),n}),zw=uo((e,t,n)=>{const i=new Set(t),o=new Set,{wc_id_connections_map:s,composed_visible_wc_id_map:r,wc_ids_by_type:a}=e;return t.forEach(c=>{const l=s[c];if(!l)o.add(c);else{const d=Array.from(l).filter(u=>r[u]).filter(u=>i.has(u));if(d.length<=1)o.add(c);else if(a.any_node.has(c)){let u;Array.from(d).map(m=>n[m]).filter(we).find(m=>{const h=m.from_id===c;if(u===void 0)u=h;else if(u!==h)return!0;return!1})||o.add(c)}}}),t.filter(c=>!o.has(c))}),Lw=Uw("forward"),Bw=Uw("source");function Uw(e){const t=e==="forward";return uo((n,i,o)=>{const s=[...i],r=new Set(s);function a(d){r.has(d)||(r.add(d),s.push(d))}const{wc_id_connections_map:c,composed_visible_wc_id_map:l}=n;return i.forEach(d=>{const u=c[d];if(!u)return;Array.from(u).concat([d]).filter(m=>l[m]).map(m=>o[m]).filter(an).filter(m=>(t?m.from_id:m.to_id)===d||m.id===d).forEach(({id:m,from_id:h,to_id:v})=>{a(m),a(t?v:h)})}),s})}const Ww=uo((e,t)=>{const n=new Set(t),i=[...t],o=new Set(i),{wc_id_connections_map:s,composed_visible_wc_id_map:r}=e;function a(c){return!r[c]}return t.forEach(c=>{if(a(c))return;const l=s[c];l&&l.forEach(d=>{if(a(d))return;const u=s[d];u&&u.forEach(f=>{f!==c&&n.has(f)&&(a(f)||o.has(d)||(i.push(d),o.add(d)))})})}),i});function uo(e){return t=>{const n=t.getState(),i=ne(n);if(!i||!(n.routing.args.view==="knowledge"))return;const s=n.meta_wcomponents.selected_wcomponent_ids_list,{wcomponents_by_id:r}=n.specialised_objects,a=e(i,s,r);t.dispatch(x.meta_wcomponents.set_selected_wcomponents({ids:a})),t.dispatch(x.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))}}function I3(e){D3(e)}function R3(e,t){t.key==="a"&&t.ctrl_key&&(t.event.preventDefault(),Rl(e))}function D3(e){H.canvas.sub("canvas_area_select",t=>{const n=e.getState(),i=ne(n);if(!i||!(n.routing.args.view==="knowledge"))return;const{start_x:s,start_y:r,end_x:a,end_y:c}=t,l=-r,d=-c,u=Object.entries(i.composed_visible_wc_id_map).filter(([h,v])=>v.left>=s&&v.left<=a&&v.top<=l&&v.top>=d).map(([h])=>h).filter(h=>!i.wc_ids_by_type.any_link.has(h)),f=n.global_keys.keys_down.has("Control"),m=O3(f,n,u);e.dispatch(x.meta_wcomponents.set_selected_wcomponents({ids:m})),e.dispatch(x.routing.change_route({sub_route:"wcomponents_edit_multiple",item_id:null}))})}function O3(e,t,n){let i=[];if(e){const o=new Set(t.meta_wcomponents.selected_wcomponent_ids_set);n.forEach(s=>o.delete(s)),i=Array.from(o)}else{const o=t.meta_wcomponents.selected_wcomponent_ids_list,s=new Set(o),r=n.filter(a=>!s.has(a));i=o.concat(r)}return i}function M3(e){q3(e)}function q3(e){let t="";H.global_keys.sub("key_down",n=>{if(t){V3(t,n,e);return}const i=n.ctrl_key&&F3.has(n.key);if(t=i?t=n.key:"",i){n.event.preventDefault();return}n.ctrl_key&&n.key==="e"?(n.event.preventDefault(),e.dispatch(x.display.toggle_consumption_formatting({}))):n.shift_key&&n.key==="?"?(n.event.preventDefault(),e.getState().display_options.show_help_menu||e.dispatch(x.display.set_show_help_menu({show:!0}))):(R3(e,n),E3(e,n))}),H.global_keys.sub("key_up",n=>{n.key==="Control"&&(t="")})}function V3(e,t,n){let i=!1;e==="d"?i=z3(t.key,n):e==="s"&&(i=L3(t.key,n)),i&&t.event.preventDefault()}const F3=new Set(["d","s"]);function z3(e,t){let n=!0;return e==="f"?t.dispatch(x.display.set_or_toggle_focused_mode()):e==="t"?t.dispatch(x.controls.toggle_display_time_sliders()):e==="s"?t.dispatch(x.controls.set_or_toggle_display_side_panel()):e==="a"?t.dispatch(x.display.set_or_toggle_animate_connections()):e==="c"?t.dispatch(x.display.set_or_toggle_circular_links()):n=!1,n}function L3(e,t){let n=!0;return e==="a"?Rl(t):e==="e"?Fw(t):e==="d"?zw(t):e==="f"?Lw(t):e==="c"?Bw(t):e==="i"?Ww(t):n=!1,n}function B3(e){document.onkeydown=t=>{const n={event:t,time_stamp:t.timeStamp,alt_key:t.altKey,code:t.code,ctrl_key:t.ctrlKey,key:t.key,meta_key:t.metaKey,shift_key:t.shiftKey};e.dispatch(x.global_keys.key_down(n)),H.global_keys.pub("key_down",n)},document.onkeyup=t=>{const n={event:t,time_stamp:t.timeStamp,alt_key:t.altKey,code:t.code,ctrl_key:t.ctrlKey,key:t.key,meta_key:t.metaKey,shift_key:t.shiftKey};e.dispatch(x.global_keys.key_up(n)),H.global_keys.pub("key_up",n)},window.onfocus=()=>{e.getState().global_keys.keys_down.size!==0&&e.dispatch(x.global_keys.clear_all_keys())}}function Dn(e,t){const n={};return e.forEach(i=>{n[i]=t[i]}),n}function U3(e){const t=Dn(["display_time_sliders","display_side_panel"],e.controls);Nn("controls",t)}function W3(e){const t=Pn("controls");return{linked_datetime_sliders:!1,display_time_sliders:!1,display_side_panel:!0,display_select_storage:e.storage_location===void 0,...t}}function H3(e){const t=Dn(["use_creation_context","creation_context"],e.creation_context);Nn("creation_context",t)}function G3(){const e=Pn("creation_context"),{use_creation_context:t=!1,creation_context:n={custom_created_at:void 0,label_ids:[]}}=e;let{custom_created_at:i}=n;return i=i&&new Date(i),n.custom_created_at=i,{use_creation_context:t,creation_context:n}}function Hw(e){return{only_certain_valid:e==="only_certain_valid",only_maybe_valid:e==="only_maybe_valid",maybe_invalid:e==="maybe_invalid",show_invalid:e==="show_invalid"}}function Gw(e){return{render_certainty_as_opacity:e==="render_certainty_as_opacity",render_certainty_as_easier_opacity:e==="render_certainty_as_easier_opacity",render_100_opacity:e==="render_100_opacity"}}function K3(e){const t=Dn(["consumption_formatting","time_resolution","display_by_simulated_time","display_time_marks","animate_connections","circular_links","show_large_grid","validity_filter","certainty_formatting","enable_angular_connections"],e.display_options);Nn("display_options",t)}function Y3(){const e=Pn("display_options"),t=e.validity_filter||"show_invalid",n=e.certainty_formatting||"render_certainty_as_opacity",i=Hw(t),o=Gw(n);return{consumption_formatting:!0,focused_mode:!1,time_resolution:"minute",display_by_simulated_time:!1,display_time_marks:!1,animate_connections:!1,circular_links:!0,show_help_menu:!1,show_large_grid:!1,validity_filter:t,certainty_formatting:n,derived_validity_filter:i,derived_certainty_formatting:o,enable_angular_connections:!1,...e}}function J3(e){const t=Dn(["apply_filter","filters"],e.filter_context);Nn("filter_context",t)}function X3(){const e=Pn("filter_context");e.filters instanceof Array&&delete e.filters;const{apply_filter:t=!1,filters:n={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""}}=e;return{apply_filter:t,filters:n}}function Z3(e){const t=Dn(["search_fields","search_type"],e.search);Nn("search",t)}function Q3(){return{search_fields:"all",search_type:"best",...Pn("search")}}function eC(e){const t=Dn([],e.sync);Nn("sync",t)}function tC(){const e=Pn("sync"),t={status:void 0,error_message:"",retry_attempt:void 0,loading_base_id:void 0};return{last_source_of_truth_specialised_objects_by_id:{wcomponents:{},knowledge_views:{}},specialised_object_ids_pending_save:{wcomponent_ids:new Set,knowledge_view_ids:new Set},specialised_objects_save_conflicts:{wcomponent_conflicts_by_id:{},knowledge_view_conflicts_by_id:{}},ready_for_reading:!1,ready_for_writing:!1,network_functional:!0,network_function_last_checked:void 0,wcomponent_ids_to_search_for_in_any_base:new Set,wcomponent_ids_searching_for_in_any_base:new Set,wcomponent_ids_searched_for_in_any_base:new Set,bases:{...t},specialised_objects:{...t},...e}}const nC={wcomponents_by_id:{},knowledge_views_by_id:{}},iC=void 0,{wcomponents_by_id:oC,knowledge_views_by_id:sC}=nC,rC=Object.values(oC).map(Pl),_C=Object.values(sC).map(e=>jl(e)),aC={wcomponents:rC,knowledge_views:_C};function cC(e){const t=Dn(["has_signed_in_at_least_once","chosen_base_id"],e.user_info);Nn("user_info",t)}function lC(e){const t=Pn("user_info"),i=(a=>document.location.hash.includes(a))("type=recovery"),o=e.storage_location!==void 0?e.storage_location:t.chosen_base_id;return{has_signed_in_at_least_once:!1,user:iC,need_to_handle_password_recovery:i,users_by_id:void 0,bases_by_id:void 0,...t,chosen_base_id:o}}function dC(e){H3(e),U3(e),K3(e),J3(e),Z3(e),eC(e),cC(e)}const uC=(e,t)=>{if(T2(t)){const n=!e.controls.linked_datetime_sliders;e=D(e,"controls","linked_datetime_sliders",n)}if(N2(t)){const{display_time_sliders:n}=t;e=D(e,"controls","display_time_sliders",n)}if(I2(t)){const{display_time_sliders:n}=e.controls;e=D(e,"controls","display_time_sliders",!n)}if(D2(t)){const{display_side_panel:n}=e.controls,i=t.display_side_panel??!n;e=D(e,"controls","display_side_panel",i)}if(M2(t)){const{display_select_storage:n}=e.controls,i=t.display_select_storage??!n;e=D(e,"controls","display_select_storage",i)}return e},pC=(e,t)=>{if(F2(t)){const i=!e.creation_context.use_creation_context;e=D(e,"creation_context","use_creation_context",i)}let n=!1;if(L2(t)){const i={label_ids:[],...e.creation_context.creation_context,custom_created_at:t.custom_created_at};e=D(e,"creation_context","creation_context",i),n=n||!!t.custom_created_at}if(U2(t)){const i={...e.creation_context.creation_context,label_ids:t.label_ids};e=D(e,"creation_context","creation_context",i),n=n||t.label_ids.length>0}if(H2(t)){const i={label_ids:[],...e.creation_context.creation_context};t.value_type==="target"?i.replace_text_target=t.value:i.replace_text_replacement=t.value,e=D(e,"creation_context","creation_context",i)}return n&&(e=D(e,"creation_context","use_creation_context",!0)),e};function mC({probability:e,conviction:t}){return e>0&&e<1||t!==1}function Kw({probability:e,conviction:t}){return Math.min(e,t)}var Y=(e=>(e[e.past=0]="past",e[e.present=1]="present",e[e.future=2]="future",e[e.eternal=3]="eternal",e))(Y||{});function he(e,t){const{min:n,value:i,max:o}=e.datetime||{},[s,r]=n===void 0?[!1,0]:[!0,n.getTime()],[a,c]=i===void 0?[!1,0]:[!0,i.getTime()],[l,d]=o===void 0?[!1,0]:[!0,o.getTime()];if(s){if(r>t)return Y.future;if(r===t||!l&&r<t)return Y.present}if(l)return d<=t?Y.past:Y.present;if(a){if(c<t)return Y.past;if(c===t)return Y.present;if(c>t)return Y.future}return Y.eternal}const fC=A.delay("get_tense_of_uncertain_datetime",()=>{let e;const n=new Date("2021-04-01 00:01").getTime(),i=new Date("2021-04-01 00:02"),o=i.getTime(),s=new Date("2021-04-01 00:03"),r=s.getTime(),a=new Date("2021-04-01 00:04"),c=a.getTime(),d=new Date("2021-04-01 00:05").getTime();e=he({datetime:{}},n),p(e,Y.eternal),e=he({datetime:{min:i}},n),p(e,Y.future),e=he({datetime:{min:i}},o),p(e,Y.present),e=he({datetime:{min:i}},r),p(e,Y.present),e=he({datetime:{value:i}},n),p(e,Y.future),e=he({datetime:{value:i}},o),p(e,Y.present),e=he({datetime:{value:i}},r),p(e,Y.past),e=he({datetime:{max:i}},n),p(e,Y.present),e=he({datetime:{max:i}},o),p(e,Y.past),e=he({datetime:{max:i}},r),p(e,Y.past),e=he({datetime:{min:i,max:s}},n),p(e,Y.future),e=he({datetime:{min:i,max:s}},o),p(e,Y.present),e=he({datetime:{min:i,max:s}},r),p(e,Y.past),e=he({datetime:{min:i,max:s}},c),p(e,Y.past),e=he({datetime:{min:i,value:s,max:a}},n),p(e,Y.future),e=he({datetime:{min:i,value:s,max:a}},o),p(e,Y.present),e=he({datetime:{min:i,value:s,max:a}},r),p(e,Y.present),e=he({datetime:{min:i,value:s,max:a}},c),p(e,Y.past),e=he({datetime:{min:i,value:s,max:a}},d),p(e,Y.past)});function hC(e){const{items:t,sim_ms:n}=e,i=po(t);return Yw({sorted_items:i,sim_ms:n})}function po(e,t=ce.descending){return ue(e,({datetime:i})=>{if(Al(i))return Number.NEGATIVE_INFINITY;const{max:o,value:s,min:r}=i;return r?r.getTime()*10+2:s?s.getTime()*10+1:o?o.getTime()*10:1},t)}function Yw(e){const{sorted_items:t,sim_ms:n}=e;let i=[],o=[],s=[];const r=[];t.forEach(c=>{const l=he(c,n);l===Y.past?i.push(c):l===Y.future?r.push(c):l===Y.present?o.push(c):s.push(c)}),o.length!==1&&(o.length>1?(i=o.slice(1).concat(i),o=o.slice(0,1)):i.length&&(o=i.slice(0,1),i=i.slice(1))),s.length&&(o.length!==1&&(o=s.slice(0,1),s=s.slice(1)),i=i.concat(s));const a=o[0];return{past_items:i,present_item:a,future_items:r}}const vC=A.delay("partition_sorted_items_by_datetimes",()=>{function e(u){var m;const f=Yw(u);return{past_items:f.past_items.map(({id:h})=>h),present_item:(m=f.present_item)==null?void 0:m.id,future_items:f.future_items.map(({id:h})=>h)}}let t,n;const o=new Date("2021-04-01 00:00").getTime(),s=new Date("2021-04-01 00:01"),r=s.getTime(),a=new Date("2021-04-01 00:02"),c=a.getTime(),d=new Date("2021-04-01 00:03").getTime();t=[],n=e({sorted_items:t,sim_ms:d}),p(n,{past_items:[],present_item:void 0,future_items:[]}),t=[{id:"10",datetime:{}},{id:"11",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),p(n,{past_items:["11"],present_item:"10",future_items:[]},"Can handle multiple eternal elements"),t=[{id:"30",datetime:{value:a}},{id:"20",datetime:{value:s}},{id:"10",datetime:{}}],n=e({sorted_items:t,sim_ms:o}),p(n,{past_items:[],present_item:"10",future_items:["30","20"]},"Should partition eternal item as present if other items are in the future"),n=e({sorted_items:t,sim_ms:r}),p(n,{past_items:["10"],present_item:"20",future_items:["30"]},"Should partition eternal item as past if other items are in the present"),n=e({sorted_items:t,sim_ms:c}),p(n,{past_items:["20","10"],present_item:"30",future_items:[]},"Should partition eternal item and other past items as past if other items are in the present"),n=e({sorted_items:t,sim_ms:d}),p(n,{past_items:["20","10"],present_item:"30",future_items:[]}),t=[{id:"40",datetime:{min:s}}],n=e({sorted_items:t,sim_ms:r}),p(n,{past_items:[],present_item:"40",future_items:[]},"Should find min datetime as present when sim_ms is equal to min datetime"),n=e({sorted_items:t,sim_ms:o}),p(n,{past_items:[],present_item:void 0,future_items:["40"]},"Should find min datetime as future when sim_ms is before min datetime"),t=[{id:"50",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:r}),p(n,{past_items:[],present_item:"50",future_items:[]},"Should find max datetime as present when sim_ms is equal to max datetime"),t=[{id:"50",datetime:{max:s}},{id:"60",datetime:{max:s}}],n=e({sorted_items:t,sim_ms:c}),p(n,{past_items:["60"],present_item:"50",future_items:[]},"Should find max datetime as past when sim_ms is later than max datetime but when no other item is present, will use one as present item")}),gC=A.delay("sort_by_uncertain_event_datetimes",()=>{function e($){return po($).map(({id:C})=>C)}function t($,R){const C=[...$].reverse(),O=R.map(({id:P})=>P);i=e($);const M=e(C);p(i,M,"",!1),p(i,O,"",!1)}let n=[],i,o;const s=new Date("2021-04-01 00:00"),r=new Date("2021-04-01 00:01"),a=new Date("2021-04-01 00:02"),c=new Date("2021-04-01 00:03");let l=0;const d=()=>`${l++}`,u={id:d(),datetime:{}},f={id:d(),datetime:{}},m={id:d(),datetime:{value:r}},h={id:d(),datetime:{value:a}},v={id:d(),datetime:{max:r}},g={id:d(),datetime:{max:a}},b={id:d(),datetime:{min:r}},w={id:d(),datetime:{min:a}},k={id:d(),datetime:{min:s,max:c}},y={id:d(),datetime:{min:r,max:a}};n=[],i=e(n),p(i,[],"",!1),n=[u,f];const S=[...n].reverse();i=e(n);const T=e(S);p(JSON.stringify(i)!==JSON.stringify(T),!0,"Should be different (indeterminant sort)"),n=[u,m,h],o=[h,m,u],t(n,o),n=[u,b,w],o=[w,b,u],t(n,o),n=[u,v,g],o=[g,v,u],t(n,o),n=[u,m,h,b,w,v,g],o=[w,h,g,b,m,v,u],t(n,o),n=[u,k,y],o=[y,k,u],t(n,o)});function xn(e){const{invalid_future_items:t,current_items:n}=_o(e),{latest:i,previous_versions_by_id:o}=ao(n),s=hC({items:i,sim_ms:e.sim_ms});return{invalid_future_items:t,...s,previous_versions_by_id:o}}function wC(e,t){const n=Jw(e,t);return po(n)}function Jw(e,t){const{current_items:n}=_o({items:e,created_at_ms:t}),{latest:i}=ao(n);return i}const bC=A.delay("partition_and_prune_items_by_datetimes_and_versions",()=>{const e=new Date("2021-04-01 00:00"),t=new Date("2021-04-01 00:01"),n=new Date("2021-04-01 00:02");function i(s){return s.map((r,a)=>({base_id:-1,id:`vps${a}`,created_at:t,version:1,datetime:{},entries:[],...r}))}let o=i([{datetime:{value:e},id:"vap_set_0"},{datetime:{value:t},id:"vap_set_1"},{datetime:{value:n},id:"vap_set_2"}]);A("all items created in future",()=>{const s=xn({items:o,created_at_ms:e.getTime(),sim_ms:t.getTime()});p(s.invalid_future_items,o,"should have all invalid future items"),p(s.past_items,[],"should have no past items"),p(s.present_item,void 0,"should have no present item"),p(s.future_items,[],"should have no future items"),p(s.previous_versions_by_id,{},"should have empty map of previous versions")}),A("all items created in past, sim_ms in middle",()=>{const s=xn({items:o,created_at_ms:t.getTime(),sim_ms:t.getTime()});p(s.invalid_future_items,[],"should have no invalid future items"),p(s.past_items,[o[0]],"vap_set_0 should be the one past item"),p(s.present_item,o[1],"vap_set_1 should be the one present item"),p(s.future_items,[o[2]],"vap_set_2 should be the one future item"),p(s.previous_versions_by_id,{vap_set_0:[],vap_set_1:[],vap_set_2:[]},"vap sets should have no previous versions")})}),Dl=()=>({is_valid:!0,certainty:1});function Ol(e){const{wcomponent:t,created_at_ms:n,sim_ms:i}=e;if(!yi(t))return;const o=xn({items:t.validity,created_at_ms:n,sim_ms:i}).present_item;if(!o)return;const s=o.probability>.5,r=Kw(o);return{is_valid:s,certainty:r}}function Xw(e){const{wcomponents_by_id:t,created_at_ms:n}=e,i={...t};return Object.keys(e.composed_visible_wc_id_map||{}).forEach(o=>{const s=t[o];if(s&&vt(s)){const r=t[s.attribute_wcomponent_id||""];if(!Ze(r))return;let a;s.values_and_prediction_sets&&(a=_o({items:s.values_and_prediction_sets,created_at_ms:n}).current_items,a=ue(a,Ae,ce.descending));const c={...r,values_and_prediction_sets:a,value_possibilities:s.value_possibilities,_derived__using_value_from_wcomponent_id:s.id};i[c.id]=c}}),i}function yC(e,t){var c,l;const n=e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id,i=(c=e.derived.current_composed_knowledge_view)==null?void 0:c.composed_visible_wc_id_map,o=(l=t.derived.current_composed_knowledge_view)==null?void 0:l.composed_visible_wc_id_map;if(!(n||i!==o))return t;const a=kC(t);return t=D(t,"derived","composed_wcomponents_by_id",a),t}function kC(e){const{wcomponents_by_id:t}=e.specialised_objects,{composed_visible_wc_id_map:n}=e.derived.current_composed_knowledge_view||{},{created_at_ms:i}=e.routing.args;return Xw({composed_visible_wc_id_map:n,wcomponents_by_id:t,created_at_ms:i})}function xC(e,t){return e.has(t)||(e=new Set(e),e.add(t)),e}function AC(e,t){return e.has(t)&&(e=new Set(e),e.delete(t)),e}function xt(...e){let t=[];return e.forEach(n=>t=t.concat(Array.from(n))),new Set(t)}function SC(e,t){const n=new Set(e);return t.forEach(i=>n.delete(i)),n.size===e.size?e:n}function Zw(){return{event:new Set,statev2:new Set,state_value:new Set,sub_state:new Set,multidimensional_state:new Set,process:new Set,action:new Set,actor:new Set,causal_link:new Set,relation_link:new Set,judgement:new Set,objective:new Set,counterfactualv2:new Set,goal:new Set,prioritisation:new Set,judgement_or_objective:new Set,goal_or_action:new Set,has_objectives:new Set,any_link:new Set,any_node:new Set,any_state_VAPs:new Set,has_single_datetime:new Set}}function Qw(e,t){const n=Zw(),i=new Set;return t.forEach(o=>{const s=e[o];if(!s){console.warn(`Could not find wcomponent by id: ${o}.  Wrong ID or in another base?`);return}wl(s)||(n[s.type].add(o),ki(s)&&Mg(s)&&i.add(s.id))}),n.judgement_or_objective=xt(n.judgement,n.objective),n.goal_or_action=xt(n.goal,n.action),n.has_objectives=xt(n.action,n.goal),n.any_link=xt(n.causal_link,n.relation_link),n.any_node=SC(new Set(t),n.any_link),n.any_state_VAPs=xt(n.statev2,n.causal_link,n.action),n.has_single_datetime=xt(n.event,n.sub_state,i),n}const ot=20,ui=ot*18,An=ot*8;function eo(e,t){return Math.round(e/t)*t}function zt(e){return eo(e,ot)}function eb(e){return{left:e.x,top:-e.y}}function ds(e,t="small"){return t==="small"?{left:zt(e.left),top:zt(e.top)}:{left:eo(e.left,ui),top:eo(e.top,An)}}const Ne=250,tb=(e=!1)=>e?120:59,pi=Ne/2,nb=e=>tb(e)/2;function CC(e){return{left:e.left-pi,top:e.top-nb(!1)}}function $C(e,t){const n=e.s??1,i=e.left+n*pi,o=e.top+n*nb(t);return{left:i,top:o}}function jC(e,t){return!e||!t?Number.POSITIVE_INFINITY:(e.left-t.left)**2+(e.top-t.top)**2}const Ki={time_origin_x:0,time_scale:1,time_line_number:4,time_line_spacing_days:30};function Ml(e){const t=e.time_origin_ms??new Date().getTime(),n=e.time_origin_x??0,i=e.time_scale??1;return{time_origin_ms:t,time_origin_x:n,time_scale:i}}function ql(e){const t=AA(e.wcomponent_id,e.wcomponents_by_id,e.created_at_ms);if(!t)return;const n=mi({datetime:t,...e});return zt(n)}function mi(e){const t=e.datetime.getTime()-e.time_origin_ms,n=e.time_scale/xv;return t*n+e.time_origin_x}function ib(e){return`${e.left},${e.top}`}function ob(e,t){const n={};return Object.entries(e).forEach(([i,o])=>{if(we(t[i]))return;const s=ds(o,"large"),r=ib(s),a=n[r]||[];a.push(i),n[r]=a}),n}const TC=/(.*?)(?:\[([^\]]*)\]\([^\)]*\))/g,PC=/(.*?)(\<[^\>]*\>)/g;function tn(e){return e=e.replaceAll(" <auto generated>",""),e=e.replaceAll(TC,"$1$2"),e=e.replaceAll(PC,"$1"),e}function NC(e){const t=new Set,n=new Set;e.forEach(o=>{o.label_ids&&o.label_ids.forEach(s=>t.add(s)),n.add(o.type)});const i=Array.from(n).sort();return{wc_label_ids:t,wc_types:i}}function Dt(e,t){const{id:n,label_ids:i=[],type:o}=e,{exclude_by_label_ids:s,include_by_label_ids:r,exclude_by_component_types:a,include_by_component_types:c}=t,l=s.has(n)||!!i.find(v=>s.has(v)),d=r.size>0&&!r.has(n)&&!i.find(v=>r.has(v)),u=a.has(o),f=c.size>0&&!c.has(o);return{should_exclude:l||u,lacks_include:d||f}}function lt(e,t){let n={};e.forEach(s=>{Object.entries(s.wc_id_map).forEach(([r,a])=>{a.passthrough||(delete n[r],n[r]=a)})}),EC(n,t);const i=IC(n);n=i.composed_wc_id_map;const o=i.composed_blocked_wc_id_map;return{composed_wc_id_map:n,composed_blocked_wc_id_map:o}}function EC(e,t){Object.keys(e).forEach(n=>{const i=t[n];wl(i)&&delete e[n]})}function IC(e){const t={};return Object.entries(e).forEach(([n,i])=>{i.blocked&&(t[n]=i,delete e[n])}),{composed_wc_id_map:e,composed_blocked_wc_id_map:t}}function Iu(e){let t=e.routing.args.subview_id;return t=Dv(t)?t:"",di(e,t)}const RC=(e,t)=>{e.specialised_objects.knowledge_views_by_id!==t.specialised_objects.knowledge_views_by_id&&(t=DC(t));const i=Iu(e),o=Iu(t);(i==null?void 0:i.id)!==(o==null?void 0:o.id)&&(t=D(t,"derived","current_composed_knowledge_view",void 0));const r=i!==o,a=e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id,c=e.meta_wcomponents.selected_wcomponent_ids_set!==t.meta_wcomponents.selected_wcomponent_ids_set,l=r||a||c,d=e.routing.args.created_at_ms!==t.routing.args.created_at_ms,u=d||e.filter_context!==t.filter_context||a,f=e.display_options.display_time_marks!==t.display_options.display_time_marks,m=d||f;if(o){if(l){let h=sb(t,o);h=Xc(t,h),h=_b(t,h),t=D(t,"derived","current_composed_knowledge_view",h)}else if(u){const h=Xc(t,t.derived.current_composed_knowledge_view);t=D(t,"derived","current_composed_knowledge_view",h)}else if(m){let{current_composed_knowledge_view:h}=t.derived;h=zC(h,f,t,o),t=D(t,"derived","current_composed_knowledge_view",h)}}return t};function DC(e){const{knowledge_views_by_id:t}=e.specialised_objects,n=_t(e),o=Object.values(t).map(a=>({...a,title:tn(a.title)})),s=ue(o,({title:a})=>a,ce.ascending),r=Dg(s,n);return yA(r),e={...e,derived:{...e.derived,knowledge_views:s,nested_knowledge_view_ids:r}},e}function sb(e,t){const{knowledge_views_by_id:n,wcomponents_by_id:i}=e.specialised_objects,{current_composed_knowledge_view:o}=e.derived;return OC({knowledge_view:t,current_composed_knowledge_view:o,knowledge_views_by_id:n,wcomponents_by_id:i})}function OC(e){const{knowledge_view:t,knowledge_views_by_id:n,wcomponents_by_id:i}=e,o=e.current_composed_knowledge_view||{composed_visible_wc_id_map:{},active_judgement_or_objective_ids_by_target_id:{},active_judgement_or_objective_ids_by_goal_or_action_id:{},filters:{wc_ids_excluded_by_any_filter:new Set,wc_ids_excluded_by_filters:new Set,wc_ids_excluded_by_created_at_datetime_filter:new Set,vap_set_number_excluded_by_created_at_datetime_filter:0},wc_id_to_active_counterfactuals_v2_map:{}},s=$t(t,n,!0),{composed_wc_id_map:r,composed_blocked_wc_id_map:a}=lt(s,i),c=FC(r,i),l=Object.keys(r),d=Qw(i,l),u=[],f=[];l.forEach(y=>{const S=i[y];S?u.push(S):f.push(y)});const m=o.wc_id_to_active_counterfactuals_v2_map,h=MC({current_wc_id_to_active_counterfactuals_v2_map:m,wc_ids_by_type:d,wcomponents_by_id:i,active_counterfactual_ids:t.active_counterfactual_v2_ids||[]}),v=qC(d.prioritisation,i),g=VC(d.any_link,i),b=NC(u),w=rb(s,!0),k={...t,...o,composed_wc_id_map:r,composed_blocked_wc_id_map:a,overlapping_wc_ids:c,wcomponent_unfound_ids:f,wc_id_to_active_counterfactuals_v2_map:h,wc_ids_by_type:d,prioritisations:v,wc_id_connections_map:g,available_filter_options:b,composed_datetime_line_config:w};return delete k.wc_id_map,delete k.datetime_line_config,k}function $t(e,t,n){const{foundation_knowledge_view_ids:i=[]}=e,o=i.map(s=>t[s]).filter(be);return n&&o.push(e),o}function MC(e){return e.current_wc_id_to_active_counterfactuals_v2_map}function qC(e,t){const n=Array.from(e).map(i=>t[i]).filter(hl);return ue(n,i=>gA(i)||Ae(i),ce.descending)}function VC(e,t){const n={};function i(s,r){const a=n[s]||new Set;a.add(r),n[s]=a}function o(s,r){i(s,r),i(r,s)}return e.forEach(s=>{const r=t[s];we(r)&&(r.from_id&&o(r.from_id,r.id),r.to_id&&o(r.to_id,r.id))}),n}function rb(e,t){let n={};return t&&(n={...Ki}),e.forEach(i=>{const{datetime_line_config:o}=i;o&&(n.time_origin_ms=o.time_origin_ms??n.time_origin_ms,n.time_origin_x=o.time_origin_x??n.time_origin_x,n.time_scale=o.time_scale??n.time_scale,n.time_line_number=o.time_line_number??n.time_line_number,n.time_line_spacing_days=o.time_line_spacing_days??n.time_line_spacing_days)}),n}function Xc(e,t){if(!t)return;const{wc_ids_by_type:n,composed_wc_id_map:i}=t,o=kn(e,n.any_node).filter(Qk),s=kn(e,n.any_link).filter(we),r=o.concat(s);let a=new Set;e.filter_context.apply_filter&&(a=Zc(e.filter_context.filters,e.meta_wcomponents.selected_wcomponent_ids_set,o,s));const{created_at_ms:c}=e.routing.args;let l=0;const d=r.filter(h=>(ki(h)&&h.values_and_prediction_sets.forEach(v=>{Ae(v)>c&&++l}),Ae(h)>c)).map(({id:h})=>h),u=new Set(d),f=xt(a,u),m={...i};return f.forEach(h=>{delete m[h]}),{...t,composed_visible_wc_id_map:m,filters:{wc_ids_excluded_by_any_filter:f,wc_ids_excluded_by_filters:a,wc_ids_excluded_by_created_at_datetime_filter:u,vap_set_number_excluded_by_created_at_datetime_filter:l}}}function Zc(e,t,n,i){const o=new Set,{exclude_by_label_ids:s,include_by_label_ids:r,exclude_by_component_types:a,include_by_component_types:c}=e,l=new Set(s),d=new Set(r),u=new Set(a),f=new Set(c),m={exclude_by_label_ids:l,include_by_label_ids:d,include_by_label_ids_list:r,exclude_by_component_types:u,include_by_component_types:f};return n.forEach(h=>{const{should_exclude:v,lacks_include:g}=Dt(h,m);(v||g)&&o.add(h.id)}),i.forEach(h=>{const{from_id:v,to_id:g}=h;let b=!1;//!from_id || !to_id
b=b||!!v&&!t.has(v)&&o.has(v)||!!g&&!t.has(g)&&o.has(g);const w=Dt(h,m);b=b||w.should_exclude,b&&o.add(h.id)}),o}function FC(e,t){const n=ob(e,t),i={};return Object.values(n).forEach(o=>{o.length<=1||o.forEach((s,r)=>{const a=r+1;i[s]=[...o.slice(a),...o.slice(0,a)]})}),i}function zC(e,t,n,i){if(e){if(t&&!n.display_options.display_time_marks){const{knowledge_views_by_id:o,wcomponents_by_id:s}=n.specialised_objects,r=$t(i,o,!0),a=lt(r,s);e={...e,...a}}else e=_b(n,e);return e}}function _b(e,t){if(!t)return;const{display_time_marks:n}=e.display_options,{wc_ids_by_type:i,composed_wc_id_map:o,composed_datetime_line_config:s}=t,{time_origin_ms:r,time_origin_x:a,time_scale:c}=s,{wcomponents_by_id:l}=e.specialised_objects,{created_at_ms:d}=e.routing.args;if(!n||r===void 0)return t;const u={...o};let f=!1;return Array.from(i.has_single_datetime).forEach(m=>{const h=o[m];if(!h)return;const v=ql({wcomponent_id:m,wcomponents_by_id:l,created_at_ms:d,time_origin_ms:r,time_origin_x:a,time_scale:c});v===void 0||h.left===v||(f=!0,u[m]={...h,left:v})}),f?{...t,composed_wc_id_map:u}:t}function LC(e,t){if(e.specialised_objects.wcomponents_by_id!==t.specialised_objects.wcomponents_by_id){const n=Object.keys(t.specialised_objects.wcomponents_by_id),i=Qw(t.specialised_objects.wcomponents_by_id,n);t=D(t,"derived","wcomponent_ids_by_type",i);const o=ab(t,t.derived.wcomponent_ids_by_type.judgement_or_objective),s=BC(o);t=D(t,"derived","judgement_or_objective_ids_by_target_id",s);const r=kn(t,t.derived.wcomponent_ids_by_type.goal).filter(be).filter(_n),a=UC(r);t=D(t,"derived","judgement_or_objective_ids_by_goal_or_action_id",a)}return t=RC(e,t),t=yC(e,t),t=WC(e,t),t}function ab(e,t){return kn(e,t).filter(be).filter(pt)}function BC(e){const t={};return e.forEach(n=>{const i=n.judgement_target_wcomponent_id;if(!i)return;const o=t[i]||[];o.push(n.id),t[i]=o}),t}function UC(e){const t={};return e.forEach(({id:n,objective_ids:i})=>{t[n]=i||[]}),t}function WC(e,t){var l;let{current_composed_knowledge_view:n}=t.derived;const i=((l=e.derived.current_composed_knowledge_view)==null?void 0:l.id)!==(n==null?void 0:n.id),o=e.derived.judgement_or_objective_ids_by_target_id!==t.derived.judgement_or_objective_ids_by_target_id,{created_at_ms:s,sim_ms:r}=t.routing.args,a=e.routing.args.created_at_ms!==s,c=e.routing.args.sim_ms!==r;if(n&&(i||o||a||c)){let d=function(S){return g[S]};const u={},f={},{wc_ids_by_type:m,composed_visible_wc_id_map:h}=n,v=ab(t,m.judgement_or_objective),g={};v.forEach(S=>{if(!h[S.id])return;const{is_valid:T}=Ol({wcomponent:S,created_at_ms:s,sim_ms:r})||Dl();T&&(g[S.id]=!0)});const b={};Object.keys(h).forEach((S,T)=>{b[S]=T});const w=S=>b[S]||-1,{judgement_or_objective_ids_by_target_id:k,judgement_or_objective_ids_by_goal_or_action_id:y}=t.derived;Object.keys(h).forEach(S=>{const T=k[S],$=y[S];if(T){const R=T.filter(d);if(R.length){const C=ue(R,w,ce.descending);u[S]=C}}if($){const R=$.filter(d);if(R.length){const C=ue(R,w,ce.descending);f[S]=C}}}),n={...n,active_judgement_or_objective_ids_by_target_id:u,active_judgement_or_objective_ids_by_goal_or_action_id:f},t=D(t,"derived","current_composed_knowledge_view",n)}return t}const HC=(e,t)=>{if(Y2(t)&&(e=D(e,"display_options","consumption_formatting",!e.display_options.consumption_formatting)),X2(t)){const n=Ii(t.focused_mode,e.display_options.focused_mode);e=D(e,"display_options","focused_mode",n)}if(Q2(t)&&(e=D(e,"display_options","time_resolution",t.time_resolution)),tx(t)){e=D(e,"display_options","validity_filter",t.validity_filter);const n=Hw(t.validity_filter);e=D(e,"display_options","derived_validity_filter",n)}if(ix(t)){e=D(e,"display_options","certainty_formatting",t.certainty_formatting);const n=Gw(t.certainty_formatting);e=D(e,"display_options","derived_certainty_formatting",n)}if(sx(t)&&(e=D(e,"display_options","display_by_simulated_time",t.display_by_simulated_time)),_x(t)&&(e=D(e,"display_options","display_time_marks",t.display_time_marks)),cx(t)){const n=Ii(t.animate_connections,e.display_options.animate_connections);e=D(e,"display_options","animate_connections",n)}if(dx(t)){const n=Ii(t.circular_links,e.display_options.circular_links);e=D(e,"display_options","circular_links",n)}if(px(t)&&(e=D(e,"display_options","show_help_menu",t.show)),fx(t)){const n=Ii(t.show_large_grid,e.display_options.show_large_grid);e=D(e,"display_options","show_large_grid",n)}if(vx(t)){const n=Ii(t.enable_angular_connections,e.display_options.enable_angular_connections);e=D(e,"display_options","enable_angular_connections",n)}return e};function Ii(e,t){return e===void 0&&(e=!t),e}function cb(e){return e.routing.args.view==="actions_list"}function GC(e){let t=e.derived.wcomponent_ids_by_type.action;const{apply_filter:n,filters:i}=e.filter_context;if(!n)return t;const{filter_by_current_knowledge_view:o,filter_by_text:s}=i;if(o){const r=ne(e);r&&(t=r.wc_ids_by_type.action)}if(s){const r=Array.from(t).map(a=>e.specialised_objects.wcomponents_by_id[a]).filter(Ov).filter(a=>a.title.includes(s)||a.description.includes(s)).map(a=>a.id);t=new Set(r)}return t}const KC=(e,t)=>{if(bx(t)&&(e=D(e,"filter_context","apply_filter",t.apply_filter)),kx(t)){e=D(e,"filter_context","filters",t.filters);const n=cb(e),{exclude_by_label_ids:i,include_by_label_ids:o,exclude_by_component_types:s,include_by_component_types:r,filter_by_current_knowledge_view:a,filter_by_text:c}=t.filters,l=i.length+o.length+s.length+r.length>0||n&&(a||c.length>0);e=D(e,"filter_context","apply_filter",l)}return e},YC=(e,t)=>{let n=!1;if(Sx(t)){n=!0;const i=new Set([...e.global_keys.keys_down]);i.add(t.key),e={...e,global_keys:{...e.global_keys,last_key:t.key,last_key_time_stamp:t.time_stamp,keys_down:i}}}if($x(t)){n=!0;let i=new Set([...e.global_keys.keys_down]);i.delete(t.key),e={...e,global_keys:{...e.global_keys,last_key:t.key,last_key_time_stamp:t.time_stamp,keys_down:i}}}return Tx(t)&&(n=!0,e=D(e,"global_keys","keys_down",new Set)),n&&(e=JC(e)),e};function JC(e){const{keys_down:t}=e.global_keys,n=t.has("Control"),i=t.has("Shift"),o={...e.global_keys,derived:{shift_down:i,control_down:n,shift_or_control_down:n||i}};return{...e,global_keys:o}}const XC=(e,t)=>(Ex(t)&&(e=D(e,"view_priorities","action_ids_to_show",t.action_ids),e=D(e,"view_priorities","date_shown",t.date_shown)),e);function Mt(e,t,n){const{route:i,sub_route:o,item_id:s,args:r}=e,a=t.args||{};a.created_at_ms=Cu(a.created_at_datetime,a.created_at_ms,n),a.created_at_datetime=a.created_at_ms?new Date(a.created_at_ms):void 0,a.sim_ms=Cu(a.sim_datetime,a.sim_ms,n),a.sim_datetime=a.sim_ms?new Date(a.sim_ms):void 0,Object.keys(a).forEach(l=>{if(l==="storage_location")return;const d=a[l];(d===void 0||d==="")&&delete a[l]});const c={...r,...a};return{route:t.route||i,sub_route:t.sub_route===null?null:t.sub_route||o,item_id:t.item_id===null?null:t.item_id||s,args:c}}const ZC=A.delay("merge_routing_state",()=>{const e=new Date("2021-04-09 23:25:26"),t=new Date("2022-01-01 01:01:01"),n=new Date("2023-01-01 01:01:01"),i={route:"wcomponents",sub_route:null,item_id:"wc53611570523449304",args:{created_at_datetime:e,created_at_ms:e.getTime(),sim_datetime:e,sim_ms:e.getTime(),view:"knowledge",subview_id:"kv7207606403961189",zoom:100,x:0,y:0,storage_location:1}};let o,s,r;const a=c=>r=c;o={args:{x:0}},s=Mt(i,o),p(s,i),o={args:{zoom:void 0}},s=Mt(i,o),p(s,i),o={args:{created_at_datetime:t,created_at_ms:n.getTime()}},r="",s=Mt(i,o,a),p(s.args.created_at_datetime,n),p(s.args.created_at_ms,n.getTime()),p(r,"do not set both new_ms and new_datetime"),o={args:{sim_datetime:t,sim_ms:n.getTime()}},r="",s=Mt(i,o,a),p(s.args.sim_datetime,n),p(s.args.sim_ms,n.getTime()),p(r,"do not set both new_ms and new_datetime"),o={args:{sim_ms:void 0,created_at_ms:void 0}},s=Mt(i,o),p(s.args.sim_ms,e.getTime(),"should leave sim_ms unchanged when called with `{ args: { sim_ms: undefined }}`"),p(s.args.created_at_ms,e.getTime(),"should leave created_at_ms unchanged when called with `{ args: { created_at_ms: undefined }}`"),o={args:{storage_location:void 0}},s=Mt(i,o),p(s.args.storage_location,void 0)}),lb={views:[],wcomponents:["wcomponents_edit_multiple"],search:[],filter:[],select:[],display:[],statements:[],objects:["objects_bulk_import","objects_bulk_import/setup"],patterns:[],creation_context:[],about:[]},db=Object.keys(lb),QC={priorities:!0,priorities_list:!0,actions_list:!0,knowledge:!0,objectives:!0},e$=Object.keys(QC),t$=e=>e$.includes(e),ub={view:!0,subview_id:!0,zoom:!0,x:!0,y:!0,storage_location:!0,cdate:!0,ctime:!0,sdate:!0,stime:!0},n$=Object.keys(ub).length;function fi(e){const t=e.sub_route?`${e.sub_route}/`:"",n=e.item_id?`${e.item_id}/`:"",i=e.args,o=Qc(i);return"#"+e.route+"/"+t+n+o}const i$=new Set(["order","rotation","created_at_datetime","created_at_ms","sim_datetime","sim_ms"]);function Qc(e){const t={...e,cdate:Ct(e.created_at_datetime,"yyyy-MM-dd"),ctime:Ct(e.created_at_datetime,"hh:mm:ss"),sdate:Ct(e.sim_datetime,"yyyy-MM-dd"),stime:Ct(e.sim_datetime,"hh:mm:ss")};return Object.keys(e).filter(i=>!i$.has(i)).sort().concat(["sdate","stime","cdate","ctime"]).map(i=>`&${i}=${t[i]??""}`).join("")}function o$(e){const t=pb(e);return!t.route||t.args_from_url.length!==n$}function pb(e){const n=(e.split("#")[1]||"").split("&"),o=n[0].split("/").filter(l=>!!l),{route:s,sub_route:r,item_id:a}=s$(o),c=n.slice(1).map(l=>l.split("=")).filter(l=>ub[l[0]]);return{route:s,sub_route:r,item_id:a,args_from_url:c}}function mb(e,t){const{route:n,sub_route:i,item_id:o,args_from_url:s}=pb(e),r=r$(t.args,s);return{route:n,sub_route:i,item_id:o,args:r}}function s$(e){let t=e[0],n=null,i=null;if(!db.includes(t))t="wcomponents";else{const o=e.slice(1).join("/")||null;lb[t].includes(o)?n=o:i=o}return{route:t,sub_route:n,item_id:i}}function r$(e,t){e={...e};let n=null,i=null,o=null,s=null;return t.forEach(r=>{const[a,c]=r;a==="cdate"?n=c:a==="ctime"?i=c:a==="sdate"?o=c:a==="stime"?s=c:_$(e,a,c)}),e.created_at_datetime=Su(n,i),e.sim_datetime=o?Su(o,s):e.created_at_datetime,e.created_at_ms=e.created_at_datetime.getTime(),e.sim_ms=e.sim_datetime.getTime(),e}function _$(e,t,n){t==="view"?t$(n)&&(e.view=n):c$(t)?e[t]=l$(n):t==="subview_id"?e.subview_id=n:t==="storage_location"&&(e.storage_location=d$(n))}const a$=new Set(["x","y","zoom"]);function c$(e){return a$.has(e)}function l$(e){const t=parseInt(e);return Number.isNaN(t)?0:t}function d$(e){const t=parseInt(e);return Number.isNaN(t)?void 0:t}const u$=A.delay("routing_state_to_string",()=>{let e,t;e={route:"wcomponents",sub_route:null,item_id:"wc88",args:{view:"knowledge",subview_id:"kv77",zoom:100,x:101,y:158,storage_location:void 0,created_at_datetime:new Date("2020-10-21T17:04:24.000Z"),created_at_ms:1603299864e3,sim_datetime:new Date("2021-04-26T09:23:13.000Z"),sim_ms:1619428993e3}},t=fi(e),p(t,"#wcomponents/wc88/&storage_location=&subview_id=kv77&view=knowledge&x=101&y=158&zoom=100&sdate=2021-04-26&stime=10:23:13&cdate=2020-10-21&ctime=18:04:24")}),p$=60*1e3;function fb(e,t){let n=Number.NEGATIVE_INFINITY;return ki(e)&&e.type==="action"&&e.values_and_prediction_sets.forEach(i=>{var s;const o=((s=ut(i.datetime))==null?void 0:s.getTime())||Number.NEGATIVE_INFINITY;n=Math.max(n,o)}),n=Math.max(n+p$,t.routing.args.sim_ms),n}const m$=(e,t)=>{if(gg(t)){const{route:n,sub_route:i,item_id:o,args:s}=e.routing,r=Mt(e.routing,t);(n!==r.route||i!==r.sub_route||o!==r.item_id||Qc(s)!==Qc(r.args))&&(e={...e,routing:r})}if(_s(t)){const n=fb(t.wcomponent,e);n!==e.routing.args.sim_ms&&(e=rs(e,"routing","args","sim_ms",n))}return e},f$=(e,t)=>{if(BA(t)){const n=t.side==="right"?"find_all_causal_paths_from_wcomponent_ids":"find_all_causal_paths_to_wcomponent_ids";e=D(e,"meta_wcomponents",n,t.ids)}return e};function Vl(e,t,n){const i=e.findIndex(n);return i<0?(console.error(`Can not find element by predicate: ${n.toString()}`),e):[...e.slice(0,i),t,...e.slice(i+1)]}function us(e,t){const n=e.filter(i=>!t(i));return n.length===e.length?e:n}function hb(e,t,n){const i=n||(s=>s===t),o=e.filter(s=>!i(s));return o.length===e.length&&o.push(t),o}function At(e,t){return e.length>0&&t>=0&&t<e.length}function bt(e,t,n){if(!At(e,t)||!At(e,n))return e;const i=Math.min(t,n),o=Math.max(t,n),s=[...e],r=s[i];return s[i]=s[o],s[o]=r,s}function yt(e,t,n){return n<=0?e=[t,...e]:n>=e.length?e=[...e,t]:e=[...e.slice(0,n),t,...e.slice(n)],e}const h$=(e,t)=>{const n=e.meta_wcomponents.selected_wcomponent_ids_list;if(HA(t)){const{id:i}=t;let o=[...e.meta_wcomponents.selected_wcomponent_ids_list];const{shift_or_control_down:s}=e.global_keys.derived;s?o=hb(o,i):o=[i];const r={...e.meta_wcomponents,selected_wcomponent_ids_list:o,last_clicked_wcomponent_id:i};e={...e,meta_wcomponents:r}}if(KA(t)&&(e=v$(e)),JA(t)&&(e=g$(e,t)),nS(t)){const i={wcomponent_id:t.wcomponent_id,terminal_type:void 0};e=D(e,"meta_wcomponents","last_pointer_down_connection_terminal",i)}if(QA(t)){const{wcomponent_id:i,terminal_type:o}=t;e=D(e,"meta_wcomponents","last_pointer_down_connection_terminal",{wcomponent_id:i,terminal_type:o})}return oS(t)&&(e=D(e,"meta_wcomponents","last_pointer_down_connection_terminal",void 0)),rS(t)&&(e=D(e,"meta_wcomponents","wcomponent_ids_to_move_set",t.wcomponent_ids_to_move)),n!==e.meta_wcomponents.selected_wcomponent_ids_list&&(e=vb(e)),e};function v$(e){return e=D(e,"meta_wcomponents","selected_wcomponent_ids_list",[]),e}function g$(e,t){return e=D(e,"meta_wcomponents","selected_wcomponent_ids_list",[...t.ids]),e}function vb(e){const t=new Set(e.meta_wcomponents.selected_wcomponent_ids_list),n={};e.meta_wcomponents.selected_wcomponent_ids_list.forEach((o,s)=>n[o]=s);const i={...e.meta_wcomponents,selected_wcomponent_ids_set:t,selected_wcomponent_ids_to_ordinal_position_map:n};return{...e,meta_wcomponents:i}}const w$=(e,t)=>(e=f$(e,t),e=h$(e,t),cS(t)&&(e=D(e,"meta_wcomponents","frame_is_resizing",t.frame_is_resizing)),e);function b$(e,t){return t=y$(e,t),t}function y$(e,t){const n=e.sync.ready_for_reading!==t.sync.ready_for_reading;if((e.routing.item_id!==t.routing.item_id||n)&&t.routing.item_id&&Dv(t.routing.item_id)){const i=[t.routing.item_id];t=D(t,"meta_wcomponents","selected_wcomponent_ids_list",i),t=vb(t)}return t}function se(e,t,n=new Set){let i=N.undefined;do{if(n.has((e==null?void 0:e.id)||"")){console.log(`Recursion prevented in "get_wcomponent_VAPs_represent" for wcomponent id: "${e==null?void 0:e.id}" type: "${e==null?void 0:e.type}"`);break}if(e&&n.add(e.id),!Ge(e))break;if(Ze(e))i=k$(e.subtype);else if(Le(e))i=N.action;else if(vt(e)){const o=t[e.attribute_wcomponent_id||""];o&&(i=se(o,t,n))}else console.error(`Unimplemented "get_wcomponent_VAPs_represent" for wcomponent id: "${e.id}" type: "${e.type}"`)}while(!1);return i}function k$(e){return e==="boolean"?N.boolean:e==="number"?N.number:e==="other"?N.other:N.undefined}function Vt(e,t){if(yi(e)){const n=ue(e.validity,Ae,ce.ascending);e.validity=n}if(Rn(e)){const n=ue(e.values_and_prediction_sets||[],Ae,ce.ascending),i=se(e,t),o=n.map(s=>({...s,entries:bl(s.entries,i)}));e.values_and_prediction_sets=o}return Ge(e)&&(e._derived__using_value_from_wcomponent_id&&console.error(`WComponent "${e.id}" had _derived__using_value_from_wcomponent_id set ("${e._derived__using_value_from_wcomponent_id}") but this should never happen and only be used on wcomponents from state.derived.composed_wcomponents_by_id`),delete e._derived__using_value_from_wcomponent_id),e}function gb(e,t,n,i){let{wcomponent_ids:o,knowledge_view_ids:s}=e.sync.specialised_object_ids_pending_save;const r=t==="wcomponent";let a=r?o:s;return a=i?xC(a,n):AC(a,n),e=rs(e,"sync","specialised_object_ids_pending_save",r?"wcomponent_ids":"knowledge_view_ids",a),e}function x$(e,t){return t=Vt(t,e.specialised_objects.wcomponents_by_id),t=lo(t),e=wg(e,"sync","last_source_of_truth_specialised_objects_by_id","wcomponents",t.id,t),e}function A$(e,t){return t=lo(t),e=wg(e,"sync","last_source_of_truth_specialised_objects_by_id","knowledge_views",t.id,t),e}function S$(e,t){return wb(e,t,!1)}function wb(e,t,n){return e={...e,needs_save:!0,modified_by_username:as(t)},n&&(e.deleted_at=new Date),e}function Ut(e,t,n){const i={...e.specialised_objects.knowledge_views_by_id};return t=n?t:S$(t,e),i[t.id]=t,e=D(e,"specialised_objects","knowledge_views_by_id",i),e=gb(e,"knowledge_view",t.id,!!t.needs_save),e}const C$=(e,t)=>(eA(t)&&(e=N$(e,t)),nA(t)&&(e=E$(e,t)),oA(t)&&(e=T$(e,t)),rA(t)&&(e=P$(e,t)),aA(t)&&(e=$$(e,t)),lA(t)&&(e=j$(e,t)),e);function $$(e,t){const{knowledge_view_id:n,wcomponent_ids:i,override_entry:o,default_entry:s}=t,r=e.specialised_objects.knowledge_views_by_id[n],a=ne(e);if(!r)console.error(`Could not find knowledge view for bulk_add_to_knowledge_view by id: "${n}"`);else if(!a)console.error("There should always be a current knowledge view if bulk editing position of world components");else{let c={};i.forEach(d=>{let u={...s,...a.composed_wc_id_map[d],...o,blocked:void 0,passthrough:void 0};if(u.left===void 0||u.top===void 0){console.error(`we should always have an entry but no bulk_entry provided and wcomponent "${d}" lacking entry in composed_kv composed_wc_id_map for "${n}"`);return}c[d]=u}),c={...r.wc_id_map,...c};const l={...r,wc_id_map:c};e=Ut(e,l)}return e}function j$(e,t){const{wcomponent_ids:n,remove_type:i}=t,o=i==="block",s=Be(e),r=ne(e);if(!s||!r)console.error("There should always be a current and current composed knowledge view if bulk editing (removing) positions of world components");else{const a={...s.wc_id_map};n.forEach(l=>{const d=o?r.composed_wc_id_map[l]:s.wc_id_map[l];if(!d)return;const u=o?{...d,blocked:!0,passthrough:void 0}:{...d,blocked:void 0,passthrough:!0};a[l]=u});const c={...s,wc_id_map:a};e=Ut(e,c)}return e}function T$(e,t){const{wcomponent_ids:n,knowledge_view_id:i}=t,o=e.specialised_objects.knowledge_views_by_id[i];if(o){const s={...o.wc_id_map};n.forEach(a=>{const c=o.wc_id_map[a];if(!c)return;const l=ds(c,"large");s[a]=l});const r={...o,wc_id_map:s};e=Ut(e,r)}return e}function P$(e,t){const{wcomponent_ids:n,order:i}=t,o=Be(e),s=ne(e);if(!o||!s)return console.error("There should always be a current knowledge view and current composed knowledge view if bulk editing (moving to top) world components"),e;let r={};i==="front"?(r={...o.wc_id_map},n.forEach(c=>{const l=s.composed_wc_id_map[c];l&&(delete r[c],r[c]=l)})):i==="back"&&(n.forEach(c=>{const l=s.composed_wc_id_map[c];l&&(r[c]=l)}),r={...r,...o.wc_id_map});const a={...o,wc_id_map:r};return e=Ut(e,a),e}function N$(e,t){const{wcomponent_ids:n,change_left:i,change_top:o}=t,s=Be(e),r=ne(e);if(s&&r){const a={...s.wc_id_map};n.forEach(l=>{const d=r.composed_wc_id_map[l];if(!d||d.blocked||d.passthrough)return;const u={...d};u.left+=i,u.top+=o,a[l]=u});const c={...s,wc_id_map:a};e=Ut(e,c)}else console.error("There should always be a current knowledge view if bulk editing position of world components");return e}function E$(e,t){const{knowledge_view_id:n,changes:i}=t,o=e.specialised_objects.knowledge_views_by_id[n];if(o){const s={...o.wc_id_map};i.forEach(a=>{const c=o.wc_id_map[a.wcomponent_id];if(!c)return;const l={...c,left:a.left,top:a.top};s[a.wcomponent_id]=l});const r={...o,wc_id_map:s};e=Ut(e,r)}return e}const I$=(e,t)=>{if(Ig(t)&&(e=Ut(e,t.knowledge_view,t.is_source_of_truth)),_s(t)){const{wcomponent:n,add_to_knowledge_view:i,add_to_top:o}=t;if(i){const r={...i.position};e=Ru(e,i.id,n.id,r,o)}const s=e.specialised_objects.knowledge_views_by_id[n.id];if(s&&s.title!==n.title){const r={...s,title:n.title};e=Ut(e,r,t.is_source_of_truth)}}if(pA(t)&&(e=Ru(e,t.knowledge_view_id,t.wcomponent_id,t.entry)),_w(t)&&t.object_type==="knowledge_view"){let n=di(e,t.id);n?(n={...n,saving:t.saving},e=rs(e,"specialised_objects","knowledge_views_by_id",t.id,n)):console.error(`Could not find knowledge_view by id: "${t.id}" whilst handling is_update_specialised_object_sync_info`)}return e=C$(e,t),e};function Ru(e,t,n,i,o){const s=di(e,t);return s?R$(e,s,n,i,o):(console.error(`Could not find knowledge_view for id: "${t}"`),e)}function R$(e,t,n,i,o=!0){let s={...t.wc_id_map};const r=s[n];r&&(r.blocked&&!i.blocked||r.passthrough&&!i.passthrough)&&delete s[n],o?s[n]=i:s={[n]:i,...s};const a={...t,wc_id_map:s};return Ut(e,a)}const D$={event:!0,statev2:!0,state_value:!0,sub_state:!0,multidimensional_state:!0,process:!0,action:!0,actor:!0,causal_link:!0,relation_link:!0,judgement:!0,objective:!0,counterfactualv2:!0,goal:!0,prioritisation:!0},bb=Object.keys(D$).sort().filter(e=>e!=="multidimensional_state");function sn(e,t){const n={};return e.forEach(i=>{if(n[i.id])throw new Error(`Duplicate "${t}".id: "${n[i.id]}".  "${n[i.id].title}" and "${i.title}"`);n[i.id]=i}),n}const O$=(e,t)=>{if(Fg(t)){const{wcomponents:n,knowledge_views:i}=t.specialised_objects,o=sn(n,"wcomponents"),s=sn(i,"knowledge_views");e={...e,specialised_objects:{wcomponents_by_id:o,knowledge_views_by_id:s}}}return Lg(t)&&(e={...e,specialised_objects:{wcomponents_by_id:{},knowledge_views_by_id:{}}}),e};function el(e,t,n,i=!1){const o={...e.specialised_objects.wcomponents_by_id};return t=n?t:wb(t,e,i),o[t.id]=t,e=D(e,"specialised_objects","wcomponents_by_id",o),e=gb(e,"wcomponent",t.id,!!t.needs_save),e}function M$(e,t){const n={...e.specialised_objects.wcomponents_by_id};return t.forEach(i=>n[i.id]=i),e=D(e,"specialised_objects","wcomponents_by_id",n),e}const q$=(e,t)=>(IA(t)&&(e=V$(e,t)),e);function V$(e,t){const{wcomponent_ids:n,change:i,remove_label_ids:o,add_label_ids:s}=t,r=kn(e,n).filter(be);return r.length&&r.forEach(a=>{const c={...a,...i},l=F$(c,o,s),d=Vt(l,e.specialised_objects.wcomponents_by_id);e=el(e,d,!1)}),e}function F$(e,t,n){let{label_ids:i}=e;if(i&&t&&(i=i.filter(o=>!t.has(o))),n){const o=i||[],s=new Set(o);Array.from(n).forEach(r=>{s.has(r)||o.push(r)}),i=o}return{...e,label_ids:i}}const z$=(e,t)=>{if(_s(t)){const n=Vt(t.wcomponent,e.specialised_objects.wcomponents_by_id);e=el(e,n,t.is_source_of_truth)}if(MA(t)){const{wcomponent_id:n}=t;let{wcomponents_by_id:i}=e.specialised_objects;const o=i[n];o&&(e=el(e,o,!1,!0))}if(VA(t)){const n=t.wcomponents.map(i=>Vt(i,e.specialised_objects.wcomponents_by_id));e=M$(e,n)}if(_w(t)&&t.object_type==="wcomponent"){let n=me(e,t.id);n?(n={...n,saving:t.saving},e=rs(e,"specialised_objects","wcomponents_by_id",t.id,n)):console.error(`Could not find wcomponent by id: "${t.id}" whilst handling is_update_specialised_object_sync_info`)}return e=q$(e,t),e},L$=(e,t)=>(e=SA(e,t),e=O$(e,t),e=z$(e,t),e=I$(e,t),e),B$=(e,t)=>{if(uS(t)){const{status:n,loading_base_id:i,error_message:o="",attempt:s}=t,r={...e.sync[t.data_type],status:n,error_message:o,retry_attempt:s};i!==void 0&&(r.loading_base_id=i),e=D(e,"sync",t.data_type,r),e=Du(e)}if(mS(t)){const n=Object.values(e.specialised_objects.wcomponents_by_id),i=Object.values(e.specialised_objects.knowledge_views_by_id),o=Ou({wcomponents:n,knowledge_views:i});e=Gs(e,o)}if(Lg(t)&&(e=Gs(e,{knowledge_view_ids:new Set,wcomponent_ids:new Set}),e=D(e,"sync","last_source_of_truth_specialised_objects_by_id",{wcomponents:{},knowledge_views:{}}),e=D(e,"sync","specialised_objects",{status:void 0,loading_base_id:void 0,error_message:"",retry_attempt:0}),e=Du(e)),Fg(t)){const{wcomponents:n,knowledge_views:i}=t.specialised_objects,o=Ou({wcomponents:n,knowledge_views:i});e=Gs(e,o);const s={wcomponents:sn(n,"wcomponents"),knowledge_views:sn(i,"knowledge_views")};e=D(e,"sync","last_source_of_truth_specialised_objects_by_id",s)}if(_s(t)&&t.is_source_of_truth&&(e=x$(e,t.wcomponent)),Ig(t)&&t.is_source_of_truth&&(e=A$(e,t.knowledge_view)),vS(t)&&(e=D(e,"sync","network_functional",t.network_functional),e=D(e,"sync","network_function_last_checked",t.last_checked)),wS(t)){const n=new Set(e.sync.wcomponent_ids_to_search_for_in_any_base),{wcomponent_ids_searching_for_in_any_base:i,wcomponent_ids_searched_for_in_any_base:o}=e.sync;t.ids.filter(s=>!n.has(s)&&!i.has(s)&&!o.has(s)&&!e.specialised_objects.wcomponents_by_id[s]).forEach(s=>n.add(s)),e=D(e,"sync","wcomponent_ids_to_search_for_in_any_base",n)}if(yS(t)){const n=xt(e.sync.wcomponent_ids_to_search_for_in_any_base,e.sync.wcomponent_ids_searching_for_in_any_base);e=D(e,"sync","wcomponent_ids_to_search_for_in_any_base",new Set),e=D(e,"sync","wcomponent_ids_searching_for_in_any_base",n)}if(xS(t)){const n=new Set(e.sync.wcomponent_ids_searching_for_in_any_base),i=new Set(e.sync.wcomponent_ids_searched_for_in_any_base);t.ids.forEach(o=>{n.delete(o),i.add(o)}),e=D(e,"sync","wcomponent_ids_searching_for_in_any_base",n),e=D(e,"sync","wcomponent_ids_searched_for_in_any_base",i)}return e};function Du(e){const{bases:t,specialised_objects:n}=e.sync,i=U$(n);return e=D(e,"sync","ready_for_reading",i.ready_for_reading),e=D(e,"sync","ready_for_writing",i.ready_for_writing),e}function U$(e){const{status:t}=e;return{ready_for_reading:t!==void 0&&t!=="LOADING",ready_for_writing:t==="SAVED"||t==="LOADED"||t==="FAILED"}}function Ou(e){const t=new Set(e.wcomponents.filter(i=>i.needs_save).map(({id:i})=>i)),n=new Set(e.knowledge_views.filter(i=>i.needs_save).map(({id:i})=>i));return{wcomponent_ids:t,knowledge_view_ids:n}}function Gs(e,t){return D(e,"sync","specialised_object_ids_pending_save",t)}const ei=(e,t)=>{var n,i;if(CS(t)){const o=((n=e.user_info.user)==null?void 0:n.id)!==((i=t.user)==null?void 0:i.id);e=D(e,"user_info","user",t.user);const s=e.user_info.has_signed_in_at_least_once||!!t.user;e=D(e,"user_info","has_signed_in_at_least_once",s),o&&H.user.pub("changed_user",!0)}if(PS(t)){let o;t.users&&(o={},t.users.forEach(s=>o[s.id]=s)),e=D(e,"user_info","users_by_id",o)}if(jS(t)&&(e=D(e,"user_info","need_to_handle_password_recovery",t.need_to_handle_password_recovery)),RS(t)){const{bases:o}=t,s=W$(o);e=D(e,"user_info","bases_by_id",s);let r=!1;if(e.user_info.user){const a=e.user_info.chosen_base_id;e=H$(e),r=a!==e.user_info.chosen_base_id}H.user.pub("changed_bases",!0),r&&H.user.pub("changed_chosen_base_id",!0)}if(ES(t)){const o=e.user_info.chosen_base_id;e=D(e,"user_info","chosen_base_id",t.base_id),o!==e.user_info.chosen_base_id&&H.user.pub("changed_chosen_base_id",!0)}return e};function W$(e){let t;return e&&(t={},e.forEach(n=>t[n.id]=n)),t}function H$(e){var i;const{bases_by_id:t,chosen_base_id:n}=e.user_info;if(t&&(n===void 0||!t[n])){const o=gw(e),s=o&&((i=o[0])==null?void 0:i.id);e=D(e,"user_info","chosen_base_id",s)}return e}const yb=e=>(t,n)=>{t=t||e;const i=t;return t=HC(t,n),t=B$(t,n),t=m$(t,n),t=YC(t,n),t=Mx(t,n),t=Lx(t,n),t=L$(t,n),t=w$(t,n),t=uC(t,n),t=pC(t,n),t=KC(t,n),t=ei(t,n),t=XC(t,n),t=Hx(t,n),t={...t,last_action:n},t=LC(i,t),t=b$(i,t),window.debug_state=t,t},G$=e=>{let t;const n=K$();J$(e);function i(){const o=e.getState();if(o.routing===t)return;const s=Y$(t,o.routing);t=o.routing,n(s,o.routing)}return i(),i};let zo=!1;function K$(){const e=Jc(n=>{const i=fi(n);window.DEBUG_ROUTING&&console.log("DELAYED changing route from ",window.location.hash.toString(),"   to:   ",i),window.location.hash=i,zo=!1},1e3),t=Jc(n=>{const i=fi(n),o=o$(window.location.toString());window.DEBUG_ROUTING&&console.log(`Debounced changing route from "${o?"incomplete":"complete"}"`,window.location.hash.toString(),"   to:   ",i),o?history.replaceState(null,"",i):window.location.hash=i,zo=!1},0);return(n,i)=>{zo=!0,n?e.throttled(i):(e.cancel(),t.cancel(),t.throttled(i))}}function Y$(e,t){return!e||!e.args?!1:e.args.x!==t.args.x||e.args.y!==t.args.y}function J$(e){window.onhashchange=t=>{var o,s,r,a;if(zo)return;const n=t,i=e.getState();if(i.sync.ready_for_reading){const c="#"+(n.newURL.split("#")[1]||""),l=fi(i.routing);if(l===c){window.DEBUG_ROUTING&&console.log("on hash change but no difference to current hash route_from_state",l);return}window.DEBUG_ROUTING&&console.log("on hash change difference.  new url is: ",c,"   state is:   ",l),e.dispatch(x.meta_wcomponents.clear_selected_wcomponents());const u=mb(n.newURL,i.routing);((o=u==null?void 0:u.args)==null?void 0:o.created_at_ms)!==void 0&&((s=u==null?void 0:u.args)==null||delete s.created_at_datetime),((r=u==null?void 0:u.args)==null?void 0:r.sim_ms)!==void 0&&((a=u==null?void 0:u.args)==null||delete a.sim_datetime),e.dispatch(x.routing.change_route(u))}}}function X$(e){const t=e.getState();let{chosen_base_id:n}=t.user_info;e.subscribe(()=>{const i=e.getState(),{chosen_base_id:o}=i.user_info,{storage_location:s}=i.routing.args;s===void 0?s!==o&&(console.log(`Change storage_location in route to "${o}" as nothing was set`),e.dispatch(x.routing.change_route({args:{storage_location:o}}))):s!==o&&(n!==o?e.dispatch(x.routing.change_route({args:{storage_location:o}})):e.dispatch(x.user_info.update_chosen_base_id({base_id:s}))),n=o})}const Z$={sync_storage_location_subscriber:X$};function Q$(e){H.canvas.sub("canvas_right_click",t=>{e.dispatch(x.meta_wcomponents.clear_selected_wcomponents());const{route:n,item_id:i,sub_route:o}=e.getState().routing;(n==="wcomponents"&&i||o==="wcomponents_edit_multiple")&&e.dispatch(x.routing.change_route({route:"wcomponents",sub_route:null,item_id:null}))})}function Ve(e,t,n){return Math.max(Math.min(e,n),t)}function Mu(e,t,n,i=0,o=1){const r=(Ve(e,i,o)-i)/(o-i);return t+r*(n-t)}const Fl=e=>Ve(e,10,400),ze=100,ej=.01;function tj(e){const{zoom:t,wheel_change:n}=e,i=t-n*ej*t;return Fl(Math.round(i))}function kb(e){const{old:t,new_zoom:n,pointer_x:i,pointer_y:o,client_width:s,client_height:r}=e,a=i/s,c=o/r,l=ze/n-ze/t.zoom,d=a*s*l,u=c*r*l,f=t.x-d,m=t.y+u;return{x:f,y:m}}const nj=A.skip("calculate_new_zoom_xy (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{let e,s,r,a;const c={pointer_x:5,pointer_y:15},l={pointer_x:5+900,pointer_y:15+600};function d(u){const f=u.pointer==="top_left"?c:l;return kb({old:{x:u.x,y:u.y,zoom:u.zoom},new_zoom:u.new_zoom,...f,client_width:900,client_height:600})}a="top_left",e=d({x:0,y:0,zoom:10,new_zoom:200,pointer:a}),p(e,{x:0,y:0}),e=d({x:100,y:100,zoom:200,new_zoom:200,pointer:a}),p(e,{x:100,y:100}),e=d({x:100,y:100,zoom:200,new_zoom:10,pointer:a}),p(e,{x:100,y:100}),a="bottom_right",s=100,r=50,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),p(e,{x:-900,y:600}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),p(e,{x:-900+100,y:600+100}),s=200,r=100,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),p(e,{x:-900/2,y:600/2}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),p(e,{x:-900/2+100,y:600/2+100}),s=100,r=200,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),p(e,{x:900/2,y:-600/2}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),p(e,{x:900/2+100,y:-600/2+100}),s=50,r=100,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),p(e,{x:900,y:-600}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),p(e,{x:900+100,y:-600+100}),s=50,r=50,e=d({x:0,y:0,zoom:s,new_zoom:r,pointer:a}),p(e,{x:0,y:0}),e=d({x:100,y:100,zoom:s,new_zoom:r,pointer:a}),p(e,{x:100,y:100})}),ii=440,ij=100;function oj(){const e=new Date,t=e.getTime(),i={route:"wcomponents",sub_route:null,item_id:null,args:{view:"knowledge",subview_id:"",zoom:100,x:0,y:0,storage_location:void 0,created_at_datetime:e,created_at_ms:t,sim_datetime:e,sim_ms:t}};return mb(window.location.toString(),i)}const ps=48,sj=e=>e?300:120,rj=e=>e?ii:0,zl=e=>document.body.clientWidth-rj(e),Ll=e=>document.body.clientHeight-ps-sj(e),xb=e=>zl(e)/2,Ab=e=>Ll(e)/2;function _j(e,t,n){const i=eo(e.x+xb(t)*(ze/e.zoom),ui),o=eo(e.y-Ab(n)*(ze/e.zoom)+ps,An);return{x:i,y:o}}function aj(e,t){const n=e.x-xb(t.display_side_panel)*(ze/e.zoom),i=e.y+(Ab(t.display_time_sliders)+ps)*(ze/e.zoom);return{x:n,y:i}}function xi(e){const t=_j(e.routing.args,e.controls.display_side_panel,e.controls.display_time_sliders);return eb(t)}const cj={display_side_panel:!1,display_time_sliders:!1};function hi(e,t,n){if(!e)return;const{left:i,top:o,zoom:s=ij}=e,r=o!==void 0?-1*o:void 0;return t&&i!==void 0&&r!==void 0?{...aj({x:i,y:r,zoom:s},n||cj),zoom:s}:{x:i,y:r,zoom:s}}function lj(e,t,n){let i=e?t[e]:void 0;for(;i;){const o=n[i.id];if(Le(o)||_n(o))return[o.id];i=i.parent_knowledge_view_id?t[i.parent_knowledge_view_id]:void 0}return[]}const dj=60*1e3;function On(e){const t=e.store||Se(),n=t.getState(),i=n.creation_context;let o=qt(e.wcomponent,i);o=uj(o,n),o=pj(o,n),o=fj(o,n);const s=mj(e.add_to_knowledge_view,o,n),r=!pt(o);let a=Ae(o);a=Math.max(a+dj,n.routing.args.created_at_ms);const c=fb(o,n);return t.dispatch(x.specialised_object.upsert_wcomponent({wcomponent:o,add_to_knowledge_view:s,add_to_top:r})),t.dispatch(x.meta_wcomponents.clear_selected_wcomponents()),t.dispatch(x.routing.change_route({route:"wcomponents",item_id:o.id,args:{created_at_ms:a,sim_ms:c}})),!0}function uj(e,t){if(pt(e)){const n=t.meta_wcomponents.selected_wcomponent_ids_list,i=n[0];if(n.length===1&&i){const o=me(t,i);o&&(e={...e,judgement_target_wcomponent_id:o.id})}}return e}function pj(e,t){if(!Le(e)||e.parent_goal_or_action_ids)return e;const n=ne(t),{wcomponents_by_id:i,knowledge_views_by_id:o}=t.specialised_objects,s=n==null?void 0:n.id,r=lj(s,o,i);return{...e,parent_goal_or_action_ids:r}}function mj(e,t,n){const i=ne(n);if(!e&&i){let o;pt(t)?o=t.judgement_target_wcomponent_id:vt(t)&&(o=t.attribute_wcomponent_id);let s=i.composed_wc_id_map[o||""];s||(s=xi(n)),e={id:i.id,position:s}}return e}function fj(e,t){if(vt(e)){const{wcomponents_by_id:n}=t.specialised_objects;let{attribute_wcomponent_id:i,value_possibilities:o}=e;const s=t.meta_wcomponents.selected_wcomponent_ids_list,r=s[0];if(s.length===1&&r){const a=me(t,r);if(a&&Ze(a)){const c=a;if(i=a.id,!o||!Object.keys(o).length){const l=se(c,n),d=yn(l,c.value_possibilities,c.values_and_prediction_sets||[]);o=sn(d,"attribute's possible_values")}}}e={...e,attribute_wcomponent_id:i,value_possibilities:o}}return e}function hj(e){return()=>{const t=e.getState(),{last_pointer_down_connection_terminal:n}=t.meta_wcomponents;if(!n)return;const i=_t(t);if(i===void 0)return;if(t.global_keys.last_key==="Escape"||t.display_options.consumption_formatting){e.dispatch(x.meta_wcomponents.clear_pointerupdown_on_connection_terminal());return}if(!t.last_action)return;let o=!1;const{terminal_type:s,wcomponent_id:r}=n,a=(s==null?void 0:s.attribute)||"state";let c=s==null?void 0:s.side,l,d="state",u=((s==null?void 0:s.side)||"right")==="right"?"left":"right";if(tS(t.last_action))l=t.last_action.wcomponent_id,o=r===l&&(s==null?void 0:s.side)===void 0;else if(ZA(t.last_action))l=t.last_action.wcomponent_id,d=t.last_action.terminal_type.attribute,u=t.last_action.terminal_type.side;else return;if(o=o||r===l&&c===u,e.dispatch(x.meta_wcomponents.clear_pointerupdown_on_connection_terminal()),o)return;c=u==="right"?"left":"right";const f=c==="right";On({wcomponent:{base_id:i,type:a==="meta"||d==="meta"?"relation_link":"causal_link",from_id:f?r:l,to_id:f?l:r,from_type:f?a:d,to_type:f?d:a}})}}function vj(e){function t(){const n=e.getState(),{last_pointer_down_connection_terminal:i}=n.meta_wcomponents;i&&e.dispatch(x.meta_wcomponents.clear_pointerupdown_on_connection_terminal())}H.canvas.sub("canvas_right_click",()=>{t()}),H.canvas.sub("canvas_pointer_down",()=>{t()}),H.canvas.sub("canvas_pointer_up",()=>{t()})}function gj(e){H.canvas.sub("canvas_double_tap",t=>{const n=e.getState(),i=Be(n);if(!i){console.error("No current_knowledge_view despite canvas double_tap");return}const o=_t(n);if(o===void 0){console.error("No base_id despite canvas double_tap");return}if(n.display_options.consumption_formatting||n.routing.args.view!=="knowledge")return;const s=wj(t),r={id:i.id,position:s};On({wcomponent:{base_id:o,type:"statev2"},add_to_knowledge_view:r,store:e})})}function wj(e){const t=CC(eb(e));return ds(t,"large")}function bj(e){yj(e);const t=hj(e);return()=>{t()}}function yj(e){Q$(e),gj(e),vj(e)}function kj(){return{composed_wcomponents_by_id:{},wcomponent_ids_by_type:Zw(),knowledge_views:[],nested_knowledge_view_ids:{top_ids:[],map:{}},judgement_or_objective_ids_by_target_id:{},judgement_or_objective_ids_by_goal_or_action_id:{},current_composed_knowledge_view:void 0}}function xj(){return{last_key:void 0,last_key_time_stamp:void 0,keys_down:new Set,derived:{shift_down:!1,control_down:!1,shift_or_control_down:!1}}}function Aj(){return{action_ids_to_show:[],date_shown:void 0}}function Sj(){return{selected_wcomponent_ids_list:[],selected_wcomponent_ids_set:new Set,selected_wcomponent_ids_to_ordinal_position_map:{},highlighted_wcomponent_ids:new Set,neighbour_ids_of_highlighted_wcomponent:new Set,last_clicked_wcomponent_id:void 0,last_pointer_down_connection_terminal:void 0,wcomponent_ids_to_move_set:new Set,frame_is_resizing:!1,find_all_causal_paths_from_wcomponent_ids:[],find_all_causal_paths_to_wcomponent_ids:[]}}function Cj(){return{wcomponents_by_id:{},knowledge_views_by_id:{}}}function Sb(){const e=oj(),{storage_location:t}=e.args,n=lC({storage_location:t});return{controls:W3({storage_location:t}),creation_context:G3(),filter_context:X3(),specialised_objects:Cj(),last_action:void 0,display_options:Y3(),sync:tC(),routing:e,global_keys:xj(),meta_wcomponents:Sj(),search:Q3(),user_info:n,view_priorities:Aj(),derived:kj()}}function Li(e){const{current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,disable_if_not_present:o,display_side_panel:s,display_time_sliders:r}=e;let{created_at_ms:a,selected_wcomponent_ids_set:c}=e,l,d=[];if(t){const{composed_wc_id_map:u,composed_visible_wc_id_map:f,wc_ids_by_type:m}=t,h=n[i];l=h&&Ae(h);const{any_node:v}=m;c=new Set(c),c.delete(i);const g=jj({initial_wcomponent:h,disable_if_not_present:o,composed_visible_wc_id_map:f,selected_wcomponent_ids_set:c,wcomponents_by_id:n,composed_wc_id_map:u,display_side_panel:s,display_time_sliders:r,any_node:v});d=g.positions,g.wcomponent_created_at_ms&&(l=Math.max(g.wcomponent_created_at_ms,l||0)),l&&(a=Math.max(a,l))}return{positions:d,go_to_datetime_ms:a}}function $j(e){const{current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,selected_wcomponent_ids_set:o,created_at_ms:s,disable_if_not_present:r}=e,a={current_composed_knowledge_view:t,wcomponents_by_id:n,initial_wcomponent_id:i,selected_wcomponent_ids_set:o,created_at_ms:s,disable_if_not_present:r},{positions:c,go_to_datetime_ms:l}=Li({...a,display_side_panel:!1,display_time_sliders:!1}),d=Li({...a,display_side_panel:!0,display_time_sliders:!1}).positions,u=Li({...a,display_side_panel:!1,display_time_sliders:!0}).positions,f=Li({...a,display_side_panel:!0,display_time_sliders:!0}).positions;return{positions_no_sidepanel_or_timesliders:c,positions_sidepanel_no_timesliders:d,positions_timesliders_no_sidepanel:u,positions_with_sidepanel_or_timesliders:f,go_to_datetime_ms:l}}function jj(e){const{initial_wcomponent:t,disable_if_not_present:n,composed_visible_wc_id_map:i,selected_wcomponent_ids_set:o,wcomponents_by_id:s,composed_wc_id_map:r,display_side_panel:a,display_time_sliders:c,any_node:l}=e;let d=[],u;const f={display_side_panel:a,display_time_sliders:c},m=r[(t==null?void 0:t.id)||""];if(t&&m){const{left:h,top:v}=$C(m,!!t.summary_image),g=hi({left:h,top:v,zoom:ze},!0,f);d.push(g)}else if(!n&&i){let h=Vu(o,i),v=qu(h,s,r,f);v.position_groups.length===0&&(h=Vu(l,i),v=qu(h,s,r,f)),u=v.wcomponent_created_at_ms,d=v.position_groups.map(g=>hi({left:(g.min_left+g.max_left)/2,top:(g.min_top+g.max_top)/2,zoom:g.zoom},!0,f))}return{positions:d,wcomponent_created_at_ms:u}}function qu(e,t,n,i){const o=[];let s;const r=Array.from(e);for(let a=0;a<r.length;++a){const c=r[a];if(!c)continue;const l=t[c],d=n[c];if(!l||!d)continue;const u=d.s??1,f=tb(!!l.summary_image),m=d.left-Ne,h=d.left+Ne*u+Ne,v=d.top-f,g=d.top+f*u;if(!o.find(w=>{const k={min_left:Math.min(w.min_left,m),max_left:Math.max(w.max_left,h),min_top:Math.min(w.min_top,v),max_top:Math.max(w.max_top,g)},{zoom:y,fits:S}=Cb(k,i);return S?(w.min_left=k.min_left,w.max_left=k.max_left,w.min_top=k.min_top,w.max_top=k.max_top,w.zoom=y,!0):!1})){if(o.length>10)break;const w={min_left:m,max_left:h,min_top:v,max_top:g,zoom:ze};o.push(w)}s=Ae(l)}return{position_groups:o,wcomponent_created_at_ms:s}}function Cb(e,t){const n=e.max_left-e.min_left,i=e.max_top-e.min_top,o=zl(t.display_side_panel)/n*ze,s=Ll(t.display_time_sliders)/i*ze,r=Math.min(o,s),a=Fl(Math.min(ze,r));return{zoom:a,fits:r>=a}}function Vu(e,t){const n=new Set(e);return e.forEach(i=>{t[i]||n.delete(i)}),n}function ms(e){return e.controls.display_time_sliders}function Tj(e){const t=e.getState();if(!Pj(t)){const n=co(t),i=t.specialised_objects.knowledge_views_by_id[(n==null?void 0:n.default_knowledge_view_id)||""],o=t.derived.knowledge_views[0],s=i||o,r=t.controls.display_side_panel,a=ms(t);if(!s)return;const c=Nj(t,s,r,a),l={subview_id:s.id,...c};e.dispatch(x.routing.change_route({args:l}))}}function Pj(e){const{subview_id:t}=e.routing.args;return!!e.specialised_objects.knowledge_views_by_id[t]}function Nj(e,t,n,i){let o=sb(e,t);o=Xc(e,o);const{wcomponents_by_id:s}=e.specialised_objects,r=e.routing.item_id||"",{created_at_ms:a}=e.routing.args,{selected_wcomponent_ids_set:c}=e.meta_wcomponents,l=Li({current_composed_knowledge_view:o,wcomponents_by_id:s,initial_wcomponent_id:r,selected_wcomponent_ids_set:c,created_at_ms:a,disable_if_not_present:!1,display_side_panel:n,display_time_sliders:i});return{x:0,y:0,z:0,...l.positions[0],created_at_ms:l.go_to_datetime_ms}}function Ej(e){const t=e.getState();if(!t.sync.ready_for_reading||t.derived.knowledge_views.length)return;const n=_t(t);if(n===void 0){console.error("Can not create knowledge view without chosen_base_id");return}const i=We({title:"All",base_id:n},t.creation_context);e.dispatch(x.specialised_object.upsert_knowledge_view({knowledge_view:i}))}function Ij(e){const t=new Set(["wcomponents","knowledge_views"]);let n=[],i=[];if(e){delete e.wcomponent_ids_to_delete;const r=Object.keys(e).filter(l=>!t.has(l));if(r.length)throw new Error(`Unexpected keys "${r.join(", ")}" in specialised objects state`);const a=Array.from(t).filter(l=>!e.hasOwnProperty(l));if(a.length)throw new Error(`Expected keys "${a.join(", ")}" missing in specialised objects state`);n=e.wcomponents.map(Pl);const c=new Set(n.map(({id:l})=>l));i=e.knowledge_views.map(l=>jl(l,c,!0))}return{wcomponents:n,knowledge_views:i}}function Rj(e){try{return Ij(e)}catch(t){throw console.error("Error parsing specialised objects state from server"),t}}async function Dj(e,t){if(!e)return Promise.resolve(aC);const n=Ce(),i=await Cw({supabase:n,base_id:t});if(i.error)return Promise.reject(i.error);const o=await l3({supabase:n,base_id:t});if(o.error)return Promise.reject(o.error);const s=await d3({supabase:n,base_id:t,knowledge_views:i.value,wcomponents:o.value});if(s.error)return Promise.reject(s.error);const r=await t3({supabase:n,knowledge_views:i.value,wcomponents_from_other_bases:s.wcomponents});if(r.error)return Promise.reject(r.error);const a=[...o.value,...s.wcomponents],c=[...i.value,...r.value];return Promise.resolve({knowledge_views:c,wcomponents:a})}function Ks(e){let t=e.getState();const{dispatch:n}=e,{chosen_base_id:i}=t.user_info;i!==t.sync.specialised_objects.loading_base_id&&(e.dispatch(x.specialised_object.clear_from_mem_all_specialised_objects()),i!==void 0&&(n(x.sync.update_sync_status({status:"LOADING",data_type:"specialised_objects",loading_base_id:i})),Dj(e.load_state_from_storage,i).then(o=>Rj(o)).then(o=>{n(x.specialised_object.replace_all_specialised_objects({specialised_objects:o})),n(x.sync.update_sync_status({status:"LOADED",data_type:"specialised_objects"})),Ej(e),Tj(e)}).catch(o=>{const s=Pw(o);console.error(o),n(x.sync.update_sync_status({status:"FAILED",data_type:"specialised_objects",error_message:s}))})))}function Oj(e){H.user.sub("changed_bases",()=>{const{ready_for_reading:o}=e.getState().sync;o||Ks(e)}),H.user.sub("changed_chosen_base_id",()=>Ks(e));const t=e.getState(),{user:n,chosen_base_id:i}=t.user_info;n&&i!==void 0&&Ks(e),Mj(e)}function Mj(e){const t=Ce(),n=Vw(async()=>{const i=e.getState();if(!i.sync.wcomponent_ids_to_search_for_in_any_base.size)return;const o=Array.from(i.sync.wcomponent_ids_to_search_for_in_any_base);e.dispatch(x.sync.searching_for_wcomponents_by_id_in_any_base());const s=await jw({supabase:t,ids:o});e.dispatch(x.sync.searched_for_wcomponents_by_id_in_any_base({ids:o})),e.dispatch(x.specialised_object.add_wcomponents_to_store({wcomponents:s.wcomponents}))},50);e.subscribe(async()=>{const i=e.getState();i.sync.ready_for_reading&&i.sync.wcomponent_ids_to_search_for_in_any_base.size&&n.throttled()}),H.user.sub("changed_chosen_base_id",()=>{n.cancel()})}function qj(e,t){if(e&&vw(t))return!0}function Vj(e,t){let n=performance.now();const i=30*1e3;window.onbeforeunload=()=>{const o=t.getState();let s=qj(e,o);return s&&(s=performance.now()-n>i),s&&(n=performance.now()),s}}async function Fj(e){const n=await Ce().from("bases").select("*, access_controls(access_level,user_id)").order("inserted_at",{ascending:!0}),i=n.data?n.data.map(o=>Lj(o,o.access_controls,e)):void 0;return{error:n.error,data:i}}async function zj(e){const{owner_user_id:t,title:n="Primary"}=e,o=await Ce().from("bases").insert({owner_user_id:t,title:n}).select();return{base:o.data&&o.data[0]||void 0,error:o.error}}function $b(e){return{id:e.id,inserted_at:e.inserted_at,updated_at:e.updated_at,owner_user_id:e.owner_user_id,public_read:e.public_read,title:e.title,default_knowledge_view_id:e.default_knowledge_view_id}}function Lj(e,t,n){let{inserted_at:i,updated_at:o}=e;const{owner_user_id:s,public_read:r}=e;i=new Date(i),o=new Date(o);const a=t==null?void 0:t.find(d=>d.user_id===n),c=(a==null?void 0:a.access_level)||(n===s?"owner":r?"viewer":"none"),l=c==="owner"||c==="editor";return{...$b(e),inserted_at:i,updated_at:o,access_level:c,can_edit:l}}async function Bj(e){const t=$b(e);return await Ce().from("bases").update(t).eq("id",t.id)}async function tl(e,t=!1){e||(e=Se()),t&&e.dispatch(x.user_info.update_bases({bases:void 0}));const{user:n}=e.getState().user_info;e.dispatch(x.sync.update_sync_status({status:"LOADING",data_type:"bases"}));const{data:i,error:o}=await Fj(n==null?void 0:n.id);e.dispatch(x.user_info.update_bases({bases:i}));const s=o?"FAILED":"LOADED";return e.dispatch(x.sync.update_sync_status({status:s,data_type:"bases"})),{error:o||void 0}}function Uj(e){if(!e.load_state_from_storage)return;const t=e.getState(),{users_by_id:n}=t.user_info;n||Fu(e),H.user.sub("changed_user",()=>{var s;(s=co(e.getState()))!=null&&s.public_read||e.dispatch(x.specialised_object.clear_from_mem_all_specialised_objects()),H.user.pub("stale_users_by_id",!0),H.user.pub("stale_bases",!0)}),H.user.sub("stale_users_by_id",s=>{s&&e.dispatch(x.user_info.set_users({users:void 0})),Fu(e)}),H.user.sub("stale_bases",s=>{tl(e,s)});let i=!0;const o=Ce();o.auth.onAuthStateChange(()=>{setTimeout(async()=>{const s=e.getState().user_info.user,a=(await o.auth.getUser()).data.user||void 0;(s==null?void 0:s.id)!==(a==null?void 0:a.id)?e.dispatch(x.user_info.set_user({user:a})):i&&tl(e),i=!1},0)})}async function Fu(e){const t=Ce(),{data:n,error:i}=await t.from("users").select();i&&console.error("Error getting users",i),n&&e.dispatch(x.user_info.set_users({users:n}))}let Ys;function Se(e={}){const{use_cache:t=!0,override_preloaded_state:n={},load_state_from_storage:i=!1}=e;if(Ys&&t)return Ys;const o={...Sb(),...n},s=yb(o),r=kk(s,o);r.load_state_from_storage=i,Ys=r;const a=()=>{const c=r.getState();dC(c),Dw(r)};return r.subscribe(a),Vj(i,r),r.subscribe(G$(r)),r.subscribe(bj(r)),A3(r),M3(r),I3(r),zx(r),B3(r),Z$.sync_storage_location_subscriber(r),Uj(r),Oj(r),b3(r),x3(r),r}const jb="VAP_uncertainty_id__undefined__",Tb="VAP_false_id__undefined__";function Wj(e,t){let n=t===N.boolean?e.entries.slice(0,1):e.entries;return n=Hj(n,t),{...e,entries:n}}function Hj(e,t){if(t===N.boolean){const n=e[0];if(!n)return e;const i={...n,probability:1-n.probability,id:Tb,value_id:ve.boolean_false,description:""};e=[{...n,value_id:ve.boolean_true},i]}return e}function Gj(e,t){const n=1-e,i={VAP_id:jb,value_id:ve.uncertainty,value_text:"?",certainty:n,parsed_value:null};return[...t,i]}function fs(e){const{VAP_set_id_to_counterfactual_v2_map:t}=e;let{VAP_set:n}=e;const i=(t==null?void 0:t[n.id])||[];let o=!1,s;return i.forEach(r=>{const{target_VAP_id:a}=r;a&&(n=Kj(n,a),o=!0,s=r.id)}),{...n,has_any_counterfactual_applied:o,active_counterfactual_v2_id:s}}function Kj(e,t){const n=t===jb?0:1,i={...e.shared_entry_values,conviction:n},o=e.entries.map(s=>{const r=s.id===t?1:0;return{...s,probability:r,relative_probability:0,conviction:n}});return{...e,shared_entry_values:i,entries:o,target_VAP_id:t}}function mo(e,t){const n=e[0];return t===N.boolean&&n?[n]:e.sort((i,o)=>i.probability>o.probability?-1:i.probability<o.probability?1:0)}function Yj(e,t){const n=mo(e,t),i=n[0];if(!i)return[];const{probability:o}=i;return n.filter(s=>s.probability===o)}function Sn(e){const{wcomponent:t,VAP_set_id_to_counterfactual_v2_map:n,created_at_ms:i,sim_ms:o}=e;if(!Ge(t))return{most_probable_VAP_set_values:[],not_allowed_VAP_set_values:!0};const r=se(t,{}),{values_and_prediction_sets:a=[]}=t,{present_item:c}=xn({items:a,created_at_ms:i,sim_ms:o}),l=c===void 0?void 0:fs({VAP_set:c,VAP_set_id_to_counterfactual_v2_map:n}),{most_probable_VAP_set_values:d,any_uncertainty:u}=Jj(l,r);let f=[l==null?void 0:l.active_counterfactual_v2_id,t._derived__using_value_from_wcomponent_id].filter(be);return f=f.length?f:void 0,{most_probable_VAP_set_values:d,any_uncertainty:u,counterfactual_applied:l==null?void 0:l.has_any_counterfactual_applied,derived__using_value_from_wcomponent_ids:f}}function Jj(e,t){if(!e||e.entries.length===0)return{most_probable_VAP_set_values:[],any_uncertainty:!1};const n=mo(e.entries,t);let i=!1,o=[];for(const s of n){const r=yl(s,t),a=Kw(s),c=mC(s);if(i=i||c,t===N.boolean||c||s.probability!==0){const d={probability:s.probability,conviction:s.conviction,certainty:a,original_value:s.value,parsed_value:r,value_id:s.value_id};if(s.probability===1&&s.conviction===1){i=!1,o=[d];break}o.push(d)}}return{most_probable_VAP_set_values:o,any_uncertainty:i}}function Bl(e,t){let n="",i="";if(Ze(e)){const{value_possibilities:o={}}=e,s=o[ve.boolean_true],r=o[ve.boolean_false];n=(s==null?void 0:s.value)||n,i=(r==null?void 0:r.value)||i}return n=n?t?n+" (True)":n:"True",i=i?t?i+" (False)":i:"False",{true:n,false:i}}function Pb(e,t){let n;return typeof e=="boolean"?n=e?t.true:t.false:n=`${e}`,n}function hs(e){const{most_probable_VAP_set_values:t,any_uncertainty:n,counterfactual_applied:i,derived__using_value_from_wcomponent_ids:o}=Sn(e),s=Bl(e.wcomponent),r=[];t.forEach(l=>{const d=Pb(l.parsed_value,s);r.push(d)});const a=t.length>0,c=Xj(r);return a?{values_string:c,counterfactual_applied:i,uncertain:n,derived__using_values_from_wcomponent_ids:o}:void 0}const Js=3;function Xj(e){let t=e.slice(0,Js).join(", ").trim()||"not defined";return e.length>Js&&(t+=`, (${e.length-Js} more)`),t}function Zj(e){let t="";if(we(e.wcomponent)){const n=e.wcomponents_by_id[e.wcomponent.from_id],i=e.wcomponents_by_id[e.wcomponent.to_id];(n||i)&&(t=`${n?"@@"+n.id:"_"} -> ${i?"@@"+i.id:"_"} <auto generated>`)}else if(vl(e.wcomponent)){t="Counterfactual (no target set) <auto generated>";const n=e.wcomponent.target_wcomponent_id;n&&(t=`Counterfactual of: @@${n} <auto generated>`)}else if(so(e.wcomponent)){t="Sub state (no target set) <auto generated>";const{target_wcomponent_id:n,selector:i}=e.wcomponent;if(n){if(t=`Sub state of @@${n}`,i!=null&&i.target_value&&(i!=null&&i.target_value_id_type)){const{target_value:o,target_value_id_type:s}=i;let r="";if(s==="id"){const a=e.wcomponents_by_id[n];if(n2(a)){const c=((a==null?void 0:a.value_possibilities)||{})[o];c&&(r=c.value)}}else r=o;t+=": "+r}t+=" <auto generated>"}}else if(vt(e.wcomponent)){t="State value (no target attribute set) <auto generated>";const{attribute_wcomponent_id:n}=e.wcomponent;n&&(t=n?`Alternative state value for @@${n} `:"No target attribute ",t+="<auto generated>")}return t}const Qj=(e,t)=>`✗${e} (${t})`,Nb=(e,t,n="")=>`${e}#wcomponents/${t}`+(n?`&subview_id=${n}`:""),Yo=(e,t,n="□",i="")=>`[${n}](${Nb(e,t,i)})`;function Eb(e,t,n){const{get_title:i,root_url:o,render_links:s,depth_limit:r}=n;if(t>=r)return e;const a=e7(e);return a.length===0||(a.forEach(({id:c,funktion:l})=>{const d=n.wcomponents_by_id[c];if(!i7(l))return;let u="";if(l==="map"){const m=n.knowledge_views_by_id[c],h=(m==null?void 0:m.title)||c;u=Yo(o,d?c:"",h,c)}else if(d)if(l==="url")u=Nb(o,c);else if(l==="value"){const m=new Date().getTime(),h=hs({wcomponent:d,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:m,sim_ms:m});u=(h==null?void 0:h.values_string)||""}else u=s?Yo(o,c):"",l==="title"?u=i(d):l==="description"&&(u+=d.description);else return;const f=new RegExp(`@@${c}.${l}`,"g");e=e.replace(f,u)}),t<r&&(e=Eb(e,t+1,n))),e}function e7(e){return[...e.matchAll(l2),...e.matchAll(c2)].map(n=>({id:n[1].slice(2),funktion:n[2]}))}const t7={url:!0,title:!0,description:!0,map:!0,value:!0},n7=new Set(Object.keys(t7));function i7(e){return n7.has(e)}function Qt(e,t,n){const{root_url:i,depth_limit:o,get_title:s,render_links:r}=n;return bn(e).forEach(c=>{const l=new RegExp(`@@${c}`,"g"),d=n.wcomponents_by_id[c];if(!d){const m=r?Yo(i,c,`@@${c}`):`@@${c}`;e=e.replace(l,Qj(m,"not found"));return}const u=t<o?s(d):`@@${c}`,f=r?Yo(i,c,u):u;e=e.replace(l,f)}),e}const o7=3;var fe=(e=>(e[e.raw=0]="raw",e[e.plain=1]="plain",e[e.rich=2]="rich",e))(fe||{});function Qe(e){const{wcomponent:t,wc_id_to_counterfactuals_map:n,created_at_ms:i,sim_ms:o}=e,s=e.text_type??2;let r=t.title;if(r||(r=Zj(e)),s===0)return r;const a=s7({text:r,wcomponent:t,wc_id_to_counterfactuals_map:n,created_at_ms:i,sim_ms:o});return ni({...e,text:a,text_type:s})}function s7(e){var r;let{text:t}=e;const{wcomponent:n,wc_id_to_counterfactuals_map:i={}}=e;if(!t.includes("${value}"))return t;const o=(r=i[n.id])==null?void 0:r.VAP_sets,s=hs({wcomponent:n,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return s&&(t=t.replace(/\$\{value\}/g,`${s.values_string}`)),t}function ni(e){const{text:t,text_type:n,wcomponents_by_id:i,knowledge_views_by_id:o,depth_limit:s=o7,current_depth:r=0,root_url:a="",wc_id_to_counterfactuals_map:c,created_at_ms:l,sim_ms:d}=e;return n===0?t:r7(t,n,i,o,s,r,a,c,l,d)}function r7(e,t,n,i,o,s,r,a,c,l){t=t===2?s===0?2:1:t;function d(f){return Qe({text_type:t,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:a,created_at_ms:c,sim_ms:l,depth_limit:o,current_depth:s+1,root_url:r,wcomponent:f})}const u={wcomponents_by_id:n,knowledge_views_by_id:i,depth_limit:o,render_links:t===2,root_url:r,get_title:d};return e=Eb(e,s,u),e=Qt(e,s,u),e}function te(e,t){const n={};return e.map(o=>{const s=new xk({timeStart:2020,timeLength:1,timeUnits:"Years"}),r=bn(o.value);let a=Zn(o.value);a=pn(a),a=Gc(a);let c=o.units;c=Xn(a,c,t),c=Gc(c||""),a=Ue(a,r);const l={name:o.name,value:a,units:c},d=s.Variable(l),{warnings:u,errors:f}=_7({model:s,model_component:d,values:n,uuids:r,wcomponents_by_id:t}),m=Ib(s,o.units,d);return r.length===1&&(m.source_wcomponent_id=r[0]),u.length&&(m.warning=u.join(" ")),f.length&&(m.error&&f.unshift(m.error),m.error=f.join(`
`)),n[o.name]=m,m}).map(o=>(o.units=Ko(o.units),o.error&&(o.error=Ko(o.error)),o))}function _7(e){const{model:t,model_component:n,values:i,uuids:o,wcomponents_by_id:s}=e,r={};Object.entries(i).forEach(([u,f])=>{if(f.value!==void 0){const m=t.Variable({name:u,value:f.value,units:f.units});r[u]=m}});const a=new Date().getTime(),c=[],l=[];return o.map(u=>{const f=s[u];if(!f)return l.push(`Could not find wcomponent with id: @@${u}.  Defaulting to value of 1.`),u;const{most_probable_VAP_set_values:m,not_allowed_VAP_set_values:h}=Sn({wcomponent:f,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:a,sim_ms:a}),v=Qe({wcomponent:f,wcomponents_by_id:s,knowledge_views_by_id:{},wc_id_to_counterfactuals_map:void 0,created_at_ms:a,sim_ms:a})||"no title";if(f.type==="action"||h)return c.push(`The wcomponent "${v}" (@@${u}) is of type "${f.type}".  Defaulting to value of 1.`),u;if(m.length===0)return c.push(`The wcomponent "${v}" (@@${u}) is missing any value and prediction sets.  Defaulting to value of 1.`),u;let g=m[0].parsed_value;if(g===null)return c.push(`The wcomponent "${v}" (@@${u}) has an invalid number "${m[0].original_value}".  Defaulting to value of 1.`),u;if(Number.isNaN(g))return c.push(`The wcomponent "${v}" (@@${u}) has an invalid number "${m[0].original_value}".  Defaulting to value of 1.`),u;typeof g=="boolean"&&(g=g?1:0);const b=t.Variable({name:u,value:g,units:""});return r[u]=b,""}).filter(u=>u.length>0).forEach(u=>{const f=t.Variable({name:u,value:1,units:""});r[u]=f}),Object.values(r).forEach(u=>{t.Link(u,n)}),{warnings:c,errors:l}}function Ib(e,t,n,i=!1){let o,s="",r=n._node.getAttribute("Units");try{o=e.simulate()._data.data[0][n._node.id]}catch(c){const l=c,d=typeof l.message=="string"&&l.message.startsWith("Wrong units generated for")&&l.message.match(/and got (.+?)\.(?:$| Either)/);if(!t&&d&&!i){r=d[1],n.units=r;const u=Ib(e,t,n,!0);({value:o,units:r}=u),u.error&&(s=u.error)}else s=`${l.message||"Unknown calculation error"}`}const a={value:o,error:s,units:r};return a.error||delete a.error,a.units==="Unitless"&&(a.units=""),a}const a7=A.delay("perform_calculations",()=>{let e=[],t=[],n=[];A("basic functionality",()=>{e=[];const r={};n=[],t=te(e,r),p(t,n,"No calculations should return no results"),e=[{id:0,name:"A",value:"3"},{id:1,name:"B",value:"4"},{id:2,name:"C",value:"[A] + [B]"}],t=te(e,r),n=[{value:3,units:""},{value:4,units:""},{value:7,units:""}],p(t,n,"3 simple calculations should return 3 results"),e=[{id:0,name:"A",value:"3 + 1"},{id:1,name:"C",value:"[A] + [some_undeclared_variable]"},{id:2,name:"D",value:"5 + 1"}],t=te(e,r),n=[{value:3+1,units:""},{value:void 0,error:"The primitive [some_undeclared_variable] could not be found.",units:""},{value:5+1,units:""}],p(t,n,"Failure to find a value should still perform other valid calculations"),e=[{id:0,name:"A",value:"1 + 1"},{id:1,name:"A",value:"[A] * 2"},{id:2,name:"A",value:"[A] * 2"}],t=te(e,r),n=[{value:1+1,units:""},{value:4,units:""},{value:8,units:""}],p(t,n,"Can cope with self reference"),e=[{id:0,name:" A ",value:"1 + 1"},{id:1,name:"B",value:"[ A ] * 2"}],t=te(e,r),n=[{value:1+1,units:""},{value:4,units:""}],p(t,n,"Can cope with references with spaces")}),A("formatting functionality",()=>{const r={};n=[],t=te(e,r),e=[{id:0,name:"A",value:"3,000,100.200"}],t=te(e,r),n=[{value:30001002e-1,units:""}],p(t,n,"Should be able to ignore commas")});const i=ie(1),o=0;let s;A("Can use wcomponent values",()=>{s=Ee(N.number,void 0,[],o,{}),s.entries[0].value="12.3";const r=q({base_id:o,id:i,title:"Some state component",type:"statev2",values_and_prediction_sets:[s],units:"seconds"}),a={[i]:r};e=[{id:0,name:"A",value:`@@${i}`,units:"meters"}],t=te(e,a),n=[{value:12.3,units:"seconds",source_wcomponent_id:i}],p(t,n,"Can access a wcomponent's value and overrides any units given in calculation with wcomponent's units"),e=[{id:0,name:"A",value:`@@${i} * 10`,units:"meters"}],t=te(e,a),n=[{value:123,units:"meters",source_wcomponent_id:i}],p(t,n,"Can reference wcomponent values in a calculation and uses units given, overriding components units"),e=[{id:0,name:"A",value:`@@${i} * @@${i}`,units:"meters"}],t=te(e,a),n=[{value:151.29,units:"meters"}],p(t,n,"Can reference same wcomponent values in a calculation but then will not give a reference to the original wcomponent i.e. wcomponent_id will be undefined"),e=[{id:0,name:"A",value:`{@@${i} meters}`}],t=te(e,a),n=[{value:12.3,units:"meters",source_wcomponent_id:i}],p.skip(t,n,"Skipping because Simulation.JS does not allow referencing and setting units: ~~Calculations can reference wcomponent values and assign units~~"),e=[{id:0,name:"A",value:`@@${i}.value`,units:"meters"}],t=te(e,a),n=[{value:void 0,units:"meters",source_wcomponent_id:i,error:"Object function not used on object"}],p(t,n,'Can not currently access the ".value" of a component in an equation')}),A("Can use wcomponent boolean values",()=>{s=Ee(N.boolean,void 0,[],o,{}),p(s.entries[1].value_id,ve.boolean_false,"Test is setting the correct VAP set entry"),s.entries[1].probability=1;const r={[i]:q({base_id:o,id:i,type:"statev2",subtype:"boolean",values_and_prediction_sets:[s]})};e=[{id:0,name:"A",value:`IfThenElse(@@${i}, 15, 10)`}],t=te(e,r),n=[{value:10,units:"",source_wcomponent_id:i}],p(t,n,"Can use wcomponent boolean values")}),A("Can use values with units",()=>{e=[{id:0,name:"A",value:"{2 Meters} + {10 Centimeters}",units:"Meters"}],t=te(e,{}),n=[{value:2.1,units:"Meters"}],p(t,n,"Computes correct value and includes units in result")}),A("Can use values without units being initially defined",()=>{e=[{id:0,name:"A",value:"{2 Meters}"}],t=te(e,{}),n=[{value:2,units:"Meters"}],p(t,n,"Computes correct units")}),A("Can use values with units initially being undefined",()=>{e=[{id:0,name:"A",value:"{2 Meters}",units:void 0}],t=te(e,{}),n=[{value:2,units:"Meters"}],p(t,n,"Computes correct units")}),A("Does not compute units if some are already specified",()=>{e=[{id:0,name:"A",value:"{2 Meters}",units:"kg"}],t=te(e,{}),n=[{value:void 0,units:"kg",error:"Wrong units generated for [A]. Expected Kg, and got Meters."}],p(t,n,"Computes correct units")}),A(`Sets units to "" if 'Unitless' is specified`,()=>{e=[{id:0,name:"A",value:"2",units:"Unitless"}],t=te(e,{}),n=[{value:2,units:""}],p(t,n,'Computes correct units of "" when "Unitless" is specified'),e=[{id:0,name:"A",value:"{2 Meters}",units:"Unitless"}],t=te(e,{}),n=[{value:void 0,units:"",error:"Wrong units generated for [A]. Expected no units and got Meters. Either specify units for the primitive or adjust the equation."}],p(t,n,'Computes correct units of "" when "Unitless" is specified as the units even though it conflicts with units given in calculation')}),A("Can process numbers with thousands comma seperators",()=>{e=[{id:0,name:"A",value:"1,200,300e4 / {4,001,000e3 km}",units:"1/km"}],t=te(e,{}),n=[{value:3,units:"1/km"}],p(t,n,"Can compute numbers with thousands commas")}),A("Can process numbers with compound units",()=>{e=[{id:0,name:"A",value:"{7 Widgets/Years^2}*{10 Years}",units:"Widgets/Years"}],t=te(e,{}),n=[{value:70,units:"Widgets/Years"}],p(t,n,"Widgets/Years^2  *  Years")}),A("hide_currency_symbols",()=>{e=[{id:0,name:"A",value:"{90 £ / year}",units:""},{id:1,name:"B",value:"{10 £ / year}",units:""},{id:2,name:"C",value:"[A]+[B]",units:""}],t=te(e,{}),n=[{value:90,units:"£/(Year)"},{value:10,units:"£/(Year)"},{value:100,units:"£/(Year)"}],p(t,n,"Handles currency symbols specified inside curly braces"),e=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"£ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],t=te(e,{}),n=[{value:90,units:"£ / year"},{value:10,units:"£ / year"},{value:100,units:"£ / year"}],p(t,n,"Handles currency symbols specified inside units field, and preserves them precisely"),e=[{id:0,name:"A",value:"90",units:"£ / year"},{id:1,name:"B",value:"10",units:"$ / year"},{id:2,name:"C",value:"[A]+[B]",units:"£ / year"}],t=te(e,{}),n=[{value:90,units:"£ / year"},{value:10,units:"$ / year"},{value:void 0,units:"£ / year",error:"Incompatible units for the addition of £/(Year) and $/(Year)."}],p(t,n,"Correctly formats currency symbols in error messages")}),A("Handles reserved words correctly",()=>{e=[{id:0,name:"A",value:"0.5 * (180 / Pi)"}],t=te(e,{}),n=[{value:28.6478897565412,units:""}],p(t,n,'Can run calculations using reserved word "Pi"')}),A("Defaults to 1 for missing or invalid or incomplete components",()=>{e=[{id:0,name:"A",value:`1 + @@${i}`}],A("Missing component",()=>{n=[{value:2,units:"",source_wcomponent_id:i,error:`Could not find wcomponent with id: @@${i}.  Defaulting to value of 1.`}],t=te(e,{}),p(t,n,"Can run calculations using missing uuids.  Will default to 1 and provide a warning.")}),A("Invalid component: action type",()=>{n=[{value:2,units:"",source_wcomponent_id:i,warning:`The wcomponent "no title" (@@${i}) is of type "action".  Defaulting to value of 1.`}];const r={[i]:q({base_id:o,id:i,type:"action",values_and_prediction_sets:[]})};t=te(e,r),p(t,n,"Can run calculations using actions.  Will default to 1 and provide a warning.")}),A("Invalid component: statev2 with subtype number but invalid number parsed to null",()=>{n=[{value:2,units:"",source_wcomponent_id:i,warning:`The wcomponent "no title" (@@${i}) has an invalid number "".  Defaulting to value of 1.`}],s=Ee(N.number,void 0,[],o,{}),s.entries[0].value="";const r={[i]:q({base_id:o,id:i,type:"statev2",subtype:"number",values_and_prediction_sets:[s]})};t=te(e,r),p(t,n,"Can run calculations using statev2 with invalid number of null.  Will default to 1 and provide a warning.")}),A("Invalid component: statev2 with subtype number but invalid number parsed to NaN",()=>{n=[{value:2,units:"",source_wcomponent_id:i,warning:`The wcomponent "no title" (@@${i}) has an invalid number "some invalid number".  Defaulting to value of 1.`}],s=Ee(N.number,void 0,[],o,{}),s.entries[0].value="some invalid number";const r={[i]:q({base_id:o,id:i,type:"statev2",subtype:"number",values_and_prediction_sets:[s]})};t=te(e,r),p(t,n,"Can run calculations using statev2 with invalid number of NaN.  Will default to 1 and provide a warning.")}),A("Incomplete component: statev2 type with no VAP sets",()=>{n=[{value:2,units:"",source_wcomponent_id:i,warning:`The wcomponent "no title" (@@${i}) is missing any value and prediction sets.  Defaulting to value of 1.`}];const r={[i]:q({base_id:o,id:i,type:"statev2",values_and_prediction_sets:[]})};t=te(e,r),p(t,n,"Can run calculations using statev2 with no VAPsets.  Will default to 1 and provide a warning.")})}),A("Coerces statev2 wcomponents with boolean subtype into 0 or 1",()=>{e=[{id:0,name:"A",value:`1 + @@${i}`}],A("coerces true to 1",()=>{n=[{value:2,units:"",source_wcomponent_id:i}],s=Ee(N.boolean,void 0,[],o,{}),p(s.entries[0].value_id,ve.boolean_true,"Test is setting the correct VAP set entry"),s.entries[0].probability=1;const r={[i]:q({base_id:o,id:i,type:"statev2",subtype:"boolean",values_and_prediction_sets:[s]})};t=te(e,r),p(t,n,"Can run calculations using statev2 boolean subtypes.  Will coerce true to 1 and not provide a warning.")}),A("coerces false to 0",()=>{n=[{value:1,units:"",source_wcomponent_id:i}],s=Ee(N.boolean,void 0,[],o,{}),p(s.entries[1].value_id,ve.boolean_false,"Test is setting the correct VAP set entry"),s.entries[1].probability=1;const r={[i]:q({base_id:o,id:i,type:"statev2",subtype:"boolean",values_and_prediction_sets:[s]})};t=te(e,r),p(t,n,"Can run calculations using statev2 boolean subtypes.  Will coerce false to 0 and not provide a warning.")})})}),Fe={_0:0,_5:.08726646259971647,_10:.17453292519943295,_15:.2617993877991494,_20:.3490658503988659,_25:.4363323129985824,_30:.5235987755982988,_35:.6108652381980153,_40:.6981317007977318,_45:.7853981633974483,_50:.8726646259971648,_55:.9599310885968813,_60:1.0471975511965976,_65:1.1344640137963142,_70:1.2217304763960306,_75:1.3089969389957472,_80:1.3962634015954636,_85:1.48352986419518,_90:1.5707963267948966,_95:1.6580627893946132,_100:1.7453292519943295,_105:1.8325957145940461,_110:1.9198621771937625,_115:2.007128639793479,_120:2.0943951023931953,_125:2.1816615649929116,_130:2.2689280275926285,_135:2.356194490192345,_140:2.443460952792061,_145:2.530727415391778,_150:2.6179938779914944,_155:2.705260340591211,_160:2.792526803190927,_165:2.8797932657906435,_170:2.96705972839036,_175:3.0543261909900767,_180:3.141592653589793,_185:3.2288591161895095,_190:3.3161255787892263,_195:3.4033920413889422,_200:3.490658503988659,_205:3.5779249665883754,_210:3.6651914291880923,_215:3.752457891787808,_220:3.839724354387525,_225:3.9269908169872414,_230:4.014257279586958,_235:4.101523742186674,_240:4.1887902047863905,_245:4.276056667386108,_250:4.363323129985823,_255:4.4505895925855405,_260:4.537856055185257,_265:4.625122517784973,_270:4.71238898038469,_275:4.799655442984406,_280:4.886921905584122,_285:4.974188368183839,_290:5.061454830783556,_295:5.148721293383272,_300:5.235987755982989,_305:5.323254218582705,_310:5.410520681182422,_315:5.497787143782138,_320:5.585053606381854,_325:5.672320068981571,_330:5.759586531581287,_335:5.846852994181004,_340:5.93411945678072,_345:6.021385919380437,_350:6.1086523819801535,_355:6.19591884457987};function Lo(e,t,n,i){const o=i-t,s=n-e;return Math.atan2(o,s)}const zu=Math.PI*2;function c7(e){return e+zu*Math.floor((Math.PI-e)/zu)}function l7(e,t){const n=Rb[t];return e+=1e-4,Db({connection_angle:e,angle_of_normal_to_connector_surface:n,offset_direction:-1})}function d7(e,t){const n=Rb[t];return e+=Math.PI,Db({connection_angle:e,angle_of_normal_to_connector_surface:n,offset_direction:1})}const Lu={left:Fe._180,top:Fe._90,right:0,bottom:-Fe._90},Rb={right:Lu.right,left:Lu.left},No=Fe._50;function Db(e){const t=c7(e.connection_angle-e.angle_of_normal_to_connector_surface),i=Ve(t,-No,No);return Ve(i,-No,No)+e.angle_of_normal_to_connector_surface}const u7=A.skip("get_angle (a lot of the tests are broken and need to be updated to match current working functionality)",()=>{const n=[{ex:10,ey:0},{ex:10,ey:-10},{ex:0,ey:-10},{ex:-10,ey:-10},{ex:-10,ey:0},{ex:-10,ey:10},{ex:0,ey:10},{ex:10,ey:10}],i=["0.00","-0.79","-1.57","-2.36","3.14","2.36","1.57","0.79"];n.forEach(({ex:r,ey:a},c)=>{const l=Lo(0,0,r,a).toFixed(2);p(l,i[c])});const o=["-0.79","-0.87","-0.87","-0.87","0.09","0.09","0.09","0.00"];n.forEach(({ex:r,ey:a},c)=>{const l=Lo(0,0,r,a),d=l7(l,"right").toFixed(2);p(d,o[c])});const s=["3.93","3.14","3.05","3.05","4.01","4.01","4.01","4.01"];n.forEach(({ex:r,ey:a},c)=>{const l=Lo(0,0,r,a),d=d7(l,"left").toFixed(2);p(d,s[c])})});function Xe(e,t){if(e===0)return 0;const n=Math.pow(10,t-Math.floor(Math.log10(Math.abs(e)))-1);return Math.round(e*n)/n}function Lt(e,t){const n=t*Math.cos(e),i=t*Math.sin(e);return{x:n,y:i}}function oi(e,t){return{x:e.x+t.x,y:e.y+t.y}}var Bt=(e=>(e[e.positive=0]="positive",e[e.negative=1]="negative",e[e.noop=2]="noop",e))(Bt||{});function p7(e){const{type:t,x:n,y:i,end_angle:o,opacity:s,blur:r,size:a,is_hovered:c,is_highlighted:l}=e;let d=`${l?"highlighted":""} ${c?"hovered":""}`;const u=s*(1-r/100),f={fillOpacity:u};let m;t===0?m=f7(o,a):t===1?m=g7(o,a):(f.fillOpacity=0,f.strokeOpacity=u,m=b7(o),d+=" noop_end ");const h=m7({x:n,y:i},m);return _("polygon",{className:"connection_end "+d,points:h,style:f})}function m7(e,t){const{x:n,y:i}=e;let o=`${n}, ${-i} `;return t.forEach(s=>o+=`${n+s.x}, ${-i-s.y} `),o}function f7(e,t){const n=Bu(e,1,t),i=Bu(e,-1,t);return[n,i]}const h7=Fe._25;function Bu(e,t,n){return Lt(e+t*h7,n)}const Ob=12,v7=Ob/2,nl=4;function g7(e,t){t=t/10;const n=Lt(e+Fe._90,v7*t),i=oi(Lt(e,nl*t),n),o=oi(Lt(e-Fe._90,Ob*t),i),s=oi(Lt(e-Fe._180,nl*t),o);return[n,i,o,s]}const Bi=9,w7=Math.sin(Fe._45)*Bi*2;function b7(e){const t=Lt(e+Fe._315,Bi),n=oi(Lt(e+Fe._45,Bi),t),i=oi(Lt(e+Fe._135,Bi),n),o=oi(Lt(e+Fe._225,Bi),i);return[t,n,i,o]}const y7=12,Jo=y7/2,k7=-6,x7=27;let Mb=22;try{navigator.platform.indexOf("Win")>-1&&(Mb=17)}catch{}const A7={meta:0,validity:1,state:2};function qb(e,t=1){const n=A7[e.attribute],i=t**1.14,o=(x7+n*Mb)*i;return{left:k7+(e.side==="right"?Ne:0)*t,top:o}}function Xo(e){const{kv_wc_entry:t,wcomponent_type:n,connection_terminal_type:i}=e;if(li(n))return t;const s=t.s||1;let{left:r,top:a}=qb(i,s);return r+=t.left+Jo,a+=t.top+Jo,{left:r,top:a}}const S7=45,Uu=e=>{let t=0;if(li(e.wcomponent_type))t=0;else{const{s:n=1}=e.kv_wc_entry;t=Ne*n}return t+S7},C7=30,Xs=30,Wu=150;function Oe(e){e.end_size===0&&((e.console_warn||console.warn)(`Invalid connection end_size "${e.end_size}", defaulting to 1`),e.end_size=1);const{connection_from_component:t,connection_to_component:n,line_behaviour:i,circular_links:o,end_size:s,connection_end_type:r}=e;if(!t||!n)return j7(e);if(i==="angular")return T7({connection_from_component:t,connection_to_component:n,end_size:s,connection_end_type:r});const{offset_line_start_y:a,offset_connection_start_y:c,invert_end_angle:l,circular_link_from_below_to:d}=$7({circular_links:o,connection_from_component:t,connection_to_component:n}),u=Xo(t),f=u.left,m=-u.top+a,h=Xo(n),v=h.left,g=-h.top+c;let b=1,w=1;d!==void 0&&(f<v?d?b=-1:w=-1:d?w=-1:b=-1);let k={x:0,y:0},y=k,T=Lo(f,m,v,g)+Fe._180;if(i===void 0||i==="curve"){const C=(v-f)/2,O=Math.max(Math.abs(C),Xs)*(Math.sign(C)||-1);let M=O*b,P=-O*w,L=0,J=0;const Ke=v<=f;if(!o&&Ke){const ct=g-m;M=Math.min(-M,300),P=Math.max(-P,-300),L=ct||-Xs,J=-ct||-Xs}T=l?0:Fe._180,k={x:M,y:L},y={x:P,y:J}}const{line_end_x:$,line_end_y:R}=Vb({connection_end_type:r,end_size:s,end_angle:T,connection_end_x:v,connection_end_y:g});return{line_start_x:f,line_start_y:m,relative_control_point1:k,relative_control_point2:y,line_end_x:$,line_end_y:R,connection_end_x:v,connection_end_y:g,end_angle:T}}function $7(e){const t={offset_line_start_y:0,offset_connection_start_y:0,invert_end_angle:!1,circular_link_from_below_to:void 0};if(!e.circular_links)return t;const{connection_from_component:n,connection_to_component:i}=e,o=li(n.wcomponent_type),s=li(i.wcomponent_type);let r=o||s?0:C7;return n.kv_wc_entry.left<i.kv_wc_entry.left-Uu(n)||(i.kv_wc_entry.left<n.kv_wc_entry.left-Uu(i)?(t.offset_line_start_y=r,t.offset_connection_start_y=r,i.connection_terminal_type={...i.connection_terminal_type,side:"right"},n.connection_terminal_type={...n.connection_terminal_type,side:"left"},t.invert_end_angle=!0):(t.circular_link_from_below_to=i.kv_wc_entry.top<n.kv_wc_entry.top,t.circular_link_from_below_to?(n.connection_terminal_type={...n.connection_terminal_type,side:"left"},t.offset_line_start_y=r):(i.connection_terminal_type={...i.connection_terminal_type,side:"right"},t.offset_connection_start_y=r,t.invert_end_angle=!0))),t}function j7(e){const{connection_from_component:t,connection_to_component:n,line_behaviour:i,circular_links:o,end_size:s,connection_end_type:r}=e;let a=0;const c={x:0,y:0},l=c;let d;if(t)a=t.kv_wc_entry.left+Ne,d=Xo(t);else{if(!n)return null;a=n.kv_wc_entry.left-Wu,d=Xo(n)}const u=-d.top,f=a+Wu,m=u,h=Fe._180,{line_end_x:v,line_end_y:g}=Vb({connection_end_type:r,end_size:s,end_angle:h,connection_end_x:f,connection_end_y:m});return{line_start_x:a,line_start_y:u,relative_control_point1:c,relative_control_point2:l,line_end_x:v,line_end_y:g,connection_end_x:f,connection_end_y:m,end_angle:h}}function Vb(e){const{connection_end_type:t,end_angle:n,connection_end_x:i,connection_end_y:o}=e,s=e.end_size/10,r=t===Bt.negative?nl*s:t===Bt.noop?w7:9*s,a=i+Math.cos(n)*r,c=o+Math.sin(n)*r;return{line_end_x:a,line_end_y:c}}function T7(e){const{connection_from_component:t,connection_to_component:n,end_size:i,connection_end_type:o}=e,s=80,r=0,a=t.kv_wc_entry,c=n.kv_wc_entry;let l=a.left,d=-a.top,u=c.left,f=-c.top;li(t.wcomponent_type)||(l+=pi*(a.s||1),d-=s*(a.s||1)),li(n.wcomponent_type)||(u+=pi*(c.s||1),f+=r);const m=3.142/2;return{line_start_x:l,line_start_y:d,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:u,line_end_y:f,connection_end_x:u,connection_end_y:f,end_angle:m}}function P7(e){const t=Hu(e.point1,e.relative_control_point1),n=Hu(e.point2,e.relative_control_point2),i=Kn(e.point1,t),o=Kn(t,n),s=Kn(n,e.point2),r=Kn(i,o),a=Kn(o,s);return Kn(r,a)}function Hu(e,t){return{x:e.x+t.x,y:e.y+t.y}}function Kn(e,t){return{x:(e.x+t.x)/2,y:(e.y+t.y)/2}}const N7=A.delay("derive_connection_coords",()=>{let e,t;A("connection between two nodes",()=>{e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ne+100},t=Oe(e),p(tt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:349,line_end_y:-77,connection_end_x:350,connection_end_y:-77,end_angle:3.142},`two nodes not overlapping horizontally
                    [from]----->[to]`),e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ne+10},t=Oe(e),p(tt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:130,y:0},relative_control_point2:{x:130,y:0},line_end_x:511,line_end_y:-47,connection_end_x:510,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other:
                    [from] [to]`),e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:Ne-10},t=Oe(e),p(tt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:120,y:0},relative_control_point2:{x:120,y:0},line_end_x:491,line_end_y:-47,connection_end_x:490,connection_end_y:-47,end_angle:0},`two nodes overlapping horizontally
                    [fr.[to]`),e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:-10},t=Oe(e),p(tt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:241,line_end_y:-47,connection_end_x:240,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally but too close to each other in the other direction
                    [to] [from]`),e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component.kv_wc_entry={top:0,left:-50},t=Oe(e),p(tt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:201,line_end_y:-47,connection_end_x:200,connection_end_y:-47,end_angle:0},`two nodes not overlapping horizontally and far from each other in the other direction
                    [to]<-----[from]`),A("of different sizes",()=>{e=Je();const i=2,o=Ne*i,s=Ne+110,a=Ne*1;e.connection_from_component.kv_wc_entry={top:0,left:0,s:i},e.connection_to_component.kv_wc_entry={top:0,left:s},t=Oe(e),p(tt(t),{line_start_x:o,line_start_y:-160,relative_control_point1:{x:55,y:0},relative_control_point2:{x:55,y:0},line_end_x:s+a+1,line_end_y:-47,connection_end_x:s+a,connection_end_y:-47,end_angle:0},`two nodes that if of same size would not overlap horizontally,
                        [from]----->[to]
                but one is bigger so they do overlap
                        [F R O M]
                             [to ]
            `)})}),e=Je(),e.connection_to_component=e.connection_from_component,t=Oe(e),p(tt(t),{line_start_x:Ne,line_start_y:-77,relative_control_point1:{x:30,y:0},relative_control_point2:{x:30,y:0},line_end_x:Ne+1,line_end_y:-47,connection_end_x:Ne,connection_end_y:-47,end_angle:0},"connection from a node back to itself"),e=Je(),e.end_size=0;let n=[];e.console_warn=(...i)=>n=i,Oe(e),p(n,['Invalid connection end_size "0", defaulting to 1'],"Should log a warning message about invalid end_size: 0,"),A("connection between nothing and a node",()=>{e=Je(),e.connection_from_component=void 0,e.connection_to_component.kv_wc_entry={top:0,left:0},t=Oe(e),p(tt(t),{line_start_x:-150,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"straight line from nothing to one node"),e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component=void 0,t=Oe(e),p(tt(t),{line_start_x:250,line_start_y:-77,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:399,line_end_y:-77,connection_end_x:400,connection_end_y:-77,end_angle:3.142},"straight line from one node to nothing")}),A("connection between a node and a connection",()=>{e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component={kv_wc_entry:{top:0,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},t=Oe(e),p(tt(t),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:0,connection_end_x:-100,connection_end_y:0,end_angle:0},"connect from one node to a second connection"),e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_to_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"left",attribute:"state"}},t=Oe(e),p(tt(t),{line_start_x:0,line_start_y:-77,relative_control_point1:{x:-50,y:0},relative_control_point2:{x:50,y:0},line_end_x:-99.1,line_end_y:200,connection_end_x:-100,connection_end_y:200,end_angle:0},"connect from one node to a second connection above and left"),e=Je(),e.connection_from_component={kv_wc_entry:{top:-200,left:-100},wcomponent_type:"causal_link",connection_terminal_type:{side:"right",attribute:"state"}},e.connection_to_component.kv_wc_entry={top:0,left:0},t=Oe(e),p(tt(t),{line_start_x:-100,line_start_y:200,relative_control_point1:{x:50,y:0},relative_control_point2:{x:-50,y:0},line_end_x:-.9,line_end_y:-77,connection_end_x:0,connection_end_y:-77,end_angle:3.142},"connect from a second connection above and left to a node")}),A("angular connections",()=>{e=Je(),e.connection_from_component.kv_wc_entry={top:0,left:0},e.connection_from_component.wcomponent_type="causal_link",e.connection_to_component.kv_wc_entry={top:200,left:100},e.line_behaviour=ml.angular,t=Oe(e),p(tt(t),{line_start_x:0,line_start_y:0,relative_control_point1:{x:0,y:0},relative_control_point2:{x:0,y:0},line_end_x:100+pi,line_end_y:-200,connection_end_x:100+pi,connection_end_y:-200,end_angle:3.142/2},"connect from a connection above to a node below")})});function Je(){return{connection_from_component:{kv_wc_entry:{top:0,left:0},wcomponent_type:"statev2",connection_terminal_type:{side:"right",attribute:"state"}},connection_to_component:{kv_wc_entry:{top:0,left:Ne+100},wcomponent_type:"statev2",connection_terminal_type:{side:"left",attribute:"state"}},line_behaviour:void 0,circular_links:!0,end_size:1,connection_end_type:Bt.positive}}function tt(e){return e?{line_start_x:Xe(e.line_start_x,2),line_start_y:Xe(e.line_start_y,2),relative_control_point1:{x:Xe(e.relative_control_point1.x,2),y:Xe(e.relative_control_point1.y,2)},relative_control_point2:{x:Xe(e.relative_control_point2.x,2),y:Xe(e.relative_control_point2.y,2)},line_end_x:Xe(e.line_end_x,3),line_end_y:Xe(e.line_end_y,3),connection_end_x:Xe(e.connection_end_x,3),connection_end_y:Xe(e.connection_end_y,3),end_angle:Xe(e.end_angle,4)}:null}function si(e){const{date:t,time_resolution:n,trim_midnight:i}=e;return t&&Wl(t)?io({date:t,time_resolution:n,trim_midnight:i}):""}function Ul(e,t){let n="Eternal";if(!Al(e)){const i=si({date:e.min,time_resolution:t}),o=si({date:e.value,time_resolution:t}),s=si({date:e.max,time_resolution:t});if(o&&!i&&!s)return o;n=[i,i?" ":"","<",o?" ":"",o,o?" ":"","<",s?" ":"",s].filter(a=>a).join("")}return n}function Wl(e){return!Number.isNaN(e.getTime())}function Yi(e){const t=new Date(e);return Wl(t)?t:void 0}const E7=A.delay("correct_datetime_for_local_time_zone",()=>{let e;e=Yi("2021-04-16 15:00"),p(e&&e.toISOString(),"2021-04-16T14:00:00.000Z","Subtracts one hour (as datetime is during summer time BST; and also passes when test is performed during GMT)"),e=Yi("2021-04-16 00:00"),p(e&&e.toISOString(),"2021-04-15T23:00:00.000Z","Subtracts one hour, goes back one day (as datetime is during summer time BST; and also passes when test is performed during GMT)"),e=Yi("2021-04-16"),p.skip(e&&e.toISOString(),"2021-04-15T23:00:00.000Z","")});function F(e){return _(nk,{xsUp:e.is_hidden,children:_(xe,{className:e.className,title:e.title,color:e.color||"primary",style:{...e.style,pointerEvents:"initial"},component:e.component,disabled:e.disabled||!1,disableElevation:e.disableElevation||!0,disableFocusRipple:e.disableFocusRipple||!1,endIcon:e.endIcon,fullWidth:e.fullWidth||!1,href:e.href,size:e.size||"small",startIcon:e.startIcon,variant:e.variant||"contained",onPointerDown:t=>{t.currentTarget.focus(),t.stopImmediatePropagation(),t.preventDefault(),e.onPointerDown&&e.onPointerDown(t)},onClick:t=>{t.currentTarget.focus(),t.stopImmediatePropagation(),t.preventDefault(),e.onClick&&e.onClick(t)},children:e.children||e.value})})}function I7(e,t){for(;e;){const{classList:n}=e;if(n&&n.contains(t))break;e=e.parentElement}return e}function R7(e,t){for(;e;){const{classList:n}=e;if(n&&t.find(i=>n.contains(i)))break;e=e.parentElement}return e}const D7=e=>({time_resolution:e.display_options.time_resolution,presenting:e.display_options.consumption_formatting}),O7=j(D7);function M7(e){const t=F7(e),[n,i]=I(!1),o=t?"":"no_entry",{on_change:s}=e;if(!s)return _("div",{className:o,children:t});const{invariant_value:r,show_now_shortcut_button:a=!1,show_today_shortcut_button:c=!0}=e,l=Gu(t),d=e.editing_allowed!==void 0?!e.editing_allowed:e.presenting,u=`editable_field ${l?"":"invalid"} ${o} ${d?"not_editable":""}`,f=(e.title||"DateTime")+(e.invariant_value&&e.value?" (custom)":"");function m(g){s&&V7(e.value,g)&&s(g)}const h=Ie(void 0),v=Ie(m);return v.current=m,_e(()=>()=>{if(!h.current||!(document.activeElement===h.current))return;const b=Zo({working_value:h.current.value,invariant_value:r});v.current(b)},[]),_("div",{className:u,title:f,children:[_(En,{disabled:d,type:"text",label:f,value:t,onFocus:()=>i(!0),inputRef:g=>{if(!g||(h.current=g,!n))return;const b=Fb(e),w=si({date:b,time_resolution:"minute",trim_midnight:!1});g.value=w,g.setSelectionRange(0,g.value.length)},onKeyDown:g=>{var k;const b=g.key==="Enter",w=g.key==="Escape";(b||w)&&((k=g.target)==null||k.blur())},onChange:g=>{const b=Gu(g.currentTarget.value),w=I7(g.currentTarget,"editable_field");w&&(b?w.classList.remove("invalid"):w.classList.add("invalid"))},onBlur:g=>{const b=g.currentTarget.value,w=Zo({working_value:b,invariant_value:r});m(w),i(!1)},size:"small",variant:"outlined",fullWidth:!0}),n&&a&&_(q7,{on_change:m}),n&&c&&_(F,{value:"Today",onPointerDown:()=>{const g=ss();m(new Date(g))}})]})}const ht=O7(M7);function Gu(e){if(!e.trim())return!0;const t=Yi(e);return!!t&&Wl(t)}function q7(e){return _(F,{value:"Now",onClick:()=>{const t=new Date(new Date().getTime()+3e4),n=Ct(t,"yyyy-MM-dd hh:mm");e.on_change(new Date(n))}})}function Fb(e){return e.value||e.invariant_value}function V7(e,t){const n=e==null?void 0:e.getTime(),i=t==null?void 0:t.getTime();return n!==i}function F7(e){const t=Fb(e);return si({date:t,time_resolution:e.time_resolution})}function Zo(e){const{working_value:t,invariant_value:n}=e;let i=Yi(t);return i&&i.getTime()===(n&&n.getTime())&&(i=void 0),i}const z7=A.delay("handle_on_blur",()=>{let e,t,n;e=void 0,t="2020-01-01",n=Zo({invariant_value:e,working_value:t}),p(n==null?void 0:n.getTime(),new Date("2020-01-01T00:00:00.000Z").getTime()),e=void 0,t="2021-04-25 08:37",n=Zo({invariant_value:e,working_value:t}),p(n==null?void 0:n.getTime(),new Date("2021-04-25T07:37:00.000Z").getTime())});function zb(e){const{knowledge_views_by_id:t,wcomponents_by_id:n}=e,i=L7(e),o=new Set(i.map(c=>c.id)),s=B7({kv_ids_to_move:o,knowledge_views_by_id:t}),{wc_ids_to_move:r,wcomponents_move_conflicts:a}=U7({knowledge_views_to_move:i,knowledge_views_to_keep:s,wcomponents_by_id:n});return{kv_ids_to_move:o,wc_ids_to_move:r,wcomponents_move_conflicts:a}}function L7(e){const t=[],n=new Set,i=[e.root_knowledge_view_id_to_move];for(;i.length;){const o=i.pop();if(!o)break;if(n.has(o))continue;const s=e.knowledge_views_by_id[o],r=e.nested_knowledge_view_ids_map[o];if(!r||!s){console.error(`kv of id: "${o}" kv is "${s?"present":"absent"}" but nested kv map entry is "${r?"present":"absent"}"`);continue}t.push(s),n.add(o),r.child_ids.forEach(a=>i.push(a))}return t}function B7(e){return Object.values(e.knowledge_views_by_id).filter(t=>!e.kv_ids_to_move.has(t.id))}function U7(e){const t={};e.knowledge_views_to_keep.forEach(r=>{Object.entries(r.wc_id_map).forEach(([a,c])=>{if(c.blocked||c.passthrough)return;const l=t[a]||[];l.push({kv_id:r.id,left:c.left,top:c.top}),t[a]=l})});const n=new Set(e.knowledge_views_to_keep.map(r=>r.id)),i=new Set(e.knowledge_views_to_move.map(r=>r.id));let o=new Set;const s={};return e.knowledge_views_to_move.forEach(r=>Object.entries(r.wc_id_map).forEach(([a,c])=>{if(c.blocked||c.passthrough||!e.wcomponents_by_id[a]||n.has(a))return;const l=t[a],d=i.has(a);l&&!d?s[a]=l:o.add(a)})),{wc_ids_to_move:o,wcomponents_move_conflicts:s}}const W7=A.delay("calc_ids_to_move_and_conflicts",()=>{const t=We({id:"uuid A",base_id:1,title:"A"}),n=We({id:"uuid B",base_id:1,title:"B",parent_knowledge_view_id:t.id}),i=We({id:"uuid C",base_id:1,title:"C",parent_knowledge_view_id:n.id}),o=We({id:"uuid I",base_id:1,title:"I",parent_knowledge_view_id:n.id}),s=We({id:"uuid J",base_id:1,title:"J",parent_knowledge_view_id:t.id}),r=[t,n,i,o,s],a={};r.forEach(S=>a[S.id]=S);const c={},l=S=>(c[S.id]=S,S),d=l(q({base_id:1,title:t.title,id:t.id})),u=l(q({base_id:1,title:n.title,id:n.id})),f=l(q({base_id:1,title:i.title,id:i.id})),m=l(q({base_id:1,title:o.title,id:o.id})),h=l(q({base_id:1,title:s.title,id:s.id})),v=l(q({id:"uuid E",base_id:1,title:"E"})),g=l(q({id:"uuid F",base_id:1,title:"F"})),b=l(q({id:"uuid G",base_id:1,title:"G"})),w=l(q({id:"uuid H",base_id:1,title:"H"}));t.wc_id_map[d.id]={left:0,top:0},t.wc_id_map[u.id]={left:0,top:0},t.wc_id_map[v.id]={left:0,top:0},t.wc_id_map[g.id]={left:0,top:0},t.wc_id_map[m.id]={left:0,top:0},t.wc_id_map[h.id]={left:0,top:0},n.wc_id_map[u.id]={left:0,top:0},n.wc_id_map[f.id]={left:0,top:0},n.wc_id_map[v.id]={left:0,top:0},n.wc_id_map[b.id]={left:0,top:0},n.wc_id_map[m.id]={left:0,top:0},i.wc_id_map[f.id]={left:0,top:0},i.wc_id_map[g.id]={left:0,top:0},i.wc_id_map[w.id]={left:0,top:0},i.wc_id_map[h.id]={left:0,top:0},o.wc_id_map[m.id]={left:0,top:0},s.wc_id_map[h.id]={left:0,top:0};const k=Dg(r,1).map,y=zb({root_knowledge_view_id_to_move:n.id,nested_knowledge_view_ids_map:k,knowledge_views_by_id:a,wcomponents_by_id:c});p(y.kv_ids_to_move,new Set([n.id,i.id,o.id])),p(y.wc_ids_to_move,new Set([u.id,f.id,m.id,b.id,w.id])),p(Object.keys(y.wcomponents_move_conflicts),[v.id,g.id])});function Hl(e,t,n=[]){let i=t(e);const o={next:(...s)=>(n.push(s),i.next(...s)),throw:s=>i.throw(s),return:s=>i.return(s),[Symbol.iterator]:()=>o,clone:()=>{const s=[...n].map(r=>[...r]);return Hl(e,t,s)}};return n.forEach(s=>i.next(...s)),o}const H7=A.delay("cloneable_generator_factory",()=>{function*e(i){let o=i.start;for(;;){let s=yield++o;s!==void 0&&(o+=s)}}let t=Hl({start:10},e);p(t.next().value,11,"should increment"),p(t.next(3).value,11+1+3,"should use jump");let n=t.clone();p(t.next().value,16,"should increment again"),p(t.next(10).value,16+1+10,"should jump again"),p(n.next().value,16,"should have been reset"),p(n.next().value,17,"should not use previous jump"),p(n.next(-10).value,17+1-10,"should jump on second branch"),p(t.next().value,28,"should jump a third time on first branch")});function Ku(e){return parseInt(`${Math.random()}`.slice(2,2+e),10)}function Lb(e){const{all_action_ids:t,all_goal_ids:n,wcomponents_by_id:i}=e,o=Array.from(t).map(c=>i[c]).filter(Le),s={};o.forEach(c=>s[c.id]=c);const r=Array.from(n).map(c=>i[c]).filter(_n),a={};return r.forEach(c=>a[c.id]=c),{actions_by_id:s,goals_by_id:a}}function*Bb(e){const{action:t,actions_by_id:n,goals_by_id:i}=e;let o=t,s=[],r=new Set([o.id]);for(;;){(o.parent_goal_or_action_ids||[]).forEach(u=>{if(r.has(u)){console.warn(`Parent action/goal id already seen: "${u}".  May be circular, may just be a common ancestor.`);return}if(r.add(u),!(n[u]||i[u])){console.log(`Parent goal or action for id "${u}" not found.  Might be from another base?`);return}s.push(u)});const a=s.length>0;if((yield o.id)||!a)return;const l=s.shift();if(!l)return;const d=n[l]||i[l];if(!d)return;o=d}}const G7=A.delay("get_actions_parent_ids",()=>{function e(o,s=[]){return q({type:"goal",base_id:-1,title:o,id:o+` ${Ku(4)}`,parent_goal_or_action_ids:s})}function t(o,s=[]){return q({type:"action",base_id:-1,title:o,id:o+` ${Ku(4)}`,parent_goal_or_action_ids:s})}function n(o){const s={},r=new Set,a=new Set;return o.forEach(c=>{s[c.id]=c,c.type==="action"?r.add(c.id):a.add(c.id)}),Lb({all_action_ids:r,all_goal_ids:a,wcomponents_by_id:s})}function i(o,s){const r={action:o,...n(s)};return Hl(r,Bb)}A("No parents only self",()=>{const o=t("action0",[]),r=i(o,[o]).next();p(r.value,o.id,"Should return own id"),p(r.done,!1,"Should have no more ids")}),A("Branching parents grandparents",()=>{const o=e("goal1"),s=e("goal2"),r=e("goal3"),a=e("subgoal2&3",[s.id,r.id]),c=t("action1",[o.id,a.id]);let l=i(c,[c,o,s,r,a]),d=l.next();p(d.value,c.id,"Should return own id"),p(d.done,!1,"Should have more ids ready");let u=l.clone();d=l.next(!0),p(d.value,void 0,"Should return nothing when last id was own id and was also consumed"),p(d.done,!0,"Should have no more ids ready when last id was own id and was also consumed"),l=u,d=l.next(!1),p(d.value,o.id,"Should return next parent id, when last was own id and was not consumed"),u=l.clone(),d=l.next(!0),p(d.value,void 0,"Should return nothing when last id was consumed"),p(d.done,!0,"Should have no more ids ready when last id was consumed"),l=u,d=l.next(!1),p(d.value,a.id,"Should return next parent id, when last was not consumed but there is a sibling id"),u=l.clone(),d=l.next(!0),p(d.value,void 0,"Should return nothing when last id was consumed"),p(d.done,!0,"Should have no more ids ready when last id was consumed"),l=u,d=l.next(!1),p(d.value,s.id,"Should return next parent id, when last was not consumed but there is a grandparent"),u=l.clone(),d=l.next(!0),p(d.value,void 0,"Should return nothing when last id was consumed"),p(d.done,!0,"Should have no more ids ready when last id was consumed"),l=u,d=l.next(!1),p(d.value,r.id,"Should return next parent id, when last was not consumed and there is a grandparent sibling"),u=l.clone(),d=l.next(!0),p(d.value,void 0,"Should return nothing when last id was consumed"),p(d.done,!0,"Should have no more ids ready when last id was consumed"),l=u,d=l.next(!1),p(d.value,void 0,"Should return undefined when exhausted parent and grandparent ids"),p(d.done,!0,"Should have no more ids")}),A("get_actions_parent_ids should work if parents are also actions, and not just for parents that are goals",()=>{const o=t("action1"),s=t("action2"),r=t("action3"),a=t("subaction2&3",[s.id,r.id]),c=t("action1",[o.id,a.id]);let l=i(c,[o,s,r,a,c]),d=l.next();p(d.value,c.id,"Should return own id"),d=l.next(),p(d.value,o.id,"Should return next id"),d=l.next(),p(d.value,a.id,"Should return next id"),d=l.next(),p(d.value,s.id,"Should return next id"),d=l.next(),p(d.value,r.id,"Should return next id"),d=l.next(),p(d.value,void 0,"Should return no more ids"),p(d.done,!0,"Should be done")}),A("Circular parents",()=>{const o=e("goal1"),s=t("action1",[o.id]);o.parent_goal_or_action_ids=[s.id];const r=t("action2",[o.id]);let a=i(r,[s,r,o]),c=a.next();p(c.value,r.id,"Should return own id"),p(c.done,!1,"Should have more ids ready"),c=a.next(),p(c.value,o.id,"Should return next id"),p(c.done,!1,"Should have more ids ready"),c=a.next(),p(c.value,s.id,"Should return next id"),p(c.done,!1,"Should have not finished"),c=a.next(),p(c.done,!0,"Should have finished")}),A("Spread iterator containing one parent",()=>{const o=e("goal1"),s=t("action1",[o.id]),a=[...i(s,[s,o])];p(a,[s.id,o.id],"Should return both ids")})});function ke(e,t){if(e===0)return"0";const n=Math.floor(Math.log10(Math.abs(e))),i=n+1-t,s=(Math.round(e/Math.pow(10,i))*Math.pow(10,i)).toString();if(i>=0)return s;{const a=s.indexOf(".")!==-1;let c=s+(a?"":".");const l=(Math.abs(e)>=1?c.length:c.length+n)-1-(e<0?1:0);let d=t-l;d=Math.max(0,d),c+="0".repeat(d);const u=t+(n<0?-n:0)+1+(e<0?1:0);return c=c.slice(0,u),c}}const K7=A.delay("run_number_to_significant_figures_test",()=>{let e="";e=ke(0,2),p(e,"0","Zero"),A("Positive numbers",()=>{e=ke(27e5,2),p(e,"2700000","2.7 million to 2 sf"),e=ke(27e6,2),p(e,"27000000","27 million to 2 sf"),e=ke(27e7,2),p(e,"270000000","270 million to 2 sf"),e=ke(2700000002e-1,2),p(e,"270000000","270.2 million to 2 sf")}),A("Positive with decimals numbers",()=>{e=ke(27,5),p(e,"27.000","27 to 5 sf"),e=ke(2700000002e-1,10),p(e,"270000000.2","270.2 million to 10 sf"),e=ke(2700000002e-1,11),p(e,"270000000.20","270.2 million to 11 sf")}),A("Negative numbers",()=>{e=ke(-27,5),p(e,"-27.000","-27 to 5 sf"),e=ke(-2700000002e-1,11),p(e,"-270000000.20","-270.2 million to 11 sf"),e=ke(-2700000002e-1,2),p(e,"-270000000","-270.2 million to 2 sf")}),A("Small numbers",()=>{e=ke(1236e-7,3),p(e,"0.000124","0.0001236 to 3 sf"),e=ke(1236e-7,5),p(e,"0.00012360","0.0001236 to 5 sf"),e=ke(-1236e-7,3),p(e,"-0.000124","-0.0001236 to 3 sf"),e=ke(-1236e-7,5),p(e,"-0.00012360","-0.0001236 to 5 sf")}),A("Floating point precision numbers",()=>{e=ke(.01264,2),p(e,"0.013","0.01264 to 2 sf, tests when floating point precision results in 0.013000000000000001"),e=ke(17.955*100,7),p(e,"1795.500","17.955*100 to 7 sf, tests when floating point precision results in 1795.4999999999998")})});function Y7(e){return e.reduce((t,n)=>(t[n]=n,t),Object.create(null))}const V=Y7(["bare","simple","scaled","percentage","abbreviated_scaled","scientific"]);function W(e,t,n){let i;if(t=Math.round(t),t=t<1?1:t,n===V.bare)i=Xe(e,t).toString();else if(n===V.simple){const o=Xe(e,t);i=Math.abs(o)<1?o.toString():o.toLocaleString()}else if(n===V.scaled)i=J7(e,t);else if(n===V.percentage)i=Xe(e*100,t).toString()+"%";else if(n===V.abbreviated_scaled)i=X7(e,t);else if(n===V.scientific){const o=Gl(e,t);i=e.toExponential(o-1)}else throw new Error(`Unimplemented display type ${n}`);return i=i.replace("e+","e").trim(),i}function J7(e,t){const n=["","thousand","million","billion","trillion"];let i=0;for(;Math.abs(e)>=1e3&&i<n.length-1;)e/=1e3,i++;const o=Gl(e,t);return ke(e,o)+" "+n[i]}function X7(e,t){const n=["","k","m","bn","tn"];let i=0;for(;Math.abs(e)>=1e3&&i<n.length-1;)e/=1e3,i++;const o=Gl(e,t);return ke(e,o)+" "+n[i]}function Gl(e,t){let n=t;for(;n>1&&Number.parseFloat(e.toPrecision(n-1))===e;)--n;return n}const Z7=A.delay("run_number_to_string_test",()=>{let e="";e=W(1264,2,V.bare),p(e,"1300","bare number"),e=W(1264,2,V.simple),p(e,"1,300","simple number"),e=W(1264,2,V.scaled),p(e,"1.3 thousand","scaled number"),e=W(.1264,2,V.percentage),p(e,"13%","number as percentage"),e=W(1264,2,V.abbreviated_scaled),p(e,"1.3 k","abbreviated scaled number"),e=W(1264,2,V.scientific),p(e,"1.3e3","scientific number"),e=W(.1264,-.2,V.scientific),p(e,"1e-1","Copes with significant_figures that are fractional and or < 1"),e=W(27e6,2,V.scaled),p(e,"27 million","27 million"),e=W(27e7,2,V.scaled),p(e,"270 million","270 million"),e=W(27e8,2,V.scaled),p(e,"2.7 billion","2.7 billion"),A("negative numbers",()=>{e=W(-1264,2,V.bare),p(e,"-1300","bare number"),e=W(-1264,2,V.simple),p(e,"-1,300","simple number"),e=W(-1264,2,V.scaled),p(e,"-1.3 thousand","scaled number"),e=W(-.1264,2,V.percentage),p(e,"-13%","percentage number"),e=W(-1264,2,V.abbreviated_scaled),p(e,"-1.3 k","abbreviated scaled number"),e=W(-1264,2,V.scientific),p(e,"-1.3e3","scientific number")}),A("less than 1 numbers",()=>{e=W(.001264,2,V.bare),p(e,"0.0013","bare number"),e=W(.001264,2,V.simple),p(e,"0.0013","simple number"),e=W(.001264,2,V.scaled),p(e,"0.0013","scaled number"),e=W(.001264,2,V.percentage),p(e,"0.13%","percentage number"),e=W(.001264,2,V.abbreviated_scaled),p(e,"0.0013","abbreviated scaled number"),e=W(.001264,2,V.scientific),p(e,"1.3e-3","scientific number"),e=W(-.001264,2,V.scientific),p(e,"-1.3e-3","0> num >-1 scientific number")}),A("no unnecessary significant figures",()=>{e=W(1,2,V.bare),p(e,"1","bare number"),e=W(1,2,V.simple),p(e,"1","simple number"),e=W(1e3,2,V.scaled),p(e,"1 thousand","scaled number"),e=W(10,2,V.percentage),p(e,"1000%","percentage number"),e=W(1e3,2,V.abbreviated_scaled),p(e,"1 k","abbreviated scaled number"),e=W(1e3,2,V.scientific),p(e,"1e3","scientific number")}),A("handles 0",()=>{e=W(0,2,V.bare),p(e,"0","bare number"),e=W(0,2,V.simple),p(e,"0","simple number"),e=W(0,2,V.scaled),p(e,"0","scaled number"),e=W(0,2,V.percentage),p(e,"0%","percentage number"),e=W(0,2,V.abbreviated_scaled),p(e,"0","abbreviated scaled number"),e=W(0,2,V.scientific),p(e,"0e0","scientific number")})});var Zs,Yu;function Q7(){if(Yu)return Zs;Yu=1;function e(){this.__data__=[],this.size=0}return Zs=e,Zs}var Qs,Ju;function Kl(){if(Ju)return Qs;Ju=1;function e(t,n){return t===n||t!==t&&n!==n}return Qs=e,Qs}var er,Xu;function vs(){if(Xu)return er;Xu=1;var e=Kl();function t(n,i){for(var o=n.length;o--;)if(e(n[o][0],i))return o;return-1}return er=t,er}var tr,Zu;function e4(){if(Zu)return tr;Zu=1;var e=vs(),t=Array.prototype,n=t.splice;function i(o){var s=this.__data__,r=e(s,o);if(r<0)return!1;var a=s.length-1;return r==a?s.pop():n.call(s,r,1),--this.size,!0}return tr=i,tr}var nr,Qu;function t4(){if(Qu)return nr;Qu=1;var e=vs();function t(n){var i=this.__data__,o=e(i,n);return o<0?void 0:i[o][1]}return nr=t,nr}var ir,ep;function n4(){if(ep)return ir;ep=1;var e=vs();function t(n){return e(this.__data__,n)>-1}return ir=t,ir}var or,tp;function i4(){if(tp)return or;tp=1;var e=vs();function t(n,i){var o=this.__data__,s=e(o,n);return s<0?(++this.size,o.push([n,i])):o[s][1]=i,this}return or=t,or}var sr,np;function gs(){if(np)return sr;np=1;var e=Q7(),t=e4(),n=t4(),i=n4(),o=i4();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,sr=s,sr}var rr,ip;function o4(){if(ip)return rr;ip=1;var e=gs();function t(){this.__data__=new e,this.size=0}return rr=t,rr}var _r,op;function s4(){if(op)return _r;op=1;function e(t){var n=this.__data__,i=n.delete(t);return this.size=n.size,i}return _r=e,_r}var ar,sp;function r4(){if(sp)return ar;sp=1;function e(t){return this.__data__.get(t)}return ar=e,ar}var cr,rp;function _4(){if(rp)return cr;rp=1;function e(t){return this.__data__.has(t)}return cr=e,cr}var lr,_p;function Ub(){if(_p)return lr;_p=1;var e=typeof To=="object"&&To&&To.Object===Object&&To;return lr=e,lr}var dr,ap;function Nt(){if(ap)return dr;ap=1;var e=Ub(),t=typeof self=="object"&&self&&self.Object===Object&&self,n=e||t||Function("return this")();return dr=n,dr}var ur,cp;function Ai(){if(cp)return ur;cp=1;var e=Nt(),t=e.Symbol;return ur=t,ur}var pr,lp;function a4(){if(lp)return pr;lp=1;var e=Ai(),t=Object.prototype,n=t.hasOwnProperty,i=t.toString,o=e?e.toStringTag:void 0;function s(r){var a=n.call(r,o),c=r[o];try{r[o]=void 0;var l=!0}catch{}var d=i.call(r);return l&&(a?r[o]=c:delete r[o]),d}return pr=s,pr}var mr,dp;function c4(){if(dp)return mr;dp=1;var e=Object.prototype,t=e.toString;function n(i){return t.call(i)}return mr=n,mr}var fr,up;function Si(){if(up)return fr;up=1;var e=Ai(),t=a4(),n=c4(),i="[object Null]",o="[object Undefined]",s=e?e.toStringTag:void 0;function r(a){return a==null?a===void 0?o:i:s&&s in Object(a)?t(a):n(a)}return fr=r,fr}var hr,pp;function Mn(){if(pp)return hr;pp=1;function e(t){var n=typeof t;return t!=null&&(n=="object"||n=="function")}return hr=e,hr}var vr,mp;function ws(){if(mp)return vr;mp=1;var e=Si(),t=Mn(),n="[object AsyncFunction]",i="[object Function]",o="[object GeneratorFunction]",s="[object Proxy]";function r(a){if(!t(a))return!1;var c=e(a);return c==i||c==o||c==n||c==s}return vr=r,vr}var gr,fp;function l4(){if(fp)return gr;fp=1;var e=Nt(),t=e["__core-js_shared__"];return gr=t,gr}var wr,hp;function d4(){if(hp)return wr;hp=1;var e=l4(),t=function(){var i=/[^.]+$/.exec(e&&e.keys&&e.keys.IE_PROTO||"");return i?"Symbol(src)_1."+i:""}();function n(i){return!!t&&t in i}return wr=n,wr}var br,vp;function Wb(){if(vp)return br;vp=1;var e=Function.prototype,t=e.toString;function n(i){if(i!=null){try{return t.call(i)}catch{}try{return i+""}catch{}}return""}return br=n,br}var yr,gp;function u4(){if(gp)return yr;gp=1;var e=ws(),t=d4(),n=Mn(),i=Wb(),o=/[\\^$.*+?()[\]{}|]/g,s=/^\[object .+?Constructor\]$/,r=Function.prototype,a=Object.prototype,c=r.toString,l=a.hasOwnProperty,d=RegExp("^"+c.call(l).replace(o,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function u(f){if(!n(f)||t(f))return!1;var m=e(f)?d:s;return m.test(i(f))}return yr=u,yr}var kr,wp;function p4(){if(wp)return kr;wp=1;function e(t,n){return t==null?void 0:t[n]}return kr=e,kr}var xr,bp;function qn(){if(bp)return xr;bp=1;var e=u4(),t=p4();function n(i,o){var s=t(i,o);return e(s)?s:void 0}return xr=n,xr}var Ar,yp;function Yl(){if(yp)return Ar;yp=1;var e=qn(),t=Nt(),n=e(t,"Map");return Ar=n,Ar}var Sr,kp;function bs(){if(kp)return Sr;kp=1;var e=qn(),t=e(Object,"create");return Sr=t,Sr}var Cr,xp;function m4(){if(xp)return Cr;xp=1;var e=bs();function t(){this.__data__=e?e(null):{},this.size=0}return Cr=t,Cr}var $r,Ap;function f4(){if(Ap)return $r;Ap=1;function e(t){var n=this.has(t)&&delete this.__data__[t];return this.size-=n?1:0,n}return $r=e,$r}var jr,Sp;function h4(){if(Sp)return jr;Sp=1;var e=bs(),t="__lodash_hash_undefined__",n=Object.prototype,i=n.hasOwnProperty;function o(s){var r=this.__data__;if(e){var a=r[s];return a===t?void 0:a}return i.call(r,s)?r[s]:void 0}return jr=o,jr}var Tr,Cp;function v4(){if(Cp)return Tr;Cp=1;var e=bs(),t=Object.prototype,n=t.hasOwnProperty;function i(o){var s=this.__data__;return e?s[o]!==void 0:n.call(s,o)}return Tr=i,Tr}var Pr,$p;function g4(){if($p)return Pr;$p=1;var e=bs(),t="__lodash_hash_undefined__";function n(i,o){var s=this.__data__;return this.size+=this.has(i)?0:1,s[i]=e&&o===void 0?t:o,this}return Pr=n,Pr}var Nr,jp;function w4(){if(jp)return Nr;jp=1;var e=m4(),t=f4(),n=h4(),i=v4(),o=g4();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,Nr=s,Nr}var Er,Tp;function b4(){if(Tp)return Er;Tp=1;var e=w4(),t=gs(),n=Yl();function i(){this.size=0,this.__data__={hash:new e,map:new(n||t),string:new e}}return Er=i,Er}var Ir,Pp;function y4(){if(Pp)return Ir;Pp=1;function e(t){var n=typeof t;return n=="string"||n=="number"||n=="symbol"||n=="boolean"?t!=="__proto__":t===null}return Ir=e,Ir}var Rr,Np;function ys(){if(Np)return Rr;Np=1;var e=y4();function t(n,i){var o=n.__data__;return e(i)?o[typeof i=="string"?"string":"hash"]:o.map}return Rr=t,Rr}var Dr,Ep;function k4(){if(Ep)return Dr;Ep=1;var e=ys();function t(n){var i=e(this,n).delete(n);return this.size-=i?1:0,i}return Dr=t,Dr}var Or,Ip;function x4(){if(Ip)return Or;Ip=1;var e=ys();function t(n){return e(this,n).get(n)}return Or=t,Or}var Mr,Rp;function A4(){if(Rp)return Mr;Rp=1;var e=ys();function t(n){return e(this,n).has(n)}return Mr=t,Mr}var qr,Dp;function S4(){if(Dp)return qr;Dp=1;var e=ys();function t(n,i){var o=e(this,n),s=o.size;return o.set(n,i),this.size+=o.size==s?0:1,this}return qr=t,qr}var Vr,Op;function Jl(){if(Op)return Vr;Op=1;var e=b4(),t=k4(),n=x4(),i=A4(),o=S4();function s(r){var a=-1,c=r==null?0:r.length;for(this.clear();++a<c;){var l=r[a];this.set(l[0],l[1])}}return s.prototype.clear=e,s.prototype.delete=t,s.prototype.get=n,s.prototype.has=i,s.prototype.set=o,Vr=s,Vr}var Fr,Mp;function C4(){if(Mp)return Fr;Mp=1;var e=gs(),t=Yl(),n=Jl(),i=200;function o(s,r){var a=this.__data__;if(a instanceof e){var c=a.__data__;if(!t||c.length<i-1)return c.push([s,r]),this.size=++a.size,this;a=this.__data__=new n(c)}return a.set(s,r),this.size=a.size,this}return Fr=o,Fr}var zr,qp;function Xl(){if(qp)return zr;qp=1;var e=gs(),t=o4(),n=s4(),i=r4(),o=_4(),s=C4();function r(a){var c=this.__data__=new e(a);this.size=c.size}return r.prototype.clear=t,r.prototype.delete=n,r.prototype.get=i,r.prototype.has=o,r.prototype.set=s,zr=r,zr}var Lr,Vp;function Zl(){if(Vp)return Lr;Vp=1;function e(t,n){for(var i=-1,o=t==null?0:t.length;++i<o&&n(t[i],i,t)!==!1;);return t}return Lr=e,Lr}var Br,Fp;function Hb(){if(Fp)return Br;Fp=1;var e=qn(),t=function(){try{var n=e(Object,"defineProperty");return n({},"",{}),n}catch{}}();return Br=t,Br}var Ur,zp;function Gb(){if(zp)return Ur;zp=1;var e=Hb();function t(n,i,o){i=="__proto__"&&e?e(n,i,{configurable:!0,enumerable:!0,value:o,writable:!0}):n[i]=o}return Ur=t,Ur}var Wr,Lp;function Kb(){if(Lp)return Wr;Lp=1;var e=Gb(),t=Kl(),n=Object.prototype,i=n.hasOwnProperty;function o(s,r,a){var c=s[r];(!(i.call(s,r)&&t(c,a))||a===void 0&&!(r in s))&&e(s,r,a)}return Wr=o,Wr}var Hr,Bp;function ks(){if(Bp)return Hr;Bp=1;var e=Kb(),t=Gb();function n(i,o,s,r){var a=!s;s||(s={});for(var c=-1,l=o.length;++c<l;){var d=o[c],u=r?r(s[d],i[d],d,s,i):void 0;u===void 0&&(u=i[d]),a?t(s,d,u):e(s,d,u)}return s}return Hr=n,Hr}var Gr,Up;function $4(){if(Up)return Gr;Up=1;function e(t,n){for(var i=-1,o=Array(t);++i<t;)o[i]=n(i);return o}return Gr=e,Gr}var Kr,Wp;function Gt(){if(Wp)return Kr;Wp=1;function e(t){return t!=null&&typeof t=="object"}return Kr=e,Kr}var Yr,Hp;function j4(){if(Hp)return Yr;Hp=1;var e=Si(),t=Gt(),n="[object Arguments]";function i(o){return t(o)&&e(o)==n}return Yr=i,Yr}var Jr,Gp;function xs(){if(Gp)return Jr;Gp=1;var e=j4(),t=Gt(),n=Object.prototype,i=n.hasOwnProperty,o=n.propertyIsEnumerable,s=e(function(){return arguments}())?e:function(r){return t(r)&&i.call(r,"callee")&&!o.call(r,"callee")};return Jr=s,Jr}var Xr,Kp;function $e(){if(Kp)return Xr;Kp=1;var e=Array.isArray;return Xr=e,Xr}var Ui={exports:{}},Zr,Yp;function T4(){if(Yp)return Zr;Yp=1;function e(){return!1}return Zr=e,Zr}Ui.exports;var Jp;function fo(){return Jp||(Jp=1,function(e,t){var n=Nt(),i=T4(),o=t&&!t.nodeType&&t,s=o&&!0&&e&&!e.nodeType&&e,r=s&&s.exports===o,a=r?n.Buffer:void 0,c=a?a.isBuffer:void 0,l=c||i;e.exports=l}(Ui,Ui.exports)),Ui.exports}var Qr,Xp;function Yb(){if(Xp)return Qr;Xp=1;var e=9007199254740991,t=/^(?:0|[1-9]\d*)$/;function n(i,o){var s=typeof i;return o=o??e,!!o&&(s=="number"||s!="symbol"&&t.test(i))&&i>-1&&i%1==0&&i<o}return Qr=n,Qr}var e_,Zp;function Ql(){if(Zp)return e_;Zp=1;var e=9007199254740991;function t(n){return typeof n=="number"&&n>-1&&n%1==0&&n<=e}return e_=t,e_}var t_,Qp;function P4(){if(Qp)return t_;Qp=1;var e=Si(),t=Ql(),n=Gt(),i="[object Arguments]",o="[object Array]",s="[object Boolean]",r="[object Date]",a="[object Error]",c="[object Function]",l="[object Map]",d="[object Number]",u="[object Object]",f="[object RegExp]",m="[object Set]",h="[object String]",v="[object WeakMap]",g="[object ArrayBuffer]",b="[object DataView]",w="[object Float32Array]",k="[object Float64Array]",y="[object Int8Array]",S="[object Int16Array]",T="[object Int32Array]",$="[object Uint8Array]",R="[object Uint8ClampedArray]",C="[object Uint16Array]",O="[object Uint32Array]",M={};M[w]=M[k]=M[y]=M[S]=M[T]=M[$]=M[R]=M[C]=M[O]=!0,M[i]=M[o]=M[g]=M[s]=M[b]=M[r]=M[a]=M[c]=M[l]=M[d]=M[u]=M[f]=M[m]=M[h]=M[v]=!1;function P(L){return n(L)&&t(L.length)&&!!M[e(L)]}return t_=P,t_}var n_,em;function ed(){if(em)return n_;em=1;function e(t){return function(n){return t(n)}}return n_=e,n_}var Wi={exports:{}};Wi.exports;var tm;function td(){return tm||(tm=1,function(e,t){var n=Ub(),i=t&&!t.nodeType&&t,o=i&&!0&&e&&!e.nodeType&&e,s=o&&o.exports===i,r=s&&n.process,a=function(){try{var c=o&&o.require&&o.require("util").types;return c||r&&r.binding&&r.binding("util")}catch{}}();e.exports=a}(Wi,Wi.exports)),Wi.exports}var i_,nm;function As(){if(nm)return i_;nm=1;var e=P4(),t=ed(),n=td(),i=n&&n.isTypedArray,o=i?t(i):e;return i_=o,i_}var o_,im;function Jb(){if(im)return o_;im=1;var e=$4(),t=xs(),n=$e(),i=fo(),o=Yb(),s=As(),r=Object.prototype,a=r.hasOwnProperty;function c(l,d){var u=n(l),f=!u&&t(l),m=!u&&!f&&i(l),h=!u&&!f&&!m&&s(l),v=u||f||m||h,g=v?e(l.length,String):[],b=g.length;for(var w in l)(d||a.call(l,w))&&!(v&&(w=="length"||m&&(w=="offset"||w=="parent")||h&&(w=="buffer"||w=="byteLength"||w=="byteOffset")||o(w,b)))&&g.push(w);return g}return o_=c,o_}var s_,om;function Ss(){if(om)return s_;om=1;var e=Object.prototype;function t(n){var i=n&&n.constructor,o=typeof i=="function"&&i.prototype||e;return n===o}return s_=t,s_}var r_,sm;function Xb(){if(sm)return r_;sm=1;function e(t,n){return function(i){return t(n(i))}}return r_=e,r_}var __,rm;function N4(){if(rm)return __;rm=1;var e=Xb(),t=e(Object.keys,Object);return __=t,__}var a_,_m;function nd(){if(_m)return a_;_m=1;var e=Ss(),t=N4(),n=Object.prototype,i=n.hasOwnProperty;function o(s){if(!e(s))return t(s);var r=[];for(var a in Object(s))i.call(s,a)&&a!="constructor"&&r.push(a);return r}return a_=o,a_}var c_,am;function Vn(){if(am)return c_;am=1;var e=ws(),t=Ql();function n(i){return i!=null&&t(i.length)&&!e(i)}return c_=n,c_}var l_,cm;function Fn(){if(cm)return l_;cm=1;var e=Jb(),t=nd(),n=Vn();function i(o){return n(o)?e(o):t(o)}return l_=i,l_}var d_,lm;function E4(){if(lm)return d_;lm=1;var e=ks(),t=Fn();function n(i,o){return i&&e(o,t(o),i)}return d_=n,d_}var u_,dm;function I4(){if(dm)return u_;dm=1;function e(t){var n=[];if(t!=null)for(var i in Object(t))n.push(i);return n}return u_=e,u_}var p_,um;function R4(){if(um)return p_;um=1;var e=Mn(),t=Ss(),n=I4(),i=Object.prototype,o=i.hasOwnProperty;function s(r){if(!e(r))return n(r);var a=t(r),c=[];for(var l in r)l=="constructor"&&(a||!o.call(r,l))||c.push(l);return c}return p_=s,p_}var m_,pm;function id(){if(pm)return m_;pm=1;var e=Jb(),t=R4(),n=Vn();function i(o){return n(o)?e(o,!0):t(o)}return m_=i,m_}var f_,mm;function D4(){if(mm)return f_;mm=1;var e=ks(),t=id();function n(i,o){return i&&e(o,t(o),i)}return f_=n,f_}var Hi={exports:{}};Hi.exports;var fm;function O4(){return fm||(fm=1,function(e,t){var n=Nt(),i=t&&!t.nodeType&&t,o=i&&!0&&e&&!e.nodeType&&e,s=o&&o.exports===i,r=s?n.Buffer:void 0,a=r?r.allocUnsafe:void 0;function c(l,d){if(d)return l.slice();var u=l.length,f=a?a(u):new l.constructor(u);return l.copy(f),f}e.exports=c}(Hi,Hi.exports)),Hi.exports}var h_,hm;function M4(){if(hm)return h_;hm=1;function e(t,n){var i=-1,o=t.length;for(n||(n=Array(o));++i<o;)n[i]=t[i];return n}return h_=e,h_}var v_,vm;function Zb(){if(vm)return v_;vm=1;function e(t,n){for(var i=-1,o=t==null?0:t.length,s=0,r=[];++i<o;){var a=t[i];n(a,i,t)&&(r[s++]=a)}return r}return v_=e,v_}var g_,gm;function Qb(){if(gm)return g_;gm=1;function e(){return[]}return g_=e,g_}var w_,wm;function od(){if(wm)return w_;wm=1;var e=Zb(),t=Qb(),n=Object.prototype,i=n.propertyIsEnumerable,o=Object.getOwnPropertySymbols,s=o?function(r){return r==null?[]:(r=Object(r),e(o(r),function(a){return i.call(r,a)}))}:t;return w_=s,w_}var b_,bm;function q4(){if(bm)return b_;bm=1;var e=ks(),t=od();function n(i,o){return e(i,t(i),o)}return b_=n,b_}var y_,ym;function sd(){if(ym)return y_;ym=1;function e(t,n){for(var i=-1,o=n.length,s=t.length;++i<o;)t[s+i]=n[i];return t}return y_=e,y_}var k_,km;function rd(){if(km)return k_;km=1;var e=Xb(),t=e(Object.getPrototypeOf,Object);return k_=t,k_}var x_,xm;function ey(){if(xm)return x_;xm=1;var e=sd(),t=rd(),n=od(),i=Qb(),o=Object.getOwnPropertySymbols,s=o?function(r){for(var a=[];r;)e(a,n(r)),r=t(r);return a}:i;return x_=s,x_}var A_,Am;function V4(){if(Am)return A_;Am=1;var e=ks(),t=ey();function n(i,o){return e(i,t(i),o)}return A_=n,A_}var S_,Sm;function ty(){if(Sm)return S_;Sm=1;var e=sd(),t=$e();function n(i,o,s){var r=o(i);return t(i)?r:e(r,s(i))}return S_=n,S_}var C_,Cm;function ny(){if(Cm)return C_;Cm=1;var e=ty(),t=od(),n=Fn();function i(o){return e(o,n,t)}return C_=i,C_}var $_,$m;function F4(){if($m)return $_;$m=1;var e=ty(),t=ey(),n=id();function i(o){return e(o,n,t)}return $_=i,$_}var j_,jm;function z4(){if(jm)return j_;jm=1;var e=qn(),t=Nt(),n=e(t,"DataView");return j_=n,j_}var T_,Tm;function L4(){if(Tm)return T_;Tm=1;var e=qn(),t=Nt(),n=e(t,"Promise");return T_=n,T_}var P_,Pm;function iy(){if(Pm)return P_;Pm=1;var e=qn(),t=Nt(),n=e(t,"Set");return P_=n,P_}var N_,Nm;function B4(){if(Nm)return N_;Nm=1;var e=qn(),t=Nt(),n=e(t,"WeakMap");return N_=n,N_}var E_,Em;function Ci(){if(Em)return E_;Em=1;var e=z4(),t=Yl(),n=L4(),i=iy(),o=B4(),s=Si(),r=Wb(),a="[object Map]",c="[object Object]",l="[object Promise]",d="[object Set]",u="[object WeakMap]",f="[object DataView]",m=r(e),h=r(t),v=r(n),g=r(i),b=r(o),w=s;return(e&&w(new e(new ArrayBuffer(1)))!=f||t&&w(new t)!=a||n&&w(n.resolve())!=l||i&&w(new i)!=d||o&&w(new o)!=u)&&(w=function(k){var y=s(k),S=y==c?k.constructor:void 0,T=S?r(S):"";if(T)switch(T){case m:return f;case h:return a;case v:return l;case g:return d;case b:return u}return y}),E_=w,E_}var I_,Im;function U4(){if(Im)return I_;Im=1;var e=Object.prototype,t=e.hasOwnProperty;function n(i){var o=i.length,s=new i.constructor(o);return o&&typeof i[0]=="string"&&t.call(i,"index")&&(s.index=i.index,s.input=i.input),s}return I_=n,I_}var R_,Rm;function oy(){if(Rm)return R_;Rm=1;var e=Nt(),t=e.Uint8Array;return R_=t,R_}var D_,Dm;function _d(){if(Dm)return D_;Dm=1;var e=oy();function t(n){var i=new n.constructor(n.byteLength);return new e(i).set(new e(n)),i}return D_=t,D_}var O_,Om;function W4(){if(Om)return O_;Om=1;var e=_d();function t(n,i){var o=i?e(n.buffer):n.buffer;return new n.constructor(o,n.byteOffset,n.byteLength)}return O_=t,O_}var M_,Mm;function H4(){if(Mm)return M_;Mm=1;var e=/\w*$/;function t(n){var i=new n.constructor(n.source,e.exec(n));return i.lastIndex=n.lastIndex,i}return M_=t,M_}var q_,qm;function G4(){if(qm)return q_;qm=1;var e=Ai(),t=e?e.prototype:void 0,n=t?t.valueOf:void 0;function i(o){return n?Object(n.call(o)):{}}return q_=i,q_}var V_,Vm;function K4(){if(Vm)return V_;Vm=1;var e=_d();function t(n,i){var o=i?e(n.buffer):n.buffer;return new n.constructor(o,n.byteOffset,n.length)}return V_=t,V_}var F_,Fm;function Y4(){if(Fm)return F_;Fm=1;var e=_d(),t=W4(),n=H4(),i=G4(),o=K4(),s="[object Boolean]",r="[object Date]",a="[object Map]",c="[object Number]",l="[object RegExp]",d="[object Set]",u="[object String]",f="[object Symbol]",m="[object ArrayBuffer]",h="[object DataView]",v="[object Float32Array]",g="[object Float64Array]",b="[object Int8Array]",w="[object Int16Array]",k="[object Int32Array]",y="[object Uint8Array]",S="[object Uint8ClampedArray]",T="[object Uint16Array]",$="[object Uint32Array]";function R(C,O,M){var P=C.constructor;switch(O){case m:return e(C);case s:case r:return new P(+C);case h:return t(C,M);case v:case g:case b:case w:case k:case y:case S:case T:case $:return o(C,M);case a:return new P;case c:case u:return new P(C);case l:return n(C);case d:return new P;case f:return i(C)}}return F_=R,F_}var z_,zm;function sy(){if(zm)return z_;zm=1;var e=Mn(),t=Object.create,n=function(){function i(){}return function(o){if(!e(o))return{};if(t)return t(o);i.prototype=o;var s=new i;return i.prototype=void 0,s}}();return z_=n,z_}var L_,Lm;function J4(){if(Lm)return L_;Lm=1;var e=sy(),t=rd(),n=Ss();function i(o){return typeof o.constructor=="function"&&!n(o)?e(t(o)):{}}return L_=i,L_}var B_,Bm;function X4(){if(Bm)return B_;Bm=1;var e=Ci(),t=Gt(),n="[object Map]";function i(o){return t(o)&&e(o)==n}return B_=i,B_}var U_,Um;function Z4(){if(Um)return U_;Um=1;var e=X4(),t=ed(),n=td(),i=n&&n.isMap,o=i?t(i):e;return U_=o,U_}var W_,Wm;function Q4(){if(Wm)return W_;Wm=1;var e=Ci(),t=Gt(),n="[object Set]";function i(o){return t(o)&&e(o)==n}return W_=i,W_}var H_,Hm;function e5(){if(Hm)return H_;Hm=1;var e=Q4(),t=ed(),n=td(),i=n&&n.isSet,o=i?t(i):e;return H_=o,H_}var G_,Gm;function t5(){if(Gm)return G_;Gm=1;var e=Xl(),t=Zl(),n=Kb(),i=E4(),o=D4(),s=O4(),r=M4(),a=q4(),c=V4(),l=ny(),d=F4(),u=Ci(),f=U4(),m=Y4(),h=J4(),v=$e(),g=fo(),b=Z4(),w=Mn(),k=e5(),y=Fn(),S=id(),T=1,$=2,R=4,C="[object Arguments]",O="[object Array]",M="[object Boolean]",P="[object Date]",L="[object Error]",J="[object Function]",Ke="[object GeneratorFunction]",ct="[object Map]",Ln="[object Number]",Kt="[object Object]",gt="[object RegExp]",ko="[object Set]",xo="[object String]",Bn="[object Symbol]",Vs="[object WeakMap]",Fs="[object ArrayBuffer]",zs="[object DataView]",Ls="[object Float32Array]",Ao="[object Float64Array]",Bs="[object Int8Array]",et="[object Int16Array]",Un="[object Int32Array]",Ti="[object Uint8Array]",H1="[object Uint8ClampedArray]",G1="[object Uint16Array]",K1="[object Uint32Array]",le={};le[C]=le[O]=le[Fs]=le[zs]=le[M]=le[P]=le[Ls]=le[Ao]=le[Bs]=le[et]=le[Un]=le[ct]=le[Ln]=le[Kt]=le[gt]=le[ko]=le[xo]=le[Bn]=le[Ti]=le[H1]=le[G1]=le[K1]=!0,le[L]=le[J]=le[Vs]=!1;function So(oe,Wn,Hn,Y1,Co,Yt){var Ye,$o=Wn&T,jo=Wn&$,J1=Wn&R;if(Hn&&(Ye=Co?Hn(oe,Y1,Co,Yt):Hn(oe)),Ye!==void 0)return Ye;if(!w(oe))return oe;var fu=v(oe);if(fu){if(Ye=f(oe),!$o)return r(oe,Ye)}else{var Gn=u(oe),hu=Gn==J||Gn==Ke;if(g(oe))return s(oe,$o);if(Gn==Kt||Gn==C||hu&&!Co){if(Ye=jo||hu?{}:h(oe),!$o)return jo?c(oe,o(Ye,oe)):a(oe,i(Ye,oe))}else{if(!le[Gn])return Co?oe:{};Ye=m(oe,Gn,$o)}}Yt||(Yt=new e);var vu=Yt.get(oe);if(vu)return vu;Yt.set(oe,Ye),k(oe)?oe.forEach(function(Jt){Ye.add(So(Jt,Wn,Hn,Jt,oe,Yt))}):b(oe)&&oe.forEach(function(Jt,ln){Ye.set(ln,So(Jt,Wn,Hn,ln,oe,Yt))});var X1=J1?jo?d:l:jo?S:y,gu=fu?void 0:X1(oe);return t(gu||oe,function(Jt,ln){gu&&(ln=Jt,Jt=oe[ln]),n(Ye,ln,So(Jt,Wn,Hn,ln,oe,Yt))}),Ye}return G_=So,G_}var K_,Km;function n5(){if(Km)return K_;Km=1;var e=t5(),t=4;function n(i){return e(i,t)}return K_=n,K_}var Y_,Ym;function ry(){if(Ym)return Y_;Ym=1;function e(t){return function(){return t}}return Y_=e,Y_}var J_,Jm;function i5(){if(Jm)return J_;Jm=1;function e(t){return function(n,i,o){for(var s=-1,r=Object(n),a=o(n),c=a.length;c--;){var l=a[t?c:++s];if(i(r[l],l,r)===!1)break}return n}}return J_=e,J_}var X_,Xm;function o5(){if(Xm)return X_;Xm=1;var e=i5(),t=e();return X_=t,X_}var Z_,Zm;function _y(){if(Zm)return Z_;Zm=1;var e=o5(),t=Fn();function n(i,o){return i&&e(i,o,t)}return Z_=n,Z_}var Q_,Qm;function s5(){if(Qm)return Q_;Qm=1;var e=Vn();function t(n,i){return function(o,s){if(o==null)return o;if(!e(o))return n(o,s);for(var r=o.length,a=i?r:-1,c=Object(o);(i?a--:++a<r)&&s(c[a],a,c)!==!1;);return o}}return Q_=t,Q_}var ea,ef;function Cs(){if(ef)return ea;ef=1;var e=_y(),t=s5(),n=t(e);return ea=n,ea}var ta,tf;function $s(){if(tf)return ta;tf=1;function e(t){return t}return ta=e,ta}var na,nf;function r5(){if(nf)return na;nf=1;var e=$s();function t(n){return typeof n=="function"?n:e}return na=t,na}var ia,of;function _5(){if(of)return ia;of=1;var e=Zl(),t=Cs(),n=r5(),i=$e();function o(s,r){var a=i(s)?e:t;return a(s,n(r))}return ia=o,ia}var oa,sf;function a5(){return sf||(sf=1,oa=_5()),oa}var sa,rf;function c5(){if(rf)return sa;rf=1;var e=Cs();function t(n,i){var o=[];return e(n,function(s,r,a){i(s,r,a)&&o.push(s)}),o}return sa=t,sa}var ra,_f;function l5(){if(_f)return ra;_f=1;var e="__lodash_hash_undefined__";function t(n){return this.__data__.set(n,e),this}return ra=t,ra}var _a,af;function d5(){if(af)return _a;af=1;function e(t){return this.__data__.has(t)}return _a=e,_a}var aa,cf;function ay(){if(cf)return aa;cf=1;var e=Jl(),t=l5(),n=d5();function i(o){var s=-1,r=o==null?0:o.length;for(this.__data__=new e;++s<r;)this.add(o[s])}return i.prototype.add=i.prototype.push=t,i.prototype.has=n,aa=i,aa}var ca,lf;function u5(){if(lf)return ca;lf=1;function e(t,n){for(var i=-1,o=t==null?0:t.length;++i<o;)if(n(t[i],i,t))return!0;return!1}return ca=e,ca}var la,df;function cy(){if(df)return la;df=1;function e(t,n){return t.has(n)}return la=e,la}var da,uf;function ly(){if(uf)return da;uf=1;var e=ay(),t=u5(),n=cy(),i=1,o=2;function s(r,a,c,l,d,u){var f=c&i,m=r.length,h=a.length;if(m!=h&&!(f&&h>m))return!1;var v=u.get(r),g=u.get(a);if(v&&g)return v==a&&g==r;var b=-1,w=!0,k=c&o?new e:void 0;for(u.set(r,a),u.set(a,r);++b<m;){var y=r[b],S=a[b];if(l)var T=f?l(S,y,b,a,r,u):l(y,S,b,r,a,u);if(T!==void 0){if(T)continue;w=!1;break}if(k){if(!t(a,function($,R){if(!n(k,R)&&(y===$||d(y,$,c,l,u)))return k.push(R)})){w=!1;break}}else if(!(y===S||d(y,S,c,l,u))){w=!1;break}}return u.delete(r),u.delete(a),w}return da=s,da}var ua,pf;function p5(){if(pf)return ua;pf=1;function e(t){var n=-1,i=Array(t.size);return t.forEach(function(o,s){i[++n]=[s,o]}),i}return ua=e,ua}var pa,mf;function ad(){if(mf)return pa;mf=1;function e(t){var n=-1,i=Array(t.size);return t.forEach(function(o){i[++n]=o}),i}return pa=e,pa}var ma,ff;function m5(){if(ff)return ma;ff=1;var e=Ai(),t=oy(),n=Kl(),i=ly(),o=p5(),s=ad(),r=1,a=2,c="[object Boolean]",l="[object Date]",d="[object Error]",u="[object Map]",f="[object Number]",m="[object RegExp]",h="[object Set]",v="[object String]",g="[object Symbol]",b="[object ArrayBuffer]",w="[object DataView]",k=e?e.prototype:void 0,y=k?k.valueOf:void 0;function S(T,$,R,C,O,M,P){switch(R){case w:if(T.byteLength!=$.byteLength||T.byteOffset!=$.byteOffset)return!1;T=T.buffer,$=$.buffer;case b:return!(T.byteLength!=$.byteLength||!M(new t(T),new t($)));case c:case l:case f:return n(+T,+$);case d:return T.name==$.name&&T.message==$.message;case m:case v:return T==$+"";case u:var L=o;case h:var J=C&r;if(L||(L=s),T.size!=$.size&&!J)return!1;var Ke=P.get(T);if(Ke)return Ke==$;C|=a,P.set(T,$);var ct=i(L(T),L($),C,O,M,P);return P.delete(T),ct;case g:if(y)return y.call(T)==y.call($)}return!1}return ma=S,ma}var fa,hf;function f5(){if(hf)return fa;hf=1;var e=ny(),t=1,n=Object.prototype,i=n.hasOwnProperty;function o(s,r,a,c,l,d){var u=a&t,f=e(s),m=f.length,h=e(r),v=h.length;if(m!=v&&!u)return!1;for(var g=m;g--;){var b=f[g];if(!(u?b in r:i.call(r,b)))return!1}var w=d.get(s),k=d.get(r);if(w&&k)return w==r&&k==s;var y=!0;d.set(s,r),d.set(r,s);for(var S=u;++g<m;){b=f[g];var T=s[b],$=r[b];if(c)var R=u?c($,T,b,r,s,d):c(T,$,b,s,r,d);if(!(R===void 0?T===$||l(T,$,a,c,d):R)){y=!1;break}S||(S=b=="constructor")}if(y&&!S){var C=s.constructor,O=r.constructor;C!=O&&"constructor"in s&&"constructor"in r&&!(typeof C=="function"&&C instanceof C&&typeof O=="function"&&O instanceof O)&&(y=!1)}return d.delete(s),d.delete(r),y}return fa=o,fa}var ha,vf;function h5(){if(vf)return ha;vf=1;var e=Xl(),t=ly(),n=m5(),i=f5(),o=Ci(),s=$e(),r=fo(),a=As(),c=1,l="[object Arguments]",d="[object Array]",u="[object Object]",f=Object.prototype,m=f.hasOwnProperty;function h(v,g,b,w,k,y){var S=s(v),T=s(g),$=S?d:o(v),R=T?d:o(g);$=$==l?u:$,R=R==l?u:R;var C=$==u,O=R==u,M=$==R;if(M&&r(v)){if(!r(g))return!1;S=!0,C=!1}if(M&&!C)return y||(y=new e),S||a(v)?t(v,g,b,w,k,y):n(v,g,$,b,w,k,y);if(!(b&c)){var P=C&&m.call(v,"__wrapped__"),L=O&&m.call(g,"__wrapped__");if(P||L){var J=P?v.value():v,Ke=L?g.value():g;return y||(y=new e),k(J,Ke,b,w,y)}}return M?(y||(y=new e),i(v,g,b,w,k,y)):!1}return ha=h,ha}var va,gf;function dy(){if(gf)return va;gf=1;var e=h5(),t=Gt();function n(i,o,s,r,a){return i===o?!0:i==null||o==null||!t(i)&&!t(o)?i!==i&&o!==o:e(i,o,s,r,n,a)}return va=n,va}var ga,wf;function v5(){if(wf)return ga;wf=1;var e=Xl(),t=dy(),n=1,i=2;function o(s,r,a,c){var l=a.length,d=l,u=!c;if(s==null)return!d;for(s=Object(s);l--;){var f=a[l];if(u&&f[2]?f[1]!==s[f[0]]:!(f[0]in s))return!1}for(;++l<d;){f=a[l];var m=f[0],h=s[m],v=f[1];if(u&&f[2]){if(h===void 0&&!(m in s))return!1}else{var g=new e;if(c)var b=c(h,v,m,s,r,g);if(!(b===void 0?t(v,h,n|i,c,g):b))return!1}}return!0}return ga=o,ga}var wa,bf;function uy(){if(bf)return wa;bf=1;var e=Mn();function t(n){return n===n&&!e(n)}return wa=t,wa}var ba,yf;function g5(){if(yf)return ba;yf=1;var e=uy(),t=Fn();function n(i){for(var o=t(i),s=o.length;s--;){var r=o[s],a=i[r];o[s]=[r,a,e(a)]}return o}return ba=n,ba}var ya,kf;function py(){if(kf)return ya;kf=1;function e(t,n){return function(i){return i==null?!1:i[t]===n&&(n!==void 0||t in Object(i))}}return ya=e,ya}var ka,xf;function w5(){if(xf)return ka;xf=1;var e=v5(),t=g5(),n=py();function i(o){var s=t(o);return s.length==1&&s[0][2]?n(s[0][0],s[0][1]):function(r){return r===o||e(r,o,s)}}return ka=i,ka}var xa,Af;function cd(){if(Af)return xa;Af=1;var e=Si(),t=Gt(),n="[object Symbol]";function i(o){return typeof o=="symbol"||t(o)&&e(o)==n}return xa=i,xa}var Aa,Sf;function ld(){if(Sf)return Aa;Sf=1;var e=$e(),t=cd(),n=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,i=/^\w*$/;function o(s,r){if(e(s))return!1;var a=typeof s;return a=="number"||a=="symbol"||a=="boolean"||s==null||t(s)?!0:i.test(s)||!n.test(s)||r!=null&&s in Object(r)}return Aa=o,Aa}var Sa,Cf;function b5(){if(Cf)return Sa;Cf=1;var e=Jl(),t="Expected a function";function n(i,o){if(typeof i!="function"||o!=null&&typeof o!="function")throw new TypeError(t);var s=function(){var r=arguments,a=o?o.apply(this,r):r[0],c=s.cache;if(c.has(a))return c.get(a);var l=i.apply(this,r);return s.cache=c.set(a,l)||c,l};return s.cache=new(n.Cache||e),s}return n.Cache=e,Sa=n,Sa}var Ca,$f;function y5(){if($f)return Ca;$f=1;var e=b5(),t=500;function n(i){var o=e(i,function(r){return s.size===t&&s.clear(),r}),s=o.cache;return o}return Ca=n,Ca}var $a,jf;function k5(){if(jf)return $a;jf=1;var e=y5(),t=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,n=/\\(\\)?/g,i=e(function(o){var s=[];return o.charCodeAt(0)===46&&s.push(""),o.replace(t,function(r,a,c,l){s.push(c?l.replace(n,"$1"):a||r)}),s});return $a=i,$a}var ja,Tf;function dd(){if(Tf)return ja;Tf=1;function e(t,n){for(var i=-1,o=t==null?0:t.length,s=Array(o);++i<o;)s[i]=n(t[i],i,t);return s}return ja=e,ja}var Ta,Pf;function x5(){if(Pf)return Ta;Pf=1;var e=Ai(),t=dd(),n=$e(),i=cd(),o=1/0,s=e?e.prototype:void 0,r=s?s.toString:void 0;function a(c){if(typeof c=="string")return c;if(n(c))return t(c,a)+"";if(i(c))return r?r.call(c):"";var l=c+"";return l=="0"&&1/c==-o?"-0":l}return Ta=a,Ta}var Pa,Nf;function A5(){if(Nf)return Pa;Nf=1;var e=x5();function t(n){return n==null?"":e(n)}return Pa=t,Pa}var Na,Ef;function my(){if(Ef)return Na;Ef=1;var e=$e(),t=ld(),n=k5(),i=A5();function o(s,r){return e(s)?s:t(s,r)?[s]:n(i(s))}return Na=o,Na}var Ea,If;function js(){if(If)return Ea;If=1;var e=cd(),t=1/0;function n(i){if(typeof i=="string"||e(i))return i;var o=i+"";return o=="0"&&1/i==-t?"-0":o}return Ea=n,Ea}var Ia,Rf;function fy(){if(Rf)return Ia;Rf=1;var e=my(),t=js();function n(i,o){o=e(o,i);for(var s=0,r=o.length;i!=null&&s<r;)i=i[t(o[s++])];return s&&s==r?i:void 0}return Ia=n,Ia}var Ra,Df;function S5(){if(Df)return Ra;Df=1;var e=fy();function t(n,i,o){var s=n==null?void 0:e(n,i);return s===void 0?o:s}return Ra=t,Ra}var Da,Of;function C5(){if(Of)return Da;Of=1;function e(t,n){return t!=null&&n in Object(t)}return Da=e,Da}var Oa,Mf;function hy(){if(Mf)return Oa;Mf=1;var e=my(),t=xs(),n=$e(),i=Yb(),o=Ql(),s=js();function r(a,c,l){c=e(c,a);for(var d=-1,u=c.length,f=!1;++d<u;){var m=s(c[d]);if(!(f=a!=null&&l(a,m)))break;a=a[m]}return f||++d!=u?f:(u=a==null?0:a.length,!!u&&o(u)&&i(m,u)&&(n(a)||t(a)))}return Oa=r,Oa}var Ma,qf;function $5(){if(qf)return Ma;qf=1;var e=C5(),t=hy();function n(i,o){return i!=null&&t(i,o,e)}return Ma=n,Ma}var qa,Vf;function j5(){if(Vf)return qa;Vf=1;var e=dy(),t=S5(),n=$5(),i=ld(),o=uy(),s=py(),r=js(),a=1,c=2;function l(d,u){return i(d)&&o(u)?s(r(d),u):function(f){var m=t(f,d);return m===void 0&&m===u?n(f,d):e(u,m,a|c)}}return qa=l,qa}var Va,Ff;function vy(){if(Ff)return Va;Ff=1;function e(t){return function(n){return n==null?void 0:n[t]}}return Va=e,Va}var Fa,zf;function T5(){if(zf)return Fa;zf=1;var e=fy();function t(n){return function(i){return e(i,n)}}return Fa=t,Fa}var za,Lf;function P5(){if(Lf)return za;Lf=1;var e=vy(),t=T5(),n=ld(),i=js();function o(s){return n(s)?e(i(s)):t(s)}return za=o,za}var La,Bf;function Ts(){if(Bf)return La;Bf=1;var e=w5(),t=j5(),n=$s(),i=$e(),o=P5();function s(r){return typeof r=="function"?r:r==null?n:typeof r=="object"?i(r)?t(r[0],r[1]):e(r):o(r)}return La=s,La}var Ba,Uf;function N5(){if(Uf)return Ba;Uf=1;var e=Zb(),t=c5(),n=Ts(),i=$e();function o(s,r){var a=i(s)?e:t;return a(s,n(r,3))}return Ba=o,Ba}var Ua,Wf;function E5(){if(Wf)return Ua;Wf=1;var e=Object.prototype,t=e.hasOwnProperty;function n(i,o){return i!=null&&t.call(i,o)}return Ua=n,Ua}var Wa,Hf;function I5(){if(Hf)return Wa;Hf=1;var e=E5(),t=hy();function n(i,o){return i!=null&&t(i,o,e)}return Wa=n,Wa}var Ha,Gf;function R5(){if(Gf)return Ha;Gf=1;var e=nd(),t=Ci(),n=xs(),i=$e(),o=Vn(),s=fo(),r=Ss(),a=As(),c="[object Map]",l="[object Set]",d=Object.prototype,u=d.hasOwnProperty;function f(m){if(m==null)return!0;if(o(m)&&(i(m)||typeof m=="string"||typeof m.splice=="function"||s(m)||a(m)||n(m)))return!m.length;var h=t(m);if(h==c||h==l)return!m.size;if(r(m))return!e(m).length;for(var v in m)if(u.call(m,v))return!1;return!0}return Ha=f,Ha}var Ga,Kf;function D5(){if(Kf)return Ga;Kf=1;function e(t){return t===void 0}return Ga=e,Ga}var Ka,Yf;function O5(){if(Yf)return Ka;Yf=1;var e=Cs(),t=Vn();function n(i,o){var s=-1,r=t(i)?Array(i.length):[];return e(i,function(a,c,l){r[++s]=o(a,c,l)}),r}return Ka=n,Ka}var Ya,Jf;function M5(){if(Jf)return Ya;Jf=1;var e=dd(),t=Ts(),n=O5(),i=$e();function o(s,r){var a=i(s)?e:n;return a(s,t(r,3))}return Ya=o,Ya}var Ja,Xf;function q5(){if(Xf)return Ja;Xf=1;function e(t,n,i,o){var s=-1,r=t==null?0:t.length;for(o&&r&&(i=t[++s]);++s<r;)i=n(i,t[s],s,t);return i}return Ja=e,Ja}var Xa,Zf;function V5(){if(Zf)return Xa;Zf=1;function e(t,n,i,o,s){return s(t,function(r,a,c){i=o?(o=!1,r):n(i,r,a,c)}),i}return Xa=e,Xa}var Za,Qf;function F5(){if(Qf)return Za;Qf=1;var e=q5(),t=Cs(),n=Ts(),i=V5(),o=$e();function s(r,a,c){var l=o(r)?e:i,d=arguments.length<3;return l(r,n(a,4),c,d,t)}return Za=s,Za}var Qa,eh;function z5(){if(eh)return Qa;eh=1;var e=Si(),t=$e(),n=Gt(),i="[object String]";function o(s){return typeof s=="string"||!t(s)&&n(s)&&e(s)==i}return Qa=o,Qa}var ec,th;function L5(){if(th)return ec;th=1;var e=vy(),t=e("length");return ec=t,ec}var tc,nh;function B5(){if(nh)return tc;nh=1;var e="\\ud800-\\udfff",t="\\u0300-\\u036f",n="\\ufe20-\\ufe2f",i="\\u20d0-\\u20ff",o=t+n+i,s="\\ufe0e\\ufe0f",r="\\u200d",a=RegExp("["+r+e+o+s+"]");function c(l){return a.test(l)}return tc=c,tc}var nc,ih;function U5(){if(ih)return nc;ih=1;var e="\\ud800-\\udfff",t="\\u0300-\\u036f",n="\\ufe20-\\ufe2f",i="\\u20d0-\\u20ff",o=t+n+i,s="\\ufe0e\\ufe0f",r="["+e+"]",a="["+o+"]",c="\\ud83c[\\udffb-\\udfff]",l="(?:"+a+"|"+c+")",d="[^"+e+"]",u="(?:\\ud83c[\\udde6-\\uddff]){2}",f="[\\ud800-\\udbff][\\udc00-\\udfff]",m="\\u200d",h=l+"?",v="["+s+"]?",g="(?:"+m+"(?:"+[d,u,f].join("|")+")"+v+h+")*",b=v+h+g,w="(?:"+[d+a+"?",a,u,f,r].join("|")+")",k=RegExp(c+"(?="+c+")|"+w+b,"g");function y(S){for(var T=k.lastIndex=0;k.test(S);)++T;return T}return nc=y,nc}var ic,oh;function W5(){if(oh)return ic;oh=1;var e=L5(),t=B5(),n=U5();function i(o){return t(o)?n(o):e(o)}return ic=i,ic}var oc,sh;function H5(){if(sh)return oc;sh=1;var e=nd(),t=Ci(),n=Vn(),i=z5(),o=W5(),s="[object Map]",r="[object Set]";function a(c){if(c==null)return 0;if(n(c))return i(c)?o(c):c.length;var l=t(c);return l==s||l==r?c.size:e(c).length}return oc=a,oc}var sc,rh;function G5(){if(rh)return sc;rh=1;var e=Zl(),t=sy(),n=_y(),i=Ts(),o=rd(),s=$e(),r=fo(),a=ws(),c=Mn(),l=As();function d(u,f,m){var h=s(u),v=h||r(u)||l(u);if(f=i(f,4),m==null){var g=u&&u.constructor;v?m=h?new g:[]:c(u)?m=a(g)?t(o(u)):{}:m={}}return(v?e:n)(u,function(b,w,k){return f(m,b,w,k)}),m}return sc=d,sc}var rc,_h;function K5(){if(_h)return rc;_h=1;var e=Ai(),t=xs(),n=$e(),i=e?e.isConcatSpreadable:void 0;function o(s){return n(s)||t(s)||!!(i&&s&&s[i])}return rc=o,rc}var _c,ah;function Y5(){if(ah)return _c;ah=1;var e=sd(),t=K5();function n(i,o,s,r,a){var c=-1,l=i.length;for(s||(s=t),a||(a=[]);++c<l;){var d=i[c];o>0&&s(d)?o>1?n(d,o-1,s,r,a):e(a,d):r||(a[a.length]=d)}return a}return _c=n,_c}var ac,ch;function J5(){if(ch)return ac;ch=1;function e(t,n,i){switch(i.length){case 0:return t.call(n);case 1:return t.call(n,i[0]);case 2:return t.call(n,i[0],i[1]);case 3:return t.call(n,i[0],i[1],i[2])}return t.apply(n,i)}return ac=e,ac}var cc,lh;function X5(){if(lh)return cc;lh=1;var e=J5(),t=Math.max;function n(i,o,s){return o=t(o===void 0?i.length-1:o,0),function(){for(var r=arguments,a=-1,c=t(r.length-o,0),l=Array(c);++a<c;)l[a]=r[o+a];a=-1;for(var d=Array(o+1);++a<o;)d[a]=r[a];return d[o]=s(l),e(i,this,d)}}return cc=n,cc}var lc,dh;function Z5(){if(dh)return lc;dh=1;var e=ry(),t=Hb(),n=$s(),i=t?function(o,s){return t(o,"toString",{configurable:!0,enumerable:!1,value:e(s),writable:!0})}:n;return lc=i,lc}var dc,uh;function Q5(){if(uh)return dc;uh=1;var e=800,t=16,n=Date.now;function i(o){var s=0,r=0;return function(){var a=n(),c=t-(a-r);if(r=a,c>0){if(++s>=e)return arguments[0]}else s=0;return o.apply(void 0,arguments)}}return dc=i,dc}var uc,ph;function eT(){if(ph)return uc;ph=1;var e=Z5(),t=Q5(),n=t(e);return uc=n,uc}var pc,mh;function tT(){if(mh)return pc;mh=1;var e=$s(),t=X5(),n=eT();function i(o,s){return n(t(o,s,e),o+"")}return pc=i,pc}var mc,fh;function nT(){if(fh)return mc;fh=1;function e(t,n,i,o){for(var s=t.length,r=i+(o?1:-1);o?r--:++r<s;)if(n(t[r],r,t))return r;return-1}return mc=e,mc}var fc,hh;function iT(){if(hh)return fc;hh=1;function e(t){return t!==t}return fc=e,fc}var hc,vh;function oT(){if(vh)return hc;vh=1;function e(t,n,i){for(var o=i-1,s=t.length;++o<s;)if(t[o]===n)return o;return-1}return hc=e,hc}var vc,gh;function sT(){if(gh)return vc;gh=1;var e=nT(),t=iT(),n=oT();function i(o,s,r){return s===s?n(o,s,r):e(o,t,r)}return vc=i,vc}var gc,wh;function rT(){if(wh)return gc;wh=1;var e=sT();function t(n,i){var o=n==null?0:n.length;return!!o&&e(n,i,0)>-1}return gc=t,gc}var wc,bh;function _T(){if(bh)return wc;bh=1;function e(t,n,i){for(var o=-1,s=t==null?0:t.length;++o<s;)if(i(n,t[o]))return!0;return!1}return wc=e,wc}var bc,yh;function aT(){if(yh)return bc;yh=1;function e(){}return bc=e,bc}var yc,kh;function cT(){if(kh)return yc;kh=1;var e=iy(),t=aT(),n=ad(),i=1/0,o=e&&1/n(new e([,-0]))[1]==i?function(s){return new e(s)}:t;return yc=o,yc}var kc,xh;function lT(){if(xh)return kc;xh=1;var e=ay(),t=rT(),n=_T(),i=cy(),o=cT(),s=ad(),r=200;function a(c,l,d){var u=-1,f=t,m=c.length,h=!0,v=[],g=v;if(d)h=!1,f=n;else if(m>=r){var b=l?null:o(c);if(b)return s(b);h=!1,f=i,g=new e}else g=l?[]:v;e:for(;++u<m;){var w=c[u],k=l?l(w):w;if(w=d||w!==0?w:0,h&&k===k){for(var y=g.length;y--;)if(g[y]===k)continue e;l&&g.push(k),v.push(w)}else f(g,k,d)||(g!==v&&g.push(k),v.push(w))}return v}return kc=a,kc}var xc,Ah;function dT(){if(Ah)return xc;Ah=1;var e=Vn(),t=Gt();function n(i){return t(i)&&e(i)}return xc=n,xc}var Ac,Sh;function uT(){if(Sh)return Ac;Sh=1;var e=Y5(),t=tT(),n=lT(),i=dT(),o=t(function(s){return n(e(s,1,i,!0))});return Ac=o,Ac}var Sc,Ch;function pT(){if(Ch)return Sc;Ch=1;var e=dd();function t(n,i){return e(i,function(o){return n[o]})}return Sc=t,Sc}var Cc,$h;function mT(){if($h)return Cc;$h=1;var e=pT(),t=Fn();function n(i){return i==null?[]:e(i,t(i))}return Cc=n,Cc}var Qo;if(typeof Ak=="function")try{Qo={clone:n5(),constant:ry(),each:a5(),filter:N5(),has:I5(),isArray:$e(),isEmpty:R5(),isFunction:ws(),isUndefined:D5(),keys:Fn(),map:M5(),reduce:F5(),size:H5(),transform:G5(),union:uT(),values:mT()}}catch{}Qo||(Qo=window._);var mt=Qo,B=mt,ud=K,fT="\0",Cn="\0",jh="";function K(e){this._isDirected=B.has(e,"directed")?e.directed:!0,this._isMultigraph=B.has(e,"multigraph")?e.multigraph:!1,this._isCompound=B.has(e,"compound")?e.compound:!1,this._label=void 0,this._defaultNodeLabelFn=B.constant(void 0),this._defaultEdgeLabelFn=B.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[Cn]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}K.prototype._nodeCount=0;K.prototype._edgeCount=0;K.prototype.isDirected=function(){return this._isDirected};K.prototype.isMultigraph=function(){return this._isMultigraph};K.prototype.isCompound=function(){return this._isCompound};K.prototype.setGraph=function(e){return this._label=e,this};K.prototype.graph=function(){return this._label};K.prototype.setDefaultNodeLabel=function(e){return B.isFunction(e)||(e=B.constant(e)),this._defaultNodeLabelFn=e,this};K.prototype.nodeCount=function(){return this._nodeCount};K.prototype.nodes=function(){return B.keys(this._nodes)};K.prototype.sources=function(){var e=this;return B.filter(this.nodes(),function(t){return B.isEmpty(e._in[t])})};K.prototype.sinks=function(){var e=this;return B.filter(this.nodes(),function(t){return B.isEmpty(e._out[t])})};K.prototype.setNodes=function(e,t){var n=arguments,i=this;return B.each(e,function(o){n.length>1?i.setNode(o,t):i.setNode(o)}),this};K.prototype.setNode=function(e,t){return B.has(this._nodes,e)?(arguments.length>1&&(this._nodes[e]=t),this):(this._nodes[e]=arguments.length>1?t:this._defaultNodeLabelFn(e),this._isCompound&&(this._parent[e]=Cn,this._children[e]={},this._children[Cn][e]=!0),this._in[e]={},this._preds[e]={},this._out[e]={},this._sucs[e]={},++this._nodeCount,this)};K.prototype.node=function(e){return this._nodes[e]};K.prototype.hasNode=function(e){return B.has(this._nodes,e)};K.prototype.removeNode=function(e){var t=this;if(B.has(this._nodes,e)){var n=function(i){t.removeEdge(t._edgeObjs[i])};delete this._nodes[e],this._isCompound&&(this._removeFromParentsChildList(e),delete this._parent[e],B.each(this.children(e),function(i){t.setParent(i)}),delete this._children[e]),B.each(B.keys(this._in[e]),n),delete this._in[e],delete this._preds[e],B.each(B.keys(this._out[e]),n),delete this._out[e],delete this._sucs[e],--this._nodeCount}return this};K.prototype.setParent=function(e,t){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(B.isUndefined(t))t=Cn;else{t+="";for(var n=t;!B.isUndefined(n);n=this.parent(n))if(n===e)throw new Error("Setting "+t+" as parent of "+e+" would create a cycle");this.setNode(t)}return this.setNode(e),this._removeFromParentsChildList(e),this._parent[e]=t,this._children[t][e]=!0,this};K.prototype._removeFromParentsChildList=function(e){delete this._children[this._parent[e]][e]};K.prototype.parent=function(e){if(this._isCompound){var t=this._parent[e];if(t!==Cn)return t}};K.prototype.children=function(e){if(B.isUndefined(e)&&(e=Cn),this._isCompound){var t=this._children[e];if(t)return B.keys(t)}else{if(e===Cn)return this.nodes();if(this.hasNode(e))return[]}};K.prototype.predecessors=function(e){var t=this._preds[e];if(t)return B.keys(t)};K.prototype.successors=function(e){var t=this._sucs[e];if(t)return B.keys(t)};K.prototype.neighbors=function(e){var t=this.predecessors(e);if(t)return B.union(t,this.successors(e))};K.prototype.isLeaf=function(e){var t;return this.isDirected()?t=this.successors(e):t=this.neighbors(e),t.length===0};K.prototype.filterNodes=function(e){var t=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});t.setGraph(this.graph());var n=this;B.each(this._nodes,function(s,r){e(r)&&t.setNode(r,s)}),B.each(this._edgeObjs,function(s){t.hasNode(s.v)&&t.hasNode(s.w)&&t.setEdge(s,n.edge(s))});var i={};function o(s){var r=n.parent(s);return r===void 0||t.hasNode(r)?(i[s]=r,r):r in i?i[r]:o(r)}return this._isCompound&&B.each(t.nodes(),function(s){t.setParent(s,o(s))}),t};K.prototype.setDefaultEdgeLabel=function(e){return B.isFunction(e)||(e=B.constant(e)),this._defaultEdgeLabelFn=e,this};K.prototype.edgeCount=function(){return this._edgeCount};K.prototype.edges=function(){return B.values(this._edgeObjs)};K.prototype.setPath=function(e,t){var n=this,i=arguments;return B.reduce(e,function(o,s){return i.length>1?n.setEdge(o,s,t):n.setEdge(o,s),s}),this};K.prototype.setEdge=function(){var e,t,n,i,o=!1,s=arguments[0];typeof s=="object"&&s!==null&&"v"in s?(e=s.v,t=s.w,n=s.name,arguments.length===2&&(i=arguments[1],o=!0)):(e=s,t=arguments[1],n=arguments[3],arguments.length>2&&(i=arguments[2],o=!0)),e=""+e,t=""+t,B.isUndefined(n)||(n=""+n);var r=ho(this._isDirected,e,t,n);if(B.has(this._edgeLabels,r))return o&&(this._edgeLabels[r]=i),this;if(!B.isUndefined(n)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(e),this.setNode(t),this._edgeLabels[r]=o?i:this._defaultEdgeLabelFn(e,t,n);var a=hT(this._isDirected,e,t,n);return e=a.v,t=a.w,Object.freeze(a),this._edgeObjs[r]=a,Th(this._preds[t],e),Th(this._sucs[e],t),this._in[t][r]=a,this._out[e][r]=a,this._edgeCount++,this};K.prototype.edge=function(e,t,n){var i=arguments.length===1?pd(this._isDirected,arguments[0]):ho(this._isDirected,e,t,n);return this._edgeLabels[i]};K.prototype.hasEdge=function(e,t,n){var i=arguments.length===1?pd(this._isDirected,arguments[0]):ho(this._isDirected,e,t,n);return B.has(this._edgeLabels,i)};K.prototype.removeEdge=function(e,t,n){var i=arguments.length===1?pd(this._isDirected,arguments[0]):ho(this._isDirected,e,t,n),o=this._edgeObjs[i];return o&&(e=o.v,t=o.w,delete this._edgeLabels[i],delete this._edgeObjs[i],Ph(this._preds[t],e),Ph(this._sucs[e],t),delete this._in[t][i],delete this._out[e][i],this._edgeCount--),this};K.prototype.inEdges=function(e,t){var n=this._in[e];if(n){var i=B.values(n);return t?B.filter(i,function(o){return o.v===t}):i}};K.prototype.outEdges=function(e,t){var n=this._out[e];if(n){var i=B.values(n);return t?B.filter(i,function(o){return o.w===t}):i}};K.prototype.nodeEdges=function(e,t){var n=this.inEdges(e,t);if(n)return n.concat(this.outEdges(e,t))};function Th(e,t){e[t]?e[t]++:e[t]=1}function Ph(e,t){--e[t]||delete e[t]}function ho(e,t,n,i){var o=""+t,s=""+n;if(!e&&o>s){var r=o;o=s,s=r}return o+jh+s+jh+(B.isUndefined(i)?fT:i)}function hT(e,t,n,i){var o=""+t,s=""+n;if(!e&&o>s){var r=o;o=s,s=r}var a={v:o,w:s};return i&&(a.name=i),a}function pd(e,t){return ho(e,t.v,t.w,t.name)}var vT="2.1.8",gT={Graph:ud,version:vT},jt=mt,wT=ud,bT={write:yT,read:AT};function yT(e){var t={options:{directed:e.isDirected(),multigraph:e.isMultigraph(),compound:e.isCompound()},nodes:kT(e),edges:xT(e)};return jt.isUndefined(e.graph())||(t.value=jt.clone(e.graph())),t}function kT(e){return jt.map(e.nodes(),function(t){var n=e.node(t),i=e.parent(t),o={v:t};return jt.isUndefined(n)||(o.value=n),jt.isUndefined(i)||(o.parent=i),o})}function xT(e){return jt.map(e.edges(),function(t){var n=e.edge(t),i={v:t.v,w:t.w};return jt.isUndefined(t.name)||(i.name=t.name),jt.isUndefined(n)||(i.value=n),i})}function AT(e){var t=new wT(e.options).setGraph(e.value);return jt.each(e.nodes,function(n){t.setNode(n.v,n.value),n.parent&&t.setParent(n.v,n.parent)}),jt.each(e.edges,function(n){t.setEdge({v:n.v,w:n.w,name:n.name},n.value)}),t}var Eo=mt,ST=CT;function CT(e){var t={},n=[],i;function o(s){Eo.has(t,s)||(t[s]=!0,i.push(s),Eo.each(e.successors(s),o),Eo.each(e.predecessors(s),o))}return Eo.each(e.nodes(),function(s){i=[],o(s),i.length&&n.push(i)}),n}var gy=mt,wy=ft;function ft(){this._arr=[],this._keyIndices={}}ft.prototype.size=function(){return this._arr.length};ft.prototype.keys=function(){return this._arr.map(function(e){return e.key})};ft.prototype.has=function(e){return gy.has(this._keyIndices,e)};ft.prototype.priority=function(e){var t=this._keyIndices[e];if(t!==void 0)return this._arr[t].priority};ft.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key};ft.prototype.add=function(e,t){var n=this._keyIndices;if(e=String(e),!gy.has(n,e)){var i=this._arr,o=i.length;return n[e]=o,i.push({key:e,priority:t}),this._decrease(o),!0}return!1};ft.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var e=this._arr.pop();return delete this._keyIndices[e.key],this._heapify(0),e.key};ft.prototype.decrease=function(e,t){var n=this._keyIndices[e];if(t>this._arr[n].priority)throw new Error("New priority is greater than current priority. Key: "+e+" Old: "+this._arr[n].priority+" New: "+t);this._arr[n].priority=t,this._decrease(n)};ft.prototype._heapify=function(e){var t=this._arr,n=2*e,i=n+1,o=e;n<t.length&&(o=t[n].priority<t[o].priority?n:o,i<t.length&&(o=t[i].priority<t[o].priority?i:o),o!==e&&(this._swap(e,o),this._heapify(o)))};ft.prototype._decrease=function(e){for(var t=this._arr,n=t[e].priority,i;e!==0&&(i=e>>1,!(t[i].priority<n));)this._swap(e,i),e=i};ft.prototype._swap=function(e,t){var n=this._arr,i=this._keyIndices,o=n[e],s=n[t];n[e]=s,n[t]=o,i[s.key]=e,i[o.key]=t};var $T=mt,jT=wy,by=PT,TT=$T.constant(1);function PT(e,t,n,i){return NT(e,String(t),n||TT,i||function(o){return e.outEdges(o)})}function NT(e,t,n,i){var o={},s=new jT,r,a,c=function(l){var d=l.v!==r?l.v:l.w,u=o[d],f=n(l),m=a.distance+f;if(f<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+l+" Weight: "+f);m<u.distance&&(u.distance=m,u.predecessor=r,s.decrease(d,m))};for(e.nodes().forEach(function(l){var d=l===t?0:Number.POSITIVE_INFINITY;o[l]={distance:d},s.add(l,d)});s.size()>0&&(r=s.removeMin(),a=o[r],a.distance!==Number.POSITIVE_INFINITY);)i(r).forEach(c);return o}var ET=by,IT=mt,RT=DT;function DT(e,t,n){return IT.transform(e.nodes(),function(i,o){i[o]=ET(e,o,t,n)},{})}var Nh=mt,yy=OT;function OT(e){var t=0,n=[],i={},o=[];function s(r){var a=i[r]={onStack:!0,lowlink:t,index:t++};if(n.push(r),e.successors(r).forEach(function(d){Nh.has(i,d)?i[d].onStack&&(a.lowlink=Math.min(a.lowlink,i[d].index)):(s(d),a.lowlink=Math.min(a.lowlink,i[d].lowlink))}),a.lowlink===a.index){var c=[],l;do l=n.pop(),i[l].onStack=!1,c.push(l);while(r!==l);o.push(c)}}return e.nodes().forEach(function(r){Nh.has(i,r)||s(r)}),o}var MT=mt,qT=yy,VT=FT;function FT(e){return MT.filter(qT(e),function(t){return t.length>1||t.length===1&&e.hasEdge(t[0],t[0])})}var zT=mt,LT=UT,BT=zT.constant(1);function UT(e,t,n){return WT(e,t||BT,n||function(i){return e.outEdges(i)})}function WT(e,t,n){var i={},o=e.nodes();return o.forEach(function(s){i[s]={},i[s][s]={distance:0},o.forEach(function(r){s!==r&&(i[s][r]={distance:Number.POSITIVE_INFINITY})}),n(s).forEach(function(r){var a=r.v===s?r.w:r.v,c=t(r);i[s][a]={distance:c,predecessor:s}})}),o.forEach(function(s){var r=i[s];o.forEach(function(a){var c=i[a];o.forEach(function(l){var d=c[s],u=r[l],f=c[l],m=d.distance+u.distance;m<f.distance&&(f.distance=m,f.predecessor=u.predecessor)})})}),i}var Ri=mt,ky=xy;xy.CycleException=es;function xy(e){var t={},n={},i=[];function o(s){if(Ri.has(n,s))throw new es;Ri.has(t,s)||(n[s]=!0,t[s]=!0,Ri.each(e.predecessors(s),o),delete n[s],i.push(s))}if(Ri.each(e.sinks(),o),Ri.size(t)!==e.nodeCount())throw new es;return i}function es(){}es.prototype=new Error;var Eh=ky,HT=GT;function GT(e){try{Eh(e)}catch(t){if(t instanceof Eh.CycleException)return!1;throw t}return!0}var ts=mt,Ay=KT;function KT(e,t,n){ts.isArray(t)||(t=[t]);var i=(e.isDirected()?e.successors:e.neighbors).bind(e),o=[],s={};return ts.each(t,function(r){if(!e.hasNode(r))throw new Error("Graph does not have node: "+r);Sy(e,r,n==="post",s,i,o)}),o}function Sy(e,t,n,i,o,s){ts.has(i,t)||(i[t]=!0,n||s.push(t),ts.each(o(t),function(r){Sy(e,r,n,i,o,s)}),n&&s.push(t))}var YT=Ay,JT=XT;function XT(e,t){return YT(e,t,"post")}var ZT=Ay,QT=eP;function eP(e,t){return ZT(e,t,"pre")}var Ih=mt,tP=ud,nP=wy,iP=oP;function oP(e,t){var n=new tP,i={},o=new nP,s;function r(c){var l=c.v===s?c.w:c.v,d=o.priority(l);if(d!==void 0){var u=t(c);u<d&&(i[l]=s,o.decrease(l,u))}}if(e.nodeCount()===0)return n;Ih.each(e.nodes(),function(c){o.add(c,Number.POSITIVE_INFINITY),n.setNode(c)}),o.decrease(e.nodes()[0],0);for(var a=!1;o.size()>0;){if(s=o.removeMin(),Ih.has(i,s))n.setEdge(s,i[s]);else{if(a)throw new Error("Input graph is not connected: "+e);a=!0}e.nodeEdges(s).forEach(r)}return n}var sP={components:ST,dijkstra:by,dijkstraAll:RT,findCycles:VT,floydWarshall:LT,isAcyclic:HT,postorder:JT,preorder:QT,prim:iP,tarjan:yy,topsort:ky},Rh=gT,Ps={Graph:Rh.Graph,json:bT,alg:sP,version:Rh.version};const Cy=Sk(Ps),rP=Tk({__proto__:null,default:Cy},[Ps]),$y=(Cy||rP).alg;function _P(e){const{items:t,get_id:n,get_head_ids:i,get_tail_ids:o}=e,s=new Ps.Graph;t.forEach(a=>s.setNode(n(a),a));const r=a=>s.hasNode(a);return t.forEach(a=>{const c=n(a);i(a).filter(r).forEach(l=>s.setEdge(c,l)),o(a).filter(r).forEach(l=>s.setEdge(l,c))}),s}function Dh(e){const{graph:t}=e,n=aP({graph:t}),i=[];return n.forEach(o=>{Ji(o).forEach(r=>{const a=[r,...Rt(t,r)];i.push(a)})}),i}function aP(e){const{graph:t}=e;return $y.components(t).map(i=>{const o=new Ps.Graph;return i.forEach(s=>{o.setNode(s,t.node(s)),(t.nodeEdges(s)||[]).forEach(a=>o.setEdge(a))}),o})}function Ji(e){return e.nodes().filter(n=>(e.successors(n)||[]).length===0)}function Io(e,t){const n=Ji(e),i=$y.dijkstra(e,t);return n.filter(o=>i[o].distance<Number.POSITIVE_INFINITY)}function Rt(e,t,n=!1){const i=e.predecessors(t)||[],o=new Set;let s=i.pop()||"";for(;s;){if(!o.has(s)&&(n||s!==t)){o.add(s);const r=e.predecessors(s)||[];i.push(...r)}s=i.pop()||""}return Array.from(o)}const cP=A.delay("graph related functions",()=>{const e=b=>b.id,t=b=>b.head_ids,n=b=>b.tail_ids,i=b=>_P({items:b,get_id:e,get_head_ids:t,get_tail_ids:n});function o(b,w,k){p(b.node(w),k.item);const y=b.outEdges(w)||[];p(y.map(T=>T.w),k.head_ids);const S=b.inEdges(w)||[];p(S.map(T=>T.v),k.tail_ids)}function s(){const b=[{id:"1",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function r(){const b=[{id:"1",head_ids:["2","4"],tail_ids:[]},{id:"2",head_ids:["1","3"],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function a(){const b=[{id:"1",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:[],tail_ids:[]},{id:"3",head_ids:[],tail_ids:[]},{id:"4",head_ids:["5"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function c(){const b=[{id:"1",head_ids:[],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["4"],tail_ids:[]},{id:"4",head_ids:[],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:["5"],tail_ids:[]},{id:"7",head_ids:["6"],tail_ids:[]},{id:"8",head_ids:["10"],tail_ids:[]},{id:"9",head_ids:["8"],tail_ids:[]},{id:"10",head_ids:["9"],tail_ids:[]},{id:"11",head_ids:["12","13"],tail_ids:["12","13"]},{id:"12",head_ids:["11","13"],tail_ids:["11","13"]},{id:"13",head_ids:["12","11"],tail_ids:["12","11"]},{id:"14",head_ids:["14"],tail_ids:["14"]},{id:"15",head_ids:[],tail_ids:["16"]},{id:"16",head_ids:[],tail_ids:[]},{id:"17",head_ids:["16"],tail_ids:[]},{id:"15b",head_ids:[],tail_ids:[]},{id:"16b",head_ids:["15b"],tail_ids:["17b"]},{id:"17b",head_ids:[],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function l(){const b=[{id:"4",head_ids:["2"],tail_ids:[]},{id:"2",head_ids:["3"],tail_ids:[]},{id:"3",head_ids:["2","1","4","7"],tail_ids:[]},{id:"1",head_ids:["5","6","9"],tail_ids:[]},{id:"5",head_ids:[],tail_ids:[]},{id:"6",head_ids:[],tail_ids:[]},{id:"7",head_ids:["8"],tail_ids:[]},{id:"8",head_ids:["7"],tail_ids:[]},{id:"9",head_ids:["5"],tail_ids:[]}],w=i(b);return{items:b,graph:w}}function d(){const b=[{id:"1",head_ids:["2"],tail_ids:["3"]}],w=i(b);return{items:b,graph:w}}const u=s(),f=c(),m=r(),h=a(),v=l(),g=d();A("graph",()=>{o(u.graph,"0",{item:void 0,head_ids:[],tail_ids:[]}),o(u.graph,"1",{item:u.items[0],head_ids:[],tail_ids:[]}),o(f.graph,"1",{item:f.items[0],head_ids:[],tail_ids:[]}),o(f.graph,"2",{item:f.items[1],head_ids:["3"],tail_ids:[]}),o(f.graph,"3",{item:f.items[2],head_ids:["4"],tail_ids:["2"]}),o(f.graph,"4",{item:f.items[3],head_ids:[],tail_ids:["3"]}),o(f.graph,"5",{item:f.items[4],head_ids:[],tail_ids:["6"]}),o(f.graph,"6",{item:f.items[5],head_ids:["5"],tail_ids:["7"]}),o(f.graph,"7",{item:f.items[6],head_ids:["6"],tail_ids:[]}),o(f.graph,"8",{item:f.items[7],head_ids:["10"],tail_ids:["9"]}),o(f.graph,"9",{item:f.items[8],head_ids:["8"],tail_ids:["10"]}),o(f.graph,"10",{item:f.items[9],head_ids:["9"],tail_ids:["8"]}),o(f.graph,"11",{item:f.items[10],head_ids:["12","13"],tail_ids:["12","13"]}),o(f.graph,"12",{item:f.items[11],head_ids:["11","13"],tail_ids:["11","13"]}),o(f.graph,"13",{item:f.items[12],head_ids:["11","12"],tail_ids:["11","12"]}),o(f.graph,"14",{item:f.items[13],head_ids:["14"],tail_ids:["14"]}),o(f.graph,"15",{item:f.items[14],head_ids:[],tail_ids:["16"]}),o(f.graph,"16",{item:f.items[15],head_ids:["15"],tail_ids:["17"]}),o(f.graph,"17",{item:f.items[16],head_ids:["16"],tail_ids:[]}),o(f.graph,"15b",{item:f.items[17],head_ids:[],tail_ids:["16b"]}),o(f.graph,"16b",{item:f.items[18],head_ids:["15b"],tail_ids:["17b"]}),o(f.graph,"17b",{item:f.items[19],head_ids:["16b"],tail_ids:[]}),o(g.graph,"1",{item:g.items[0],head_ids:[],tail_ids:[]})}),A("find_leaf_ids",()=>{p(Ji(m.graph),["3","4"]),p(Ji(h.graph),["2","3","5"]),p(Ji(v.graph),["5","6"])}),A("find_leaf_ids_for_id",()=>{p(Io(v.graph,"12"),[]),p(Io(v.graph,"1"),["5","6"]),p(Io(v.graph,"2"),["5","6"]),p(Io(v.graph,"7"),[])}),A("find_leaf_group_ids",()=>{p(Dh(u),[["1"]]),p(Dh(m),[["3","2","1"],["4","1","2"]])}),A("find_all_predecessor_ids",()=>{p(Rt(u.graph,"1"),[]),p(Rt(m.graph,"1"),["2"]),p(Rt(m.graph,"2"),["1"]),p(Rt(m.graph,"3"),["2","1"]),p(Rt(m.graph,"4"),["1","2"]),p(Rt(v.graph,"2"),["4","3"]),p(Rt(v.graph,"8"),["7","3","2","4"]),p(Rt(v.graph,"5"),["9","1","3","2","4"])})}),lP=A.delay("stable_stringify",()=>{let e="";e=kt({a:1,b:2,c:3}),p(e,'{"a":1,"b":2,"c":3}',"regular object"),e=kt({c:3,b:2,a:1}),p(e,'{"c":3,"b":2,"a":1}',"regular object with keys in reverse order remains unchanged by default"),e=kt({c:3,b:2,a:1},{sort_items:!0}),p(e,'{"a":1,"b":2,"c":3}',"regular object with keys in reverse order are sorted if requested"),e=kt({a:{b:{c:3}}}),p(e,'{"a":{"b":{"c":3}}}',"nested object"),e=kt({a:void 0}),p(e,"{}","object with undefined not rendered by default"),e=kt({a:void 0},{render_undefined:!0}),p(e,'{"a":undefined}',"object with undefined rendered when render_undefined is true")}),dP=A.delay("test sync",()=>{p(!0,!0,"should handle sync")}),uP=A.delay("test async",async()=>{await new Promise(e=>setTimeout(e,0)),p(!0,!0,"should handle async"),await A("test nested async",async()=>{await new Promise(e=>setTimeout(e,0)),p(!0,!0,"should handle nested async")}),A("test sync nested in async",()=>{p(!0,!0,"should handle sync nested in async")})});function Te(e){let t,n;const{conviction:i,probability:o,counterfactual_conviction:s,counterfactual_probability:r}=e,a=r===void 0&&s===void 0;return i!==1&&(n=1),a&&(o===1&&i!==1||o!==1)?t=1:r!==0&&(o===0&&i!==1||o!==0)?t=0:(t=void 0,n=void 0),{new_counterfactual_probability:t,new_counterfactual_conviction:n}}const pP=A.delay("calc_new_counterfactual_state",()=>{let e,t,n,i,o;e=.5,t=1,o=Te({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,void 0),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),n=0,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,void 0),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),p(o.new_counterfactual_probability,void 0),p(o.new_counterfactual_conviction,void 0),e=1,t=1,o=Te({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=0,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,void 0),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),p(o.new_counterfactual_probability,void 0),p(o.new_counterfactual_conviction,void 0),e=0,t=1,o=Te({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,void 0),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:void 0}),p(o.new_counterfactual_probability,void 0),p(o.new_counterfactual_conviction,void 0),e=.5,t=.5,o=Te({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,i),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,i),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),p(o.new_counterfactual_probability,void 0),p(o.new_counterfactual_conviction,void 0),e=1,t=.5,o=Te({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,i),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,i),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),p(o.new_counterfactual_probability,void 0),p(o.new_counterfactual_conviction,void 0),e=0,t=.5,o=Te({probability:e,conviction:t,counterfactual_probability:void 0,counterfactual_conviction:void 0}),n=1,i=1,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,i),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),n=0,p(o.new_counterfactual_probability,n),p(o.new_counterfactual_conviction,i),o=Te({probability:e,conviction:t,counterfactual_probability:n,counterfactual_conviction:i}),p(o.new_counterfactual_probability,void 0),p(o.new_counterfactual_conviction,void 0)}),mP=/^(([ ]{0,3}```)|([ ]{4,})).*/gm,Oh=/^[ \t]*(\*|\d+\.)/gm,Mh=/^[ \t]*[^\s]+/gm;function en(e){const t=[];let n=!1;const i=e.split(`
`);return i.forEach((s,r)=>{if(r>0){const a=i[r-1];a.match(mP)&&(n=!n),n||a.match(Mh)&&!a.match(Oh)&&(s.match(Oh)?t[r-1]=a+`
`:s.match(Mh)&&(t[r-1]=a+"<br>"))}t.push(s)}),t.join(`
`)}const fP=A.delay("add_newlines_to_markdown",()=>{p(en(`
test 1
test2
`),`
test 1<br>
test2
`);const e=`* Test bullet 1
* Test bullet 2`;p(en(e),e);let n=en(`Test 1
Test
  Test 3  
	Test 4
* Test bullet 1
* Test bullet 2

Test 5
1. Test number 1
2. Test number 2

`),i=`Test 1<br>
Test<br>
  Test 3  <br>
	Test 4

* Test bullet 1
* Test bullet 2

Test 5

1. Test number 1
2. Test number 2

`;p(n,i),A("Code blocks should not contain <br>",()=>{n=en("\n```\nsome text\n```\n"),i="\n```\nsome text\n```\n",p(n,i,"Three ``` should stop <br> insertion"),n=en("\n   ```\nsome text\n```\n"),i="\n   ```\nsome text\n```\n",p(n,i,"Three ``` with three prepended spaces should stop <br> insertion"),n=en(`
   more text
   some more text
`),i=`
   more text<br>
   some more text
`,p(n,i,"Three prepended spaces for normal text should allow <br> insertion"),n=en("\n    ```some text\n    some more text\n"),i="\n    ```some text\n    some more text\n",p(n,i,"Four prepended spaces for ``` and normal text should stop <br> insertion")})}),hP=A.delay("run_get_rich_text_tests",()=>{let e;A("replace_ids_in_text",()=>{const t=ie(1),n=ie(2),i=ie(3),s=new Date("2021-05-12").getTime(),r={use_creation_context:!1,creation_context:{label_ids:[]}},a={[t]:qt({base_id:-1,id:t,title:`@@${i} was told @@${n} is here`},r),[n]:qt({base_id:-1,id:n,title:"Person A"},r),[i]:qt({base_id:-1,id:i,title:"Person B"},r)},c={},l={text_type:fe.rich,wcomponents_by_id:a,knowledge_views_by_id:c,wc_id_to_counterfactuals_map:void 0,created_at_ms:s,sim_ms:s};e=ni({...l,text_type:fe.raw,text:`Yesterday @@${t} today`}),p(e,`Yesterday @@${t} today`,"Should not replace ids when text_type is RichTextType.raw"),e=ni({...l,text_type:fe.plain,text:`Yesterday @@${t} today`}),p(e,"Yesterday Person B was told Person A is here today","Should replace ids with only text and no links when text_type is RichTextType.plain"),e=ni({...l,text_type:fe.rich,text:`Yesterday @@${t} today`}),p(e,`Yesterday [Person B was told Person A is here](#wcomponents/${t}) today`,"Should replace ids with text and links when text_type is RichTextType.rich.  And should not render lower depth links so as not to have nested broken links.")}),A("get_title",()=>{const t=new Date("2021-05-12"),n=t.getTime(),i={use_creation_context:!1,creation_context:{label_ids:[]}},o=O=>{const M={id:"vps"+O.id,created_at:t,base_id:-1,datetime:{},entries:[{id:"VAP"+O.id,explanation:"",probability:1,conviction:1,value:"",description:""}]};return qt({...O,base_id:-1,type:"statev2",subtype:"boolean",values_and_prediction_sets:[M]},i)},s=ie(1),r=ie(2),a=ie(3),c=ie(4),l=ie(5),d=ie(6),u=ie(7),f=ie(8),m=ie(9),h=o({id:s,title:"aaa"}),v=o({id:r,title:`bbb @@${s}`}),g=o({id:a,title:"ccc ${value}"}),b=o({id:c,title:`ddd @@${a}`}),w=o({id:l,title:`eee \${value} @@${c}`}),k=o({id:d,title:`fff @@${l}`}),y=o({id:u,title:`ggg @@${d}`}),S=o({id:f,title:`Recursive @@${f}`}),T=o({id:m,title:`Recursive @@${m}.title`}),$={[h.id]:h,[v.id]:v,[g.id]:g,[b.id]:b,[w.id]:w,[k.id]:k,[y.id]:y,[S.id]:S,[T.id]:T},R={};function C(O){const{id:M,text_type:P,wc_id_to_counterfactuals_map:L}=O;return Qe({text_type:P,wcomponents_by_id:$,knowledge_views_by_id:R,wcomponent:$[M],wc_id_to_counterfactuals_map:L,created_at_ms:n,sim_ms:n})}A("get_title",()=>{const O={[h.id]:"aaa",[v.id]:`bbb @@${s}`,[g.id]:"ccc ${value}",[b.id]:`ddd @@${a}`,[w.id]:`eee \${value} @@${c}`},M={[h.id]:"aaa",[v.id]:"bbb aaa",[g.id]:"ccc True",[b.id]:"ddd ccc True",[w.id]:"eee True ddd ccc True"},P={[h.id]:"aaa",[v.id]:`bbb [aaa](#wcomponents/${s})`,[g.id]:"ccc True",[b.id]:`ddd [ccc True](#wcomponents/${a})`,[w.id]:`eee True [ddd ccc True](#wcomponents/${c})`};Object.entries(O).forEach(([L,J])=>{e=C({id:L,text_type:fe.raw}),p(e,J)}),Object.entries(M).forEach(([L,J])=>{e=C({id:L,text_type:fe.plain}),p(e,J)}),Object.entries(P).forEach(([L,J])=>{e=C({id:L,text_type:fe.rich}),p(e,J)})}),A("depth_limit",()=>{e=C({id:y.id,text_type:fe.rich}),p(e,`ggg [fff eee True ddd @@${a}](#wcomponents/${d})`,"Should stop recursively rendering ids when a depth limit is reached"),e=C({id:S.id,text_type:fe.rich}),p(e,"Recursive [Recursive Recursive Recursive @@80000000-0000-4000-a000-000000000000](#wcomponents/80000000-0000-4000-a000-000000000000)","Should handle recursion for normal recursive titles."),e=C({id:T.id,text_type:fe.rich}),p(!0,!0,"Should handle recursion for '.title' functional ids of recursive titles.")}),A("counterfactuals",()=>{const O={[g.id]:"ccc False",[b.id]:`ddd [ccc False](#wcomponents/${a})`,[w.id]:`eee True [ddd ccc False](#wcomponents/${c})`},M={[g.id]:{VAP_sets:{[`vps${a}`]:[{id:"wc999000",type:"counterfactualv2",created_at:t,base_id:-1,title:"",description:"",target_wcomponent_id:g.id,target_VAP_set_id:`vps${a}`,target_VAP_id:Tb}]}}};Object.entries(O).forEach(([P,L])=>{e=C({id:P,text_type:fe.rich,wc_id_to_counterfactuals_map:M}),p(e,L,"Should override values correctly using counterfactualv2 value")})})}),A.skip("replace_ids_in_text -> replace_calculations_with_results",()=>{const t=ie(1),i=new Date("2023-08-14").getTime(),o={use_creation_context:!1,creation_context:{label_ids:[]}},s={[t]:qt({base_id:-1,id:t,title:"UK Homes"},o)},r={},a={text_type:fe.rich,wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:void 0,created_at_ms:i,sim_ms:i};let l=ni({...a,text:`
    $$!
    value: 123
    $$!
    `});p(l,`
123
`,"Should replace calculation with string value")})}),vP=A.delay("id_regexs",()=>{A("uuids_regex",()=>{let e="77777777-7777-4777-8777-777777777777".match(zi);p(e!==null,!0,"should match a valid uuid"),p(e==null?void 0:e[0],"77777777-7777-4777-8777-777777777777","should match a valid uuid"),e="77777777-7777-0777-0777-777777777777".match(zi),p(e===null,!0,"should fail to match a invalid uuid"),e=" 77777777-7777-4777-8777-777777777777".match(zi),p(e===null,!0,"should fail to match a valid uuid with leading space"),e="77777777-7777-4777-8777-777777777777 ".match(zi),p(e===null,!0,"should fail to match a valid uuid with trailing space"),A("is_valid_uuid",()=>{p(Jn("77777777-7777-4777-8777-777777777777"),!0,"should match a valid uuid"),p(Jn("77777777-7777-0777-0777-777777777777"),!1,"should fail to match a invalid uuid"),p(Jn(" 77777777-7777-4777-8777-777777777777"),!1,"should fail to match a valid uuid with leading space"),p(Jn("77777777-7777-4777-8777-777777777777 "),!1,"should fail to match a valid uuid with trailing space"),p(Jn("77777777-7777-4777-8777-777777777777 ",!0),!0,"should match a valid uuid with trailing space if starts_with is true")})}),A("uuids_regexes",()=>{const e=`  77777777-7777-4777-8777-777777777777
        77777777-7777-0777-0777-777777777777
        11111111-1111-4111-8111-111111111111
        `.match(Vv);p(e!==null,!0,"should match a string with valid uuids"),p(e==null?void 0:e.length,2,"should match 2 valid uuids"),p(e==null?void 0:e[0],"77777777-7777-4777-8777-777777777777","should match first valid uuid"),p(e==null?void 0:e[1],"11111111-1111-4111-8111-111111111111","should match second valid uuid")})}),gP=A.delay("get_ids_from_text",()=>{let e=[];A("get_double_at_mentioned_uuids_from_text",()=>{e=bn(""),p(e,[],"Should find no IDs in empty string"),e=bn("asd @@wc123 asd name@example.com #label dfg @@345 sf"),p(e,[],'Should not find old ids of "wc123", "345"');const t=ie(1),n=ie(2);e=bn(`asd @@${t} asd name@example.com #label dfg @@${n} sf`),p(e,[t,n],"Should find uuid ids")}),A("get_uuids_from_text",()=>{e=Au(""),p(e,[],"Should find no IDs in empty string");const t=ie(1),n=ie(2);e=Au(`1 + [${t}] + (2 + [${n}]) * 3`),p(e,[t,n],"Should find uuid ids")})}),wP=A.delay("remove_rich_text",()=>{let e,t,n;e="Something [linked](http://example.com).",t=tn(e),n="Something linked.",p(t,n,"Should remove links in middle"),e="[Linked](http://example.com) here.",t=tn(e),n="Linked here.",p(t,n,"Should remove links at start"),e="[Linked](http://example.com) here and [here](https://other.example.com)",t=tn(e),n="Linked here and here",p(t,n,"Should remove multiple links at start"),e="<auto generated>Text with <auto generated> in it <auto generated>",t=tn(e),n="Text with in it",p(t,n,"Should remove <auto generated> tags"),e="Italicised <i>text<i/>",t=tn(e),n="Italicised text",p(t,n,"Should remove tags")}),bP=A.delay("replace_normal_ids",()=>{let e="",t="",n="";const i=ie(1),o=ie(9),s={use_creation_context:!1,creation_context:{label_ids:[]}},r={[i]:qt({base_id:-1,id:i,title:"Title 1"},s)};let a;A("render_links: true",()=>{a={wcomponents_by_id:r,depth_limit:2,render_links:!0,root_url:"http://datacurator.org",get_title:c=>c.title},e="",n="",t=Qt(e,1,a),p(t,n,"Should handle replacing ids in empty string"),e=`Some text
    with an @@id in
    it: @@${i}.
    `,n=`Some text
    with an @@id in
    it: [Title 1](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).
    `,t=Qt(e,1,a),p(t,n,"Should replace id with component title"),e=`An @@id to a component that's not found: @@${o}.`,n="An @@id to a component that's not found: ✗[@@90000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/90000000-0000-4000-a000-000000000000) (not found).",t=Qt(e,1,a),p(t,n,"Should handle missing components"),e=`Out of depth @@${i}.`,n="Out of depth [@@10000000-0000-4000-a000-000000000000](http://datacurator.org#wcomponents/10000000-0000-4000-a000-000000000000).",t=Qt(e,2,a),p(t,n,"Should not replace with component title when depth is exceeded")}),A("render_links: false",()=>{a={wcomponents_by_id:r,depth_limit:2,render_links:!1,root_url:"http://datacurator.org",get_title:c=>c.title},e=`Some @@id: @@${i}.`,n="Some @@id: Title 1.",t=Qt(e,1,a),p(t,n,"Should replace id with component title but no link when render_links is false"),e=`An @@id to a component that's not found: @@${o}.`,n="An @@id to a component that's not found: ✗@@90000000-0000-4000-a000-000000000000 (not found).",t=Qt(e,1,a),p(t,n,"Should handle missing components but not add link when render_links is false"),e=`Out of depth @@${i}.`,n="Out of depth @@10000000-0000-4000-a000-000000000000.",t=Qt(e,2,a),p(t,n,"Should not replace with component title when depth is exceeded and not add link when render_links is false")})}),yP=A.delay("derived_composed_wcomponents_by_id_reducer",()=>{const e=new Date("2023-10-05"),t=new Date("2023-10-06"),n=new Date("2023-10-07"),i=ie(1),o=ie(2),s=ie(3);let r,a,c,l,d,u;function f(v){return q({base_id:-1,type:"statev2",...v})}function m(v){return q({base_id:-1,type:"state_value",...v})}function h(v,g,b){let w=Sb();const k=We({base_id:-1,id:s,title:"Test KV",sort_type:"priority"},{}),y=yb(w);return w=y(w,x.specialised_object.upsert_knowledge_view({knowledge_view:k})),w=y(w,x.routing.change_route({args:{view:"knowledge",subview_id:k.id}})),w=y(w,x.specialised_object.upsert_wcomponent({wcomponent:v,add_to_knowledge_view:{id:k.id,position:{left:0,top:0}}})),w=y(w,x.specialised_object.upsert_wcomponent({wcomponent:g,add_to_knowledge_view:{id:k.id,position:{left:300,top:0}}})),b&&(w=y(w,x.routing.change_route({args:{created_at_datetime:b}}))),w}a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:t,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),A("state_value VAPs should be composed into statev2 wcomponent",()=>{var v;r=h(a,c,n),l=r.derived.composed_wcomponents_by_id,d=l[a.id],u=(d==null?void 0:d.values_and_prediction_sets)||[],p((v=u[0])==null?void 0:v.id,"vps22222","The composed wcomponent should have VAP sets from the state value component that targets it"),p(d==null?void 0:d._derived__using_value_from_wcomponent_id,c.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set to the state_value's ID")}),A("Components created after current created_at datetime are still present in composed_wcomponents_by_id",()=>{r=h(a,c,e),l=r.derived.composed_wcomponents_by_id,p(a.created_at.getTime()>r.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_statev2 wcomponent based on its created_at"),p(c.created_at.getTime()>r.routing.args.created_at_ms,!0,"Double check the current created_at should filter out wcomponent_state_value wcomponent based on its created_at"),p(new Set(Object.keys(l)),new Set([i,o]),"derived.composed_wcomponents_by_id should still contain the components when the created_at filter is set to before the created_at of the two components")}),A("state_value created after statev2 and filtered out by created_at datetime",()=>{var v;a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:n,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:n,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),r=h(a,c,t),l=r.derived.composed_wcomponents_by_id,d=l[a.id],u=(d==null?void 0:d.values_and_prediction_sets)||[],p((v=u[0])==null?void 0:v.id,"vps1","The composed wcomponent should have VAP sets from the original statev2 component as the state_value that targets it should be filtered out based on created_at time"),p(d==null?void 0:d._derived__using_value_from_wcomponent_id,void 0,"The composed wcomponent should NOT have _derived__using_value_from_wcomponent_id set")}),A("state_value VAPs filtered out by created_at datetime",()=>{a=f({id:o,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps1",created_at:t,entries:[],datetime:{}}]}),c=m({id:i,created_at:t,values_and_prediction_sets:[{base_id:-1,id:"vps22222",created_at:n,entries:[],datetime:{}}],attribute_wcomponent_id:a.id}),r=h(a,c,t),l=r.derived.composed_wcomponents_by_id,d=l[a.id],u=(d==null?void 0:d.values_and_prediction_sets)||[],p(u.length,0,"The composed wcomponent should have VAP sets from the state_value component that targets it but these VAPs should be filtered out based on created_at time"),p(d==null?void 0:d._derived__using_value_from_wcomponent_id,c.id,"The composed wcomponent should have _derived__using_value_from_wcomponent_id set")})}),kP=A.delay("get_composed_wcomponents_by_id",()=>{var c;const t=new Date("2024-10-08"),n={use_creation_context:!0,creation_context:{custom_created_at:t,label_ids:[]}},i=q({type:"statev2",base_id:-1,values_and_prediction_sets:[Ee(N.number,{1:{id:"1",order:1,value:"10",description:""}},[],-1,n)]}),o=q({type:"state_value",base_id:-1,values_and_prediction_sets:[Ee(N.number,{2:{id:"2",order:1,value:"20",description:""}},[],-1,n)],attribute_wcomponent_id:i.id});let r=Xw({wcomponents_by_id:{[i.id]:i,[o.id]:o},composed_visible_wc_id_map:{[i.id]:{left:0,top:0},[o.id]:{left:0,top:0}},created_at_ms:t.getTime()})[i.id];if(!Ze(r))throw new Error("Expected composed wcomponent to be statev2");p(r._derived__using_value_from_wcomponent_id,o.id,"should populate the _derived__using_value_from_wcomponent_id field of the statev2 with the id of the state_value component that is targeting it.");let a=(r.values_and_prediction_sets||[])[0];p((c=a==null?void 0:a.entries[0])==null?void 0:c.value,"20","should replace the VAP set of a statev2 with the VAP set of the state_value component that is targeting it.")}),xP=A.delay("calc_if_wcomponent_should_exclude_because_label_or_type",()=>{const e=q({id:"1",base_id:1}),t=q({id:"2",base_id:1,label_ids:[e.id]}),n=q({id:"3",base_id:1,label_ids:[]}),i={exclude_by_label_ids:new Set,include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},o={exclude_by_label_ids:new Set([e.id]),include_by_label_ids:new Set,exclude_by_component_types:new Set,include_by_component_types:new Set},s={exclude_by_label_ids:new Set,include_by_label_ids:new Set([e.id]),exclude_by_component_types:new Set,include_by_component_types:new Set},r={exclude_by_label_ids:new Set([e.id]),include_by_label_ids:new Set([e.id]),exclude_by_component_types:new Set,include_by_component_types:new Set};let{should_exclude:a,lacks_include:c}=Dt(t,i);p(a,!1),p(c,!1),{should_exclude:a,lacks_include:c}=Dt(t,o),p(a,!0),p(c,!1),{should_exclude:a,lacks_include:c}=Dt(t,s),p(a,!1),p(c,!1),{should_exclude:a,lacks_include:c}=Dt(n,s),p(a,!1),p(c,!0),{should_exclude:a,lacks_include:c}=Dt(t,r),p(a,!0),p(c,!1),{should_exclude:a,lacks_include:c}=Dt(e,o),p(a,!0),p(c,!1),{should_exclude:a,lacks_include:c}=Dt(e,s),p(a,!1),p(c,!1)}),fn=ie(1);function Ro(e,t,n){const o={id:t,foundation_knowledge_view_ids:n?[n]:void 0,wc_id_map:{},title:"",description:"",sort_type:"normal",created_at:new Date("2023-03-22 15:15:00"),base_id:1,goal_ids:[]};return e&&(o.wc_id_map[fn]=e),o}const AP=A.delay("get_composed_wc_id_maps_object",()=>{const e=new Date("2023-03-22 15:15:00");let t,n;t=lt([],{}),n={composed_wc_id_map:{},composed_blocked_wc_id_map:{}},p(t,n);const i=[{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, defined in foundation, ",test_description_part2:"should return entry in foundation"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"missing in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:void 0,kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"missing in current, blocked in foundation, ",test_description_part2:"should return entry in blocked"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, missing in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, defined in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, passthrough in foundation, ",test_description_part2:"should return entry in current not foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:{left:222,top:222},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"normal entry in current, blocked in foundation, ",test_description_part2:"should return entry in current not foundation and NOT show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, missing in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:{left:0,top:0},expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, defined in foundation, ",test_description_part2:"should return (passthrough) entry from foundation"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:void 0,test_description:"passthrough entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return"},{kv_wc_entry_in_current_kv:{left:222,top:222,passthrough:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:0,top:0,blocked:!0},test_description:"passthrough entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show foundation's blocked entry in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:void 0,expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, missing in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, defined in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,passthrough:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, passthrough in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"},{kv_wc_entry_in_current_kv:{left:222,top:222,blocked:!0},kv_wc_entry_in_foundation_kv:{left:0,top:0,blocked:!0},expected_result_in_composed_wc_id_map:void 0,expected_result_in_composed_blocked_wc_id_map:{left:222,top:222,blocked:!0},test_description:"blocked entry in current, blocked in foundation, ",test_description_part2:"should find no entry to return and show blocked entry from current kv in composed_blocked_wc_id_map"}];i.forEach(o=>{const s=Ro(o.kv_wc_entry_in_foundation_kv,"kv1"),r=Ro(o.kv_wc_entry_in_current_kv,"kv2","kv1");t=lt([s,r],{}),p(t.composed_wc_id_map[fn],o.expected_result_in_composed_wc_id_map,"composed_wc_id_map "+o.test_description+o.test_description_part2),p(t.composed_blocked_wc_id_map[fn],o.expected_result_in_composed_blocked_wc_id_map,"composed_blocked_wc_id_map "+o.test_description+o.test_description_part2)}),A("deleted wcomponent",()=>{i.forEach(o=>{const s=Ro(o.kv_wc_entry_in_foundation_kv,"kv1"),r=Ro(o.kv_wc_entry_in_current_kv,"kv2","kv1");t=lt([s,r],{[fn]:{id:fn,deleted_at:e,type:"statev2",title:"",description:"",created_at:e,base_id:1}}),p(t.composed_wc_id_map[fn],void 0,"composed_wc_id_map "+o.test_description+"should not return any entry"),p(t.composed_blocked_wc_id_map[fn],void 0,"composed_blocked_wc_id_map "+o.test_description+"should not return any entry")})})}),SP=A.delay("knowledge_views_derived_reducer",()=>{A("calculate_wc_ids_to_exclude_based_on_filters",()=>{const e={exclude_by_label_ids:[],include_by_label_ids:[],exclude_by_component_types:[],include_by_component_types:[],filter_by_current_knowledge_view:!1,filter_by_text:""},t=new Set,n=q({id:"node1",base_id:-1,type:"statev2",label_ids:[]}),i=q({id:"node2",base_id:-1,type:"statev2",label_ids:["123"]}),o=[n,i],s=q({id:"link1_no_label",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),r=q({id:"link2_no_label_no_from",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),a=q({id:"link3_no_label_no_to",base_id:-1,type:"causal_link",label_ids:[],from_id:n.id,to_id:i.id}),c=q({id:"link4_has_label",base_id:-1,type:"causal_link",label_ids:["123"],from_id:n.id,to_id:i.id}),l=q({id:"link5_has_label_no_from",base_id:-1,type:"causal_link",label_ids:["123"],from_id:void 0,to_id:i.id}),d=q({id:"link6_has_label_no_to",base_id:-1,type:"causal_link",label_ids:["123"],from_id:i.id,to_id:void 0}),u=[s,r,a,c,l,d];let f=Zc(e,t,o,u);p(f,new Set,"no filters"),e.include_by_label_ids=["123"],f=Zc(e,t,o,u),p(f,new Set([n.id,s.id,r.id,a.id,c.id]),"filter out components not labelled")})}),CP=A.delay("specialised_objects accessors tests",()=>{A("get_current_temporal_value_certainty_from_wcomponent",()=>{const e=new Date("2023-10-09"),t=new Date("2023-10-10");let n,i,o,s;function r(a,c){const l=q({base_id:-1,created_at:e,type:"statev2",values_and_prediction_sets:a}),d={[l.id]:l};return Cl(l.id,d,c)}i=e.getTime(),o=r(void 0,i),s=void 0,p(o,s,"No VAP sets should result in undefined value"),i=e.getTime(),o=r([],i),s=void 0,p(o,s,"Empty VAP sets should result in undefined value"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,entries:[],datetime:{}}],o=r(n,i),s={certainty:void 0,temporal_uncertainty:{}},p(o,s,"VAP sets with one VAPset should result in that VAP set's empty datetime being returned"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,entries:[],datetime:{value:t}}],o=r(n,i),s={certainty:void 0,temporal_uncertainty:{value:t}},p(o,s,"VAP sets with one VAPset should result in that VAP set's datetime and value being returned"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:t,datetime:{},entries:[]}],o=r(n,i),s=void 0,p.skip(o,s,"VAP sets with one VAPset created after current created_at should return undefined"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,datetime:{value:t},entries:[{id:"",description:"",value:"",explanation:"",probability:1,conviction:1}]}],o=r(n,i),s={certainty:1,temporal_uncertainty:{value:t}},p(o,s,"VAP sets with one VAPset with an 100% probable & confident (conviction) entry should be 100% certain"),i=e.getTime(),n=[{base_id:-1,id:"vps1",created_at:e,datetime:{value:t},entries:[{id:"",description:"",value:"",explanation:"",probability:.5,conviction:.5},{id:"",description:"",value:"",explanation:"",probability:.9,conviction:.9}]}],o=r(n,i),s={certainty:.81,temporal_uncertainty:{value:t}},p(o,s,"VAP sets with one VAPset with two entries should take highest certainty")})}),$P=A.delay("tidy_wcomponent",()=>{const t=new Date("2021-05-12"),n=new Date("2021-05-13"),i={use_creation_context:!1,creation_context:{label_ids:[]}};let o,s,r,a,c={};const l=-1;o=qt({base_id:l,type:"statev2",subtype:"other"},i),o.values_and_prediction_sets=[{...Ee(N.undefined,{},[],l,i),id:"vps2",created_at:n,custom_created_at:void 0},{...Ee(N.undefined,{},[],l,i),id:"vps1",created_at:t,custom_created_at:void 0}],r=Vt(o,c),p(r.values_and_prediction_sets.map(({id:u})=>u),["vps1","vps2"],"",!1),o=qt({base_id:l,type:"statev2",subtype:"other"},i),s=[{...qe(),id:"VAP1",relative_probability:5},{...qe(),id:"VAP2",relative_probability:0}],o.values_and_prediction_sets=[{...Ee(N.undefined,{},[],l,i),entries:s}],r=Vt(o,c),p(r.values_and_prediction_sets[0].entries.map(({probability:u})=>u),[1,0],"",!1),o={...o,subtype:"boolean"},r=Vt(o,c),a=r.values_and_prediction_sets[0].entries,p(a.map(({relative_probability:u})=>u),[5,0],"",!1),p(a.map(({probability:u})=>u),[1,0],"",!1),s=[{...qe(),id:"VAP1",relative_probability:5,probability:0},{...qe(),id:"VAP2",relative_probability:0,probability:1}];let d=[{...Ee(N.undefined,{},[],l,i),entries:s}];o={...o,subtype:"boolean",values_and_prediction_sets:d},r=Vt(o,c),a=r.values_and_prediction_sets[0].entries,p(a.map(({relative_probability:u})=>u),[5,0],"",!1),p(a.map(({probability:u})=>u),[0,1],"",!1),A("Ensuring _derived__using_value_from_wcomponent_id is not saved",()=>{const u=console.error;let f="";console.error=m=>{f=m},o={...o,_derived__using_value_from_wcomponent_id:"123"},r=Vt(o,c),console.error=u,p(f.length>0,!0,"Should log an error to the console when wcomponent with _derived__using_value_from_wcomponent_id is tidied before attempting to be saved"),p(r._derived__using_value_from_wcomponent_id,void 0,"Should delete wcomponent._derived__using_value_from_wcomponent_id")})}),jP=A.delay("refresh_bases_for_current_user",()=>{const e=new Date,t=new Date,n="123",i="987",o={id:1,inserted_at:e,updated_at:t,owner_user_id:n,public_read:!1,title:"owned by this user",access_level:"owner",can_edit:!0},s={id:2,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!1,title:"editable by this user",access_level:"editor",can_edit:!0},r={id:3,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!1,title:"viewable by this user",access_level:"viewer",can_edit:!1},a={id:3,inserted_at:e,updated_at:t,owner_user_id:i,public_read:!0,title:"public viewable by this user",access_level:"viewer",can_edit:!1},c=[o,s,r,a];function l(u){return ww({user_info:u})}let d={user:{id:n},chosen_base_id:void 0,bases_by_id:void 0};p(l(d),!1),[o,s].forEach(u=>{d=ei({user_info:d},x.user_info.update_bases({bases:[u]})).user_info,p(d.chosen_base_id,u.id),p(l(d),!1)}),d=ei({user_info:d},x.user_info.update_bases({bases:[r,a]})).user_info,p(d.chosen_base_id,void 0),p(l(d),!0),d=ei({user_info:{user:{id:n},chosen_base_id:100,bases_by_id:void 0}},x.user_info.update_bases({bases:[r,a]})).user_info,p(d.chosen_base_id,void 0),p(l(d),!0),[o,s].forEach(u=>{d=ei({user_info:{user:{id:n},chosen_base_id:100,bases_by_id:void 0}},x.user_info.update_bases({bases:[]})).user_info,p(d.chosen_base_id,void 0),p(l(d),!0)}),c.forEach(({id:u})=>{d=ei({user_info:{user:{id:n},chosen_base_id:u,bases_by_id:void 0}},x.user_info.update_bases({bases:c})).user_info,p(d.chosen_base_id,u),p(l(d),!1)})});function Bo(e,t){const n=[];for(let i=0;i<e.length;++i){const o=e[i];if(n.push(o),i>=e.length-1)continue;const s=e[i+1];n.push(t(o,s))}return n}const TP=A.delay("array functions",()=>{let e=Bo([],()=>0);p(e,[],"intersperse with no elements should be empty"),e=Bo(["a"],()=>0),p(e,["a"],"intersperse with 1 element should have no interspersed values"),e=Bo(["a","b","c"],(t,n)=>t.charCodeAt(0)+n.charCodeAt(0)),p(e,["a",195,"b",197,"c"],"intersperse with 3 elements should have interspersed values")});function qh(e,t,n){let i=0,o=e.length-1;for(;i<=o;){let s=Math.floor((i+o)/2);const r=t(e[s]);if(r===n)return s;r<n?i=s+1:o=s-1}return-1}function hn(e,t,n){let i=0,o=e.length-1;for(;i<=o;){let s=Math.floor((i+o)/2);const r=t(e[s]);if(r===n)return{index:s,exact:!0,bounds:"in"};if(r<n?i=s+1:o=s-1,i>o){const a=o===-1?"lower":i===e.length?"higher":"in";return{index:a==="lower"?-.5:a==="higher"?e.length-.5:r<n?s+.5:s-.5,exact:!1,bounds:a}}}return{index:-1,exact:!1,bounds:"n/a"}}const PP=A.delay("binary search functions",()=>{let e=qh([1,2,3,4,5,6,7,8,9],n=>n,3);p(e,2),e=qh([1,2,3,4,5,6,7,8,9],n=>n,3.5),p(e,-1);let t=hn([1,2,3,4,5,6,7,8,9],n=>n,3);p(t,{index:2,exact:!0,bounds:"in"}),t=hn([1,2,3,4,5,6,7,8,9],n=>n,0),p(t,{index:-.5,exact:!1,bounds:"lower"}),t=hn([1,2,3,4,5,6,7,8,9],n=>n,1.5),p(t,{index:.5,exact:!1,bounds:"in"}),t=hn([1,2,3,4,5,6,7,8,9],n=>n,2.5),p(t,{index:1.5,exact:!1,bounds:"in"}),t=hn([1,2,3,4,5,6,7,8,9],n=>n,3.5),p(t,{index:2.5,exact:!1,bounds:"in"}),t=hn([1,2,3,4,5,6,7,8,9],n=>n,9.5),p(t,{index:8.5,exact:!1,bounds:"higher"})}),NP=/(?:^)([^",\n\r]*),?/g,EP=/(?:^)"([^"]+|"")*",?/g,IP=/(?:^)([\n\r]+)/g;function U(e){const t=[];let n,i,o,s,r=[],a=!1,c=!0,l=2;do{if(a=!1,c&&(c=!1,l=2,r=[],t.push(r)),n=e.match(NP),i=e.match(EP),i&&i.length){s=i[0],a=s.endsWith(",");const d=(a?s.slice(1,-2):s.slice(1,-1)).replace(/""/g,'"');r.push(d),e=e.slice(s.length),a||(l-=1)}else if(n.length){s=n[0],a=s.endsWith(",");const d=a?s.slice(0,-1):s;r.push(d),e=e.slice(s.length),a||(l-=1)}o=e.match(IP),!a&&o&&o.length&&(c=!0,l=2,e=e.slice(o[0].length)),e===""&&(l-=1)}while(l>0);return t}const RP=A.delay("csv_to_array",()=>{p(U(""),[[""]]),p(U(","),[["",""]]),p(U("a"),[["a"]]),p(U("a,"),[["a",""]]),p(U(",a"),[["","a"]]),p(U(",a,"),[["","a",""]]),p(U("a,a"),[["a","a"]]),p(U("a,a,"),[["a","a",""]]),p(U(",a,a"),[["","a","a"]]),p(U(",a,a,"),[["","a","a",""]]),p(U(`
`),[[""],[""]]),p(U(`a
a`),[["a"],["a"]]),p(U(`,
,`),[["",""],["",""]]),p(U(`a,
a,`),[["a",""],["a",""]]),p(U(`,a
,a`),[["","a"],["","a"]]),p(U(`,a,
,a,`),[["","a",""],["","a",""]]),p(U('""'),[[""]]),p(U('"",'),[["",""]]),p(U(',""'),[["",""]]),p(U(',"",'),[["","",""]]),p(U('","'),[[","]]),p(U('",",'),[[",",""]]),p(U(',","'),[["",","]]),p(U(',",",'),[["",",",""]]),p(U('"",""'),[["",""]]),p(U('"a"'),[["a"]]),p(U('"a",'),[["a",""]]),p(U(',"a"'),[["","a"]]),p(U(',"a",'),[["","a",""]]),p(U('"a","a"'),[["a","a"]]),p(U('"a","a",'),[["a","a",""]]),p(U(',"a","a"'),[["","a","a"]]),p(U(',"a","a",'),[["","a","a",""]]),p(U('""""'),[['"']]),p(U('"""",'),[['"',""]]),p(U(',""""'),[["",'"']]),p(U(',"""",'),[["",'"',""]]),p(U('"""a"""'),[['"a"']]),p(U('"""a""","""a"""'),[['"a"','"a"']]),p(U('""""""'),[['""']]),p(U('"a""a"'),[['a"a']]),p(U('"a"",""a"'),[['a","a']]),p(U(`""
`),[[""],[""]])}),DP=A.delay("list functions",()=>{A("index_is_in_bounds",()=>{p(At([],0),!1,"empty list, any number"),p(At(["A"],-1),!1,"list with one element, index -1"),p(At(["A"],0),!0,"list with one element, index 0"),p(At(["A"],1),!1,"list with one element, index 1"),p(At(["A","B"],1),!0,"list with two elements, index 1"),p(At(["A","B"],2),!1,"list with two elements, index 2")}),A("swap_elements",()=>{p(bt([],0,0),[],"empty list, any indices, should be noop"),p(bt(["A","B"],-1,0),["A","B"],"invalid first index of -1, should be noop"),p(bt(["A","B"],2,0),["A","B"],"invalid first index of 2, should be noop"),p(bt(["A","B"],0,-1),["A","B"],"invalid second index of -1, should be noop"),p(bt(["A","B"],0,2),["A","B"],"invalid second index of 2, should be noop"),p(bt(["A","B"],0,1),["B","A"],"should swap"),p(bt(["A","B"],1,0),["B","A"],"should swap"),p(bt(["A","B"],1,1),["A","B"],"should handle noop")}),A("insert_element_at_index",()=>{p(yt([],"A",0),["A"],"insertion works at index 0"),p(yt([],"A",-2),["A"],"insertion works at any negative index"),p(yt([],"A",2),["A"],"insertion works at any positive index"),p(yt(["A","B","C"],"D",0),["D","A","B","C"],"insertion works at index 0"),p(yt(["A","B","C"],"D",-2),["D","A","B","C"],"insertion works at any negative index"),p(yt(["A","B","C"],"D",2),["A","B","D","C"],"insertion works at an positive index that is in the list"),p(yt(["A","B","C"],"D",3),["A","B","C","D"],"insertion works at an positive index that is the length of the list"),p(yt(["A","B","C"],"D",4),["A","B","C","D"],"insertion works at any positive index that is > list length")})});function jy(e,t){const n={};return Object.values(e||{}).forEach(i=>{const o=t?i.value.toLowerCase():i.value;n[o]=i}),n}function ti(e,t){if(e===void 0)return;const n=t||{},i=jy(n,!1);return e.map(o=>({...o,entries:o.entries.map(s=>{let{value_id:r,value:a,description:c}=s,l=n[r||""];return l||(r=void 0,l=i[s.value]),l&&(r=l.id,a=l.value,c=l.description),{...s,value_id:r,value:a,description:c}})}))}const OP=A.delay("update_VAPSets_with_possibilities",()=>{var a,c,l,d,u,f,m,h,v,g,b,w,k,y,S,T,$,R,C,O,M,P,L,J;const e="val_prob_id_123",t="val_prob_id_456",n="value abc",i="value def456",o={[e]:{id:e,value:n,description:"description abc",order:0},[t]:{id:t,value:i,description:"description def456",order:1}},s=[{id:"VAPSet123",created_at:new Date,base_id:1,datetime:{},entries:[{...qe(),value_id:e,value:"old abc value",description:"old abc description"},{...qe(),value_id:"defunct_id",value:n,description:"old abc description"},{...qe(),value_id:t,value:n,description:""}]}];let r=ti(void 0,void 0);p(r,void 0,"Undefined initial VAPs returns undefined"),r=ti(void 0,o),p(r,void 0,"Undefined initial VAPs returns undefined"),r=ti([],o),p(r,[],"Empty initial VAPs returns empty"),r=ti(s,void 0),p(r==null?void 0:r.length,s.length,"Undefined value_possibilities returns all VAPs"),r&&(p((c=(a=r[0])==null?void 0:a.entries[0])==null?void 0:c.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),p((d=(l=r[0])==null?void 0:l.entries[1])==null?void 0:d.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids"),p((f=(u=r[0])==null?void 0:u.entries[2])==null?void 0:f.value_id,void 0,"Undefined value_possibilities returns VAPs without value_ids")),console.log("Updates VAPs in VAP Set with value_possibilities ..."),r=ti(s,o),p(Array.isArray(r),!0,"Returns an array"),r&&(p((h=(m=r[0])==null?void 0:m.entries[0])==null?void 0:h.value,(v=o[e])==null?void 0:v.value,"Updates value"),p((b=(g=r[0])==null?void 0:g.entries[0])==null?void 0:b.description,(w=o[e])==null?void 0:w.description,"Updates description"),p((y=(k=r[0])==null?void 0:k.entries[1])==null?void 0:y.value_id,e,"Updates id based on matched value"),p((T=(S=r[0])==null?void 0:S.entries[1])==null?void 0:T.description,($=o[e])==null?void 0:$.description,"Updates description based on matched value/id"),p((C=(R=r[0])==null?void 0:R.entries[2])==null?void 0:C.value_id,t,"Does not update id based on matched value if ID valid"),p((M=(O=r[0])==null?void 0:O.entries[2])==null?void 0:M.value,i,"Updates value"),p((L=(P=r[0])==null?void 0:P.entries[2])==null?void 0:L.description,(J=o[t])==null?void 0:J.description,"Updates description"))}),MP=A.delay("get_wcomponent_VAPs_represent",()=>{const e=ie(1),t=ie(2);let n,i,o,s,r,a;n=void 0,o={},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,"Should return undefined for undefined WComponent"),n=q({base_id:-1,type:"statev2",subtype:void 0}),o={},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,'Should return undefined for WComponent.type of "statev2" and subtype of undefined'),n=q({base_id:-1,type:"statev2",subtype:"boolean"}),o={},s=void 0,r=N.boolean,a=se(n,o,s),p(a,r,'Should return boolean for WComponent.type of "statev2" and subtype of boolean'),n=q({base_id:-1,type:"statev2",subtype:"number"}),o={},s=void 0,r=N.number,a=se(n,o,s),p(a,r,'Should return number for WComponent.type of "statev2" and subtype of number'),n=q({base_id:-1,type:"statev2",subtype:"other"}),o={},s=void 0,r=N.other,a=se(n,o,s),p(a,r,'Should return other for WComponent.type of "statev2" and subtype of other'),A("state_value",()=>{i=q({base_id:-1,type:"statev2",subtype:"number"}),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=N.number,a=se(n,o,s),p(a,r,'Should return number for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of number'),i=q({base_id:-1,type:"statev2",subtype:"boolean"}),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=N.boolean,a=se(n,o,s),p(a,r,'Should return boolean for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of boolean'),i=q({base_id:-1,type:"statev2",subtype:"other"}),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:i.id}),o={[i.id]:i},s=void 0,r=N.other,a=se(n,o,s),p(a,r,'Should return other for WComponent.type of "state_value" targeting a stateV2 wcomponent with subtype of other'),n=q({base_id:-1,type:"state_value",attribute_wcomponent_id:"some unknown uuid"}),o={},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,'Should return undefined for WComponent.type of "state_value" targeting an unknown stateV2 wcomponent'),A("protected from recursion",()=>{n=q({base_id:-1,id:e,type:"state_value",attribute_wcomponent_id:e}),o={[n.id]:n},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,'Should return undefined for WComponent.type of "state_value" targeting itself (accidentally)'),i=q({base_id:-1,id:e,type:"state_value",attribute_wcomponent_id:t}),n=q({base_id:-1,id:t,type:"state_value",attribute_wcomponent_id:e}),o={[i.id]:i,[n.id]:n},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,'Should return undefined for two WComponent.type of "state_value" targeting each other with infinite recursion')})}),A("other types",()=>{n=q({base_id:-1,type:"action"}),o={},s=void 0,r=N.action,a=se(n,o,s),p(a,r,'Should return action for WComponent.type of "action"'),n=q({base_id:-1,type:"process"}),o={},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,'Should return undefined for WComponent.type of "process"'),n=q({base_id:-1,type:"causal_link"}),o={},s=void 0,r=N.undefined,a=se(n,o,s),p(a,r,'Should return undefined for WComponent.type of "causal_link"')})}),qP=A.delay("parse_value",()=>{A("parse_VAP_value",()=>{let e;A('VAPsType "number"',()=>{const t=n=>yl({value:n,id:"",description:"",explanation:"",probability:1,conviction:1},N.number);e=t(""),p(e,null,"Should parse empty string as valid but null"),e=t("   "),p(e,null,"Should parse string of spaces as valid but null"),e=t("123"),p(e,123,"Should parse valid number"),e=t("  123  "),p(e,123,"Should parse valid number with whitespace"),e=t("123abc"),p(Number.isNaN(e),!0,"Should parse number with appended invalid characters as invalid NaN"),e=t("abc123"),p(Number.isNaN(e),!0,"Should parse number with prepended invalid characters as invalid NaN"),e=t("123%"),p(e,1.23,"Should parse number with appended %"),e=t("123 %"),p(e,1.23,"Should parse number with appended whitespace %"),e=t("123%%"),p(Number.isNaN(e),!0,"Should parse number with appended % and further invalid characters as invalid NaN"),e=t("1e-3%"),p(e,1e-5,"Should parse negative exponent number with appended %"),e=t(".3 e 2 %"),p(e,.3,"Should parse fractional number with exponent with appended % and interspersed whitespace"),e=t("3,000.200"),p(e,3000.2,"Should parse numbers with commas as thousands separators"),e=t("3,000.200%"),p(e,30.002,"Should parse numbers with commas as thousands separators and percentage sign")})}),A("is_string_valid_number",()=>{p(Pe(""),!0,"empty string is valid number"),p(Pe("   "),!0,"string of spaces is valid number"),p(Pe("123"),!0,"valid number"),p(Pe("  123  "),!0,"valid number with whitespace"),p(Pe("123abc"),!1,"number with appended invalid characters"),p(Pe("abc123"),!1,"number with prepended invalid characters"),p(Pe("123%"),!0,"number with appended % (valid)"),p(Pe("a90%"),!1,"number with appended % but prepended character (invalid)"),p(Pe("123 %"),!0,"number with appended whitespace % (valid)"),p(Pe("123%%"),!1,"number with appended % and further invalid characters"),p(Pe("1e-3%"),!0,"negative exponent number with appended % (valid)"),p(Pe(".3 e 2 %"),!0,"fractional number with exponent with appended % and interspersed whitespace (valid)"),p(Pe("3,000.200%"),!0,"numbers with commas as thousands separators are allowed"),p(Pe("3,00.2"),!1,"numbers with commas not at every 1000 are not allowed"),p(Pe("3,00"),!1,"numbers with commas not at every 1000 are not allowed")})});function ri(e){const{wcomponent:t,kv_entry:n,sim_ms:i,wc_ids_excluded_by_filters:o}=e;if(!n||n.blocked)return!1;let s="is_selected"in e?e.is_selected:!1;if("selected_wcomponent_ids_set"in e&&(s=e.selected_wcomponent_ids_set.has(t.id)),s)return 1;if(o.has(t.id)||VP(t,e.created_at_ms))return!1;const{certainty:a}=Ol(e)||Dl();if(FP({validity_certain:a,validity_filter:e.validity_filter}))return!1;let l=a;if(gl(t)){const d=zP({event_at:t.event_at,sim_ms:i});d!==void 0&&(l=Math.min(l,d))}return l}function VP(e,t){return Ae(e)>t}function FP(e){let t=!1;const{validity_certain:n,validity_filter:i}=e;return i.show_invalid?t=!0:i.maybe_invalid?t=n>0:i.only_maybe_valid?t=n>.5:i.only_certain_valid?t=n===1:console.error("Unsupported validity_filter: "+JSON.stringify(i)),!t}function zP(e){const{event_at:t,sim_ms:n}=e,i=t[0];if(i)return i.probability*i.conviction}function vn(e){const{from_wc:t,from_wc__kv_entry:n,to_wc:i,to_wc__kv_entry:o}=e,s=ri(e);if(!s)return!1;if(!t||!i)return{display_certainty:1};if(!n||!o)return!1;const r=ri({...e,wcomponent:t,kv_entry:n});return!r||!ri({...e,wcomponent:i,kv_entry:o})?!1:{display_certainty:Math.min(s,r)}}function LP(e){const{target_wc:t,target_wc__kv_entry:n}=e;if(!t||!n)return!1;const i=ri(e);if(!i)return!1;const o=ri({...e,wcomponent:t,kv_entry:n});return o?{display_certainty:Math.min(i,o)}:!1}function Ty(e){if(e.is_highlighted||e.is_selected||e.is_current_item||e.certainty_formatting.render_100_opacity&&!e.focused_mode||e.connected_neighbour_is_highlighted)return 1;if(e.focused_mode)return .1;if(e.is_editing)return 1;const t=e.certainty_formatting.render_certainty_as_easier_opacity;return e.certainty===1?1:t?Mu(e.certainty,.4,.7):Mu(e.certainty,.1,.5)}const BP=A.delay("calc_connection_wcomponent_should_display",()=>{const e=new Date("2024-08-29T11:00:00.000Z"),t=e.getTime(),n=new Date("2024-08-29T11:00:00.000Z").getTime(),i=()=>{let r=q({type:"causal_link",base_id:-1,created_at:e});if(!an(r))throw new Error(`Need a causal_link component for tests but got "${r.type}"`);const a=q({type:"causal_link",base_id:-1,created_at:e}),c=q({type:"statev2",base_id:-1,created_at:e});return{wcomponent:r,kv_entry:{left:0,top:0},validity_filter:{only_certain_valid:!1,only_maybe_valid:!1,maybe_invalid:!1,show_invalid:!0},from_wc:a,to_wc:c,from_wc__kv_entry:{left:0,top:0},to_wc__kv_entry:{left:0,top:0},created_at_ms:t,sim_ms:n,selected_wcomponent_ids_set:new Set,wc_ids_excluded_by_filters:new Set}};let o=i(),s=vn(o);p(s,{display_certainty:1},"should display"),o=i(),o.wcomponent.created_at=new Date(t+1),s=vn(o),p(s,!1,"should not display if created in future"),o=i(),o.wc_ids_excluded_by_filters.add(o.wcomponent.id),s=vn(o),p(s,!1,"should not display if it list of ids excluded by filters"),o=i(),o.from_wc=void 0,o.from_wc__kv_entry=void 0,s=vn(o),p(s,{display_certainty:1},"should display if from_wc not present"),o=i(),o.to_wc=void 0,o.to_wc__kv_entry=void 0,s=vn(o),p(s,{display_certainty:1},"should display if to_wc not present"),o=i(),o.from_wc=void 0,o.from_wc__kv_entry=void 0,o.wc_ids_excluded_by_filters.add(o.wcomponent.id),s=vn(o),p(s,!1,"should not display if from_wc not present and id is in list of ids excluded by filters")}),UP=A.delay("get_wcomponent_state_UI_value",()=>{const e=new Date("2021-05-01 00:00"),t=new Date("2021-05-01 00:01"),n=new Date("2021-05-01 00:02");function i(f,m){const h={};return f.forEach(v=>{m.forEach(g=>{if(v.VAP_set_id!==g.id)return;const b=h[g.id]||[];b.push({base_id:-1,id:"",created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:g.id,target_VAP_id:v.VAP_id}),h[g.id]=b})}),h}function o(f,m,h){const{counterfactuals_data:v=[],datetime:g={}}=h||{},b=m.map((k,y)=>({base_id:-1,id:`vps${y}`,created_at:t,version:1,datetime:g,entries:k}));f={...f,values_and_prediction_sets:b};const w=i(v,b);return hs({wcomponent:f,VAP_set_id_to_counterfactual_v2_map:w,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const s={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]};let r;const a={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},c={...a,id:"VAP100",value:"A100",probability:1,conviction:1},l={...c,id:"VAP80",value:"A80",probability:.8},d={...c,id:"VAP20",value:"A20",probability:.2},u={...c,id:"VAP0",value:"A0",probability:0};A("Basic tests of get_wcomponent_state_UI_value",()=>{r=o(s,[]),p(r,void 0,"No VAP (value and prediction) sets should return undefined"),r=o(s,[[]]),p(r,void 0,"No value defined in a VAP (value and prediction) set should return undefined"),r=o(s,[[{...c,value:"  "}]]),p(r,{values_string:"not defined",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with whitespace string value should be trimmed to nothing and then shown as 'not defined'"),r=o(s,[[c]]),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Single VAP with certainty"),r=o(s,[[d,l]]),p(r,{values_string:"A80, A20",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"Multiple VAPs with both uncertain should result in both being shown, with the most probable first"),r=o(s,[[u,c]]),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain first, should only show the certain one"),r=o(s,[[c,u]]),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"Two VAPs with one 0% certain last, should only show the certain one"),r=o(s,[[d,d,d,d]]),p(r,{values_string:"A20, A20, A20, (1 more)",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},'Shows "(1 more)" when there are more than 3 values')}),A("number subtype",()=>{const f={...s,subtype:"number"},m={...a,id:"VAP1",value:"33",probability:1,conviction:1};r=o(f,[[m]]),p(r,{values_string:"33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number value string");const h={...a,id:"VAP1",value:"33abc",probability:1,conviction:1};r=o(f,[[h]]),p(r,{values_string:"NaN",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A number with invalid characters in value string");const v={...a,id:"VAP1",value:"33%",probability:1,conviction:1};r=o(f,[[v]]),p(r,{values_string:"0.33",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"A valid number percentage")}),A("boolean subtype",()=>{const f={...s,subtype:"boolean"};r=o(f,[[c]]),p(r,{values_string:"True",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"100% confident boolean should render as True"),r=o(f,[[{...c,probability:.51}]]),p(r,{values_string:"True",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},">50% confident boolean should render as True"),r=o(f,[[{...c,probability:.5}]]),p(r,{values_string:"False",counterfactual_applied:!1,uncertain:!0,derived__using_values_from_wcomponent_ids:void 0},"<=50% confident boolean should render as False"),r=o(f,[[u]]),p(r,{values_string:"False",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"0% confident boolean should render as False")}),A("StateValue replacing VAPSets",()=>{const f={...s,_derived__using_value_from_wcomponent_id:"abc123"};r=o(f,[[c]]),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),A("datetime",()=>{r=o(s,[[c]],{datetime:{min:n}}),p(r,void 0,"When datetime.min is in the future, no value should be shown"),r=o(s,[[c]],{datetime:{min:t}}),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.min is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{max:t}}),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{max:e}}),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.max is in the past, a value should still be shown because the 'max' represents the lastest time this change to state could have occured, and the state represents the most current value"),r=o(s,[[c]],{datetime:{value:n}}),p(r,void 0,"When datetime.value is the future, no value should be shown"),r=o(s,[[c]],{datetime:{value:t}}),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the present sim datetime, a value should be shown"),r=o(s,[[c]],{datetime:{value:e}}),p(r,{values_string:"A100",counterfactual_applied:!1,uncertain:!1,derived__using_values_from_wcomponent_ids:void 0},"When datetime.value is the past, a value should still be shown, for the same reason as when datetime.max is in the past")})}),WP=A.delay("get_wcomponent_state_value_and_probabilities",()=>{const e=new Date("2021-05-01 00:00"),t=new Date("2021-05-01 00:01"),n=new Date("2021-05-01 00:02");function i(w,k){if(!w||!k)return;const y={};let S=0;return w.forEach(T=>{k.forEach($=>{if(T.VAP_set_id!==$.id)return;const R=y[$.id]||[];R.push({base_id:-1,id:`cf${S++}`,created_at:t,type:"counterfactualv2",title:"",description:"",target_wcomponent_id:"",target_VAP_set_id:$.id,target_VAP_id:T.VAP_id}),y[$.id]=R})}),y}function o(w){return w.map((k,y)=>({base_id:-1,id:`vps${y}`,created_at:t,version:1,datetime:{},entries:[],...k}))}function s(w,k,y){const{apply_counterfactuals_v2:S,datetime:T={}}=y||{};if(k){const R=k.map(O=>({datetime:T,entries:O})),C=o(R);w={...w,values_and_prediction_sets:C}}const $=i(S,w.values_and_prediction_sets);return Sn({wcomponent:w,VAP_set_id_to_counterfactual_v2_map:$,created_at_ms:t.getTime(),sim_ms:t.getTime()})}const r={base_id:-1,id:"",created_at:t,type:"statev2",subtype:"other",title:"",description:"",values_and_prediction_sets:[]},a={...r,subtype:"boolean"};let c;const l={id:"VAP0",value:"",probability:1,conviction:1,description:"",explanation:""},d={...l,id:"VAP100",value:"A100",probability:1,conviction:1},u={...d,id:"VAP80",value:"A80",probability:.8},f={...d,id:"VAP20",value:"A20",probability:.2},m={...d,id:"VAP0",value:"A0",probability:0},h={...d,id:"VAP100c50",value:"A100c50",conviction:.8},v={...d,id:"VAP100c0",value:"A100c0",conviction:0},g=[h],b=[v];A("Basic functionality",()=>{c=s(r,[]),p(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"No VAP (value and prediction) defined"),c=s(r,[[]]),p(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"No value defined in VAP (value and prediction)"),c=s(r,[[d]]),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Single with certainty"),c=s(r,[[f,u]]),p(c,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:.8,conviction:1,probability:.8,value_id:void 0},{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with both uncertain"),c=s(r,[[d,f]]),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple with one certain, one uncertain, should only show certain");let w=o([{datetime:{value:e},id:"vap_set_0",entries:[{...d,value:"A100a"}]},{datetime:{value:t},id:"vap_set_1",entries:[{...d,value:"A100b"}]},{datetime:{value:n},id:"vap_set_2",entries:[{...d,value:"A100c"}]}]),k={...r,values_and_prediction_sets:w};c=Sn({wcomponent:k,VAP_set_id_to_counterfactual_v2_map:void 0,created_at_ms:t.getTime(),sim_ms:t.getTime()}),p(c,{most_probable_VAP_set_values:[{original_value:"A100b",parsed_value:"A100b",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Multiple VAP sets, each with one single VAP, should pick current VAP set"),c=s(r,[[m]]),p(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance: Should return no value when no chance")}),A("should use first VAP set when both VAP sets conflict at same datetime",()=>{c=s(r,[[d],[f]]),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"certain first and uncertain last"),c=s(r,[[f],[d]]),p(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"uncertain first and certain last")}),A("handling boolean subtype",()=>{c=s(a,[[m]]),p(c,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:!1,certainty:0,conviction:1,probability:0,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"no chance boolean: Should return a value with probability of 0 when no chance of a boolean value"),c=s(a,[[d]]),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:!0,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should handle boolean, probability of 1, by returning true"),A('uncertainty for "boolean" subtype',()=>{c=s(a,[[f]]),p(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:!1,certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),c=s(a,[g]),p(c,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:!0,certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),c=s(a,[b]),p(c,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:!0,certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")})}),A('uncertainty for "other" subtype',()=>{c=s(r,[[f]]),p(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:.2,conviction:1,probability:.2,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when probability is < 1"),c=s(r,[g]),p(c,{most_probable_VAP_set_values:[{original_value:"A100c50",parsed_value:"A100c50",certainty:.8,conviction:.8,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is < 1"),c=s(r,[b]),p(c,{most_probable_VAP_set_values:[{original_value:"A100c0",parsed_value:"A100c0",certainty:0,conviction:0,probability:1,value_id:void 0}],any_uncertainty:!0,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should have any_uncertainty true when conviction is 0")}),A("counterfactuals",()=>{c=s(r,[[d]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:d.id}]}),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"No op counterfactual is applied to something already with certainty of 1"),c=s(r,[[u]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:u.id}]}),p(c,{most_probable_VAP_set_values:[{original_value:"A80",parsed_value:"A80",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP that had certainty of < 1"),c=s(r,[[u,f]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:f.id}]}),p(c,{most_probable_VAP_set_values:[{original_value:"A20",parsed_value:"A20",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactual applied to VAP set with two VAPs that had certainty of < 1"),c=s(r,[[d,m]],{apply_counterfactuals_v2:[{VAP_set_id:"vps0",VAP_id:m.id}]}),p(c,{most_probable_VAP_set_values:[{original_value:"A0",parsed_value:"A0",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["cf0"]},"Counterfactuals to force one option possibility over another that was certain"),c=s(r,[[d,m]]),p.skip(c,{most_probable_VAP_set_values:[{certainty:1,conviction:1,original_value:"A100",parsed_value:"A100",probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!0,derived__using_value_from_wcomponent_ids:["123"]},"Skipping because counterfactuals version 2 only works to force things to be true, not to be false.  For forcing something to be true, then you can use a StateValue component instead.")}),A("StateValue replacing VAPSets",()=>{const w={...r,_derived__using_value_from_wcomponent_id:"abc123"};c=s(w,[[d]]),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:["abc123"]},"Returns the id of the (state value) component whose VAP sets are present in this component")}),A('Parsing "number" subtype',()=>{var S;const w={...r,subtype:"number"},k={...l,id:"VAP1",value:"33",probability:1,conviction:1},y={...l,id:"VAP1",value:"44abc",probability:1,conviction:1};c=s(w,[[k]]),p(c,{most_probable_VAP_set_values:[{original_value:"33",parsed_value:33,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Correctly parses valid number"),c=s(w,[[y]]),p(c,{most_probable_VAP_set_values:[{original_value:"44abc",parsed_value:Number.NaN,certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"Errors when parsing number appended with invalid characters"),p(Number.isNaN((S=c.most_probable_VAP_set_values[0])==null?void 0:S.parsed_value),!0,"Error is Number.NaN")}),A("values before, at, after a datetime.min, datetime.value, datetime.max",()=>{A("in the future",()=>{c=s(r,[[d]],{datetime:{min:n}}),p(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.min is in future"),c=s(r,[[d]],{datetime:{value:n}}),p(c,{most_probable_VAP_set_values:[],any_uncertainty:!1,counterfactual_applied:void 0,derived__using_value_from_wcomponent_ids:void 0},"should not find any values when datetime.value is in future"),c=s(r,[[d]],{datetime:{max:n}}),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")}),c=s(r,[[d]],{datetime:{min:t}}),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.min is at the same time (or earlier)"),c=s(r,[[d]],{datetime:{value:t}}),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.value is at the same time (or earlier)"),c=s(r,[[d]],{datetime:{max:t}}),p(c,{most_probable_VAP_set_values:[{original_value:"A100",parsed_value:"A100",certainty:1,conviction:1,probability:1,value_id:void 0}],any_uncertainty:!1,counterfactual_applied:!1,derived__using_value_from_wcomponent_ids:void 0},"should find the value when datetime.max is at the same time (or earlier)")})});var md={},HP=Q;Object.defineProperty(md,"__esModule",{value:!0});var Ns=md.default=void 0,GP=HP(Z()),KP=ee(),YP=(0,GP.default)((0,KP.jsx)("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");Ns=md.default=YP;function $i(e){const{warning:t,label:n="",always_display:i=!1}=e;return _(re,{noWrap:!0,variant:"caption",title:t,"aria-label":t,style:{display:t||i?"inline":"none"},children:[_(Ns,{}),_("span",{style:{position:"relative",top:-7},children:n})]})}function Py(e,t={display:"flex"}){const n={...t,color:"lightgrey"};let i="";return e!=null&&e.error&&(i=`Error: ${e.error}`,n.color="black"),e!=null&&e.warning&&(e.error&&(i+=`
----
`),i+=`Warning: ${e.warning}`),{error_or_warning_message:i,css:n}}function Ny(e){const{error_or_warning_message:t,css:n}=e;return _("div",{style:{...n,maxHeight:t.length?100:0,maxWidth:t.length?100:0,transition:"max-height 1s ease, max-width 1s ease, color 1s ease"},children:_($i,{warning:t,always_display:!0})})}function gn(){return gn=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},gn.apply(this,arguments)}const JP=["children","options"],Vh=["allowFullScreen","allowTransparency","autoComplete","autoFocus","autoPlay","cellPadding","cellSpacing","charSet","className","classId","colSpan","contentEditable","contextMenu","crossOrigin","encType","formAction","formEncType","formMethod","formNoValidate","formTarget","frameBorder","hrefLang","inputMode","keyParams","keyType","marginHeight","marginWidth","maxLength","mediaGroup","minLength","noValidate","radioGroup","readOnly","rowSpan","spellCheck","srcDoc","srcLang","srcSet","tabIndex","useMap"].reduce((e,t)=>(e[t.toLowerCase()]=t,e),{for:"htmlFor"}),Fh={amp:"&",apos:"'",gt:">",lt:"<",nbsp:" ",quot:"“"},XP=["style","script"],ZP=/([-A-Z0-9_:]+)(?:\s*=\s*(?:(?:"((?:\\.|[^"])*)")|(?:'((?:\\.|[^'])*)')|(?:\{((?:\\.|{[^}]*?}|[^}])*)\})))?/gi,QP=/mailto:/i,eN=/\n{2,}$/,Ey=/^( *>[^\n]+(\n[^\n]+)*\n*)+\n{2,}/,tN=/^ *> ?/gm,nN=/^ {2,}\n/,iN=/^(?:( *[-*_])){3,} *(?:\n *)+\n/,Iy=/^\s*(`{3,}|~{3,}) *(\S+)?([^\n]*?)?\n([\s\S]+?)\s*\1 *(?:\n *)*\n?/,Ry=/^(?: {4}[^\n]+\n*)+(?:\n *)+\n?/,oN=/^(`+)\s*([\s\S]*?[^`])\s*\1(?!`)/,sN=/^(?:\n *)*\n/,rN=/\r\n?/g,_N=/^\[\^([^\]]+)](:.*)\n/,aN=/^\[\^([^\]]+)]/,cN=/\f/g,lN=/^\s*?\[(x|\s)\]/,Dy=/^ *(#{1,6}) *([^\n]+?)(?: +#*)?(?:\n *)*(?:\n|$)/,Oy=/^([^\n]+)\n *(=|-){3,} *(?:\n *)+\n/,il=/^ *(?!<[a-z][^ >/]* ?\/>)<([a-z][^ >/]*) ?([^>]*)\/{0}>\n?(\s*(?:<\1[^>]*?>[\s\S]*?<\/\1>|(?!<\1)[\s\S])*?)<\/\1>\n*/i,dN=/&([a-zA-Z]+);/g,My=/^<!--[\s\S]*?(?:-->)/,uN=/^(data|aria|x)-[a-z_][a-z\d_.-]*$/,ol=/^ *<([a-z][a-z0-9:]*)(?:\s+((?:<.*?>|[^>])*))?\/?>(?!<\/\1>)(\s*\n)?/i,pN=/^\{.*\}$/,mN=/^(https?:\/\/[^\s<]+[^<.,:;"')\]\s])/,fN=/^<([^ >]+@[^ >]+)>/,hN=/^<([^ >]+:\/[^ >]+)>/,vN=/-([a-z])?/gi,qy=/^(.*\|?.*)\n *(\|? *[-:]+ *\|[-| :]*)\n((?:.*\|.*\n)*)\n?/,gN=/^\[([^\]]*)\]:\s+<?([^\s>]+)>?\s*("([^"]*)")?/,wN=/^!\[([^\]]*)\] ?\[([^\]]*)\]/,bN=/^\[([^\]]*)\] ?\[([^\]]*)\]/,yN=/(\[|\])/g,kN=/(\n|^[-*]\s|^#|^ {2,}|^-{2,}|^>\s)/,xN=/\t/g,AN=/^ *\| */,SN=/(^ *\||\| *$)/g,CN=/ *$/,$N=/^ *:-+: *$/,jN=/^ *:-+ *$/,TN=/^ *-+: *$/,PN=/^([*_])\1((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1\1(?!\1)/,NN=/^([*_])((?:\[.*?\][([].*?[)\]]|<.*?>(?:.*?<.*?>)?|`.*?`|~+.*?~+|.)*?)\1(?!\1|\w)/,EN=/^==((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)==/,IN=/^~~((?:\[.*?\]|<.*?>(?:.*?<.*?>)?|`.*?`|.)*?)~~/,RN=/^\\([^0-9A-Za-z\s])/,DN=/^[\s\S]+?(?=[^0-9A-Z\s\u00c0-\uffff&;.()'"]|\d+\.|\n\n| {2,}\n|\w+:\S|$)/i,ON=/^\n+/,MN=/^([ \t]*)/,qN=/\\([^\\])/g,zh=/ *\n+$/,VN=/(?:^|\n)( *)$/,fd="(?:\\d+\\.)",hd="(?:[*+-])";function Vy(e){return"( *)("+(e===1?fd:hd)+") +"}const Fy=Vy(1),zy=Vy(2);function Ly(e){return new RegExp("^"+(e===1?Fy:zy))}const FN=Ly(1),zN=Ly(2);function By(e){return new RegExp("^"+(e===1?Fy:zy)+"[^\\n]*(?:\\n(?!\\1"+(e===1?fd:hd)+" )[^\\n]*)*(\\n|$)","gm")}const Uy=By(1),Wy=By(2);function Hy(e){const t=e===1?fd:hd;return new RegExp("^( *)("+t+") [\\s\\S]+?(?:\\n{2,}(?! )(?!\\1"+t+" (?!"+t+" ))\\n*|\\s*\\n*$)")}const Gy=Hy(1),Ky=Hy(2);function Lh(e,t){const n=t===1,i=n?Gy:Ky,o=n?Uy:Wy,s=n?FN:zN;return{t(r,a,c){const l=VN.exec(c);return l&&(a.o||!a._&&!a.u)?i.exec(r=l[1]+r):null},i:X.HIGH,l(r,a,c){const l=n?+r[2]:void 0,d=r[0].replace(eN,`
`).match(o);let u=!1;return{p:d.map(function(f,m){const h=s.exec(f)[0].length,v=new RegExp("^ {1,"+h+"}","gm"),g=f.replace(v,"").replace(s,""),b=m===d.length-1,w=g.indexOf(`

`)!==-1||b&&u;u=w;const k=c._,y=c.o;let S;c.o=!0,w?(c._=!1,S=g.replace(zh,`

`)):(c._=!0,S=g.replace(zh,""));const T=a(S,c);return c._=k,c.o=y,T}),m:n,g:l}},h:(r,a,c)=>e(r.m?"ol":"ul",{key:c.k,start:r.g},r.p.map(function(l,d){return e("li",{key:d},a(l,c))}))}}const LN=/^\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,BN=/^!\[([^\]]*)]\( *((?:\([^)]*\)|[^() ])*) *"?([^)"]*)?"?\)/,Yy=[Ey,Iy,Ry,Dy,Oy,My,qy,Uy,Gy,Wy,Ky],UN=[...Yy,/^[^\n]+(?:  \n|\n{2,})/,il,ol];function WN(e){return e.replace(/[ÀÁÂÃÄÅàáâãäåæÆ]/g,"a").replace(/[çÇ]/g,"c").replace(/[ðÐ]/g,"d").replace(/[ÈÉÊËéèêë]/g,"e").replace(/[ÏïÎîÍíÌì]/g,"i").replace(/[Ññ]/g,"n").replace(/[øØœŒÕõÔôÓóÒò]/g,"o").replace(/[ÜüÛûÚúÙù]/g,"u").replace(/[ŸÿÝý]/g,"y").replace(/[^a-z0-9- ]/gi,"").replace(/ /gi,"-").toLowerCase()}function HN(e){return TN.test(e)?"right":$N.test(e)?"center":jN.test(e)?"left":null}function Bh(e,t,n){const i=n.v;n.v=!0;const o=t(e.trim(),n);n.v=i;let s=[[]];return o.forEach(function(r,a){r.type==="tableSeparator"?a!==0&&a!==o.length-1&&s.push([]):(r.type!=="text"||o[a+1]!=null&&o[a+1].type!=="tableSeparator"||(r.$=r.$.replace(CN,"")),s[s.length-1].push(r))}),s}function GN(e,t,n){n._=!0;const i=Bh(e[1],t,n),o=e[2].replace(SN,"").split("|").map(HN),s=function(r,a,c){return r.trim().split(`
`).map(function(l){return Bh(l,a,c)})}(e[3],t,n);return n._=!1,{S:o,A:s,L:i,type:"table"}}function Uh(e,t){return e.S[t]==null?{}:{textAlign:e.S[t]}}function Xt(e){return function(t,n){return n._?e.exec(t):null}}function Zt(e){return function(t,n){return n._||n.u?e.exec(t):null}}function It(e){return function(t,n){return n._||n.u?null:e.exec(t)}}function Di(e){return function(t){return e.exec(t)}}function KN(e,t,n){if(t._||t.u||n&&!n.endsWith(`
`))return null;let i="";e.split(`
`).every(s=>!Yy.some(r=>r.test(s))&&(i+=s+`
`,s.trim()));const o=i.trimEnd();return o==""?null:[i,o]}function Yn(e){try{if(decodeURIComponent(e).replace(/[^A-Za-z0-9/:]/g,"").match(/^\s*(javascript|vbscript|data(?!:image)):/i))return null}catch{return null}return e}function Wh(e){return e.replace(qN,"$1")}function Uo(e,t,n){const i=n._||!1,o=n.u||!1;n._=!0,n.u=!0;const s=e(t,n);return n._=i,n.u=o,s}function YN(e,t,n){const i=n._||!1,o=n.u||!1;n._=!1,n.u=!0;const s=e(t,n);return n._=i,n.u=o,s}function JN(e,t,n){return n._=!1,e(t+`

`,n)}const $c=(e,t,n)=>({$:Uo(t,e[1],n)});function jc(){return{}}function Tc(){return null}function XN(...e){return e.filter(Boolean).join(" ")}function Pc(e,t,n){let i=e;const o=t.split(".");for(;o.length&&(i=i[o[0]],i!==void 0);)o.shift();return i||n}var X;function ZN(e,t={}){t.overrides=t.overrides||{},t.slugify=t.slugify||WN,t.namedCodesToUnicode=t.namedCodesToUnicode?gn({},Fh,t.namedCodesToUnicode):Fh;const n=t.createElement||yu;function i(m,h,...v){const g=Pc(t.overrides,`${m}.props`,{});return n(function(b,w){const k=Pc(w,b);return k?typeof k=="function"||typeof k=="object"&&"render"in k?k:Pc(w,`${b}.component`,b):b}(m,t.overrides),gn({},h,g,{className:XN(h==null?void 0:h.className,g.className)||void 0}),...v)}function o(m){let h=!1;t.forceInline?h=!0:t.forceBlock||(h=kN.test(m)===!1);const v=d(l(h?m:`${m.trimEnd().replace(ON,"")}

`,{_:h}));for(;typeof v[v.length-1]=="string"&&!v[v.length-1].trim();)v.pop();if(t.wrapper===null)return v;const g=t.wrapper||(h?"span":"div");let b;if(v.length>1||t.forceWrapper)b=v;else{if(v.length===1)return b=v[0],typeof b=="string"?i("span",{key:"outer"},b):b;b=null}return yu(g,{key:"outer"},b)}function s(m){const h=m.match(ZP);return h?h.reduce(function(v,g,b){const w=g.indexOf("=");if(w!==-1){const k=function($){return $.indexOf("-")!==-1&&$.match(uN)===null&&($=$.replace(vN,function(R,C){return C.toUpperCase()})),$}(g.slice(0,w)).trim(),y=function($){const R=$[0];return(R==='"'||R==="'")&&$.length>=2&&$[$.length-1]===R?$.slice(1,-1):$}(g.slice(w+1).trim()),S=Vh[k]||k,T=v[S]=function($,R){return $==="style"?R.split(/;\s?/).reduce(function(C,O){const M=O.slice(0,O.indexOf(":"));return C[M.replace(/(-[a-z])/g,P=>P[1].toUpperCase())]=O.slice(M.length+1).trim(),C},{}):$==="href"?Yn(R):(R.match(pN)&&(R=R.slice(1,R.length-1)),R==="true"||R!=="false"&&R)}(k,y);typeof T=="string"&&(il.test(T)||ol.test(T))&&(v[S]=Pv(o(T.trim()),{key:b}))}else g!=="style"&&(v[Vh[g]||g]=!0);return v},{}):null}const r=[],a={},c={blockQuote:{t:It(Ey),i:X.HIGH,l:(m,h,v)=>({$:h(m[0].replace(tN,""),v)}),h:(m,h,v)=>i("blockquote",{key:v.k},h(m.$,v))},breakLine:{t:Di(nN),i:X.HIGH,l:jc,h:(m,h,v)=>i("br",{key:v.k})},breakThematic:{t:It(iN),i:X.HIGH,l:jc,h:(m,h,v)=>i("hr",{key:v.k})},codeBlock:{t:It(Ry),i:X.MAX,l:m=>({$:m[0].replace(/^ {4}/gm,"").replace(/\n+$/,""),M:void 0}),h:(m,h,v)=>i("pre",{key:v.k},i("code",gn({},m.I,{className:m.M?`lang-${m.M}`:""}),m.$))},codeFenced:{t:It(Iy),i:X.MAX,l:m=>({I:s(m[3]||""),$:m[4],M:m[2]||void 0,type:"codeBlock"})},codeInline:{t:Zt(oN),i:X.LOW,l:m=>({$:m[2]}),h:(m,h,v)=>i("code",{key:v.k},m.$)},footnote:{t:It(_N),i:X.MAX,l:m=>(r.push({O:m[2],B:m[1]}),{}),h:Tc},footnoteReference:{t:Xt(aN),i:X.HIGH,l:m=>({$:m[1],R:`#${t.slugify(m[1])}`}),h:(m,h,v)=>i("a",{key:v.k,href:Yn(m.R)},i("sup",{key:v.k},m.$))},gfmTask:{t:Xt(lN),i:X.HIGH,l:m=>({T:m[1].toLowerCase()==="x"}),h:(m,h,v)=>i("input",{checked:m.T,key:v.k,readOnly:!0,type:"checkbox"})},heading:{t:It(Dy),i:X.HIGH,l:(m,h,v)=>({$:Uo(h,m[2],v),j:t.slugify(m[2]),C:m[1].length}),h:(m,h,v)=>i(`h${m.C}`,{id:m.j,key:v.k},h(m.$,v))},headingSetext:{t:It(Oy),i:X.MAX,l:(m,h,v)=>({$:Uo(h,m[1],v),C:m[2]==="="?1:2,type:"heading"})},htmlComment:{t:Di(My),i:X.HIGH,l:()=>({}),h:Tc},image:{t:Zt(BN),i:X.HIGH,l:m=>({D:m[1],R:Wh(m[2]),N:m[3]}),h:(m,h,v)=>i("img",{key:v.k,alt:m.D||void 0,title:m.N||void 0,src:Yn(m.R)})},link:{t:Xt(LN),i:X.LOW,l:(m,h,v)=>({$:YN(h,m[1],v),R:Wh(m[2]),N:m[3]}),h:(m,h,v)=>i("a",{key:v.k,href:Yn(m.R),title:m.N},h(m.$,v))},linkAngleBraceStyleDetector:{t:Xt(hN),i:X.MAX,l:m=>({$:[{$:m[1],type:"text"}],R:m[1],type:"link"})},linkBareUrlDetector:{t:(m,h)=>h.Z?null:Xt(mN)(m,h),i:X.MAX,l:m=>({$:[{$:m[1],type:"text"}],R:m[1],N:void 0,type:"link"})},linkMailtoDetector:{t:Xt(fN),i:X.MAX,l(m){let h=m[1],v=m[1];return QP.test(v)||(v="mailto:"+v),{$:[{$:h.replace("mailto:",""),type:"text"}],R:v,type:"link"}}},orderedList:Lh(i,1),unorderedList:Lh(i,2),newlineCoalescer:{t:It(sN),i:X.LOW,l:jc,h:()=>`
`},paragraph:{t:KN,i:X.LOW,l:$c,h:(m,h,v)=>i("p",{key:v.k},h(m.$,v))},ref:{t:Xt(gN),i:X.MAX,l:m=>(a[m[1]]={R:m[2],N:m[4]},{}),h:Tc},refImage:{t:Zt(wN),i:X.MAX,l:m=>({D:m[1]||void 0,F:m[2]}),h:(m,h,v)=>i("img",{key:v.k,alt:m.D,src:Yn(a[m.F].R),title:a[m.F].N})},refLink:{t:Xt(bN),i:X.MAX,l:(m,h,v)=>({$:h(m[1],v),P:h(m[0].replace(yN,"\\$1"),v),F:m[2]}),h:(m,h,v)=>a[m.F]?i("a",{key:v.k,href:Yn(a[m.F].R),title:a[m.F].N},h(m.$,v)):i("span",{key:v.k},h(m.P,v))},table:{t:It(qy),i:X.HIGH,l:GN,h:(m,h,v)=>i("table",{key:v.k},i("thead",null,i("tr",null,m.L.map(function(g,b){return i("th",{key:b,style:Uh(m,b)},h(g,v))}))),i("tbody",null,m.A.map(function(g,b){return i("tr",{key:b},g.map(function(w,k){return i("td",{key:k,style:Uh(m,k)},h(w,v))}))})))},tableSeparator:{t:function(m,h){return h.v?AN.exec(m):null},i:X.HIGH,l:function(){return{type:"tableSeparator"}},h:()=>" | "},text:{t:Di(DN),i:X.MIN,l:m=>({$:m[0].replace(dN,(h,v)=>t.namedCodesToUnicode[v]?t.namedCodesToUnicode[v]:h)}),h:m=>m.$},textBolded:{t:Zt(PN),i:X.MED,l:(m,h,v)=>({$:h(m[2],v)}),h:(m,h,v)=>i("strong",{key:v.k},h(m.$,v))},textEmphasized:{t:Zt(NN),i:X.LOW,l:(m,h,v)=>({$:h(m[2],v)}),h:(m,h,v)=>i("em",{key:v.k},h(m.$,v))},textEscaped:{t:Zt(RN),i:X.HIGH,l:m=>({$:m[1],type:"text"})},textMarked:{t:Zt(EN),i:X.LOW,l:$c,h:(m,h,v)=>i("mark",{key:v.k},h(m.$,v))},textStrikethroughed:{t:Zt(IN),i:X.LOW,l:$c,h:(m,h,v)=>i("del",{key:v.k},h(m.$,v))}};t.disableParsingRawHTML!==!0&&(c.htmlBlock={t:Di(il),i:X.HIGH,l(m,h,v){const[,g]=m[3].match(MN),b=new RegExp(`^${g}`,"gm"),w=m[3].replace(b,""),k=(y=w,UN.some(R=>R.test(y))?JN:Uo);var y;const S=m[1].toLowerCase(),T=XP.indexOf(S)!==-1;v.Z=v.Z||S==="a";const $=T?m[3]:k(h,w,v);return v.Z=!1,{I:s(m[2]),$,G:T,H:T?S:m[1]}},h:(m,h,v)=>i(m.H,gn({key:v.k},m.I),m.G?m.$:h(m.$,v))},c.htmlSelfClosing={t:Di(ol),i:X.HIGH,l:m=>({I:s(m[2]||""),H:m[1]}),h:(m,h,v)=>i(m.H,gn({},m.I,{key:v.k}))});const l=function(m){let h=Object.keys(m);function v(g,b){let w=[],k="";for(;g;){let y=0;for(;y<h.length;){const S=h[y],T=m[S],$=T.t(g,b,k);if($){const R=$[0];g=g.substring(R.length);const C=T.l($,v,b);C.type==null&&(C.type=S),w.push(C),k=R;break}y++}}return w}return h.sort(function(g,b){let w=m[g].i,k=m[b].i;return w!==k?w-k:g<b?-1:1}),function(g,b){return v(function(w){return w.replace(rN,`
`).replace(cN,"").replace(xN,"    ")}(g),b)}}(c),d=(u=function(m){return function(h,v,g){return m[h.type].h(h,v,g)}}(c),function m(h,v={}){if(Array.isArray(h)){const g=v.k,b=[];let w=!1;for(let k=0;k<h.length;k++){v.k=k;const y=m(h[k],v),S=typeof y=="string";S&&w?b[b.length-1]+=y:y!==null&&b.push(y),w=S}return v.k=g,b}return u(h,m,v)});var u;const f=o(e);return r.length?i("div",null,f,i("footer",{key:"footer"},r.map(function(m){return i("div",{id:t.slugify(m.B),key:m.B},m.B,d(l(m.O,{_:!0})))}))):f}(function(e){e[e.MAX=0]="MAX",e[e.HIGH=1]="HIGH",e[e.MED=2]="MED",e[e.LOW=3]="LOW",e[e.MIN=4]="MIN"})(X||(X={}));const ji=e=>{let{children:t,options:n}=e,i=function(o,s){if(o==null)return{};var r,a,c={},l=Object.keys(o);for(a=0;a<l.length;a++)s.indexOf(r=l[a])>=0||(c[r]=o[r]);return c}(e,JP);return Pv(ZN(t,n),i)};function at(e){var t;return(t=e.derived.current_composed_knowledge_view)==null?void 0:t.wc_id_to_active_counterfactuals_v2_map}function vo(e,t){var i;if(!t)return;const n=at(e);return n&&((i=n[t])==null?void 0:i.VAP_sets)}function Jy(e,t){const{overlapping_wc_ids:n={}}=e.derived.current_composed_knowledge_view||{};return n[t]}function QN(e){return _("a",{href:e.href,onClick:t=>t.stopImmediatePropagation(),onPointerDown:t=>t.stopImmediatePropagation(),children:e.children})}const eE=e=>({rich_text:e.display_options.consumption_formatting,composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:at(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),tE=j(eE);function nE(e){const{text:t,rich_text:n,composed_wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,placeholder:r="...",created_at_ms:a,sim_ms:c}=e,l=n?fe.rich:fe.raw,d=ni({text:t,text_type:l,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:a,sim_ms:c});return _(ji,{options:Es,children:d&&en(d)||r})}const vd=tE(nE),Es={overrides:{a:QN,script:e=>e.children,auto:e=>"",iframe:e=>{const{src:t}=e;return new URL(t).hostname==="www.youtube.com"?_("iframe",{...e}):null},tweet:e=>{const t=`https://platform.twitter.com/embed/Tweet.html?dnt=false&frame=false&hideCard=false&hideThread=false&id=${e.id}&lang=en-gb&theme=light&widgetsVersion=0a8eea3%3A1643743420422&width=400px"`;return _("iframe",{src:t,scrolling:"no",frameBorder:0,allowTransparency:!0,allowFullScreen:!0,style:{width:401,height:624}})},img:e=>{var t;return(t=e.style)==null||delete t.position,_("img",{src:e.src,style:e.style,alt:e.alt})}}};function Xy(e){const{judgement_wcomponent:t,target_wcomponent:n,VAP_set_id_to_counterfactual_v2_map:i,created_at_ms:o,sim_ms:s}=e;if(t.judgement_manual!==void 0)return t.judgement_manual;if(!n)return;const{most_probable_VAP_set_values:r}=Sn({wcomponent:n,VAP_set_id_to_counterfactual_v2_map:i,created_at_ms:o,sim_ms:s});if(r.length!==1)return;const c=r[0].parsed_value,d=se(n,{});return Zy({judgement_wcomponent:t,target_VAPs_represent:d,value:c})}function Zy(e){const{judgement_wcomponent:t,target_VAPs_represent:n,value:i}=e,{judgement_operator:o,judgement_comparator_value:s,judgement_manual:r}=t;if(r!==void 0)return r;const a=n===N.number?parseFloat(s||""):n===N.boolean?s==="True"||(s==="False"?!1:void 0):s;let c;return i===null||a===void 0?c=void 0:o==="=="?c=i===a:o==="!="?c=i!==a:o==="<"?c=i<a:o==="<="?c=i<=a:o===">"?c=i>a:o===">="&&(c=i>=a),c}var gd={},iE=Q;Object.defineProperty(gd,"__esModule",{value:!0});var Qy=gd.default=void 0,oE=iE(Z()),sE=ee(),rE=(0,oE.default)((0,sE.jsx)("path",{d:"m16 18 2.29-2.29-4.88-4.88-4 4L2 7.41 3.41 6l6 6 4-4 6.3 6.29L22 12v6z"}),"TrendingDown");Qy=gd.default=rE;var wd={},_E=Q;Object.defineProperty(wd,"__esModule",{value:!0});var e0=wd.default=void 0,aE=_E(Z()),cE=ee(),lE=(0,aE.default)((0,cE.jsx)("path",{d:"m22 12-4-4v3H3v2h15v3z"}),"TrendingFlat");e0=wd.default=lE;var bd={},dE=Q;Object.defineProperty(bd,"__esModule",{value:!0});var t0=bd.default=void 0,uE=dE(Z()),pE=ee(),mE=(0,uE.default)((0,pE.jsx)("path",{d:"m16 6 2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"}),"TrendingUp");t0=bd.default=mE;function Et(e){var n,i;let{className:t=""}=e;return t="MuiSvgIcon-root "+t,e.fontSize==="small"&&(t+=" MuiSvgIcon-fontSizeSmall "),_("span",{title:e.title,style:{width:(n=e.style)==null?void 0:n.width,height:(i=e.style)==null?void 0:i.height},children:_("svg",{className:t,viewBox:"0 0 24 24",style:e.style,children:[_("path",{d:e.d}),e.svg_elements]})})}const fE="M11.07 12.85c.77-1.39 2.25-2.21 3.11-3.44.91-1.29.4-3.7-2.18-3.7-1.69 0-2.52 1.28-2.87 2.34L6.54 6.96C7.25 4.83 9.18 3 11.99 3c2.35 0 3.96 1.07 4.78 2.41.7 1.15 1.11 3.3.03 4.9-1.2 1.77-2.35 2.31-2.97 3.45-.25.46-.35.76-.35 2.24h-2.89c-.01-.78-.13-2.05.48-3.15zM14 20c0 1.1-.9 2-2 2s-2-.9-2-2 .9-2 2-2 2 .9 2 2z";function hE(e){return _(Et,{...e,d:fE})}const vE=(e,t)=>{const n=e.routing,{selected_on:i=new Set}=t;let o=i.size>0;return i.size&&(i.has("route")&&t.route!==void 0&&(o=o&&t.route===n.route),t.args&&(i.has("args.view")&&t.args.view!==void 0&&(o=o&&t.args.view===n.args.view),i.has("args.subview_id")&&t.args.subview_id!==void 0&&(o=o&&t.args.subview_id===n.args.subview_id))),{current_routing_state:n,selected:o}},gE=(e,t)=>({change_route:n=>e(x.routing.change_route({route:t.route,sub_route:t.sub_route,item_id:t.item_id,args:n}))}),n0=j(vE,gE);function wE(e){const{children:t="Link"}=e,[n,i]=I(!1),o=Ie(void 0);if(e.disabled)return t;n&&!o.current&&(o.current=setTimeout(()=>{i(!1),o.current=void 0},300));const s=e.args||{},r=d=>{d.stopImmediatePropagation(),d.preventDefault(),!e.selected&&(i(!0),!(e.on_pointer_down&&e.on_pointer_down())&&e.change_route(s))},a=Mt(e.current_routing_state,e),c={...e.current_routing_state.args,...s};a.args=c;const l="link "+(n?" clicked_animate ":"")+(e.selected?" selected ":"")+(e.extra_class_name||"");return _("a",{onPointerDown:r,onClick:d=>{d.stopImmediatePropagation(),d.preventDefault()},href:fi({...a}),className:l,style:e.extra_css_style,children:t})}const De=n0(wE);function bE(e){const t=e.args||{},n=s=>{s.stopImmediatePropagation(),s.preventDefault(),!(e.on_pointer_down&&e.on_pointer_down())&&e.change_route(t)},i=Mt(e.current_routing_state,e),o={...e.current_routing_state.args,...t};return i.args=o,_(xe,{size:"small",color:"primary",variant:"contained",onClick:n,href:fi({...i}),children:e.name||"Link"})}const yE=n0(bE);function yd(e){const{judgement:t,judgement_trend_manual:n,size:i}=e,s=`judgement_badge ${i} ${t?"positive":t===void 0?"inactive":"negative"} ${n??""}`,r=n==="improving"?_(t0,{}):n==="stable"?_(e0,{}):n==="worsening"?_(Qy,{}):n==="unknown"?_(hE,{}):_("span",{});if(!e.judgement_or_objective_id)return _("div",{className:s,children:r});let a;return e.position&&(a=hi({...e.position,zoom:100},!0)),_(De,{route:void 0,sub_route:void 0,item_id:e.judgement_or_objective_id,args:a,extra_class_name:s,on_pointer_down:()=>{const c=Se(),l=c.getState(),{display_side_panel:d,display_time_sliders:u}=l.controls;return e.position&&(a=hi({...e.position,zoom:100},!0,{display_side_panel:d,display_time_sliders:u})),c.dispatch(x.routing.change_route({item_id:e.judgement_or_objective_id,args:a})),!0},children:r})}const kE=(e,t)=>{let n=me(e,t.judgement_or_objective_id);pt(n)||(n=void 0);let i,o;if(n){const a=n.judgement_target_wcomponent_id;i=me(e,a),o=vo(e,a)}const s=ne(e),r=s==null?void 0:s.composed_wc_id_map[t.judgement_or_objective_id];return{judgement_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,position:r}},xE=j(kE);function AE(e){const{judgement_or_objective_id:t,judgement_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r,position:a}=e;if(!n||!i)return null;const c=Xy({judgement_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r});return _(yd,{judgement:c,judgement_trend_manual:e.hide_judgement_trend?void 0:n.judgement_trend_manual,judgement_or_objective_id:t,position:a,size:e.hide_judgement_trend?"small":"medium"})}const i0=xE(AE);function cn(e){const{wcomponents:t,allowed_wcomponent_ids:n,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a}=e;let c=t||Object.values(i);return n&&(c=c.filter(({id:d})=>n.has(d))),c.filter(ro).filter(d=>!e.exclude_ids||!e.exclude_ids.has(d.id)).map(d=>{const u=Qe({wcomponent:d,text_type:fe.plain,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a});let f=`@@${d.id} -- ${d.title} -- ${d.description}`;we(d)&&(f+=` -- @@${d.from_id} -> @@${d.to_id}`);let m;return pt(d)&&(m=_("div",{children:[_(i0,{judgement_or_objective_id:d.id,hide_judgement_trend:!1}),u]})),{id:d.id,title:u,jsx:m,raw_title:d.title,subtitle:f,color:d.label_color}})}var kd={},SE=Q;Object.defineProperty(kd,"__esModule",{value:!0});var Xi=kd.default=void 0,CE=SE(Z()),$E=ee(),jE=(0,CE.default)((0,$E.jsx)("path",{d:"M16.59 8.59 12 13.17 7.41 8.59 6 10l6 6 6-6z"}),"ExpandMore");Xi=kd.default=jE;var xd={},TE=Q;Object.defineProperty(xd,"__esModule",{value:!0});var o0=xd.default=void 0,PE=TE(Z()),NE=ee(),EE=(0,PE.default)((0,NE.jsx)("path",{d:"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"}),"Refresh");o0=xd.default=EE;function IE(e){const{editing_options:t,internal_options_to_display:n,is_option_wrapper_highlighted:i,conditional_on_change:o,set_highlighted_option_index:s,on_mouse_over_option:r,on_mouse_leave_option:a}=e;if(n.length===0||!t)return null;const c=45;return _("div",{className:"options_outer",style:{marginTop:15},children:_("div",{className:"options_inner",ref:l=>{if(!l)return;const d=`${document.body.clientHeight-l.clientTop-c}px`;l.style.setProperty("max-height",d)},children:n.map((l,d)=>_("div",{className:"option_wrapper "+(i(l,d)?" highlighted ":""),onMouseDown:()=>o(l.id),onMouseOver:()=>{s(d),r(l.id)},onMouseLeave:()=>a(l.id),children:_("div",{className:"option",children:[l.jsx||l.title||l.id||"none",_("div",{className:"option_subtitle",children:l.subtitle})]})}))})})}const RE=e=>{var t;return{presenting:(t=e.display_options)==null?void 0:t.consumption_formatting}},DE=j(RE);function OE(e){const t=Ie([]),n=Ie(Ck.Index()),i=Ie([]);_e(()=>{const P=FE(e.options,200,e.search_fields),L=zE(P);t.current=L,P.forEach(J=>{n.current=n.current.add(J.id_num,J.unlimited_total_text)}),i.current=P},[e.options,e.search_fields]);const o=Ie({actively_chosen:!1,id:void 0}),s=S(),[r,a]=I("");_e(()=>{a(e.initial_search_term||s)},[e.initial_search_term,s]);const{throttled:c,flush:l}=Jc(a,300),[d,u]=I(!1);function f(P){P!==d&&u(P)}_e(()=>{f(!!e.start_expanded)},[e.start_expanded]);const{threshold_minimum_score:m=!1}=e,[h,v]=I([]);_e(()=>{const P=LE({temp_value_str:r,selected_any_option:e.selected_option_id!==Ad,allow_none:!!e.allow_none,internal_options:i.current,prepared_targets:t.current,flexsearch_index:n.current,search_type:e.search_type||"best",threshold_minimum_score:m,retain_options_order:e.retain_options_order||!1});v(P.internal_options),e.set_search_type_used&&e.set_search_type_used(P.search_type_used),l()},[r,e.selected_option_id,e.allow_none,i.current,t.current,n.current,e.search_type,m]);const[g,b]=I(0),w=Ie(new Set),k=z(()=>P=>{P&&w.current.add(P),e.on_mouse_over_option&&e.on_mouse_over_option(P)},[e.on_mouse_over_option]),y=z(()=>P=>{P&&w.current.delete(P),e.on_mouse_leave_option&&e.on_mouse_leave_option(P)},[e.on_mouse_leave_option]);function S(){const P=qE(e);return(P==null?void 0:P.title)||""}const T=async(P,L)=>{P.stopImmediatePropagation();const J=P.key,Ke=J==="ArrowDown",ct=J==="ArrowUp",Ln=J==="Enter",Kt=J==="Escape";if(Ln||Kt)if(Ln&&g!==void 0){const gt=L[g];gt&&R(gt.id)}else Kt&&R(e.selected_option_id);else if(Ke||ct){let gt=g+(Ke?1:-1);gt=gt%L.length,b(gt)}},$=()=>{f(!1),!e.retain_invalid_search_term_on_blur&&a(S()),b(0)},R=P=>{$(),o.current={actively_chosen:!0,id:P}},C=()=>{$();const{on_mouse_leave_option:P}=e;P&&(w.current.forEach(ct=>P(ct)),w.current=new Set);const{actively_chosen:L,id:J}=o.current;if(!L)return;o.current={actively_chosen:!1,id:void 0},e.selected_option_id===J?e.on_choose_same&&e.on_choose_same(J):e.on_change(J)},O=VE(h,r),M=(O==null?void 0:O.id)===sl.id&&e.allow_none||r.toLowerCase()===(O==null?void 0:O.title.toLowerCase());return _("div",{class:"editable_field autocomplete "+(M?"":"invalid "),style:e.extra_styles,children:[_(En,{variant:"standard",disabled:e.editing_allowed!==void 0?!e.editing_allowed:e.presenting,ref:P=>{if(!P)return;const L=P.getElementsByTagName("input")[0];L&&setTimeout(d?()=>L.focus():()=>L.blur(),0)},placeholder:e.placeholder,value:r||(d?"":"-"),onFocus:P=>{setTimeout(()=>f(!0),0),P.currentTarget.setSelectionRange(0,P.currentTarget.value.length)},onChange:P=>c(P.currentTarget.value),onKeyDown:P=>T(P,h),onBlur:()=>C()}),_(IE,{editing_options:d,internal_options_to_display:h,is_option_wrapper_highlighted:(P,L)=>L===g,conditional_on_change:R,set_highlighted_option_index:b,on_mouse_over_option:k,on_mouse_leave_option:y})]})}const ME=DE(OE);function de(e){return _(ME,{...e})}function qE(e){return e.selected_option_id===void 0?e.allow_none?void 0:e.options[0]:e.options.find(({id:t})=>t===e.selected_option_id)}function VE(e,t){const n=t.toLowerCase();return e.find(i=>i.title.toLowerCase()===n)}const s0=1;function FE(e,t,n="all"){let i=s0;const o=n==="all";return e.filter(({is_hidden:r})=>!r).map(r=>{const a=Hh(r,t,o),c=Hh(r,0,o);return{...r,limited_total_text:a,unlimited_total_text:c,id_num:i++}})}function Hh(e,t,n){let i=Nc(e.title,t);return n?i+=e.subtitle?" "+Nc(e.subtitle,t):"":i+=e.raw_title?" "+Nc(e.raw_title,t):"",i}function Nc(e,t){return t?e.slice(0,t)+(e.length>t?"...":""):e}function zE(e){return e.map(({limited_total_text:t})=>Nv.prepare(t))}const Ad=void 0,sl={id:Ad,id_num:s0-1,title:"(clear)",limited_total_text:"clear",unlimited_total_text:""};function LE(e){const{temp_value_str:t,selected_any_option:n,allow_none:i,prepared_targets:o,flexsearch_index:s,search_type:r,threshold_minimum_score:a,retain_options_order:c}=e;let{internal_options:l}=e,d;if(!t)return l=i&&n?[sl,...l]:l,{internal_options:l,search_type_used:d};let u=g=>0,f=g=>0,m=0;if(r==="best"||r==="exact"){d="exact";const g=s.search(t);m=g.length;const b={};g.forEach((w,k)=>b[w]=1e4-k),u=w=>b[w.id_num]||-1e4}if(m<10&&(r==="best"||r==="fuzzy")){d="fuzzy";const g={limit:100,allowTypo:!0,threshold:-1e4},b=Nv.go(t,o,g),w={};b.forEach(({target:k,score:y})=>w[k]=y),f=k=>{const y=w[k.limited_total_text];return y===void 0?u(k):y}}else f=u;const h=a===!1?l:l.filter(g=>f(g)>a);let v=h;return c||(v=ue(h,f,ce.descending)),i&&n&&(v=[sl,...v]),{internal_options:v,search_type_used:d}}function BE(e,t){const n=e.global_keys.last_key==="Escape",{last_key_time_stamp:i=0}=e.global_keys;return{should_close:n&&i>t.time_stamp_first_rendered}}const UE=j(BE);function WE(e){const{on_close:t}=e;return t&&e.should_close&&setTimeout(()=>t(),0),_("div",{id:"modal_background",className:(e.size||"medium")+"_modal",onClick:n=>{n.stopImmediatePropagation(),t&&t(n)},children:_("div",{id:"modal_container",style:e.scrollable===!1?{overflowY:"hidden"}:void 0,onClick:n=>n.stopPropagation(),children:[_("div",{id:"modal_title",children:e.title}),t&&_("div",{id:"modal_close",onClick:n=>t(n),children:_("span",{children:"X"})}),e.child]})})}const HE=UE(WE);function zn(e){const t=performance.now();return _(HE,{...e,time_stamp_first_rendered:t})}function GE(e){const[t,n]=I("all"),[i,o]=I("best"),[s,r]=I(void 0),[a,c]=I(!1),l=_(Ns,{titleAccess:"You might be getting sub optimal search results!",style:{color:ik[600]}}),d=()=>i=="best"&&t=="all";return _(zn,{on_close:()=>e.on_blur&&e.on_blur(),title:e.search_window_title,child:_(E,{p:5,children:[_(qi,{onChange:(u,f)=>{c(f)},children:[_(Vi,{expandIcon:!d()&&!a?l:_(Xi,{}),children:_(re,{component:"h2",children:[a?"Hide ":"Show ","Advanced Search Options"]})}),_(Fi,{children:_(E,{width:1,children:[_(E,{display:"flex",justifyContent:"flex-start",alignItems:"stretch",children:[_(E,{mr:10,flexGrow:1,flexShrink:0,children:_(it,{variant:"standard",component:"fieldset",fullWidth:!0,children:[_(ci,{component:"legend",children:"Search Type: "}),_(wu,{name:"search_type",value:i,onChange:u=>o(u.target.value),children:[_(Pi,{value:"exact",control:_(Ni,{}),label:"Exact"}),_(Pi,{value:"fuzzy",control:_(Ni,{}),label:"Fuzzy"}),_(Pi,{value:"best",control:_(Ni,{}),label:"Best"})]})]})}),_(E,{mr:10,flexGrow:1,flexShrink:0,children:_(it,{variant:"standard",component:"fieldset",fullWidth:!0,children:[_(ci,{component:"legend",children:"Search Over: "}),_(wu,{name:"search_fields",value:t,onChange:u=>n(u.target.value),children:[_(Pi,{value:"all",control:_(Ni,{}),label:"All"}),_(Pi,{value:"title",control:_(Ni,{}),label:"Title Only"})]})]})}),_(E,{flexGrow:1,flexShrink:0,alignSelf:"flex-end",textAlign:"right",children:!d()&&_(xe,{variant:"contained",color:"primary",onClick:()=>{o("best"),n("all")},endIcon:_(o0,{}),children:"Reset Search Options"})})]}),_(E,{style:{opacity:s?.7:0},children:["Used: ",s]})]})})]}),_(de,{placeholder:e.placeholder,selected_option_id:e.selected_option_id,initial_search_term:e.initial_search_term,options:e.options,allow_none:e.allow_none,on_change:u=>{e.on_change(u),e.on_blur&&e.on_blur()},on_mouse_over_option:e.on_mouse_over_option,on_mouse_leave_option:e.on_mouse_leave_option,extra_styles:e.extra_styles,start_expanded:!0,retain_invalid_search_term_on_blur:!0,search_fields:t,search_type:i,set_search_type_used:r,editing_allowed:!0,threshold_minimum_score:-1e3})]})})}const KE=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:at(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),YE=j(KE);function JE(e){const t=cn(e);return _(GE,{search_window_title:"Search for a Component",placeholder:"Search for a Component...",selected_option_id:"",initial_search_term:e.initial_search_term,allow_none:!0,options:t,on_change:e.on_change,on_blur:e.on_blur})}const r0=YE(JE);function XE(e){const{value:t,id_insertion_point:n,conditional_on_change:i,on_close:o}=e,s=ZE({value:t,id_insertion_point:n}),r=Ie(!1);return _(r0,{initial_search_term:s,on_change:a=>{const c=QE({value:t,id_to_insert:a,id_insertion_point:n}),l=n+((a==null?void 0:a.length)||0),d=l+((s==null?void 0:s.length)||0),u={start:l,end:d};r.current=!0,i({new_value:c,on_focus_set_selection:u})},on_blur:()=>{if(r.current)return;const a=n+((s==null?void 0:s.length)||0);o({start:n,end:a})}})}function ZE(e){const n=e.value.slice(e.id_insertion_point).match(/^(\w+)/);return n&&n[1]||""}function QE(e){const{value:t,id_to_insert:n,id_insertion_point:i}=e;return n===void 0?t:t.slice(0,i)+n+t.slice(i)}var G=(e=>(e[e.conditional=0]="conditional",e[e.always=1]="always",e))(G||{});const e9=e=>({presenting:e.display_options.consumption_formatting,use_creation_context:e.creation_context.use_creation_context,creation_context:e.creation_context.creation_context}),t9=j(e9);function n9(e){const{placeholder:t,disabled:n,presenting:i,editing_allowed:o,select_all_on_focus:s,force_focus_on_first_render:r,on_blur_type:a=0}=e,[c,l]=I(e.value);_e(()=>l(e.value),[e.value]);const d=Ie(void 0),u=Ie(void 0);if(o===!1||!e.conditional_on_change&&!e.on_blur||n||i&&o===void 0){const C=n?"disabled":"",O=!!e.value;return _("div",{className:C,children:[O&&!e.hide_label&&_("span",{className:"description_label",children:[e.placeholder," "]}),_(vd,{text:c||t})]})}const f=`editable_field ${c?"":"placeholder"}`,m=z(()=>C=>{if(!C)return;const O=!d.current;d.current=C,O&&i9({el:C,force_focus_on_first_render:r})},[]),h=z(()=>C=>{o9({e:C,select_all_on_focus:s})},[s]),v=z(()=>C=>{e.use_creation_context&&(C=Gh(e.creation_context,C)),C!==e.value&&e.conditional_on_change&&e.conditional_on_change(C),l(C)},[e.value,e.creation_context,e.conditional_on_change]),g=z(()=>C=>{e.use_creation_context&&(C=Gh(e.creation_context,C)),e.modify_value_pre_on_blur&&(C=e.modify_value_pre_on_blur(C));const O=C!==e.value;(a===1||O)&&e.on_blur&&e.on_blur(C),l(C)},[e.value,e.creation_context,a,e.on_blur]),b=z(()=>C=>{if(u.current!==void 0)return;const O=a9(C.currentTarget);O!==void 0&&(u.current=O),v(C.currentTarget.value)},[v]),w=z(()=>C=>{u.current===void 0&&g(C.currentTarget.value)},[e.value,g]),k=z(()=>C=>{s9(C,d.current,v,g)},[v,g]),y=Ie(g);y.current=g,_e(()=>()=>{!d.current||!(document.activeElement===d.current)||y.current(d.current.value)},[]);const[S,T]=I({}),$=z(()=>C=>{var O,M;(O=d.current)==null||O.focus(),u.current=void 0,T({}),(M=d.current)==null||M.setSelectionRange(C.start,C.end)},[]),R=z(()=>e.component({value:c,on_render:m,on_focus:h,on_change:b,on_blur:w,on_key_down:k}),[c,m,h,b,w]);return _("div",{className:f,style:e.style,children:[R,u.current!==void 0&&_("div",{style:{fontSize:"initial",fontWeight:"initial"},children:_(XE,{value:c,id_insertion_point:u.current,conditional_on_change:({new_value:C,on_focus_set_selection:O})=>{v(C),setTimeout(()=>$(O),0)},on_close:C=>{$(C)}})})]})}const _0=t9(n9);function i9(e){e.force_focus_on_first_render&&setTimeout(()=>e.el.focus(),0)}function o9(e){if(e.select_all_on_focus){const t=e.e.currentTarget;t.setSelectionRange(0,t.value.length)}}function s9(e,t,n,i){document.activeElement===t&&(r9(e,t,n),_9(e,t,i))}function r9(e,t,n){if(!e.ctrlKey||e.key!=="k")return;e.preventDefault();const{value:i,selectionStart:o}=t;let{selectionEnd:s}=t;if(typeof o!="number")return;typeof s!="number"&&(s=o);const r=i.slice(o,s),a=r?r.startsWith("http")?0:1:2,c=a===1?r:"title",l=a===0?r:"url",d=i.slice(0,o)+"["+c+"]("+l+")"+i.slice(s);n(d);let u=o+1,f=u+c.length;a===1&&(u=s+3,f=u+l.length),setTimeout(()=>t.setSelectionRange(u,f),0)}function _9(e,t,n){if(e.ctrlKey&&e.key==="e"){n(t.value);return}e.key!=="Shift"&&e.key!=="Control"&&e.stopImmediatePropagation()}function a9({selectionStart:e,value:t}){if(typeof e=="number"){const n=t[e-2],i=t[e-1];if(n==="@"&&i==="@"&&Se().getState().global_keys.last_key==="@")return e}}function Gh(e,t){return e&&e.replace_text_target&&e.replace_text_replacement&&(t=t.replaceAll(e.replace_text_target,e.replace_text_replacement)),t}function Wt(e){return _(_0,{...e,component:({value:t,on_render:n,on_focus:i,on_change:o,on_blur:s,on_key_down:r})=>_(En,{fullWidth:!0,size:"small",variant:"standard",label:e.placeholder,multiline:!0,value:t,onFocus:i,onChange:o,onBlur:s,onKeyDown:r,inputRef:n,spellcheck:e.spellcheck})})}function He(e){const t=z(()=>({value:n,on_render:i,on_focus:o,on_change:s,on_blur:r,on_key_down:a})=>_(En,{fullWidth:!0,label:e.placeholder,variant:"outlined",value:n,onFocus:o,onChange:s,onBlur:r,onKeyDown:a,size:e.size,inputRef:i,spellcheck:e.spellcheck,disabled:e.disabled_input,title:e.title}),[e.placeholder,e.size,e.spellcheck,e.disabled_input,e.title]);return _(_0,{...e,component:t})}function ns(e){const[t,n]=I(e.ready_to_progress??!1),{tooltip_text:i=""}=e;return _("div",{style:{display:"flex",justifyContent:"space-between",margin:"4px 0px"},children:[_(Wc,{injectFirst:!0,children:_(Hc,{theme:tk,children:_(F,{color:"secondary",disabled:e.disabled,is_hidden:!t,onClick:o=>{o.stopImmediatePropagation(),n(!1),e.on_click&&e.on_click()},startIcon:e.button_icon,children:_(Me,{title:i,"aria-label":i,children:_(E,{component:"span",children:"CONFIRM"})})})})}),_(Wc,{injectFirst:!0,children:_(Hc,{theme:Av,children:_(F,{color:"primary",disabled:e.disabled,fullWidth:!t,is_hidden:!e.on_click,onClick:o=>{o.stopImmediatePropagation(),n(!t),t&&e.on_cancel&&e.on_cancel()},startIcon:t?"":e.button_icon,children:_(Me,{title:t?"":i,"aria-label":t?"":i,children:_(E,{component:"span",children:t?"Cancel":e.button_text})})})})})]})}const c9="M19 5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 14h-14v-5h14z m0 -12v5h-14v-5h1v-2h12v2z m-3 -2h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function l9(e){return _(Et,{...e,d:c9})}const d9="M19 2H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-12c0-1.1-.9-2-2-2z m0 7h-14v-5h14z m0 7h-1v2h-12v-2h-1v-5h14z m-3 0h-3v-3h-2v3h-3v2h3v3h2v-3h3z";function u9(e){return _(Et,{...e,d:d9})}function p9(e){const[t,n]=I(!1);return _(Re,{children:[_(Me,{title:"Add above",children:_(pe,{onClick:()=>e.update_calculations("add_above"),size:"large",children:_(l9,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),_(Me,{title:"Add below",children:_(pe,{onClick:()=>e.update_calculations("add_below"),size:"large",children:_(u9,{style:{fill:"currentColor",height:"24px",width:"24px"}})})}),_(Me,{title:"Move up",children:_(pe,{onClick:()=>e.update_calculations("move_up"),size:"large",disabled:e.disallowed_commands.has("move_up"),children:_(ok,{})})}),_(Me,{title:"Move down",children:_(pe,{onClick:()=>e.update_calculations("move_down"),size:"large",disabled:e.disallowed_commands.has("move_down"),children:_(sk,{})})}),!t&&_(pe,{onClick:()=>n(!0),size:"large",children:_(bu,{})}),t&&_(ns,{on_click:e.delete_calculation,button_text:"",button_icon:_(bu,{}),ready_to_progress:!0,on_cancel:()=>n(!1)})]})}const m9=e=>({editing:!e.display_options.consumption_formatting}),f9=j(m9);function h9(e){const t=e.value!==void 0?e.value.toString():"",{allow_undefined:n,conditional_on_change:i,on_blur:o,on_blur_type:s,disabled:r,editing:a,default_value_when_invalid:c=0,editing_allowed:l}=e;let d="editable_number";if(!a||!i&&!o||r){d=d+(a?"":" not_editable ")+(r?" disabled ":"");const u=e.value!==void 0;return _("div",{className:d,style:e.style,children:[u&&_("span",{className:"description_label",children:e.placeholder})," ",u?e.value:e.placeholder]})}return _("div",{className:d,style:e.style,children:_(He,{placeholder:e.placeholder,size:e.size||"small",style:e.style,value:t,editing_allowed:l,select_all_on_focus:!0,conditional_on_change:u=>{if(!i)return;const f=a0(u,c);(c0(i,n)||f!==void 0)&&i(f)},on_blur:u=>{o&&v9({value:u,default_value_when_invalid:c,on_blur:o,allow_undefined:n})},on_blur_type:s||G.conditional})})}const st=f9(h9);function a0(e,t){if(!e)return;const n=parseFloat(e);return Number.isNaN(n)?t:n}function c0(e,t){return!!t}function v9({value:e,default_value_when_invalid:t,on_blur:n,allow_undefined:i}){let o=a0(e,t);c0(n,i)||o===void 0&&(o=t),n(o)}function g9(e){const{result:t,default_significant_figures:n,temp_result_sig_figs:i,set_temp_result_sig_figs:o,result_display_type:s,update_calculation:r}=e,a=w9(t,i??n);return _("div",{style:{display:"flex"},children:[_("div",{"data-tooltip":"Significant figures","data-tooltip_left_-10":!0,"data-tooltip_bottom_-60":!0,children:_(st,{size:"small",style:{marginLeft:5,marginTop:5,width:"80px"},placeholder:"Sig. figs",value:i,allow_undefined:!0,conditional_on_change:c=>{c=Kh(c),o(c)},on_blur_type:G.always,on_blur:c=>{c=Kh(c),o(c??n),r({result_sig_figs:c})}})}),_("div",{"data-tooltip":"Display type","data-tooltip_left_0":!0,"data-tooltip_bottom_-60":!0,style:{marginLeft:"10px",width:"120px"},children:[_("div",{className:"description_label",children:"Format"}),_(de,{selected_option_id:s,options:a,retain_options_order:!0,on_change:c=>{const l=a.find(u=>u.id===c),d=l==null?void 0:l.result_display_type;r({result_display_type:d})}})]})]})}function Kh(e){if(e!==void 0)return Math.max(Math.round(e),0)}function w9(e,t){e=e??1000.23;const n={bare:{id:"bare",order:0,result_display_type:"bare",title:W(e,t,V.bare)},simple:{id:"simple",order:1,result_display_type:"simple",title:W(e,t,V.simple)},scaled:{id:"scaled",order:2,result_display_type:"scaled",title:W(e,t,V.scaled)},percentage:{id:"percentage",order:4,result_display_type:"percentage",title:W(e,t,V.percentage)},abbreviated_scaled:{id:"abbreviated_scaled",order:3,result_display_type:"abbreviated_scaled",title:W(e,t,V.abbreviated_scaled)},scientific:{id:"scientific",order:5,result_display_type:"scientific",title:W(e,t,V.scientific)}},i={...n};return n.abbreviated_scaled.title===n.scaled.title&&delete i.abbreviated_scaled,n.scaled.title===n.simple.title&&delete i.scaled,n.simple.title===n.bare.title&&delete i.simple,Object.values(i).sort((s,r)=>s.order-r.order)}const b9=2;function l0(e){const t=parseInt(e,10);return u0(t)?4:b9}function d0(e){const t=parseInt(e,10);return u0(t)?V.bare:e.trim().match(/\d+\.?\d*\s*\%/)?V.percentage:V.simple}function u0(e){return Number.isSafeInteger(e)&&e>=1900&&e<=2200}function wn(e,t=""){const n=t.toUpperCase(),i=y9(e);if(t&&!i.has(n))return t;let o=k9(t||"A"),s=Yh(o);for(;i.has(s);)o=x9(o),s=Yh(o);return t&&(s=A9(s,t)),s}function y9(e){return new Set([...Kc,...e].map(n=>n.toUpperCase().replaceAll(/\s*/g,"")))}function k9(e){return e=e.toUpperCase(),e.split("").map(t=>t.charCodeAt(0)).filter(t=>t>=65&&t<=90)}function Yh(e){return e.map(t=>String.fromCharCode(t)).join("")}function x9(e){let t=!1;for(let n=e.length-1;n>=0;--n)if(e[n]=e[n]+1,e[n]>90)e[n]=65,t=!0;else{t=!1;break}return t&&e.push(65),e}function A9(e,t){return e.split("").map((n,i)=>{const o=t.charCodeAt(i);return o>=97&&o<=122&&(n=n.toLowerCase()),n}).join("")}function p0(e){return e.replaceAll("*","\\*")}function S9(e){const{calculation:t,calculation_result:n,editing:i,existing_calculation_name_ids:o,show_options:s,set_show_options:r}=e,a=l0(t.value),{result_sig_figs:c=a}=t,[l,d]=I(c),u=d0(t.value),{result_display_type:f=u}=t;if(!i&&!t.value&&!t.units)return null;let m=_("div",{});if(n!==void 0&&n.value!==void 0){const w=W(n.value,l??a,f),{source_wcomponent_id:k}=n;m=_("div",{children:[" = ",_(De,{disabled:k===void 0,route:"wcomponents",sub_route:void 0,item_id:k,args:void 0,extra_class_name:"normal",children:[w,n.units&&_("span",{style:{fontSize:"14px"},children:[" ",n.units]}),t.result_description&&_("span",{style:{fontSize:"14px"},children:[" ",_(vd,{text:t.result_description})]})]})]})}const h=i||m0(t.value),v=!!t.value.match(a2),g={display:"flex"},b=Py(n,g);return _(E,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",marginBottom:i?"18px":void 0,flexDirection:i?"column":"row",style:{display:"flex"},className:"form_section "+(s?"":"hidden_border"),children:[_(Ny,{...b}),_("div",{style:{width:"100%",display:"flex"},children:[_(He,{size:"small",placeholder:"",hide_label:!0,value:t.name,on_blur:w=>{const k=o.filter(S=>S!==t.name),y=wn(k,w);e.update_calculation({...t,name:y})},on_blur_type:G.conditional}),h&&_(Re,{children:[" = ",_(Wt,{placeholder:"Calculation",hide_label:!0,value:i?t.value:p0(t.value),on_blur:w=>e.update_calculation({...t,value:w}),on_blur_type:G.conditional})," "]}),i&&_(He,{placeholder:"Units",hide_label:!0,disabled_input:v,title:v?"Editing disabled: edit units of referenced component":void 0,value:(v?n==null?void 0:n.units:t.units)||"",modify_value_pre_on_blur:w=>v?(n==null?void 0:n.units)||"":w,on_blur:w=>e.update_calculation({...t,units:w||void 0}),on_blur_type:G.conditional}),!i&&m]}),i&&_("div",{style:{...g,marginTop:void 0},children:[m,_(pe,{onClick:()=>r(!s),size:"small",style:{marginLeft:"auto"},children:_(Sv,{})})]}),e.editing&&s&&_(g9,{result:n==null?void 0:n.value,default_significant_figures:a,temp_result_sig_figs:l,set_temp_result_sig_figs:d,result_display_type:f,update_calculation:w=>{e.update_calculation({...t,...w})}}),e.editing&&s&&_("div",{style:{...g,marginLeft:10,marginTop:20},children:_("div",{style:{display:"flex"},children:_(He,{size:"small",placeholder:"Description",value:t.result_description||"",on_blur_type:G.conditional,on_blur:w=>{const k=w||void 0;e.update_calculation({...t,result_description:k})}})})}),e.editing&&s&&_("div",{style:{...g,justifyContent:"flex-end"},children:_(p9,{delete_calculation:()=>e.update_calculation(null),disallowed_commands:e.disallowed_commands,update_calculations:e.update_calculations})})]})}const C9=/.*[\^*/+\-()><=].*/g;function m0(e){let t="";for(;t=e.replace(_2,"$1$3"),t!==e;)e=t;return!!t.match(C9)}const $9=A.delay("EditableCalculationRow support functions",()=>{A("should_show_calc_value",()=>{let e,t;e="(@@02d4a5f4-4abd-41a2-bb50-e68e358a3169/@@e34796cf-ab9e-47b8-9ea5-20cb00fb611d)*@@86635a8b-f4f8-4489-8a02-b4f09c0a22ec",t=m0(e),p(t,!0,"Should return true for calculation with wcomponent ids")})}),j9=A.delay("get default formatting function",()=>{const e=[{calc_value:"  81.2  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when valid number with decimal space",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when only valid number"},{calc_value:"  1899  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (1899) outside of 1900-2200",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when integer number (1899) outside of 1900-2200"},{calc_value:"  1900  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (1900) inside of 1900-2200",expected_result_display_type:V.bare,test_description__result_display_type:"Should assign simple type when integer number (1900) inside of 1900-2200"},{calc_value:"  2200  ",expected_sig_figs:4,test_description__sig_figs:"4 sig figures when integer number (2200) inside of 1900-2200",expected_result_display_type:V.bare,test_description__result_display_type:"Should assign simple type when integer number (2200) inside of 1900-2200"},{calc_value:"  2201  ",expected_sig_figs:2,test_description__sig_figs:"Only 2 sig figures when integer number (2201) outside of 1900-2200",expected_result_display_type:V.simple,test_description__result_display_type:"Should assign simple type when integer number (2201) outside of 1900-2200"},{calc_value:"  81.2 %  ",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:V.percentage,test_description__result_display_type:"Should assign percentage type when % included with valid number containing spaces and decimal"},{calc_value:"83%",expected_sig_figs:2,test_description__sig_figs:"Default 2 sig figures when number is percentage",expected_result_display_type:V.percentage,test_description__result_display_type:"Should assign percentage type when % included with simple valid number without spaces or decimal"}];A("get_default_significant_figures",()=>{let t;e.forEach(n=>{t=l0(n.calc_value),p(t,n.expected_sig_figs,n.test_description__sig_figs)})}),A("get_default_result_display_type",()=>{let t;e.forEach(n=>{t=d0(n.calc_value),p(t,n.expected_result_display_type,n.test_description__result_display_type)})})}),T9=A.delay("get_valid_calculation_name_id",()=>{let e,t,n,i;t=[],e=void 0,n="A",i=wn(t,e),p(i,n,"Without any other IDs"),t=["A"],e=void 0,n="B",i=wn(t,e),p(i,n,'With an existing ID of "A"'),t=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],e=void 0,n="AA",i=wn(t,e),p(i,n,'With existing IDs of "A" up to "Z"'),t=["A","B"],e="a",n="c",i=wn(t,e),p(i,n,'With existing IDs of "A" and "B", and given a  lower case "a"'),t=["food"],e="Food",n="Fooe",i=wn(t,e),p(i,n,'With an existing ID of "food" and given "Food"')}),P9=A.delay("make_calculation_safe_for_rich_text",()=>{let e,t,n;e="A * B * C",n="A \\* B \\* C",t=p0(e),p(t,n,"Should escape *")});function rl(e){const{editing_allowed:t,wcomponent_id:n,knowledge_view:i,composed_wc_id_maps_object:o,foundation_composed_wc_id_map:s}=e,r={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},a=i.wc_id_map[n],c=o.composed_wc_id_map[n],l=!!(!a||a.blocked||a.passthrough);return r.show_wcomponent_status_in_this_kv_section=!!(i.id&&l),r.show_wcomponent_status_in_this_kv_section&&(r.wcomponent_status_in_this_kv_text=(a!=null&&a.blocked?"Deleted from":"Not present in")+" this knowledge view"+(c&&!c.blocked?" but is present in a foundational knowledge view":"")),r.show_add_button=r.show_wcomponent_status_in_this_kv_section&&t,r.show_add_button&&(r.add_button_text=(a!=null&&a.blocked?"Re-add":"Add")+" to current knowledge view"),r.show_remove_button=!!(t&&a&&!a.passthrough),r.show_remove_button&&(r.remove_button_text="Remove from knowledge view",r.remove_button_tooltip="Remove from current knowledge view ("+i.title+")",a!=null&&a.blocked&&s[n]&&(r.remove_button_text="Remove block (allow to show through from foundational knowledge view)",r.remove_button_tooltip="This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view ("+i.title+")")),r.show_remove_and_block_button=!!(t&&a&&!a.blocked&&!a.passthrough&&s[n]),r.show_remove_and_block_button&&(r.remove_and_block_button_text="Remove and Block from knowledge view",r.remove_and_block_button_tooltip="Remove and Block from showing in current knowledge view ("+i.title+")"),r}function Ec(e,t,n){const i=new Date("2023-03-22 15:15:00");return{id:t,foundation_knowledge_view_ids:n?[n]:void 0,wc_id_map:e,title:"some title of "+t,description:"",sort_type:"normal",created_at:i,base_id:1,goal_ids:[]}}const N9=A.delay("get_UI_data__wcomponent_add_or_for_knowledge_view",()=>{A("simple single knowledge view with no foundation",()=>{const e=Ec({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0}},"kv1"),t={[e.id]:e},n=$t(e,t,!0),i=lt(n,{}),o=$t(e,t,!1),s=lt(o,{});p(i,{composed_wc_id_map:{wc2:{left:20,top:0}},composed_blocked_wc_id_map:{wc4:{left:40,top:0,blocked:!0}}},"Sanity check (no1) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),p(s,{composed_wc_id_map:{},composed_blocked_wc_id_map:{}},"Sanity check (no2) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function c(u,f){return rl({editing_allowed:u,wcomponent_id:f,knowledge_view:e,composed_wc_id_maps_object:i,foundation_composed_wc_id_map:s.composed_wc_id_map})}let l,d;A("editing_allowed is true",()=>{l=c(!0,"wc1"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(l,d,"with wcomponent not yet added to knowledge view"),l=c(!0,"wc2"),d={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},p(l,d,"with normal wcomponent entry in knowledge view"),l=c(!0,"wc3"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(l,d,"with wcomponent removed from this knowledge view"),l=c(!0,"wc4"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv1)",show_remove_and_block_button:!1},p(l,d,"with wcomponent blocked from this knowledge view")}),A("editing_allowed is false",()=>{l=c(!1,"wc1"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(l,d,"with wcomponent not yet added to knowledge view"),l=c(!1,"wc2"),d={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(l,d,"with normal wcomponent entry in knowledge view"),l=c(!1,"wc3"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(l,d,"with wcomponent removed from this knowledge view"),l=c(!1,"wc4"),d={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(l,d,"with wcomponent blocked from this knowledge view")})}),A("knowledge view with single knowledge view foundation",()=>{const e=Ec({wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222},wc9:{left:90,top:222,passthrough:!0},wc10:{left:100,top:222,passthrough:!0},wc11:{left:110,top:222,passthrough:!0},wc12:{left:120,top:222,passthrough:!0},wc13:{left:130,top:222,blocked:!0},wc14:{left:140,top:222,blocked:!0},wc15:{left:150,top:222,blocked:!0},wc16:{left:160,top:222,blocked:!0}},"kv1"),t=Ec({wc2:{left:20,top:0},wc3:{left:30,top:0,passthrough:!0},wc4:{left:40,top:0,blocked:!0},wc6:{left:60,top:0},wc7:{left:70,top:0,passthrough:!0},wc8:{left:80,top:0,blocked:!0},wc10:{left:100,top:0},wc11:{left:110,top:0,passthrough:!0},wc12:{left:120,top:0,blocked:!0},wc14:{left:140,top:0},wc15:{left:150,top:0,passthrough:!0},wc16:{left:160,top:0,blocked:!0}},"kv2",e.id),n={[e.id]:e,[t.id]:t},i=$t(t,n,!0),o=lt(i,{}),s=$t(t,n,!1),r=lt(s,{});p(o,{composed_wc_id_map:{wc2:{left:20,top:0},wc5:{left:50,top:222},wc6:{left:60,top:0},wc7:{left:70,top:222},wc10:{left:100,top:0},wc14:{left:140,top:0}},composed_blocked_wc_id_map:{wc4:{blocked:!0,left:40,top:0},wc8:{blocked:!0,left:80,top:0},wc12:{blocked:!0,left:120,top:0},wc13:{blocked:!0,left:130,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:0}}},"Sanity check (no3) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid"),p(r,{composed_wc_id_map:{wc5:{left:50,top:222},wc6:{left:60,top:222},wc7:{left:70,top:222},wc8:{left:80,top:222}},composed_blocked_wc_id_map:{wc13:{blocked:!0,left:130,top:222},wc14:{blocked:!0,left:140,top:222},wc15:{blocked:!0,left:150,top:222},wc16:{blocked:!0,left:160,top:222}}},"Sanity check (no4) that we're still dealing with the same data structure from get_composed_wc_id_maps_object so that following tests are valid");function l(f,m){return rl({editing_allowed:f,wcomponent_id:m,knowledge_view:t,composed_wc_id_maps_object:o,foundation_composed_wc_id_map:r.composed_wc_id_map})}let d,u;A("editing_allowed is true",()=>{A("with wcomponent not yet added to foundational knowledge view",()=>{d=l(!0,"wc1"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc2"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc3"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc4"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with wcomponent blocked from this top/current/child knowledge view")}),A("with wcomponent added to foundational knowledge view",()=>{d=l(!0,"wc5"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc6"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!0,remove_and_block_button_text:"Remove and Block from knowledge view",remove_and_block_button_tooltip:"Remove and Block from showing in current knowledge view (some title of kv2)"},p(d,u,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc7"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view but is present in a foundational knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc8"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove block (allow to show through from foundational knowledge view)",remove_button_tooltip:"This is present in a foundational knowledge view but is currently blocked from appearing in this current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with wcomponent blocked from this top/current/child knowledge view")}),A("with wcomponent removed from foundational knowledge view",()=>{d=l(!0,"wc9"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc10"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc11"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc12"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with wcomponent blocked from this top/current/child knowledge view")}),A("with wcomponent removed and blocked in foundational knowledge view",()=>{d=l(!0,"wc13"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent not yet added to top/current/child knowledge view"),d=l(!0,"wc14"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with normal wcomponent entry in top/current/child knowledge view"),d=l(!0,"wc15"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!0,add_button_text:"Add to current knowledge view",show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"and with wcomponent removed from this top/current/child knowledge view"),d=l(!0,"wc16"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!0,add_button_text:"Re-add to current knowledge view",show_remove_button:!0,remove_button_text:"Remove from knowledge view",remove_button_tooltip:"Remove from current knowledge view (some title of kv2)",show_remove_and_block_button:!1},p(d,u,"and with wcomponent blocked from this top/current/child knowledge view")})}),A("editing_allowed is false",()=>{A("with wcomponent not yet added to foundational knowledge view",()=>{d=l(!1,"wc1"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent blocked from this knowledge view")}),A("with wcomponent added to foundational knowledge view",()=>{d=l(!1,"wc1"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent blocked from this knowledge view")}),A("with wcomponent removed from foundational knowledge view",()=>{d=l(!1,"wc1"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent blocked from this knowledge view")}),A("with wcomponent removed and blocked in foundational knowledge view",()=>{d=l(!1,"wc1"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent not yet added to knowledge view"),d=l(!1,"wc2"),u={show_wcomponent_status_in_this_kv_section:!1,show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with normal wcomponent entry in knowledge view"),d=l(!1,"wc3"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Not present in this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent removed from this knowledge view"),d=l(!1,"wc4"),u={show_wcomponent_status_in_this_kv_section:!0,wcomponent_status_in_this_kv_text:"Deleted from this knowledge view",show_add_button:!1,show_remove_button:!1,show_remove_and_block_button:!1},p(d,u,"with wcomponent blocked from this knowledge view")})})})});async function E9(){ku.reset(),(await dP)(),await(await uP)(),(await d2)(),(await p2)(),(await m2)(),(await h2)(),(await g2)(),(await a7)(),(await u7)(),(await N7)(),(await nj)(),(await E7)(),(await z7)(),(await W7)(),(await G7)(),(await K7)(),(await Z7)(),(await cP)(),(await lP)(),(await fC)(),(await vC)(),(await gC)(),(await wA)(),(await pP)(),(await fP)(),(await hP)(),(await wP)(),(await bP)(),(await yP)(),(await kP)(),(await xP)(),(await AP)(),(await SP)(),(await ZC)(),(await u$)(),(await CP)(),(await $P)(),(await WS)(),(await GS)(),(await jP)(),(await TP)(),(await PP)(),(await RP)(),(await H7)(),(await DP)(),(await $2)(),(await OP)(),(await MP)(),(await qP)(),(await y2)(),(await A2)(),(await BP)(),(await UP)(),(await WP)(),(await bC)(),(await $9)(),(await j9)(),(await T9)(),(await P9)(),(await N9)(),(await vP)(),(await gP)(),ku.print()}function I9(){window.run_tests=E9}var _l=(e=>(e.click="click",e.drag="drag",e))(_l||{});const ae={help:{shortcut:["?"],outcome:"Opens this help menu"},fit_view:{shortcut:["space"],outcome:"Fit view to components / cycle between groups of components."},toggle_present_edit:{shortcut:["Ctrl","e"],outcome:"Toggle between presentation and editing modes"},toggle_side:{shortcut:["Ctrl","d","s"],outcome:"Toggle showing side panel"},toggle_time:{shortcut:["Ctrl","d","t"],outcome:"Toggle showing time sliders"},toggle_focused:{shortcut:["Ctrl","d","f"],outcome:'Toggle "focused" mode on and off'},toggle_animating:{shortcut:["Ctrl","d","a"],outcome:"Toggle animating connections"},toggle_circular_connections:{shortcut:["Ctrl","d","c"],outcome:"Toggle showing connections as (more) circular"},select_multiple:{shortcut:["Shift","click","drag"],outcome:"Select multiple nodes"},deselect_multiple:{shortcut:["Shift","Ctrl","click","drag"],outcome:"Deselect multiple nodes"},select_all:{shortcut:["Ctrl","a"],outcome:"Select all nodes on knowledge view"},expand_select_forwards:{shortcut:["Ctrl","s","f"],outcome:"Expand selection towards effects (forwards)"},expand_select_backwards:{shortcut:["Ctrl","s","c"],outcome:"Expand selection towards causes (backwards)"},expand_select:{shortcut:["Ctrl","s","e"],outcome:"Expand selection"},decrease_select:{shortcut:["Ctrl","s","d"],outcome:"Decrease selection (along non circular connections and nodes)"},select_interconnections:{shortcut:["Ctrl","s","i"],outcome:"Select components inbetween (interconnections)"},search:{shortcut:["Ctrl","f"],outcome:"Open the search menu"}},R9=[ae.help,ae.fit_view,ae.toggle_present_edit,ae.toggle_side,ae.toggle_time,ae.toggle_focused,ae.toggle_animating,ae.toggle_circular_connections,ae.select_multiple,ae.deselect_multiple,ae.select_all,ae.expand_select_forwards,ae.expand_select_backwards,ae.expand_select,ae.decrease_select,ae.select_interconnections,ae.search];function St(e){return _("div",{className:"description",style:{display:"inline"},children:Bo(e.shortcut,()=>_("span",{children:" + "}))})}function D9(e){return _(re,{component:"dt",style:{display:"inline"},children:e.shortcut.map((t,n)=>{const i=t===_l.click||t===_l.drag?"physical_action":"physical_button";return _("div",{style:{display:"inline"},children:[_("div",{className:i,children:t}),n<e.shortcut.length-1&&_("span",{className:"shortcut_plus",children:" + "})]})})})}function O9(e){return _(E,{component:"dl",children:[_(D9,{shortcut:e.shortcut}),_("div",{style:{display:"inline"},children:["   ",e.outcome," "]})]})}const M9=e=>({show:e.display_options.show_help_menu}),q9={set_show_help_menu:x.display.set_show_help_menu},V9=j(M9,q9);function F9(e){const[t,n]=I("kbd-shortcuts"),i=o=>(s,r)=>{n(r?o:!1)};return e.show?_(zn,{size:"medium",title:"",on_close:()=>e.set_show_help_menu({show:!1}),child:_(E,{p:10,children:[_(re,{component:"h1",variant:"h5",children:"Tips for using DataCurator"}),_(qi,{expanded:t==="kbd-shortcuts",onChange:i("kbd-shortcuts"),expandIcon:_(Xi,{}),children:[_(Vi,{children:_(re,{component:"h2",variant:"h6",children:"Commands / shortcuts"})}),_(Fi,{children:_(E,{children:["These shortcuts only work when you are not editing a text field.  Some may only work when you are on the Map (Knowledge) canvas view.",R9.map(o=>_(O9,{...o}))]})})]}),_(qi,{expanded:t==="linking-tips",onChange:i("linking-tips"),children:[_(Vi,{children:_(re,{component:"h2",variant:"h6",children:" Tips on Linking"})}),_(Fi,{children:_(E,{children:L9.map(o=>_(re,{component:"p",paragraph:!0,children:o}))})})]}),_(qi,{expanded:t==="general-tips",onChange:i("general-tips"),expandIcon:_(Xi,{}),children:[_(Vi,{children:_(re,{component:"h2",variant:"h6",children:"General tips"})}),_(Fi,{children:_(E,{children:B9.map(o=>_(re,{component:"p",paragraph:!0,children:o}))})})]}),_(qi,{expanded:t==="detailed-tips",onChange:i("detailed-tips"),expandIcon:_(Xi,{}),children:[_(Vi,{children:_(re,{component:"h2",variant:"h6",children:"Detailed tips"})}),_(Fi,{children:_(E,{children:U9.map(o=>_(re,{component:"p",paragraph:!0,children:o}))})})]})]})}):null}const z9=V9(F9),L9=[`Type "@@" in any text field to access a menu to link to any other component.
    This will insert the id of that component, e.g.  @@12345678-abcd-4123-abcd-1234567890ab.`,`Follow "@@some-id" with .url, .title and .description to get the attributes
    of that component e.g. "@@12345678-abcd-4123-abcd-1234567890ab.title".  Or if it has an
    associated knowledge view then add .map to go to that knowledge view.`,_("span",{children:["Markdown is available so you can use things like ",_("b",{children:"**some text**"}),'to make it bold once it is rendered during presentation mode. Other Markdown syntax like "1. some text" will give you numbered lists. See the full ',_("a",{href:"https: //www.markdownguide.org/basic-syntax/",children:"Markdown guide here"})]})],B9=[_("div",{children:[_(re,{component:"h3",variant:"h6",children:'"Should" word usage'}),'If you find yourself writing states with "should", e.g. "People ',_("b",{children:"should"}),' listen more and be less reductionist" then you might consider separating this out into its 4 separate parts and phrasing as the positive or desired state.  Specifically:',_("ol",{children:[_("li",{children:`the attribute, e.g.: "People listen more and be less reductionist".  Note it is usually easier to express this as the desired state of the attribute instead of the pure attribute itself which is usually longer and less easy to work with: "People's ability to listen and what degree of complexity they can hold in their minds about different subjects".`}),_("li",{children:'the current value, e.g.: "False"'}),_("li",{children:"the other possibilities.  If the value is a boolean i.e. True/False then this can be skipped otherwise if it is a number or other type of value then add the other different possible values."}),_("li",{children:"the judgement or objective about the desired value, e.g.: create a judgement or objective node, target your state node, and choose the desired value via the comparator"})]})]}),_("div",{children:[_(re,{component:"h3",variant:"h6",children:'"Action" node type versus "State"'}),"The action and state node types are very similar.  The former can be used to draw attention to the areas where you or a team member can have an effect on the project.  You can use actions to represent the activity of third party actors but this usually draws unwarranted attention to these components."]})],U9=[_("div",{children:[_(re,{component:"h3",variant:"h6",children:"State subtypes"}),"There are three State subtypes:",_("ol",{children:[_("li",{children:"boolean, e.g. True / False"}),_("li",{children:"number"}),_("li",{children:"other"})]}),"Often you can represent the same attribute in different ways and this will depend on what level of detail is salient to the conversation / the model of the scenario you are interested in.",_("ol",{children:[_("li",{children:'a boolean, with title "The medical response was fast" or "The medical response time was adequate"'}),_("li",{children:'"other" with title "The medical response", with values of "Very slow", "Slow", "Medium", "Fast", "Very fast" etc.'}),_("li",{children:'"number" with title "The medical response speed", where the value perhaps represents the time in minutes until aid was first administered.'})]})]}),_("div",{children:[_(re,{component:"h3",variant:"h6",children:"Multidimensional states"}),'Often there can be attributes / concepts which have two dimensions to them which are salient together, e.g. "The medical response was fast and effective".  These can be modelled using states with titles and subtypes in many ways, for example:',_("ol",{children:[_("li",{children:'a boolean, with title "The medical response was (adequately) fast and effective"'}),_("li",{children:'"number" with title "The medical response speed and effectiveness", where the value is derived from some formula to calculate a single number based of the two attributes of speed and effectiveness.'})]}),'If the concept later needs to be analysed / comprehended / explored in greater detail it can be decomposed.  Either it could be change to a subtype of "other" with title "The medical response speed and effectiveness", with values of "fast and effective", "fast but ineffective", "slow but effective", "slow and ineffective".  Or replaced by two new seperate states, one for "Medical response speed" and one for "Medical response effectiveness".  In the latter case deleting the first node from the knowledge views would be best.  In the former case, ',_("a",{href:"https: //github.com/centerofci/data-curator2/issues/36",children:"versioning the whole component"})," would make this easier from a user's perspective."]}),_("div",{children:[_(re,{component:"h3",variant:"h6",children:"Temporal uncertainty"}),_("p",{children:'Part of making predictions is knowing when some event may occur.  For this we have a very simple "Temporal Uncertainty" form that has three fields: Min, Expected and Max datetime.'}),_("p",{children:"It's important to note that this represents a single event and not a distribution of similar events.  It is also not directly the uncertain temporal range a state might exist over.  i.e. the min is the earliest when the event can occur.  This is easier to understand if you talk about the max value.  The max is the latest the event can occur.  This means the state (associate with state transition events) will occur from the max of an event marking its existence but might occur earlier: up to an including the min datetime of the event."}),_("p",{children:"A concrete example: you will switch on the light in 1 minute (min), likely in 5 minutes (expected) or at most in 10 minutes (max).  But this does not mean the room will be lit from 1 minutes time to 10 minutes time."}),_("p",{children:"The current form is also woefully simplistic for a lot of the uncertain temporal distributions you have inside your head, use almost all the time, use seamlessly, unconsciously, and yet are vital to coordinated effective collaboration, for (complex) interventions."}),_("p",{children:"For example: when are you going to get funding for project X, when will have a hire for position Y, when will your change job, when will you next go shopping (if it's not raining AND someone else not gone yet AND time after 7 am AND time less 10 am then ...)."})]})];var Sd={},W9=Q;Object.defineProperty(Sd,"__esModule",{value:!0});var Cd=Sd.default=void 0,H9=W9(Z()),G9=ee(),K9=(0,H9.default)((0,G9.jsx)("path",{d:"M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"}),"Menu");Cd=Sd.default=K9;const Y9=e=>({use_creation_context:e.creation_context.use_creation_context}),J9={toggle_use_creation_context:x.creation_context.toggle_use_creation_context},X9=j(Y9,J9);function Z9(e){return _("div",{children:["Creation Context",_("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:e.use_creation_context,onClick:t=>{t.stopPropagation(),t.preventDefault()},onPointerDown:t=>{t.stopPropagation(),t.preventDefault(),e.toggle_use_creation_context()}})]})}const Q9=X9(Z9),eI=e=>({apply_filter:e.filter_context.apply_filter}),tI={set_apply_filter:x.filter_context.set_apply_filter},nI=j(eI,tI);function iI(e){return _("div",{children:["Filter",_("input",{type:"checkbox",style:{margin:"-3px 0 0 5px"},checked:e.apply_filter,onClick:t=>{t.stopPropagation(),t.preventDefault()},onPointerDown:t=>{t.stopPropagation(),t.preventDefault(),e.set_apply_filter(!e.apply_filter)}})]})}const oI=nI(iI);function Ht(e){return e.slice(0,1).toUpperCase()+e.slice(1).toLowerCase()}function f0(e){return e==="wcomponents"?"Components":e==="display"?"Display Options":e==="select"?"Selection":Ht(e.replaceAll("_"," "))}function sI(e){return e==="filter"?_(oI,{}):e==="creation_context"?_(Q9,{}):f0(e)}const rI=e=>({current_route:e.routing.route}),_I={change_route:x.routing.change_route},aI=j(rI,_I);function cI(e){const t=()=>{e.on_pointer_down(),e.change_route({route:e.id,sub_route:null,item_id:null})},n=()=>(e.on_pointer_down(),!1),i=sI(e.id);return _(h0,{on_pointer_down:t,children:_(De,{route:e.id,sub_route:null,item_id:null,args:void 0,on_pointer_down:n,children:i})})}const lI=aI(cI);function h0(e){return _(os,{style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},onPointerDown:t=>{t.stopImmediatePropagation(),e.on_pointer_down()},children:e.children})}const dI=e=>({route:e.routing.route,editing:!e.display_options.consumption_formatting}),uI={set_show_help_menu:x.display.set_show_help_menu,change_route:x.routing.change_route},pI=j(dI,uI),mI=new Set(["objects","patterns","statements"]),fI=db.filter(e=>!mI.has(e));function hI(e){const[t,n]=I(null),i=c=>{n(c.currentTarget)},o=()=>{n(null)},[s,r]=I(!1);let a=fI;if(!s){const c=new Set(["about","creation_context"]);a=a.filter(l=>!c.has(l)||e.editing&&l==="creation_context")}return _("div",{children:[_("div",{style:{display:"flex",flexDirection:"row"},children:[_(xe,{style:{display:"flex",flex:1},children:_("b",{style:{width:"100%",display:"flex"},onClick:()=>{e.change_route({route:e.route,item_id:null,sub_route:null})},children:f0(e.route)})}),_(xe,{"aria-controls":"select_tab","aria-haspopup":"true",style:{display:"flex",flex:1,justifyContent:"end"},onClick:i,children:_(Cd,{})})]}),_(rk,{anchorEl:t,id:"select_tab",onClose:o,open:!!t,keepMounted:!0,children:[a.map(c=>_(lI,{id:c,on_pointer_down:o})),_(h0,{on_pointer_down:()=>{o(),e.set_show_help_menu({show:!0})},children:"Help"}),_(os,{onClick:()=>r(!s),style:{display:"flex",justifyContent:"flex-start",padding:"0.5em"},children:[s?"Hide extra":"Show all"," options"]})]})]})}const vI=pI(hI);var $d={},gI=Q;Object.defineProperty($d,"__esModule",{value:!0});var v0=$d.default=void 0,wI=gI(Z()),Jh=ee(),bI=(0,wI.default)([(0,Jh.jsx)("path",{d:"M15.5 5H11l5 7-5 7h4.5l5-7z"},"0"),(0,Jh.jsx)("path",{d:"M8.5 5H4l5 7-5 7h4.5l5-7z"},"1")],"DoubleArrow");v0=$d.default=bI;var jd={},yI=Q;Object.defineProperty(jd,"__esModule",{value:!0});var g0=jd.default=void 0,kI=yI(Z()),xI=ee(),AI=(0,kI.default)((0,xI.jsx)("path",{d:"M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"}),"Tune");g0=jd.default=AI;function SI(e){let t;const n=ne(e);if(n){const{composed_visible_wc_id_map:i,wc_ids_by_type:o}=n,{x:s,y:r,zoom:a}=e.routing.args,c=ze/a,l=s+zl(e.controls.display_side_panel)*c,d=r-ps*c,u=ms(e),f=d-Ll(u)*c;t=!!Array.from(o.any_node).find(m=>{const h=i[m];if(!h)return!1;const{left:v,top:g}=h;return v>=s&&v<=l&&-g<=d&&-g>=f})}return t}var Td={},CI=Q;Object.defineProperty(Td,"__esModule",{value:!0});var w0=Td.default=void 0,$I=CI(Z()),jI=ee(),TI=(0,$I.default)((0,jI.jsx)("path",{d:"M5 15H3v4c0 1.1.9 2 2 2h4v-2H5v-4zM5 5h4V3H5c-1.1 0-2 .9-2 2v4h2V5zm14-2h-4v2h4v4h2V5c0-1.1-.9-2-2-2zm0 16h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zM12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"}),"FilterCenterFocus");w0=Td.default=TI;function b0(e){const{move:t,draw_attention:n,have_finished_drawing_attention:i=()=>{}}=e;return _e(()=>{if(e.enable_spacebar_move_to_shortcut)return H.global_keys.sub("key_down",o=>{t&&o.key===" "&&t()})},[e.enable_spacebar_move_to_shortcut,t]),_(E,{children:[_(Me,{placement:"top",title:t?"Move to component(s)":"No component(s) present",children:_("span",{children:_(pe,{size:"medium",onClick:t,disabled:!t,children:_(w0,{})})})}),_("div",{className:t&&n?"pulsating_circle":"",ref:o=>setTimeout(()=>{o==null||o.classList.remove("pulsating_circle"),i()},1e4)})]})}const PI=(e,t)=>{const n=t.wcomponent_id||e.routing.item_id||"";let i;return t.allow_drawing_attention&&(i=SI(e)),{initial_wcomponent_id:n,created_at_ms:e.routing.args.created_at_ms,components_on_screen:i,current_composed_knowledge_view:ne(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,selected_wcomponent_ids_set:e.meta_wcomponents.selected_wcomponent_ids_set,display_side_panel:e.controls.display_side_panel,display_time_sliders:ms(e)}},NI={move:(e,t)=>x.routing.change_route({args:{created_at_ms:e,...t}})},EI=j(PI,NI);function II(e){const{components_on_screen:t,have_finished_drawing_attention:n,current_composed_knowledge_view:i,wcomponents_by_id:o,initial_wcomponent_id:s,selected_wcomponent_ids_set:r,created_at_ms:a,disable_if_not_present:c,display_side_panel:l,display_time_sliders:d}=e,{positions_no_sidepanel_or_timesliders:u,positions_sidepanel_no_timesliders:f,positions_timesliders_no_sidepanel:m,positions_with_sidepanel_or_timesliders:h,go_to_datetime_ms:v}=z(()=>$j({current_composed_knowledge_view:i,wcomponents_by_id:o,initial_wcomponent_id:s,selected_wcomponent_ids_set:r,created_at_ms:a,disable_if_not_present:c}),[i,o,s,r,a,c]),g=l||d?l&&d?h:l?f:m:u;let b=0;const w=g.length===0?void 0:()=>{let y=g[b++];y||(b=0,y=g[b++]),e.move(v,y)},k=e.allow_drawing_attention&&g.length>0&&!t;return _(b0,{move:w,draw_attention:k,have_finished_drawing_attention:n,enable_spacebar_move_to_shortcut:!e.wcomponent_id})}const y0=EI(II);var Pd={},RI=Q;Object.defineProperty(Pd,"__esModule",{value:!0});var k0=Pd.default=void 0,DI=RI(Z()),OI=ee(),MI=(0,DI.default)((0,OI.jsx)("path",{d:"m15.96 10.29-2.75 3.54-1.96-2.36L8.5 15h11l-3.54-4.71zM3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"Filter");k0=Pd.default=MI;const Is=Pt(e=>({warning_button:{cursor:"help"},warning_icon:{color:e.palette.warning.main}})),qI=e=>{var i;const{wc_ids_excluded_by_created_at_datetime_filter:t,vap_set_number_excluded_by_created_at_datetime_filter:n=0}=((i=ne(e))==null?void 0:i.filters)||{};return{components:(t==null?void 0:t.size)||0,vap_sets:n}},VI={set_display_time_sliders:x.controls.set_display_time_sliders},FI=j(qI,VI);function zI(e){const{components:t,vap_sets:n}=e;if(t+n===0)return null;const i=Is();let o=t?`${t} components are invisible `:"";return t&&n&&(o+="and "),o+=n?`${n} predictions are invisible `:"",o+="due to created at datetime filter",_(Me,{placement:"top",title:o,children:_(pe,{className:i.warning_button,component:"span",onClick:()=>e.set_display_time_sliders(!0),size:"small",children:_(k0,{className:i.warning_icon})})})}const Nd=FI(zI);var Ed={},LI=Q;Object.defineProperty(Ed,"__esModule",{value:!0});var x0=Ed.default=void 0,BI=LI(Z()),UI=ee(),WI=(0,BI.default)((0,UI.jsx)("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore");x0=Ed.default=WI;var Id={},HI=Q;Object.defineProperty(Id,"__esModule",{value:!0});var A0=Id.default=void 0,GI=HI(Z()),KI=ee(),YI=(0,GI.default)((0,KI.jsx)("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext");A0=Id.default=YI;function JI(e){return _(F,{title:e.title,value:"Now",onClick:()=>{const t=new Date().getTime()+6e4;e.change_datetime_ms(t)},is_left:!0})}const XI=(e,{get_handle_ms:t})=>({handle_datetime_ms:t(e),time_resolution:e.display_options.time_resolution}),ZI=j(XI);function QI(e){const t=e.events.map(a=>{let c=a.datetime.getTime();return c=Mk(c,e.time_resolution),c}),n=t[0],i=t[t.length-1],o=hn(t,a=>a,e.handle_datetime_ms);function s(a){typeof a=="number"&&e.change_handle_ms(a)}function r(a){return()=>{let c=o.index+a;o.exact||(a===1?c=Math.ceil(o.index):c=Math.floor(o.index));let l=t[c];for(;l===e.handle_datetime_ms;)c+=a,l=t[c];l&&e.change_handle_ms(l)}}return _(E,{className:"time_slider",my:2,px:5,children:[_(E,{className:"slider_container",display:"flex",children:[_(In,{size:"small",children:[_(pe,{onClick:r(-1),disabled:o.bounds==="n/a"||o.index<=0,title:"Previous "+e.title+" datetime",size:"large",children:_(x0,{})}),_(pe,{onClick:r(1),disabled:o.bounds==="n/a"||o.index>=t.length-1,title:"Next "+e.title+" datetime",size:"large",children:_(A0,{})})]}),_(E,{flexGrow:1,title:e.title+" datetimes",children:_(Cv,{onChange:(a,c)=>s(c),color:"secondary",value:e.handle_datetime_ms,getAriaValueText:eR,valueLabelFormat:tR,step:1,min:n,max:i,valueLabelDisplay:"auto",marks:t.map(a=>({value:a,label:""}))})})]}),_(E,{display:"flex",justifyContent:"flex-end",alignItems:"center",children:[_(ht,{title:e.title,value:new Date(e.handle_datetime_ms),on_change:a=>a&&e.change_handle_ms(a.getTime()),show_now_shortcut_button:!1,show_today_shortcut_button:!1,editing_allowed:!0}),_(JI,{title:"Set "+e.title+" to now",change_datetime_ms:a=>e.change_handle_ms(a)})]})]})}const Xh=ZI(QI),eR=e=>`${e}`,tR=e=>{const t=io({date:new Date(e),time_resolution:"minute"});return _("span",{style:{whiteSpace:"nowrap"},children:t})},Rd=Pt(e=>({inverse_disabled:{color:e.palette.text.disabled,"&.Mui-disabled":{color:e.palette.text.primary,pointerEvents:"auto"}}}));var Dd={},nR=Q;Object.defineProperty(Dd,"__esModule",{value:!0});var S0=Dd.default=void 0,iR=nR(Z()),oR=ee(),sR=(0,iR.default)((0,oR.jsx)("path",{d:"M19.02 10v9H5V5h9V3H5.02c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-9h-2zM17 10l.94-2.06L20 7l-2.06-.94L17 4l-.94 2.06L14 7l2.06.94zm-3.75.75L12 8l-1.25 2.75L8 12l2.75 1.25L12 16l1.25-2.75L16 12z"}),"PhotoFilter");S0=Dd.default=sR;const rR=e=>({creation_context:e.creation_context,editing:!e.display_options.consumption_formatting}),_R={change_route:x.routing.change_route,set_or_toggle_display_side_panel:x.controls.set_or_toggle_display_side_panel},aR=j(rR,_R);function cR(e){const{creation_context:t,editing:n}=e,i=Is();return t.use_creation_context&&n&&_(Me,{placement:"top",title:"WARNING: Creation Context is active, which can result in components being created with incorrect information!",children:_(pe,{className:i.warning_button,component:"span",size:"small",onClick:()=>{e.set_or_toggle_display_side_panel(!0),e.change_route({route:"creation_context"})},children:_(S0,{className:i.warning_icon})})})}const C0=aR(cR);var Od={},lR=Q;Object.defineProperty(Od,"__esModule",{value:!0});var $0=Od.default=void 0,dR=lR(Z()),uR=ee(),pR=(0,dR.default)((0,uR.jsx)("path",{d:"M3 5H1v16c0 1.1.9 2 2 2h16v-2H3V5zm18-4H7c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 16H7V3h14v14z"}),"FilterNone");$0=Od.default=pR;const mR=e=>({apply_filter:e.filter_context.apply_filter}),fR={change_route:x.routing.change_route},hR=j(mR,fR);function vR(e){const{apply_filter:t}=e,n=Is();return t?_(Me,{placement:"top",title:"A filter is in place which could result in components being hidden",children:_(pe,{className:n.warning_button,component:"span",size:"small",onClick:()=>e.change_route({route:"filter"}),children:_($0,{className:n.warning_icon})})}):null}const j0=hR(vR);var Md={},gR=Q;Object.defineProperty(Md,"__esModule",{value:!0});var T0=Md.default=void 0,wR=gR(Z()),bR=ee(),yR=(0,wR.default)((0,bR.jsx)("path",{d:"M11 4.07V2.05c-2.01.2-3.84 1-5.32 2.21L7.1 5.69c1.11-.86 2.44-1.44 3.9-1.62zm7.32.19C16.84 3.05 15.01 2.25 13 2.05v2.02c1.46.18 2.79.76 3.9 1.62l1.42-1.43zM19.93 11h2.02c-.2-2.01-1-3.84-2.21-5.32L18.31 7.1c.86 1.11 1.44 2.44 1.62 3.9zM5.69 7.1 4.26 5.68C3.05 7.16 2.25 8.99 2.05 11h2.02c.18-1.46.76-2.79 1.62-3.9zM4.07 13H2.05c.2 2.01 1 3.84 2.21 5.32l1.43-1.43c-.86-1.1-1.44-2.43-1.62-3.89zM15 12c0-1.66-1.34-3-3-3s-3 1.34-3 3 1.34 3 3 3 3-1.34 3-3zm3.31 4.9 1.43 1.43c1.21-1.48 2.01-3.32 2.21-5.32h-2.02c-.18 1.45-.76 2.78-1.62 3.89zM13 19.93v2.02c2.01-.2 3.84-1 5.32-2.21l-1.43-1.43c-1.1.86-2.43 1.44-3.89 1.62zm-7.32-.19C7.16 20.95 9 21.75 11 21.95v-2.02c-1.46-.18-2.79-.76-3.9-1.62l-1.42 1.43z"}),"FilterTiltShift");T0=Md.default=yR;const kR=e=>({focused_mode:e.display_options.focused_mode}),xR={set_or_toggle_focused_mode:x.display.set_or_toggle_focused_mode},AR=j(kR,xR);function SR(e){const{focused_mode:t}=e,n=t?"WARNING: Focused Mode is active, unselected components will be almost invisible":"Activate focused mode",i=t?Is():$R();return _(Me,{placement:"top",title:n,children:_("span",{children:_(pe,{component:"span",size:"medium",onClick:()=>e.set_or_toggle_focused_mode(),children:_(T0,{className:i.warning_icon})})})})}const CR=AR(SR),$R=Pt(e=>({warning_icon:{color:e.palette.primary.main}}));const jR=e=>{const t=ne(e),n=(t&&t.composed_datetime_line_config.time_origin_ms)!==void 0,i=Be(e);return{display_time_marks:e.display_options.display_time_marks,sim_ms:e.routing.args.sim_ms,time_origin_ms_present:n,current_kv:i,presenting:e.display_options.consumption_formatting}},TR={upsert_knowledge_view:x.specialised_object.upsert_knowledge_view,set_display_time_marks:x.display.set_display_time_marks},PR=j(jR,TR);function NR(e){const{display_time_marks:t,time_origin_ms_present:n,current_kv:i,presenting:o}=e;return o&&!n?null:_(E,{component:"label",children:_(In,{disableElevation:!0,variant:"contained",value:t,children:_(xe,{onClick:()=>{const s=!t;if(s&&!n&&i){const r=Se(),a=xi(r.getState()).left,c={...i,datetime_line_config:{...i.datetime_line_config,time_origin_ms:e.sim_ms,time_origin_x:a}};e.upsert_knowledge_view({knowledge_view:c})}e.set_display_time_marks(s)},"aria-label":"Toggle displaying time markers",children:[t?"Hide":"Show"+(n?"":" (Set)")," time"]})})})}const ER=PR(NR),IR=e=>({linked_datetime_sliders:e.controls.linked_datetime_sliders,display_by_simulated_time:e.display_options.display_by_simulated_time,display_time_sliders:e.controls.display_time_sliders,actually_display_time_sliders:ms(e),editing:!e.display_options.consumption_formatting,animate_connections:e.display_options.animate_connections,created_at_ms:e.routing.args.created_at_ms}),RR={change_display_at_created_datetime:x.display_at_created_datetime.change_display_at_created_datetime,change_display_at_sim_datetime:x.display_at_sim_datetime.change_display_at_sim_datetime,toggle_linked_datetime_sliders:x.controls.toggle_linked_datetime_sliders,set_display_time_sliders:x.controls.set_display_time_sliders,set_display_by_simulated_time:x.display.set_display_by_simulated_time,set_or_toggle_animate_connections:x.display.set_or_toggle_animate_connections},DR=j(IR,RR);function OR(e){const[t,n]=I(!0);Rd();const{created_events:i,sim_events:o}=e,s=qR();return _(E,{p:2,mb:2,borderTop:1,borderColor:"primary.main",position:"relative",children:[_(_k,{in:e.actually_display_time_sliders,children:_(E,{className:s.drawer_content,children:_(E,{flexGrow:1,children:e.actually_display_time_sliders&&_(Re,{children:[_(Xh,{events:i,get_handle_ms:r=>r.routing.args.created_at_ms,change_handle_ms:r=>e.change_display_at_created_datetime({ms:r}),data_set_name:"content_controls_created_at_datetimes",title:"Created at"}),_(Xh,{events:o,get_handle_ms:r=>r.routing.args.sim_ms,change_handle_ms:r=>e.change_display_at_sim_datetime({ms:r}),data_set_name:"content_controls_sim_datetimes",title:"Simulation"})]})})})}),_($v,{className:s.toolbar,variant:"dense",children:[_(E,{className:s.move_to_button_and_warnings,children:[_(y0,{allow_drawing_attention:t,have_finished_drawing_attention:()=>n(!1),disable_if_not_present:!1}),_(CR,{}),_(Nd,{}),_(j0,{}),_(C0,{})]}),_(ER,{}),_("div",{children:[_(Me,{placement:"top",title:e.animate_connections?"Stop animating connections":"Animate connections",children:_(pe,{component:"span",size:"medium",onClick:()=>e.set_or_toggle_animate_connections(),children:_(v0,{style:{color:e.animate_connections?"rgb(25, 118, 210)":""}})})}),_(Me,{placement:"top",title:e.display_time_sliders?"Hide time sliders":"Show time sliders",children:_(pe,{component:"span",size:"medium",onClick:()=>e.set_display_time_sliders(!e.display_time_sliders),children:_(g0,{})})})]})]})]})}const MR=DR(OR),qR=Pt(e=>({toolbar:{justifyContent:"space-between"},move_to_button_and_warnings:{display:"flex",flexDirection:"row"},drawer_content:{display:"flex",flexDirection:"row",alignItems:"center",alignContent:"center"},warning_icon:{color:e.palette.warning.main}}));function VR(e){const t=[],n=new Set,i=[],o=new Set;let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;function a(f,m){if(!f)return;const h=f.getTime();m!=="sim"&&!n.has(h)&&t.push({datetime:f,type:m}),m!=="created"&&!o.has(h)&&i.push({datetime:f,type:m}),s=Math.min(s,f.getTime()),r=Math.max(r,f.getTime())}function c(f){a(f.min,"sim"),a(f.value,"sim"),a(f.max,"sim")}e.forEach(f=>{a(f.custom_created_at||f.created_at,"created"),yi(f)&&f.validity.forEach(({created_at:m,custom_created_at:h,datetime:v})=>{a(h||m,"created"),c(v)}),Rn(f)&&f.values_and_prediction_sets.forEach(({created_at:m,custom_created_at:h,datetime:v})=>{a(h||m,"created"),c(v)}),gl(f)&&f.event_at.forEach(({datetime:m})=>{c(m)})});const l=new Date;t.length===0&&a(l,"created");const d=s,u=r;return["created","sim"].forEach(f=>{a(new Date(d),f),a(new Date(u),f),a(new Date(d-864e5),f),a(new Date(u+864e5),f)}),t.sort(Zh),i.sort(Zh),{created_events:t,sim_events:i}}function Zh({datetime:e},{datetime:t}){return e.getTime()<t.getTime()?-1:1}const FR=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,current_composed_knowledge_view:ne(e)}),zR=j(FR);function LR(e){const{wcomponents_by_id:t,current_composed_knowledge_view:n}=e;if(!n)return _("div",{});const{composed_wc_id_map:i}=n,{created_events:o,sim_events:s}=z(()=>{const r=Object.keys(i).map(a=>t[a]).filter(be);return VR(r)},[i,t]);return _(MR,{created_events:o,sim_events:s})}const BR=zR(LR),UR=e=>{const t=ne(e),n=t==null?void 0:t.prioritisations,i=t==null?void 0:t.composed_datetime_line_config;return{prioritisations:n,time_origin_ms:i==null?void 0:i.time_origin_ms,time_origin_x:i==null?void 0:i.time_origin_x,time_scale:i==null?void 0:i.time_scale}},WR={change_display_at_created_datetime:x.display_at_created_datetime.change_display_at_created_datetime,change_route:x.routing.change_route},HR=j(UR,WR);function GR(e){const[t,n]=I(!0),{prioritisations:i=[]}=e,{time_origin_ms:o,time_origin_x:s,time_scale:r}=Ml(e);let a=mi({datetime:new Date,time_origin_ms:o,time_origin_x:s,time_scale:r}),c=a;const l=140;i.forEach(h=>{const v=ut(h.datetime);if(!v)return;const g=mi({datetime:v,time_origin_ms:o,time_origin_x:s,time_scale:r});a=Math.min(a,g),c=Math.max(c,g)}),a-=100,c+=200;const d=Cb({min_left:a,max_left:c,min_top:l,max_top:l},{display_side_panel:!1,display_time_sliders:!1}).zoom,u={x:a,y:l,zoom:d};return _("div",{style:{borderTop:"thin solid rgb(206, 206, 206)"},children:_(b0,{move:()=>e.change_route({args:u}),draw_attention:t&&u&&!!0,have_finished_drawing_attention:()=>n(!1),enable_spacebar_move_to_shortcut:!0})})}const KR=HR(GR),YR=e=>({view:e.routing.args.view}),JR=j(YR);function XR(e){const{view:t}=e;return _("div",{className:"main_content_controls",children:[t==="knowledge"&&_(BR,{}),t==="priorities"&&_(KR,{})]})}const ZR=JR(XR);function go(e){return _(E,{id:"main_area",display:"flex",flexDirection:"column",flexGrow:1,flexShrink:1,zIndex:1,children:[_(E,{id:"main_content",flexGrow:1,flexShrink:1,display:"flex",flexDirection:"column",position:"relative",zIndex:1,children:e.main_content}),_(E,{id:"main_content_controls",bgcolor:"#fafafa",flexGrow:0,flexShrink:1,position:"relative",zIndex:10,children:_(ZR,{})}),e.extra_content]})}var qd={},QR=Q;Object.defineProperty(qd,"__esModule",{value:!0});var P0=qd.default=void 0,eD=QR(Z()),tD=ee(),nD=(0,eD.default)((0,tD.jsx)("path",{d:"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"}),"Add");P0=qd.default=nD;function N0(e,t,n,i=An){const o={left:0,top:0};if(!e||!t)return o;const s=e[t];if(!s)return o;const r=ob(e,n);let a=s;const c={left:s.left,top:s.top};for(;a;){c.top+=i;const l=ib(c),u=(r[l]||[])[0];a=u?e[u]:void 0}return c}function E0(e,t){let n=kl(e);return e&&(e={...e}),t.forEach(i=>{i.entries.forEach(o=>{var r;if(!o.value_id)return;e=e||{};const s=((r=e[o.value_id])==null?void 0:r.order)??++n;e[o.value_id]={id:o.value_id,value:o.value,description:o.description,order:s}})}),e}function I0(e,t){return e.entries.map(n=>{const i=n.value_id===t?1:0;return{...n,relative_probability:i,probability:i,conviction:1}})}function al(e){const{existing_value_possibilities:t,orig_values_and_prediction_sets:n,base_id:i,creation_context:o,action_value_possibility_id:s}=e,r=Ee(N.action,t,n,i,o),a=I0(r,s);return r.entries=a,[...n,r]}function R0(e){const t=E0(e.existing_value_possibilities,e.new_values_and_prediction_sets);e.update_VAPSets_and_value_possibilities({value_possibilities:t,values_and_prediction_sets:e.new_values_and_prediction_sets});const n=Qh(e.orig_values_and_prediction_sets,e.current_created_at_ms),i=Qh(e.new_values_and_prediction_sets,e.current_created_at_ms),o=1*60*1e3,s=10*o;let r;i.latest_created_at_ms>n.latest_created_at_ms&&(r=i.latest_created_at_ms+o);const a=new Date().getTime(),c=i.latest_sim_ms<a+o&&i.latest_sim_ms>a-s;let l;e.sim_ms<i.latest_sim_ms&&c&&(l=i.latest_sim_ms),(r!==void 0||l!==void 0)&&e.change_route({args:{sim_ms:l,created_at_ms:r}})}function Qh(e,t=0){let n=Number.NEGATIVE_INFINITY;return e.forEach(i=>{t=Math.max(Ae(i),t);const o=ut(i.datetime);o&&(n=Math.max(o.getTime(),n))}),{latest_created_at_ms:t,latest_sim_ms:n}}const iD=e=>({creation_context:e.creation_context,composed_knowledge_view:ne(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,base_id:_t(e)}),oD=j(iD);function sD(e){const{most_recent_action_id:t,composed_knowledge_view:n,wcomponents_by_id:i,base_id:o,list_type:s,creation_context:r}=e;if(!n)return null;const{id:a,composed_wc_id_map:c}=n,l=z(()=>rD({base_id:o,composed_wc_id_map:c,most_recent_action_id:t,wcomponents_by_id:i,list_type:s,creation_context:r,knowledge_view_id:a}),[o,c,t,i,s,r,a]);return _(F,{className:"add_new_action_button",fullWidth:!1,onClick:l,disabled:o===void 0,title:o===void 0?"No knowledge base selected":"",children:_(P0,{})})}const Do=oD(sD);function rD(e){const{base_id:t,composed_wc_id_map:n,most_recent_action_id:i,wcomponents_by_id:o,list_type:s,creation_context:r,knowledge_view_id:a}=e;return function(){if(t===void 0)throw new Error("No base_id defined in click for AddNewActionButton");const l=N0(n,i,o);let d=[];const u=s==="todo",f=s==="in_progress",m=s==="done";if((f||m)&&(d=al({existing_value_possibilities:void 0,orig_values_and_prediction_sets:[],base_id:t,creation_context:r,action_value_possibility_id:ge.action_in_progress}),m)){let v=new Date;const g=3600*1e3;v=new Date(v.getTime()-g),d[0].datetime.value=v}m&&(d=al({existing_value_possibilities:void 0,orig_values_and_prediction_sets:d,base_id:t,creation_context:r,action_value_possibility_id:ge.action_completed}));const h=E0(void 0,d);On({wcomponent:{base_id:t,type:"action",values_and_prediction_sets:d,value_possibilities:h,todo_index:u?new Date().getTime():void 0},add_to_knowledge_view:{id:a,position:l}})}}var Vd={},_D=Q;Object.defineProperty(Vd,"__esModule",{value:!0});var D0=Vd.default=void 0,aD=_D(Z()),cD=ee(),lD=(0,aD.default)((0,cD.jsx)("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"}),"ArrowBack");D0=Vd.default=lD;var Fd={},dD=Q;Object.defineProperty(Fd,"__esModule",{value:!0});var O0=Fd.default=void 0,uD=dD(Z()),pD=ee(),mD=(0,uD.default)((0,pD.jsx)("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"}),"ArrowForward");O0=Fd.default=mD;var zd={},fD=Q;Object.defineProperty(zd,"__esModule",{value:!0});var Rs=zd.default=void 0,hD=fD(Z()),vD=ee(),gD=(0,hD.default)((0,vD.jsx)("path",{d:"m4 12 1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z"}),"ArrowUpward");Rs=zd.default=gD;var Ld={},wD=Q;Object.defineProperty(Ld,"__esModule",{value:!0});var M0=Ld.default=void 0,bD=wD(Z()),yD=ee(),kD=(0,bD.default)((0,yD.jsx)("path",{d:"M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"}),"Description");M0=Ld.default=kD;function Bd(e){const{position:t,extra_styles:n,display:i,extra_css_class:o,title:s,children:r}=e,{on_pointer_enter:a,on_pointer_leave:c,on_pointer_down:l,on_pointer_up:d,on_click:u}=e,f={...t,position:t?"absolute":"relative",display:i===void 0||i?"":"none",...n},h=`node ${l||d||u||a||c?"mouseable":""} ${o||""}`;return _("div",{...e.extra_args,className:h,style:f,title:s,onPointerDown:l||(v=>{v.stopImmediatePropagation(),v.preventDefault()}),onPointerUp:d,onClick:u,onPointerEnter:a,onPointerLeave:c,onContextMenu:v=>{v.preventDefault()},children:r})}function xD(e){let{opacity:t}=e;const n={display:e.hidden?"none":"",opacity:t};e.unlimited_width&&(n.maxWidth="initial");const i={boxShadow:e.glow?`${e.glow} 0px 0px 10px`:"",backgroundColor:e.color,...e.extra_styles_for_node_main_content},{pointerupdown_on_connection_terminal:o=()=>{}}=e,s=" connectable_canvas_node "+(e.extra_css_class||"");return _(Bd,{position:e.position,on_pointer_down:e.on_pointer_down,on_pointer_up:e.on_pointer_up,on_click:e.on_click,on_pointer_enter:e.on_pointer_enter,on_pointer_leave:e.on_pointer_leave,extra_css_class:s,extra_styles:n,extra_args:e.extra_args,children:[_(ak,{className:"node_main_content",variant:"outlined",style:i,children:[e.cover_image&&_(ck,{component:"img",image:e.cover_image,className:"node_image_content",onContextMenu:r=>{r.stopImmediatePropagation()}}),_(lk,{style:{padding:16},children:e.node_main_content}),e.terminals.map(({type:r,style:a,label:c})=>_("div",{className:"connection_terminal",style:{...AD,...a},onPointerDown:l=>{l.stopPropagation(),o(r,"down")},onPointerUp:l=>{l.stopPropagation(),o(r,"up")},children:c}))]}),e.other_children]})}const ev=Jo*2,AD={width:ev,height:ev,borderRadius:Jo+1},SD={white:{r:255,g:255,b:255,a:1},white_a75:{r:255,g:255,b:255,a:.75}};function Tt(e){return e?`rgba(${e.r}, ${e.g}, ${e.b}, ${e.a})`:""}function q0(e){if(!e)return{r:0,g:0,b:0,a:1};const n=e.r+e.g+e.b<383?255:0;return{r:n,g:n,b:n,a:1}}function CD(e){if(e)return{r:e.r/2,g:e.g/2,b:e.b/2,a:e.a}}function $D(e,{wcomponent_id:t}){const{wcomponents_by_id:n,knowledge_views_by_id:i}=e.specialised_objects;return{wcomponent:n[t],wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:at(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}}const jD=j($D);function TD(e){const{wcomponent:t}=e,n=t?Qe({wcomponent:t,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}):"&lt;Label not found&gt;";return _("div",{className:"label_v2",style:{backgroundColor:Tt((t==null?void 0:t.label_color)||SD.white_a75),color:Tt(q0(t==null?void 0:t.label_color))},children:_(ji,{options:Es,children:n})})}const PD=jD(TD);function ND(e){return _("div",{style:{display:"flex",flexWrap:"wrap"},children:(e.label_ids||[]).map(t=>_(PD,{wcomponent_id:t}))})}function rn(e){const t="⚠";return _("span",{style:{backgroundColor:e.backgroundColor||"yellow",color:"black"},title:e.message,children:t})}function ED(e,t){const n=Se(),i=n.getState(),{selected_wcomponent_ids_set:o}=i.meta_wcomponents;let s=new Set(o);if(!s.has(e)){s=new Set([e]);const d=x.meta_wcomponents.clicked_wcomponent({id:e});n.dispatch(d)}const r=x.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:s});n.dispatch(r);let a;const c=H.canvas.sub("canvas_move",d=>{a=ds({left:d.x-t.x,top:t.y-d.y}),H.canvas.pub("canvas_node_drag_relative_position",a)}),l=H.canvas.sub("canvas_pointer_up",()=>{if(a){const u=x.specialised_object.bulk_edit_knowledge_view_entries({wcomponent_ids:Array.from(s),change_left:a.left,change_top:a.top});n.dispatch(u)}const d=x.meta_wcomponents.set_wcomponent_ids_to_move({wcomponent_ids_to_move:new Set});n.dispatch(d),c(),l()})}function to(e){return e==="counterfactualv2"?"counterfactual":e==="statev2"?"state":e.replaceAll("_"," ")}function V0(e){const{wcomponent_id:t,shift_or_control_keys_are_down:n,change_route:i,clicked_wcomponent:o,clear_selected_wcomponents:s,is_current_item:r}=e;return a=>{a.stopImmediatePropagation(),a.preventDefault(),o({id:t}),n?i({route:"wcomponents",sub_route:"wcomponents_edit_multiple",item_id:null}):r?(i({route:"wcomponents",sub_route:null,item_id:null}),s()):i({route:"wcomponents",sub_route:null,item_id:t})}}function Ud(e,t){return t*(ze/e)}function F0(e,t,n){return e+Ud(t,n)}function z0(e,t,n){return e-Ud(t,n)}var Wd={},ID=Q;Object.defineProperty(Wd,"__esModule",{value:!0});var L0=Wd.default=void 0,RD=ID(Z()),DD=ee(),OD=(0,RD.default)((0,DD.jsx)("path",{d:"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"}),"Search");L0=Wd.default=OD;const MD="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z";function qD(e){return _(Et,{...e,d:MD,svg_elements:[_("line",{x1:"0",x2:"13",y1:"18",y2:"18",stroke:"white","stroke-width":"6"}),_("line",{x1:"6.5",x2:"6.5",y1:"11.5",y2:"24",stroke:"white","stroke-width":"6"}),_("line",{x1:"1.5",x2:"11.5",y1:"18",y2:"18","stroke-width":"3"}),_("line",{x1:"6.5",x2:"6.5",y1:"13",y2:"23","stroke-width":"3"})]})}const VD=(e,t)=>{const n=me(e,t.wcomponent_id),o=(Jy(e,t.wcomponent_id)||[]).find(s=>e.specialised_objects.knowledge_views_by_id[s]);return{wcomponent:n,kvwc:e.specialised_objects.knowledge_views_by_id[t.wcomponent_id],subview_id:e.routing.args.subview_id,nested_knowledge_view_ids_entry:e.derived.nested_knowledge_view_ids.map[t.wcomponent_id],presenting:e.display_options.consumption_formatting,any_overlapping_wcomponents_have_kvs:o}},FD=j(VD);function zD(e){let{kvwc:t}=e;const{is_highlighted:n,nested_knowledge_view_ids_entry:i,any_overlapping_wcomponents_have_kvs:o}=e,s=!e.presenting,r=!t&&(e.presenting||s&&!n&&!o),a=e.subview_id===e.wcomponent_id,c=i&&i.parent_id,l=s&&!!e.wcomponent,d=a?c?2:-1:t?1:l?3:-2,u=a&&!c,f="node_handle explore "+(r?" hidden ":"")+(t?" has_knowledge_view ":"")+(u?" current_but_no_parent ":"")+(d===3?" will_create_on_click ":"")+(d===-2?" error_disabled ":"");return _("div",{className:f,title:d===2?"Navigate up to parent":d===-1?"No parent to navigate up to":d===1?"Navigate to knowledge view":d===3?"Create then navigate to knowledge view":d===-2?"Error: could not find the component to create a new knowledge view for":"Unknown error",onClick:h=>{h.preventDefault(),h.stopImmediatePropagation();const v=Se();if(a)c&&Tu(c,v);else{if(!t){const g=LD(e,v);if(!g)return;t=g,v.dispatch(x.specialised_object.upsert_knowledge_view({knowledge_view:t}))}Tu(t.id,v)}},children:a?_(Rs,{}):d===3?_(qD,{}):_(L0,{})})}const Hd=FD(zD);function LD(e,t){if(!e.wcomponent)return!1;const n=t.getState(),i=xi(n),o={[e.wcomponent.id]:e.wcomponent_current_kv_entry||i},s=Qe({wcomponent:e.wcomponent,wc_id_to_counterfactuals_map:at(n),text_type:fe.plain,wcomponents_by_id:n.specialised_objects.wcomponents_by_id,knowledge_views_by_id:n.specialised_objects.knowledge_views_by_id,created_at_ms:n.routing.args.created_at_ms,sim_ms:n.routing.args.sim_ms}),a=tn(s)||`Knowledge view for ${e.wcomponent.id} created: ${ss()}`,c=ne(n),l=c&&c.id,d={id:e.wcomponent.id,base_id:e.wcomponent.base_id,wc_id_map:o,title:a,sort_type:l?"normal":"hidden",parent_knowledge_view_id:l},{creation_context:u}=n;return We(d,u)}const BD="M14 2H4c-1.11 0-2 .9-2 2v10h2V4h10V2zm4 4H8c-1.11 0-2 .9-2 2v10h2V8h10V6zm2 4h-8c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h8c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2z";function UD(e){return _(Et,{...e,d:BD})}const WD=(e,t)=>({overlapping_wcomponent_ids:Jy(e,t.wcomponent_id)}),HD={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent,change_route:x.routing.change_route},GD=j(WD,HD);function KD(e){const{overlapping_wcomponent_ids:t,set_highlighted_wcomponent:n,change_route:i}=e,o=(t==null?void 0:t.length)||0,r="node_handle overlapping_nodes"+(o===0?" hidden ":""),a=o?`${o-1} other nodes at this location`:"",c=z(()=>{if(t)return l=>{l.stopImmediatePropagation(),n({id:e.wcomponent_id,highlighted:!1}),i({item_id:t[0]})}},[i,t]);return _("div",{className:r,title:a,onClick:c,children:_(UD,{fontSize:"small"})})}const YD=GD(KD);function JD(e){return _("div",{className:"handles",children:[_(XD,{show_move_handle:e.show_move_handle,user_requested_node_move:e.user_requested_node_move}),_(Hd,{wcomponent_id:e.wcomponent_id,wcomponent_current_kv_entry:e.wcomponent_current_kv_entry,is_highlighted:e.is_highlighted}),_(YD,{wcomponent_id:e.wcomponent_id})]})}function XD(e){const{show_move_handle:t,user_requested_node_move:n}=e,i="node_handle movement highlight_on_hover";return t?_("div",{className:i,onPointerDown:s=>{s.stopPropagation();const r=ZD(s);n(r)},children:"✥"}):_("div",{className:i,children:" "})}function ZD(e){const t=Se().getState(),{x:n,y:i,zoom:o}=t.routing.args;return{x:F0(n,o,e.clientX),y:z0(i,o,e.clientY)}}function B0(e){const{VAP_set:t,VAP_set_id_to_counterfactual_v2_map:n,knowledge_views_by_id:i}=e,o=(n==null?void 0:n[t.id])||[],s={};return o.forEach(r=>{const{target_VAP_id:a}=r;if(!a)return;const c=xA(r.id,i),l={counterfactual_v2_id:r.id,counterfactual_has_knowledge_view:c},d=s[a]||[];d.push(l),s[a]=d}),s}function wo(e){var a;const t=Wj(e.VAP_set,e.VAPs_represent),n=(a=t.shared_entry_values)==null?void 0:a.conviction;let i=0;const o=Bl(e.wcomponent),s=t.entries.map(c=>{const l=b2(c,e.VAPs_represent),d=Pb(l,o),u=n??c.conviction,f=c.probability*u;return i+=f,{VAP_id:c.id,value_id:c.value_id,parsed_value:l,value_text:d,certainty:f}}),r=ue(s,c=>c.certainty,ce.descending);return Gj(i,r)}const QD="m9.78 11.16-1.42 1.42c-.68-.69-1.34-1.58-1.79-2.94l1.94-.49c.32.89.77 1.5 1.27 2.01zM11 6 7 2 3 6h3.02c.02.81.08 1.54.19 2.17l1.94-.49C8.08 7.2 8.03 6.63 8.02 6H11zm10 0-4-4-4 4h2.99c-.1 3.68-1.28 4.75-2.54 5.88-.5.44-1.01.92-1.45 1.55-.34-.49-.73-.88-1.13-1.24L9.46 13.6c.93.85 1.54 1.54 1.54 3.4v5h2v-5c0-2.02.71-2.66 1.79-3.63 1.38-1.24 3.08-2.78 3.2-7.37H21z";function U0(e){return _(Et,{...e,d:QD})}const W0="darkorange";const e6=(e,t)=>{let n=me(e,t.judgement_or_objective_id);pt(n)||(n=void 0);const i=ne(e),o=i?i.composed_wc_id_map[t.judgement_or_objective_id]:void 0;return{judgement_wcomponent:n,position:o}},t6=j(e6);function n6(e){const{judgement_or_objective_id:t,judgement_wcomponent:n,position:i,target_VAPs_represent:o,value:s}=e;if(!n)return null;const r=Zy({judgement_wcomponent:n,target_VAPs_represent:o,value:s});return _(yd,{judgement:r,judgement_trend_manual:e.hide_judgement_trend?void 0:n.judgement_trend_manual,judgement_or_objective_id:t,position:i,size:e.hide_judgement_trend?"small":"medium"})}const i6=t6(n6);const o6=e=>{const t=ne(e);return{active_judgement_or_objective_ids_by_target_id:t==null?void 0:t.active_judgement_or_objective_ids_by_target_id,active_judgement_or_objective_ids_by_goal_or_action_id:t==null?void 0:t.active_judgement_or_objective_ids_by_goal_or_action_id}},s6=j(o6);function r6(e){const{active_judgement_or_objective_ids_by_target_id:t,active_judgement_or_objective_ids_by_goal_or_action_id:n,target_VAPs_represent:i,value:o}=e,s=z(()=>[...(t||{})[e.wcomponent.id]||[],...(n||{})[e.wcomponent.id]||[]],[t,n]),r="node_judgements_container ";return o===void 0||i===void 0?_("div",{className:r,children:s.map(a=>_(i0,{judgement_or_objective_id:a,hide_judgement_trend:e.hide_judgement_trend}))}):_("div",{className:r,children:s.map(a=>_(i6,{judgement_or_objective_id:a,hide_judgement_trend:e.hide_judgement_trend,target_VAPs_represent:i,value:o}))})}const H0=s6(r6);function G0(e){const{VAP_visual:t,show_judgements:n,counterfactual_VAP_set:i,VAP_id_to_counterfactuals_info_map:o}=e,s={},r=se(e.wcomponent,s),a=t.certainty*100,c=`${a}%`,l=Math.round(a);let d=100;l<100&&(d=l*1.25);const u=o[t.VAP_id]||[],f=i.has_any_counterfactual_applied?"warning_color":"";return _("div",{className:`value_and_prediction prob-${l} ${f}`,style:{fontSize:`${d}%`,maxHeight:c,minHeight:c},children:[t.value_text,n&&_(H0,{wcomponent:e.wcomponent,target_VAPs_represent:r,value:t.parsed_value,hide_judgement_trend:!0}),u.map(m=>_(_6,{any_active:i.has_any_counterfactual_applied,counterfactual:m,active_counterfactual_v2_id:i.active_counterfactual_v2_id}))]})}function _6(e){const i={fontSize:"25px",color:e.counterfactual.counterfactual_v2_id===e.active_counterfactual_v2_id?W0:e.any_active?"white":"#ffc965",verticalAlign:"middle",fontWeight:"bold",width:"20px"};return _("span",{onPointerDown:o=>o.stopImmediatePropagation(),onClick:o=>o.stopImmediatePropagation(),style:{display:"inline-flex"},children:[" ",_(De,{route:void 0,sub_route:void 0,item_id:e.counterfactual.counterfactual_v2_id,args:void 0,extra_css_style:i,children:_(U0,{fontSize:"small"})}),e.counterfactual.counterfactual_has_knowledge_view&&_("span",{style:{fontSize:14},children:_(Hd,{wcomponent_id:e.counterfactual.counterfactual_v2_id||"",is_highlighted:!0})})," "]})}function a6(e){const[t,n]=I(!1),{counterfactual_VAP_set:i,VAP_id_to_counterfactuals_info_map:o}=e,s={},r=se(e.wcomponent,s),a=wo({...e,VAP_set:i,VAPs_represent:r}),c=a.filter(l=>l.certainty>0);return _(E,{height:"100%",maxWidth:"100%",minWidth:100,overflow:"hidden",position:"relative",flexDirection:"column",justifyContent:"flex-end",alignItems:"stretch",alignContent:"stretch",className:`value_and_prediction_set_summary items-${a.length} visible-${c.length}`,onPointerOver:()=>n(!0),onPointerLeave:()=>n(!1),children:a.map((l,d)=>{const u=t||d===0;return _(G0,{wcomponent:e.wcomponent,VAP_visual:l,show_judgements:u,counterfactual_VAP_set:i,VAP_id_to_counterfactuals_info_map:o})})})}const c6=(e,t)=>({VAP_set_id_to_counterfactual_v2_map:vo(e,t.wcomponent.id),knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),l6=j(c6);function d6(e){const{wcomponent:t,VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o}=e,s=fs({VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i}),r=B0({VAP_set:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o});return _(a6,{wcomponent:t,counterfactual_VAP_set:s,VAP_id_to_counterfactuals_info_map:r})}const Gd=l6(d6);function K0(e){const{values_and_prediction_sets:t=[],created_at_ms:n,sim_ms:i}=e,{present_item:o}=xn({items:t,created_at_ms:n,sim_ms:i});return o}function Y0(e){if(!Rn(e.wcomponent))return null;const t=K0({...e,values_and_prediction_sets:e.wcomponent.values_and_prediction_sets});return t?_(Gd,{wcomponent:e.wcomponent,VAP_set:t}):null}function J0(e){const{selector:t,target_wcomponent:n}=e,{target_VAP_set_id:i,target_value_id_type:o,target_value:s}=t||{},r=u6(n,i),c=se(n,{}),l=[];return r.forEach(u=>{wo({VAP_set:u,VAPs_represent:c,wcomponent:n}).forEach(({value_id:f,value_text:m})=>l.push({value_id:f,value:m}))}),Bv(l,n.value_possibilities).map(u=>{const f=X0({target_value_id_type:o,target_value:s,value_text:u.value,value_id:u.id});return{...u,selected:f}})}function u6(e,t){let n=e.values_and_prediction_sets||[];return t&&(n=n.filter(({id:i})=>i===t)),n}function X0(e){const{target_value_id_type:t,target_value:n,value_text:i,value_id:o}=e;let s;return t==="value_string"?s=n===i:t==="id"&&(s=n===o),s}function vi(e){if(e===void 0)return"";const t=Ve(e,0,1)*100;return t.toPrecision(t<98?2:3).replace(/\.0$/,"")}const p6=(e,t)=>{const{target_wcomponent_id:n}=t.wcomponent,{wcomponents_by_id:i}=e.specialised_objects,o=i[n||""],s=Ge(o)&&o,r=vo(e,n);return{target_wcomponent:s,wcomponents_by_id:i,VAP_set_id_to_counterfactual_v2_map:r,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}},m6=j(p6);function f6(e){const{target_wcomponent:t,wcomponents_by_id:n,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o}=e;if(!t)return null;const{selector:s}=e.wcomponent,{target_VAP_set_id:r,target_value_id_type:a,target_value:c}=s||{},l=a!==void 0&&c!==void 0;let d=t.values_and_prediction_sets||[];const u=se(t,n);if(r===void 0)return l?null:_(Y0,{wcomponent:t,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});d=d.filter(({id:w})=>w===r),d=Jw(d,e.created_at_ms);const f=d[0];if(!f)return _("div",{children:"Invalid configuration"});if(!l)return _(Gd,{wcomponent:t,VAP_set:f});const m=fs({VAP_set:f,VAP_set_id_to_counterfactual_v2_map:i}),h=B0({VAP_set:f,VAP_set_id_to_counterfactual_v2_map:i,knowledge_views_by_id:o});let g=wo({...e,VAP_set:m,VAPs_represent:u}).find(({value_id:w,value_text:k})=>X0({target_value_id_type:a,target_value:c,value_id:w,value_text:k}));if(!g)return _("div",{children:"Invalid configuration"});let{value_text:b}=g;return b=` ${vi(g.certainty)}%`,g={...g,value_text:b,certainty:1},_(G0,{wcomponent:t,VAP_visual:g,show_judgements:!0,counterfactual_VAP_set:m,VAP_id_to_counterfactuals_info_map:h})}const h6=m6(f6),v6="m14.5 14.2 2.9 1.7-.8 1.3L13 15v-5h1.5v4.2zM22 14c0 4.41-3.59 8-8 8-2.02 0-3.86-.76-5.27-2H4c-1.15 0-2-.85-2-2V9c0-1.12.89-1.96 2-2v-.5C4 4.01 6.01 2 8.5 2c2.34 0 4.24 1.79 4.46 4.08.34-.05.69-.08 1.04-.08 4.41 0 8 3.59 8 8zM6 7h5v-.74C10.88 4.99 9.8 4 8.5 4 7.12 4 6 5.12 6 6.5V7zm14 7c0-3.31-2.69-6-6-6s-6 2.69-6 6 2.69 6 6 6 6-2.69 6-6z";function g6(e){return _(Et,{...e,d:v6})}const w6="M8 18h3v3h2v-3h3l-4-4-4 4zm8-12h-3v-3h-2v3h-3l4 4 4-4zm-12 5v2h16v-2z";function b6(e){return _(Et,{...e,d:w6})}const y6=(e,t)=>{const{target_wcomponent_id:n}=t.wcomponent,i=e.specialised_objects.wcomponents_by_id[n||""];return{target_wcomponent:Ge(i)&&i,presenting:e.display_options.consumption_formatting}},k6=j(y6);function x6(e){const{target_wcomponent:t,presenting:n}=e;if(!t||n)return null;const{selector:i}=e.wcomponent,{target_VAP_set_id:o,target_value_id_type:s,target_value:r}=i||{},a=t.values_and_prediction_sets||[],c=o===void 0?0:a.find(({id:m})=>m===o)?1:2,l=J0({selector:i,target_wcomponent:t}),d=s===void 0||r===void 0?0:l.find(({selected:m})=>m)?1:2,u=tv(c),f=tv(d);return _("div",{className:"sub_state_type_indicators",children:[_(g6,{className:u,title:"Specific Time "+nv(c),style:{height:"30px"}}),_(b6,{className:f,title:"Specific Possibility "+nv(d),style:{height:"30px"}})]})}const A6=k6(x6);function tv(e){return e===1?" sub_state_type_status__set ":e===0?" sub_state_type_status__not_set ":" sub_state_type_status__invalid "}function nv(e){return e===1?"Set":e===0?"Not set":"Invalid"}const cl={r:175,g:175,b:175,a:.11};const iv=ot,ov=ot,S6=e=>{var t;return{is_editing:!e.display_options.consumption_formatting,frame_is_resizing:e.meta_wcomponents.frame_is_resizing,knowledge_view_id:(t=Be(e))==null?void 0:t.id}},C6={set_frame_is_resizing:x.meta_wcomponents.set_frame_is_resizing,upsert_knowledge_view_entry:x.specialised_object.upsert_knowledge_view_entry},$6=j(S6,C6);function j6(e){const{wcomponent_id:t,kv_entry:n,is_editing:i,frame_is_resizing:o,knowledge_view_id:s,set_frame_is_resizing:r}=e;if((n==null?void 0:n.frame_width)===void 0||(n==null?void 0:n.frame_height)===void 0)return null;const[a,c]=I(void 0),[l,d]=I(void 0),u=v=>g=>{g.stopImmediatePropagation(),g.preventDefault(),r({frame_is_resizing:!0}),c(v)},f=z(()=>u(!0),[]),m=z(()=>u(!1),[]);_e(()=>H.canvas.sub("canvas_move",v=>{if(a===void 0)return;const g=a?n.frame_width:zt(v.x-n.left+ov),b=a?zt(-v.y-n.top+iv):n.frame_height;d({...n,frame_width:g,frame_height:b})})),_e(()=>H.canvas.sub("canvas_pointer_up",()=>{!o||!s||l&&(e.upsert_knowledge_view_entry({wcomponent_id:t,knowledge_view_id:s,entry:l}),d(void 0),r({frame_is_resizing:!1}),c(void 0))}));const h=l||n;return _("div",{className:"wcomponent_background_frame",style:{top:h.top-iv,left:h.left-ov,width:h.frame_width,height:h.frame_height,backgroundColor:Tt(h.frame_color||cl),borderColor:Tt(CD(h.frame_color||cl))},children:[i&&_("div",{className:"editable_edge editable_edge_bottom",onPointerDown:f}),i&&_("div",{className:"editable_edge editable_edge_right",onPointerDown:m})]})}const T6=$6(j6);function P6(e){const{wcomponent:t,created_at_ms:n,sim_ms:i}=e,{is_valid:o}=Ol({wcomponent:t,created_at_ms:n,sim_ms:i})||Dl();return{values_string:o?"Valid":"Invalid",counterfactual_applied:void 0,uncertain:void 0,derived__using_values_from_wcomponent_ids:void 0}}function Z0(e){const{UI_value:t}=e,{values_string:n,counterfactual_applied:i,uncertain:o,derived__using_values_from_wcomponent_ids:s}=t,r=i||!!(s!=null&&s.length),a=`value ${r?"assumption":""} ${o?"uncertain":""}`;let c="Current value";return r&&(c+=" is an assumption"),r&&o&&(c+=" and"),o&&(c+=" has uncertainty"),_(Re,{children:[_(Me,{className:a,title:c,"aria-label":c,children:_("span",{children:n})}),(s||[]).map(l=>_(R6,{uuid:l}))]})}const N6=(e,t)=>{const{composed_wcomponents_by_id:n}=e.derived,i=n[t.uuid],o=at(e),s=e.specialised_objects.knowledge_views_by_id;return{title:i&&Qe({wcomponent:i,text_type:fe.plain,wcomponents_by_id:n,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms})}},E6=j(N6);function I6(e){const{uuid:t,title:n}=e;let i="a different component";n!=null&&n.trim()&&(i=`'${tn(n.trim())}'`);const o="Value derived from "+i;return _(De,{route:void 0,sub_route:void 0,item_id:t,args:void 0,children:_(U0,{className:"material-icons",title:o,style:{fill:W0,height:"16px"}})},t)}const R6=E6(I6),D6=e=>{const{created_at_ms:t,sim_ms:n}=e.routing.args;return{created_at_ms:t,sim_ms:n}},O6=j(D6);function M6(e){const t=P6(e);return _("div",{className:"node_validity_value_container",children:_(Z0,{UI_value:t})})}const q6=O6(M6),Q0=!1,V6=(e,t)=>{const{id:n,always_show:i=Q0}=t,o=e.global_keys.derived.shift_or_control_down,s=bA(e,n),{current_composed_knowledge_view:r}=e.derived,a=e.derived.composed_wcomponents_by_id[n],c=a&&r&&a.base_id!==r.base_id;let l=!1,d,u=new Set;r&&(l=!!(r.active_judgement_or_objective_ids_by_target_id[n]||r.active_judgement_or_objective_ids_by_goal_or_action_id[n]),d=r.composed_wc_id_map[n],u=r.filters.wc_ids_excluded_by_filters);const f=e.meta_wcomponents.selected_wcomponent_ids_set.has(n),{created_at_ms:m,sim_ms:h}=e.routing.args,v=e.display_options.derived_validity_filter,g=i||!a?1:ri({wcomponent:a,kv_entry:d,created_at_ms:m,sim_ms:h,validity_filter:v,is_selected:f,wc_ids_excluded_by_filters:u});return{on_current_knowledge_view:s,kv_entry:d,derived_composed_wcomponent:a,kv_from_different_base:c,wc_id_to_counterfactuals_map:at(e),knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,is_current_item:e.routing.item_id===n,is_selected:f,is_highlighted:e.meta_wcomponents.highlighted_wcomponent_ids.has(n),shift_or_control_keys_are_down:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,is_editing:!e.display_options.consumption_formatting,validity_value:g,certainty_formatting:e.display_options.derived_certainty_formatting,focused_mode:e.display_options.focused_mode,have_judgements:l,node_is_moving:e.meta_wcomponents.wcomponent_ids_to_move_set.has(n),display_time_marks:e.display_options.display_time_marks,connected_neighbour_is_highlighted:e.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(n)}},F6={clicked_wcomponent:x.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:x.meta_wcomponents.clear_selected_wcomponents,change_route:x.routing.change_route,set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent,pointerupdown_on_component:x.meta_wcomponents.pointerupdown_on_component,pointerupdown_on_connection_terminal:x.meta_wcomponents.pointerupdown_on_connection_terminal,set_wcomponent_ids_to_move:x.meta_wcomponents.set_wcomponent_ids_to_move,request_searching_for_wcomponents_by_id_in_any_base:x.sync.request_searching_for_wcomponents_by_id_in_any_base},z6=j(V6,F6);function L6(e){const{id:t,is_on_canvas:n=!0,always_show:i=Q0,is_editing:o,derived_composed_wcomponent:s,kv_entry:r,kv_from_different_base:a,wc_id_to_counterfactuals_map:c,knowledge_views_by_id:l,is_current_item:d,is_selected:u,is_highlighted:f,shift_or_control_keys_are_down:m,validity_value:h,created_at_ms:v,sim_ms:g,certainty_formatting:b,clicked_wcomponent:w,clear_selected_wcomponents:k}=e,y={},{change_route:S,set_highlighted_wcomponent:T}=e;if(_e(()=>{s||e.request_searching_for_wcomponents_by_id_in_any_base({ids:[t]})},[!!s]),!r&&!i)return _("div",{children:["Could not find knowledge view entry for id ",t]});const $=r||{left:0,top:0},[R,C]=I(void 0);if(_e(()=>{if(!e.node_is_moving)return;const et=H.canvas.sub("throttled_canvas_node_drag_relative_position",Un=>{const Ti={...$};Ti.left+=Un.left,Ti.top+=Un.top,C(Ti)});return()=>{C(void 0),et()}},[e.node_is_moving]),!h)return null;const O=Ty({is_editing:o,certainty:h,is_highlighted:f,connected_neighbour_is_highlighted:e.connected_neighbour_is_highlighted,is_selected:u,is_current_item:d,certainty_formatting:b,focused_mode:e.focused_mode}),M=e.node_is_moving?.3:O,P=V0({wcomponent_id:t,clicked_wcomponent:w,clear_selected_wcomponents:k,shift_or_control_keys_are_down:m,change_route:S,is_current_item:d}),L=e.node_is_moving?[]:[_(JD,{show_move_handle:n&&o&&f,user_requested_node_move:et=>{ED(t,et)},wcomponent_id:t,wcomponent_current_kv_entry:$,is_highlighted:f})],J=s?Qe({wcomponent:s,wcomponents_by_id:y,knowledge_views_by_id:l,wc_id_to_counterfactuals_map:c,created_at_ms:v,sim_ms:g}):"&lt;Not found&gt;",Ke=o,ct={transform:`scale(${$.s&&n?$.s:1})`},Ln=f?"orange":(u||d)&&"blue",Kt=U6({wcomponent:s,wcomponents_by_id:y,sim_ms:g,created_at_ms:v,display_time_marks:e.display_time_marks}),gt=` wcomponent_canvas_node  wcomponent_${t} `+(o?e.on_current_knowledge_view?" node_on_kv ":" node_on_foundational_kv ":"")+(e.node_is_moving?" node_is_moving ":"")+(f?" node_is_highlighted ":"")+(d?" node_is_current_item ":"")+(u?" node_is_selected ":"")+(s?` node_is_type_${s.type} `:"")+(Ke?" compact_title ":"")+Kt.font+Kt.background;let ko=!1,xo=!1;s&&(ko=qv(s)&&o||yi(s)&&d,xo=o&&Ge(s)||!s.hide_state&&(ki(s)||pt(s)||Ho(s)&&(s.objective_ids||[]).length>0||e.have_judgements));const Bn=s?(o||!s.hide_state)&&so(s)&&s:!1,Vs=B6({is_on_canvas:n,is_editing:o,is_highlighted:f}),Fs=et=>{et.stopImmediatePropagation(),et.preventDefault(),e.pointerupdown_on_component({up_down:"down",wcomponent_id:t})},zs=et=>{et.stopImmediatePropagation(),et.preventDefault(),e.pointerupdown_on_component({up_down:"up",wcomponent_id:t})},Ls=(et,Un)=>e.pointerupdown_on_connection_terminal({terminal_type:et,up_down:Un,wcomponent_id:t}),Ao=n?R||$:void 0,Bs=z(()=>W6(s),[s]);return _("div",{children:[_(T6,{wcomponent_id:t,kv_entry:Ao}),_(xD,{position:Ao,cover_image:s==null?void 0:s.summary_image,node_main_content:_("div",{children:[!(s!=null&&s.summary_image)&&_("div",{className:"background_image"}),_("div",{className:"node_title",children:[r===void 0&&o&&_("span",{children:[_(rn,{message:"Missing from this knowledge view"})," "]}),a&&o&&_("span",{children:[_(rn,{message:"Is from a different base to this knowledge view"})," "]}),(o||!(s!=null&&s.hide_title))&&_(ji,{options:{...Es,forceInline:!0},children:J})]}),s&&ko&&_("div",{className:"node_validity_container",children:[o&&_("div",{className:"description_label",children:"validity"}),_(q6,{wcomponent:s})]}),s&&xo&&_("div",{className:"node_state_container",children:[o&&_("div",{className:"description_label",children:"state  "}),_(H0,{wcomponent:s,hide_judgement_trend:!1}),_("div",{className:"value_and_prediction_summary",children:_(Y0,{wcomponent:s,created_at_ms:v,sim_ms:g})})]}),Bn&&_("div",{className:"node_sub_state_container",children:_("div",{className:"value_and_prediction_summary",children:_(h6,{wcomponent:Bn,created_at_ms:v,sim_ms:g})})}),Bn&&_(A6,{wcomponent:Bn}),s&&o&&_("div",{className:"description_label",children:to(s.type)}),_("div",{style:{display:"flex"},title:s!=null&&s.description.trim()?"Further details are included":void 0,children:[(s==null?void 0:s.description.trim())&&_(M0,{className:"description_icon",fontSize:"small",color:"disabled"}),s&&_(ND,{label_ids:Bs})]})]}),extra_css_class:gt,extra_styles_for_node_main_content:ct,opacity:M,unlimited_width:!1,glow:Ln,on_click:P,on_pointer_enter:()=>T({id:t,highlighted:!0}),on_pointer_leave:()=>T({id:t,highlighted:!1}),terminals:Vs,on_pointer_down:Fs,on_pointer_up:zs,pointerupdown_on_connection_terminal:Ls,other_children:L})]})}const gi=z6(L6),Ic=[],e1=[];Yk.forEach(e=>{Jk.forEach(t=>{const n={attribute:e,side:t},i=qb(n),o=n.attribute.slice(0,1).toUpperCase();e1.push({type:n,style:i,label:o})})});function B6(e){return!e.is_on_canvas||!e.is_editing||!e.is_highlighted?Ic:e1}function U6(e){let t="",n="";const{wcomponent:i,created_at_ms:o,sim_ms:s}=e;if(!i)return{background:" node_missing ",font:n};if(Le(i)){const r=Sn({wcomponent:i,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:o,sim_ms:s}),a=r.most_probable_VAP_set_values[0];r.any_uncertainty?t=" past_uncertain ":a&&(a.value_id===ge.action_completed||a.value_id===ge.action_failed||a.value_id===ge.action_rejected)&&(t=" past_certain ",n=" color_light ")}else{const r=Cl(i.id,e.wcomponents_by_id,o);if(r){const{temporal_uncertainty:a,certainty:c}=r,l=ut(a);l&&l.getTime()<s?c===1||c===void 0?(t=" past_certain ",n=" color_light "):t=" past_uncertain ":l||(c===1||c===void 0)&&(t=" past_certain ",n=" color_light ")}}return{background:t,font:n}}function W6(e){if(!e)return[];const t=[...e.label_ids||[]],n=new Set(t);return Le(e)&&e.parent_goal_or_action_ids&&e.parent_goal_or_action_ids.forEach(i=>{n.has(i)||(t.push(i),n.add(i))}),t}const H6=e=>({editing:!e.display_options.consumption_formatting}),G6={upsert_wcomponent:x.specialised_object.upsert_wcomponent},K6=j(H6,G6);function Y6(e){const{action:t,upsert_wcomponent:n}=e;return _("div",{className:"prioritisable_action",children:[_(gi,{id:t.id,is_on_canvas:!1,always_show:!0}),e.show_icebox_actions&&_("div",{className:"controls",children:_(pe,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:new Date().getTime()}}),children:_(O0,{})})}),e.show_todo_actions&&_("div",{className:"controls",children:[_(pe,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:new Date().getTime()}}),children:_(Rs,{})}),_(pe,{size:"medium",onClick:()=>n({wcomponent:{...t,todo_index:void 0}}),children:_(D0,{})})]})]})}const Oo=K6(Y6);function J6(e){return _(go,{main_content:_(tO,{})})}const X6=e=>{const{wcomponents_by_id:t}=e.specialised_objects;return{action_ids:GC(e),wcomponents_by_id:t,display_side_panel:e.controls.display_side_panel}},Z6={upsert_wcomponent:x.specialised_object.upsert_wcomponent},Q6=j(X6,Z6);function eO(e){const{action_ids:t,wcomponents_by_id:n}=e,[i,o]=I(5),[s,r]=I(void 0),a=Ie(void 0),c=Ie(void 0),l=z(()=>{const w=Rg(n,t).filter(Le);return ue(w,nO,ce.descending)},[t,n]),d=[],u=[],f=[],m=[],h=new Date().getTime();l.forEach(w=>{const y=Sn({wcomponent:w,VAP_set_id_to_counterfactual_v2_map:{},created_at_ms:h,sim_ms:h}).most_probable_VAP_set_values[0];(y==null?void 0:y.value_id)===ge.action_in_progress?f.push(w):(y==null?void 0:y.value_id)===ge.action_completed||(y==null?void 0:y.value_id)===ge.action_rejected||(y==null?void 0:y.value_id)===ge.action_failed?m.push(w):w.todo_index?u.push(w):d.push(w)});const v=m.length-i,g=ue(u,w=>w.todo_index||0,ce.descending),b=z(()=>{var y;return((y=(ue(l,Ae,ce.descending)||[])[0])==null?void 0:y.id)||""},[l]);return _("div",{className:`action_list_view_content ${s===void 0?"":"moving"}`,ref:w=>c.current=w||void 0,onPointerDown:w=>{const k=c.current;k&&(r({x:w.clientX,y:w.clientY}),a.current={left:k.scrollLeft,top:k.scrollTop})},onPointerMove:w=>{if(s===void 0||a.current===void 0||!c.current)return;const k=a.current.left-(w.clientX-s.x),y=a.current.top-(w.clientY-s.y);c.current.scroll(k,y)},onPointerUp:w=>r(void 0),onPointerLeave:w=>r(void 0),onPointerOut:w=>{let k=w.relatedTarget;k=R7(k,["action_list","action_list_view_content"]),!k&&r(void 0)},children:[_("div",{className:"action_list icebox",children:[_("h1",{children:["Icebox",_(Do,{list_type:"icebox",most_recent_action_id:b})]}),d.map(w=>_(Oo,{action:w,show_icebox_actions:!0},w.id))]}),_("div",{className:"action_list todo",children:[_("h1",{children:["Todo",_(Do,{list_type:"todo",most_recent_action_id:b})]}),g.map(w=>_(Oo,{action:w,show_todo_actions:!0},w.id))]}),_("div",{className:"action_list in_progress",children:[_("h1",{children:["In progress",_(Do,{list_type:"in_progress",most_recent_action_id:b})]}),f.map(w=>_(Oo,{action:w},w.id))]}),_("div",{className:"action_list done_or_rejected",children:[_("h1",{children:["Done",_(Do,{list_type:"done",most_recent_action_id:b})]}),m.slice(0,i).map(w=>_(Oo,{action:w},w.id)),v>0&&_("div",{style:{textAlign:"center",margin:40,cursor:"pointer"},onClick:()=>o(i+50),children:["... ",v," hidden ..."]})]}),_("div",{className:"side_panel_padding",style:{minWidth:e.display_side_panel?ii:0}})]})}const tO=Q6(eO);function nO(e){return e.modified_at?e.modified_at.getTime():Ae(e)}function iO(e){const{canvas_start_x:t,canvas_start_y:n,canvas_end_x:i,canvas_end_y:o}=e,s={left:t,top:-o,width:i-t,height:o-n};return _("div",{className:`selection_box color_${e.color}`,style:s})}const t1="graph_container",n1="graph_visuals_container",oO=900,sO=10,rO=e=>{const{x:t,y:n,zoom:i}=e.routing.args,o=e.global_keys.keys_down.has("Shift"),s=e.global_keys.keys_down.has("Control");return{zoom:i,x:t,y:n,shift_key_down:o,control_key_down:s}},_O=e=>({change_routing_args:t=>{let n={};t.zoom!==void 0&&(n.zoom=Math.round(Fl(t.zoom))),t.x!==void 0&&(n.x=Math.round(t.x)),t.y!==void 0&&(n.y=Math.round(t.y)),e(x.routing.change_route({args:n}))}}),aO=j(rO,_O);class cO extends Ev{constructor(n){super(n);ye(this,"manual_zoom_target");ye(this,"client_to_canvas",n=>Ud(this.props.zoom,n));ye(this,"client_to_canvas_x",n=>F0(this.props.x,this.props.zoom,n));ye(this,"client_to_canvas_y",n=>z0(this.props.y,this.props.zoom,n));ye(this,"on_pointer_down",n=>{if(H.canvas.pub("canvas_pointer_down",!0),n.button===2)return;const o=n.offsetX,s=n.offsetY,r={down:!0,area_select:this.props.shift_key_down,last_pointer_down_ms:new Date().getTime(),canvas_start_x:this.client_to_canvas_x(o),canvas_start_y:this.client_to_canvas_y(s),x_when_pointer_down:this.props.x,y_when_pointer_down:this.props.y,client_start_x:o,client_start_y:s};lO({zoom:this.props.zoom,current_pointer_state:this.state.pointer_state,new_pointer_state:r}),this.setState({pointer_state:r,canvas_current_x:r.canvas_start_x,canvas_current_y:r.canvas_start_y})});ye(this,"on_pointer_up",n=>{if(n==null||n.preventDefault(),H.canvas.pub("canvas_pointer_up",!0),this.state.pointer_state.area_select){const o=rv(this.state),s={start_x:o.canvas_start_x,start_y:o.canvas_start_y,end_x:o.canvas_end_x,end_y:o.canvas_end_y};H.canvas.pub("canvas_area_select",s)}const i={...this.state.pointer_state,down:!1,area_select:!1};this.setState({pointer_state:i,canvas_current_x:void 0,canvas_current_y:void 0})});ye(this,"on_pointer_leave",()=>{this.state.pointer_state.area_select||this.on_pointer_up()});ye(this,"on_pointer_move",n=>{if(H.canvas.pub("canvas_move",{x:this.client_to_canvas_x(n.offsetX),y:this.client_to_canvas_y(n.offsetY)}),!this.state.pointer_state.down)return;const i=n.offsetX,o=n.offsetY;if(this.state.pointer_state.area_select){const s=this.client_to_canvas_x(i),r=this.client_to_canvas_y(o);this.setState({canvas_current_x:s,canvas_current_y:r})}else{const s=this.state.pointer_state.client_start_x-i,r=this.state.pointer_state.client_start_y-o,a=this.state.pointer_state.x_when_pointer_down+this.client_to_canvas(s),c=this.state.pointer_state.y_when_pointer_down-this.client_to_canvas(r);this.props.change_routing_args({x:a,y:c})}});ye(this,"on_wheel",n=>{n.stopPropagation(),n.preventDefault();const i=n.deltaY,o=tj({zoom:this.props.zoom,wheel_change:i});if(o===this.props.zoom)return;const s=this.props.zoom/ze,{pointer_x:r,pointer_y:a}=dO(n,this.props,s),{offsetHeight:c,offsetWidth:l}=n.currentTarget,d=kb({old:this.props,new_zoom:o,pointer_x:r,pointer_y:a,client_height:c,client_width:l});this.props.change_routing_args({zoom:o,x:d.x,y:d.y}),this.manual_zoom_target=o});ye(this,"on_context_menu",n=>{n.stopPropagation(),n.preventDefault();const i=this.client_to_canvas_x(n.offsetX),o=this.client_to_canvas_y(n.offsetY);n.button===2&&H.canvas.pub("canvas_right_click",{x:i,y:o})});this.state={pointer_state:{down:!1,area_select:!1,last_pointer_down_ms:void 0,canvas_start_x:void 0,canvas_start_y:void 0,x_when_pointer_down:void 0,y_when_pointer_down:void 0,client_start_x:void 0,client_start_y:void 0},canvas_current_x:void 0,canvas_current_y:void 0}}render(){const{zoom:n}=this.props,i=n/ze,o=-1*this.props.x*i,s=this.props.y*i,r=ot*i,a=this.state.pointer_state.down,c=this.manual_zoom_target===n;this.manual_zoom_target=void 0;const l=a?0:c?.1:1,d={transition:`background-position ${l}s, background-size ${l}s`,backgroundPosition:`${o}px ${s}px`,backgroundSize:`${r}px ${r}px`},u={transition:`background-position ${l}s, background-size ${l}s`,backgroundPosition:`${o}px ${s}px`,backgroundSize:`${ui*i}px ${An*i}px`},f={transition:`transform ${l}s`,transform:`translate(${o}px,${s}px)`},m={transition:`transform ${l}s`,transformOrigin:"left top",transform:`scale(${i})`},h=(this.props.plain_background?"":"squared_background ")+(this.state.pointer_state.down?"graph_background_pointer_down ":"");return _("div",{style:{flexGrow:1},className:this.props.extra_class_names,children:_("div",{id:t1,className:h,style:d,onPointerDown:this.on_pointer_down,onPointerMove:this.on_pointer_move,onPointerUp:this.on_pointer_up,onPointerLeave:this.on_pointer_leave,onWheel:this.on_wheel,onDragOver:v=>{v.preventDefault(),v.dataTransfer.dropEffect="move"},onContextMenu:this.on_context_menu,children:[!this.props.plain_background&&this.props.show_large_grid&&_("div",{className:"big_squared_background",style:u}),_("div",{id:n1,style:f,children:_("div",{style:m,children:[_("div",{id:"graph_lowest_elements_container",children:[_("svg",{style:{zIndex:0,position:"absolute",top:0,left:0},children:[sv,this.props.svg_children]}),this.props.children,_("svg",{style:{zIndex:2,position:"absolute",top:0,left:0},children:[sv,this.props.svg_upper_children]})]}),this.state.pointer_state.area_select&&_(iO,{...rv(this.state),color:this.props.control_key_down?"red":"blue"})]})}),_("div",{children:this.props.overlay})]})})}}const i1=aO(cO),sv=_("defs",{children:Array.from(Array(101)).map((e,t)=>_("filter",{id:"blur_filter_"+t,x:"0",y:"0",children:_("feGaussianBlur",{in:"SourceGraphic",stdDeviation:t/20})}))});function lO(e){const{zoom:t,current_pointer_state:n,new_pointer_state:i}=e;if(!n.last_pointer_down_ms||!i.last_pointer_down_ms||i.last_pointer_down_ms-n.last_pointer_down_ms>oO)return;const{canvas_start_x:s,canvas_start_y:r}=n,{canvas_start_x:a,canvas_start_y:c}=i;if(s===void 0||r===void 0||a===void 0||c===void 0)return;const l=Math.abs(s-a),d=Math.abs(r-c),u=sO/t;l>u||d>u||H.canvas.pub("canvas_double_tap",{x:s,y:r})}function rv(e){const t=e.pointer_state.canvas_start_x||0,n=e.pointer_state.canvas_start_y||0,i=e.canvas_current_x||0,o=e.canvas_current_y||0;return{canvas_start_x:Math.min(t,i),canvas_start_y:Math.min(n,o),canvas_end_x:Math.max(t,i),canvas_end_y:Math.max(n,o)}}function dO(e,t,n){let i=e.offsetX,o=e.offsetY,s=e.target;if((s==null?void 0:s.id)!==t1){for(;s&&s.id!==n1;)i+=s.offsetLeft||0,o+=s.offsetTop||0,s=s.parentElement;i-=t.x,o+=t.y,i*=n,o*=n,i=Math.round(i),o=Math.round(o)}return{pointer_x:i,pointer_y:o}}function uO(e){const[t,n]=I(!1),{connection_from_component:i,connection_to_component:o,line_behaviour:s,circular_links:r,on_pointer_over_out:a=()=>{},connection_end_type:c=Bt.positive,is_highlighted:l=!1}=e,d=t?2:e.thickness??2,u=Ve(d*2.5,10,35),f=z(()=>Oe({connection_from_component:i,connection_to_component:o,line_behaviour:s,circular_links:r,end_size:u,connection_end_type:c}),[i,o,s,r,u,c]);if(!f)return null;const m=e.intensity??1,h=e.blur??0,v={strokeWidth:d+10},g={strokeOpacity:m,strokeWidth:d,filter:h?`url(#blur_filter_${Math.round(h)})`:""},b=t?" hovered ":e.focused_mode?"":l?" highlighted ":"",w=(e.on_click?" mouseable ":"")+b,k=()=>{n(!0),a(!0)},y=()=>{n(!1),a(!1)};return _("g",{className:"connection_container "+(e.extra_css_classes||""),onPointerDown:e.on_click,style:{display:e.hidden?"none":""},children:_(pO,{target_connection_coords:f,extra_background_classes:w,on_pointer_over:k,on_pointer_out:y,style_line_background:v,extra_line_classes:b,style_line:g,connection_end_type:c,opacity:m,blur:h,end_size:u,hovered:t,is_highlighted:l,line_behaviour:s})})}function pO(e){const[t,n]=I(e.target_connection_coords);_e(()=>hO(t,e.target_connection_coords,n),[e.target_connection_coords]);const i=mO(t,e.line_behaviour);return _(Re,{children:[_("path",{className:"connection_line_background "+e.extra_background_classes,d:i,onPointerOver:e.on_pointer_over,onPointerOut:e.on_pointer_out,style:e.style_line_background}),_("path",{className:"connection_line "+e.extra_line_classes,d:i,style:e.style_line}),_(p7,{type:e.connection_end_type,x:t.connection_end_x,y:t.connection_end_y,end_angle:t.end_angle,opacity:e.opacity,blur:e.blur,size:e.end_size,is_hovered:e.hovered,is_highlighted:e.is_highlighted})]})}function mO({line_start_x:e,line_start_y:t,relative_control_point1:n,relative_control_point2:i,line_end_x:o,line_end_y:s},r){if(r===ml.angular){const u=(s-t)/2;return`
            M ${e} ${-t}
            L ${e} ${-t-u}
            L ${o} ${-t-u}
            L ${o} ${-s}
        `}const a=e+n.x,c=-t-n.y,l=o+i.x,d=-s-i.y;return`
        M ${e} ${-t}
        C ${a},${c}, ${l},${d}, ${o},${-s}
    `}const fO=1*1e3;function hO(e,t,n){if(e===t)return;let i=performance.now();function o(s){if(i<0)return;let r=(s-i)/fO;r=Math.min(r,1);const a={line_start_x:Ot(e.line_start_x,t.line_start_x,r),line_start_y:Ot(e.line_start_y,t.line_start_y,r),relative_control_point1:_v(e.relative_control_point1,t.relative_control_point1,r),relative_control_point2:_v(e.relative_control_point2,t.relative_control_point2,r),line_end_x:Ot(e.line_end_x,t.line_end_x,r),line_end_y:Ot(e.line_end_y,t.line_end_y,r),connection_end_x:Ot(e.connection_end_x,t.connection_end_x,r),connection_end_y:Ot(e.connection_end_y,t.connection_end_y,r),end_angle:Ot(e.end_angle,t.end_angle,r)};r>=1?(i=-1,n(t)):(n(a),requestAnimationFrame(o))}return requestAnimationFrame(o),()=>i=-1}function Ot(e,t,n){return e+(t-e)*n}function _v(e,t,n){return{x:Ot(e.x,t.x,n),y:Ot(e.y,t.y,n)}}function o1(e){const{wcomponent:t,current_composed_knowledge_view:n,from_wc:i,to_wc:o}=e,{kv_entry_from_wc:s,kv_entry_to_wc:r,from_attribute:a,to_attribute:c}=vO({wcomponent:t,wc_id_map:n.composed_wc_id_map}),l={side:"right",attribute:a},d={side:"left",attribute:c},u=i==null?void 0:i.type,f=o==null?void 0:o.type;return{connection_from_component:s&&u&&{kv_wc_entry:s,wcomponent_type:u,connection_terminal_type:l},connection_to_component:r&&f&&{kv_wc_entry:r,wcomponent_type:f,connection_terminal_type:d}}}function vO({wcomponent:e,wc_id_map:t}){let n,i,o,s;return we(e)?(n=t[e.from_id],i=t[e.to_id],o=e.from_type,s=e.to_type):(n=t[e.id],i=t[e.judgement_target_wcomponent_id],o="meta",s="meta"),{kv_entry_from_wc:n,kv_entry_to_wc:i,from_attribute:o,to_attribute:s}}const gO=(e,t)=>{const{id:n}=t,i=me(e,n),{selected_wcomponent_ids_set:o}=e.meta_wcomponents,{current_composed_knowledge_view:s}=e.derived,{created_at_ms:r,sim_ms:a}=e.routing.args,{derived_validity_filter:c}=e.display_options,l=!e.display_options.consumption_formatting;let d=!1,u,f,m;if(!(!i||!s)){const{wc_ids_excluded_by_filters:g}=s.filters,b=s.composed_wc_id_map[i.id];if(we(i)){u=me(e,i.from_id),f=me(e,i.to_id);const w=s.composed_wc_id_map[i.from_id],k=s.composed_wc_id_map[i.to_id];d=vn({wcomponent:i,kv_entry:b,validity_filter:c,from_wc:u,to_wc:f,from_wc__kv_entry:w,to_wc__kv_entry:k,created_at_ms:r,sim_ms:a,selected_wcomponent_ids_set:o,wc_ids_excluded_by_filters:g}),m=xO(i,u,e)}else if(pt(i)){const w=i.judgement_target_wcomponent_id,k=me(e,w),y=s.composed_wc_id_map[w];d=LP({wcomponent:i,kv_entry:b,validity_filter:c,target_wc:k,target_wc__kv_entry:y,created_at_ms:r,sim_ms:a,selected_wcomponent_ids_set:o,wc_ids_excluded_by_filters:g})}}const h=d===!1?!1:d.display_certainty,v=e.global_keys.derived.shift_or_control_down;return{current_composed_knowledge_view:s,wcomponent:i,from_wc:u,to_wc:f,connection_effect:m,validity_value:h,is_current_item:e.routing.item_id===n,is_selected:e.meta_wcomponents.selected_wcomponent_ids_set.has(n),is_highlighted:e.meta_wcomponents.highlighted_wcomponent_ids.has(n),is_editing:l,certainty_formatting:e.display_options.derived_certainty_formatting,shift_or_control_keys_are_down:v,focused_mode:e.display_options.focused_mode,connected_neighbour_is_highlighted:e.meta_wcomponents.neighbour_ids_of_highlighted_wcomponent.has(n),circular_links:e.display_options.circular_links}},wO={clicked_wcomponent:x.meta_wcomponents.clicked_wcomponent,clear_selected_wcomponents:x.meta_wcomponents.clear_selected_wcomponents,set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent,change_route:x.routing.change_route},bO=j(gO,wO);function yO(e){const{id:t,current_composed_knowledge_view:n,wcomponent:i,from_wc:o,to_wc:s,is_current_item:r,is_highlighted:a,is_selected:c,validity_value:l,connection_effect:d,shift_or_control_keys_are_down:u,change_route:f,clicked_wcomponent:m,clear_selected_wcomponents:h}=e;if(!i)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but could not find it`),null;if(!e2(i))return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but was not a causal link`),null;if(l===!1)return null;if(!n)return console.error(`Tried to render a WComponentCanvasConnection of world component id: "${t}" but no current_composed_knowledge_view`),null;const v=V0({wcomponent_id:t,clicked_wcomponent:m,clear_selected_wcomponents:h,shift_or_control_keys_are_down:u,change_route:f,is_current_item:r}),g=o1({wcomponent:i,from_wc:o,to_wc:s,current_composed_knowledge_view:n}),{connection_from_component:b,connection_to_component:w}=z(()=>g,[JSON.stringify(g)]),k=Ty({is_editing:e.is_editing,certainty:l,is_current_item:r,is_selected:c,connected_neighbour_is_highlighted:e.connected_neighbour_is_highlighted,certainty_formatting:e.certainty_formatting,focused_mode:e.focused_mode});let y=2,S=Bt.positive,T="";d!==void 0&&(y=Ve(Math.abs(d),2,15),d<0?(S=Bt.negative,T="negative_connection_effect"):d===0&&(S=Bt.noop,T="no_connection_effect"));let $;return we(i)&&($=i.line_behaviour),_(uO,{connection_from_component:b,connection_to_component:w,on_click:v,on_pointer_over_out:R=>e.set_highlighted_wcomponent({id:t,highlighted:R}),line_behaviour:$,circular_links:e.circular_links,thickness:y,connection_end_type:S,intensity:k,is_highlighted:r||a||c,focused_mode:e.focused_mode,extra_css_classes:"connection_type_"+i.type+" "+T})}const kO=bO(yO);function xO(e,t,n){var o;let i;if(an(e)&&(i=e.effect_when_true,Ze(t))){const s=K0({values_and_prediction_sets:t.values_and_prediction_sets,created_at_ms:n.routing.args.created_at_ms,sim_ms:n.routing.args.sim_ms});if(s){const r=vo(n,t.id),a=fs({VAP_set:s,VAP_set_id_to_counterfactual_v2_map:r}),l=se(t,{}),u=(o=wo({wcomponent:t,VAP_set:a,VAPs_represent:l})[0])==null?void 0:o.parsed_value;u!=null&&(l===N.boolean?i=u===!0?e.effect_when_true:e.effect_when_false??e.effect_when_true:i=typeof u=="number"?e.effect_when_true!==void 0?u*e.effect_when_true:void 0:e.effect_when_true)}}return i!==void 0?Ve(i,-100,100):void 0}var Kd={},AO=Q;Object.defineProperty(Kd,"__esModule",{value:!0});var s1=Kd.default=void 0,SO=AO(Z()),CO=ee(),$O=(0,SO.default)((0,CO.jsx)("path",{d:"m20 12-1.41-1.41L13 16.17V4h-2v12.17l-5.58-5.59L4 12l8 8 8-8z"}),"ArrowDownward");s1=Kd.default=$O;const jO=e=>{const t=ne(e),n=t==null?void 0:t.composed_datetime_line_config;return{display_time_marks:e.display_options.display_time_marks,time_origin_ms:n==null?void 0:n.time_origin_ms,time_origin_x:n==null?void 0:n.time_origin_x,time_scale:n==null?void 0:n.time_scale,time_line_number:n==null?void 0:n.time_line_number,time_line_spacing_days:n==null?void 0:n.time_line_spacing_days,x:e.routing.args.x,zoom:e.routing.args.zoom,sim_ms:e.routing.args.sim_ms}},TO=j(jO);function PO(e){if(!(e.force_display??e.display_time_marks))return null;let{time_origin_ms:t,time_origin_x:n,time_scale:i}=e;if(e.force_display&&({time_origin_ms:t,time_origin_x:n,time_scale:i}=Ml({time_origin_ms:t,time_origin_x:n,time_scale:i})),t===void 0||n===void 0||i===void 0)return null;const{sim_ms:o,time_line_number:s,time_line_spacing_days:r}=e,a=z(()=>IO({time_line_number:s&&s-1,time_line_spacing_days:r}),[s,r]),{x:c,zoom:l}=e,d=l/ze,u=(c-n)*d,f=i/xv*d,m=new Date().getTime();return _("div",{className:"datetime_lines_container",children:[a.map(h=>_(Rc,{date_ms:(e.show_by_now?m:o)+h.offset,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:u,xd:d,color:"black",opacity:h.opacity},h.key)),!!s&&_(Rc,{date_ms:m,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:u,xd:d,color:"red",left_label_when_off_screen:!0}),!!s&&!e.show_by_now&&_(Rc,{date_ms:o,time_origin_ms:t,time_scale_ms_to_pixels_fudge:f,xm:u,xd:d,color:"blue",left_label_when_off_screen:!0})]})}const r1=TO(PO),NO="yyyy-MM-dd";function Rc(e){const{color:t,opacity:n}=e;let i=(e.date_ms-e.time_origin_ms)*e.time_scale_ms_to_pixels_fudge-e.xm;const o=document.body.clientWidth-20,s=i<0,r=i>o,a=!s&&!r;return!a&&!e.left_label_when_off_screen?null:(i=Ve(i,0,o),_("div",{className:"datetime_container",style:{color:t,borderColor:t,left:i,opacity:n},children:[_("div",{className:"rotater",children:[s&&_(Rs,{fontSize:"small"}),r&&_(s1,{fontSize:"small"}),_("div",{className:"date_label",children:Ct(new Date(e.date_ms),NO)})]}),a&&_("div",{className:"datetime_line"})]}))}const EO=1e3*3600*24;function IO(e){const t=[],{time_line_number:n,time_line_spacing_days:i}=e;if(n===void 0||i===void 0)return[];const o=i*EO;for(let s=n;s>0;--s){const r=s/n,a=n-s+1;t.push({offset:o*a,opacity:r,key:`plus${s}`}),t.push({offset:-o*a,opacity:r,key:`minus${s}`})}return t}const RO=e=>{const{ready_for_reading:t}=e.sync,{current_composed_knowledge_view:n}=e.derived;t&&!n&&console.log("No current_composed_knowledge_view");const{wc_ids_by_type:i,wcomponent_unfound_ids:o}=n||{},s=e.meta_wcomponents.wcomponent_ids_to_move_set.size>0,r=e.meta_wcomponents.frame_is_resizing,a=s||r;return{ready:t,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,wc_ids_by_type:i,wcomponent_unfound_ids:o,presenting:e.display_options.consumption_formatting,show_large_grid:e.display_options.show_large_grid,canvas_drag_event:a}},DO=j(RO);function OO(e){const t=qO(e),[n,i]=I(!1);_e(()=>H.canvas.sub("canvas_pointer_down",()=>{i(!0)})),_e(()=>H.canvas.sub("canvas_pointer_up",()=>{i(!1)}));const o=e.canvas_drag_event||n?" canvas_drag_event ":"";return _(go,{main_content:_(i1,{svg_children:[],svg_upper_children:VO(e),overlay:FO(),plain_background:e.presenting,show_large_grid:e.show_large_grid,extra_class_names:o,children:t})})}const MO=DO(OO),Dc=[],qO=e=>{const{ready:t,wc_ids_by_type:n,wcomponents_by_id:i,wcomponent_unfound_ids:o=[]}=e;if(!t||!n)return Dc;const s=[];return n.any_node.forEach(a=>{const c=i[a];c&&s.push(c)}),s.length===0&&o.length===0?Dc:[...s.map(({id:a})=>_(gi,{id:a},a)),...o.map(a=>_(gi,{id:a},a))]},VO=({wc_ids_by_type:e})=>{const t=Se().getState();return kn(t,e==null?void 0:e.any_link).filter(we).map(({id:i})=>_(kO,{id:i},i))},FO=()=>_(r1,{});const zO=e=>{const{ready_for_reading:t}=e.sync,{current_composed_knowledge_view:n}=e.derived;t&&!n&&console.log("No current_composed_knowledge_view");const{selected_wcomponent_ids_to_ordinal_position_map:i}=e.meta_wcomponents,{created_at_ms:o,sim_ms:s}=e.routing.args,r=[],a=[];return n&&(n.wc_ids_by_type.any_node.forEach(c=>{const l=e.specialised_objects.wcomponents_by_id[c];l&&r.push(l)}),n.wc_ids_by_type.any_link.forEach(c=>{const l=e.specialised_objects.wcomponents_by_id[c];we(l)&&a.push(l)})),{ready:t,wcomponent_nodes:r,wcomponent_connections:a,presenting:e.display_options.consumption_formatting,selected_wcomponent_ids_to_ordinal_position_map:i,created_at_ms:o,sim_ms:s}},LO=j(zO);class BO{constructor(t,n){ye(this,"scale","months");ye(this,"single_time_units",this._ms(1,!1));ye(this,"scales",Object.keys(this.single_time_units));ye(this,"dates",[]);ye(this,"cdate",new Date);ye(this,"sdate",new Date);ye(this,"time_resolution","hour");ye(this,"timeline_spacing",!0);t.length!==0&&(this.time_resolution="day",this.scale=this.time_resolution+"s",this.cdate=new Date(n.created_at_ms),this.sdate=new Date(n.sim_ms),this.dates=t.sort((i,o)=>i.getTime()-o.getTime()))}_ms(t,n=!0){const i=n?(o,s)=>o/s:(o,s)=>o*s;return{milliseconds:t,get seconds(){return i(t,1e3)},get minutes(){return i(this.seconds,60)},get hours(){return i(this.minutes,60)},get days(){return i(this.hours,24)},get months(){return i(this.days,365/12)},get years(){return i(this.days,365)}}}get scale_index(){return this.scales.indexOf(this.scale)}increment(t,n=1,i=this.scale){const o=new Date(t.getTime()),s=this.get_date_prop_func_names(i);return Object(o)[s.set](Object(o)[s.get]()+n),o}get range_dates(){const t=[],n=this.round_date(this.increment(this.end_date,1),!0,this.scale),i=this.round_date(this.increment(this.start_date,-1),!1,this.scale);return t.push(i),t.push(n),t}get start_date(){const t=this.dates.first();return Mo(t)}get end_date(){const t=this.dates.last();return Mo(t)}get range_start_date(){const t=this.range_dates.first();return Mo(t)}get range_end_date(){const t=this.range_dates.last();return Mo(t)}get_date_offset_percent(t){let n=0;const i=t.getTime(),o=this.range_start_date.getTime(),s=this.range_end_date.getTime();return n=(i-o)/(s-o)*100,n}get_date_prop_func_names(t){let n,i=null;const o=t.charAt(0).toUpperCase()+t.slice(1),s=new Date,r=`get${o}`;switch(t){case"days":n="getDate";break;default:Object(s)[r]?n=r:Object(s)[r.replace(/s$/,"")]&&(n=r.replace(/s$/,""))}return n&&(i=n.replace(/^get/,"set")),{get:n,set:i}}round_date(t,n=!1,i=this.scale){const o=new Date(t.getTime());return this.scales.forEach((s,r)=>{const a=this.get_date_prop_func_names(s),c=s==="days"?1:0;n?r===this.scale_index?Object(o)[a.set](Object(o)[a.get]()+1):r<this.scale_index&&Object(o)[a.set](c):r<this.scale_index&&a.set&&Object(o)[a.set]&&Object(o)[a.set](c)}),n&&o.setTime(o.getTime()-1),o}render(t){if(t.length===0)return null;const n=new Date(this.range_start_date.getTime()),i=[];for(i.push(new Date(n.getTime()));n.getTime()<=this.range_end_date.getTime();){let s=this.get_date_prop_func_names(this.scale),r=Object(n)[s.get]();Object(n)[s.set](r+1),i.push(new Date(n.getTime()))}const o=this.timeline_spacing?`${100+i.length*1.42}%`:"100%";return _(E,{id:"knowledge_time_view",className:`time_view scroll_area_x ${this.scale} ${this.timeline_spacing?"timeline_spacing":"event_spacing"}`,flexGrow:1,flexShrink:1,position:"relative",onScroll:s=>{let a=s.target.scrollLeft,c=document.getElementsByClassName("wc");for(let l=0;l<c.length;l++){const d=c[l];d&&(d.style.marginLeft=`${a}px`)}},children:[_(E,{className:"timeline",display:this.timeline_spacing?"block":"none",height:1,maxHeight:1,position:"absolute",minWidth:o,width:o,maxWidth:o,top:0,right:"auto",bottom:0,left:0,zIndex:1,children:_(E,{width:1,maxWidth:1,height:1,maxHeight:1,display:"flex",flexDirection:"row",flexWrap:"wrap",children:i.map((s,r)=>_(E,{className:"unit",flexGrow:1,flexShrink:1,flexBasis:"auto",position:"relative",overflow:"visible",children:_(E,{position:"absolute",className:"tick",width:0,height:1,top:0,right:0,bottom:0,left:0,children:_(E,{className:"rotater",whiteSpace:"nowrap",children:[_(E,{component:"small",className:"days weeks months years",children:s.toLocaleDateString()}),_(E,{component:"small",className:"hours",children:s.toLocaleTimeString()})]})})}))})}),_(E,{minWidth:o,width:o,maxWidth:o,minHeight:1,height:1,maxHeight:1,overflow:"hidden",children:_(E,{className:"scroll_area_y",minWidth:"100%",maxWidth:"100%",position:"relative",zIndex:10,height:1,maxHeight:1,children:_(E,{className:"contents",mt:this.timeline_spacing?50:0,children:t.map(s=>{const r=Rn(s)?s.values_and_prediction_sets:[];return _(E,{width:1,maxWidth:1,overflow:"hidden",position:"relative",children:[_(E,{id:`WC-${s.id}`,className:"wc",display:"inline-block",position:"relative",top:0,children:_(gi,{id:s.id,is_on_canvas:!1})}),_(E,{className:"vaps",width:1,maxWidth:1,overflow:"hidden",minHeight:"7em",height:"7em",maxHeight:"7em",p:this.timeline_spacing?0:3,position:"relative",display:`${this.timeline_spacing?"block":"flex"}`,flexDirection:"row",justifyContent:"start",children:r.map(a=>{const c=Sl(a);if(!c)return null;const l=this.get_date_offset_percent(c);return _(E,{className:"vap",flexGrow:0,flexShrink:1,flexBasis:"auto",display:"inline-block",border:1,minHeight:"100%",height:"100%",maxHeight:"100%",position:`${this.timeline_spacing?"absolute":"static"}`,zIndex:1,left:`${l}%`,children:_(Gd,{wcomponent:s,VAP_set:a})})})})]})})})})})]})}}function UO(e){let{wcomponent_nodes:t}=e;const{selected_wcomponent_ids_to_ordinal_position_map:n}=e,i=[];t=ue(t,a=>{const c=n[a.id];return c!==void 0?c:Ae(a)},ce.ascending),t.forEach(a=>{(Rn(a)?a.values_and_prediction_sets:[]).forEach(l=>{const d=Sl(l);d&&i.push(d)})});const r=new BO(i,e).render(t);return _(go,{main_content:r||_(E,{})})}const WO=LO(UO);function Mo(e){return e instanceof Date?e:new Date}const HO={set_action_ids_to_show:x.view_priorities.set_action_ids_to_show},GO=j(null,HO);function KO(e){const{x:t,y:n,width:i,height:o,display:s,action_ids:r,date_shown:a}=e;return _(Bd,{position:{width:i,height:o,left:t,top:n},display:s,extra_styles:{backgroundColor:"orange",borderRadius:"2px",border:"thin solid #777",overflow:"hidden",fontSize:"7px",textAlign:"center"},on_click:()=>e.set_action_ids_to_show({action_ids:r,date_shown:a}),children:r.length})}const YO=GO(KO);const JO=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,created_at_ms:e.routing.args.created_at_ms}),XO={change_route:x.routing.change_route},ZO=j(JO,XO);function QO(e){const{wcomponents_by_id:t,knowledge_views_by_id:n,created_at_ms:i,x:o,y:s,width:r,effort:a,display:c}=e,l=t[e.wcomponent_id];if(!l)return null;const d=Qe({wcomponent:l,wcomponents_by_id:t,knowledge_views_by_id:n,wc_id_to_counterfactuals_map:void 0,created_at_ms:i,sim_ms:new Date().getTime()}),u=Math.max(r,60),f=Math.max(r,250),[m,h]=I(u),v=`${Math.round(a*100)}%`,b={backgroundImage:`linear-gradient(to top, #a6eaff ${v}, rgba(0,0,0,0) ${v})`,backgroundColor:"white"};return _(Bd,{position:{left:o,top:s,width:m},display:c,on_pointer_down:w=>{w.stopImmediatePropagation(),w.preventDefault(),e.change_route({item_id:e.wcomponent_id})},on_pointer_enter:()=>h(f),on_pointer_leave:()=>h(u),extra_css_class:" prioritisation_entry ",children:_("div",{className:"node_main_content",style:b,children:[" ",_("span",{title:d,children:_(ji,{options:Es,children:d})}),_("div",{children:[_("br",{}),_("span",{style:{color:"grey",fontSize:10},children:["  ",a>0&&`Effort ${v}`]})]})]})})}const e8=ZO(QO),t8=new Set(Object.values(ge));function _1(e){let t=e.values_and_prediction_sets||[];t=ao(t).latest,t=po(t,ce.ascending);let n,i;const o=[];if(t.forEach(s=>{const{entries:r,datetime:a}=s,l=Yj(r,N.action).filter(f=>f.probability>0&&f.value_id&&t8.has(f.value_id)),d=l[0];if(l.length!==1||!d){console.log(`Skipping calculating action_active_date_ranges for VAP_set "${s.id}" of action "${e.id}"`);return}d.value_id===ge.action_in_progress?n||(n=ut(a)):n&&(i=ut(a)),n&&i&&(o.push({start:n,stop:i}),n=void 0,i=void 0)}),n){let s=new Date;s.getTime()<n.getTime()&&(s=n),o.push({start:n,stop:s})}return o}function n8(e){const t=_1(e);let n=[],i=new Set;return t.forEach(o=>{const r=Ok(o.start,o.stop).filter(a=>!i.has(a));n=n.concat(r),i=new Set(n)}),n}const i8=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),o8={change_route:x.routing.change_route},s8=j(i8,o8);function r8(e){const{wcomponent_ids:t=[],wcomponents_by_id:n,knowledge_views_by_id:i}=e,o=t.map(c=>n[c]).filter(be),s={},r=new Date().getTime(),a=r;return _("table",{class:"list",children:_("tbody",{children:o.map(c=>_("tr",{style:{cursor:"pointer"},onClick:()=>e.change_route({item_id:c.id}),children:Qe({wcomponent:c,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:s,created_at_ms:r,sim_ms:a})}))})})}const _8=s8(r8),a8=e=>({action_ids_to_show:e.view_priorities.action_ids_to_show,date_shown:e.view_priorities.date_shown}),c8={set_action_ids_to_show:x.view_priorities.set_action_ids_to_show},l8=j(a8,c8);function d8(e){if(e.action_ids_to_show.length===0)return null;let t="Actions";return e.date_shown&&(t+=` (${Ct(e.date_shown,"yyyy-MMM-dd")})`),_(zn,{on_close:()=>e.set_action_ids_to_show({action_ids:[]}),title:t,child:_(_8,{wcomponent_ids:e.action_ids_to_show})})}const u8=l8(d8),p8=e=>{const t=ne(e),n=t==null?void 0:t.prioritisations,{action:i,goal:o}=e.derived.wcomponent_ids_by_type,s=t==null?void 0:t.composed_datetime_line_config;return{prioritisations:n,time_origin_ms:s==null?void 0:s.time_origin_ms,time_origin_x:s==null?void 0:s.time_origin_x,time_scale:s==null?void 0:s.time_scale,presenting:e.display_options.consumption_formatting,all_action_ids:i,all_goal_ids:o,wcomponents_by_id:e.specialised_objects.wcomponents_by_id}},m8=j(p8),f8=e=>[];function h8(e){return!!e.start_date}const v8=e=>{const{prioritisations:t=[],all_action_ids:n,all_goal_ids:i,wcomponents_by_id:o}=e,s=z(()=>y8(t),[t]),{denormalised_prioritisation_by_id:r,prioritised_goals_and_actions:a}=s,c=z(()=>k8({all_action_ids:n,all_goal_ids:i,wcomponents_by_id:o,prioritised_goals_and_actions:a}),[n,i,o,a]),{time_origin_ms:l,time_origin_x:d,time_scale:u}=Ml(e),f=z(()=>x8({denormalised_prioritisation_by_id:r,prioritised_goals_and_actions:a,time_origin_ms:l,time_origin_x:d,time_scale:u}),[r,a,l,d,u]),m=z(()=>A8({date_str_to_daily_actions_map:c,time_origin_ms:l,time_origin_x:d,time_scale:u,prioritised_goals_and_actions:a}),[c,l,d,u,a]);return[...f,...m]},g8=()=>_(r1,{force_display:!0,show_by_now:!0});function w8(e){const t=v8(e);return _(go,{main_content:_(i1,{svg_children:f8(),svg_upper_children:[],overlay:g8(),plain_background:e.presenting,children:t}),extra_content:_(u8,{})})}const b8=m8(w8),ll="UNCATEGORISED_PRIORITY_ID";function y8(e){const t=new Date;let n=e.map(a=>({...a,total_effort:0,start_date:ut(a.datetime),end_date:t})).filter(h8);n=ue(n,a=>a.start_date.getTime(),ce.ascending),n.forEach((a,c)=>{const l=n[c+1];a.end_date=ut(l==null?void 0:l.datetime)||t});let i=0;const o={},s=[];n.forEach(a=>{Object.entries(a.goals).forEach(([c,l])=>{a.total_effort+=l.effort;let d=o[c];d===void 0&&(d=i++,o[c]=d),s.push({prioritisation_id:a.id,goal_or_action_id:c,effort:l.effort,offset_index:d})})});const r={};return n.forEach(a=>r[a.id]=a),{denormalised_prioritisation_by_id:r,prioritised_goals_and_actions:s}}function k8(e){const{prioritised_goals_and_actions:t}=e,n=new Set(t.map(r=>r.goal_or_action_id)),i={},o=Lb(e);return Object.values(o.actions_by_id).forEach(r=>{const a=[...Bb({action:r,...o})];n8(r).forEach(l=>{const d=i[l]||{prioritised_goal_or_action_ids_to_action_ids_map:{}};let u=!1;for(let f=0;f<a.length;++f){const m=a[f];if(n.has(m)){u=!0;const h=d.prioritised_goal_or_action_ids_to_action_ids_map[m]||[];h.push(r.id),d.prioritised_goal_or_action_ids_to_action_ids_map[m]=h}}if(!u){const f=d.prioritised_goal_or_action_ids_to_action_ids_map[ll]||[];f.push(r.id),d.prioritised_goal_or_action_ids_to_action_ids_map[ll]=f}i[l]=d})}),i}function x8(e){const{denormalised_prioritisation_by_id:t,prioritised_goals_and_actions:n,time_origin_ms:i,time_origin_x:o,time_scale:s}=e;return n.map(({prioritisation_id:r,goal_or_action_id:a,effort:c,offset_index:l})=>{const{total_effort:d,start_date:u,end_date:f}=t[r],m=mi({datetime:u,time_origin_ms:i,time_origin_x:o,time_scale:s}),h=mi({datetime:f,time_origin_ms:i,time_origin_x:o,time_scale:s});return _(e8,{effort:c/d,wcomponent_id:a,x:m,y:100*l,width:h-m,display:!0})})}function A8(e){const{time_origin_ms:t,time_origin_x:n,time_scale:i,prioritised_goals_and_actions:o}=e,s={};o.forEach(a=>{s[a.goal_or_action_id]=a});const r=[];return Object.entries(e.date_str_to_daily_actions_map).forEach(([a,c])=>{const l=new Date(a),d=mi({datetime:l,time_origin_ms:t,time_origin_x:n,time_scale:i});Object.entries(c.prioritised_goal_or_action_ids_to_action_ids_map).forEach(([u,f])=>{const m=s[u];let h=-40;if(m)h=100*m.offset_index+70;else if(u!==ll)return;r.push(_(YO,{width:10,height:10,display:!0,x:d,y:h,action_ids:f,date_shown:l}))})}),r}const S8=e=>({editing:!e.display_options.consumption_formatting}),C8={upsert_wcomponent:x.specialised_object.upsert_wcomponent},$8=j(S8,C8);function j8(e){var r;const{goal:t,selected_prioritisation:n,editing:i}=e,o=n&&n.goals||{},s=(r=o[t.id])==null?void 0:r.effort;return _("div",{style:{display:"flex"},children:[_(gi,{id:t.id,is_on_canvas:!1,always_show:!0}),n&&(i||!!s)&&_("div",{children:[_("br",{}),_(st,{placeholder:"Effort",allow_undefined:!0,value:s,on_blur:a=>{const c={...o};a===void 0?delete c[t.id]:c[t.id]={effort:a};const l={...n,goals:c};e.upsert_wcomponent({wcomponent:l})},on_blur_type:G.conditional})]})]})}const Oc=$8(j8);function T8({prioritisation:e}){return _(gi,{id:e.id,is_on_canvas:!1,always_show:!0})}function P8(e){return _(go,{main_content:_(D8,{})})}const N8=e=>{const t=e.specialised_objects.wcomponents_by_id,n=ne(e),i=[];let o,s;if(n){n.wc_ids_by_type.has_objectives.forEach(a=>{const c=t[a];Ho(c,a)&&i.push(c)}),o=n.prioritisations;const{item_id:r}=e.routing;s=o.find(({id:a})=>a===r),Object.keys((s==null?void 0:s.goals)||{}).forEach(a=>{if(n.wc_ids_by_type.has_objectives.has(a))return;const c=t[a];Ho(c,a)&&i.push(c)})}return{composed_knowledge_view:n,goals_and_actions:i,prioritisations:o,selected_prioritisation:s,base_id:_t(e),wcomponents_by_id:t,display_side_panel:e.controls.display_side_panel}},E8={upsert_wcomponent:x.specialised_object.upsert_wcomponent},I8=j(N8,E8);function R8(e){const{goals_and_actions:t,prioritisations:n,composed_knowledge_view:i,selected_prioritisation:o,base_id:s,wcomponents_by_id:r}=e,a=i==null?void 0:i.id,c=(i==null?void 0:i.composed_wc_id_map)||{},l=o==null?void 0:o.goals,{potential_goals:d,prioritised_goals:u,deprioritised_goals:f}=O8(t,l);return s===void 0?_("div",{children:"No base id chosen"}):_("div",{className:"priorities_list_view_content",children:[_("div",{className:"priorities_list goals",children:[_("h1",{children:"Potential"}),d.map(m=>_(Oc,{goal:m,selected_prioritisation:o},m.id)),_("h1",{children:"Deprioritised"}),f.map(m=>_(Oc,{goal:m,selected_prioritisation:o},m.id))]}),_("div",{className:"priorities_list goals",children:[_("h1",{children:"Prioritised"}),u.map(m=>_(Oc,{goal:m,selected_prioritisation:o},m.id))]}),_("div",{className:"priorities_list prioritisations",children:[_("h1",{children:["Prioritisations",a&&_("span",{className:"button_add_new",children:[" ",_(F,{fullWidth:!1,onClick:m=>{var g;const h=((g=(n||[])[0])==null?void 0:g.id)||"",v=N0(c,h,r);On({wcomponent:{base_id:s,type:"prioritisation",goals:l||{},description:(o==null?void 0:o.description)||""},add_to_knowledge_view:{id:a,position:v}})},children:l?"Copy":"Add"})]})]}),_("div",{className:"prioritisations_list",children:(n||[]).map(m=>_(T8,{prioritisation:m}))})]}),_("div",{className:"side_panel_padding",style:{minWidth:e.display_side_panel?ii:0}})]})}const D8=I8(R8);function O8(e,t){let n=[],i=[],o=[];return t?e.forEach(s=>{const r=t[s.id];r?r.effort>0?i.push(s):o.push(s):n.push(s)}):n=e,n=ue(n,Ae,ce.descending),i=ue(i,M8(t),ce.descending),o=ue(o,Ae,ce.descending),{potential_goals:n,prioritised_goals:i,deprioritised_goals:o}}function M8(e){return t=>{var n;return((n=(e||{})[t.id])==null?void 0:n.effort)||0}}const q8=e=>{const{view:t}=e.routing.args,{display_by_simulated_time:n}=e.display_options;return{view:t,display_by_simulated_time:n}},V8=j(q8);function F8(e){let t=_("div",{children:["Unsupported view: ",e.view]});return e.view==="knowledge"?e.display_by_simulated_time?t=_(WO,{}):t=_(MO,{}):e.view==="priorities"?t=_(b8,{}):e.view==="priorities_list"?t=_(P8,{}):e.view==="actions_list"&&(t=_(J6,{})),t}const z8=V8(F8);function L8(){return B8(),I(!1),null}dk(e=>({badge:{top:2,right:"-0.42em",zIndex:1}}))(uk);const B8=Pt(e=>({button:{display:"inline-block",marginRight:"1em",border:`1px ${e.palette.divider} solid`},icon:{position:"relative",zIndex:10}})),U8=e=>({}),W8=j(U8);function H8(e){return _("div",{children:[_("span",{className:"description_label",children:"Version"})," ",_("b",{children:"2025-05-13"})]})}const G8=W8(H8);function nt(e){e.value;const{on_change:t}=e,n=e.disabled||!t;return _("input",{type:"checkbox",checked:e.value,disabled:n,style:{cursor:n?"not-allowed":""},onChange:i=>{if(!t)return;const o=i.currentTarget.checked;t(o)}})}var Yd={},K8=Q;Object.defineProperty(Yd,"__esModule",{value:!0});var a1=Yd.default=void 0,Y8=K8(Z()),J8=ee(),X8=(0,Y8.default)((0,J8.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Clear");a1=Yd.default=X8;function Z8(e){const{editing:t,option:n,on_remove_option:i,on_pointer_down_selected_option:o,on_mouse_over_option:s,on_mouse_leave_option:r}=e;return n?_(In,{size:"small",color:"primary",variant:"contained",fullWidth:!0,disableElevation:!0,style:{margin:5},children:[_(F,{onClick:a=>o&&o(a,n.id),disabled:!o,style:{cursor:o?"":"not-allowed",backgroundColor:n.color&&Tt(n.color),color:n.color&&Tt(q0(n.color))},children:_(Me,{title:n.jsx||n.title,children:_(re,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:n.jsx||n.title})})}),t&&_(pe,{onClick:()=>i(n.id),size:"small",children:_(a1,{})})]}):null}const Q8=(e,t)=>({editable:t.editing_allowed!==void 0?t.editing_allowed:!e.display_options.consumption_formatting}),eM={change_route:x.routing.change_route},tM=j(Q8,eM);function nM(e){const{editable:t,options:n,selected_option_ids:i}=e,{filtered_options:o,missing_options_by_id:s}=z(()=>{const a=n.filter(({id:l})=>!i.includes(l)),c={};if(a.length!==i.length){const l=new Set(a.map(({id:u})=>u));i.filter(u=>!l.has(u)).forEach(u=>{const f={id:u,title:"<Label Not found>"};c[u]=f,a.push(f)})}return{filtered_options:a,missing_options_by_id:c}},[n,i]),r=z(()=>{const a={...s};return n.forEach(c=>a[c.id]=c),a},[n,s]);return _(E,{width:"100%",overflowX:"hidden",children:[t&&_(de,{...e,selected_option_id:void 0,options:o,on_change:a=>{a!==void 0&&e.on_change([...i,a])},editing_allowed:t}),_("div",{style:{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden"},children:i.map(a=>_("div",{style:{flexGrow:1,flexShrink:1,flexBasis:"30%",maxWidth:"100%"},children:_(Z8,{editing:t,option:r[a],on_remove_option:c=>{e.on_change(i.filter(l=>l!==c))},on_mouse_over_option:e.on_mouse_over_option,on_mouse_leave_option:e.on_mouse_leave_option,on_pointer_down_selected_option:(c,l)=>{e.change_route({item_id:l})}})}))})]})}const iM=tM(nM);function wi(e){return _(iM,{...e})}const oM=e=>({ready:e.sync.ready_for_reading,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:at(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}),sM={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent},rM=j(oM,sM);function _M(e){const{ready:t,label_ids:n=[]}=e;if(!t)return _("div",{children:"Loading labels..."});let i;e.allowed_label_ids&&(i=new Set(e.allowed_label_ids),n.forEach(s=>i==null?void 0:i.add(s)));const o=cn({allowed_wcomponent_ids:i,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _(wi,{placeholder:"Add Label",selected_option_ids:n,options:o,allow_none:!0,on_change:s=>{e.on_change(s.filter(r=>!!r))},on_mouse_over_option:s=>e.set_highlighted_wcomponent({id:s,highlighted:!0}),on_mouse_leave_option:s=>e.set_highlighted_wcomponent({id:s,highlighted:!1}),editing_allowed:e.editing_allowed})}const no=rM(_M),aM=e=>{const{creation_context:t}=e.creation_context;return{use_creation_context:e.creation_context.use_creation_context,custom_created_at:t==null?void 0:t.custom_created_at,label_ids:t==null?void 0:t.label_ids,replace_text_target:t==null?void 0:t.replace_text_target,replace_text_replacement:t==null?void 0:t.replace_text_replacement}},cM={toggle_use_creation_context:x.creation_context.toggle_use_creation_context,set_custom_created_at:x.creation_context.set_custom_created_at,set_label_ids:x.creation_context.set_label_ids,set_replace_text:x.creation_context.set_replace_text},lM=j(aM,cM);function dM(e){return _("div",{children:[_("p",{children:["Enabled: ",_(nt,{value:e.use_creation_context,on_change:()=>e.toggle_use_creation_context()})]}),_("p",{children:["Custom created at datetime: ",_(ht,{value:e.custom_created_at,on_change:t=>e.set_custom_created_at({custom_created_at:t})}),e.custom_created_at!==void 0&&_("div",{style:{backgroundColor:"pink"},children:["Tip: you only need to set this for easing entry of historical data.  If you want to view the data you are currently entering in a lower time resolution then use the",_(De,{route:"display",sub_route:void 0,item_id:void 0,args:void 0,children:" display options "}),"to change the time resolution."]})]}),_("p",{children:["Automatically label with: ",_(no,{label_ids:e.label_ids,on_change:t=>e.set_label_ids({label_ids:t})})]}),_("p",{children:["Automatically replace text:",_("br",{}),_(Wt,{placeholder:"Target text...",value:e.replace_text_target||"",conditional_on_change:t=>e.set_replace_text({value:t||void 0,value_type:"target"})}),_("br",{}),_(Wt,{placeholder:"Replacement text...",value:e.replace_text_replacement||"",conditional_on_change:t=>e.set_replace_text({value:t||void 0,value_type:"replacement"})})]})]})}const uM=lM(dM),pM=e=>({enable_angular_connections:e.display_options.enable_angular_connections}),mM={set_or_toggle_enable_angular_connections:x.display.set_or_toggle_enable_angular_connections},fM=j(pM,mM);function hM(e){return _(Re,{children:[_("b",{children:_(av,{show_label:!0})}),_("p",{className:"section",children:[_(av,{})," ",_("b",{children:["Enable Angular Connections ",_("span",{style:{position:"relative",top:"-0.5em"},children:["⌞",_("span",{style:{position:"relative",top:"0.8em",left:"-2px"},children:"⌝"})]})]}),_(nt,{value:e.enable_angular_connections,on_change:e.set_or_toggle_enable_angular_connections})]})]})}const vM=fM(hM);function av(e){const t="Experimental feature.  Maybe changed or removed.";return _($i,{warning:t,label:e.show_label?t:""})}const gM={second:!0,minute:!0,hour:!0,day:!0},wM=Object.keys(gM),bM=e=>({time_resolution:e.display_options.time_resolution,display_by_simulated_time:e.display_options.display_by_simulated_time}),yM={set_time_resolution:x.display.set_time_resolution},kM=j(bM,yM);function xM(e){const t=Rd();return e.display_by_simulated_time?null:_(In,{disableElevation:!0,variant:"contained",value:e.time_resolution,children:SM.map(n=>_(xe,{value:n,onClick:()=>e.set_time_resolution({time_resolution:n}),className:t.inverse_disabled,disabled:e.time_resolution===n,children:n}))})}const AM=kM(xM),SM=wM.filter(e=>e!=="second"),CM=e=>({validity_filter:e.display_options.validity_filter,certainty_formatting:e.display_options.certainty_formatting,display_by_simulated_time:e.display_options.display_by_simulated_time,focused_mode:e.display_options.focused_mode,circular_links:e.display_options.circular_links,display_time_marks:e.display_options.display_time_marks,animate_connections:e.display_options.animate_connections,show_large_grid:e.display_options.show_large_grid,display_time_sliders:e.controls.display_time_sliders}),$M={set_validity_filter:x.display.set_validity_filter,set_certainty_formatting:x.display.set_certainty_formatting,set_display_by_simulated_time:x.display.set_display_by_simulated_time,set_or_toggle_focused_mode:x.display.set_or_toggle_focused_mode,set_or_toggle_circular_links:x.display.set_or_toggle_circular_links,set_display_time_marks:x.display.set_display_time_marks,set_or_toggle_animate_connections:x.display.set_or_toggle_animate_connections,set_or_toggle_show_large_grid:x.display.set_or_toggle_show_large_grid,set_display_time_sliders:x.controls.set_display_time_sliders},jM=j(CM,$M);function TM(e){const t=EM[e.validity_filter];return _("div",{className:"side_panel",children:[_("p",{className:"section",children:[_("b",{children:"Validity filter"}),_("br",{}),_("div",{style:{display:"inline-flex"},children:["Show:   ",_(de,{placeholder:"",options:NM,selected_option_id:e.validity_filter,allow_none:!1,on_change:n=>{n&&e.set_validity_filter({validity_filter:n})},editing_allowed:!0})]}),_("br",{}),_("div",{className:"description",children:[t.pre,_("br",{}),_("i",{children:["certainty ",t.condition]})," ",cv,"."]})]}),_("p",{className:"section",children:[_("b",{children:"Validity formatting"}),_("br",{}),_("div",{style:{display:"inline-flex"},children:["Opacity:   ",_(de,{placeholder:"",options:IM,selected_option_id:e.certainty_formatting,allow_none:!1,on_change:n=>{n&&e.set_certainty_formatting({certainty_formatting:n})},editing_allowed:!0})]}),_("br",{}),_("div",{className:"description",children:["Show nodes and connection opacity as ",_("i",{children:RM[e.certainty_formatting]})," ",cv,"."]})]}),_("p",{className:"section",children:[_("b",{children:"Time resolution"}),"  ",_(AM,{})]}),_("p",{className:"section",children:[_("b",{children:'Use "Focused" Mode'}),"  ",_(St,{...ae.toggle_focused}),_(nt,{value:e.focused_mode,on_change:e.set_or_toggle_focused_mode})]}),_("p",{className:"section",children:[_("b",{children:"Show connections as more circular"}),"  ",_(St,{...ae.toggle_circular_connections}),_(nt,{value:e.circular_links,on_change:e.set_or_toggle_circular_links})]}),_("p",{className:"section",children:[_("b",{children:"Animate connections"}),"  ",_(St,{...ae.toggle_animating}),_(nt,{value:e.animate_connections,on_change:e.set_or_toggle_animate_connections})]}),_("p",{className:"section",children:[_("b",{children:"Show time markers"}),_(nt,{value:e.display_time_marks,on_change:e.set_display_time_marks})]}),_("p",{className:"section",children:[_("b",{children:"Show large grid (whilst editing)"}),_(nt,{value:e.show_large_grid,on_change:e.set_or_toggle_show_large_grid})]}),_("hr",{}),_(vM,{}),_("hr",{}),_("h3",{children:"Controls"}),_("p",{className:"section",children:[_("b",{children:'Display time sliders for "created at" and "simulated" time'}),"  ",_(St,{...ae.toggle_time}),_(nt,{value:e.display_time_sliders,on_change:n=>{e.set_display_time_sliders(n)}})]})]})}const PM=jM(TM),cv="(certainty is the minimum of probability or confidence, e.g. something with 70% probability and 20% confidence is 20% certain)",NM=[{id:"only_certain_valid",title:"Only valid"},{id:"only_maybe_valid",title:"Only maybe Valid"},{id:"maybe_invalid",title:"Maybe Invalid"},{id:"show_invalid",title:"Invalid"}],Mc="Only show nodes and connections with validity",EM={only_certain_valid:{pre:Mc,condition:"100%"},only_maybe_valid:{pre:Mc,condition:"> 50%"},maybe_invalid:{pre:Mc,condition:"> 0%"},show_invalid:{pre:"Show all nodes and connections i.e. with validity",condition:">= 0%"}},IM=[{id:"render_certainty_as_opacity",title:"Use certainty"},{id:"render_certainty_as_easier_opacity",title:"Use certainty (opacity >= 50%)"},{id:"render_100_opacity",title:"Always 100%"}],RM={render_certainty_as_opacity:"proportional to certainty",render_certainty_as_easier_opacity:"proportional to certainty but no lower than 50% (easier to see)",render_100_opacity:"always 100% (no transparency)"},DM=e=>{var i;const{wc_label_ids:t,wc_types:n}=((i=e.derived.current_composed_knowledge_view)==null?void 0:i.available_filter_options)||{};return{wc_label_ids:t,wc_types:n,apply_filter:e.filter_context.apply_filter,filters:e.filter_context.filters,is_on_actions_list_view:cb(e)}},OM={set_apply_filter:x.filter_context.set_apply_filter,set_filters:x.filter_context.set_filters},MM=j(DM,OM);function qM(e){const{wc_label_ids:t,wc_types:n,filters:i}=e,o=z(()=>[...n||[]].concat(i.exclude_by_component_types).map(a=>({id:a,title:to(a)})),[n,i]),s=z(()=>[...n||[]].concat(i.include_by_component_types).map(a=>({id:a,title:to(a)})),[n,i]);return _("div",{children:[_("p",{children:["Enabled: ",_(nt,{value:e.apply_filter,on_change:()=>e.set_apply_filter(!e.apply_filter)})]}),_("p",{children:["Filter by label:",_(no,{allowed_label_ids:t,label_ids:e.filters.include_by_label_ids,on_change:r=>{e.set_filters({filters:{...e.filters,include_by_label_ids:r}})},editing_allowed:!0})]}),_("p",{children:["Exclude by label:",_(no,{allowed_label_ids:t,label_ids:e.filters.exclude_by_label_ids,on_change:r=>{e.set_filters({filters:{...e.filters,exclude_by_label_ids:r}})},editing_allowed:!0})]}),_("p",{children:["Filter by component type:",_(wi,{placeholder:"",selected_option_ids:e.filters.include_by_component_types,options:s,allow_none:!0,on_change:r=>{e.set_filters({filters:{...e.filters,include_by_component_types:r}})},editing_allowed:!0})]}),_("p",{children:["Exclude by component type:",_(wi,{placeholder:"",selected_option_ids:e.filters.exclude_by_component_types,options:o,allow_none:!0,on_change:r=>{e.set_filters({filters:{...e.filters,exclude_by_component_types:r}})},editing_allowed:!0})]}),e.is_on_actions_list_view&&_(Re,{children:[_("br",{}),_("hr",{}),_("h3",{children:"Actions list filters"}),_("p",{children:["Filter by current knowledge view: ",_(nt,{value:e.filters.filter_by_current_knowledge_view,on_change:()=>{const r={...e.filters,filter_by_current_knowledge_view:!e.filters.filter_by_current_knowledge_view};e.set_filters({filters:r})}})]}),_("p",{children:["Filter by text: ",_(He,{size:"small",placeholder:"",editing_allowed:!0,value:e.filters.filter_by_text,on_blur:r=>{const a={...e.filters,filter_by_text:r.trim()};e.set_filters({filters:a})},on_blur_type:G.conditional})]})]})]})}const VM=MM(qM),FM=["priority","normal","hidden","archived"];function $n(){return _("div",{className:"external_link_icon"})}const zM=e=>({bases_by_id:e.user_info.bases_by_id,chosen_base_id:e.user_info.chosen_base_id}),LM=j(zM);function BM(e){const t=e.base_id_to_move_to===void 0?void 0:`${e.base_id_to_move_to}`,n=Object.values(e.bases_by_id||{}).filter(i=>i.id!==e.chosen_base_id&&i.can_edit).map(i=>({id:`${i.id}`,title:i.title}));return _("div",{children:_(de,{selected_option_id:t,allow_none:!0,options:n,on_change:i=>{const o=i===void 0?void 0:parseInt(i);e.on_change(o)}})})}const UM=LM(BM),WM=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),HM=j(WM);function GM(e){const{wcomponents_move_conflicts:t,wcomponents_by_id:n,knowledge_views_by_id:i}=e,o=new Date().getTime(),s=o;return _("div",{children:Object.entries(t||{}).map(([r,a],c)=>{const l=n[r],d=l&&Qe({wcomponent:l,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:void 0,created_at_ms:o,sim_ms:s})||r;return _("div",{children:[_(De,{route:"wcomponents",sub_route:void 0,item_id:r,args:void 0,children:['Component "',_(ji,{children:d}),'" in:']}),_("ul",{children:a.map(u=>{const f=i[u.kv_id],m=(f==null?void 0:f.title)||u.kv_id,h=hi(u,!0);return _("li",{children:_(De,{route:"wcomponents",sub_route:void 0,item_id:r,args:{subview_id:u.kv_id,...h},children:["    ",m]})})})})]},r)})})}const KM=HM(GM),YM=e=>({nested_knowledge_view_ids_map:e.derived.nested_knowledge_view_ids.map,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,chosen_base_id:e.user_info.chosen_base_id}),JM=j(YM);function XM(e){const{knowledge_view:t,nested_knowledge_view_ids_map:n,knowledge_views_by_id:i,wcomponents_by_id:o,chosen_base_id:s}=e,[r,a]=I(new Set),[c,l]=I(void 0),[d,u]=I(void 0),[f,m]=I(void 0);if(s===void 0)return _("div",{children:[_("h4",{children:"Change base of knowledge view"}),"Need to select a base first"]});if(!c)return _("div",{children:[_("h4",{children:"Change base of knowledge view"}),_(F,{value:"Check if safe to move",onClick:()=>{const{kv_ids_to_move:g,wc_ids_to_move:b,wcomponents_move_conflicts:w}=zb({root_knowledge_view_id_to_move:t.id,nested_knowledge_view_ids_map:n,knowledge_views_by_id:i,wcomponents_by_id:o});a(xt(g,b)),l(w)}})]});const h=Object.keys(c).length,v=r.size+h;return _("div",{children:[_("h4",{children:"Change base of knowledge view"}),h>0&&_("p",{children:["There are other knowledge views which are not nested under this knowledge view and that contain ",_("span",{style:{color:"darkred"},children:[h," components"]})," that are also in this knowledge view.  These entries can be moved to the new base or left assigned to this base.  All the nested knowledge views and their components will be moved regardless."]}),h>0&&_("p",{children:[_("i",{children:_("b",{children:[h," component(s) also present in other knowledge views:"]})}),_(KM,{wcomponents_move_conflicts:c})]}),h===0&&_("p",{children:[_("i",{children:_("b",{children:"Safe to move!"})}),"   All of the knowledge views and components in and nested under this knowledge view are contained in this knowledge view.  None of them are present in any other knowledge views that are not nested under this knowledge view."]}),_("p",{children:[_("i",{children:_("b",{children:"Step 2 of 3: Select base to move to"})}),_(UM,{base_id_to_move_to:d,on_change:g=>u(g)})]}),d!==void 0&&_("div",{children:[r.size!==v&&_(ns,{disabled:v===0,button_text:`Move all ${v} components to new base (including conflicted)`,on_click:()=>{const g=Array.from(r).concat(Object.keys(c));lv(g,s,d,m)}}),_(ns,{disabled:r.size===0,button_text:`Move ${r.size} components (no conflicts) to new base`,on_click:()=>{const g=Array.from(r);lv(g,s,d,m)}})]}),f&&_("p",{children:[f.error&&_("div",{style:{backgroundColor:"pink"},children:["Got error whilst trying to change base id of components ",_("br",{}),_("pre",{children:JSON.stringify(f.error,null,2)})]}),f.data&&_("div",{style:{backgroundColor:"lightgreen"},children:["Successfully changed base id of ",f.data," components & knowledge views.  Reloading page in ",c1," seconds"]})]})]})}const ZM=JM(XM),c1=2;async function lv(e,t,n,i){const s=await Ce().rpc("move_ids_to_new_base",{ids:e,from_base_id:t,to_base_id:n});i(s),s.error||(nn.debug("Reloading page after moving ids to new base"),setTimeout(()=>document.location.reload(),c1*1e3))}const QM=e=>({knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids_map:e.derived.nested_knowledge_view_ids.map}),eq=j(QM);function tq(e){const{placeholder:t,selected_option_id:n=void 0,allowed_ids:i,exclude_ids:o=new Set,on_change:s,knowledge_views:r,nested_knowledge_view_ids_map:a}=e,c=z(()=>nq(r,i,o).map(({id:d,title:u})=>{let f="",m=a[d];for(;m;)f=" / "+m.title+f,m=a[m.parent_id||""];return{id:d,title:u,subtitle:f}}).sort((d,u)=>d.title<u.title?-1:1),[r,i,o,a]);return _(de,{placeholder:t||"Select knowledge view...",allow_none:!0,selected_option_id:n,options:c,on_change:s,editing_allowed:e.editing_allowed})}const bo=eq(tq);function nq(e,t,n){let i=e;return t&&(i=i.filter(({id:o})=>t.has(o))),n.size&&(i=i.filter(({id:o})=>!n.has(o))),i}const iq=e=>({knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,editing:!e.display_options.consumption_formatting}),oq={upsert_knowledge_view:x.specialised_object.upsert_knowledge_view},sq=j(iq,oq);function rq(e){const{owner_knowledge_view:t,knowledge_views_by_id:n,on_change:i,editing:o}=e,s=t.foundation_knowledge_view_ids||[],r=new Set(s),a=[],c=[];s.forEach(m=>{const h=n[m];h?a.push(h):c.push(m)}),c.length&&console.warn(`Did not find foundational knowledge view ids: ${c.join(", ")}`);const l=new Set(r);l.add(t.id);const d=a.length,{parent_knowledge_view_id:u}=t,f=!!a.find(m=>m.id===u);return _("div",{children:[(o||a.length>0)&&"Foundational Views",o&&_("span",{children:["(",d,")"]}),o&&_(bo,{placeholder:"Search for knowledge view to add...",exclude_ids:l,on_change:m=>{m&&i([m,...s])}}),o&&u&&!f&&_(F,{value:"Use parent view as foundation",onClick:()=>i([u,...s])}),a.map((m,h)=>_("div",{style:{display:"flex",flexDirection:"row"},children:[_("div",{style:{flex:"1"},children:d-h}),_("div",{style:{flex:"9"},children:m.title}),_("div",{style:{flex:"3"},children:o&&_(F,{value:"remove",onClick:()=>{i(us(s,v=>v===m.id))}})})]},m.id)),c.length>0&&_("div",{children:["Could not find ",c.length," knowledge views"]})]})}const _q=sq(rq),aq=(e,t)=>{const n=di(e,t.knowledge_view_id),{wcomponents_by_id:i,knowledge_views_by_id:o}=e.specialised_objects;return{knowledge_view:n,wcomponents_by_id:i,knowledge_views_by_id:o,editing:!e.display_options.consumption_formatting,is_current_kv:e.routing.args.subview_id===t.knowledge_view_id}},cq=j(aq);function lq(e){const{editing:t,knowledge_view:n,wcomponents_by_id:i,knowledge_views_by_id:o,on_change:s}=e,[r,a]=I(e.is_current_kv||e.show_automatically||!1);if(!n)return _("div",{});if(!r)return _(F,{value:"Calculate active assumptions",onClick:()=>a(!0)});const c=n.active_counterfactual_v2_ids||[],l=$t(n,o,!0),d=z(()=>{const u=lt(l,i).composed_wc_id_map;return Object.keys(u).map(m=>i[m]).filter(be).filter(({type:m})=>m==="counterfactualv2").map(m=>({id:m.id,title:Qe({wcomponent:m,text_type:fe.plain,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:void 0,created_at_ms:dv,sim_ms:dv})}))},[i,...l]);if(t){if(d.length===0)return _("div",{children:"No counterfactuals in composed knowledge view (includes foundational knowledge views)"})}else if(c.length===0)return _("div",{children:"No assumptions set"});return _("div",{children:_(wi,{placeholder:"...",allow_none:!0,selected_option_ids:c,options:d,on_change:s})})}const dq=cq(lq),dv=new Date().getTime()+1e11,uq=e=>{const{editing:t,knowledge_view:n}=e,i=$t(n,e.knowledge_views_by_id,!1),o=rb(i,!1),{datetime_line_config:s={}}=n,r=s.time_origin_ms??o.time_origin_ms,a=f=>{const m={...s,...f};e.update_item({...n,datetime_line_config:m})};if(r===void 0)return t?_("div",{children:[_("h4",{children:"Configure X Axis Datetime"}),_("p",{children:_(ht,{title:"Time origin",value:void 0,on_change:f=>{const m=f?f.getTime():void 0;a({time_origin_ms:m})}})})]}):null;const c=qo(s,o,"time_origin_x"),l=qo(s,o,"time_scale"),d=qo(s,o,"time_line_number"),u=qo(s,o,"time_line_spacing_days");return _("div",{children:[_("h4",{children:"Configure X Axis Datetime"}),_("p",{children:_(ht,{title:"Time origin",value:new Date(r),on_change:f=>{const m=f?f.getTime():void 0;a({time_origin_ms:m})}})}),_("p",{children:[_(st,{placeholder:"Time origin position",value:c.value,allow_undefined:!0,on_blur:f=>{a({time_origin_x:f})},on_blur_type:G.conditional,style:{width:"70%"}}),t&&_(Vo,{source:c.source})]}),_("p",{children:[_(st,{placeholder:"Time scale",value:l.value,allow_undefined:!0,on_blur:f=>{a({time_scale:f})},on_blur_type:G.conditional,style:{width:"70%"}}),t&&_(Vo,{source:l.source})]}),_("p",{children:[_(st,{placeholder:"Time line number",value:d.value,allow_undefined:!0,on_blur:f=>{a({time_line_number:f})},on_blur_type:G.conditional,style:{width:"70%"}}),t&&_(Vo,{source:d.source})]}),_("p",{children:[_(st,{placeholder:"Days between time line",value:u.value,allow_undefined:!0,on_blur:f=>{a({time_line_spacing_days:f})},on_blur_type:G.conditional,style:{width:"70%"}}),t&&_(Vo,{source:u.source})]}),t&&_("p",{children:_(F,{value:"Clear (to inherited or default to month)",fullWidth:!0,onClick:()=>{a({time_scale:void 0,time_line_number:void 0,time_line_spacing_days:void 0})}})}),t&&_("p",{style:{display:"flex",flexDirection:"row",justifyContent:"space-evenly",alignItems:"center"},children:[_("div",{children:"Defaults:"}),"  ",_(F,{value:"Week",fullWidth:!1,onClick:()=>{a({time_scale:3,time_line_number:8,time_line_spacing_days:7})}})," ",_(F,{value:"Month",fullWidth:!1,onClick:()=>{a({time_scale:Ki.time_scale,time_line_number:Ki.time_line_number,time_line_spacing_days:Ki.time_line_spacing_days})}})," ",_(F,{value:"Year",fullWidth:!1,onClick:()=>{a({time_scale:.3,time_line_number:2,time_line_spacing_days:365})}})]})]})};function qo(e,t,n){const i=e[n]??t[n]??Ki[n],o=i===e[n]?0:i===t[n]?1:2;return{value:i,source:o}}function Vo(e){if(e.source===0)return null;const t=e.source===1?"Inherited from foundation":"Default";return _("div",{style:{color:"grey",fontSize:11},title:t,children:e.source===1?"(Inherited)":"(Default)"})}function l1(e){const{items_descriptor:t,on_click_header:n,other_content:i=()=>null}=e;return _("div",{onClick:o=>{o.stopImmediatePropagation(),n&&n()},style:{cursor:n?"pointer":"default"},title:e.items_descriptor_title,children:[i(),_("div",{className:"item_descriptors",children:t}),_("div",{style:{clear:"both"}})]})}var d1=(e=>(e[e.collapsed=0]="collapsed",e[e.partial_expansion=1]="partial_expansion",e[e.expanded=2]="expanded",e))(d1||{});const pq=e=>({editing:!e.display_options.consumption_formatting}),mq=j(pq);function fq(e){const t=e.expanded_initial_state||(e.disable_collapsed?e.disable_partial_collapsed?2:1:0),[n,i]=I(t),o=n===2,{header_content:s=()=>null,content:r,items_count:a,item_descriptor:c,items_descriptor:l=_i(c,a,e.editing),items_descriptor_title:d,disable_partial_collapsed:u=!1}=e;function f(){let m=(n+1)%3;e.disable_collapsed&&m===0&&++m,u&&m===1&&++m,i(m)}return _("div",{children:[_(l1,{items_descriptor:l,items_descriptor_title:d,on_click_header:f,other_content:s}),r({disable_partial_collapsed:u,expanded_items:n>0,expanded_item_rows:o})]})}const on=mq(fq);function _i(e,t,n=!0){return(n||t!==void 0&&t!==0)&&(e+=` (${t})`),e}function Ds(e){const{new_item_descriptor:t,on_pointer_down_new_list_entry:n}=e;return _("div",{children:_(F,{fullWidth:!0,onClick:i=>{i.stopImmediatePropagation(),n()},children:`New ${t}`})})}const hq=e=>({consumption_formatting:e.display_options.consumption_formatting}),vq=j(hq);function gq(e){const{items_count:t,item_descriptor:n,new_item_descriptor:i=n,consumption_formatting:o}=e;return _(on,{header_content:()=>o?null:_(Ds,{new_item_descriptor:i,on_pointer_down_new_list_entry:e.on_click_new_item}),content:e.content,items_count:t,items_descriptor:e.items_descriptor,item_descriptor:n,disable_collapsed:e.disable_collapsed,disable_partial_collapsed:e.disable_partial_collapsed,expanded_initial_state:e.expanded_initial_state})}const u1=vq(gq);var Jd={},wq=Q;Object.defineProperty(Jd,"__esModule",{value:!0});var Xd=Jd.default=void 0,bq=wq(Z()),yq=ee(),kq=(0,bq.default)((0,yq.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}),"Delete");Xd=Jd.default=kq;const xq=e=>({consumption_formatting:e.display_options.consumption_formatting}),Aq=j(xq);function Sq(e){return e.consumption_formatting?null:_(ns,{disabled:e.disabled,on_click:e.on_delete,button_text:e.button_text??"Delete",button_icon:_(Xd,{}),tooltip_text:e.tooltip_text})}const jn=Aq(Sq);class Zd extends Ev{constructor(t){super(t);const{calc_initial_custom_expansion_state:n}=t,i=n&&n(t.item),o=i!==void 0?i:!!t.expanded;this.state={internal__expanded:o}}componentDidUpdate(t,n){this.props.expanded!==t.expanded&&this.setState({internal__expanded:!!this.props.expanded})}render(){const{item:t,get_created_at:n,get_custom_created_at:i,set_custom_created_at:o=(S,T)=>({...S,custom_created_at:T}),get_summary:s,get_details:r,get_details2:a,get_details3:c,crud:l,delete_button_text:d,hide_expansion_button:u}=this.props,{update_item:f,delete_item:m}=l,h=i?i(t):void 0,{internal__expanded:v}=this.state,g=v?"expanded":"",b=this.props.extra_class_names||"",w=`editable_list_entry ${g} ${b}`,k=z(()=>m&&(()=>m(t)),[m,t]),y=S=>{f(o(t,S))};return _("div",{className:w,children:[_("div",{className:"summary_header",children:[_("div",{className:"summary",children:s(t,l,v)}),!(u&&u(t))&&_("div",{className:"expansion_button",title:v?"Collapse":"Expand",onClick:()=>this.setState({internal__expanded:!v})})]}),v&&_(Re,{children:[r(t,l),_("div",{className:"details2",children:a&&a(t,l)}),_("div",{children:[k&&_(jn,{on_delete:k,button_text:d}),_("br",{}),(n||i)&&_(it,{children:_(ht,{title:"Created at",invariant_value:n&&n(t),value:h,on_change:y})})]}),_("div",{className:"details3",children:c&&c(t,l)})]})]})}}function ai(e){const{items:t,get_id:n,item_props:i,debug_item_descriptor:o=""}=e;return r=>{const{expanded_items:a,expanded_item_rows:c}=r;return _("div",{style:{display:a?"":"none",cursor:"initial"},onClick:l=>l.stopPropagation(),children:t.map((l,d)=>_("div",{children:[_("hr",{className:"entries_horizontal_dividers"}),_(Zd,{item:l,...i,expanded:c})]},n(l)))})}}const Cq=new Set(["knowledge","priorities"]);function $q(e){return Cq.has(e)?e:"knowledge"}function Oi(e){const{parent_knowledge_view_id:t,knowledge_views:n,current_view:i,sort_type:o}=e;if(!e.editing&&n.length===0)return null;const s=ai({items:n,get_id:c=>c.id,item_props:{get_summary:jq(i),get_details:h1(e),get_details3:Tq,calc_initial_custom_expansion_state:Nq(e),crud:{update_item:c=>{e.upsert_knowledge_view({knowledge_view:c})}}},debug_item_descriptor:"View"}),r=Pq(e);if(o==="hidden"||o==="archived"||o==="errored")return _(on,{items_count:n.length,content:s,item_descriptor:Ht(o)+" "+(e.item_descriptor||"View"),disable_collapsed:!1,expanded_initial_state:r});const a=(o==="priority"?"Priority ":"")+(e.item_descriptor||"View");return _(u1,{items_count:n.length,on_click_new_item:()=>{zS({knowledge_view:{title:f1(),parent_knowledge_view_id:t,sort_type:o},creation_context:e.creation_context})},content:s,item_descriptor:a,disable_collapsed:!0,expanded_initial_state:r})}function jq(e){const t=$q(e);return(n,i)=>_(De,{route:void 0,sub_route:void 0,item_id:void 0,args:{view:t,subview_id:n.id},selected_on:new Set(["route","args.subview_id"]),children:n.title})}function Tq(){return _("div",{children:[_("br",{}),_("br",{})]})}function Pq(e){const{current_kv_parent_ids:t,knowledge_views:n,current_subview_id:i}=e;return!!n.find(({id:s})=>s===i||t.has(s))?d1.partial_expansion:void 0}function Nq(e){return t=>e.current_kv_parent_ids.has(t.id)?!0:void 0}function p1(e){const{priority:t,normal:n,hidden:i,archived:o,errored:s}=z(()=>{const r=[],a=[],c=[],l=[],d=[];return e.knowledge_views.forEach(u=>{const f=e.nested_knowledge_view_ids.map[u.id];(f==null?void 0:f.sort_type)==="errored"?d.push(u):u.sort_type==="hidden"?c.push(u):u.sort_type==="archived"?l.push(u):u.sort_type==="priority"?r.push(u):a.push(u)}),{priority:r,normal:a,hidden:c,archived:l,errored:d}},[e.knowledge_views]);return _("div",{children:[_("br",{}),_(Oi,{...e,knowledge_views:t,sort_type:"priority"}),_("br",{}),_(Oi,{...e,knowledge_views:n,sort_type:"normal"}),_("br",{}),_(Oi,{...e,knowledge_views:i,sort_type:"hidden"}),_("br",{}),_(Oi,{...e,knowledge_views:o,sort_type:"archived"}),_("br",{}),_(Oi,{...e,knowledge_views:s,sort_type:"errored"})]})}function m1(e,t){const n=new Set;let i=e[t];for(;i&&i.parent_id;)n.add(i.parent_id),i=e[i.parent_id];return n}const f1=()=>ss(!1),h1=e=>(t,n)=>{const{editing:i,nested_knowledge_view_ids:o}=e,s=o.map[t.id],r=((s==null?void 0:s.child_ids)||[]).map(h=>e.knowledge_views_by_id[h]).filter(be),a=!!e.wcomponents_by_id[(t==null?void 0:t.id)||""],c=t.base_id!==e.chosen_base_id,l=(e.bases_by_id||{})[t.base_id],d=e.current_subview_id===t.id,u=z(()=>new Set(e.possible_parent_knowledge_view_ids),[e.possible_parent_knowledge_view_ids]);let f="";s!=null&&s.ERROR_is_circular&&(f="Is circularly nested"),s!=null&&s.ERROR_parent_kv_missing&&(f="Parent knowledge view is missing (may be present in a different knowledge base)");let m="";return s!=null&&s.ERROR_parent_from_diff_base&&(m="Parent knowledge view from a different base"),_("div",{style:{backgroundColor:"white",border:"thin solid #aaa",borderRadius:3,padding:5,margin:5},children:[c&&_("div",{style:{cursor:"pointer"},onClick:()=>e.update_chosen_base_id({base_id:t.base_id}),title:`Click to change to base ${t.base_id}`,children:[_(rn,{message:""}),'  Is part of base "',l==null?void 0:l.title,'"']}),_("p",{style:{display:"inline-flex"},children:[_(He,{placeholder:"Title",value:t.title,on_blur:h=>{const v=f1();n.update_item({...t,title:h??v})},on_blur_type:G.conditional}),a&&_(De,{route:"wcomponents",sub_route:void 0,item_id:t.id,args:void 0,children:[_($n,{}),"Component"]}),!a&&i&&_("span",{style:{cursor:"pointer"},onClick:()=>{On({wcomponent:{base_id:t.base_id,id:t.id,title:t.title,type:"statev2"}})},children:[_($n,{}),"Create Component"]})]}),(i||t.description)&&_("p",{children:[i&&_("span",{className:"description_label",children:"Description"}),"  ",_(Wt,{placeholder:"...",value:t.description,on_blur:h=>{n.update_item({...t,description:h})},on_blur_type:G.conditional})]}),_("div",{children:[_("span",{className:"description_label",children:"Active assumptions (counterfactuals)"}),_(dq,{knowledge_view_id:t.id,on_change:h=>n.update_item({...t,active_counterfactual_v2_ids:h})})]}),_("p",{children:_(_q,{owner_knowledge_view:t,on_change:h=>{n.update_item({...t,foundation_knowledge_view_ids:h})}})}),(i||f||m)&&_("p",{children:[_("span",{className:"description_label",children:"Nest under"}),f&&_("div",{style:{backgroundColor:"pink"},children:[" ",f," "]}),m&&_("div",{children:[_(rn,{message:m})," ",m]}),_(bo,{selected_option_id:t.parent_knowledge_view_id,allowed_ids:u,on_change:h=>{n.update_item({...t,parent_knowledge_view_id:h})}})]}),i&&_("p",{children:[_("span",{className:"description_label",children:"Sort status"}),_(de,{selected_option_id:t.sort_type,options:FM.map(h=>({id:h,title:h})),allow_none:!1,on_change:h=>h&&n.update_item({...t,sort_type:h})})]}),_("hr",{}),i&&!d&&_("div",{children:[_(De,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:t.id},children:"Change to this knowledge view"})," to edit datetime lines config and change the base."]}),i&&d&&_("div",{children:[_(uq,{editing:i,knowledge_view:t,knowledge_views_by_id:e.knowledge_views_by_id,update_item:n.update_item}),_("hr",{}),_(ZM,{knowledge_view:t}),_("hr",{}),_("br",{})]}),(i||r.length>0)&&_("p",{children:_(p1,{...e,parent_knowledge_view_id:t.id,knowledge_views:r,item_descriptor:"Nested"})}),_("br",{})]})},Eq=e=>{const t=Be(e);return{ready_for_reading:e.sync.ready_for_reading,knowledge_view:t,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids:e.derived.nested_knowledge_view_ids,creation_context:e.creation_context,editing:!e.display_options.consumption_formatting,current_view:e.routing.args.view,current_subview_id:e.routing.args.subview_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}},Iq={upsert_knowledge_view:x.specialised_object.upsert_knowledge_view,update_chosen_base_id:x.user_info.update_chosen_base_id},Rq=j(Eq,Iq);function Dq(e){const{knowledge_view:t,upsert_knowledge_view:n}=e;if(!e.ready_for_reading)return _("div",{children:"Loading..."});if(!t)return _("div",{children:"No knowledge view selected"});const i=z(()=>e.knowledge_views.filter(a=>a.base_id===e.chosen_base_id).map(a=>a.id),[e.knowledge_views]),o=m1(e.nested_knowledge_view_ids.map,e.current_subview_id),r={create_item:()=>{throw new Error("Not implemented create knowledge view")},update_item:a=>n({knowledge_view:a}),delete_item:()=>{throw new Error("Not implemented delete knowledge view")}};return h1({...e,possible_parent_knowledge_view_ids:i,current_kv_parent_ids:o,chosen_base_id:e.chosen_base_id,bases_by_id:e.bases_by_id,update_chosen_base_id:e.update_chosen_base_id})(t,r)}const Oq=Rq(Dq),Mq=e=>({ready:e.sync.ready_for_reading,knowledge_views:e.derived.knowledge_views,nested_knowledge_view_ids:e.derived.nested_knowledge_view_ids,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,creation_context:e.creation_context,current_view:e.routing.args.view,current_subview_id:e.routing.args.subview_id,editing:!e.display_options.consumption_formatting,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}),qq={upsert_knowledge_view:x.specialised_object.upsert_knowledge_view,update_chosen_base_id:x.user_info.update_chosen_base_id},Vq=j(Mq,qq);function Fq(e){if(e.knowledge_views.length===0)return _("div",{style:{cursor:"progress"},children:e.ready?"Automatically creating a knowledge view...":"Loading..."});const t=z(()=>e.knowledge_views.filter(o=>o.base_id===e.chosen_base_id).map(o=>o.id),[e.knowledge_views]),n=e.nested_knowledge_view_ids.top_ids.map(o=>e.knowledge_views_by_id[o]).filter(be),i=m1(e.nested_knowledge_view_ids.map,e.current_subview_id);return _(p1,{...e,parent_knowledge_view_id:void 0,knowledge_views:n,possible_parent_knowledge_view_ids:t,upsert_knowledge_view:e.upsert_knowledge_view,current_kv_parent_ids:i,chosen_base_id:e.chosen_base_id,bases_by_id:e.bases_by_id,update_chosen_base_id:e.update_chosen_base_id})}const zq=Vq(Fq);function Lq(e){return _(E,{p:1,pt:5,class:"views_side_panel",children:["Current View:",_(Oq,{}),_("br",{}),_("br",{}),_("br",{}),_("br",{}),_("br",{}),_(zq,{})]})}const Bq={change_route:x.routing.change_route},Uq=j(null,Bq);function Wq(e){return _(r0,{on_change:t=>{t&&e.change_route({route:"wcomponents",item_id:t})},on_blur:()=>{e.change_route({route:"wcomponents"})}})}const Hq=Uq(Wq);function Gq(e){const t=Se();return _("div",{className:"side_panel",children:[_("p",{className:"section",children:[_(F,{value:"Expand towards causes (backwards)",fullWidth:!0,onClick:()=>Bw(t)}),_(St,{...ae.expand_select_backwards})]}),_("p",{className:"section",children:[_(F,{value:"Expand towards effects (forwards)",fullWidth:!0,onClick:()=>Lw(t)}),_(St,{...ae.expand_select_forwards})]}),_("p",{className:"section",children:[_(F,{value:"Select all components",fullWidth:!0,onClick:()=>Rl(t)}),_(St,{...ae.select_all})]}),_("p",{className:"section",children:[_(F,{value:"Expand selection (in all directions)",fullWidth:!0,onClick:()=>Fw(t)}),_(St,{...ae.expand_select})]}),_("p",{className:"section",children:[_(F,{value:"Contract selection (in all directions)",fullWidth:!0,onClick:()=>zw(t)}),_(St,{...ae.decrease_select})]}),_("p",{className:"section",children:[_(F,{value:"Select components inbetween",fullWidth:!0,onClick:()=>Ww(t)}),_(St,{...ae.select_interconnections}),_("div",{className:"description",children:"Only selects the immediate components inbetween.  e.g. if A ---B--> C ---D--> E, then selecting nodes A and C followed by this command will also select connection B.  But if only node A and node E are selected, then this command will not do anything."})]})]})}const uv=()=>({r:255,g:255,b:255,a:1});function v1(e){const[t,n]=I(e.color||uv());_e(()=>{n(e.color||uv())},[Tt(e.color)]);const i=s=>{const r=pv(t,s);n(r)},o=s=>{const r=pv(t,s);mv(t,r)&&n(r),mv(e.color,r)&&e.conditional_on_blur(r)};return _("div",{className:"color_picker",children:[_(st,{placeholder:"r",value:t.r,allow_undefined:!1,conditional_on_change:s=>i({r:s}),on_blur:s=>o({r:s}),on_blur_type:G.always,style:{width:65}}),"  ",_(st,{placeholder:"g",value:t.g,allow_undefined:!1,conditional_on_change:s=>i({g:s}),on_blur:s=>o({g:s}),on_blur_type:G.always,style:{width:65}}),"  ",_(st,{placeholder:"b",value:t.b,allow_undefined:!1,conditional_on_change:s=>i({b:s}),on_blur:s=>o({b:s}),on_blur_type:G.always,style:{width:65}}),"  ",_(st,{placeholder:"a",value:t.a,allow_undefined:!1,conditional_on_change:s=>i({a:s}),on_blur:s=>o({a:s}),on_blur_type:G.always,style:{width:65}}),"  ",_("div",{className:"color_swatch",style:{backgroundColor:Tt(t)}})]})}function pv(e,t){const n={...e,...t};return Kq(n)}function Kq(e){let{r:t,g:n,b:i,a:o}=e;return t=Ve(t,0,255),n=Ve(n,0,255),i=Ve(i,0,255),o=Ve(o,0,1),{r:t,g:n,b:i,a:o}}function mv(e,t){return e?Tt(e)!==Tt(t):!0}const Yq=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id}),Jq={change_route:x.routing.change_route},Xq=j(Yq,Jq);function Zq(e){const{wcomponent_id:t,wcomponents_by_id:n,knowledge_views_by_id:i}=e,[o,s]=I(!1),[r,a]=I([]);if(_e(()=>{let d=[];o&&(d=Object.values(n).filter(u=>ro(u)).filter(u=>u.title.includes(t)||u.description.includes(t)||(u.label_ids||[]).includes(t)||(_n(u)||Le(u))&&(u.parent_goal_or_action_ids||[]).includes(t)||pt(u)&&u.judgement_target_wcomponent_id===t||ki(u)&&u.values_and_prediction_sets.find(f=>f.entries.find(m=>(m.explanation||"").includes(t)))||yi(u)&&u.validity.find(f=>(f.explanation||"").includes(t))||we(u)&&(u.from_id===t||u.to_id===t)||vt(u)&&u.attribute_wcomponent_id===t).filter(u=>u.id!==t)),a(d)},[t,n,o]),!o)return _("div",{children:_(F,{value:"Show back references",onClick:()=>s(!0)})});if(r.length===0)return _("div",{children:"No back references"});const c=new Date().getTime(),l=c;return _("div",{children:["Back references:",r.map(d=>_("div",{children:_(De,{route:void 0,sub_route:void 0,item_id:d.id,args:void 0,children:_(ji,{children:Qe({wcomponent:d,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:void 0,created_at_ms:c,sim_ms:l})||`No title for component ${d.id}`})})}))]})}const Qq=Xq(Zq),eV=e=>{const t=ne(e),n=Be(e),i=t==null?void 0:t.composed_datetime_line_config;return{kv:n,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,created_at_ms:e.routing.args.created_at_ms,time_origin_ms:i==null?void 0:i.time_origin_ms,time_origin_x:i==null?void 0:i.time_origin_x,time_scale:i==null?void 0:i.time_scale}},tV={upsert_knowledge_view:x.specialised_object.upsert_knowledge_view},nV=j(eV,tV);function iV(e){const[t,n]=I(void 0),{kv:i,wcomponent_id:o,wcomponents_by_id:s,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l,upsert_knowledge_view:d}=e,u=(o?[o]:e.wcomponent_ids)||[],{id:f,wc_id_map:m}=i||{},h=!i||!f||m===void 0||a===void 0||c===void 0||l===void 0||!!o&&ql({wcomponent_id:o,wcomponents_by_id:s,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l})===void 0,v=h?a===void 0?"Disabled as time origin not set":c===void 0?"Disabled as time origin X position is not set":"Diabled":"";let g="";return t!==void 0&&(t?u.length>1&&(g=`Changed ${t}`):g="No changes"),_("div",{style:{display:"inline-block"},children:[_(F,{disabled:h,value:"X by time",title:v,onClick:()=>{if(h)return;const{number_changed:b,knowledge_view:w}=sV({wcomponent_ids:u,wcomponents_by_id:s,kv:i,wc_id_map:m,created_at_ms:r,time_origin_ms:a,time_origin_x:c,time_scale:l});b&&w&&d({knowledge_view:w}),n(b),setTimeout(()=>n(void 0),1e3)},is_left:!0}),g]})}const oV=nV(iV);function sV(e){const{wcomponent_ids:t,wcomponents_by_id:n,kv:i,wc_id_map:o,created_at_ms:s,time_origin_ms:r,time_origin_x:a,time_scale:c}=e;let l=0;if(!i||!o||r===void 0||a===void 0||c===void 0)return{number_changed:l,knowledge_view:void 0};const d={...o};t.forEach(f=>{const m=o[f];if(!m)return;const h=ql({wcomponent_id:f,wcomponents_by_id:n,created_at_ms:s,time_origin_ms:r,time_origin_x:a,time_scale:c});if(h===void 0)return;const v={...m,left:h};d[f]=v,l+=1});const u=l?{...i,wc_id_map:d}:void 0;return{number_changed:l,knowledge_view:u}}const rV=(e,t)=>{const n=Be(e),i=n==null?void 0:n.id,o=t.wcomponent_ids||[t.wcomponent_id],s=!!o.find(a=>e.derived.wcomponent_ids_by_type.any_node.has(a)),r=!!o.find(a=>e.derived.wcomponent_ids_by_type.any_link.has(a));return{knowledge_view_id:i,kv:n,wcomponent_node_present:s,wcomponent_link_present:r}},_V={snap_to_grid_knowledge_view_entries:x.specialised_object.snap_to_grid_knowledge_view_entries,bulk_add_to_knowledge_view:x.specialised_object.bulk_add_to_knowledge_view,bulk_update_knowledge_view_entries:x.specialised_object.bulk_update_knowledge_view_entries,change_current_knowledge_view_entries_order:x.specialised_object.change_current_knowledge_view_entries_order},aV=j(rV,_V);function cV(e){const{wcomponent_id:t,knowledge_view_id:n,kv:i}=e,o=e.wcomponent_ids||[e.wcomponent_id],s=i&&t?Object.keys(i.wc_id_map).findIndex(l=>l===t):void 0,r=i?Object.keys(i.wc_id_map).length:void 0,a=s!==void 0&&s+1===r,c=s===0;return _("div",{children:[_("h3",{children:"Align"}),e.wcomponent_node_present&&_(Re,{children:[_(F,{disabled:!n,value:"Snap to grid",onClick:()=>{n&&e.snap_to_grid_knowledge_view_entries({wcomponent_ids:o,knowledge_view_id:n})},is_left:!0})," ",_(oV,{...e})," ",_(F,{disabled:!n,value:"Bring here",onClick:()=>{if(!n)return;const l=Se().getState(),d=xi(l);e.bulk_add_to_knowledge_view({knowledge_view_id:n,wcomponent_ids:o,override_entry:d})},is_left:!0})]}),e.wcomponent_node_present&&e.wcomponent_link_present&&_("br",{}),e.wcomponent_link_present&&_(Re,{children:_(F,{disabled:!n,value:"Manually update link location",onClick:()=>{if(!n)return;const l=Se().getState(),d=lV(o,l);d&&e.bulk_update_knowledge_view_entries({knowledge_view_id:n,changes:d})},is_left:!0})}),_("br",{}),_("span",{title:a?"Already at front":"Move to front",children:_(F,{value:"Move to front",disabled:a,onClick:()=>{e.change_current_knowledge_view_entries_order({wcomponent_ids:o,order:"front"})},is_left:!0})})," ",_("span",{title:c?"Already at back":"Move to back",children:_(F,{value:"Move to back",disabled:c,onClick:()=>{e.change_current_knowledge_view_entries_order({wcomponent_ids:o,order:"back"})},is_left:!0})})]})}const g1=aV(cV);function lV(e,t){const n=t.derived.current_composed_knowledge_view;if(n)return e.map(i=>me(t,i)).filter(we).map(i=>{const o=me(t,i.from_id),s=me(t,i.to_id),r=o1({wcomponent:i,from_wc:o,to_wc:s,current_composed_knowledge_view:n}),a=Oe({...r,end_size:1,line_behaviour:i.line_behaviour,circular_links:!0,connection_end_type:Bt.positive});if(!a)return;const c=P7({point1:{x:a.line_start_x,y:a.line_start_y},relative_control_point1:a.relative_control_point1,relative_control_point2:a.relative_control_point2,point2:{x:a.line_end_x,y:a.line_end_y}});return{wcomponent_id:i.id,left:c.x,top:-c.y}}).filter(i=>!!i)}const dV=(e,t)=>{const{wcomponent_id:n}=t,i=Be(e),o=i&&i.wc_id_map[n],s=e.derived.knowledge_views;return{knowledge_view_id:i&&i.id,knowledge_view_entry:o,all_knowledge_views:s}},uV=j(dV);function pV(e){const{knowledge_view_id:t,wcomponent_id:n,knowledge_view_entry:i}=e,o=e.all_knowledge_views.filter(({id:r})=>r!==t).filter(({wc_id_map:r})=>{const a=r[n];return a&&!a.blocked&&!a.passthrough});if(o.length===0)return null;const s=!i||i.blocked||i.passthrough;return _("div",{children:[s?"Present":"Also"," in:",o.map(r=>{const a=r.wc_id_map[e.wcomponent_id],c=hi(a,!0);return _("div",{children:_(De,{route:void 0,sub_route:void 0,item_id:void 0,args:{subview_id:r.id,...c},children:r.title})})})]})}const w1=uV(pV),mV=(e,t)=>{const{wcomponent_id:n}=t,i=Be(e),o=i&&i.wc_id_map[n],s=ne(e),r=s&&s.composed_wc_id_map[n],a=xi(e);return{knowledge_view:i,composed_knowledge_view_entry:r,knowledge_view_entry:o,middle_position_left:a.left,middle_position_top:a.top,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponents_by_id:e.specialised_objects.wcomponents_by_id}},fV={upsert_knowledge_view_entry:x.specialised_object.upsert_knowledge_view_entry,bulk_remove_from_knowledge_view:x.specialised_object.bulk_remove_from_knowledge_view},hV=j(mV,fV);function vV(e){const{wcomponent_id:t,knowledge_view:n,composed_knowledge_view_entry:i,knowledge_view_entry:o,editing_allowed:s,knowledge_views_by_id:r,wcomponents_by_id:a}=e;if(!n)return null;const c=$t(n,r,!0),l=lt(c,a),d=$t(n,r,!1),u=lt(d,a),f=rl({editing_allowed:s,wcomponent_id:t,knowledge_view:n,composed_wc_id_maps_object:l,foundation_composed_wc_id_map:u.composed_wc_id_map}),{show_wcomponent_status_in_this_kv_section:m,wcomponent_status_in_this_kv_text:h,show_add_button:v,add_button_text:g,show_remove_button:b,remove_button_text:w,remove_button_tooltip:k,show_remove_and_block_button:y,remove_and_block_button_text:S,remove_and_block_button_tooltip:T}=f;function $(C,O={}){const M={...i||{left:e.middle_position_left,top:e.middle_position_top},...O};e.upsert_knowledge_view_entry({wcomponent_id:t,knowledge_view_id:C,entry:M})}const R=(o==null?void 0:o.frame_width)!==void 0&&(o==null?void 0:o.frame_height)!==void 0;return _("div",{children:[s&&o&&!o.blocked&&_(it,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ci,{component:"legend",children:"Size"}),_(Cv,{color:"secondary",defaultValue:1,marks:!0,min:.25,max:2,onChange:(C,O)=>{const M=Array.isArray(O)?O[0]:O;$(n.id,{s:M})},step:.25,value:o.s?o.s:1,valueLabelDisplay:"on"})]}),s&&o&&!o.blocked&&_(it,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ci,{component:"legend",children:"Frame"}),_("p",{children:_(F,{value:R?"Remove Frame":"Add Frame",onClick:()=>{const C={};R?(C.frame_color=void 0,C.frame_width=void 0,C.frame_height=void 0):(C.frame_color=C.frame_color??cl,C.frame_width=C.frame_width??(ui+ot)*2,C.frame_height=C.frame_height??(An+ot)*2),$(n.id,C)}})}),_("span",{className:"description_label",children:"Frame Color"}),_(v1,{color:o.frame_color,conditional_on_blur:C=>{$(n.id,{frame_color:C})}})]}),s&&_("p",{children:[_(g1,{wcomponent_id:t}),_("br",{})]}),_("div",{style:{display:"inline-flex"},children:[_(y0,{wcomponent_id:t,disable_if_not_present:!0}),_(E,{zIndex:10,m:4,class:"node_handle",children:_(Hd,{wcomponent_id:t,wcomponent_current_kv_entry:i,is_highlighted:!0})})]}),m&&_("div",{children:[h,_("br",{}),v&&_(F,{value:g,extra_class_names:"left",onClick:()=>$(n.id,{blocked:void 0,passthrough:void 0})})]}),b&&_("p",{children:_(jn,{button_text:w,tooltip_text:k,on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"passthrough"})}})}),y&&_("div",{children:_(jn,{button_text:S,tooltip_text:T,on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"block"})}})}),s&&_("p",{children:["Add to knowledge view",_(bo,{on_change:C=>{C&&$(C,{blocked:void 0,passthrough:void 0})}})]}),_("p",{children:_(w1,{wcomponent_id:t})}),_("p",{children:_(Qq,{wcomponent_id:t})})]})}const b1=hV(vV),gV=(e,t)=>{const n=Be(e),i=n&&n.wc_id_map[t.wcomponent_id];return{knowledge_view_title:n&&n.title,knowledge_view_entry:i,editing:!e.display_options.consumption_formatting}},wV={bulk_remove_from_knowledge_view:x.specialised_object.bulk_remove_from_knowledge_view},bV=j(gV,wV);function yV(e){const{wcomponent_id:t,knowledge_view_title:n,knowledge_view_entry:i,editing:o}=e;return _("div",{children:[_(b1,{wcomponent_id:t,editing_allowed:o}),o&&i&&!i.passthrough&&_("p",{children:_(jn,{button_text:"Delete from knowledge view",tooltip_text:"Delete from current knowledge view ("+n+")",on_delete:()=>{e.bulk_remove_from_knowledge_view({wcomponent_ids:[t],remove_type:"passthrough"})}})}),_("p",{children:_(w1,{wcomponent_id:t})})]})}const kV=bV(yV);function xV(e,t){const n=t.type!==void 0&&t.type!==e.type;return e={...e,...t},{wcomponent:e,different_type:n}}const AV=(e,{wcomponent:t})=>{const n=ne(e),i=[];if(n){const{judgement:s,objective:r}=n.wc_ids_by_type,a=Array.from(xt(s,r));kn(e,a).forEach((c,l)=>{pt(c,a[l])&&i.push(c)})}const o=at(e);return{consumption_formatting:e.display_options.consumption_formatting,filtered_wcomponents:i,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},SV={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent},CV=j(AV,SV);function $V(e){const{objective_ids:t=[]}=e.wcomponent;if(e.consumption_formatting&&t.length===0)return null;const n=cn({wcomponents:e.filtered_wcomponents,wcomponents_by_id:e.wcomponents_by_id,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:e.wc_id_to_counterfactuals_map,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _("div",{children:[_("p",{children:["Objectives",_(wi,{editing_allowed:e.editing_allowed,placeholder:"Objectives...",selected_option_ids:t,options:n,allow_none:!0,on_change:i=>e.upsert_wcomponent({objective_ids:i}),on_mouse_over_option:i=>e.set_highlighted_wcomponent({id:i,highlighted:!0}),on_mouse_leave_option:i=>e.set_highlighted_wcomponent({id:i,highlighted:!1})})]}),_("hr",{}),_("br",{})]})}const jV=CV($V),TV={"==":!0,"!=":!0,"<":!0,"<=":!0,">":!0,">=":!0},PV=Object.keys(TV),NV={improving:!0,worsening:!0,stable:!0,unknown:!0,not_assessed:!0},EV=Object.keys(NV);const IV=e=>{var t;return{allowed_wcomponent_ids:(t=e.derived.current_composed_knowledge_view)==null?void 0:t.wc_ids_by_type.any_node,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:at(e),created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},RV={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent},DV=j(IV,RV);function OV(e){const{connection_terminal_description:t,wcomponent_id:n,connection_terminal_type:i,allowed_wcomponent_ids:o,wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:a,on_update_id:c,on_update_type:l,set_highlighted_wcomponent:d}=e,u=n?s[n]:void 0,f=cn({wcomponents_by_id:s,knowledge_views_by_id:r,wc_id_to_counterfactuals_map:a,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms,exclude_ids:e.exclude_ids}),m=[{id:"validity",title:"Validity"},{id:"state",title:"State"},{id:"meta",title:"Meta"}];return _("div",{title:u&&u.title,className:"wcomponent_from_to",children:[_("span",{className:"description_label",children:[t,"  "]}),_(de,{placeholder:t+"...",selected_option_id:n,options:f,allow_none:!0,on_change:h=>c(h),on_mouse_over_option:h=>d({id:h,highlighted:!0}),on_mouse_leave_option:h=>d({id:h,highlighted:!1})}),n&&_(De,{route:void 0,sub_route:void 0,item_id:n,args:void 0,children:_($n,{})}),l&&_(de,{placeholder:"attribute...",selected_option_id:i,options:m,allow_none:!1,on_change:h=>l(h),on_mouse_over_option:h=>d({id:n,highlighted:!0}),on_mouse_leave_option:h=>d({id:n,highlighted:!1})})]})}const dl=DV(OV),MV=(e,{wcomponent:t})=>{const n=t.judgement_target_wcomponent_id,i=me(e,n),o=vo(e,n);return{target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,is_editing:!e.display_options.consumption_formatting}},qV=j(MV);function VV(e){const{wcomponent:t,upsert_wcomponent:n,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r}=e,{judgement_manual:a,judgement_trend_manual:c}=t,l=a===void 0?void 0:a.toString(),d=Xy({judgement_wcomponent:t,target_wcomponent:i,VAP_set_id_to_counterfactual_v2_map:o,created_at_ms:s,sim_ms:r}),f=se(i,{});let m=[];if(f===N.boolean){const h=Bl(i,!0);m=[{id:"True",title:h.true},{id:"False",title:h.false}]}return _("p",{children:[_(dl,{connection_terminal_description:"Target",wcomponent_id:i&&i.id,connection_terminal_type:"meta",on_update_id:h=>{const v={judgement_target_wcomponent_id:h};!t.title&&h&&(v.title=Ht(t.type)+`: @@${h}`),n(v)}}),(e.is_editing||l!==void 0)&&_("p",{children:_("div",{style:{display:"inline-flex"},children:["Manual:   ",_(de,{placeholder:"Manual override...",allow_none:!0,selected_option_id:l,options:LV,on_change:h=>{n({judgement_manual:h===void 0?void 0:h==="true"})}})]})}),l===void 0&&_("p",{children:_("div",{style:{display:"inline-flex"},children:["Comparator:   ",_(de,{extra_styles:{width:30},placeholder:"Operator...",selected_option_id:t.judgement_operator,options:zV,on_change:h=>n({judgement_operator:h})})," ",f!==N.boolean&&_(He,{placeholder:"Value...",value:t.judgement_comparator_value||"",conditional_on_change:h=>{const v=h.trim();v!==t.judgement_comparator_value&&n({judgement_comparator_value:v})}}),f===N.boolean&&_(de,{placeholder:"Value...",selected_option_id:t.judgement_comparator_value,options:m,on_change:h=>{h&&h!==t.judgement_comparator_value&&n({judgement_comparator_value:h})}})]})}),(e.is_editing||c!==void 0&&c!=="not_assessed")&&_("p",{children:_("div",{style:{display:"inline-flex"},children:["Manual trend:   ",_(de,{placeholder:"Manual trend...",allow_none:!0,selected_option_id:c||"Not assessed",options:BV,on_change:h=>{n({judgement_trend_manual:h==="not_assessed"?void 0:h})}})]})}),_("p",{children:_("div",{style:{display:"inline-flex"},children:["Current value:   ",_(yd,{judgement:d,judgement_trend_manual:c,size:"medium"})]})})]})}const FV=qV(VV),zV=PV.map(e=>({id:e,title:e})),LV=[{id:"true",title:"Good"},{id:"false",title:"Bad"}],BV=EV.map(e=>({id:e,title:Ht(e).replaceAll("_"," ")})),UV={boolean:!0,number:!0,other:!0},WV=Object.keys(UV),y1=bb.map(e=>({id:e,title:to(e)})),HV=WV.map(e=>({id:e,title:e}));function GV(e){const{wcomponent:t}=e;return _(k1,{effect_string:t.effect_string,effect_when_true:t.effect_when_true,effect_when_false:t.effect_when_false,editing:e.editing,wcomponents_by_id:e.wcomponents_by_id,upsert_wcomponent:e.upsert_wcomponent})}function k1(e){const{effect_string:t,effect_when_true:n,effect_when_false:i,editing:o,wcomponents_by_id:s,upsert_wcomponent:r}=e,a=z(()=>{if(!t)return;const m=te([{id:-1,name:"",value:t}],s)[0],h=m==null?void 0:m.value;return h!==void 0&&r({effect_when_true:h}),Py(m)},[t]),c=o||t!==void 0,l=n!==void 0,d=i!==void 0;return _("p",{style:{display:"flex",flexDirection:"column"},children:[c&&_("div",{children:[_("span",{className:"description_label",children:"Effect"}),"  ",_("div",{style:{display:"flex"},children:[a&&_(Ny,{...a}),_(He,{placeholder:"",value:t||"",editing_allowed:o,on_blur:u=>r({effect_string:u}),on_blur_type:G.conditional})]})]}),l&&_("div",{children:[_("span",{className:"description_label",children:"Effect value"}),"  ",_("span",{children:n})]}),d&&_("div",{children:[_("span",{className:"description_label",children:"Effect value when false"}),"  ",_("span",{children:i}),o&&_(Re,{children:[" ",_("span",{className:"description_label",style:{cursor:"pointer",color:"#F99"},onClick:()=>r({effect_when_false:void 0}),children:"Field deprecated (click to remove)"})]})]})]})}function KV(e){const{wcomponent:t,editing:n,upsert_wcomponent:i}=e,{line_behaviour:o}=t;return _("div",{children:n&&_("p",{children:[_("span",{className:"description_label",children:"Line style behaviour"}),"  ",_(de,{selected_option_id:o,allow_none:!0,options:YV,on_change:s=>{i({line_behaviour:s})}})]})})}const YV=Xk.map(e=>({id:e,title:Ht(e)})),JV=e=>{const t=Be(e),n=ne(e);return{knowledge_view:t,editing:!e.display_options.consumption_formatting,composed_wc_id_map:n&&n.composed_wc_id_map,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},XV={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:x.specialised_object.upsert_knowledge_view},ZV=j(JV,XV);function QV(e){const{wcomponent:t,upsert_wcomponent:n,wcomponents_by_id:i,knowledge_views_by_id:o,composed_wc_id_map:s,knowledge_view:r}=e;if(!s)return _("div",{children:"Counterfactual form can not render: No current knowledge view"});const a=Object.keys(s).map(v=>i[v]).filter(be).filter(Ge),c=cn({wcomponents:a,wcomponents_by_id:i,knowledge_views_by_id:o,wc_id_to_counterfactuals_map:void 0,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}),l=i[t.target_wcomponent_id||""];let d=[],u=[];Ge(l)&&(d=l.values_and_prediction_sets||[],u=d.map(({id:v,datetime:g})=>{const b=Ul(g,"minute");return{id:v,title:b}}));const f=se(l,i),m=d.find(({id:v})=>v===t.target_VAP_set_id);let h=!1;return r&&(h=(r.active_counterfactual_v2_ids||[]).includes(t.id)),_("div",{children:[_("p",{children:[_("span",{className:"description_label",children:"Target component"}),"  ",t.target_wcomponent_id&&_(De,{route:void 0,sub_route:void 0,item_id:t.target_wcomponent_id,args:void 0,children:[_($n,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:t.target_wcomponent_id,options:c,on_change:v=>n({target_wcomponent_id:v,target_VAP_set_id:void 0,target_VAP_id:void 0}),on_mouse_over_option:v=>e.set_highlighted_wcomponent({id:v,highlighted:!0}),on_mouse_leave_option:v=>e.set_highlighted_wcomponent({id:v,highlighted:!1})})})]}),t.target_wcomponent_id&&_("p",{children:[_("span",{className:"description_label",children:"Target value and prediction set to override"}),"  ",_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:t.target_VAP_set_id,options:u,on_change:v=>{n({target_VAP_set_id:v,target_VAP_id:void 0})}})})]}),l&&m&&_("p",{children:[_("span",{className:"description_label",children:"Counterfactual value"}),"  ",wo({VAP_set:m,VAPs_represent:f,wcomponent:l}).map(v=>{const{VAP_id:g,value_text:b}=v,w=g===t.target_VAP_id;return _("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:g,value:b,checked:w,onChange:()=>n({target_VAP_id:g})}),_("label",{for:g,children:b})]})})]}),r&&_("p",{children:[_("span",{className:"description_label",children:"Apply counterfactual in this knowledge view"}),"  ",_(nt,{value:h,on_change:()=>{const{id:v}=t,g=hb(r.active_counterfactual_v2_ids||[],v),b={...r,active_counterfactual_v2_ids:g};e.upsert_knowledge_view({knowledge_view:b})}}),!m&&h&&_("span",{title:"Will not be applied yet, you need to target a component and one of its value sets",children:_(Ns,{})})]})]})}const eF=ZV(QV);const tF=e=>({show_unused_fields:!e.display_options.consumption_formatting}),nF=j(tF);function iF(e){const{datetime:t,on_change:n,show_unused_fields:i}=e;return _("div",{className:"datetimes",children:[t.min&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(ht,{title:"Minimum datetime",value:t.min,on_change:o=>n({...t,min:o})})})}),(i||t.value)&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(ht,{title:"Expected datetime",value:t.value,on_change:o=>n({...t,value:o})})})}),t.max&&_("div",{className:"datetime_section",children:_("div",{className:"datetime_value",children:_(ht,{title:"Maximum datetime",value:t.max,on_change:o=>n({...t,max:o})})})})]})}const Os=nF(iF),oF=e=>({creation_context_state:e.creation_context}),sF=j(oF);function rF(e){const{wcomponent:t,creation_context_state:n,upsert_wcomponent:i}=e,o=t.datetime||{};return _("p",{children:_(Os,{datetime:o,on_change:s=>i({datetime:s})})})}const _F=sF(rF);function Tn(e){const t=vi(e.value),{conditional_on_change:n,on_blur:i,on_blur_type:o=G.conditional,disabled:s}=e;if(!n&&!i||s){const r="editable_percentage"+(s?"disabled":""),a=e.value!==void 0;return _("div",{className:r,children:[a&&_("span",{className:"description_label",children:e.placeholder}),t||e.placeholder," %"]})}return _("div",{className:"editable_percentage",children:[_(He,{placeholder:e.placeholder,value:t,conditional_on_change:r=>{const a=fv(r);a!==void 0&&n&&n(a)},on_blur:r=>{const a=fv(r);a!==void 0&&i&&i(a)},on_blur_type:o})," %"]})}function fv(e){if(!e)return;const t=parseFloat(e);return Number.isNaN(t)?0:Ve(t,0,100)/100}function aF(e){const{size:t,border_width:n,elements_width:i,conviction:o}=e,s=t/i;return _("g",{className:"conviction_mask",onMouseEnter:r=>r.currentTarget.classList.add("hovered"),onMouseLeave:r=>r.currentTarget.classList.remove("hovered"),ref:r=>{if(!r)return;const a=r.getElementsByClassName("parts")[0];Array.from(a.children).forEach(c=>{const l=c.getAttribute("data-group_id");if(!l)return;let u=parseInt(l,10)/100<=o?"display: none;":"";const f=130+Math.random()*45;u+=`fill: rgb(${f},${f},${f})`,c.setAttribute("style",u)})},children:[_("rect",{x:0,y:0,width:t+2,height:t+2,fill:"rgba(0,0,0,0)"}),_("g",{className:"parts",children:cF.map(r=>_("rect",{"data-group_id":r[2],x:n+r[0]*s,y:n+r[1]*s,width:s,height:s}))})]})}const cF=[[0,9,40],[0,8,30],[0,7,40],[0,6,90],[0,5,10],[0,4,95],[0,3,60],[0,2,60],[0,1,90],[0,0,40],[1,9,20],[1,8,50],[1,7,80],[1,6,60],[1,5,80],[1,4,90],[1,3,90],[1,2,30],[1,1,50],[1,0,30],[2,9,20],[2,8,50],[2,7,80],[2,6,40],[2,5,70],[2,4,20],[2,3,20],[2,2,50],[2,1,60],[2,0,40],[3,9,90],[3,8,50],[3,7,20],[3,6,30],[3,5,60],[3,4,50],[3,3,20],[3,2,2],[3,1,95],[3,0,10],[4,9,80],[4,8,30],[4,7,90],[4,6,60],[4,5,50],[4,4,100],[4,3,40],[4,2,70],[4,1,30],[4,0,98],[5,9,20],[5,8,40],[5,7,70],[5,6,50],[5,5,70],[5,4,90],[5,3,50],[5,2,70],[5,1,10],[5,0,80],[6,9,20],[6,8,5],[6,7,30],[6,6,50],[6,5,70],[6,4,100],[6,3,20],[6,2,90],[6,1,60],[6,0,60],[7,9,30],[7,8,70],[7,7,80],[7,6,70],[7,5,20],[7,4,10],[7,3,30],[7,2,98],[7,1,98],[7,0,90],[8,9,5],[8,8,60],[8,7,95],[8,6,70],[8,5,70],[8,4,80],[8,3,95],[8,2,40],[8,1,95],[8,0,2],[9,9,40],[9,8,40],[9,7,80],[9,6,80],[9,5,90],[9,4,10],[9,3,5],[9,2,60],[9,1,80],[9,0,30]];function x1(e){const{size:t,elements_width:n=10}=e,i=n*n,o=t/n,{counterfactual_probability:s,counterfactual_conviction:r,set_counterfactual:a}=e,c=Fo(s)||Fo(r),{probability:l,conviction:d}=lF(e),u=Fo(s)?s:l,f=Fo(r)?r:d;function m(){if(!a)return;const w=Te({probability:l,conviction:d,counterfactual_probability:s,counterfactual_conviction:r});a({probability:w.new_counterfactual_probability,conviction:w.new_counterfactual_conviction})}const h=3,g=`prediction_badge ${`counterfactual_${c?"":"in"}active`}`,b="Visual display of probability and confidence";return _("div",{style:{cursor:e.disabled?"not-allowed":"pointer"},title:b,children:_("svg",{width:t+h*2,height:t+h*2,onClick:()=>!e.disabled&&m(),className:g,children:[_("rect",{x:0,y:0,width:t+h*2,height:t+h*2,className:"outline"}),_("g",{children:Array.from(Array(i)).map((w,k)=>{const y=k/i,S=k%n,T=Math.floor(k/n);return{i:k,i_frac:y,x:S,y:T,ys:h+(n-1-S)*o,xs:h+T*o}}).map(w=>{const S=(w.i_frac<u?0:1)*255;return{...w,fill:`rgb(${S},${S},${S})`}}).map(w=>_("rect",{x:w.xs,y:w.ys,width:o,height:o,fill:w.fill}))}),_(aF,{size:t,border_width:h,elements_width:n,conviction:f})]})})}function lF({probability:e,conviction:t}){const n=Ve(e,0,1),i=Ve(t,0,1);return n!==e&&console.error(`probability: ${e} not in range 0 to 1`),i!==t&&console.error(`conviction: ${t} not in range 0 to 1`),{probability:n,conviction:i}}function Fo(e){return Number.isFinite(e)}const dF=e=>({creation_context_state:e.creation_context,editing:!e.display_options.consumption_formatting,base_id:_t(e)}),uF=j(dF);function pF(e){const{wcomponent:t,creation_context_state:n,upsert_wcomponent:i,base_id:o}=e,s=t.event_at&&t.event_at[0],r=a=>{const c={event_at:[{probability:1,conviction:1,datetime:{},id:"",base_id:o||-1,explanation:"",...s||{...bi(n)},...a}]};i(c)};return _("p",{children:[_(Os,{datetime:s?s.datetime:{},on_change:a=>r({datetime:a})}),_("br",{}),_("div",{style:{display:"inline-flex"},children:[_(Tn,{placeholder:"Probability",value:s==null?void 0:s.probability,on_blur:a=>r({probability:a}),on_blur_type:G.conditional}),_(Tn,{placeholder:"Confidence",value:s==null?void 0:s.conviction,on_blur:a=>r({conviction:a}),on_blur_type:G.conditional}),"  ",s&&_(x1,{disabled:!0,size:20,probability:s.probability,conviction:s.conviction})]}),_("br",{}),_("br",{}),e.editing&&_(F,{fullWidth:!0,value:s?"Clear Event":"Create Default Event",onClick:()=>{s?i({event_at:[]}):r({conviction:1,probability:1})}})]})}const mF=uF(pF),fF=e=>({creation_context_state:e.creation_context}),hF=j(fF);function vF(e){const{wcomponent:t,upsert_wcomponent:n}=e,i=t.summary_image||void 0;return _(En,{fullWidth:!0,label:"Summary Image URL",onChange:o=>{var r,a;let s=(r=o.target)!=null&&r.value?(a=o.target)==null?void 0:a.value:null;s!==void 0&&n({summary_image:s})},value:i,variant:"outlined"})}const gF=hF(vF),wF=e=>{var t;return{current_kv_id:(t=Be(e))==null?void 0:t.id,goal_or_action_wcomponent_ids:e.derived.wcomponent_ids_by_type.goal_or_action,wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,is_editing:!e.display_options.consumption_formatting,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},bF=j(wF);function yF(e){const{wcomponent:t,wcomponents_by_id:n,upsert_wcomponent:i}=e,o=z(()=>{const r=Array.from(e.goal_or_action_wcomponent_ids).map(c=>n[c]).filter(be);function a(c){return c.id===e.current_kv_id?new Date().getTime():c.created_at.getTime()}return ue(r,a,ce.descending)},[e.goal_or_action_wcomponent_ids,n,e.current_kv_id]),s=cn({wcomponents:o,wcomponents_by_id:n,knowledge_views_by_id:e.knowledge_views_by_id,wc_id_to_counterfactuals_map:{},created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _(it,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ci,{component:"legend",children:"Parent Goal (or Action)"}),_(wi,{placeholder:"Add Label",selected_option_ids:t.parent_goal_or_action_ids||[],options:s,allow_none:!0,on_change:r=>{const a=r.filter(c=>!!c);i({parent_goal_or_action_ids:a})}})]})}const kF=bF(yF),xF=e=>({editing:!e.display_options.consumption_formatting,wcomponents_by_id:e.derived.composed_wcomponents_by_id}),AF={},SF=j(xF,AF);function CF(e){const{wcomponent:t,wcomponents_by_id:n}=e,{calculations:i=[]}=t;i.forEach((u,f)=>u.id=u.id??f);const[o,s]=I(i.length>0),r={};i.forEach(u=>r[u.id]=!1);const[a,c]=I(r),l=te(i,n),d=i.map(({name:u})=>u);return _("div",{className:"editable_list_entry padded "+(o?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>s(!o),children:[_("div",{className:"summary",children:[_("h4",{style:{display:"inline-block"},children:["Calculations ",!o&&i.length?`(${i.length})`:""]}),_("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:_($i,{warning:"",label:""})})]}),_("div",{className:"expansion_button"})]}),o&&_("div",{children:[_(E,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map((u,f)=>_(S9,{editing:e.editing,show_options:a[u.id]||!1,set_show_options:m=>{const h={...a,[u.id]:m};c(h)},calculation:u,calculation_result:l[f],existing_calculation_name_ids:d,update_calculation:m=>{const v=[...i.slice(0,f),m,...i.slice(f+1)].filter(b=>!!b),g=v.length?v:void 0;e.upsert_wcomponent({calculations:g})},disallowed_commands:(()=>{const m=new Set;return f===0&&m.add("move_up"),f===i.length-1&&m.add("move_down"),m})(),update_calculations:m=>{if(m==="move_up"){const h=f-1;if(!At(i,h))return;const v=bt(i,f,h);e.upsert_wcomponent({calculations:v})}else if(m==="move_down"){const h=f+1;if(!At(i,h))return;const v=bt(i,f,h);e.upsert_wcomponent({calculations:v})}else if(m==="add_above"){const h=qc(i),v=yt(i,h,f);e.upsert_wcomponent({calculations:v})}else if(m==="add_below"){const h=qc(i),v=yt(i,h,f+1);e.upsert_wcomponent({calculations:v})}}},u.id))}),e.editing&&_(F,{value:"Add calculation",fullWidth:!0,onClick:()=>{const u=qc(i),f=[...i,u];e.upsert_wcomponent({calculations:f})}})]})]})}const $F=SF(CF);function qc(e){let t=-1;e.forEach(o=>t=Math.max(t,o.id)),++t;const n=wn(e.map(({name:o})=>o));return{id:t,name:n,value:""}}function jF(e){const t=kl(e);return{id:pl(),value:"",description:"",order:t+1}}function TF(e){const{editing:t,value_possibility:n,count_of_value_possibilities:i,update_value_possibility:o}=e,[s,r]=I(n.value);_e(()=>r(n.value),[n.value]);const c=(i[s.toLowerCase()]||0)>1?`Current value "${s}" is already present in other possible values.`:"";return _(E,{p:1,flexGrow:1,flexShrink:1,flexBasis:"100%",maxWidth:"100%",marginTop:"5px",style:{display:"flex"},children:[_(E,{style:{width:"100%"},children:[_($i,{warning:c,label:"Duplicate"}),_(re,{noWrap:!0,textOverflow:"ellipsis",variant:"caption",children:_(He,{placeholder:"Possible value",hide_label:!0,value:n.value,conditional_on_change:l=>r(l),on_blur:l=>{o({...n,value:l})},on_blur_type:G.conditional})})]}),Yc[n.id]&&_(E,{style:{width:100,color:"#cb4",cursor:"pointer"},title:"Using interoperable ID",children:Yc[n.id]}),t&&_(pe,{onClick:()=>o(void 0),size:"large",children:_(Xd,{})})]},e.value_possibility.id)}function PF(e){const[t,n]=I(!1);if(e.VAPs_represent===N.undefined)return null;const i=EF(e.value_possibilities),{count_of_value_possibilities:o,max_count:s}=NF(i),r=s>1?"Duplicate value possibilities present":"",a=`editable_list_entry padded ${t?"expanded":""}`,{attribute_wcomponent:c}=e;return _("div",{className:a,children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>n(!t),children:[_("div",{className:"summary",children:[_("h4",{style:{display:"inline-block"},children:["Possible Values ",!t&&i.length?`(${i.length})`:""]}),_("div",{style:{display:"inline-block",position:"relative",top:7,left:5},children:_($i,{warning:r,label:""})})]}),_("div",{className:"expansion_button"})]}),t&&_("div",{children:[_(E,{display:"flex",flexDirection:"row",flexWrap:"wrap",overflow:"hidden",children:i.map(l=>_(TF,{editing:e.editing,value_possibility:l,count_of_value_possibilities:o,update_value_possibility:d=>{const u={...e.value_possibilities};d?u[d.id]=d:delete u[l.id];const f=Object.keys(u).length>0;e.update_value_possibilities(f?u:void 0)}}))}),e.editing&&_(F,{value:"New possibility",fullWidth:!0,onClick:()=>{const l=jF(e.value_possibilities),d={...e.value_possibilities,[l.id]:l};e.update_value_possibilities(d)}}),e.editing&&_(F,{value:"Use defaults",fullWidth:!0,onClick:()=>{const l=yn(e.VAPs_represent,void 0,e.values_and_prediction_sets),d=sn(l,"default_possible_values");e.update_value_possibilities(d)}}),e.editing&&c&&Ze(c)&&_(F,{value:"Use attribute's possibilities",fullWidth:!0,onClick:()=>{const l=yn(e.VAPs_represent,c.value_possibilities,c.values_and_prediction_sets||[]),d=sn(l,"attribute's possible_values");e.update_value_possibilities(d)}})]})]})}function NF(e){const t={};let n=0;return e.forEach(({value:i})=>{i=i.toLowerCase();const o=(t[i]||0)+1;t[i]=o,n=Math.max(n,o)}),{count_of_value_possibilities:t,max_count:n}}function EF(e){return Object.values(e||{}).sort((t,n)=>t.order<n.order?-1:1)}const IF=(e,t)=>({created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,creation_context:e.creation_context,editing:t.editing_allowed??!e.display_options.consumption_formatting,current_created_at_ms:e.routing.args.created_at_ms}),RF={change_route:x.routing.change_route},DF=j(IF,RF);function OF(e){var R;const{existing_value_possibilities:t,values_and_prediction_sets:n,VAPs_represent:i,base_id:o,editing:s,current_created_at_ms:r,sim_ms:a,creation_context:c,update_VAPSets_and_value_possibilities:l,change_route:d}=e;if(!s||i!==N.action)return null;const{latest:u}=ao(n),m=po(u)[0],h=(R=m==null?void 0:m.entries.find(C=>C.probability===1))==null?void 0:R.value_id,v=h===ge.action_potential,g=h===ge.action_paused,b=h===ge.action_in_progress,w=h===ge.action_completed,k=!m||v||g,y=w,S=b,T=!m||b;function $(C){const O=al({existing_value_possibilities:t,orig_values_and_prediction_sets:n,base_id:o,creation_context:c,action_value_possibility_id:C});R0({existing_value_possibilities:t,new_values_and_prediction_sets:O,orig_values_and_prediction_sets:n,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:l,change_route:d})}return _("div",{children:[(k||y)&&_(F,{value:y?"Restart (In Progress)":"In Progress",fullWidth:!0,color:"secondary",onClick:()=>$(ge.action_in_progress)}),S&&_(F,{value:"Pause",fullWidth:!0,color:"secondary",onClick:()=>$(ge.action_paused)}),T&&_(F,{value:"Completed",fullWidth:!0,color:"secondary",onClick:()=>$(ge.action_completed)})]})}const MF=DF(OF);function A1(e){const{new_item:t,set_new_item:n,item_descriptor:i,item_props:o}=e,{crud:s}=o,r=z(()=>({...s,update_item:n}),[s,n]);return t?_(E,{children:_(pk,{"aria-labelledby":"new_item_title",open:!0,onClose:()=>n(void 0),fullWidth:!0,maxWidth:"sm",children:[_(mk,{id:"new_item_title",children:["New ",i]}),_(fk,{children:_(Zd,{item:t,...o,expanded:!0,crud:r})}),_(hk,{children:[_(F,{onClick:()=>{setTimeout(()=>s.create_item(t),0)},children:["Add ",i]}),_(F,{onClick:()=>n(void 0),children:"Cancel"})]})]})}):null}function qF(e,t){const n=mo(e.entries,t),i=n[0];if(t===N.boolean&&i)return _(Re,{children:i.probability>.5?"True":"False"});const o=t===N.number,s=n.filter(({probability:r})=>r>0);return _(Re,{children:[s.map((r,a)=>_("span",{children:[o?_(VF,{value:r.value}):r.value,a<s.length-1&&", "]},a)),s.length===0&&"-"]})}function VF(e){return Pe(e.value)?_(Re,{children:e.value}):_("span",{style:{borderRadius:5,border:"thin solid #999",padding:"2px 3px 0px 3px"},children:[_(rn,{message:"Number is invalid",backgroundColor:"white"}),e.value]})}function FF(e,t){const n=mo(e.entries,t),i=n[0];return t===N.boolean&&i?vi(i.probability):n.filter(({probability:s})=>s>0).map(s=>vi(s.probability)).join(", ")}function zF(e,t){const n=mo(e.entries,t),i=n[0];if(t===N.boolean&&i)return vi(i.conviction);const o=n.filter(({probability:a})=>a>0),s=new Set;o.forEach(({conviction:a})=>s.add(a));const r=s.size<=1;return o.slice(0,r?1:void 0).map(a=>vi(a.conviction)).join(", ")}var Qd={},LF=Q;Object.defineProperty(Qd,"__esModule",{value:!0});var Wo=Qd.default=void 0,BF=LF(Z()),UF=ee(),WF=(0,BF.default)((0,UF.jsx)("path",{d:"M17 7h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1 0 1.43-.98 2.63-2.31 2.98l1.46 1.46C20.88 15.61 22 13.95 22 12c0-2.76-2.24-5-5-5zm-1 4h-2.19l2 2H16zM2 4.27l3.11 3.11C3.29 8.12 2 9.91 2 12c0 2.76 2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1 0-1.59 1.21-2.9 2.76-3.07L8.73 11H8v2h2.73L13 15.27V17h1.73l4.01 4L20 19.74 3.27 3 2 4.27z"}),"LinkOff");Wo=Qd.default=WF;const HF="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM19 12h-2v3h-3v2h3v3h2v-3h3v-2h-3z";function GF(e){return _(Et,{...e,d:HF})}const KF="M8 11h8v2H8zm12.1 1H22c0-2.76-2.24-5-5-5h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1zM3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1z M16 18.17 14.33 16.5l-1.42 1.41L16 21 21.0 15.8l-1.41-1.41z";function YF(e){return _(Et,{...e,d:KF})}function JF(e){const{editing:t,VAP:n,value_possibilities:i,update_VAP:o}=e,s=z(()=>jy(e.value_possibilities,!0),[e.value_possibilities]);if(i===void 0)return _("span",{title:"Need to first add value possibilities to link to.",className:"possible_value_link disabled",children:_(Wo,{})});if(!!i[n.value_id||""])return _("span",{title:"Linked to possible value.  Click to unlink.",className:"possible_value_link "+(t?"clickable":"disabled"),onClick:()=>{const c={...n};delete c.value_id,o(c)},children:[_(YF,{className:"hide_on_hover"}),_(Wo,{className:"show_on_hover"})]});const a=s[n.value.toLowerCase()];return a?_("span",{title:"Linkable to value possibility.  Click to link.",className:"possible_value_link "+(t?"clickable":"disabled"),onClick:()=>{const l=i[a.id].description||n.description,d={...n,value_id:a.id,description:l};o(d)},children:_(GF,{})}):_("span",{title:"No matching value possibility to link to.",className:"possible_value_link disabled",children:_(Wo,{})})}const XF=e=>({editing:!e.display_options.consumption_formatting}),ZF=j(XF);function QF(e){const{editing:t,value_possibilities:n,VAPs_represent:i}=e,o=e.values_and_predictions,s=i===N.boolean&&o.length>=1?"only_one_VAP":"",r=i===N.number,a={get_summary:tz({value_possibilities:n,VAPs_represent:i,editing:t}),get_details:nz(i,t),extra_class_names:"value_and_prediction",crud:{update_item:l=>{const d=Mi(l),u=Vl(o,l,f=>Mi(f)===d);e.update_values_and_predictions(u)},delete_item:l=>{const d=Mi(l),u=us(o,f=>Mi(f)===d);e.update_values_and_predictions(u)}},delete_button_text:"Delete Value & Prediction",hide_expansion_button:l=>!t&&!l.description&&!l.source&&(!r||!l.min&&!l.max),calc_initial_custom_expansion_state:l=>!!(l.description||l.source||r&&(l.min||l.max))},c="Value and prediction";return _("div",{className:`value_and_predictions ${s}`,children:[_(l1,{items_descriptor:_i(c,o.length),other_content:()=>!t||i===N.boolean?null:_(Ds,{new_item_descriptor:c,on_pointer_down_new_list_entry:()=>{const l=[...o,qe()];e.update_values_and_predictions(l)}})}),ai({items:o,get_id:Mi,item_props:a,debug_item_descriptor:c})({expanded_item_rows:!1,expanded_items:!0,disable_partial_collapsed:!1})]})}const ez=ZF(QF),Mi=e=>e.id,tz=e=>(t,n,i)=>{const{value_possibilities:o,VAPs_represent:s,editing:r}=e,{probability:a,relative_probability:c,conviction:l,min:d,value:u,max:f}=t,m=s===N.boolean,h=s===N.number,v=c!==void 0,g=v&&!m,b=!v||m;return _("div",{className:"value_and_prediction_summary",children:[_("br",{}),_("div",{className:"temporal_uncertainty",children:[h&&(r&&i||d)&&_("div",{children:[_(Vc,{value:d}),_(He,{placeholder:"Min",value:d||"",modify_value_pre_on_blur:w=>w.trim(),on_blur:w=>n.update_item({...t,min:w}),on_blur_type:G.conditional}),_("br",{})]},"min"),(r||u)&&_("div",{style:{position:"relative"},children:[h&&_(Vc,{value:u}),_(He,{disabled:m,placeholder:"Value",value:m?a>.5?"True":"False":u,modify_value_pre_on_blur:w=>w.trim(),on_blur:w=>n.update_item({...t,value:w}),on_blur_type:G.conditional}),!h&&!m&&_("div",{style:{position:"absolute",right:"-25px",top:"15px"},children:_(JF,{editing:r,VAP:t,value_possibilities:o,update_VAP:w=>n.update_item(w)})}),_("br",{})]},"value"),h&&(r&&i||f)&&_("div",{children:[_(Vc,{value:f}),_(He,{placeholder:"Max",value:f||"",modify_value_pre_on_blur:w=>w.trim(),on_blur:w=>n.update_item({...t,max:w}),on_blur_type:G.conditional}),_("br",{})]},"max")]}),_("div",{className:"predictions",children:[m&&_("div",{className:g?"disabled":"",children:_(Tn,{disabled:g,placeholder:"Probability",value:a,on_blur:w=>{n.update_item({...t,probability:w})},on_blur_type:G.conditional})}),m&&_("div",{children:_(Tn,{placeholder:"Confidence",value:l,on_blur:w=>n.update_item({...t,conviction:w}),on_blur_type:G.conditional})}),!m&&c!==void 0&&_("div",{className:b?"disabled":"",children:_(st,{disabled:b,placeholder:"Relative probability",size:"medium",value:c,allow_undefined:!0,on_blur:w=>{w=w||0,n.update_item({...t,relative_probability:w})},on_blur_type:G.conditional})}),"  ",_(x1,{disabled:!0,size:20,probability:a,conviction:l})]})]})},nz=(e,t)=>(n,i)=>e===N.boolean?_("div",{children:[_("div",{className:"description_label",children:"Description"}),"Boolean value of this state, i.e. either true (100%), false (0%) or somewhere in between."]}):!t&&!n.description&&!n.source?_(Re,{}):_("div",{children:[(t||n.description)&&_(Wt,{placeholder:"Description",value:n.description,on_blur:o=>i.update_item({...n,description:o.trim()}),on_blur_type:G.conditional}),t&&_("br",{}),(t||n.source)&&_(He,{placeholder:"Source",size:"small",value:n.source||"",on_blur:o=>i.update_item({...n,source:o?o.trim():void 0}),on_blur_type:G.conditional}),t&&_("br",{})]});function Vc(e){const t=Pe(e.value||"");return _("div",{style:{maxHeight:t?0:100,overflow:"hidden",transition:"max-height 1s ease 0s"},children:_($i,{warning:"Number is invalid"})})}const iz=e=>({time_resolution:e.display_options.time_resolution}),oz=j(iz);function sz(e){const{value:t,created_at:n,datetime:i,probability:o,conviction:s,time_resolution:r}=e;return _("div",{children:[n&&_("div",{style:{display:"inline-flex"},children:["Created:  ",_(ht,{invariant_value:n,value:void 0})]}),_("div",{className:"summary_container",children:[_("div",{className:"summary_row",children:[_("div",{className:"datetimes",children:Ul(i,r)}),t&&_("div",{children:["      ",t]})]}),_("div",{className:"summary_row",children:[_("div",{children:[_("span",{className:"description_label",children:"Prob"})," ",o]}),"   ",_("div",{children:[_("span",{className:"description_label",children:"Confidence"})," ",s]})]})]})]})}const S1=oz(sz),eu=(e,t)=>(n,i)=>{let o=C1(n,e);n={...n,entries:o};const s=qF(n,e),r=FF(n,e)+"%",a=zF(n,e)+"%";return _(S1,{created_at:t?n.custom_created_at||n.created_at:void 0,value:s,datetime:n.datetime,probability:r,conviction:a})},tu=(e,t)=>(n,i)=>{const o=C1(n,t);return _("div",{className:"VAP_set_details",children:[_("br",{}),_(Os,{datetime:n.datetime,on_change:s=>i.update_item({...n,datetime:s})}),_("div",{children:[_("br",{}),_(ez,{value_possibilities:e,VAPs_represent:t,values_and_predictions:o,update_values_and_predictions:s=>{const r=rz(s,n,t),a=bl(r,t),c={...n,entries:a};i.update_item(c)}}),_("br",{})]}),_("br",{})]})},nu=(e,t)=>(n,i)=>{const o=n.shared_entry_values||{},s=n.entries.map(({explanation:d})=>d.trim()).filter(d=>d).join(`

`),r=o.explanation||s||"",a=o.conviction||1,c=e!==N.boolean,l=!!(t||r);return _("div",{className:"shared_VAP_set_details",children:[c&&_("div",{children:_(Tn,{disabled:!1,placeholder:"Confidence",value:a,on_blur:d=>{const u={...n.shared_entry_values,conviction:d},f=n.entries.map(m=>({...m,conviction:d}));i.update_item({...n,entries:f,shared_entry_values:u})},on_blur_type:G.conditional})}),l&&_(Wt,{placeholder:"Explanation",value:r,on_blur:d=>{const u={...n.shared_entry_values,explanation:d};i.update_item({...n,shared_entry_values:u})},on_blur_type:G.conditional}),_("br",{})]})};function C1(e,t){let n=e.entries;return t===N.boolean&&n.length!==1&&(n=n.slice(0,1)),n}function rz(e,t,n){return n===N.boolean&&(e=e.concat(t.entries.slice(1))),e}function _z(e){const{VAP_set:t,on_change:n}=e;if(!t.entries[0])return null;const o=ut(t.datetime),s=o===void 0;return _("div",{children:[o?io({date:o,time_resolution:void 0}):"Is Eternal",_("br",{}),s&&_(F,{value:"Set to 'From today'",onClick:()=>n({...t,datetime:{value:Rk()}})}),!s&&_(F,{value:"Set to Eternal",onClick:()=>n({...t,datetime:{}})}),_("br",{}),_("br",{})]})}const az=(e,t)=>{const n=Object.keys(t||{}).length>0,i=e===N.other&&n,o=e===N.boolean||e===N.action||i,[s,r]=I(!o);return(a,c)=>{const{update_item:l}=c;return _("div",{children:[!s&&e===N.boolean&&_(cz,{VAP_set:a,on_change:l}),!s&&e===N.action&&_(lz,{possible_value_possibilities:t,VAP_set:a,on_change:l}),!s&&i&&_(dz,{possible_value_possibilities:t,VAP_set:a,on_change:l}),!s&&_("div",{children:[_("span",{className:"description_label",children:"Datetime"}),_(_z,{VAP_set:a,on_change:l})]}),_(F,{value:(s?"Hide":"Show")+" advanced options",onClick:()=>r(!s)}),s&&_("div",{children:[_("br",{}),_("br",{}),_("hr",{}),eu(e,!1)(a,c),tu(t,e)(a,c),nu(e,!0)(a,c)]})]})}};function cz(e){const{VAP_set:t,on_change:n}=e,i=t.entries[0];if(!i)return null;const o=!!i&&i.probability===1&&i.conviction===1,s=!!i&&i.probability===0&&i.conviction===1;return _("div",{children:[o&&"True",s&&"False",_("br",{}),!o&&_(F,{value:"Set to True",onClick:()=>{n({...t,entries:[{...i,probability:1,conviction:1}]})}}),!s&&_(F,{value:"Set to False",onClick:()=>{n({...t,entries:[{...i,probability:0,conviction:1}]})}}),_("br",{}),_("br",{})]})}function lz(e){return _($1,{...e,title:"Set action status to:"})}function dz(e){return _($1,{...e,title:"Set value to:"})}function $1(e){const{title:t,possible_value_possibilities:n,VAP_set:i,on_change:o}=e,s=pz(i),r=uz(n);return _("div",{children:[t,_(de,{selected_option_id:s,options:r,allow_none:!0,on_change:a=>{if(!a)return;const c=I0(i,a);o({...i,entries:c})}}),_("br",{}),_("br",{})]})}function uz(e){return e===void 0?[]:Object.values(e).map(({id:t,value:n})=>({id:t,title:Ht(n)}))}function pz(e){var o,s;let t;const n=((o=e.shared_entry_values)==null?void 0:o.conviction)||0,i=((s=e.shared_entry_values)==null?void 0:s.probability)||0;return e.entries.forEach(r=>{Math.max(n,r.conviction)===1&&Math.max(i,r.probability)===1&&(t=r.value_id)}),t}const mz=e=>({creation_context:e.creation_context,editing:!e.display_options.consumption_formatting}),fz=j(mz);function hz(e){const{editing:t,value_possibilities:n,VAPs_represent:i,older_VAP_sets:o,create_item:s,update_item:r,delete_item:a}=e,c="Older version",l=z(()=>()=>{const u=C2(e.current_VAP_set,e.creation_context);s(u)},[e.current_VAP_set,e.creation_context,s]),d=z(()=>ai({items:o,get_id:gz,debug_item_descriptor:c,item_props:{get_created_at:wz,get_custom_created_at:bz,get_summary:eu(i,!0),get_details:tu(n,i),get_details2:nu(i,t),extra_class_names:"value_and_prediction_set",crud:{create_item:s,update_item:r,delete_item:a},delete_button_text:"Delete Older Set of Value & Predictions"}}),[o,c,i,t,s,r,a]);return _(u1,{items_count:o.length,item_descriptor:c,new_item_descriptor:"Version",content:d,on_click_new_item:l})}const vz=fz(hz),gz=e=>e.id,wz=e=>e.created_at,bz=e=>e.custom_created_at;function yz(e){const[t,n]=I(void 0),{wcomponent_id:i,VAPs_represent:o,update_values_and_predictions:s,existing_value_possibilities:r,values_and_prediction_sets:a,invalid_future_items:c,future_items:l,present_item:d,past_items:u,previous_versions_by_id:f,editing:m}=e,h=d?[d]:[],v=Lc({existing_value_possibilities:r,subset_VAP_sets:l,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:Y.future,editing:m}),g=Lc({existing_value_possibilities:r,subset_VAP_sets:h,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:Y.present,editing:m}),b=Lc({existing_value_possibilities:r,subset_VAP_sets:u,previous_versions_by_id:f,all_VAP_sets:a,update_values_and_predictions:s,wcomponent_id:i,VAPs_represent:o,tense:Y.past,editing:m}),k={get_created_at:j1,get_custom_created_at:T1,get_summary:az(o,r),get_details:()=>_("div",{}),get_details2:()=>_("div",{}),extra_class_names:"value_and_prediction_set new",crud:{create_item:R=>{const C=[...a,R];s(C),n(void 0)},update_item:n}},y="Value Prediction",S=m||l.length>0,T=m||h.length>0,$=m||u.length>0;return _("div",{className:"value_and_prediction_sets",children:[m&&_(Ds,{new_item_descriptor:y,on_pointer_down_new_list_entry:()=>{const R=Ee(o,r,a,e.base_id,e.creation_context);n(R)}}),_(A1,{new_item:t,set_new_item:n,item_props:k,item_descriptor:y}),c.length>0&&_("div",{children:["Hidden (",c.length,") ",_(Nd,{})]}),S&&_(on,{content:v,item_descriptor:"",items_descriptor:Fc("Future",l,f,m),items_descriptor_title:zc("Future",l,f),disable_collapsed:!0}),(S||T)&&_("hr",{}),T&&_(on,{content:g,item_descriptor:"",items_descriptor:Fc("Present",h,f,m),items_descriptor_title:zc("Present",h,f),disable_collapsed:!0}),T&&$&&_("hr",{}),$&&_(on,{content:b,item_descriptor:"",items_descriptor:Fc("Past",u,f,m),items_descriptor_title:zc("Past",u,f),disable_collapsed:!0})]})}function Fc(e,t,n,i){if(!i)return e;let o=0;return t.forEach(({id:s})=>o+=(n[s]||[]).length),o===0?_i(e,t.length,i):`${e} (${t.length}+)`}function zc(e,t,n){let i=0;return t.forEach(({id:o})=>i+=(n[o]||[]).length),i===0?`${t.length} ${e} items`:`${t.length} ${e} items with ${i} older versions`}function Lc(e){const{existing_value_possibilities:t,subset_VAP_sets:n,all_VAP_sets:i,previous_versions_by_id:o,update_values_and_predictions:s,VAPs_represent:r,tense:a,editing:c}=e;return d=>{const{disable_partial_collapsed:u,expanded_items:f,expanded_item_rows:m}=d,h={create_item:v=>{const g=[...i,v];s(g)},update_item:v=>{const g=hv(v),b=Vl(i,v,g);s(b)},delete_item:v=>{const g=hv(v),b=us(i,g);s(b)}};return _("div",{style:{display:f?"":"none",cursor:"initial"},onClick:v=>v.stopPropagation(),children:n.map(v=>_("div",{children:[_("hr",{className:"entries_horizontal_dividers"}),_(Zd,{item:v,get_created_at:j1,get_custom_created_at:T1,get_summary:eu(r,!1),get_details:tu(t,r),get_details2:nu(r,c),get_details3:kz(t,r,o),extra_class_names:`value_and_prediction_set ${a===Y.future?"future":a===Y.present?"present":"past"}`,expanded:m,crud:h,delete_button_text:"Delete Set of Value & Predictions"})]},v.id))})}}const j1=e=>e.created_at,T1=e=>e.custom_created_at,hv=e=>t=>e.id===t.id&&e.created_at.getTime()===t.created_at.getTime(),kz=(e,t,n)=>(i,o)=>_(E,{className:"VAP_set_details",children:[_("br",{}),_(vz,{value_possibilities:e,VAPs_represent:t,current_VAP_set:i,older_VAP_sets:n[i.id]||[],create_item:o.create_item,update_item:o.update_item,delete_item:o.delete_item}),_("br",{}),_("br",{})]}),xz=(e,t)=>({current_created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,creation_context:e.creation_context,editing:t.editing_allowed??!e.display_options.consumption_formatting,base_id:_t(e)||-1}),Az={change_route:x.routing.change_route},Sz=j(xz,Az);function Cz(e){const{wcomponent_id:t,existing_value_possibilities:n,values_and_prediction_sets:i,VAPs_represent:o,base_id:s,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l}=e,{invalid_future_items:d,past_items:u,present_item:f,future_items:m,previous_versions_by_id:h}=xn({items:i,created_at_ms:e.current_created_at_ms,sim_ms:a});return _(yz,{wcomponent_id:t,VAPs_represent:o,update_values_and_predictions:v=>{R0({existing_value_possibilities:n,new_values_and_prediction_sets:v,orig_values_and_prediction_sets:i,current_created_at_ms:r,sim_ms:a,update_VAPSets_and_value_possibilities:c,change_route:l})},existing_value_possibilities:e.existing_value_possibilities,values_and_prediction_sets:i,invalid_future_items:d,past_items:u,present_item:f,future_items:m,previous_versions_by_id:h,base_id:s,creation_context:e.creation_context,editing:e.editing})}const $z=Sz(Cz),jz=e=>({wcomponents_by_id:e.derived.composed_wcomponents_by_id,presenting:e.display_options.consumption_formatting}),Tz={},Pz=j(jz,Tz);function Nz(e){const{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,VAPs_represent:o,orig_values_and_prediction_sets:s,orig_value_possibilities:r}=e,a=s.length>0||t&&o===N.action,[c,l]=I(a),d=Ze(n)&&n.units,[u,f]=I(!!d),m=u&&(o===N.number||!!d)||e.presenting&&o===N.number&&!!d;return _("div",{className:"editable_list_entry padded "+(c?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>l(!c),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Value Predictions ",!c&&s.length?`(${s.length})`:""]})}),_("div",{className:"expansion_button"})]}),Ze(n)&&_("div",{children:[e.editing_allowed&&_(pe,{onClick:()=>f(!u),size:"small",style:{marginLeft:"auto",display:"flex"},children:_(Sv,{})}),m&&_(He,{style:{padding:"10px 0px"},size:"small",placeholder:"Units",hide_label:!1,disabled:!e.editing_allowed,value:n.units||"",on_blur:h=>e.upsert_wcomponent({units:h||void 0}),on_blur_type:G.conditional})]}),c&&_("div",{children:[o===N.undefined&&_("div",{children:n.type==="state_value"?"Set subtype of target 'state' component to show Value Predictions on this 'state value' component":"Set subtype to show Value Predictions"}),o===N.action&&_(MF,{VAPs_represent:o,base_id:n.base_id,existing_value_possibilities:r,values_and_prediction_sets:s,update_VAPSets_and_value_possibilities:({value_possibilities:h,values_and_prediction_sets:v})=>{i({value_possibilities:h,values_and_prediction_sets:v})},editing_allowed:t}),o!==N.undefined&&_($z,{wcomponent_id:n.id,VAPs_represent:o,existing_value_possibilities:r,values_and_prediction_sets:s,update_VAPSets_and_value_possibilities:({value_possibilities:h,values_and_prediction_sets:v})=>{i({value_possibilities:h,values_and_prediction_sets:v})},editing_allowed:t})]})]})}const Ez=Pz(Nz),Iz=e=>({wcomponents_by_id:e.specialised_objects.wcomponents_by_id}),Rz={},Dz=j(Iz,Rz);function Oz(e){const{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,wcomponents_by_id:o}=e,s=se(n,o),r=n.values_and_prediction_sets,a=n.value_possibilities;return _(Re,{children:[(t&&o2(n)||i2(n)&&n.calculations.length>0)&&_($F,{wcomponent:n,upsert_wcomponent:i}),r!==void 0&&(t||r.length>0)&&_(Ez,{editing_allowed:t,wcomponent:n,upsert_wcomponent:i,VAPs_represent:s,orig_values_and_prediction_sets:r,orig_value_possibilities:a}),s!==N.undefined&&r!==void 0&&(t||Object.keys(a||{}).length>0)&&_(PF,{editing:t,attribute_wcomponent:o[vt(n)&&n.attribute_wcomponent_id||""],VAPs_represent:s,value_possibilities:a,values_and_prediction_sets:r,update_value_possibilities:c=>{const l=ti(r,c);i({value_possibilities:c,values_and_prediction_sets:l})}})]})}const Mz=Dz(Oz),qz=e=>({current_knowledge_view:ne(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:e.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:!e.display_options.consumption_formatting,wc_id_to_counterfactuals_map:at(e)}),Vz={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:x.specialised_object.upsert_knowledge_view},Fz=j(qz,Vz);function zz(e){const{current_knowledge_view:t,wcomponents_by_id:n,knowledge_views_by_id:i,wcomponent:o,upsert_wcomponent:s,wc_id_to_counterfactuals_map:r}=e,a=Array.from(e.wcomponent_ids_with_state_VAPs).map(f=>n[f]).filter(be).filter(Ge),c=t==null?void 0:t.composed_wc_id_map[o.id];function l(f){const m=t==null?void 0:t.composed_wc_id_map[f.id];return jC(c,m)}const d=ue(a,l,ce.ascending),u=cn({wcomponents:d,wcomponents_by_id:n,knowledge_views_by_id:i,wc_id_to_counterfactuals_map:r,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms});return _("div",{children:_("p",{children:[_("span",{className:"description_label",children:"Attribute (target) component"}),"  ",o.attribute_wcomponent_id&&_(De,{route:void 0,sub_route:void 0,item_id:o.attribute_wcomponent_id,args:void 0,children:[_($n,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:o.attribute_wcomponent_id,options:u,on_change:f=>{const m=n[f||""];let{value_possibilities:h}=o;if((!h||!Object.keys(h))&&Ze(m)){const v=se(m,n),g=yn(v,m.value_possibilities,m.values_and_prediction_sets||[]);h=sn(g,"attribute's possible_values")}s({attribute_wcomponent_id:f,value_possibilities:h})},on_mouse_over_option:f=>e.set_highlighted_wcomponent({id:f,highlighted:!0}),on_mouse_leave_option:f=>e.set_highlighted_wcomponent({id:f,highlighted:!1})})})]})})}const Lz=Fz(zz);function Bc(e){let t;if(!e)return;const{target_VAP_set_id:n,target_value:i,target_value_id_type:o}=e;return n?i&&o?t={target_VAP_set_id:n,target_value:i,target_value_id_type:o}:t={target_VAP_set_id:n}:i&&o?t={target_value:i,target_value_id_type:o}:t=void 0,t}const Bz=(e,t)=>{const{target_wcomponent_id:n}=t.wcomponent,i=e.specialised_objects.wcomponents_by_id[n||""],o=Ge(i)&&i;return{wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wcomponent_ids_with_state_VAPs:e.derived.wcomponent_ids_by_type.any_state_VAPs,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,editing:!e.display_options.consumption_formatting,target_wcomponent:o,wc_id_to_counterfactuals_map:at(e)}},Uz={set_highlighted_wcomponent:x.specialised_object.set_highlighted_wcomponent,upsert_knowledge_view:x.specialised_object.upsert_knowledge_view},Wz=j(Bz,Uz);function Hz(e){const{wcomponents_by_id:t,knowledge_views_by_id:n,wcomponent:i,upsert_wcomponent:o,target_wcomponent:s,wc_id_to_counterfactuals_map:r}=e,a=Array.from(e.wcomponent_ids_with_state_VAPs).map(m=>t[m]).filter(be).filter(Ge),c=cn({wcomponents:a,wcomponents_by_id:t,knowledge_views_by_id:n,wc_id_to_counterfactuals_map:r,created_at_ms:e.created_at_ms,sim_ms:e.sim_ms}),l=i.selector||{};let d=[],u=[],f=[];return s&&(d=s.values_and_prediction_sets||[],d=wC(d,e.created_at_ms),u=d.map(({id:m,datetime:h})=>{const v=Ul(h,"minute");return{id:m,title:v}}),f=J0({selector:i.selector,target_wcomponent:s})),_("div",{children:[_("p",{children:[_("span",{className:"description_label",children:"Target component"}),"  ",i.target_wcomponent_id&&_(De,{route:void 0,sub_route:void 0,item_id:i.target_wcomponent_id,args:void 0,children:[_($n,{}),"  "]}),_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:i.target_wcomponent_id,options:c,on_change:m=>o({target_wcomponent_id:m,selector:void 0}),on_mouse_over_option:m=>e.set_highlighted_wcomponent({id:m,highlighted:!0}),on_mouse_leave_option:m=>e.set_highlighted_wcomponent({id:m,highlighted:!1})})})]}),s&&_("p",{children:[_("span",{className:"description_label",children:"Select value and prediction set timepoint of interest to display"}),"  ",_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{allow_none:!0,selected_option_id:l.target_VAP_set_id,options:u,on_change:m=>{const h=Bc({...l,target_VAP_set_id:m});o({selector:h})},retain_options_order:!0})})]}),s&&_("p",{children:[_("span",{className:"description_label",children:"Select value possibility of interest to limit display by"}),"  ",_("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:"not_set_target_value",checked:l.target_value===void 0||l.target_value_id_type===void 0,onChange:()=>{const m=Bc({...l,target_value:void 0,target_value_id_type:void 0});o({selector:m})}}),_("label",{for:"not_set_target_value",children:"Not set"})]}),f.map(m=>{const{value:h,id:v,selected:g}=m;return _("div",{children:[_("input",{type:"radio",disabled:!e.editing,id:v,checked:g||!1,onChange:()=>{const b=Bc({...l,target_value:v||h,target_value_id_type:v?"id":"value_string"});o({selector:b})}}),_("label",{for:v,children:h})]})})]})]})}const Gz=Wz(Hz);function Kz(e){const{prediction:t,on_change:n}=e,{datetime:i,probability:o,conviction:s}=t;return _(S1,{datetime:i,probability:_(Tn,{placeholder:"...",value:o,conditional_on_change:n&&(r=>n({...t,probability:r}))}),conviction:_(Tn,{placeholder:"...",value:s,conditional_on_change:n&&(r=>n({...t,conviction:r}))})})}function Yz(e){const{on_change:t,prediction:n}=e,{explanation:i=""}=n,o=t?r=>{const a={...n,...r};t(a)}:void 0,s=o?{on_blur:r=>o({explanation:r}),on_blur_type:G.conditional}:{};return _("div",{children:[_("br",{}),_(Os,{datetime:n.datetime,on_change:r=>o&&o({datetime:r})}),_("br",{}),(e.editing||i)&&_("div",{children:_(Wt,{placeholder:"Explanation",value:i,...s})})]})}const Jz=e=>({created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms,creation_context:e.creation_context,editing:!e.display_options.consumption_formatting,base_id:_t(e)}),Xz=j(Jz);function Zz(e){const[t,n]=I(void 0),{item_descriptor:i,predictions:o,update_predictions:s,created_at_ms:r,sim_ms:a,editing:c,base_id:l=-1}=e,d=z(()=>({get_created_at:vv,get_custom_created_at:gv,get_summary:wv,get_details:bv(c),crud:{create_item:$=>{s([...o,$]),n(void 0)}}}),[c,o,s]),u=z(()=>({get_created_at:vv,get_custom_created_at:gv,get_summary:wv,get_details:bv(c),crud:{update_item:$=>{const C=Vl(o,$,O=>un(O)===un($));s(C)},delete_item:$=>{const C=us(o,O=>un(O)===un($));s(C)}},delete_button_text:"Delete "+i}),[c,o,s,i]),{invalid_future_items:f,future_items:m,present_item:h,past_items:v}=xn({items:o,created_at_ms:r,sim_ms:a}),g=h?[h]:[],b=ai({items:m,get_id:un,item_props:u}),w=ai({items:g,get_id:un,item_props:u}),k=ai({items:v,get_id:un,item_props:u}),y=c||m.length>0,S=c||g.length>0,T=c||v.length>0;return _("div",{children:[c&&_(Ds,{new_item_descriptor:i,on_pointer_down_new_list_entry:()=>n(eL(l,e.creation_context))}),_(A1,{new_item:t,set_new_item:n,item_props:d,item_descriptor:i}),f.length>0&&_("div",{children:["Hidden (",f.length,")"]}),o.length>0&&_("div",{children:[y&&_(on,{content:b,item_descriptor:"",items_descriptor:_i("Future",m.length,c),disable_collapsed:!0}),(y||S)&&_("hr",{}),S&&_(on,{content:w,item_descriptor:"",items_descriptor:_i("Present",g.length,c),disable_collapsed:!0}),S&&T&&_("hr",{}),T&&_(on,{content:k,item_descriptor:"",items_descriptor:_i("Past",v.length,c),disable_collapsed:!0})]})]})}const Qz=Xz(Zz),un=e=>e.id,vv=e=>e.created_at,gv=e=>e.custom_created_at;function wv(e,t){return _(Kz,{prediction:e,on_change:t.update_item})}function bv(e){return(t,n)=>_(Yz,{prediction:t,on_change:n.update_item,editing:e})}function eL(e,t){const n=bi(t),i=Rv(n.custom_created_at||n.created_at,"day");return{id:Uk(),...n,base_id:e,datetime:{value:i},explanation:"",probability:1,conviction:1}}const tL=e=>({consumption_formatting:e.display_options.consumption_formatting}),nL={change_route:x.routing.change_route},iL=j(tL,nL);function oL(e){const{wcomponent:t}=e,{validity:n=[]}=t,[i,o]=I(n.length>0);return e.consumption_formatting&&n.length===0?null:_("div",{className:"editable_list_entry padded "+(i?"expanded":""),children:[_("div",{className:"summary_header",style:{cursor:"pointer"},onClick:()=>o(!i),children:[_("div",{className:"summary",children:_("h4",{style:{display:"inline-block"},children:["Validity Predictions ",!i&&n.length?`(${n.length})`:""]})}),_("div",{className:"expansion_button"})]}),i&&_(Qz,{item_descriptor:(we(t)?"Existence ":"Validity ")+" prediction",predictions:n,update_predictions:s=>{const r=new Date().getTime()+1;e.change_route({args:{created_at_ms:r,sim_ms:r}}),e.upsert_wcomponent({validity:s})}})]})}const sL=iL(oL),rL=(e,{wcomponent:t})=>{let n,i;we(t)&&(n=me(e,t.from_id),i=me(e,t.to_id));const o=at(e),s=!e.display_options.consumption_formatting,r=(e.user_info.bases_by_id||{})[t.base_id],a=!!(r!=null&&r.can_edit);return{ready:e.sync.ready_for_reading,base_id:_t(e),wcomponents_by_id:e.specialised_objects.wcomponents_by_id,knowledge_views_by_id:e.specialised_objects.knowledge_views_by_id,wc_id_to_counterfactuals_map:o,from_wcomponent:n,to_wcomponent:i,derived_composed_wcomponents_by_id:e.derived.composed_wcomponents_by_id,derived_composed_wcomponent:e.derived.composed_wcomponents_by_id[t.id],is_in_editing_mode:s,allowed_to_edit:a,editing_allowed:s&&a,base_for_wcomponent:r,created_at_ms:e.routing.args.created_at_ms,sim_ms:e.routing.args.sim_ms}},_L={upsert_wcomponent:x.specialised_object.upsert_wcomponent,delete_wcomponent:x.specialised_object.delete_wcomponent,update_chosen_base_id:x.user_info.update_chosen_base_id},aL=j(rL,_L);function cL(e){var C,O,M;const{wcomponent:t,ready:n,base_id:i,wcomponents_by_id:o,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:r,from_wcomponent:a,to_wcomponent:c,derived_composed_wcomponents_by_id:l,derived_composed_wcomponent:d,editing_allowed:u,created_at_ms:f,sim_ms:m}=e,h=t.id,[v,g]=I(h);if(!n)return _("div",{children:"Loading..."});if(!d)return _("div",{children:"Loading..."});if(i===void 0)return _("div",{children:"Choose a base first."});const b=r&&((C=r[h])==null?void 0:C.VAP_sets),w=Ie(!0);if(_e(()=>g(h),[h]),v!==h)return w.current=!0,null;const k=w.current;w.current=!1;const y=P=>{const L=xV(t,P).wcomponent;e.upsert_wcomponent({wcomponent:L})};let S,T=!1;Ge(t)&&(S=hs({wcomponent:d,VAP_set_id_to_counterfactual_v2_map:b,created_at_ms:f,sim_ms:m}),T=(((O=t.values_and_prediction_sets)==null?void 0:O.length)||0)>0);const $=Qe({text_type:u?fe.raw:fe.rich,wcomponent:d,wcomponents_by_id:l,knowledge_views_by_id:s,wc_id_to_counterfactuals_map:r,created_at_ms:f,sim_ms:m}),R=P=>y({title:P});return _(E,{children:[e.is_in_editing_mode&&!e.allowed_to_edit&&_("div",{children:[_(rn,{message:""}),"  Not allow to edit.  Ask base owner to give you edit permissions."]}),e.wcomponent_from_different_base&&_("div",{style:{cursor:"pointer"},onClick:()=>e.update_chosen_base_id({base_id:t.base_id}),title:`Click to change to base ${t.base_id}`,children:[_(rn,{}),'  Is part of base "',(M=e.base_for_wcomponent)==null?void 0:M.title,'"']}),_(it,{variant:"standard",fullWidth:!0,margin:"normal",style:{fontWeight:600,fontSize:22},children:_(Wt,{editing_allowed:u,placeholder:t.type==="action"?"Passive imperative title...":t.type==="relation_link"?"Verb...":"Title...",value:$,on_blur:R,on_blur_type:G.conditional,force_focus_on_first_render:k,hide_label:!0,spellcheck:!0})}),S&&_("span",{children:[_("span",{className:"description_label",children:"Value "}),_(Z0,{UI_value:S})]}),(u||t.type!=="statev2"||T)&&_(it,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:_(de,{editing_allowed:u,placeholder:"Type: ",selected_option_id:t.type,options:y1,on_change:P=>{if(!P)return;const J={...q({type:P,base_id:t.base_id}),...t};J.type=P,y(J)}})}),Ze(t)&&(u||t.subtype)&&_("p",{children:[_("span",{className:"description_label",children:"Subtype"})," ",_("div",{style:{width:"60%",display:"inline-block"},children:_(de,{editing_allowed:u,placeholder:"Subtype...",selected_option_id:t.subtype,options:HV,allow_none:!0,on_change:P=>y({subtype:P})})})]}),(u||t.description)&&_(it,{variant:"standard",fullWidth:!0,margin:"normal",children:_(Wt,{editing_allowed:u,placeholder:"Description...",value:t.description,on_blur:P=>y({description:P}),on_blur_type:G.conditional,hide_label:!0})}),vt(t)&&_(Lz,{wcomponent:t,upsert_wcomponent:y}),so(t)&&_(Gz,{wcomponent:t,upsert_wcomponent:y}),vl(t)&&_(eF,{wcomponent:t,upsert_wcomponent:y}),we(t)&&_("div",{children:[_("p",{children:_(dl,{connection_terminal_description:"From",wcomponent_id:a&&a.id,connection_terminal_type:t.from_type,on_update_id:P=>y({from_id:P}),on_update_type:P=>y({from_type:P}),exclude_ids:new Set([t.id])})}),_("p",{children:_(dl,{connection_terminal_description:"To",wcomponent_id:c&&c.id,connection_terminal_type:t.to_type,on_update_id:P=>y({to_id:P}),on_update_type:P=>y({to_type:P}),exclude_ids:new Set([t.id])})}),u&&_("p",{style:{display:"flex",alignItems:"center",flexDirection:"column"},children:_(F,{value:"Reverse Direction",onClick:()=>{y({to_id:t.from_id,from_id:t.to_id})}})})]}),an(t)&&_(GV,{wcomponent:t,from_wcomponent:a,editing:u,wcomponents_by_id:o,upsert_wcomponent:y}),we(t)&&_(KV,{wcomponent:t,editing:u,upsert_wcomponent:y}),pt(t)&&_(FV,{wcomponent:t,upsert_wcomponent:y}),(_n(t)||Le(t))&&_(kF,{wcomponent:t,upsert_wcomponent:y}),(u||t.label_ids&&t.label_ids.length>0)&&_(it,{variant:"standard",component:"fieldset",fullWidth:!0,margin:"normal",children:[_(ci,{component:"legend",children:"Labels"}),_(no,{label_ids:t.label_ids,on_change:P=>y({label_ids:P})})]}),fl(t)&&_(mF,{wcomponent:t,upsert_wcomponent:y}),hl(t)&&_(_F,{wcomponent:t,upsert_wcomponent:y}),Ge(t)&&_(Mz,{editing_allowed:u,wcomponent:t,upsert_wcomponent:y}),Ho(t)&&_(jV,{editing_allowed:u,wcomponent:t,upsert_wcomponent:y}),qv(t)&&_(sL,{editing_allowed:u,wcomponent:t,upsert_wcomponent:y}),_("br",{}),_("br",{}),_(it,{variant:"standard",fullWidth:!0,children:[_(ht,{editing_allowed:u,title:"Created at",invariant_value:t.created_at,value:t.custom_created_at,on_change:P=>{y({custom_created_at:P})}}),_("br",{})]}),u&&_("p",{children:[_("span",{className:"description_label",children:"Label color"}),_(v1,{color:t.label_color,conditional_on_blur:P=>y({label_color:P})})]}),u&&_(gF,{wcomponent:t,upsert_wcomponent:y}),!u&&t.summary_image&&_("p",{children:_("a",{href:t.summary_image,target:"_blank",children:[_($n,{}),"Open image"]})}),u&&_("p",{children:[_("span",{className:"description_label",children:"Hide node title"}),_(nt,{value:t.hide_title,on_change:P=>y({hide_title:P})}),_("span",{className:"description_label",children:"Hide node state"}),_(nt,{value:t.hide_state,on_change:P=>y({hide_state:P})}),_("hr",{})]}),_(b1,{wcomponent_id:t.id,editing_allowed:u}),_("br",{}),_("br",{}),u&&ro(t)&&_("div",{children:_(jn,{button_text:"Soft Delete (can undo)",tooltip_text:"Remove from all knowledge views",on_delete:()=>e.delete_wcomponent({wcomponent_id:h})})}),u&&wl(t)&&_("div",{children:_(F,{title:"Undo delete",onClick:()=>y({deleted_at:void 0}),children:"Restore"})}),_("br",{})]})}const lL=aL(cL);const dL=e=>({current_knowledge_view:ne(e),editing:!e.display_options.consumption_formatting,base_id:_t(e)}),uL={toggle_consumption_formatting:x.display.toggle_consumption_formatting},pL=j(dL,uL);function mL(e){const{current_knowledge_view:t,editing:n,base_id:i}=e;return n?i===void 0?_("div",{class:"create_new_wcomponent",children:"Select a base first."}):t?_("div",{class:"create_new_wcomponent",children:[_("h3",{children:"Create new component"}),_(In,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:bb.map(o=>_(xe,{onClick:()=>hL(i,o),children:to(o)}))})]}):_("div",{class:"create_new_wcomponent",children:[_("h3",{children:"Create new component"}),_("p",{children:"Please select a knowledge view first"})]}):_("div",{class:"create_new_wcomponent",children:_(F,{onClick:()=>e.toggle_consumption_formatting({}),children:"Swap to editing"})})}const fL=pL(mL);function hL(e,t){On({wcomponent:{base_id:e,type:t}})}const vL=e=>({}),gL={change_route:x.routing.change_route},wL=j(vL,gL);function bL(e){const[t,n]=I(void 0),i=z(()=>()=>{const s=Se().getState(),{wcomponents_by_id:r,knowledge_views_by_id:a}=s.specialised_objects,c=new Set;Object.values(a).forEach(u=>{Object.entries(u.wc_id_map).filter(([f,m])=>!m.blocked&&!m.passthrough).forEach(([f,m])=>c.add(f))});const l=Object.values(r).filter(u=>ro(u)&&!c.has(u.id)),d=ue(l,u=>(u.modified_at||u.created_at).getTime(),ce.descending);n(d)},[]);return _("div",{children:[_("h3",{style:{marginTop:30,marginBottom:0},children:"Orphaned Components"}),_("span",{className:"description_label",children:"Show all components in this knowledge base which are not in one or more knowledge views in this base."}),_(In,{fullWidth:!0,color:"primary",variant:"contained",orientation:"vertical",children:_(xe,{onClick:()=>i(),children:"Find orphan components"})}),t&&t.length>0&&_("table",{children:_("tbody",{style:{cursor:"pointer"},children:t.map(o=>_("tr",{onClick:()=>e.change_route({item_id:o.id}),children:[_("td",{children:o.type}),_("td",{children:_(vd,{text:o.title})})]}))})}),t&&t.length===0&&_("p",{children:"No orphaned components found."})]})}const yL=wL(bL);function kL(e){const[t,n]=I(0),[i,o]=I(0),s=r=>{e.on_update({change_left:r.change_left?zt(r.change_left):0,change_top:r.change_top?zt(r.change_top):0})};return _("div",{children:[_("p",{style:{fontSize:10,color:"#888"},children:["Increments of ",ot," pixels"]}),"Move right: ",_(st,{placeholder:"Right",value:t,allow_undefined:!1,on_blur:r=>n(zt(r)),on_blur_type:G.conditional}),_("input",{type:"button",value:"Move",disabled:t===0,onClick:()=>s({change_left:t})}),"  ",_("input",{type:"button",value:"←",onClick:()=>s({change_left:-ot})}),_("input",{type:"button",value:"←←",onClick:()=>s({change_left:-ui})}),_("input",{type:"button",value:"→→",onClick:()=>s({change_left:ui})}),_("input",{type:"button",value:"→",onClick:()=>s({change_left:ot})}),_("br",{}),_("br",{}),"Move up: ",_(st,{placeholder:"Up",value:-i,allow_undefined:!1,on_blur:r=>o(zt(-r)),on_blur_type:G.conditional}),_("input",{type:"button",value:"Move",disabled:i===0,onClick:()=>s({change_top:i})}),"  ",_("input",{type:"button",value:"↑",onClick:()=>s({change_top:-ot})}),_("input",{type:"button",value:"↑↑",onClick:()=>s({change_top:-An})}),_("input",{type:"button",value:"↓↓",onClick:()=>s({change_top:An})}),_("input",{type:"button",value:"↓",onClick:()=>s({change_top:ot})})]})}const xL=e=>{const t=ne(e),{selected_wcomponent_ids_set:n}=e.meta_wcomponents,{wcomponents_by_id:i}=e.specialised_objects;return{ready:e.sync.ready_for_reading,selected_wcomponent_ids_set:n,wcomponents_by_id:i,knowledge_view_id:t==null?void 0:t.id,composed_wc_id_map:t==null?void 0:t.composed_wc_id_map,editing:!e.display_options.consumption_formatting}},AL={bulk_edit_knowledge_view_entries:x.specialised_object.bulk_edit_knowledge_view_entries,bulk_add_to_knowledge_view:x.specialised_object.bulk_add_to_knowledge_view,bulk_remove_from_knowledge_view:x.specialised_object.bulk_remove_from_knowledge_view,snap_to_grid_knowledge_view_entries:x.specialised_object.snap_to_grid_knowledge_view_entries,bulk_edit_wcomponents:x.specialised_object.bulk_edit_wcomponents,upsert_wcomponent:x.specialised_object.upsert_wcomponent},SL=j(xL,AL);function CL(e){if(!e.ready)return _("div",{children:"Loading..."});const{selected_wcomponent_ids_set:t,composed_wc_id_map:n,knowledge_view_id:i,wcomponents_by_id:o,editing:s,bulk_edit_knowledge_view_entries:r,bulk_add_to_knowledge_view:a,bulk_remove_from_knowledge_view:c,snap_to_grid_knowledge_view_entries:l,bulk_edit_wcomponents:d,upsert_wcomponent:u}=e,f=Rg(o,t).filter(be),m=Array.from(t),h=jL(m,n),v=new Set,g=[];let b;f.forEach(k=>{(k.label_ids||[]).forEach(y=>v.add(y)),an(k)&&(g.push(k.id),b=b||k.effect_string)});const w=Array.from(v).sort();return m.length===0?_("div",{children:_("h2",{children:"No selected components"})}):_("div",{children:[_("h2",{children:[s?"Bulk editing":"Viewing"," ",m.length," components"]}),s&&_("p",{children:[_("h3",{children:"Position"}),_(kL,{on_update:k=>{r({wcomponent_ids:m,...k})}})]}),s&&_("p",{children:_(g1,{wcomponent_ids:m})}),(s||w.length>0)&&_("p",{children:[_("h3",{children:"Labels"}),_(no,{label_ids:w,on_change:k=>{const y=new Set(k),S=new Set(w.filter($=>!y.has($))),T=new Set(k.filter($=>!v.has($)));d({wcomponent_ids:m,change:{},remove_label_ids:S,add_label_ids:T})}})]}),s&&g.length>0&&_("p",{children:["Causal Connection Values",_(k1,{effect_string:b,effect_when_true:void 0,effect_when_false:void 0,editing:s,wcomponents_by_id:o,upsert_wcomponent:k=>d({wcomponent_ids:g,change:k})})]}),s&&_("p",{children:["Component types",_(de,{placeholder:"Type: ",selected_option_id:void 0,allow_none:!0,options:y1,on_change:k=>{k&&f.forEach(y=>{const T={...q({base_id:y.base_id,type:k}),...y};T.type=k,u({wcomponent:T})})}})]}),s&&_("p",{children:[_("h3",{children:"Created at"}),_(ht,{value:void 0,on_change:k=>d({wcomponent_ids:m,change:{custom_created_at:k}})})]}),s&&_("p",{children:[_("h3",{children:"Add to knowledge view"}),h?"":_("span",{children:[_(rn,{message:"Not all components present in current view so will be added to center of view."}),"Not all components present in current view so will be added to center of view."]}),_(bo,{on_change:k=>{if(!k)return;const y=Se().getState(),S=xi(y);a({wcomponent_ids:m,knowledge_view_id:k,default_entry:S})}})]}),s&&_("p",{children:_(jn,{button_text:"Delete from knowledge view",tooltip_text:"Delete from knowledge view",on_delete:()=>{c({wcomponent_ids:m,remove_type:"passthrough"})}})}),s&&_("p",{children:_(jn,{button_text:"Delete and Block from knowledge view",tooltip_text:"Delete and Block from showing in current knowledge view",on_delete:()=>{c({wcomponent_ids:m,remove_type:"block"})}})})]})}const $L=SL(CL);function jL(e,t){return t?e.find(n=>!t[n])===void 0:!1}const TL=e=>{const{ready_for_reading:t}=e.sync,{bases_by_id:n,chosen_base_id:i}=e.user_info,{sub_route:o,item_id:s}=e.routing,r=me(e,s),a=e.meta_wcomponents.selected_wcomponent_ids_list;return{bases_by_id:n,chosen_base_id:i,ready_for_reading:t,sub_route:o,item_id:s,wcomponent:r,selected_ids:a,editing:!e.display_options.consumption_formatting,wcomponent_ids_searched_for_in_any_base:e.sync.wcomponent_ids_searched_for_in_any_base}},PL={clear_selected_wcomponents:x.meta_wcomponents.clear_selected_wcomponents,set_or_toggle_display_select_storage:x.controls.set_or_toggle_display_select_storage,request_searching_for_wcomponents_by_id_in_any_base:x.sync.request_searching_for_wcomponents_by_id_in_any_base},NL=j(TL,PL);function EL(e){const{ready_for_reading:t,item_id:n}=e,i=n?!e.wcomponent_ids_searched_for_in_any_base.has(n):!1,o=e.wcomponent,s=e.bases_by_id&&!e.chosen_base_id?0:t?e.sub_route==="wcomponents_edit_multiple"?2:n===null?3:4:1;if(_e(()=>{o||s===4&&n&&e.request_searching_for_wcomponents_by_id_in_any_base({ids:[n]})},[t,s,n,o,i]),s===0)return _("div",{children:_(F,{value:"Choose a base to view",onClick:()=>e.set_or_toggle_display_select_storage(!0)})});if(s===1)return _("div",{children:"Loading..."});if(s===2)return _("div",{children:_($L,{})});if(s===3)return _("div",{children:[e.selected_ids.length>0&&_("p",{children:[_("div",{style:{display:"inline-flex"},children:[_(yE,{name:`View ${e.selected_ids.length} component(s) already selected`,route:"wcomponents",sub_route:e.selected_ids.length>1?"wcomponents_edit_multiple":void 0,item_id:e.selected_ids.length===1?e.selected_ids[0]:void 0,args:void 0})," ",_(F,{value:"Clear selection",onClick:()=>e.clear_selected_wcomponents(),is_left:!0})]}),_("br",{}),_("br",{}),_("hr",{})]}),_(fL,{}),_(yL,{})]});if(o){const r=!!e.wcomponent&&e.wcomponent.base_id!==e.chosen_base_id;return _(lL,{wcomponent:o,wcomponent_from_different_base:r})}return _("div",{children:["Component not found for id: ",n,_("br",{}),_("br",{}),i&&_("div",{children:"Searching in other bases..."}),!i&&_("div",{children:["Not found in other bases (that you have access to).",e.editing&&n&&_(kV,{wcomponent_id:n})]})]})}const IL=NL(EL),RL=e=>({route:e.routing.route}),DL=j(RL);function OL(e){return _("div",{children:[e.route==="filter"&&_(VM,{}),e.route==="select"&&_(Gq,{}),e.route==="display"&&_(PM,{}),e.route==="creation_context"&&_(uM,{}),e.route==="views"&&_(Lq,{}),e.route==="wcomponents"&&_(IL,{}),e.route==="about"&&_(G8,{}),e.route==="search"&&_(Hq,{})]})}const ML=DL(OL);var iu={},qL=Q;Object.defineProperty(iu,"__esModule",{value:!0});var P1=iu.default=void 0,VL=qL(Z()),FL=ee(),zL=(0,VL.default)((0,FL.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close");P1=iu.default=zL;const LL=e=>({display_side_panel:e.controls.display_side_panel}),BL={set_or_toggle_display_side_panel:x.controls.set_or_toggle_display_side_panel},UL=j(LL,BL);function WL(e){return _(pe,{"aria-label":"open side panel",color:"inherit",edge:"end",onClick:e.set_or_toggle_display_side_panel,size:"small",children:e.display_side_panel?_(P1,{}):_(Cd,{})})}const HL=UL(WL);var ou={},GL=Q;Object.defineProperty(ou,"__esModule",{value:!0});var N1=ou.default=void 0,KL=GL(Z()),YL=ee(),JL=(0,KL.default)((0,YL.jsx)("path",{d:"M18.99 11.5c.34 0 .67.03 1 .07L20 0 0 20h11.56c-.04-.33-.07-.66-.07-1 0-4.14 3.36-7.5 7.5-7.5zm3.71 7.99c.02-.16.04-.32.04-.49 0-.17-.01-.33-.04-.49l1.06-.83c.09-.08.12-.21.06-.32l-1-1.73c-.06-.11-.19-.15-.31-.11l-1.24.5c-.26-.2-.54-.37-.85-.49l-.19-1.32c-.01-.12-.12-.21-.24-.21h-2c-.12 0-.23.09-.25.21l-.19 1.32c-.3.13-.59.29-.85.49l-1.24-.5c-.11-.04-.24 0-.31.11l-1 1.73c-.06.11-.04.24.06.32l1.06.83c-.02.16-.03.32-.03.49 0 .17.01.33.03.49l-1.06.83c-.09.08-.12.21-.06.32l1 1.73c.06.11.19.15.31.11l1.24-.5c.26.2.54.37.85.49l.19 1.32c.02.12.12.21.25.21h2c.12 0 .23-.09.25-.21l.19-1.32c.3-.13.59-.29.84-.49l1.25.5c.11.04.24 0 .31-.11l1-1.73c.06-.11.03-.24-.06-.32l-1.07-.83zm-3.71 1.01c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"}),"PermDataSetting");N1=ou.default=JL;var su={},XL=Q;Object.defineProperty(su,"__esModule",{value:!0});var E1=su.default=void 0,ZL=XL(Z()),QL=ee(),eB=(0,ZL.default)((0,QL.jsx)("path",{d:"M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"}),"Sync");E1=su.default=eB;var ru={},tB=Q;Object.defineProperty(ru,"__esModule",{value:!0});var _u=ru.default=void 0,nB=tB(Z()),iB=ee(),oB=(0,nB.default)((0,iB.jsx)("path",{d:"M3 12c0 2.21.91 4.2 2.36 5.64L3 20h6v-6l-2.24 2.24C5.68 15.15 5 13.66 5 12c0-2.61 1.67-4.83 4-5.65V4.26C5.55 5.15 3 8.27 3 12zm8 5h2v-2h-2v2zM21 4h-6v6l2.24-2.24C18.32 8.85 19 10.34 19 12c0 2.61-1.67 4.83-4 5.65v2.09c3.45-.89 6-4.01 6-7.74 0-2.21-.91-4.2-2.36-5.64L21 4zm-10 9h2V7h-2v6z"}),"SyncProblem");_u=ru.default=oB;function I1(e){const{state:t,text:n="Refresh",title:i="Refresh",on_click:o,style:s}=e,r=t==="error";return _("span",{title:i,onClick:o,style:s,children:[n,!r&&_(E1,{className:t==="in_progress"?"animate spinning":""}),r&&_(_u,{})]})}function is(e){const{error:t}=e;return t===null?null:t.message.includes("Thanks for registering")&&t.status===400?_("div",{children:"Please check your email"}):_("div",{children:["Error : ",t.message||t]})}function yo(e){const{error:t}=e;if(!t)return null;const n=t.message||t;let i=`${n}`;return i==="[object Object]"&&(i=JSON.stringify(n)),_("div",{children:["Error: ",i]})}var au={},sB=Q;Object.defineProperty(au,"__esModule",{value:!0});var cu=au.default=void 0,rB=sB(Z()),_B=ee(),aB=(0,rB.default)((0,_B.jsx)("path",{d:"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"}),"Edit");cu=au.default=aB;function R1(e){var s;const{users_by_id:t,current_user_id:n,other_user_id:i}=e;let o=((s=t[i])==null?void 0:s.name)||"";return n?o=n===i?"me":o||"(someone else)":o=o||"Someone",_("span",{title:i,children:o})}function cB(e){const{user:t,users_by_id:n,base:i,selected:o,on_click:s,on_click_edit:r}=e,{title:a,public_read:c,access_level:l}=i,d=l==="owner"?"Editor (Owner)":l==="editor"?"Editor":l==="viewer"?"Viewer":i.public_read?"Viewer (public access)":"?";return _("tr",{className:"base_option "+(o?"selected":""),onClick:s,children:[_("td",{className:"narrow",children:_("input",{type:"radio",checked:o,style:{cursor:"pointer"}})}),_("td",{children:a||"(No title)"}),_("td",{children:c&&"(Public)"}),_("td",{children:R1({users_by_id:n,current_user_id:t==null?void 0:t.id,other_user_id:i.owner_user_id})}),_("td",{children:d}),_("td",{className:"narrow edit_title",onClick:i.can_edit?u=>{u.stopImmediatePropagation(),r()}:void 0,children:i.can_edit&&_(cu,{})})]})}const lB=e=>({user:e.user_info.user,users_by_id:e.user_info.users_by_id,chosen_base_id:e.user_info.chosen_base_id,bases_by_id:e.user_info.bases_by_id}),dB={update_chosen_base_id:x.user_info.update_chosen_base_id},uB=j(lB,dB);function pB(e){const{on_choose:t,on_click_edit:n,user:i,users_by_id:o,chosen_base_id:s,bases_by_id:r,update_chosen_base_id:a}=e,[c,l]=I("initial"),[d,u]=I(void 0);if(!o)return"Loading users...";if(!r)return"Loading bases...";const f=ue(Object.values(r),m=>m.inserted_at.getTime(),ce.descending);return f.length===0?null:_("div",{style:{margin:10},children:[_(I1,{state:c,title:"Refresh sharing options",on_click:async()=>{l("in_progress");const m=await tl();l(m.error?"error":"success"),u(m.error)},style:{float:"right"}}),_("h4",{children:"Select a base"}),_(yo,{error:d}),_("table",{children:[_("thead",{children:_("tr",{children:[_("th",{}),_("th",{children:"Knowledge Base Title"}),_("th",{}),_("th",{children:"Owner"}),_("th",{children:"Access"}),_("th",{})]})}),_("tbody",{children:f.map(m=>_(cB,{user:i,users_by_id:o,base:m,selected:m.id===s,on_click:()=>{a({base_id:m.id}),t&&t()},on_click_edit:()=>n(m.id)}))})]})]})}const mB=uB(pB);async function fB(e){const t=Ce(),{data:n,error:i}=await t.from("access_controls").select().eq("base_id",e);debugger;return{access_controls:n?n.map(s=>({...s,inserted_at:new Date(s.inserted_at),updated_at:new Date(s.updated_at)})):void 0,error:i}}async function hB(e){const t={base_id:e.base_id,user_id:e.other_user_id,access_level:e.grant};return await Ce().from("access_controls").upsert(t).select()}function D1(e){const t=["editor","viewer","none"];return _(jv,{variant:"standard",disabled:e.disabled,value:e.current_level,title:e.title||"Select access level",onChange:n=>{const i=n.target.value;e.on_change(i)},children:t.map(n=>_(os,{value:n,children:Ht(n)}))})}function vB(e){const{access_control:t,base_id:n,users_by_id:i,current_user_id:o,is_owner:s,on_update:r}=e,{user_id:a,access_level:c}=t;if(c==="owner")return null;const l=d=>hB({base_id:n,other_user_id:a,grant:d}).then(r);return _("tr",{children:[_("td",{children:R1({users_by_id:i,current_user_id:o,other_user_id:a})}),_("td",{children:_(D1,{disabled:!s,current_level:c,title:s?"Select access level":"Only owners can edit access levels",on_change:l})}),_("br",{})]})}function gB(e){const[t,n]=I(""),[i,o]=I("editor"),[s,r]=I("initial"),a=s==="in_progress",c=s==="success",[l,d]=I(null),{base_id:u}=e;return _("div",{children:["Share with new user: ",_("br",{}),_("input",{type:"text",placeholder:"User's ID or email",value:t,disabled:a,style:{minWidth:200},onKeyUp:f=>n(f.currentTarget.value),onChange:f=>n(f.currentTarget.value),onBlur:f=>n(f.currentTarget.value)}),"  ",_(D1,{current_level:i,on_change:o}),_("br",{}),a&&_("span",{children:"Adding..."}),c&&_("span",{children:"Added."}),_(yo,{error:l}),_("br",{}),t&&_("input",{type:"button",onClick:async()=>{r("in_progress");const m=await Ce().rpc("invite_user_to_base",{base_id:u,email_or_uid:t,access_level:i}),{status:h,error:v}=m;d(v),r(v?"error":"success"),v||(n(""),e.on_add_or_exit(!0))},value:"Add user",disabled:!t}),"  ",_("input",{type:"button",onClick:()=>e.on_add_or_exit(!1),value:"Back"})]})}const wB=e=>({users_by_id:e.user_info.users_by_id}),bB=j(wB);function yB(e){const{user:t,base:n,on_save_or_exit:i,users_by_id:o}=e,[s,r]=I("initial"),[a,c]=I(void 0),[l,d]=I(void 0),u=n.owner_user_id===t.id;function f(){r("in_progress"),fB(n.id).then(m=>{r(m.error?"error":"success"),c(m.access_controls),d(m.error||void 0),!m.error&&H.user.pub("stale_users_by_id",!1)})}return _e(()=>f(),[]),o?_("div",{children:[_(I1,{state:s,title:"Refresh sharing options",on_click:()=>f(),style:{float:"right"}}),_("h4",{children:"Sharing options"}),_(yo,{error:l}),a&&_("div",{children:[a.length===0&&"Not shared with anyone yet",a.length>0&&_("table",{className:"access_controls_table",children:_("tbody",{children:a.map(m=>_(vB,{access_control:m,base_id:n.id,users_by_id:o,current_user_id:t.id,is_owner:u,on_update:h=>{d(h.error||void 0),h.error||f()}}))})}),_("br",{})]}),!u&&_("div",{children:"Sharing with new users (Only owners can do this for now)"}),u&&_(gB,{base_id:n.id,on_add_or_exit:m=>{m?f():i()}})]}):_("div",{children:"Fetching users..."})}const kB=bB(yB);function xB(e){const{base:t,on_save_or_exit:n,user:i}=e,[o,s]=I(t);_e(()=>s(t),[t]);const[r,a]=I(void 0),c=t.owner_user_id===i.id,l=JSON.stringify(t)!==JSON.stringify(o),d=!!o.title;function u(f,m){let h=f.currentTarget.value;m&&(h=h.trim()),s({...o,title:h})}return c?_("div",{children:[_("h4",{children:"Edit base"}),"Title   ",_("input",{type:"text",placeholder:"title",value:o.title,onChange:f=>u(f,!1),onBlur:f=>u(f,!0)}),_("br",{}),_("br",{}),"Visibility   ",_("input",{type:"button",onClick:()=>{s({...o,public_read:!o.public_read})},value:o.public_read?"Make private":"Publish (make public)"}),_("br",{}),_("br",{}),"Default view   ",_(bo,{selected_option_id:o.default_knowledge_view_id??void 0,on_change:f=>{s({...o,default_knowledge_view_id:f})},editing_allowed:!0}),_("br",{}),_("br",{}),_("div",{children:[l&&d&&_("input",{type:"button",disabled:!d,onClick:async()=>{const f=await Bj(o);if(f.error)return a(f.error);a(void 0),H.user.pub("stale_bases",!1)},value:"Save changes"}),"  ",_("input",{type:"button",onClick:n,value:l?"Cancel":"Back"}),_("br",{}),_(yo,{error:r})]}),_("br",{}),_("hr",{})]}):null}const AB=e=>({user:e.user_info.user}),SB=j(AB);function CB(e){const{base:t,on_save_or_exit:n,user:i}=e;return i?_("div",{style:{margin:10},children:[_(xB,{user:i,base:t,on_save_or_exit:n}),_(kB,{user:i,base:t,on_save_or_exit:n})]}):"Please sign in"}const $B=SB(CB),jB=e=>({user:e.user_info.user,users_by_id:e.user_info.users_by_id,bases_by_id:e.user_info.bases_by_id}),TB={update_chosen_base_id:x.user_info.update_chosen_base_id},PB=j(jB,TB);function NB(e){const{on_close:t,user:n,users_by_id:i,bases_by_id:o,update_chosen_base_id:s}=e,[r,a]=I(""),[c,l]=I("initial"),[d,u]=I(void 0),[f,m]=I(void 0);if(!i)return"Loading users...";if(!o)return"Loading bases...";const h=n==null?void 0:n.id,v=Object.keys(o).length,g=h===void 0?void 0:async function(){l("in_progress");const b=await zj({owner_user_id:h,title:r.trim()});l(b.error?"error":"success"),m(b.base),b.error||(H.user.pub("stale_bases",!1),a(""))};return d!==void 0?_("div",{style:{margin:10},children:_($B,{base:o[d],on_save_or_exit:()=>u(void 0)})}):_("div",{style:{margin:10},children:[_(mB,{on_choose:t,on_click_edit:b=>u(b)}),v>0&&g&&_("hr",{}),g&&_("div",{children:[_("h4",{children:["Create ",v?"a new":"your first"," base"]}),_("input",{type:"text",value:r,onKeyUp:b=>a(b.currentTarget.value),onChange:b=>a(b.currentTarget.value),onBlur:b=>a(b.currentTarget.value)}),_("br",{}),_("input",{type:"button",disabled:!r.trim()||c==="in_progress",onClick:g,value:"Create new base"}),"  ",IB(c),"  ",f&&_("input",{type:"button",onClick:()=>{s({base_id:f.id}),t&&t()},value:"Select new base"})]})]})}const EB=PB(NB);function IB(e){return e==="initial"?"":e==="in_progress"?"Creating...":e==="success"?"Created.":"Error"}function RB(e){const{on_close:t}=e;return _(zn,{title:_("div",{style:{margin:10},children:_("h2",{style:{display:"inline"},children:"Knowledge Bases"})}),size:"medium",on_close:t&&(n=>{n==null||n.stopImmediatePropagation(),t()}),child:_(EB,{on_close:t})})}const DB=e=>({base_name:qS(e),needs_to_create_a_base:ww(e),display_select_storage:e.controls.display_select_storage}),OB={set_or_toggle_display_select_storage:x.controls.set_or_toggle_display_select_storage},MB=j(DB,OB);function qB(e){const{needs_to_create_a_base:t,display_select_storage:n,set_or_toggle_display_select_storage:i}=e;return _e(()=>{t&&i(!0)},[t]),_(re,{component:"span",children:[_(xe,{id:"storage_info_button",color:"primary",disableElevation:!0,onClick:()=>i(!0),size:"small",endIcon:_(N1,{titleAccess:"Create and Select Knowledge Bases"}),style:{textTransform:"none"},variant:"contained",children:_("span",{class:"storage_name",children:e.base_name||"Choose store"})}),n&&_(RB,{on_close:t?void 0:()=>i(!1)})]})}const VB=MB(qB);var lu={},FB=Q;Object.defineProperty(lu,"__esModule",{value:!0});var O1=lu.default=void 0,zB=FB(Z()),LB=ee(),BB=(0,zB.default)((0,LB.jsx)("path",{d:"M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"}),"Save");O1=lu.default=BB;const UB=e=>({sync_state_specialised_objects:e.sync.specialised_objects,sync_state_bases:e.sync.bases,ready_for_writing:e.sync.ready_for_writing}),WB={update_sync_status:x.sync.update_sync_status},HB=j(UB,WB);function GB(e){const{sync_state_specialised_objects:t,sync_state_bases:n,ready_for_writing:i}=e,o=t.status==="FAILED"||n.status==="FAILED",s=t.status==="LOADING"||n.status==="LOADING",r=t.status==="SAVING"||n.status==="SAVING",a=[t.error_message,n.error_message].filter(be).join(", "),c=s||r,l=YB();let d=Ht(t.status||"");return n.status&&n.status!=="LOADED"&&n.status!=="SAVED"&&(d+=n.status!==t.status&&", "+Ht(n.status)||""),d?_(re,{component:"span",children:_(xe,{className:l.button,size:"small",disabled:!i,onClick:async u=>{u.currentTarget.blur();const f=Se();await Nw(f,!0)},startIcon:o?_(_u,{color:"error"}):_(O1,{className:c?"animate spinning":""}),title:o?a:d,children:[_(re,{className:`${l.animate} ${l.initially_shown} show`,color:o?"error":"initial",component:"span",noWrap:!0,children:o?"Failed!":d}),_(re,{className:`${l.animate} ${l.initially_hidden} hide`,color:"initial",component:"span",noWrap:!0,children:o?"Retry Now":"Save Now"}),_(re,{component:"span",children:" "})]})}):null}const KB=HB(GB),YB=Pt(e=>({button:{textTransform:"none","&:hover .show":{fontSize:0},"&:focus .show":{fontSize:0},"&:hover .hide":{fontSize:"initial"},"&:focus .hide":{fontSize:"initial"}},animate:{transitionProperty:"all",transitionDuration:"0.23s"},initially_hidden:{fontSize:0},initially_shown:{fontSize:"initial"}}));var du={},JB=Q;Object.defineProperty(du,"__esModule",{value:!0});var M1=du.default=void 0,XB=JB(Z()),ZB=ee(),QB=(0,XB.default)((0,ZB.jsx)("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 4c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm0 14c-2.03 0-4.43-.82-6.14-2.88C7.55 15.8 9.68 15 12 15s4.45.8 6.14 2.12C16.43 19.18 14.03 20 12 20z"}),"AccountCircle");M1=du.default=QB;const eU="(No user name)";var uu={},tU=Q;Object.defineProperty(uu,"__esModule",{value:!0});var q1=uu.default=void 0,nU=tU(Z()),iU=ee(),oU=(0,nU.default)((0,iU.jsx)("path",{d:"M10.09 15.59 11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"}),"ExitToApp");q1=uu.default=oU;const sU=e=>{const{need_to_handle_password_recovery:t}=e.user_info;return{user:e.user_info.user,need_to_handle_password_recovery:t}},rU={set_user:x.user_info.set_user,set_need_to_handle_password_recovery:x.user_info.set_need_to_handle_password_recovery},_U=j(sU,rU);function aU(e){const{on_close:t,user:n,set_user:i,need_to_handle_password_recovery:o,set_need_to_handle_password_recovery:s}=e,[r,a]=I(""),[c,l]=I(null);if(!n)return null;async function d(){const f=Ce(),m=n==null?void 0:n.email,h=await f.auth.updateUser({email:m,password:r});l(h.error),h.error||(i({user:h.data.user}),s(!1),t())}const u=cU();return _(Tv,{className:"section",children:[o&&_("p",{children:"Please set a new password."}),_(E,{className:u.root,children:[_(it,{variant:"standard",children:_(En,{inputProps:{type:"password"},onBlur:f=>a(f.currentTarget.value),onChange:f=>a(f.currentTarget.value),onKeyUp:f=>a(f.currentTarget.value),label:"password",size:"small",value:r,variant:"outlined"})}),_(E,{className:u.update_button_container,children:_(xe,{className:u.update_button,disabled:!n.email||!r,onClick:d,variant:"contained",children:"Update password"})}),_(E,{children:!o&&_(xe,{variant:"contained",onClick:()=>{t(),l(null)},children:"Cancel"})})]}),_(is,{error:c})]})}const cU=Pt(()=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),lU=_U(aU),dU=e=>{const{user:t,users_by_id:n}=e.user_info;return{user:t,users_by_id:n,need_to_set_user_name:$l(e)}},uU={},pU=j(dU,uU);function mU(e){const{on_close:t,user:n,need_to_set_user_name:i}=e,[o,s]=I(""),r=(e.users_by_id||{})[(n==null?void 0:n.id)||""],a=(r==null?void 0:r.name)||"";_e(()=>s(a),[a]);const[c,l]=I("initial"),d=c==="in_progress",[u,f]=I(null);if(!n)return null;const{id:m}=n;async function h(){var y;const g=Ce();l("in_progress");const{data:b,error:w}=await g.from("users").upsert({id:m,name:o}).eq("id",m).select();f(w),((b&&((y=b[0])==null?void 0:y.name))??void 0)&&H.user.pub("stale_users_by_id",!0),l(w?"error":"success")}const v=fU();return _(Tv,{className:"section",children:[_(E,{className:v.root,children:[_(it,{variant:"standard",children:_(En,{disabled:d,onChange:g=>{s(g.currentTarget.value)},onBlur:g=>{s(g.currentTarget.value)},placeholder:"Username",size:"small",value:o,variant:"outlined"})}),_(E,{className:v.update_button_container,children:_(xe,{className:v.update_button,disabled:!o||d,onClick:h,variant:"contained",children:[i?"Set":"Change"," username"]})}),_(E,{children:!i&&_(xe,{variant:"contained",onClick:()=>{t(),f(null)},children:"Close"})})]}),d&&"Saving...",c==="success"&&"Saved.",_(yo,{error:u})]})}const fU=Pt(e=>({root:{display:"flex",justifyContent:"flex-start",alignContent:"center"},username_input:{borderTopRightRadius:0,borderBottomRightRadius:0},update_button_container:{flexGrow:1,textAlign:"left",marginLeft:15},update_button:{borderTopLeftRadius:0,borderBottomLeftRadius:0}})),hU=pU(mU),vU=e=>{const{need_to_handle_password_recovery:t}=e.user_info;return{user:e.user_info.user,user_name:as(e),need_to_set_user_name:$l(e),need_to_handle_password_recovery:t}},gU={set_user:x.user_info.set_user},wU=j(vU,gU),bU=Pt(e=>({root:{margin:5},section:{display:"flex",justifyContent:"space-between",alignItems:"center"},logout_section:{flexBasis:"100%"},button:{marginBottom:5},label:{marginBottom:10}}));function yU(e){const{user:t,user_name:n,need_to_set_user_name:i,need_to_handle_password_recovery:o,set_user:s}=e,[r,a]=I("initial"),[c,l]=I(null);if(console.log("user account info form need_to_set_user_name",i,"form_state",r),_e(()=>{i&&a("updating_username")},[i,r]),!t)return null;if(r==="updating_password"||o)return _(lU,{on_close:()=>a("initial")});if(r==="updating_username")return _(hU,{on_close:()=>a("initial")});const d=bU();return _(E,{className:d.root,children:[_(E,{className:`${d.section} ${d.logout_section} section`,children:[_("p",{children:["Logged in with",_("strong",{children:[" ",t.email," "]})]}),_(E,{children:_(xe,{onClick:()=>Ow(!0),variant:"contained",endIcon:_(q1,{}),children:"Log out"})})]}),_(E,{className:`${d.section} section`,display:"flex",justifyContent:"space-between",children:[_(re,{component:"p",children:["User name ",_("strong",{children:n?`: ${n}`:""}),_("br",{}),_("small",{children:["user id:   ",t.id]})]}),_(E,{children:[_(xe,{className:d.button,variant:"contained",onClick:()=>a("updating_username"),children:[i?"Set":"Change"," username"]}),_("br",{}),_(xe,{variant:"contained",onClick:()=>a("updating_password"),children:"Change password"})]})]}),_(is,{error:c})]})}const kU=wU(yU);function xU(e){const{on_close:t}=e;return _(zn,{title:_("div",{style:{margin:10,textAlign:"center"},children:_("h2",{children:"User Account"})}),size:"medium",on_close:t?n=>{n==null||n.stopImmediatePropagation(),t()}:void 0,child:_("div",{style:{textAlign:"center"},children:_(kU,{on_close:t})})})}const AU={set_user:x.user_info.set_user},SU=j(null,AU);function CU(e){const{set_user:t}=e,n=Ce(),[i,o]=I("initial"),[s,r]=I(""),[a,c]=I(""),[l,d]=I(null),[u,f]=I(!1),[m,h]=I(!1);function v(y){r(y),f(!1)}function g(y){c(y),h(!1)}async function b(){if(!s||!a){s||f(!0),a||h(!0);return}const{error:y}=await n.auth.signUp({email:s,password:a,options:{emailRedirectTo:"https://datacurator.org/app/"}});d(y),y||o("registered")}async function w(){if(!s||!a){s||f(!0),a||h(!0);return}const{data:{user:y},error:S}=await n.auth.signInWithPassword({email:s,password:a});d(S),t({user:y||void 0})}async function k(){if(!s){f(!0),h(!1);return}const{error:y}=await n.auth.resetPasswordForEmail(s);d(y),y||o("reset_password")}return i==="initial"?_("div",{className:"section",children:[_("form",{children:[_("br",{}),_("br",{}),_("input",{type:"email",placeholder:"email",value:s,onKeyUp:y=>v(y.currentTarget.value),onChange:y=>v(y.currentTarget.value),onBlur:y=>v(y.currentTarget.value)}),_("div",{className:"error_form_input_empty "+(u?"":"inactive"),children:"Email required"}),_("br",{}),_("input",{type:"password",placeholder:"password",value:a,onKeyUp:y=>g(y.currentTarget.value),onChange:y=>g(y.currentTarget.value),onBlur:y=>g(y.currentTarget.value)}),_("div",{className:"error_form_input_empty "+(m?"":"inactive"),children:"Password required"})]}),_("div",{children:[_("br",{}),_("input",{type:"button",onClick:w,value:"Signin"}),"  ",_("input",{type:"button",onClick:b,value:"Register"}),_("br",{}),_("br",{}),_("input",{type:"button",onClick:k,value:"Forgot password?"}),_("br",{}),_("br",{})]}),_(is,{error:l}),_("br",{})]}):i==="reset_password"?_("div",{className:"section",children:[_("h3",{children:"Password reset"}),_("br",{}),!l&&"Please check your email",_(is,{error:l})]}):_("div",{className:"section",children:[_("h3",{children:"Registered"}),_("br",{}),"Please check your email"]})}const $U=SU(CU);function jU(e){return _(zn,{title:_("div",{style:{margin:10,textAlign:"center"},children:_("h2",{children:"Signin / Register"})}),size:"medium",on_close:e.on_close,child:_("div",{style:{textAlign:"center"},children:_($U,{})})})}const TU=e=>({user:e.user_info.user,bases_by_id:e.user_info.bases_by_id,users_by_id:e.user_info.users_by_id,chosen_base_id:e.user_info.chosen_base_id,user_name:as(e),need_to_set_user_name:$l(e)}),PU={},NU=j(TU,PU);function EU(e){const{user:t,bases_by_id:n,users_by_id:i,chosen_base_id:o,user_name:s,need_to_set_user_name:r}=e,a=!i,[c,l]=I("hidden"),d=Ie(t),u=s||eU;return _e(()=>{const f=!d.current&&t;d.current=t;const m=n&&o?!n[o]:!1;l(!t&&m?"signin":a?"loading":r?"account_info":f?"hidden":c)},[t,n,o,a,r]),_("div",{children:[_(xe,{color:"primary",endIcon:_(M1,{}),fullWidth:!0,disableElevation:!0,onClick:()=>l(t?"account_info":"signin"),size:"small",style:{textTransform:"none"},variant:"contained",children:_(re,{noWrap:!0,children:t?u:a?"Loading":"Sign in"})}),c==="signin"&&_(jU,{on_close:()=>l("hidden")}),c==="account_info"&&_(xU,{on_close:r?void 0:()=>l("hidden")})]})}const IU=NU(EU);var pu={},RU=Q;Object.defineProperty(pu,"__esModule",{value:!0});var V1=pu.default=void 0,DU=RU(Z()),OU=ee(),MU=(0,DU.default)((0,OU.jsx)("path",{d:"M21 3H3c-1.11 0-2 .89-2 2v14c0 1.11.89 2 2 2h18c1.11 0 2-.89 2-2V5c0-1.11-.89-2-2-2zm0 16.02H3V4.98h18v14.04zM10 12H8l4-4 4 4h-2v4h-4v-4z"}),"PresentToAll");V1=pu.default=MU;const qU=e=>{const t=FS(e);return{presenting:e.display_options.consumption_formatting,access_level:t}},VU={toggle_consumption_formatting:x.display.toggle_consumption_formatting,change_route:x.routing.change_route},FU=j(qU,VU);function zU(e){const{access_level:t}=e,n=t==="viewer"||t==="none",i=!e.presenting,[o,s]=I(void 0),r=Ie(!1);_e(()=>{t!==void 0&&(r.current||(r.current=!0,s(n)))},[t]);const a=n?"No editing rights":"",c=n?e.presenting?"rgba(183, 28, 26, 0.5)":"rgba(183, 28, 26)":"",l=Rd();return _(In,{size:"small",value:e.presenting?"presenting":"editing",children:[_(Me,{title:a,"aria-label":a,children:_(pe,{className:l.inverse_disabled,disabled:i,component:i?"div":void 0,onClick:i?void 0:e.toggle_consumption_formatting,value:"editing",size:"large",children:_(cu,{style:{color:c}})})}),_(pe,{className:l.inverse_disabled,disabled:e.presenting,onClick:e.toggle_consumption_formatting,value:"presenting",size:"large",children:_(V1,{})})]})}const LU=FU(zU),BU=e=>{const t=e.routing.args.subview_id;return{ready_for_reading:e.sync.ready_for_reading,presenting:e.display_options.consumption_formatting,view:e.routing.args.view,kv_id:t,nested_kv_ids_map:e.derived.nested_knowledge_view_ids}},UU={toggle_consumption_formatting:x.display.toggle_consumption_formatting,change_route:x.routing.change_route},WU=j(BU,UU);function HU(e){if(!e.ready_for_reading)return null;const{kv_id:t,nested_kv_ids_map:n}=e;let i=n.map[t];const o=[];let s=Ad;for(;i;){const a=i.child_ids.map(c=>n.map[c]).filter(be);if(a.length){const c=a.map(yv);o.unshift({options:c,selected_id:s,parent_id:i.id})}s=i.id,i=i.parent_id!==void 0?n.map[i.parent_id]:void 0}const r=n.top_ids.map(a=>n.map[a]).filter(be).map(yv);return o.unshift({options:r,selected_id:s,parent_id:void 0}),_(vk,{style:{marginTop:"8px"},children:[_(E,{children:_(jv,{variant:"standard",label:_(re,{noWrap:!0,children:"View Type:"}),name:"select_view",value:e.view,children:KU.map(a=>_(os,{value:a.id,selected:a.id===e.view,onPointerDown:c=>{c.stopImmediatePropagation(),e.change_route({args:{view:a.id}})},children:a.title}))})}),o.map(a=>_(E,{children:_(de,{allow_none:a.parent_id!==void 0,selected_option_id:a.selected_id,options:a.options,on_change:c=>e.change_route({args:{subview_id:c||a.parent_id}}),on_choose_same:c=>e.change_route({args:{subview_id:c||a.parent_id}}),editing_allowed:!0,threshold_minimum_score:!1,retain_options_order:!0})}))]})}const GU=WU(HU),KU=[{id:"knowledge",title:"Knowledge"},{id:"priorities",title:"Priorities"},{id:"priorities_list",title:"Priorities list"},{id:"actions_list",title:"Actions list"}];function yv(e){const t=e.sort_type==="hidden"||e.sort_type==="archived"||e.sort_type==="errored",n=e.sort_type==="errored"?YU:void 0;return{id:e.id,title:e.title,is_hidden:t,color:n}}const YU={r:231,g:190,b:201,a:1},JU=e=>({display_side_panel:e.controls.display_side_panel,animate_connections:e.display_options.animate_connections,network_functional:e.sync.network_functional,network_function_last_checked:e.sync.network_function_last_checked}),XU=j(JU);function ZU(e){return _e(()=>{e.network_functional||setTimeout(()=>{qw(Se())},1e3)},[e.network_functional,e.network_function_last_checked]),_(Wc,{injectFirst:!0,children:_(Hc,{theme:Av,children:[_(gk,{}),_(eW,{...e})]})})}const QU=XU(ZU);function eW(e){const t=tW();return _(Re,{children:[!e.network_functional&&_(zn,{title:"",size:"small",child:_(E,{children:[_(re,{id:"modal-modal-title",variant:"h6",component:"h2",children:"Reconnecting..."}),_(re,{id:"modal-modal-description",sx:{mt:2},children:["Last attempt: ",si({date:e.network_function_last_checked,time_resolution:"second"})]})]})}),_(E,{id:"app",className:t.root,children:[_(wk,{elevation:1,id:"header",position:"fixed",className:"app_header "+t.app_bar,children:_($v,{variant:"dense",className:t.toolbar,children:[_(E,{className:`${t.toolbar_section} ${t.grow} ${t.small_full_width}`,children:[_(E,{className:`${t.toolbar_item}`,children:_(LU,{})}),_(E,{className:`${t.toolbar_item} ${t.grow}`,children:_(GU,{})})]}),_(E,{className:`${t.toolbar_section} ${t.small_full_width}`,justifyContent:"flex-end",children:[_(E,{className:`${t.toolbar_item}`,children:[_(Nd,{}),_(j0,{}),_(C0,{})]}),_(E,{className:`${t.toolbar_item}`,children:_(L8,{})}),_(E,{className:`${t.toolbar_item}`,children:_(KB,{})}),_(E,{className:`${t.toolbar_item}`,children:_(VB,{})}),_(E,{className:`${t.toolbar_item}`,children:_(IU,{})}),_(E,{className:`${t.toolbar_item}`,children:_(HL,{})})]})]})}),_(E,{id:"app_content",component:"div",className:bk(t.content,{[t.content_with_open_side_panel]:e.display_side_panel,animate_connections:e.animate_connections}),children:_(z8,{})}),_(yk,{anchor:"right",className:t.drawer,open:e.display_side_panel,variant:"persistent",children:_(E,{component:"aside",className:t.side_panel,id:"side_panel",children:_(E,{id:"side_panel_content",className:t.side_panel_content,children:[_(vI,{}),_(ML,{})]})})}),_(E,{className:t.help_popup,children:_(z9,{})})]})]})}const tW=Pt(e=>({root:{width:"100%",height:"100%",overflow:"hidden",display:"flex"},app_bar:{transition:e.transitions.create(["all"],{easing:e.transitions.easing.sharp,duration:e.transitions.duration.leavingScreen}),zIndex:e.zIndex.drawer+1},app_bar_with_open_side_panel:{},content:{width:"100%",flexGrow:1,display:"flex",marginRight:-ii,transition:e.transitions.create(["margin"],{easing:e.transitions.easing.sharp,duration:e.transitions.duration.leavingScreen})},content_with_open_side_panel:{marginRight:0,transition:e.transitions.create(["margin"],{easing:e.transitions.easing.easeOut,duration:e.transitions.duration.enteringScreen})},drawer:{width:ii,flexShrink:0},side_panel:{backgroundColor:e.palette.background.paper,width:ii,position:"relative",paddingTop:50},side_panel_content:{marginTop:10,padding:10},sidebar_toolbar:{flexGrow:1,justifyContent:"flex-end"},toolbar:{flexGrow:1,justifyContent:"space-between",flexWrap:"wrap",[e.breakpoints.up("md")]:{flexWrap:"nowrap"}},toolbar_section:{display:"inherit",flexGrow:0,flexShrink:1,flexBasis:"auto",marginRight:5,"&:last-child":{marginRight:0},"&:empty":{display:"none"}},toolbar_item:{marginRight:5,"&:last-child":{marginRight:0}},help_popup:{position:"relative",zIndex:e.zIndex.drawer+1},small_full_width:{[e.breakpoints.down("md")]:{flexGrow:0,flexShrink:1,flexBasis:"100%",margin:0}},grow:{flexGrow:1},hide:{display:"none"},warning_icon:{color:e.palette.warning.main}}));I9();function mu(e=!1){const n=qs().derived.current_composed_knowledge_view;if(e&&!n)throw new Error("Lacking current_composed_knowledge_view");return n}function Ms(){return qs().specialised_objects.wcomponents_by_id}function F1(e={}){const t=mu(!0),n=Ms(),{causal_only:i=!0}=e,o=new Set(Object.keys(t.composed_visible_wc_id_map)),a=Array.from(i?t.wc_ids_by_type.causal_link:t.wc_ids_by_type.any_link).filter(d=>o.has(d)).map(d=>n[d]).filter(we).filter(d=>d.from_id&&d.to_id).filter(d=>n[d.from_id]&&n[d.to_id]),c=new Set,l={};return a.forEach(d=>{c.add(d.from_id),c.add(d.to_id);const u=l[d.from_id]||{};l[d.from_id]=u;const f=u[d.to_id]||[];u[d.to_id]=f;let m=1;an(d)&&(m=d.effect_when_true??1),f.push(m)}),{node_ids_connections_map:l,node_ids:c}}function nW(e={}){const{node_ids_connections_map:t,node_ids:n}=F1(e),i=[],o=[""];return i.push(o),Array.from(n).forEach(s=>o.push(s)),Array.from(n).forEach(s=>{const r=[s];Array.from(n).forEach(a=>{const c=(t[a]||{})[s]||[];r.push(c)}),i.push(r)}),i}function iW(){const e=mu(!0),t=Ms(),i=Object.keys(e.composed_visible_wc_id_map).map(s=>t[s]).filter(be),o={};return i.forEach(s=>{!s.label_ids||s.label_ids.length===0||(o[s.id]=s.label_ids)}),o}function oW(){const e=Ms(),t=iW(),n={},i={};return Object.entries(t).forEach(([o,s])=>{const r=s.map(a=>{const c=e[a];if(!c)return"";const l=n[a]||c.title;return n[a]=l,l});i[o]=r}),i}function z1(e,t){return e.map(i=>i.map(o=>typeof o!="string"?o:o?t(o):""))}function sW(e,t){const n={},i={};return z1(t,s=>{let r=n[s]||"";if(!r){r=(e[s]||[]).join(",");const c=(i[r]||0)+1;i[r]=c,r+=`_${c}`,n[s]=r}return r})}function rW(e,t){return z1(t,i=>{var o;return((o=e[i])==null?void 0:o.title)||""})}function _W(e){const t=[];return e.forEach(n=>{const i=[];n.forEach(o=>{typeof o=="string"?i.push(o):o.length===0?i.push(""):o.length===1?i.push((o[0]||0).toString()):i.push(JSON.stringify(o))}),t.push(i.join(",")+`
`)}),t.join("")}function aW(){return{get_connection_map:F1,get_connection_matrix:nW,get_component_id_to_label_names_map:oW}}function cW(){const e=qs(),t=e.routing.item_id||"";return e.specialised_objects.wcomponents_by_id[t]}function L1(){const e=qs();return e.meta_wcomponents.selected_wcomponent_ids_list.map(t=>me(e,t)).filter(Ov)}function B1(e,t){let n=0;return Le(e)&&_1(e).forEach(({start:o,stop:s})=>n+=s.getTime()-o.getTime()),n=Math.round(n/1e3),t?W1(n):U1(n)}function U1(e){return Number.parseFloat((e/60).toFixed(2))}function W1(e){const t=e%60;e=Math.round((e-t)/60);const n=e%60;e=Math.round((e-n)/60);const i=e%24;e=Math.round((e-i)/24);let o="";return e&&(o+=`${e} days`),(e||i)&&(o+=` ${i} hours`),(e||i||n)&&(o+=` ${n} minutes`),o+=` ${t} seconds`,o=o.trim(),o}function lW(e){const n=L1().map(i=>B1(i,!1)).reduce((i,o)=>i+o,0)*60;return e?W1(n):U1(n)}function dW(){const e={get_current_visible_graph:aW,matrix_component_ids_to_labels:sW,matrix_component_ids_to_titles:rW,matrix_to_csv:_W,get_current_kv:mu,get_wcomponents_by_id:Ms,create_wcomponent:On,get_current_wcomponent:cW,get_selected_wcomponents:L1,get_action_wcomponent_elapsed_minutes:B1,get_selected_wcomponents_elapsed_minutes:lW};window.console_api=e}function qs(){return window.debug_state}const Uc=document.getElementById("root");if(Uc){Uc.innerText="";const e=Se({load_state_from_storage:!0});$k(_(jk,{store:e,children:_(QU,{})}),Uc)}kv();g3();dW();
